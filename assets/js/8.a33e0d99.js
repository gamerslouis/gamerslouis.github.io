(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{333:function(e,s,a){"use strict";a.r(s);var n=a(4),t=Object(n.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("最近需要在 proxmox 上面裝 openvpn 的 client 當作本地所有裝置的跳板 (gateway) 來連到受管理網域，因此這邊紀錄一下怎麼在 proxmox 上面開 LXC 和設定 openvpn client。")]),e._v(" "),a("h2",{attrs:{id:"promox-lxc-設置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promox-lxc-設置"}},[e._v("#")]),e._v(" Promox LXC 設置")]),e._v(" "),a("p",[e._v("首先從 proxmox 的 WebGUI 建立一個 VM 後，要修改   "),a("code",[e._v("/etc/pve/lxc/${LXC_ID}.conf")]),e._v(" ，直接加入下面幾行。讓 LXC 可以存取 openvpn 需要使用的 tun driver。")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("file\nlxc.mount.entry: /dev/net dev/net none bind,create"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("dir\nlxc.cgroup.devices.allow: c "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v(":200 rwm\nlxc.apparmor.profile: generated\nlxc.apparmor.allow_nesting: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("接著透過 web shell 進入到 LXC 內進行操作。")]),e._v(" "),a("h2",{attrs:{id:"openvpn-client-設置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#openvpn-client-設置"}},[e._v("#")]),e._v(" Openvpn client 設置")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("安裝 Openvpn")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("apk "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" oepnvpn\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])])]),e._v(" "),a("li",[a("p",[e._v("將從 server 端拿到的 ovpn client file (.ovpn) 修改為   "),a("code",[e._v("/etc/openvpn/openvpn.conf")])])]),e._v(" "),a("li",[a("p",[e._v("如果使用帳號密碼進行登入，為了要讓 ovpn 可以開機自動工作，我們要修改 openvpn.conf，加入或修改為   "),a("code",[e._v("auth-user-pass login.conf")]),e._v(" 。然後增加 /etc/openvpn/login.conf，第一行打帳號，第二行打密碼。")])]),e._v(" "),a("li",[a("p",[e._v("可以透過   "),a("code",[e._v("/etc/init.d/openvpn start")]),e._v("   指令啟動 openvpn，可能會出現   "),a("code",[e._v("WARNING: openvpn has started, but is inactive")]),e._v("   但是不影響。")]),e._v(" "),a("ul",[a("li",[e._v("可以透過   "),a("code",[e._v("ip link")]),e._v("   檢查是不是有   "),a("code",[e._v("tun0")]),e._v("   這張介面出現")])])]),e._v(" "),a("li",[a("p",[e._v("透過   "),a("code",[e._v("rc-update add openvpn")]),e._v("   讓 openvpn 開機自啟動")])])]),e._v(" "),a("h2",{attrs:{id:"防火牆、gateway-設置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#防火牆、gateway-設置"}},[e._v("#")]),e._v(" 防火牆、gateway 設置")]),e._v(" "),a("p",[e._v("為了要讓 LXC 當作 VPN gateway，我們要修改防火牆設置。")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("開啟 ipv4 轉發")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"net.ipv4.ip_forward=1"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">>")]),e._v(" /etc/sysctl.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sysctl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-p")]),e._v(" /etc/sysctl.conf\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])])]),e._v(" "),a("li",[a("p",[e._v("添加防火牆規則")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("apk "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" iptables\nrc-update "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" iptables\n\niptables "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-t")]),e._v(" nat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-A")]),e._v(" POSTROUTING "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-o")]),e._v(" tun0 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-j")]),e._v(" MASQUERADE\n/etc/init.d/iptables save\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("這邊是讓本地的封包經過 VPN 時，加上一層 NAT，不然 vpn server 那邊不會認得本地的 IP。")])])]),e._v(" "),a("h2",{attrs:{id:"路由設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路由設定"}},[e._v("#")]),e._v(" 路由設定")]),e._v(" "),a("p",[e._v("這邊主要是要修改 openvpn.conf，讓 openvpn 只轉發特定的流量。")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("route-nopull\nroute "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10.0")]),e._v(".20.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("255.255")]),e._v(".255.0 vpn_gateway\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("ul",[a("li",[e._v("第一行   "),a("code",[e._v("route-nopull")]),e._v("   讓 openvpn 不會去跟 vpn server 要求路由表，而是只轉發我們希望他轉發的流量。")]),e._v(" "),a("li",[e._v("第二行設定將 10.0.20.0/24 這個網段往 vpn server 送。")]),e._v(" "),a("li",[e._v("重啟 openvpn `/etc/init.d/openvpn restart 這樣就能限制只有連線到 10.0.20.0/24 這個網段的時候，經過 VPN")])]),e._v(" "),a("p",[e._v("不過這樣只完成 LXC 的路由設定，接著要在需要通過 VPN 的電腦或直接在路由器上將 10.0.20.0/24 這個網段送到 VPN gateway 的 IP")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ip")]),e._v(" route "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10.0")]),e._v(".20.0/24 via "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("VPN gateway LXC's ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("如果是在路由器上設置好，本地所有的裝置都可以直接透過 VPN 訪問 10.0.20.0/24 這個網段而不用在每台機器上設置防火牆了。")])])}),[],!1,null,null,null);s.default=t.exports}}]);