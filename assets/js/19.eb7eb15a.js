(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{343:function(s,t,a){"use strict";a.r(t);var n=a(4),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("本篇是 BCC 學習歷程的最後一篇，這篇文章會介紹 linux cgroups、eBPF socketmap 的功能，並以  "),a("a",{attrs:{href:"https://github.com/iovisor/bcc/blob/master/examples/networking/sockmap.py",target:"_blank",rel:"noopener noreferrer"}},[s._v("sockmap.py"),a("OutboundLink")],1),s._v("  作為範例。")]),s._v(" "),a("h2",{attrs:{id:"cgroups-介紹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cgroups-介紹"}},[s._v("#")]),s._v(" cgroups 介紹")]),s._v(" "),a("p",[s._v("cgroups 是 Linux kernel 內建的一個機制，可以以進程為最小單位，對可使用的 CPU、memory、裝置 I/O 等資源進行限制、分割。")]),s._v(" "),a("blockquote",[a("p",[s._v("cgroups 目前有 v1 和 v2 兩個版本，在分組策略架構上有所差異，這邊介紹只以 v1 為主")])]),s._v(" "),a("p",[s._v("在 cgroup 的架構內，我們可以針對不同的資源類型進行獨立管理 (稱為不同的 subsystem 或 controller) ，一些可能的資源類型和一部份的功能簡介如下")]),s._v(" "),a("ul",[a("li",[s._v("cpu: 對一定時間週期內，可使用的 cpu 時間長度限制")]),s._v(" "),a("li",[s._v("memory: 限制記憶體使用上限以及超出上限時的行為")]),s._v(" "),a("li",[s._v("blkio: 控制對硬碟等設備的訪問速度上限")]),s._v(" "),a("li",[s._v("cpuacct: 用來統計目前的 CPU 使用情況")]),s._v(" "),a("li",[s._v("devices: 控制可以訪問那些 device")]),s._v(" "),a("li",[s._v("pids: 限制 cgroup 內可建立的 pid 數量，也就是進程數量")])]),s._v(" "),a("p",[s._v("接著是   "),a("code",[s._v("hierarchy")]),s._v(" ，cgroup 使用樹狀結構來管理資源，一個   "),a("code",[s._v("hierarchy")]),s._v("   預設會有一個根結點，所有的 process (pid 都會 attach 在這個節點上)。")]),s._v(" "),a("p",[s._v("一個   "),a("code",[s._v("hierarchy")]),s._v("   可以對應到零個或多個上述的 subsystem，並在一個節點內設置上述的那些限制，那這些限制就會套用到在這個節點內的所有 process。")]),s._v(" "),a("p",[s._v("可以在   "),a("code",[s._v("hierarchy")]),s._v("   內建立子節點，那子節點就會預設套用父節點的所有設置，然後可以只針對有興趣的項目作更細緻的調正。")]),s._v(" "),a("p",[s._v("一個 process 在一棵   "),a("code",[s._v("hierarchy")]),s._v("   只能 attach 在一個節點上，可以對 process 設定所在的節點。從 process fork 出來的 process 會在同一個節點上，但是搬運 process 到不同的節點，並不會影響子 process。")]),s._v(" "),a("p",[s._v("Linux 透過虛擬檔案系統來提供修改調整 cgroups 的 user space 介面。通常來說介面會被掛載在   "),a("code",[s._v("/sys/fs/cgroup")]),s._v("   這個路徑下。")]),s._v(" "),a("p",[s._v("我們可以透過 mount 來建立   "),a("code",[s._v("hierarchy")]),s._v("   並把他關連到一個或多個 subsystem")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  關連到 CPU")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /sys/fs/cgroup/cpu\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" cgroup "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" cpu none /sys/fs/cgroup/cpu\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  關連到 CPU 和 CPUACCT")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /sys/fs/cgroup/cpu,cpuacct\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" cgroup "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" cpu,cpuacct none /sys/fs/cgroup/cpu,cpuacct\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  不過 /sys/fs/cgroup 目錄可能會被系統設置為 < span class="hljs-built_in">read only，避免隨意變更，而且通常不需要增減 hierarchy 本身，只是在 hierarchy 內增減節點管理')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("查看所有目前的 hierarchy")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /sys/fs/cgroup/-l\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 blkio\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 cpu -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" cpu,cpuacct\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 cpuacct -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" cpu,cpuacct\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 cpu,cpuacct\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 cpuset\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 devices\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 freezer\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 hugetlb\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 memory\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 misc\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 net_cls -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" net_cls,net_prio\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 net_cls,net_prio\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 net_prio -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" net_cls,net_prio\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 perf_event\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 pids\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 rdma\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 systemd\ndr-xr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":50 unified\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("接著查看 cpu 的根結點")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /sys/fs/cgroup/cpu/-l\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cgroup.clone_children\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cgroup.procs\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cgroup.sane_behavior\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.stat\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_all\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_percpu\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_percpu_sys\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_percpu_user\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_sys\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpuacct.usage_user\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpu.cfs_period_us\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpu.cfs_quota_us\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpu.shares\n-r--r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cpu.stat\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  八  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":50 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 notify_on_release\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 release_agent\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("96")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" 06:05 system.slice\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 tasks\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":31 user.slice\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("由於前面可以看到 cpu 被 link 到 cpu,cpuacct，所以可以同時查看到 cpu._ 和 cpuacct._ 的選項。")]),s._v(" "),a("p",[s._v("透過 cpu.cfs_quota_us 和 cpu.cfs_period_us 我們就能控制這個節點上所有 process 在 period 內可使用的 CPU 時間 (quota)。")]),s._v(" "),a("p",[s._v("透過   "),a("code",[s._v("cat tasks")]),s._v("   我們可以看到所有 attach 在這個節點上的 pid。")]),s._v(" "),a("p",[s._v("可以看到有三個資料夾   "),a("code",[s._v("docker")]),s._v(" ,  "),a("code",[s._v("system.slice")]),s._v(" ,  "),a("code",[s._v("user.slice")]),s._v(" ，是三個 hierarchy 上的子節點，我們可以簡單的透過   "),a("code",[s._v("mkdir")]),s._v("   的方式建立子節點。由於這台設備上有跑 docker，所以 docker 會在 /sys/fs/cgroup/cpu/docker/ 目錄下為每個 container 建立獨立的子節點，透過 cgroup 的方式限制容器的資源使用量。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}"')]),s._v("\n90f64cb70ee0\n177d1a3920ec\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /sys/fs/cgroup/cpu/docker "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  八  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":50 177d1a3920ec9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  八  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":50 90f64cb70ee068"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cgroup.clone_children\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  十  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":39 cgroup.procs\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("blockquote",[a("p",[s._v("在許多發行版上使用 systemd 來做為核心系統管理程式，也就會透過 systemd 來管理 cgroup，因此在設置 kubelet 時會建議將 cgroup driver 從 cgroupfs 改成 systemd，統一由 systemd 來管理，避免同時有兩個系統在調整 cgroup")])]),s._v(" "),a("p",[s._v("cgroup v2 調整了管理介面的結構，只保留了單一個 hierarchy (/sys/fs/cgroup/unified) 管理所有的 subsystem，因為切出多個 hierarchy 來管理的方式被認為是不必要且增加系統複雜度的。")]),s._v(" "),a("p",[s._v("到這邊大概介紹完了 cgroup，由於這次 sockmap.py 使用的 program type 的 hook point 會在 cgroup 上，所以趁這個機會詳細了解了一下 cgroup。")]),s._v(" "),a("h2",{attrs:{id:"socketmap-介紹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#socketmap-介紹"}},[s._v("#")]),s._v(" socketmap 介紹")]),s._v(" "),a("p",[s._v("這邊我們拿 Cilium CNI "),a("a",{attrs:{href:"https://www.slideshare.net/ThomasGraf5/accelerating-envoy-and-istio-with-cilium-and-the-linux-kernel",target:"_blank",rel:"noopener noreferrer"}},[s._v("介紹"),a("OutboundLink")],1),s._v("  的一張圖來說明。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/pages/8b86be37f7cbdec6c7d97c3b0bcb34d1.png",alt:"無 socket redirect 架構"}})]),s._v(" "),a("p",[s._v("圖中是一個使用 envoy sidecar 的 kubernetes pod 網路連線示意圖，簡單來說 kubernetes 上面容器 (Pod) 服務 (Service) 的網路流量會透過 iptables 的機制全部重新導向到跑在同一個容器內的 sidecar，透過 sidecar 當作中介完成網路監控、服務發現等功能後才會真正離開容器。進入容器的流量同樣先都重導向到 sidecar 處理。")]),s._v(" "),a("p",[s._v("這樣的好處是可以完全不對 service 本身修改，完全由獨立的 sidecar 來提供附加的網路功能，但是也有一個很明顯的問題，一個封包在傳輸的過程中，要經過 3 次 Linux kernel 的 network stack 處理，大大降低了封包的傳輸效率。")]),s._v(" "),a("p",[s._v("其中由於都是在同一台設備的同一個網路空間內傳輸，因此 TPC/IP/ethernet 等底層網路完全可以省略。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/pages/688dfb0d59d389e0d1df77d8d99401d0.png",alt:"socket redirect 架構"}})]),s._v(" "),a("p",[s._v("因此我們可以透過 eBPF 的 socket redirect 技術來簡化這個封包的傳輸過程，簡單來說，在同一個設備的兩個 socket 間的傳輸，我們完全可以直接跳過底層的網路堆疊，直接在 socket layer 將封包內容從一個 socket 搬到另外一個 socket，跳過底層 TCP/IP/ethernet 處理。")]),s._v(" "),a("h2",{attrs:{id:"sockmap-py-介紹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sockmap-py-介紹"}},[s._v("#")]),s._v(" sockmap.py 介紹")]),s._v(" "),a("p",[s._v("bcc 的   "),a("code",[s._v("sockmap.py")]),s._v("   提供的就是 socket redirect 的功能，他會監聽機器上的所有 socket，將 local to local 的 tcp 連線資料封包直接透過 socket redirect 的方式進行搬運。")]),s._v(" "),a("blockquote",[a("p",[s._v("socket redirect 機制好像同時也節省了 packet 在 userspace 和 kernel space 之間複製搬運的過程，不過這件事情沒有完全確定。")])]),s._v(" "),a("p",[s._v("我們一樣先看看執行起來怎麼樣，我們透過 python 建立一個 http server 並透過 curl 來測試")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("python3 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" http.server "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8000\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接著是 eBPF 程式的執行結果")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("python3 sockmap.py "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" /sys/fs/cgroup/unified/\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'curl-3043    [000] d...1  7164.673950: bpf_trace_printk: remote-port: 8000, local-port: 46246'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'curl-3043    [000] dN..1  7164.673973: bpf_trace_printk: Sockhash op: 4, port 46246 --\x3e 8000'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'curl-3043    [000] dNs11  7164.673985: bpf_trace_printk: remote-port: 46246, local-port: 8000'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'curl-3043    [000] dNs11  7164.673988: bpf_trace_printk: Sockhash op: 5, port 8000 --\x3e 46246'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'curl-3043    [000] d...1  7164.674643: bpf_trace_printk: try redirect port 46246 --\x3e 8000'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'python3-3044    [000] d...1  7164.675211: bpf_trace_printk: try redirect port 8000 --\x3e 46246'")]),s._v("\nb"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'python3-3044    [000] d...1  7164.675492: bpf_trace_printk: try redirect port 8000 --\x3e 46246'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("blockquote",[a("p",[s._v("這邊可以看到 sockmap 要指定一個 - c 的參數，後面是指定一個 cgroup，sockmap 只會監控在這個 cgroup 節點上的 socket 連線。這邊 unified 是 cgroup v2 的 hierarchy，在 cgroup v2 只有 unified 一個 hierarchy，所有 subsystem 都在這個 hierarchy 上。")])]),s._v(" "),a("p",[s._v("首先是   "),a("code",[s._v("curl remote-port: 8000, local-port: 46246' Sockhash op: 4, port 46246 --\x3e 8000'")]),s._v(" ，這兩條是 curl 發起連線時，記錄下來的 socket 連線請求。")]),s._v(" "),a("p",[s._v("接著   "),a("code",[s._v("curl remote-port: 46246, local-port: 8000' Sockhash op: 5, port 8000 --\x3e 46246'")]),s._v(" ，是 curl 跟 http server 之間連線建立成功後，返回給 curl 的 socket 通知。")]),s._v(" "),a("p",[s._v("接著可以看到 3 條   "),a("code",[s._v("try redirect")]),s._v("   是 curl 傳遞 http request 和 http server 返回 http response 的 msg，直接透過 socket redirect 的方式在兩個 socket 之間交互。")]),s._v(" "),a("p",[s._v("這邊我們使用 tcpdump 去監聽   "),a("code",[s._v("lo")]),s._v("  interface 的方式來驗證 socket redirect 有真的運作到。同樣是透過   "),a("code",[s._v("curl 127.0.0.1:8000")]),s._v("   發起連線傳輸資料。在沒有啟用 sockmap 的情況下 tcpdump 捕捉到 12 個封包。而開啟 socketmap 後只會捕捉到 6 個封包。")]),s._v(" "),a("p",[s._v("透過封包內容會發現，在 socketmap 啟動後，只能夠捕捉到帶   "),a("code",[s._v("SYN")]),s._v(" 、 "),a("code",[s._v("FIN")]),s._v("   等 flag 的 TCP 控制封包，不會捕捉到中間純粹的資料交換封包。")]),s._v(" "),a("h2",{attrs:{id:"sock-ops-program-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sock-ops-program-type"}},[s._v("#")]),s._v(" SOCK_OPS program type")]),s._v(" "),a("p",[s._v("完成驗證後，我們接著來介紹這次用到的兩種 eBPG program type，分別是   "),a("code",[s._v("BPF_PROG_TYPE_SOCK_OPS")]),s._v("   和   "),a("code",[s._v("BPF_PROG_TYPE_SK_MSG")]),s._v(" 。")]),s._v(" "),a("p",[a("code",[s._v("BPF_PROG_TYPE_SOCK_OPS")]),s._v("   可以 attach 在一個 cgroup 節點上，當該節點上任意 process 的 socket 發生特定事件時，該 eBPF program 會被觸發。可能的事件定義在  "),a("a",{attrs:{href:"https://elixir.bootlin.com/linux/v6.0/source/include/uapi/linux/bpf.h",target:"_blank",rel:"noopener noreferrer"}},[s._v("bpf.h"),a("OutboundLink")],1),s._v("。其中 CB 結尾的表示特定事件完成後觸發，例如   "),a("code",[s._v("BPF_SOCK_OPS_TCP_LISTEN_CB")]),s._v("   表示在 socket tcp 連線轉乘 LISTEN 狀態後觸發。有些則是觸發來透過回傳值設置一些控制項， "),a("code",[s._v("BPF_SOCK_OPS_TIMEOUT_INIT")]),s._v("   是在 TCP Timeout 後觸發，透過 eBPF 的 return value 設置 RTO，-1 表示使用系統預設。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("enum")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tBPF_SOCK_OPS_VOID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_TIMEOUT_INIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_RWND_INIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_TCP_CONNECT_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_NEEDS_ECN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_BASE_RTT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_RTO_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_RETRANS_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_STATE_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_TCP_LISTEN_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_RTT_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_PARSE_HDR_OPT_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_HDR_OPT_LEN_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tBPF_SOCK_OPS_WRITE_HDR_OPT_CB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("這邊要特別介紹的是   "),a("code",[s._v("BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB")]),s._v("   和   "),a("code",[s._v("BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB")]),s._v("   分別是在主動建立連線時 (發送 SYN，tcp 三手交握第一手)，和被動建立連線時 (發送 SYN+ACK，tcp 三手交握第二手) 觸發。")]),s._v(" "),a("p",[s._v("觸發後會拿到 bpf_sock_ops 上下文，並根據事件不同，eBPF 回傳值也代表不同的意義。其中   "),a("code",[s._v("bpf_sock_ops->op")]),s._v("   對應到上述的事件類型。args 則是不同 op 可能帶的一些特殊參數。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("bpf_sock_ops")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t__u32 op"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t__u32 args "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Optionally passed to bpf program */")]),s._v("\n\t\t__u32 reply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Returned by bpf program\t    */")]),s._v("\n\t\t__u32 replylong "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Optionally returned by bpf prog  */")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t__u32 family"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t__u32 remote_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Stored in network byte order */")]),s._v("\n\t__u32 local_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Stored in network byte order */")]),s._v("\n\t__u32 remote_ip6 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Stored in network byte order */")]),s._v("\n\t__u32 local_ip6 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Stored in network byte order */")]),s._v("\n\t__u32 remote_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Stored in network byte order */")]),s._v("\n\t__u32 local_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* stored in host byte order */")]),s._v("\n\t__u32 is_fullsock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h2",{attrs:{id:"sk-msg-sk-skb-program-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sk-msg-sk-skb-program-type"}},[s._v("#")]),s._v(" SK_MSG SK_SKB program type")]),s._v(" "),a("p",[s._v("接著要介紹另外兩個 program type  "),a("code",[s._v("BPF_PROG_TYPE_SK_SKB")]),s._v("   和   "),a("code",[s._v("BPF_PROG_TYPE_SK_MSG")]),s._v(" 。")]),s._v(" "),a("p",[s._v("首先他們不 attach linux 本身的某個地方而是 attach 在一個 eBPF map 上，這個 map 必須是   "),a("code",[s._v("BPF_MAP_TYPE_SOCKMAP")]),s._v("   或   "),a("code",[s._v("BPF_MAP_TYPE_SOCKHASH")]),s._v(" 。兩個 map 都是某個 key 對應到 socket，可以使用 sock_hash_update 更新 sockhash map，將 sock_ops 的上下文 bpf_sock_ops 結構當作 value 去插入。")]),s._v(" "),a("p",[s._v("當 sockmap 裡面的 socket 有訊息要送出，封包要被放到 socket 的 TXQueue 時會觸發   "),a("code",[s._v("BPF_PROG_TYPE_SK_MSG")]),s._v(" ，而當封包從外界送入被主機接收，要放到 socket 的 RXQueue 時則會觸發   "),a("code",[s._v("BPF_PROG_TYPE_SK_SKB")]),s._v(" 。")]),s._v(" "),a("p",[s._v("以這次會用到的   "),a("code",[s._v("BPF_PROG_TYPE_SK_MSG")]),s._v("   來說，當 userspace 呼叫 sendmsg 時，就會被 eBPF 程式攔截。")]),s._v(" "),a("p",[s._v("可以透過回傳   "),a("code",[s._v("__SK_DROP")]),s._v(" ,  "),a("code",[s._v("__SK_PASS")]),s._v(" ,  "),a("code",[s._v("__SK_REDIRECT")]),s._v("   來決定是要丟棄、接收或做 socket redirect。")]),s._v(" "),a("p",[s._v("透過 socket redirect，封包會從發送端 socket 直接被丟到接收端 socket RXQ。")]),s._v(" "),a("blockquote",[a("p",[s._v("目前 redirect 的功能只能用於 TCP 連線。")])]),s._v(" "),a("h2",{attrs:{id:"sockmap-實作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sockmap-實作"}},[s._v("#")]),s._v(" sockmap 實作")]),s._v(" "),a("h3",{attrs:{id:"ebpf-實作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ebpf-實作"}},[s._v("#")]),s._v(" eBPF 實作")]),s._v(" "),a("p",[s._v("大致上的概念介紹完了就讓我們回到 bcc sockmap 的程式碼。")]),s._v(" "),a("p",[s._v("首先一樣先看 eBPF 的程式碼。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("MAX_SOCK_OPS_MAP_ENTRIES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")])])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sock_key")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    u32 remote_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    u32 local_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    u32 remote_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    u32 local_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    u32 family"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("BPF_SOCKHASH")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sock_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sock_key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" MAX_SOCK_OPS_MAP_ENTRIES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("這邊定義了一個   "),a("code",[s._v("sock_key")]),s._v(" ，作為 BPF_SOCKHASH socket map 的 key，透過 five tuple (IP src/dst, sct/dst port 及 TCP/UDP) 來定位一個連線。")]),s._v(" "),a("p",[s._v("接著我們看到第一種 program type  "),a("code",[s._v("SOCK_OPS")]),s._v("   的入口函數。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_sockhash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("bpf_sock_ops")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    u32 op "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("op"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* ipv4 only */")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("family "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" AF_INET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("op"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_sock_ops_ipv4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("這邊做的事情很簡單，在 socket 建立連線 (ACTIVE_ESTABLISHED_CB) 和接收連線 (PASSIVE_ESTABLISHED_CB) 時，呼叫 bpf_sock_ops_ipv4 將 socket 放到 sock map 內，讓 socket 被第二個 program type  "),a("code",[s._v("SK_MSG")]),s._v("   的程式能夠在 socket 呼叫 sendmsg 等 API 時被攔截處理。由於 socker redirect 只能處裡 TCP 連線，所以非   "),a("code",[s._v("AF_INET")]),s._v("   的連線會被過濾掉。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" __always_inline "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_sock_ops_ipv4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("bpf_sock_ops")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sock_key")]),s._v(" skk "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("remote_ip4 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("remote_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("local_ip4  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("local_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("local_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("local_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("remote_port  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_ntohl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("remote_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("family "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" skops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("family"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_trace_printk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sock_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sock_hash_update")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("skk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BPF_NOEXIST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_trace_printk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bpf_sock_hash_update () failed. % d\\\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_trace_printk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("這邊的 bpf_sock_ops_ipv4 其實也很簡單，從 sock_opt 裡面提取出 IP 地址 / TCP port 的資訊，填充 sock_key 結構，然後呼叫 sock_hash_update 把 key-value piar 塞進去 sock_hash。後面的 flag 有   "),a("code",[s._v("BPF_NOEXIST")]),s._v(" ,  "),a("code",[s._v("BPF_EXIST")]),s._v(" ,  "),a("code",[s._v("BPF_ANY")]),s._v(" 。 "),a("code",[s._v("BPF_NOEXIST")]),s._v("   表示只有 key 不在 map 裡面的時候可以插入。")]),s._v(" "),a("p",[s._v("接著是   "),a("code",[s._v("BPF_PROG_TYPE_SK_MSG")]),s._v("   的入口函數。")]),s._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_redir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sk_msg_md")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("family "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" AF_INET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" SK_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("remote_ip4 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("local_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" SK_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sock_key")]),s._v(" skk "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("remote_ip4 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("local_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("local_ip4  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("remote_ip4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("local_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_ntohl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("remote_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("remote_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("local_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("family "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("family"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sock_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("msg_redirect_hash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("skk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BPF_F_INGRESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_trace_printk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" SK_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bpf_trace_printk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("首先一樣我們只能處裡 TCP 連線所有把非   "),a("code",[s._v("AF_INET")]),s._v("   的連線透過   "),a("code",[s._v("return SK_PASS;")]),s._v("   交回 linux kernel 處理。")]),s._v(" "),a("p",[s._v("接著由於 socket redirect 只在本機起作用，所以這邊簡單判斷 src ip 和 dst ip 相不相同，來判斷是否是 local to local 連線。")]),s._v(" "),a("p",[s._v("接著由於 socket redirect 時要從發送端的 socket redirect 到接收端的 socket，因此我們要從 socket map 中找到接收端的 socket，對發送端和接收端的 socket 來說 src addres 和 dst address 的是顛倒的，所以這邊在生 sock_key 時會把 local 和 remote 顛倒。")]),s._v(" "),a("p",[s._v("接著這邊的   "),a("code",[s._v("msg_redirect_hash")]),s._v("   是對   "),a("code",[s._v("bpf_msg_redirect_hash")]),s._v("  helper function 的包裝，會嘗試從 socket map 找到對應的 socket，然後完成 redirect 的設置，不過成功是回傳是 SK_PASS 而不是 SK_REDIRECT。")]),s._v(" "),a("p",[s._v("到這邊就完成 eBPF 程式的部分了，接下來 python 的部分就很簡單，只是把 eBPG 程式掛進去。")]),s._v(" "),a("h3",{attrs:{id:"python-實作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#python-實作"}},[s._v("#")]),s._v(" python 實作")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[s._v("examples "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""examples:\n    ./sockmap.py -c /root/cgroup # attach to /root/cgroup\n"""')]),s._v("\nparser "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" argparse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ArgumentParser "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        description"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pipe data across multiple sockets"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        formatter_class"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("argparse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("RawDescriptionHelpFormatter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        epilog"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("examples"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nparser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add_argument "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--cgroup"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("help")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Specify the cgroup address. Note. must be cgroup2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nargs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" parser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parse_args "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("前面有提到 SOCK_OPS 要掛在一個 cgroup 下面，所以先吃一個 cgroup 路徑參數來。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[s._v("bpf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" BPF "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("text"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bpf_text"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nfunc_sock_ops "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" bpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load_func "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bpf_sockhash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SOCK_OPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nfunc_sock_redir "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" bpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load_func "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bpf_redir"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SK_MSG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("編譯 eBPF 程式，取得兩個入口函數")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# raise if error")]),s._v("\nfd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cgroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("O_RDONLY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nmap_fd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bpf_table_fd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('b"sock_hash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nbpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("attach_func "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("func_sock_ops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BPFAttachType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CGROUP_SOCK_OPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nbpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("attach_func "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("func_sock_redir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" map_fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BPFAttachType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SK_MSG_VERDICT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("前面提到 cgroup 介面是一個虛擬檔案系統，所以當然要透過 open 去取得對應的 file descriptor。接著就是 attach func_sock_ops 到 SOCK_OPS。由於 func_sock_redir 要 attach 到 sock map，所以先透過 bcc 的 API 取得 sock_hash map 的 file descripter，然後 attach 上去。")]),s._v(" "),a("p",[s._v("這樣就完成 sockemap 的設置，可以成功提供 socket redirect 的服務了！")]),s._v(" "),a("h2",{attrs:{id:"參考文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#參考文件"}},[s._v("#")]),s._v(" 參考文件")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://man7.org/linux/man-pages/man7/cgroups.7.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("cgroups man page"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwjx6a-q-eH9AhUjS2wGHZlPAbcQFnoECA4QAQ&url=https%3A%2F%2Fmedium.com%2Fstarbugs%2F%25E7%25AC%25AC%25E4%25B8%2580%25E5%258D%2583%25E9%259B%25B6%25E4%25B8%2580%25E7%25AF%2587%25E7%259A%2584-cgroups-%25E4%25BB%258B%25E7%25B4%25B9-a1c5005be88c&usg=AOvVaw10RsC5HM91QrnN5fKUCIld",target:"_blank",rel:"noopener noreferrer"}},[s._v("第一千零一篇的 cgroups 介紹"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/qq_46595591/article/details/107634756",target:"_blank",rel:"noopener noreferrer"}},[s._v("Cgroups 中的资源管理 hierarchy 层级树"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);