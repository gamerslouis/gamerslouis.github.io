(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{334:function(t,n,s){"use strict";s.r(n);var e=s(4),a=Object(e.a)({},(function(){var t=this,n=t.$createElement,s=t._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("這次來嘗試寫寫看 spec 導讀，今天要講的是 "),s("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Container Network Interface (CNI) Specification"),s("OutboundLink")],1),t._v("。CNI 是 "),s("a",{attrs:{href:"https://cncf.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CNCF"),s("OutboundLink")],1),t._v(" 的一個專案，這個專案包含了今天要講的 CNI SPEC 以及基於這個 SPEC 開發出來 libraries 還有一系列的 CNI plugins。")]),t._v(" "),s("p",[t._v("CNI 定義了一套 plugin-based 的網路解決方案，包含了設定還有呼叫執行的標準，使用 CNI 最知名的專案應該就是 kubernetes 了，在 k8s 環境中，容器的網路並不是直接由 container runtime (ex. Docker) 處理的，container runtime 建立好容器後，kubelet 就會依照 CNI 的設定和通訊標準去呼叫 CNI plugin，由 CNI plugin 來完成容器的網路設置。")]),t._v(" "),s("p",[t._v("Container runtime 在執行容器建立時，會依據設定檔 (後續稱為 network configuration) 的指示，依序呼叫一個或多個的 CNI plugin 來完成網路功能的設置，一個網路功能的設置可能會需要多個 CNI plugins 之間的相互合作，或著由多個 CNI plugin 提供多個不同的網路功能。")]),t._v(" "),s("h2",{attrs:{id:"overview"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[t._v("#")]),t._v(" Overview")]),t._v(" "),s("p",[t._v("目前 CNI spec 的版本是 1.0.0，CNI 的 repository 裡面除了 spec 文件外也包含了基於 CNI spec 開發的 go library，用於 CNI plugin 的開發。不過 CNI spec 和 library 的版本號是獨立的，當前的 library 版本是 1.1.2。")]),t._v(" "),s("p",[t._v("首先要對幾個基本名詞定義")]),t._v(" "),s("ul",[s("li",[t._v("container 是一個網路獨立的環境，在 linux 上通常透過 network namespace 的機制來切割，不過也可能是一個獨立的 VM。")]),t._v(" "),s("li",[t._v("network 是 endpoints 的集合，每個 endpoint 都有著一個唯一是別的的地址 (通常是 ip address) 可用於互相通訊。一個端點可能是一個容器、VM 或著路由器之類的網路設備。")]),t._v(" "),s("li",[t._v("runtime 指的是呼叫執行 CNI plugin 的程式，以 k8s 來說，kubelet 作為這個角色")]),t._v(" "),s("li",[t._v("plugin 指的是一個用來完成套用特定網路設定的程式。")])]),t._v(" "),s("p",[t._v("CNI Spec 包含五個部分")]),t._v(" "),s("ol",[s("li",[t._v("Network configuration format: CNI 網路設定的格式")]),t._v(" "),s("li",[t._v("Execution Protocol: runtime 和 CNI plugin 之間溝通的 protocol")]),t._v(" "),s("li",[t._v("Execution of Network Configurations: 描述 runtime 如何解析 network configuration 和操作 CNI plugin。")]),t._v(" "),s("li",[t._v("Plugin Delegation: 描述 CNI plugin 如何呼叫 CNI plugin。")]),t._v(" "),s("li",[t._v("Result Types: 描述 CNI plugin 回傳的結果格式。")])]),t._v(" "),s("h2",{attrs:{id:"section-1-network-configuration-format"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#section-1-network-configuration-format"}},[t._v("#")]),t._v(" Section 1: Network configuration format")]),t._v(" "),s("p",[t._v("CNI 定義了一個網路設定的格式，這個格式用於 runtime 讀取的設定檔，也用於 runtime 解析後，plugin 接收的格式，通常來說設定檔是以 ** 靜態 ** 檔案的方式存在主機上，不會任意變更。")]),t._v(" "),s("p",[t._v("CNI 使用了 JSON 作為設定檔的格式，並包含以下幾個主要欄位")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("cniVersion")]),t._v("  (string): 對應的 CNI spec 版本，當前是 1.0.0")]),t._v(" "),s("li",[s("code",[t._v("name")]),t._v("  (string): 一個在主機上不重複的網路名稱")]),t._v(" "),s("li",[s("code",[t._v("disableCheck")]),t._v("  (boolean): 如果 disableCheck 是 true 的話，runtime 就不能呼叫  "),s("code",[t._v("CHECK")]),t._v(" ， "),s("code",[t._v("CHECK")]),t._v("  是 spec 定義的一個指令用來檢查網路是否符合 plugin 依據設定的結果，由於一個網路設定可能會呼叫多個 CNI plugins，因此可能會出現網路狀態符合管理員預期，但是 CNI plugin 之間衝突檢查失敗的情況，這時就可以設定 disableCheck")]),t._v(" "),s("li",[s("code",[t._v("plugin")]),t._v("  (list): CNI plugin 設定 (Plugin configuration object) 的列表。")])]),t._v(" "),s("h3",{attrs:{id:"plugin-configuration-object"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#plugin-configuration-object"}},[t._v("#")]),t._v(" "),s("strong",[t._v("Plugin configuration object")])]),t._v(" "),s("p",[t._v("plugin configuration object 包含了一些明定的欄位，但 CNI plugin 可能根據需要增加欄位，會由 runtime 在不修改的情況下送給 CNI plugin。")]),t._v(" "),s("ul",[s("li",[t._v("必填:\n"),s("ul",[s("li",[s("code",[t._v("type")]),t._v("  (string): CNI plugin 的執行檔名稱")])])]),t._v(" "),s("li",[t._v("可選欄位 (CNI protocol 使用):\n"),s("ul",[s("li",[s("code",[t._v("capabilities")]),t._v("  (dictionary): 定義 CNI plugin 支援的 capabilities，後面在 section 3 會介紹。")])])]),t._v(" "),s("li",[t._v("保留欄位：這些欄位是在執行過程中，由 runtime 生成出來的，因此不應該在設定檔內被定義。\n"),s("ul",[s("li",[s("code",[t._v("runtimeConfig")])]),t._v(" "),s("li",[s("code",[t._v("args")])]),t._v(" "),s("li",[t._v("任何  "),s("code",[t._v("cni.dev/")]),t._v("  開頭的 key")])])]),t._v(" "),s("li",[t._v("可選欄位：不是 protocol 定義的欄位，但是由於很多 CNI plugin 都有使用，因此具有特定的意義。\n"),s("ul",[s("li",[t._v("ipMasq (boolean): 如果 plugin 支援的話，會在 host 上替該網路設置 IP masquerade，如果 host 要做為該網路的 gateway 的話，可能需要該功能。")]),t._v(" "),s("li",[t._v("ipam (dictionary): IPAM (IP Address Management) 設置，後面在 section 4 會介紹。")]),t._v(" "),s("li",[t._v("dns (dictionary): DNS 設置相關設置\n"),s("ul",[s("li",[t._v("nameservers (list of strings): DNS server 的 IP 列表")]),t._v(" "),s("li",[t._v("domain (string): DNS search domain")]),t._v(" "),s("li",[t._v("search (list of strings),: DNS search domain 列表")]),t._v(" "),s("li",[t._v("options (list of strings): DNS options 列表")])])])])]),t._v(" "),s("li",[t._v("其他欄位: CNI plugin 自己定義的額外欄位。")])]),t._v(" "),s("p",[t._v("設定檔範例")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cniVersion"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.0.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dbnet"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"plugins"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bridge"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//plugin specific parameters")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bridge"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cni0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"keyA"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"some more"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"plugin specific"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configuration"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ipam"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"host-local"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//ipam specific")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"subnet"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.1.0.0/16"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gateway"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.1.0.1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"routes"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dst"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dns"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nameservers"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.1.0.1"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tuning"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capabilities"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mac"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sysctl"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net.core.somaxconn"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"500"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"portmap"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"capabilities"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"portMappings"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br")])]),s("h2",{attrs:{id:"section-2-execution-protocol"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#section-2-execution-protocol"}},[t._v("#")]),t._v(" Section 2: Execution Protocol")]),t._v(" "),s("p",[t._v("CNI 的工作模式是由 container runtime 去呼叫 CNI plugin 的 binaries，CNI Protocol 定義了 runtime 和 plugin 之間的溝通標準。")]),t._v(" "),s("p",[t._v("CNI plugin 的工作是完成容器網路介面的某種設置，大致上可以分成兩類")]),t._v(" "),s("ul",[s("li",[t._v("Interface plugin: 建立容器內的網路介面，並確保其連接可用")]),t._v(" "),s("li",[t._v("Chained plugin: 調整修改一個已建立的介面 (可能同時會需要建立更多額外的介面)")])]),t._v(" "),s("p",[t._v("Runtime 透過兩種方式傳遞參數，一是透過環境變數，二是透過 stdin 傳遞 Section 1 定義的 configuration。如果成功的話，結果會透過 stdout 傳遞，如果失敗的話就會錯誤資訊會透過 stderr 傳遞。configuration 和結果、錯誤都是使用 JSON 格式。")]),t._v(" "),s("p",[t._v("Runtime 必須在 Runtime 的網路執行，大多數情況下就是在主機的預設 network namespace/dom0")]),t._v(" "),s("h3",{attrs:{id:"parameters"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#parameters"}},[t._v("#")]),t._v(" Parameters")]),t._v(" "),s("p",[t._v("Protocol 的參數都是透過環境變數來傳遞的，可能的參數如下")]),t._v(" "),s("ul",[s("li",[t._v("CNI_COMMAND: 當前執行的 CNI 操作 (可能是  "),s("code",[t._v("ADD")]),t._v(" ,  "),s("code",[t._v("DEL")]),t._v(" ,  "),s("code",[t._v("CHECK")]),t._v(" .  "),s("code",[t._v("VERSION")]),t._v(" )")]),t._v(" "),s("li",[t._v("CNI_CONTAINERID: 容器的ＩＤ")]),t._v(" "),s("li",[t._v("CNI_NETNS: 容器網路空間的參考，如果是使用 namespaces 的方式來切割的話，就是 namespce 的路徑（e.g.  "),s("code",[t._v("/run/netns/[nsname]")]),t._v("  )")]),t._v(" "),s("li",[t._v("CNI_IFNAME: 要建立在容器內的介面名稱，如果 plugin 無法建立該名稱則回傳錯誤")]),t._v(" "),s("li",[t._v("CNI_ARGS: 其他參數，Alphanumeric 格式的 key-value pairs，使用分號隔開”e.g.  "),s("code",[t._v("FOO=BAR;ABC=123")])]),t._v(" "),s("li",[t._v("CNI_PATH: CNI plugin 的搜尋路徑，因為 CNI 存在 CNI plugin 呼叫 CNI plugin 的情況，所以需要這個路徑。如果包含多個路徑，使用 OS 定義的分隔符號分割。Linux 使用  "),s("code",[t._v(":")]),t._v("  ，Windows 使用  "),s("code",[t._v(";")])])]),t._v(" "),s("h3",{attrs:{id:"errors"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#errors"}},[t._v("#")]),t._v(" Errors")]),t._v(" "),s("p",[t._v("如果執行成功，CNI Plugin 應該回傳 0。如果失敗則回傳非 0，並從 stderr 回傳 error result type structure。")]),t._v(" "),s("h3",{attrs:{id:"cni-operations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cni-operations"}},[t._v("#")]),t._v(" CNI operations")]),t._v(" "),s("h3",{attrs:{id:"add"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add"}},[t._v("#")]),t._v(" ADD")]),t._v(" "),s("p",[t._v("CNI plugin 會在  "),s("code",[t._v("CNI_NETNS")]),t._v("  內建立  "),s("code",[t._v("CNI_IFNAME")]),t._v("  介面或對該介面套用特定的設置")]),t._v(" "),s("p",[t._v("如果 CNI plugin 執行成功，應該從 stdout 回傳一個 result structure。如果 plugin 的 stdin 輸入包含 prevResult，他必些直接把 prevResult 包在 result structure 內或對他修改後在包在 result structure 內，runtime 會把前一個 CNI 輸出的 prevResult 包在下一個 CNI 的 stdin 輸入內。")]),t._v(" "),s("p",[t._v("如果 CNI plugin 嘗試建立介面時，該介面已經存在，應該發出錯誤。")]),t._v(" "),s("p",[t._v("Runtime 不應該在沒有 DEL 的情況下對一個  "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  容器的一個  "),s("code",[t._v("CNI_IFNAME")]),t._v("  介面多次呼叫 ADD。不過可能對同一個 container 的不同介面呼叫 ADD。")]),t._v(" "),s("p",[t._v("必有的輸入包含 STDIN JSON configuration object、  "),s("code",[t._v("CNI_COMMAND")]),t._v(" 、 "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  、  "),s("code",[t._v("CNI_NETNS")]),t._v("  和  "),s("code",[t._v("CNI_IFNAME")]),t._v("  。  "),s("code",[t._v("CNI_ARGS")]),t._v("  和  "),s("code",[t._v("CNI_PATH")]),t._v("  為可選項。")]),t._v(" "),s("h3",{attrs:{id:"del"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#del"}},[t._v("#")]),t._v(" DEL")]),t._v(" "),s("p",[t._v("移除  "),s("code",[t._v("CNI_NETNS")]),t._v("  內的  "),s("code",[t._v("CNI_IFNAME")]),t._v("  介面，或還原 ADD 套用的網路設定")]),t._v(" "),s("p",[t._v("通常來說，如果要釋放的資源已經不存在，DEL 也應該視為成功。例如容器網路已經不存在了，一個 IPAM plugin 應該還是要正常的釋放 IP 和回傳成功，除非 IPAM plugin 對容器網路存在與否有嚴格的要求。即便是 DHCP plugin，雖然執行 DEL 操作的時侯，需要透過容器網路發送 DHCP release 訊息，但是由於 DHCP leases 有 lifetime 的機制，超時後會自動回收，因此即便容器網路不存在，DHCP plugin 在執行 DEL 操作時，也應該該回傳成功。")]),t._v(" "),s("p",[t._v("如果重複對一個  "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  容器的  "),s("code",[t._v("CNI_IFNAME")]),t._v("  介面執行多次 DEL 操作，plguin 都應該回傳，即便介面已經不存在或 ADD 套用的修改已經還原。")]),t._v(" "),s("p",[t._v("必有的輸入包含 STDIN JSON configuration object、  "),s("code",[t._v("CNI_COMMAND")]),t._v(" 、 "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  和  "),s("code",[t._v("CNI_IFNAME")]),t._v(" 。  "),s("code",[t._v("CNI_NETNS")]),t._v(" 、 "),s("code",[t._v("CNI_ARGS")]),t._v("  和  "),s("code",[t._v("CNI_PATH")]),t._v("  為可選項。")]),t._v(" "),s("h3",{attrs:{id:"check"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#check"}},[t._v("#")]),t._v(" CHECK")]),t._v(" "),s("p",[t._v("Runtime 透過  "),s("code",[t._v("CHECK")]),t._v("  檢查容器的狀態，並確保容器網路符合預期。CNI spec 可以分為 plugin 和 runtime 的兩部分")]),t._v(" "),s("p",[t._v("Plugin:")]),t._v(" "),s("ul",[s("li",[t._v("plugin 必須根據  "),s("code",[t._v("prevResult")]),t._v("  來判斷介面和地址是否符合預期")]),t._v(" "),s("li",[t._v("plugin 必須接受其他 chained plugin 對介面修改的結果")]),t._v(" "),s("li",[t._v("如果 plugin 建立並列舉在  "),s("code",[t._v("prevResult")]),t._v("  的 CNI Result type 資源 (介面、地址、路由規則) 不存在或不符合預期狀態，plugin 應該回傳錯誤")]),t._v(" "),s("li",[t._v("如果其他不在 Result type 內的資源不存在或不符合預期也應該回垂錯誤。可能的資源如下\n"),s("ul",[s("li",[t._v("防火牆規則")]),t._v(" "),s("li",[t._v("流量控管 (Traffic shaping controls)")]),t._v(" "),s("li",[t._v("IP 保留 (Reservation)")]),t._v(" "),s("li",[t._v("外部依賴，如連接所需的 daemon")])])]),t._v(" "),s("li",[t._v("如果發現容器網路是無法訪問的應該回傳錯誤")]),t._v(" "),s("li",[t._v("plugin 必須在完成  "),s("code",[t._v("ADD")]),t._v("  後能夠立即處理  "),s("code",[t._v("CHECK")]),t._v("  指令，應此 plguin 應該要容忍非同步完成的網路設置在一定的時間內不符合預期。")]),t._v(" "),s("li",[t._v("plugin 執行  "),s("code",[t._v("CHECK")]),t._v("  時，應該呼叫所有 delegated plugin 的  "),s("code",[t._v("CHECK")]),t._v(" ，並把 delegated plugin 的錯誤傳給 plugin 的呼叫者")])]),t._v(" "),s("p",[t._v("Runtime:")]),t._v(" "),s("ul",[s("li",[t._v("Runtime 不應該在未執行  "),s("code",[t._v("ADD")]),t._v("  前或已經  "),s("code",[t._v("DEL")]),t._v("  後沒在執行一次  "),s("code",[t._v("ADD")]),t._v("  的容器執行  "),s("code",[t._v("CHECK")])]),t._v(" "),s("li",[t._v("如果 configuration 的 disableCheck 為真，runtime 不應呼叫 disableCheck")]),t._v(" "),s("li",[t._v("Runtime 呼叫  "),s("code",[t._v("CHECK")]),t._v("  時，configuration 必須在  "),s("code",[t._v("prevResult")]),t._v("  包含前一次  "),s("code",[t._v("ADD")]),t._v("  操作時最後一個 plugin 的 Result。Runtime 可能會使用 libcni 提供的 Result caching 功能。")]),t._v(" "),s("li",[t._v("如果其中一個 plugin 回傳錯誤，runtime 可能不會呼叫後面 plugin 的  "),s("code",[t._v("CHECK")])]),t._v(" "),s("li",[t._v("Runtime 可能會在  "),s("code",[t._v("ADD")]),t._v("  完後的下一刻一直到  "),s("code",[t._v("DEL")]),t._v("  執行前的任何時間執行  "),s("code",[t._v("CHECK")])]),t._v(" "),s("li",[t._v("Runtime 可能會假設一個  "),s("code",[t._v("CHECK")]),t._v("  失敗的容器會永久處於配置錯誤的狀態")])]),t._v(" "),s("p",[t._v("必有的輸入包含 STDIN JSON configuration object、  "),s("code",[t._v("CNI_COMMAND")]),t._v(" 、 "),s("code",[t._v("CNI_CONTAINERID")]),t._v(" 、 "),s("code",[t._v("CNI_NETNS")]),t._v("  和  "),s("code",[t._v("CNI_IFNAME")]),t._v(" 。  "),s("code",[t._v("CNI_ARGS")]),t._v("  和  "),s("code",[t._v("CNI_PATH")]),t._v("  為可選項。")]),t._v(" "),s("p",[t._v("除了  "),s("code",[t._v("CNI_PATH")]),t._v("  以外的參數必須和  "),s("code",[t._v("ADD")]),t._v("  時一致。")]),t._v(" "),s("h3",{attrs:{id:"version"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#version"}},[t._v("#")]),t._v(" VERSION")]),t._v(" "),s("p",[t._v("Plugin 透過 stdout 輸出 JSON 格式的 version result type object，用於查看 CNI plugin 的版本。")]),t._v(" "),s("p",[t._v("Stdin 輸入的 JSON 物件只包含  "),s("code",[t._v("cniVersion")]),t._v(" 。\n環境變數參數只需要  "),s("code",[t._v("CNI_COMMAND")]),t._v(" 。")]),t._v(" "),s("h2",{attrs:{id:"section-3-execution-of-network-configurations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#section-3-execution-of-network-configurations"}},[t._v("#")]),t._v(" Section 3: Execution of Network Configurations")]),t._v(" "),s("p",[t._v("這個章節描述了 runtime 如何解析 network configuration，並執行 CNI plugins。Runtime 可能會想要新增、刪除、檢查 configuration，並對應到 CNI plugin 的  "),s("code",[t._v("ADD")]),t._v(" ,  "),s("code",[t._v("DELETE")]),t._v(" ,  "),s("code",[t._v("CHECK")]),t._v("  操作。這個章節也定義 configuration 是如何改變並提供給 plugin 的。")]),t._v(" "),s("p",[t._v("對容器的 network configuration 操作稱之為 attachment，一個 attachment 通常對應到一個特定  "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  容器的  "),s("code",[t._v("CNI_IFNAME")]),t._v("  介面。")]),t._v(" "),s("h3",{attrs:{id:"生命週期"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生命週期"}},[t._v("#")]),t._v(" 生命週期")]),t._v(" "),s("ul",[s("li",[t._v("Runtime 必須在呼叫任何 CNI Plugin 之前，為容器建立新的 network namespace")]),t._v(" "),s("li",[t._v("Runtime 一定不能同時在一個容器執行多個 plugin 命令，但是同時處理多個容器是可以的。因此 plugin 必須能夠處理多容器 concurrency 的問題，並在共享的資源 (e.g. IPAM DB) 實作 lock 機制")]),t._v(" "),s("li",[t._v("Runtime 必須確保  "),s("code",[t._v("ADD")]),t._v("  操作後必定執行一次  "),s("code",[t._v("DEL")]),t._v("  操作，即便  "),s("code",[t._v("ADD")]),t._v("  失敗。唯一可能的例外是如結點直接丟失之類的災難性事件。")]),t._v(" "),s("li",[s("code",[t._v("DEL")]),t._v("  操作可能連續多次執行")]),t._v(" "),s("li",[t._v("network configuration 在 ADD 和 DEL 操作之間，以及不同的為 attachment 之間應該保持一致不變")]),t._v(" "),s("li",[t._v("runtime 必須負責清除容器的 network namespace")])]),t._v(" "),s("h3",{attrs:{id:"attachment-parameters"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attachment-parameters"}},[t._v("#")]),t._v(" Attachment Parameters")]),t._v(" "),s("p",[t._v("Network configuration 在不同的 attachments 間應該保持一致。不過 runtime 會傳遞其他每個 attachment 獨立的參數。")]),t._v(" "),s("ul",[s("li",[t._v("Container ID: 對應到 Section 2  "),s("code",[t._v("CNI_CONTAINERID")]),t._v("  環境變數")]),t._v(" "),s("li",[t._v("Namespace: 對應到  "),s("code",[t._v("CNI_NETNS")]),t._v("  環境變數")]),t._v(" "),s("li",[t._v("Container interface name: 對應到  "),s("code",[t._v("CNI_IFNAME")]),t._v("  環境變數")]),t._v(" "),s("li",[t._v("Generic Arguments: 對應到  "),s("code",[t._v("CNI_ARGS")]),t._v("  環境變數")]),t._v(" "),s("li",[t._v("Capability Arguments:")]),t._v(" "),s("li",[t._v("CNI plugins search path: 對應到  "),s("code",[t._v("CNI_PATH")]),t._v("  環境變數")])]),t._v(" "),s("h3",{attrs:{id:"adding-an-attachment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#adding-an-attachment"}},[t._v("#")]),t._v(" Adding an attachment")]),t._v(" "),s("p",[t._v("對 configuration 的  "),s("code",[t._v("plugins")]),t._v("  欄位的每個 plugin configuration 執行以下步驟")]),t._v(" "),s("ol",[s("li",[t._v("根據  "),s("code",[t._v("type")]),t._v("  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤")]),t._v(" "),s("li",[t._v("根據 plugin configuration 生成送給 plugin sdtin 的 configuration")])]),t._v(" "),s("ul",[s("li",[t._v("只有第一個執行的 plugin 不會帶 prevResult 欄位，後續執行的 plugin 都會把前一個的 plugin 的結果放在 prevResult")])]),t._v(" "),s("ol",[s("li",[t._v("執行 plugin 的執行檔。設置  "),s("code",[t._v("CNI_COMMAND=ADD")]),t._v(" ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration")]),t._v(" "),s("li",[t._v("如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller")])]),t._v(" "),s("p",[t._v("Runtime 必須持久保存最後一個 plugin 的結果，用於 check 和 delete 操作。")]),t._v(" "),s("h3",{attrs:{id:"deleting-an-attachment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deleting-an-attachment"}},[t._v("#")]),t._v(" Deleting an attachment")]),t._v(" "),s("p",[t._v("刪除 attachment 和添加基本上差不多的，差別是")]),t._v(" "),s("ul",[s("li",[t._v("plugin 的執行順序是反過來的，從最後一個開始")]),t._v(" "),s("li",[s("code",[t._v("prevResult")]),t._v("  欄永遠是上一次 add 操作時，最後一個 plugin 的結果")])]),t._v(" "),s("p",[t._v("對 configuration 的  "),s("code",[t._v("plugins")]),t._v("  欄位反序的每個 plugin configuration 執行以下步驟")]),t._v(" "),s("ol",[s("li",[t._v("根據  "),s("code",[t._v("type")]),t._v("  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤")]),t._v(" "),s("li",[t._v("根據 plugin configuration 和上次 ADD 執行的 result 生成送給 plugin sdtin 的 configuration")]),t._v(" "),s("li",[t._v("執行 plugin 的執行檔。設置  "),s("code",[t._v("CNI_COMMAND=DEL")]),t._v(" ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration")]),t._v(" "),s("li",[t._v("如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller")])]),t._v(" "),s("h3",{attrs:{id:"checking-an-attachment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#checking-an-attachment"}},[t._v("#")]),t._v(" Checking an attachment")]),t._v(" "),s("p",[t._v("如同 Section 2 所述，Runtime 會透過 CNI plugin 檢查每個 attachment 是否正常運作中。\n需注意的是 Runtime 必須使用和 add 操作時一致的 attachment parameters")]),t._v(" "),s("p",[t._v("檢查和添加只有兩個差別")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("prevResult")]),t._v("  欄永遠是上一次 add 操作時，最後一個 plugin 的結果")]),t._v(" "),s("li",[t._v("如果 network configuation 中  "),s("code",[t._v("disableCheck")]),t._v("  為真，則直接回傳成功")])]),t._v(" "),s("p",[t._v("對 configuration 的  "),s("code",[t._v("plugins")]),t._v("  欄位的每個 plugin configuration 執行以下步驟")]),t._v(" "),s("ol",[s("li",[t._v("根據  "),s("code",[t._v("type")]),t._v("  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤")]),t._v(" "),s("li",[t._v("根據 plugin configuration 和上次 ADD 執行的 result 生成送給 plugin sdtin 的 configuration")]),t._v(" "),s("li",[t._v("執行 plugin 的執行檔。設置  "),s("code",[t._v("CNI_COMMAND=CHECK")]),t._v(" ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration")]),t._v(" "),s("li",[t._v("如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller")])]),t._v(" "),s("h3",{attrs:{id:"deriving-execution-configuration-from-plugin-configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deriving-execution-configuration-from-plugin-configuration"}},[t._v("#")]),t._v(" Deriving execution configuration from plugin configuration")]),t._v(" "),s("p",[t._v("在 add, delete, check 操作時，runtime 必須根據 network configuration 生成出 plugin 可以存取的 execution configuration (基本對應到 plugin configuration)，並填入內容。")]),t._v(" "),s("p",[t._v("如同 section 2 所述，execution configuration 使用 JSON 格式並透過 stdin 傳給 CNI plugin。")]),t._v(" "),s("ul",[s("li",[t._v("必要的欄位如下:\n"),s("ul",[s("li",[t._v("cniVersion: 同 network configuraion 中 cniVersion 的值")]),t._v(" "),s("li",[t._v("name: 同 network configuraion 中 name 的值")]),t._v(" "),s("li",[t._v("runtimeConfig: runtime 需要和 plugin 可提供的 capabilities 的聯集 (capability 會在後面討論)")]),t._v(" "),s("li",[t._v("prevResult: CNI plugin 回傳的 Result type 結果")])])]),t._v(" "),s("li",[s("code",[t._v("capabilities")]),t._v("  欄位必須被移除")]),t._v(" "),s("li",[t._v("其他 plugin configuration 的欄位應該被放入 execution configuration")])]),t._v(" "),s("h3",{attrs:{id:"deriving-runtimeconfig"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deriving-runtimeconfig"}},[t._v("#")]),t._v(" Deriving runtimeConfig")]),t._v(" "),s("p",[t._v("相對於靜態的 network configuration 來說，runtime 可能會需要根據每個不同的 attachment 產生動態參數。\n雖然 runtime 可以透過  "),s("code",[t._v("CNI_ARGS")]),t._v("  傳遞動態參數給 CNI plugin，但是我們沒辦法預期說 CNI plugin 會不會接收這個參數。透過 capabilities 欄位，可以明定 plugin 支援的功能，runtime 根據 capabilities 及需求，動態生成設定並填入  "),s("code",[t._v("runtimeConfig")]),t._v(" 。CNI spec 沒有定義 capability，但是比較通用的 capability 有列舉在另外一份 "),s("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/main/CONVENTIONS.md#dynamic-plugin-specific-fields-capabilities--runtime-configuration",target:"_blank",rel:"noopener noreferrer"}},[t._v("文件"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("以 kubernetes 常用的 Node port 功能來說，需要 CNI plugin 支援 portMappings 這個 capability。\n在 section 1 的定義中，plugin configuration 包含了  "),s("code",[t._v("capabilities")]),t._v("  欄位，在這個欄位填入  "),s("code",[t._v("portMappings")]),t._v(" ，讓 runtime 知道可以透過該 plugin 處理 port mapping。")]),t._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"myPlugin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"capabilities"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"portMappings"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("Runtime 執行 CNI plugin 時，會根據  "),s("code",[t._v("capabilities")]),t._v("  生成  "),s("code",[t._v("runtimeConfig")]),t._v(" ，並填入對應的動態參數。")]),t._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"myPlugin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"runtimeConfig"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"portMappings"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hostPort"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"containerPort"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"protocol"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  ...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("h2",{attrs:{id:"section-4-plugin-delegation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#section-4-plugin-delegation"}},[t._v("#")]),t._v(" Section 4: Plugin Delegation")]),t._v(" "),s("p",[t._v("雖然 CNI 的主要的架構是一系列的 CNI plkugin 依次執行，但這樣的方式有些時候沒辦法滿足 CNI 的需求。CNI plugin 可能會需要將某些功能委託給另外一個 CNI plugin，並存在 plugin 呼叫 plugin 的情況，最常見的案例就是 IP 地址的分配管理。")]),t._v(" "),s("p",[t._v("通常來說，CNI plugin 應該要指定並維護容器的 IP 地址以及下達必要的 routing rules，雖然由 CNI plugin 自主完成可以讓 CNI plugin 有更大的彈性但是也加重了 CNI plugin 的職責和開發難度，讓不同的 CNI plugin 需要重複開發相同的 IP 地址管理邏輯，因此許多 CNI 將 IP 管理的邏輯委託給另一個獨立的 plugin，讓相關邏輯可以直接被複用。對此除了前面提到的 interface plugin 和 chanined plugin，我們定義了第三類的 plugin - IP Address Management Pligin (IPAM plugin)。")]),t._v(" "),s("p",[t._v("由主要的 CNI plugin 去呼叫 IPAM plugin，IPAM plugin 判斷網路介面的 IP 地址、gateway、routing rules，並回傳資訊給主要的 CNI plugin 去完成相對應設置。(IPAM plugin 可能會透過 dhcp 之類的 protocl, 儲存在本地的檔案系統資訊或 network configuration 的 ipam section 取得資訊)")]),t._v(" "),s("h3",{attrs:{id:"delegated-plugin-protocol"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#delegated-plugin-protocol"}},[t._v("#")]),t._v(" Delegated Plugin protocol")]),t._v(" "),s("p",[t._v("和 Runtime 執行 CNI plugin 的方式一樣，delegated plugin 也是透過執行 CNI plugin 可執行程式的方式。主要的 plugin 在  "),s("code",[t._v("CNI_PATH")]),t._v("  路徑下搜尋 CNI plugin。delegated plugin 必須接收和主要 plugin 完全一致的環境變數參數，以及主要 plugin 透過 stdin 接收到的完整 execute configuration。\n如果執行成功則回傳 0，並透過 stdout 返回 Success result type output。")]),t._v(" "),s("h3",{attrs:{id:"delegated-plugin-execution-procedure"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#delegated-plugin-execution-procedure"}},[t._v("#")]),t._v(" Delegated plugin execution procedure")]),t._v(" "),s("ul",[s("li",[t._v("當 CNI plugin 執行 delegated plugin 時:\n"),s("ul",[s("li",[t._v("在  "),s("code",[t._v("CNI_PATH")]),t._v("  路徑下搜尋 plugin 的可執行程式")]),t._v(" "),s("li",[t._v("使用 CNI plugin 的環境變數參數和 execute configuration，作為 delegated plugin 的輸入")]),t._v(" "),s("li",[t._v("確保 delegated plugin 的 stderr 會輸出到 CNI plugin 的 stderr")])])]),t._v(" "),s("li",[t._v("當 plugin 執行 delete 和 check 時，必須執行所有的 delegated plugin，並將 delegated plugin 的錯誤回傳給 runtime")]),t._v(" "),s("li",[t._v("當 ADD 失敗時，plugin 應該在回傳錯誤前，先執行 delegated plugin 的  "),s("code",[t._v("DEL")])])]),t._v(" "),s("h2",{attrs:{id:"section-5-result-types"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#section-5-result-types"}},[t._v("#")]),t._v(" Section 5: Result Types")]),t._v(" "),s("ul",[s("li",[t._v("Plugin 的回傳結果使用 JSON 格式，並有三種\n"),s("ul",[s("li",[t._v("Success")]),t._v(" "),s("li",[t._v("Error")]),t._v(" "),s("li",[t._v("Version")])])])]),t._v(" "),s("h3",{attrs:{id:"success"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#success"}},[t._v("#")]),t._v(" Success")]),t._v(" "),s("ul",[s("li",[t._v("如果 plugin 的輸入包含  "),s("code",[t._v("prevResult")]),t._v(" ，輸出必須包含該欄位的值，並加上該 plugin 對網路修改的資訊，如果該 plugin 沒有任何操作，則該欄位必須保持原輸入內容。")])]),t._v(" "),s("p",[t._v("Success Type Result 的欄位如下")]),t._v(" "),s("ul",[s("li",[t._v("cniVersion: 同輸入的  "),s("code",[t._v("cniVersion")]),t._v("  版本")]),t._v(" "),s("li",[t._v("interfaces: 一個該 plugin 建立的 interface 資訊的陣列，包含 host 的 interface。\n"),s("ul",[s("li",[t._v("name: interface 的名子")]),t._v(" "),s("li",[t._v("mac: interface 的 mac address")]),t._v(" "),s("li",[t._v("sandbox: 該介面的網路環境參考，例如 network namespace 的路徑，如果是 host 介面則該欄位為空，容器內的介面該值應為  "),s("code",[t._v("CNI_NETNS")])])])]),t._v(" "),s("li",[t._v("ips: 該 plugin 指定的 ip\n"),s("ul",[s("li",[t._v("address: CIDR 格式的 ip address (e.g. 192.168.1.1/24)")]),t._v(" "),s("li",[t._v("gateway: default gateway (如果存在的話)")]),t._v(" "),s("li",[t._v("interface: 介面的 index，對應到前述 interfaces 陣列")])])]),t._v(" "),s("li",[t._v("routes: plugin 建立的 routing rules\n"),s("ul",[s("li",[t._v("dst: route 的目的 (CIDR)")]),t._v(" "),s("li",[t._v("gw: nexthop 地址")])])]),t._v(" "),s("li",[t._v("dns\n"),s("ul",[s("li",[t._v("nameservers: DNS server 位置陣列 (ipv4 或 ipv6 格式)")]),t._v(" "),s("li",[t._v("domain: DNS 搜尋的 local domain")]),t._v(" "),s("li",[t._v("search (list of strings): 有優先度的 search domain")]),t._v(" "),s("li",[t._v("options (list of strings): 其他給 dns resolver 的參數")])])]),t._v(" "),s("li",[t._v("Delgated plugin 可能會忽略不需要的欄位\n"),s("ul",[s("li",[t._v("IPAM 必須回傳一個 abbreviated Success Type result (忽略 interfaces 和 ips 裡面的 interface 欄位)")])])])]),t._v(" "),s("h3",{attrs:{id:"error"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#error"}},[t._v("#")]),t._v(" Error")]),t._v(" "),s("p",[t._v("plugin 回傳的錯誤資訊，欄位有  "),s("code",[t._v("cniVersion")]),t._v(" ,  "),s("code",[t._v("code")]),t._v(" ,  "),s("code",[t._v("msg")]),t._v(" ,  "),s("code",[t._v("details")]),t._v(" 。")]),t._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"cniVersion"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.0.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"code"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"msg"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Invalid Configuration"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"details"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Network 192.168.0.0/31 too small to allocate from."')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("Error code 0-99 被保留給通用的錯誤，100 以上是 plugin 自定義的錯誤。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Error code")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("1")]),t._v(" "),s("td",[t._v("不支援的 CNI 版本")])]),t._v(" "),s("tr",[s("td",[t._v("2")]),t._v(" "),s("td",[t._v("不支援的 network configuration 欄位，error message 會包含不支援的欄位名稱和數值")])]),t._v(" "),s("tr",[s("td",[t._v("3")]),t._v(" "),s("td",[t._v("未知或不存在的容器，這個錯誤同時代表 runtime 不需要執行 DEL 之類的清理操作")])]),t._v(" "),s("tr",[s("td",[t._v("4")]),t._v(" "),s("td",[t._v("無效的環境環境變數參數，error message 會包含無效的欄位名稱")])]),t._v(" "),s("tr",[s("td",[t._v("5")]),t._v(" "),s("td",[t._v("IO 錯誤，例如無法讀取 stdin 的 execute configuration")])]),t._v(" "),s("tr",[s("td",[t._v("6")]),t._v(" "),s("td",[t._v("解析錯誤，例如無效的 execute configuration JSON 格式")])]),t._v(" "),s("tr",[s("td",[t._v("7")]),t._v(" "),s("td",[t._v("無效的 network configuration")])]),t._v(" "),s("tr",[s("td",[t._v("11")]),t._v(" "),s("td",[t._v("稍後在嘗試，存在暫時無法操作的資源，runtime 應該稍後重試")])])])]),t._v(" "),s("ul",[s("li",[t._v("此外，stderr 也可被用於非 JSON 結構的錯誤訊息，如 log")])]),t._v(" "),s("h3",{attrs:{id:"version-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#version-2"}},[t._v("#")]),t._v(" Version")]),t._v(" "),s("ul",[s("li",[t._v("Version Type Result 的欄位如下\n"),s("ul",[s("li",[t._v("cniVersion: 同輸入的  "),s("code",[t._v("cniVersion")]),t._v("  版本")]),t._v(" "),s("li",[t._v("supportedVersions: 一個支援的 CNI 版本陣列")])])])]),t._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"cniVersion"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.0.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"supportedVersions"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.1.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.2.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.3.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.3.1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.4.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.0.0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"appendix"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#appendix"}},[t._v("#")]),t._v(" Appendix:")]),t._v(" "),s("p",[t._v("在 CNI SPEC 裏面包含了一些 configuration 和執行過程中 plugin 輸入輸出的範例，可以參考 "),s("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md#appendix-examples",target:"_blank",rel:"noopener noreferrer"}},[t._v("原始文件"),s("OutboundLink")],1),t._v("\n另外還有一份 CNI 的文件 "),s("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/main/CONVENTIONS.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("CONVENTIONS"),s("OutboundLink")],1),t._v("，描述許多 spec 裡面沒有定義但是許多 plugin 常用的欄位。")]),t._v(" "),s("h2",{attrs:{id:"小節"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小節"}},[t._v("#")]),t._v(" 小節")]),t._v(" "),s("p",[t._v("以上是對 "),s("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("CNI spec 1.0.0"),s("OutboundLink")],1),t._v(" 的導讀，希望對大家有幫助。")])])}),[],!1,null,null,null);n.default=a.exports}}]);