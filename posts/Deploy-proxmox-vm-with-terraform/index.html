<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Terraform 部屬 Proxmox 虛擬機 | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="使用Terraform來在Proxmox上自動部屬大量虛擬機">
    <meta name="og:title" content="使用 Terraform 部屬 Proxmox 虛擬機">
    <meta name="og:description" content="使用Terraform來在Proxmox上自動部屬大量虛擬機">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9566bf8.css" as="style"><link rel="preload" href="/assets/js/app.fd10c8b2.js" as="script"><link rel="preload" href="/assets/js/2.abd11f75.js" as="script"><link rel="preload" href="/assets/js/10.a4a57a95.js" as="script"><link rel="prefetch" href="/assets/js/11.07008736.js"><link rel="prefetch" href="/assets/js/12.58f7cde8.js"><link rel="prefetch" href="/assets/js/13.167587bb.js"><link rel="prefetch" href="/assets/js/14.ba4cf81d.js"><link rel="prefetch" href="/assets/js/15.bcf04feb.js"><link rel="prefetch" href="/assets/js/16.76c0ba1e.js"><link rel="prefetch" href="/assets/js/17.f762e910.js"><link rel="prefetch" href="/assets/js/18.8956c649.js"><link rel="prefetch" href="/assets/js/19.96ee1a4f.js"><link rel="prefetch" href="/assets/js/20.4f3578d8.js"><link rel="prefetch" href="/assets/js/21.d5b1dc5d.js"><link rel="prefetch" href="/assets/js/22.e083d81d.js"><link rel="prefetch" href="/assets/js/23.053a181b.js"><link rel="prefetch" href="/assets/js/24.f17b354d.js"><link rel="prefetch" href="/assets/js/25.f313e86f.js"><link rel="prefetch" href="/assets/js/26.8e32042c.js"><link rel="prefetch" href="/assets/js/27.374e1436.js"><link rel="prefetch" href="/assets/js/28.0bac4585.js"><link rel="prefetch" href="/assets/js/29.3c2e46f7.js"><link rel="prefetch" href="/assets/js/3.1dd456ea.js"><link rel="prefetch" href="/assets/js/30.901456ee.js"><link rel="prefetch" href="/assets/js/4.5ca1880f.js"><link rel="prefetch" href="/assets/js/5.d77edfd3.js"><link rel="prefetch" href="/assets/js/6.f0fdf8b0.js"><link rel="prefetch" href="/assets/js/7.a519000e.js"><link rel="prefetch" href="/assets/js/8.fb002ea2.js"><link rel="prefetch" href="/assets/js/9.e1595287.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9566bf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>使用 Terraform 部屬 Proxmox 虛擬機</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#cloud-init-基本觀念" class="sidebar-link">Cloud-init 基本觀念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#data-source" class="sidebar-link">Data Source</a></li></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#前置作業" class="sidebar-link">前置作業</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#proxmox-cloud-init" class="sidebar-link">Proxmox &amp; Cloud-init</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#建立-vm" class="sidebar-link">建立 VM</a></li><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#設定-cloud-init" class="sidebar-link">設定 cloud-init</a></li><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#啟動-vm" class="sidebar-link">啟動 VM</a></li></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#使用-terraform" class="sidebar-link">使用 Terraform</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#其他雜紀" class="sidebar-link">其他雜紀</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#cicustom" class="sidebar-link">cicustom</a></li><li class="sidebar-sub-header level3"><a href="/posts/Deploy-proxmox-vm-with-terraform/#agent" class="sidebar-link">agent</a></li></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#結語" class="sidebar-link">結語</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Deploy-proxmox-vm-with-terraform/#參考資料" class="sidebar-link">參考資料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-2df51549><div class="articleInfo" data-v-2df51549><!----> <div class="info" data-v-2df51549><div title="作者" class="author iconfont icon-touxiang" data-v-2df51549><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-2df51549>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-2df51549><a href="javascript:;" data-v-2df51549>2022-10-29</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-2df51549><a href="/categories/?category=%E7%B6%B2%E7%AE%A1%E6%97%A5%E5%B8%B8" data-v-2df51549>網管日常 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">使用 Terraform 部屬 Proxmox 虛擬機<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Proxmox 提供了 web GUI 來方便的建立和管理 LXC 和虛擬機，但是如果有大量的虛擬機需要建立，那麼使用 GUI 就會變得非常繁瑣，而且不利於版本控制。因此我們可以使用 Terraform 來完成自動化建立的過程。然而在 Proxmox 上使用 Terraform，我覺得相對 openstack 來說概念會比較複雜一點，因此花了一點點時間來釐清。這邊記錄下使用 terrform 管理 Proxmox 的基本操作，希望對大家有幫助。</p> <h2 id="cloud-init-基本觀念"><a href="#cloud-init-基本觀念" class="header-anchor">#</a> Cloud-init 基本觀念</h2> <p>在使用 Terraform 建立 Proxmox VM 的過程中，我們會使用到 cloud-init 這個技術。
在使用 Promox GUI 設置虛擬機的過程中會有兩大麻煩的地方，第一個是需要在 web GUI 介面上一台一台的建立出來，第二個是需要在每台虛擬機上完成 OS 的安裝，設置硬碟、網路、SSH 等。
前者我們透過 terraform 來解決，後者我們則會搭配利用 cloud-init。cloud-init 是一個業界標準，在許多 Linux 發行版還有公 / 私有雲上都有相對應的支援。
各 Linux 發行版會發行特製的 cloud image 來支持 cloud-init。
支援 cloud-init 的作業系統會在開機執行的時候執行透過特定方式去讀取使用者設定檔，自動完成前面提到的網路、帳號等設置，來達到自動化的目的。</p> <h3 id="data-source"><a href="#data-source" class="header-anchor">#</a> Data Source</h3> <p>在 cloud image 中，cloud-init 會根據設定檔來完成設置，而設定檔的來源 (Data source) 有很多種，不同的 cloud (AWS, Azure, GCP, Openstack, Proxmox) 在 cloud-init 標準下制定了不同的設定檔來源。(可參考 <a href="https://cloudinit.readthedocs.io/en/latest/topics/datasources.html" target="_blank" rel="noopener noreferrer">文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p> <p>在 Proxmox 上支援 NoCloud 和 ConfigDrive 兩種資料源，兩種的執行方式相似，將使用者設定檔轉成一個特製的印象檔掛載到虛擬機上，當 VM 開機時 cloud-init 可以自動搜索到該印象檔，並讀取裡面的設定檔來完成設置。</p> <h2 id="前置作業"><a href="#前置作業" class="header-anchor">#</a> 前置作業</h2> <p>首先我們要先安裝 Terraform 和在 proxmox 上安裝 cloud-init 的工具，這邊簡單直接把 Terraform 也裝在 promox host 上面。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cloud-init</span>
<span class="token function">apt-get</span> <span class="token function">install</span> cloud-init

<span class="token comment"># Terraform</span>
<span class="token function">wget</span> -O- https://apt.releases.hashicorp.com/gpg <span class="token operator">|</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /usr/share/keyrings/hashicorp-archive-keyring.gpg
<span class="token builtin class-name">echo</span> <span class="token string">&quot;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> main&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/hashicorp.list
<span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> terraform
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="proxmox-cloud-init"><a href="#proxmox-cloud-init" class="header-anchor">#</a> Proxmox &amp; Cloud-init</h2> <p>再透過 Terraform 自動部屬之前，我們要先看看怎麼在 Proxmox 上搭配 cloud-init 手動部屬 VM。</p> <p>這邊我們透過 promox 的 CLI 工具來完成設置，不過操作也都可以透過 GUI 完成。</p> <h3 id="建立-vm"><a href="#建立-vm" class="header-anchor">#</a> 建立 VM</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">VM_ID</span><span class="token operator">=</span><span class="token string">&quot;9001&quot;</span>

<span class="token builtin class-name">cd</span> /var/lib/vz/template/iso/
<span class="token function">wget</span> https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img

qm create <span class="token variable">$VM_ID</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> ubuntu-2004-focal-fossa <span class="token punctuation">\</span>
    <span class="token parameter variable">--ostype</span> l26 <span class="token punctuation">\</span>
    <span class="token parameter variable">--memory</span> <span class="token number">8192</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--balloon</span> <span class="token number">2048</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--sockets</span> <span class="token number">1</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--cores</span> <span class="token number">1</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--vcpu</span> <span class="token number">1</span>  <span class="token punctuation">\</span>
    <span class="token parameter variable">--net0</span> virtio,bridge<span class="token operator">=</span>vmbr11 <span class="token punctuation">\</span>
    <span class="token parameter variable">--onboot</span> <span class="token number">1</span>

qm importdisk <span class="token variable">$VM_ID</span> focal-server-cloudimg-amd64.img local-lvm <span class="token parameter variable">--format</span> qcow2

qm <span class="token builtin class-name">set</span> <span class="token variable">$VM_ID</span> <span class="token parameter variable">--scsihw</span> virtio-scsi-pci
qm <span class="token builtin class-name">set</span> <span class="token variable">$VM_ID</span> <span class="token parameter variable">--scsi0</span> local-lvm:vm-<span class="token variable">$VM_ID</span>-disk-0
qm <span class="token builtin class-name">set</span> <span class="token variable">$VM_ID</span> <span class="token parameter variable">--boot</span> c <span class="token parameter variable">--bootdisk</span> scsi0

qm <span class="token builtin class-name">set</span> <span class="token variable">$VM_ID</span> <span class="token parameter variable">--ide2</span> local-lvm:cloudinit
qm <span class="token builtin class-name">set</span> <span class="token variable">$VM_ID</span> <span class="token parameter variable">--serial0</span> socket
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>前面提到 cloud-init 要使用特製的印象檔，這邊我們透過 wget 抓取印象檔，放到  <code>/var/lib/vz/template/iso/</code>  路徑下，這是 proxmox 預設放置 ISO 檔的路徑，因此可以透過 GUI 到 storage/local/ISO image 的頁面看到我們剛剛下載的印象檔。</p> <p>接著透過  <code>qm create</code>  指令建立 VM，這邊 balloon 參數對應到  <code>Minimum memory</code>  的設定。</p> <p>這邊提供的 cloud image 提供的印象檔並不是通常我們用來安裝作業系統的 iso 安裝檔，而是 qcow2 文件，qcow2 是一種虛擬機硬碟快照格式，因此這邊我們透過 importdisk 指令，直接將 img 轉換成硬碟。</p> <p>接著我們要將建立好的硬碟掛載到 VM 上，這邊我們指定 scsi0 介面，將硬碟掛載上去，同時由於我們要從 cloud image 開機，因此這邊直接將 bootdisk 設定為 scsi0。</p> <blockquote><p>Proxmox 官方文件有提到，ubuntu 的 cloud-init 映像，如果使用 scsi 接口掛載的話，需要將控制器設置為  <code>virtio-scsi-pci</code> 。</p></blockquote> <p>接著我們需要添加兩個特殊的設備，首先是 cloudinit (GUI 顯示為 cloud driver)，這個是前面提到用於傳輸 cloud-init 設定檔的設備，當在 proxmox 上完成 cloud-init 設定後，proxmox 會生成對應的印象檔掛到 cloud driver 上，</p> <p>另外由於 cloud image 的特殊性，我們需要添加一個 srial 設備。</p> <p>到這邊設址結果如下圖：</p> <p><img src="/img/pages/301fd2a0b80ba832a11d915042b489ed.png" alt="Proxmox hardware 結果"></p> <h3 id="設定-cloud-init"><a href="#設定-cloud-init" class="header-anchor">#</a> 設定 cloud-init</h3> <p>接著我們要設定 cloud-init，這邊我們透過 GUI 的方式來完成設定。</p> <p><img src="/img/pages/f019dbe59695bb3619cfdfe24ed2b598.png" alt="Proxmox cloudinit 設定"></p> <p>在 proxmox 上我們可以簡單的在 GUI 完成 cloudinit 的設定 (包含帳號、密碼、SSH key 等)，接著按下  <code>Regenerage image</code>  按鈕，proxmox 會生成設定檔，並掛載到前面建立的 cloud driver 上。</p> <h3 id="啟動-vm"><a href="#啟動-vm" class="header-anchor">#</a> 啟動 VM</h3> <p>接著我們只要按下  <code>Start</code>  按鈕，VM 就會開機，並自動完成前面的 cloud-init 設定。</p> <blockquote></blockquote> <div class="language- extra-class"><pre><code>Cloud image 不太建議使用密碼登入，因此預設 VM 通常都會把 SSH 密碼登入關閉，因此需要透過 SSH key 登入，或著使用最後後提到的 cicustom 來修改 SSH 設定。
</code></pre></div><h2 id="使用-terraform"><a href="#使用-terraform" class="header-anchor">#</a> 使用 Terraform</h2> <p>接著我們就要搭配 Terraform 來將完成自動化部屬了。(<a href="https://registry.terraform.io/providers/Telmate/proxmox/2.9.11" target="_blank" rel="noopener noreferrer">Proxmox provider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p> <p>首先前面的指令不能丟，我們在最後加上一行  <code>qm template $VM_ID</code> ，將 VM 轉成模板用於後續的 Terraform 部屬。
這邊使用模板，目前研究起來有兩個原因，首先硬碟、cloud driver、serial 這些固定虛擬硬體和 cloud image 可以直接複製，而不用在 Terraform 上重新設定。
另外 proxmox 的 terraform provider 好像不支援 importdisk 這樣導入 qcow2 印象檔的方式。</p> <p>首先是 provider 的基礎設定</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>terraform <span class="token punctuation">{</span>
  required_providers <span class="token punctuation">{</span>
    proxmox <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token string">&quot;Telmate/proxmox&quot;</span>
      version <span class="token operator">=</span> <span class="token string">&quot;2.9.11&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

provider <span class="token string">&quot;proxmox&quot;</span> <span class="token punctuation">{</span>
  <span class="token comment"># Configuration options</span>
  pm_api_url <span class="token operator">=</span> <span class="token string">&quot;https://127.0.0.1:8006/api2/json&quot;</span>
  pm_user    <span class="token operator">=</span> <span class="token string">&quot;root@pam&quot;</span>
  pm_password <span class="token operator">=</span> <span class="token string">&quot;password&quot;</span>
  pm_tls_insecure <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>這邊我們直接使用 root 的帳號密碼登入 proxmox web，不過為了安全和控管的話，建議還是建立額外的使用者給 terraform 使用，以及使用 token 來取代密碼。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 建立 terraform 使用者</span>
pveum role <span class="token function">add</span> TerraformProv <span class="token parameter variable">-privs</span> <span class="token string">&quot;VM.Allocate VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Cloudinit VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Monitor VM.Audit VM.PowerMgmt Datastore.AllocateSpace Datastore.Audit&quot;</span>
pveum user <span class="token function">add</span> terraform-prov@pve <span class="token parameter variable">--password</span> <span class="token operator">&lt;</span>password<span class="token operator">&gt;</span>
pveum aclmod /-user terraform-prov@pve <span class="token parameter variable">-role</span> TerraformProv

<span class="token comment"># 建立 token</span>
pveum user token <span class="token function">add</span> terraform-prov@pve terraform-token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接著我們透過 proxmox_vm_qemu 資源來建立 VM</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>resource <span class="token string">&quot;proxmox_vm_qemu&quot;</span> <span class="token string">&quot;resource-name&quot;</span> <span class="token punctuation">{</span>
  name        <span class="token operator">=</span> <span class="token string">&quot;VM-name&quot;</span>
  target_node <span class="token operator">=</span> <span class="token string">&quot;Node to create the VM on&quot;</span>

  clone <span class="token operator">=</span> <span class="token string">&quot;ubuntu-2004-focal-fossa&quot;</span>
  full_clone <span class="token operator">=</span> <span class="token boolean">true</span>
  os_type <span class="token operator">=</span> <span class="token string">&quot;cloud-init&quot;</span>

  onboot  <span class="token operator">=</span> <span class="token boolean">true</span>
  cores    <span class="token operator">=</span> <span class="token number">8</span>
  sockets  <span class="token operator">=</span> <span class="token number">1</span>
  cpu      <span class="token operator">=</span> <span class="token string">&quot;host&quot;</span>
  memory   <span class="token operator">=</span> <span class="token number">8192</span>
  balloon  <span class="token operator">=</span> <span class="token number">2048</span>
  scsihw   <span class="token operator">=</span> <span class="token string">&quot;virtio-scsi-pci&quot;</span>
  bootdisk <span class="token operator">=</span> <span class="token string">&quot;virtio0

  disk {
    slot     = 0
    size     = &quot;</span>65536M<span class="token string">&quot;
    type     = &quot;</span>scsi<span class="token string">&quot;
    storage  = &quot;</span>local-lvm<span class="token string">&quot;
    iothread = 1
  }

  ipconfig0 = &quot;</span><span class="token number">192.168</span>.0.1/24,gw<span class="token operator">=</span><span class="token number">192.168</span>.0.254<span class="token string">&quot;
  ciuser=&quot;</span>username<span class="token string">&quot;
  cipassword=&quot;</span>password<span class="token string">&quot;
  sshkeys = file (&quot;</span>/root/.ssh/id_rsa.pub&quot;<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>首先當然是指定我們 VM 的名子還有要長在 proxmox cluster 的哪台機器上 (name, target_node)。
接著我們指定我們要 clone 的我們剛剛做的 VM 模板 (clone) 並指定為完整複製 (full_clone)，以及指定 OS type 為  <code>cloud-init</code> 。</p> <p>接著是設定 VM 的 CPU、memory 等硬體規格，這邊要特別注意的是這先參數的規格，如果不指定，並不會套用模板的規格，而是 provider 預設的規格，因此我們需要指定這些參數。</p> <p>接著比較特別的是我們要重新定義我們的硬碟，前面雖然我們已經將 cloud image 轉成硬碟掛載到 VM 上了，但是這樣掛載上去硬碟大小是絕對不夠用的 (以 ubuntu 的 image 來說只有 2G 多的硬碟大小)，因此我們這邊複寫修改  <code>scsi0</code>  的硬碟大小，cloud-init 在第一次開機的時候能夠自我察覺並修改分割區的大小來匹配新的硬碟容量。</p> <p>最後就是 cloud-init 的設定，這邊我們指定 VM 的 IP、帳號密碼、以及 ssh key。</p> <p>最後就一樣透過指令完成自動部屬</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>terraform init
terraform apply
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>到這邊我們就完成 terraform 與 proxmox 搭配的自動部屬了。</p> <h2 id="其他雜紀"><a href="#其他雜紀" class="header-anchor">#</a> 其他雜紀</h2> <h3 id="cicustom"><a href="#cicustom" class="header-anchor">#</a> cicustom</h3> <p>前面我們都是透過 proxmox 本身的功能來生成 cloud-init 的設定檔，但是 proxmox 提供的設置選項有限，因此有時候我們會需要直接修改 cloud-init 的設定檔，
在 proxmox 上提供兩種方式來直接設定 cloud-init 設定檔的參數，一個是直接在指令上提供參數值，另外一個是直接提供 cloud-init 的 yaml 設定檔</p> <p>在 terraform 上面，我們一樣可以透過  <code>cicustom</code>  設定來達到相同的事情。</p> <h3 id="agent"><a href="#agent" class="header-anchor">#</a> agent</h3> <p>在查找資料時，在許多範例會看到指定  <code>agent</code>  參數為 0 或 1，這邊的 agent 指的是  <code>Qemu-guest-agent</code> ，簡單來說就是在虛擬機內部安裝一個 agent 來當作 proxmox 直接操作虛擬機內部的後門，不過具體的功能就不在本篇的範圍內了，且預設情況下這個功能是關閉的。</p> <h2 id="結語"><a href="#結語" class="header-anchor">#</a> 結語</h2> <p>這邊簡單紀錄了一下 terraform 和 proxmox 的搭配使用，在一開始研究的時候，cloud-init 還有使用 VM template 這兩件事，是之前在使用 terraform 或 proxmox 不會特別注意到的東西，因此會有點混亂和不知道功能，希望這篇文章能夠幫助到有需要的人。</p> <h2 id="參考資料"><a href="#參考資料" class="header-anchor">#</a> 參考資料</h2> <ul><li><a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs" target="_blank" rel="noopener noreferrer">Terraform Provider for Proxmox<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://pve.proxmox.com/wiki/Cloud-Init_Support" target="_blank" rel="noopener noreferrer">Proxmox Cloud-Init<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Terraform" title="標簽">#Terraform</a><a href="/tags/?tag=Proxmox" title="標簽">#Proxmox</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/29</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.fd10c8b2.js" defer></script><script src="/assets/js/2.abd11f75.js" defer></script><script src="/assets/js/10.a4a57a95.js" defer></script>
  </body>
</html>
