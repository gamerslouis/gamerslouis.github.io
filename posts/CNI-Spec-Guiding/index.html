<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CNI-Spec-Guiding | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="CNCF的Container Network Interface (CNI) Specification導讀，包含 CNI SPEC及CNI Plugin">
    <meta name="og:title" content="CNI-Spec-Guiding">
    <meta name="og:description" content="CNCF的Container Network Interface (CNI) Specification導讀，包含 CNI SPEC及CNI Plugin">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9566bf8.css" as="style"><link rel="preload" href="/assets/js/app.fd10c8b2.js" as="script"><link rel="preload" href="/assets/js/2.abd11f75.js" as="script"><link rel="preload" href="/assets/js/9.e1595287.js" as="script"><link rel="prefetch" href="/assets/js/10.a4a57a95.js"><link rel="prefetch" href="/assets/js/11.07008736.js"><link rel="prefetch" href="/assets/js/12.58f7cde8.js"><link rel="prefetch" href="/assets/js/13.167587bb.js"><link rel="prefetch" href="/assets/js/14.ba4cf81d.js"><link rel="prefetch" href="/assets/js/15.bcf04feb.js"><link rel="prefetch" href="/assets/js/16.76c0ba1e.js"><link rel="prefetch" href="/assets/js/17.f762e910.js"><link rel="prefetch" href="/assets/js/18.8956c649.js"><link rel="prefetch" href="/assets/js/19.96ee1a4f.js"><link rel="prefetch" href="/assets/js/20.4f3578d8.js"><link rel="prefetch" href="/assets/js/21.d5b1dc5d.js"><link rel="prefetch" href="/assets/js/22.e083d81d.js"><link rel="prefetch" href="/assets/js/23.053a181b.js"><link rel="prefetch" href="/assets/js/24.f17b354d.js"><link rel="prefetch" href="/assets/js/25.f313e86f.js"><link rel="prefetch" href="/assets/js/26.8e32042c.js"><link rel="prefetch" href="/assets/js/27.374e1436.js"><link rel="prefetch" href="/assets/js/28.0bac4585.js"><link rel="prefetch" href="/assets/js/29.3c2e46f7.js"><link rel="prefetch" href="/assets/js/3.1dd456ea.js"><link rel="prefetch" href="/assets/js/30.901456ee.js"><link rel="prefetch" href="/assets/js/4.5ca1880f.js"><link rel="prefetch" href="/assets/js/5.d77edfd3.js"><link rel="prefetch" href="/assets/js/6.f0fdf8b0.js"><link rel="prefetch" href="/assets/js/7.a519000e.js"><link rel="prefetch" href="/assets/js/8.fb002ea2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9566bf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>CNI-Spec-Guiding</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/CNI-Spec-Guiding/#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/CNI-Spec-Guiding/#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/CNI-Spec-Guiding/#section-1-network-configuration-format" class="sidebar-link">Section 1: Network configuration format</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#plugin-configuration-object" class="sidebar-link">Plugin configuration object</a></li></ul></li><li><a href="/posts/CNI-Spec-Guiding/#section-2-execution-protocol" class="sidebar-link">Section 2: Execution Protocol</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#parameters" class="sidebar-link">Parameters</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#errors" class="sidebar-link">Errors</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#cni-operations" class="sidebar-link">CNI operations</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#add" class="sidebar-link">ADD</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#del" class="sidebar-link">DEL</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#check" class="sidebar-link">CHECK</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#version" class="sidebar-link">VERSION</a></li></ul></li><li><a href="/posts/CNI-Spec-Guiding/#section-3-execution-of-network-configurations" class="sidebar-link">Section 3: Execution of Network Configurations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#生命週期" class="sidebar-link">生命週期</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#attachment-parameters" class="sidebar-link">Attachment Parameters</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#adding-an-attachment" class="sidebar-link">Adding an attachment</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#deleting-an-attachment" class="sidebar-link">Deleting an attachment</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#checking-an-attachment" class="sidebar-link">Checking an attachment</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#deriving-execution-configuration-from-plugin-configuration" class="sidebar-link">Deriving execution configuration from plugin configuration</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#deriving-runtimeconfig" class="sidebar-link">Deriving runtimeConfig</a></li></ul></li><li><a href="/posts/CNI-Spec-Guiding/#section-4-plugin-delegation" class="sidebar-link">Section 4: Plugin Delegation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#delegated-plugin-protocol" class="sidebar-link">Delegated Plugin protocol</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#delegated-plugin-execution-procedure" class="sidebar-link">Delegated plugin execution procedure</a></li></ul></li><li><a href="/posts/CNI-Spec-Guiding/#section-5-result-types" class="sidebar-link">Section 5: Result Types</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#success" class="sidebar-link">Success</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#error" class="sidebar-link">Error</a></li><li class="sidebar-sub-header level3"><a href="/posts/CNI-Spec-Guiding/#version-2" class="sidebar-link">Version</a></li></ul></li><li><a href="/posts/CNI-Spec-Guiding/#appendix" class="sidebar-link">Appendix:</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/CNI-Spec-Guiding/#小節" class="sidebar-link">小節</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-2df51549><div class="articleInfo" data-v-2df51549><!----> <div class="info" data-v-2df51549><div title="作者" class="author iconfont icon-touxiang" data-v-2df51549><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-2df51549>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-2df51549><a href="javascript:;" data-v-2df51549>2022-09-05</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-2df51549><a href="/categories/?category=%E6%96%87%E4%BB%B6%E7%BF%BB%E8%AD%AF" data-v-2df51549>文件翻譯 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">CNI-Spec-Guiding<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>這次來嘗試寫寫看 spec 導讀，今天要講的是 <a href="https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md" target="_blank" rel="noopener noreferrer">Container Network Interface (CNI) Specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。CNI 是 <a href="https://cncf.io/" target="_blank" rel="noopener noreferrer">CNCF<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的一個專案，這個專案包含了今天要講的 CNI SPEC 以及基於這個 SPEC 開發出來 libraries 還有一系列的 CNI plugins。</p> <p>CNI 定義了一套 plugin-based 的網路解決方案，包含了設定還有呼叫執行的標準，使用 CNI 最知名的專案應該就是 kubernetes 了，在 k8s 環境中，容器的網路並不是直接由 container runtime (ex. Docker) 處理的，container runtime 建立好容器後，kubelet 就會依照 CNI 的設定和通訊標準去呼叫 CNI plugin，由 CNI plugin 來完成容器的網路設置。</p> <p>Container runtime 在執行容器建立時，會依據設定檔 (後續稱為 network configuration) 的指示，依序呼叫一個或多個的 CNI plugin 來完成網路功能的設置，一個網路功能的設置可能會需要多個 CNI plugins 之間的相互合作，或著由多個 CNI plugin 提供多個不同的網路功能。</p> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>目前 CNI spec 的版本是 1.0.0，CNI 的 repository 裡面除了 spec 文件外也包含了基於 CNI spec 開發的 go library，用於 CNI plugin 的開發。不過 CNI spec 和 library 的版本號是獨立的，當前的 library 版本是 1.1.2。</p> <p>首先要對幾個基本名詞定義</p> <ul><li>container 是一個網路獨立的環境，在 linux 上通常透過 network namespace 的機制來切割，不過也可能是一個獨立的 VM。</li> <li>network 是 endpoints 的集合，每個 endpoint 都有著一個唯一是別的的地址 (通常是 ip address) 可用於互相通訊。一個端點可能是一個容器、VM 或著路由器之類的網路設備。</li> <li>runtime 指的是呼叫執行 CNI plugin 的程式，以 k8s 來說，kubelet 作為這個角色</li> <li>plugin 指的是一個用來完成套用特定網路設定的程式。</li></ul> <p>CNI Spec 包含五個部分</p> <ol><li>Network configuration format: CNI 網路設定的格式</li> <li>Execution Protocol: runtime 和 CNI plugin 之間溝通的 protocol</li> <li>Execution of Network Configurations: 描述 runtime 如何解析 network configuration 和操作 CNI plugin。</li> <li>Plugin Delegation: 描述 CNI plugin 如何呼叫 CNI plugin。</li> <li>Result Types: 描述 CNI plugin 回傳的結果格式。</li></ol> <h2 id="section-1-network-configuration-format"><a href="#section-1-network-configuration-format" class="header-anchor">#</a> Section 1: Network configuration format</h2> <p>CNI 定義了一個網路設定的格式，這個格式用於 runtime 讀取的設定檔，也用於 runtime 解析後，plugin 接收的格式，通常來說設定檔是以 ** 靜態 ** 檔案的方式存在主機上，不會任意變更。</p> <p>CNI 使用了 JSON 作為設定檔的格式，並包含以下幾個主要欄位</p> <ul><li><code>cniVersion</code>  (string): 對應的 CNI spec 版本，當前是 1.0.0</li> <li><code>name</code>  (string): 一個在主機上不重複的網路名稱</li> <li><code>disableCheck</code>  (boolean): 如果 disableCheck 是 true 的話，runtime 就不能呼叫  <code>CHECK</code> ， <code>CHECK</code>  是 spec 定義的一個指令用來檢查網路是否符合 plugin 依據設定的結果，由於一個網路設定可能會呼叫多個 CNI plugins，因此可能會出現網路狀態符合管理員預期，但是 CNI plugin 之間衝突檢查失敗的情況，這時就可以設定 disableCheck</li> <li><code>plugin</code>  (list): CNI plugin 設定 (Plugin configuration object) 的列表。</li></ul> <h3 id="plugin-configuration-object"><a href="#plugin-configuration-object" class="header-anchor">#</a> <strong>Plugin configuration object</strong></h3> <p>plugin configuration object 包含了一些明定的欄位，但 CNI plugin 可能根據需要增加欄位，會由 runtime 在不修改的情況下送給 CNI plugin。</p> <ul><li>必填:
<ul><li><code>type</code>  (string): CNI plugin 的執行檔名稱</li></ul></li> <li>可選欄位 (CNI protocol 使用):
<ul><li><code>capabilities</code>  (dictionary): 定義 CNI plugin 支援的 capabilities，後面在 section 3 會介紹。</li></ul></li> <li>保留欄位：這些欄位是在執行過程中，由 runtime 生成出來的，因此不應該在設定檔內被定義。
<ul><li><code>runtimeConfig</code></li> <li><code>args</code></li> <li>任何  <code>cni.dev/</code>  開頭的 key</li></ul></li> <li>可選欄位：不是 protocol 定義的欄位，但是由於很多 CNI plugin 都有使用，因此具有特定的意義。
<ul><li>ipMasq (boolean): 如果 plugin 支援的話，會在 host 上替該網路設置 IP masquerade，如果 host 要做為該網路的 gateway 的話，可能需要該功能。</li> <li>ipam (dictionary): IPAM (IP Address Management) 設置，後面在 section 4 會介紹。</li> <li>dns (dictionary): DNS 設置相關設置
<ul><li>nameservers (list of strings): DNS server 的 IP 列表</li> <li>domain (string): DNS search domain</li> <li>search (list of strings),: DNS search domain 列表</li> <li>options (list of strings): DNS options 列表</li></ul></li></ul></li> <li>其他欄位: CNI plugin 自己定義的額外欄位。</li></ul> <p>設定檔範例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;cniVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dbnet&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bridge&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">//plugin specific parameters</span>
      <span class="token string">&quot;bridge&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cni0&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;keyA&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;some more&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin specific&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;configuration&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

      <span class="token string">&quot;ipam&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;host-local&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">//ipam specific</span>
        <span class="token string">&quot;subnet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10.1.0.0/16&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;gateway&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10.1.0.1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;routes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">&quot;dst&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0.0/0&quot;</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;dns&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;nameservers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;10.1.0.1&quot;</span> <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tuning&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;mac&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;sysctl&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;net.core.somaxconn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;500&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;portmap&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;portMappings&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="section-2-execution-protocol"><a href="#section-2-execution-protocol" class="header-anchor">#</a> Section 2: Execution Protocol</h2> <p>CNI 的工作模式是由 container runtime 去呼叫 CNI plugin 的 binaries，CNI Protocol 定義了 runtime 和 plugin 之間的溝通標準。</p> <p>CNI plugin 的工作是完成容器網路介面的某種設置，大致上可以分成兩類</p> <ul><li>Interface plugin: 建立容器內的網路介面，並確保其連接可用</li> <li>Chained plugin: 調整修改一個已建立的介面 (可能同時會需要建立更多額外的介面)</li></ul> <p>Runtime 透過兩種方式傳遞參數，一是透過環境變數，二是透過 stdin 傳遞 Section 1 定義的 configuration。如果成功的話，結果會透過 stdout 傳遞，如果失敗的話就會錯誤資訊會透過 stderr 傳遞。configuration 和結果、錯誤都是使用 JSON 格式。</p> <p>Runtime 必須在 Runtime 的網路執行，大多數情況下就是在主機的預設 network namespace/dom0</p> <h3 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h3> <p>Protocol 的參數都是透過環境變數來傳遞的，可能的參數如下</p> <ul><li>CNI_COMMAND: 當前執行的 CNI 操作 (可能是  <code>ADD</code> ,  <code>DEL</code> ,  <code>CHECK</code> .  <code>VERSION</code> )</li> <li>CNI_CONTAINERID: 容器的ＩＤ</li> <li>CNI_NETNS: 容器網路空間的參考，如果是使用 namespaces 的方式來切割的話，就是 namespce 的路徑（e.g.  <code>/run/netns/[nsname]</code>  )</li> <li>CNI_IFNAME: 要建立在容器內的介面名稱，如果 plugin 無法建立該名稱則回傳錯誤</li> <li>CNI_ARGS: 其他參數，Alphanumeric 格式的 key-value pairs，使用分號隔開”e.g.  <code>FOO=BAR;ABC=123</code></li> <li>CNI_PATH: CNI plugin 的搜尋路徑，因為 CNI 存在 CNI plugin 呼叫 CNI plugin 的情況，所以需要這個路徑。如果包含多個路徑，使用 OS 定義的分隔符號分割。Linux 使用  <code>:</code>  ，Windows 使用  <code>;</code></li></ul> <h3 id="errors"><a href="#errors" class="header-anchor">#</a> Errors</h3> <p>如果執行成功，CNI Plugin 應該回傳 0。如果失敗則回傳非 0，並從 stderr 回傳 error result type structure。</p> <h3 id="cni-operations"><a href="#cni-operations" class="header-anchor">#</a> CNI operations</h3> <h3 id="add"><a href="#add" class="header-anchor">#</a> ADD</h3> <p>CNI plugin 會在  <code>CNI_NETNS</code>  內建立  <code>CNI_IFNAME</code>  介面或對該介面套用特定的設置</p> <p>如果 CNI plugin 執行成功，應該從 stdout 回傳一個 result structure。如果 plugin 的 stdin 輸入包含 prevResult，他必些直接把 prevResult 包在 result structure 內或對他修改後在包在 result structure 內，runtime 會把前一個 CNI 輸出的 prevResult 包在下一個 CNI 的 stdin 輸入內。</p> <p>如果 CNI plugin 嘗試建立介面時，該介面已經存在，應該發出錯誤。</p> <p>Runtime 不應該在沒有 DEL 的情況下對一個  <code>CNI_CONTAINERID</code>  容器的一個  <code>CNI_IFNAME</code>  介面多次呼叫 ADD。不過可能對同一個 container 的不同介面呼叫 ADD。</p> <p>必有的輸入包含 STDIN JSON configuration object、  <code>CNI_COMMAND</code> 、 <code>CNI_CONTAINERID</code>  、  <code>CNI_NETNS</code>  和  <code>CNI_IFNAME</code>  。  <code>CNI_ARGS</code>  和  <code>CNI_PATH</code>  為可選項。</p> <h3 id="del"><a href="#del" class="header-anchor">#</a> DEL</h3> <p>移除  <code>CNI_NETNS</code>  內的  <code>CNI_IFNAME</code>  介面，或還原 ADD 套用的網路設定</p> <p>通常來說，如果要釋放的資源已經不存在，DEL 也應該視為成功。例如容器網路已經不存在了，一個 IPAM plugin 應該還是要正常的釋放 IP 和回傳成功，除非 IPAM plugin 對容器網路存在與否有嚴格的要求。即便是 DHCP plugin，雖然執行 DEL 操作的時侯，需要透過容器網路發送 DHCP release 訊息，但是由於 DHCP leases 有 lifetime 的機制，超時後會自動回收，因此即便容器網路不存在，DHCP plugin 在執行 DEL 操作時，也應該該回傳成功。</p> <p>如果重複對一個  <code>CNI_CONTAINERID</code>  容器的  <code>CNI_IFNAME</code>  介面執行多次 DEL 操作，plguin 都應該回傳，即便介面已經不存在或 ADD 套用的修改已經還原。</p> <p>必有的輸入包含 STDIN JSON configuration object、  <code>CNI_COMMAND</code> 、 <code>CNI_CONTAINERID</code>  和  <code>CNI_IFNAME</code> 。  <code>CNI_NETNS</code> 、 <code>CNI_ARGS</code>  和  <code>CNI_PATH</code>  為可選項。</p> <h3 id="check"><a href="#check" class="header-anchor">#</a> CHECK</h3> <p>Runtime 透過  <code>CHECK</code>  檢查容器的狀態，並確保容器網路符合預期。CNI spec 可以分為 plugin 和 runtime 的兩部分</p> <p>Plugin:</p> <ul><li>plugin 必須根據  <code>prevResult</code>  來判斷介面和地址是否符合預期</li> <li>plugin 必須接受其他 chained plugin 對介面修改的結果</li> <li>如果 plugin 建立並列舉在  <code>prevResult</code>  的 CNI Result type 資源 (介面、地址、路由規則) 不存在或不符合預期狀態，plugin 應該回傳錯誤</li> <li>如果其他不在 Result type 內的資源不存在或不符合預期也應該回垂錯誤。可能的資源如下
<ul><li>防火牆規則</li> <li>流量控管 (Traffic shaping controls)</li> <li>IP 保留 (Reservation)</li> <li>外部依賴，如連接所需的 daemon</li></ul></li> <li>如果發現容器網路是無法訪問的應該回傳錯誤</li> <li>plugin 必須在完成  <code>ADD</code>  後能夠立即處理  <code>CHECK</code>  指令，應此 plguin 應該要容忍非同步完成的網路設置在一定的時間內不符合預期。</li> <li>plugin 執行  <code>CHECK</code>  時，應該呼叫所有 delegated plugin 的  <code>CHECK</code> ，並把 delegated plugin 的錯誤傳給 plugin 的呼叫者</li></ul> <p>Runtime:</p> <ul><li>Runtime 不應該在未執行  <code>ADD</code>  前或已經  <code>DEL</code>  後沒在執行一次  <code>ADD</code>  的容器執行  <code>CHECK</code></li> <li>如果 configuration 的 disableCheck 為真，runtime 不應呼叫 disableCheck</li> <li>Runtime 呼叫  <code>CHECK</code>  時，configuration 必須在  <code>prevResult</code>  包含前一次  <code>ADD</code>  操作時最後一個 plugin 的 Result。Runtime 可能會使用 libcni 提供的 Result caching 功能。</li> <li>如果其中一個 plugin 回傳錯誤，runtime 可能不會呼叫後面 plugin 的  <code>CHECK</code></li> <li>Runtime 可能會在  <code>ADD</code>  完後的下一刻一直到  <code>DEL</code>  執行前的任何時間執行  <code>CHECK</code></li> <li>Runtime 可能會假設一個  <code>CHECK</code>  失敗的容器會永久處於配置錯誤的狀態</li></ul> <p>必有的輸入包含 STDIN JSON configuration object、  <code>CNI_COMMAND</code> 、 <code>CNI_CONTAINERID</code> 、 <code>CNI_NETNS</code>  和  <code>CNI_IFNAME</code> 。  <code>CNI_ARGS</code>  和  <code>CNI_PATH</code>  為可選項。</p> <p>除了  <code>CNI_PATH</code>  以外的參數必須和  <code>ADD</code>  時一致。</p> <h3 id="version"><a href="#version" class="header-anchor">#</a> VERSION</h3> <p>Plugin 透過 stdout 輸出 JSON 格式的 version result type object，用於查看 CNI plugin 的版本。</p> <p>Stdin 輸入的 JSON 物件只包含  <code>cniVersion</code> 。
環境變數參數只需要  <code>CNI_COMMAND</code> 。</p> <h2 id="section-3-execution-of-network-configurations"><a href="#section-3-execution-of-network-configurations" class="header-anchor">#</a> Section 3: Execution of Network Configurations</h2> <p>這個章節描述了 runtime 如何解析 network configuration，並執行 CNI plugins。Runtime 可能會想要新增、刪除、檢查 configuration，並對應到 CNI plugin 的  <code>ADD</code> ,  <code>DELETE</code> ,  <code>CHECK</code>  操作。這個章節也定義 configuration 是如何改變並提供給 plugin 的。</p> <p>對容器的 network configuration 操作稱之為 attachment，一個 attachment 通常對應到一個特定  <code>CNI_CONTAINERID</code>  容器的  <code>CNI_IFNAME</code>  介面。</p> <h3 id="生命週期"><a href="#生命週期" class="header-anchor">#</a> 生命週期</h3> <ul><li>Runtime 必須在呼叫任何 CNI Plugin 之前，為容器建立新的 network namespace</li> <li>Runtime 一定不能同時在一個容器執行多個 plugin 命令，但是同時處理多個容器是可以的。因此 plugin 必須能夠處理多容器 concurrency 的問題，並在共享的資源 (e.g. IPAM DB) 實作 lock 機制</li> <li>Runtime 必須確保  <code>ADD</code>  操作後必定執行一次  <code>DEL</code>  操作，即便  <code>ADD</code>  失敗。唯一可能的例外是如結點直接丟失之類的災難性事件。</li> <li><code>DEL</code>  操作可能連續多次執行</li> <li>network configuration 在 ADD 和 DEL 操作之間，以及不同的為 attachment 之間應該保持一致不變</li> <li>runtime 必須負責清除容器的 network namespace</li></ul> <h3 id="attachment-parameters"><a href="#attachment-parameters" class="header-anchor">#</a> Attachment Parameters</h3> <p>Network configuration 在不同的 attachments 間應該保持一致。不過 runtime 會傳遞其他每個 attachment 獨立的參數。</p> <ul><li>Container ID: 對應到 Section 2  <code>CNI_CONTAINERID</code>  環境變數</li> <li>Namespace: 對應到  <code>CNI_NETNS</code>  環境變數</li> <li>Container interface name: 對應到  <code>CNI_IFNAME</code>  環境變數</li> <li>Generic Arguments: 對應到  <code>CNI_ARGS</code>  環境變數</li> <li>Capability Arguments:</li> <li>CNI plugins search path: 對應到  <code>CNI_PATH</code>  環境變數</li></ul> <h3 id="adding-an-attachment"><a href="#adding-an-attachment" class="header-anchor">#</a> Adding an attachment</h3> <p>對 configuration 的  <code>plugins</code>  欄位的每個 plugin configuration 執行以下步驟</p> <ol><li>根據  <code>type</code>  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤</li> <li>根據 plugin configuration 生成送給 plugin sdtin 的 configuration</li></ol> <ul><li>只有第一個執行的 plugin 不會帶 prevResult 欄位，後續執行的 plugin 都會把前一個的 plugin 的結果放在 prevResult</li></ul> <ol><li>執行 plugin 的執行檔。設置  <code>CNI_COMMAND=ADD</code> ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration</li> <li>如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller</li></ol> <p>Runtime 必須持久保存最後一個 plugin 的結果，用於 check 和 delete 操作。</p> <h3 id="deleting-an-attachment"><a href="#deleting-an-attachment" class="header-anchor">#</a> Deleting an attachment</h3> <p>刪除 attachment 和添加基本上差不多的，差別是</p> <ul><li>plugin 的執行順序是反過來的，從最後一個開始</li> <li><code>prevResult</code>  欄永遠是上一次 add 操作時，最後一個 plugin 的結果</li></ul> <p>對 configuration 的  <code>plugins</code>  欄位反序的每個 plugin configuration 執行以下步驟</p> <ol><li>根據  <code>type</code>  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤</li> <li>根據 plugin configuration 和上次 ADD 執行的 result 生成送給 plugin sdtin 的 configuration</li> <li>執行 plugin 的執行檔。設置  <code>CNI_COMMAND=DEL</code> ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration</li> <li>如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller</li></ol> <h3 id="checking-an-attachment"><a href="#checking-an-attachment" class="header-anchor">#</a> Checking an attachment</h3> <p>如同 Section 2 所述，Runtime 會透過 CNI plugin 檢查每個 attachment 是否正常運作中。
需注意的是 Runtime 必須使用和 add 操作時一致的 attachment parameters</p> <p>檢查和添加只有兩個差別</p> <ul><li><code>prevResult</code>  欄永遠是上一次 add 操作時，最後一個 plugin 的結果</li> <li>如果 network configuation 中  <code>disableCheck</code>  為真，則直接回傳成功</li></ul> <p>對 configuration 的  <code>plugins</code>  欄位的每個 plugin configuration 執行以下步驟</p> <ol><li>根據  <code>type</code>  欄位尋找 CNI plugin 的執行檔，如果找不到則回傳錯誤</li> <li>根據 plugin configuration 和上次 ADD 執行的 result 生成送給 plugin sdtin 的 configuration</li> <li>執行 plugin 的執行檔。設置  <code>CNI_COMMAND=CHECK</code> ，提供前面定義的環境變數，以及透過 standard in 傳輸生成出來的 configuration</li> <li>如果 plugin 回傳錯誤，中斷執行並回傳錯誤給 caller</li></ol> <h3 id="deriving-execution-configuration-from-plugin-configuration"><a href="#deriving-execution-configuration-from-plugin-configuration" class="header-anchor">#</a> Deriving execution configuration from plugin configuration</h3> <p>在 add, delete, check 操作時，runtime 必須根據 network configuration 生成出 plugin 可以存取的 execution configuration (基本對應到 plugin configuration)，並填入內容。</p> <p>如同 section 2 所述，execution configuration 使用 JSON 格式並透過 stdin 傳給 CNI plugin。</p> <ul><li>必要的欄位如下:
<ul><li>cniVersion: 同 network configuraion 中 cniVersion 的值</li> <li>name: 同 network configuraion 中 name 的值</li> <li>runtimeConfig: runtime 需要和 plugin 可提供的 capabilities 的聯集 (capability 會在後面討論)</li> <li>prevResult: CNI plugin 回傳的 Result type 結果</li></ul></li> <li><code>capabilities</code>  欄位必須被移除</li> <li>其他 plugin configuration 的欄位應該被放入 execution configuration</li></ul> <h3 id="deriving-runtimeconfig"><a href="#deriving-runtimeconfig" class="header-anchor">#</a> Deriving runtimeConfig</h3> <p>相對於靜態的 network configuration 來說，runtime 可能會需要根據每個不同的 attachment 產生動態參數。
雖然 runtime 可以透過  <code>CNI_ARGS</code>  傳遞動態參數給 CNI plugin，但是我們沒辦法預期說 CNI plugin 會不會接收這個參數。透過 capabilities 欄位，可以明定 plugin 支援的功能，runtime 根據 capabilities 及需求，動態生成設定並填入  <code>runtimeConfig</code> 。CNI spec 沒有定義 capability，但是比較通用的 capability 有列舉在另外一份 <a href="https://github.com/containernetworking/cni/blob/main/CONVENTIONS.md#dynamic-plugin-specific-fields-capabilities--runtime-configuration" target="_blank" rel="noopener noreferrer">文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>以 kubernetes 常用的 Node port 功能來說，需要 CNI plugin 支援 portMappings 這個 capability。
在 section 1 的定義中，plugin configuration 包含了  <code>capabilities</code>  欄位，在這個欄位填入  <code>portMappings</code> ，讓 runtime 知道可以透過該 plugin 處理 port mapping。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;capabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;portMappings&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Runtime 執行 CNI plugin 時，會根據  <code>capabilities</code>  生成  <code>runtimeConfig</code> ，並填入對應的動態參數。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;runtimeConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;portMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;hostPort&quot;</span><span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
        <span class="token property">&quot;containerPort&quot;</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  ...
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="section-4-plugin-delegation"><a href="#section-4-plugin-delegation" class="header-anchor">#</a> Section 4: Plugin Delegation</h2> <p>雖然 CNI 的主要的架構是一系列的 CNI plkugin 依次執行，但這樣的方式有些時候沒辦法滿足 CNI 的需求。CNI plugin 可能會需要將某些功能委託給另外一個 CNI plugin，並存在 plugin 呼叫 plugin 的情況，最常見的案例就是 IP 地址的分配管理。</p> <p>通常來說，CNI plugin 應該要指定並維護容器的 IP 地址以及下達必要的 routing rules，雖然由 CNI plugin 自主完成可以讓 CNI plugin 有更大的彈性但是也加重了 CNI plugin 的職責和開發難度，讓不同的 CNI plugin 需要重複開發相同的 IP 地址管理邏輯，因此許多 CNI 將 IP 管理的邏輯委託給另一個獨立的 plugin，讓相關邏輯可以直接被複用。對此除了前面提到的 interface plugin 和 chanined plugin，我們定義了第三類的 plugin - IP Address Management Pligin (IPAM plugin)。</p> <p>由主要的 CNI plugin 去呼叫 IPAM plugin，IPAM plugin 判斷網路介面的 IP 地址、gateway、routing rules，並回傳資訊給主要的 CNI plugin 去完成相對應設置。(IPAM plugin 可能會透過 dhcp 之類的 protocl, 儲存在本地的檔案系統資訊或 network configuration 的 ipam section 取得資訊)</p> <h3 id="delegated-plugin-protocol"><a href="#delegated-plugin-protocol" class="header-anchor">#</a> Delegated Plugin protocol</h3> <p>和 Runtime 執行 CNI plugin 的方式一樣，delegated plugin 也是透過執行 CNI plugin 可執行程式的方式。主要的 plugin 在  <code>CNI_PATH</code>  路徑下搜尋 CNI plugin。delegated plugin 必須接收和主要 plugin 完全一致的環境變數參數，以及主要 plugin 透過 stdin 接收到的完整 execute configuration。
如果執行成功則回傳 0，並透過 stdout 返回 Success result type output。</p> <h3 id="delegated-plugin-execution-procedure"><a href="#delegated-plugin-execution-procedure" class="header-anchor">#</a> Delegated plugin execution procedure</h3> <ul><li>當 CNI plugin 執行 delegated plugin 時:
<ul><li>在  <code>CNI_PATH</code>  路徑下搜尋 plugin 的可執行程式</li> <li>使用 CNI plugin 的環境變數參數和 execute configuration，作為 delegated plugin 的輸入</li> <li>確保 delegated plugin 的 stderr 會輸出到 CNI plugin 的 stderr</li></ul></li> <li>當 plugin 執行 delete 和 check 時，必須執行所有的 delegated plugin，並將 delegated plugin 的錯誤回傳給 runtime</li> <li>當 ADD 失敗時，plugin 應該在回傳錯誤前，先執行 delegated plugin 的  <code>DEL</code></li></ul> <h2 id="section-5-result-types"><a href="#section-5-result-types" class="header-anchor">#</a> Section 5: Result Types</h2> <ul><li>Plugin 的回傳結果使用 JSON 格式，並有三種
<ul><li>Success</li> <li>Error</li> <li>Version</li></ul></li></ul> <h3 id="success"><a href="#success" class="header-anchor">#</a> Success</h3> <ul><li>如果 plugin 的輸入包含  <code>prevResult</code> ，輸出必須包含該欄位的值，並加上該 plugin 對網路修改的資訊，如果該 plugin 沒有任何操作，則該欄位必須保持原輸入內容。</li></ul> <p>Success Type Result 的欄位如下</p> <ul><li>cniVersion: 同輸入的  <code>cniVersion</code>  版本</li> <li>interfaces: 一個該 plugin 建立的 interface 資訊的陣列，包含 host 的 interface。
<ul><li>name: interface 的名子</li> <li>mac: interface 的 mac address</li> <li>sandbox: 該介面的網路環境參考，例如 network namespace 的路徑，如果是 host 介面則該欄位為空，容器內的介面該值應為  <code>CNI_NETNS</code></li></ul></li> <li>ips: 該 plugin 指定的 ip
<ul><li>address: CIDR 格式的 ip address (e.g. 192.168.1.1/24)</li> <li>gateway: default gateway (如果存在的話)</li> <li>interface: 介面的 index，對應到前述 interfaces 陣列</li></ul></li> <li>routes: plugin 建立的 routing rules
<ul><li>dst: route 的目的 (CIDR)</li> <li>gw: nexthop 地址</li></ul></li> <li>dns
<ul><li>nameservers: DNS server 位置陣列 (ipv4 或 ipv6 格式)</li> <li>domain: DNS 搜尋的 local domain</li> <li>search (list of strings): 有優先度的 search domain</li> <li>options (list of strings): 其他給 dns resolver 的參數</li></ul></li> <li>Delgated plugin 可能會忽略不需要的欄位
<ul><li>IPAM 必須回傳一個 abbreviated Success Type result (忽略 interfaces 和 ips 裡面的 interface 欄位)</li></ul></li></ul> <h3 id="error"><a href="#error" class="header-anchor">#</a> Error</h3> <p>plugin 回傳的錯誤資訊，欄位有  <code>cniVersion</code> ,  <code>code</code> ,  <code>msg</code> ,  <code>details</code> 。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;cniVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Invalid Configuration&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Network 192.168.0.0/31 too small to allocate from.&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Error code 0-99 被保留給通用的錯誤，100 以上是 plugin 自定義的錯誤。</p> <table><thead><tr><th>Error code</th> <th>描述</th></tr></thead> <tbody><tr><td>1</td> <td>不支援的 CNI 版本</td></tr> <tr><td>2</td> <td>不支援的 network configuration 欄位，error message 會包含不支援的欄位名稱和數值</td></tr> <tr><td>3</td> <td>未知或不存在的容器，這個錯誤同時代表 runtime 不需要執行 DEL 之類的清理操作</td></tr> <tr><td>4</td> <td>無效的環境環境變數參數，error message 會包含無效的欄位名稱</td></tr> <tr><td>5</td> <td>IO 錯誤，例如無法讀取 stdin 的 execute configuration</td></tr> <tr><td>6</td> <td>解析錯誤，例如無效的 execute configuration JSON 格式</td></tr> <tr><td>7</td> <td>無效的 network configuration</td></tr> <tr><td>11</td> <td>稍後在嘗試，存在暫時無法操作的資源，runtime 應該稍後重試</td></tr></tbody></table> <ul><li>此外，stderr 也可被用於非 JSON 結構的錯誤訊息，如 log</li></ul> <h3 id="version-2"><a href="#version-2" class="header-anchor">#</a> Version</h3> <ul><li>Version Type Result 的欄位如下
<ul><li>cniVersion: 同輸入的  <code>cniVersion</code>  版本</li> <li>supportedVersions: 一個支援的 CNI 版本陣列</li></ul></li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;cniVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;supportedVersions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0.1.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.3.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.3.1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.4.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="appendix"><a href="#appendix" class="header-anchor">#</a> Appendix:</h2> <p>在 CNI SPEC 裏面包含了一些 configuration 和執行過程中 plugin 輸入輸出的範例，可以參考 <a href="https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md#appendix-examples" target="_blank" rel="noopener noreferrer">原始文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
另外還有一份 CNI 的文件 <a href="https://github.com/containernetworking/cni/blob/main/CONVENTIONS.md" target="_blank" rel="noopener noreferrer">CONVENTIONS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，描述許多 spec 裡面沒有定義但是許多 plugin 常用的欄位。</p> <h2 id="小節"><a href="#小節" class="header-anchor">#</a> 小節</h2> <p>以上是對 <a href="https://github.com/containernetworking/cni/blob/spec-v1.0.0/SPEC.md" target="_blank" rel="noopener noreferrer">CNI spec 1.0.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的導讀，希望對大家有幫助。</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Kubernetes" title="標簽">#Kubernetes</a><a href="/tags/?tag=CNI" title="標簽">#CNI</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/29</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.fd10c8b2.js" defer></script><script src="/assets/js/2.abd11f75.js" defer></script><script src="/assets/js/9.e1595287.js" defer></script>
  </body>
</html>
