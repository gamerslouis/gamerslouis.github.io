<!doctype html><html lang=zh-tW dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-tw"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>學習 eBPF 系列 2 - 基本概念 &#183; Louis Li's Blog</title>
<meta name=title content="學習 eBPF 系列 2 - 基本概念 &#183; Louis Li's Blog"><meta name=description content="2022 iThome 鐵人賽 學習 eBPF 系列 介紹 eBPF 的基本概念"><meta name=keywords content="2022 iThome 鐵人賽 - 學習 eBPF 系列,技術分享,"><link rel=canonical href=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/><link type=text/css rel=stylesheet href=/css/main.bundle.min.a9788a8e9a1ecc2f085a494b293cc03e66101a4a399d18136fe4092798df8daa0d5e5332c2a12328277554486a6e6b09174f578643315873767b88c5cde1c748.css integrity="sha512-qXiKjpoezC8IWklLKTzAPmYQGko5nRgTb+QJJ5jfjaoNXlMywqEjKCd1VEhqbmsJF09XhkMxWHN2e4jFzeHHSA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js integrity="sha512-oteNeGcuVJ+/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/"><meta property="og:site_name" content="Louis Li's Blog"><meta property="og:title" content="學習 eBPF 系列 2 - 基本概念"><meta property="og:description" content="2022 iThome 鐵人賽 學習 eBPF 系列 介紹 eBPF 的基本概念"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-31T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-31T00:00:00+00:00"><meta property="article:tag" content="2022 IThome 鐵人賽 - 學習 EBPF 系列"><meta property="article:tag" content="技術分享"><meta property="og:image" content="https://blog.louisif.me/og_image.png"><meta name=twitter:card content="summary"><meta name=twitter:title content="學習 eBPF 系列 2 - 基本概念"><meta name=twitter:description content="2022 iThome 鐵人賽 學習 eBPF 系列 介紹 eBPF 的基本概念"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"文章","name":"學習 eBPF 系列 2 - 基本概念","headline":"學習 eBPF 系列 2 - 基本概念","description":"2022 iThome 鐵人賽 學習 eBPF 系列 介紹 eBPF 的基本概念","inLanguage":"zh-tw","url":"https:\/\/blog.louisif.me\/posts\/learn-ebpf-serial-2-basic-concept\/","author":{"@type":"Person","name":"Louis Li"},"copyrightYear":"2022","dateCreated":"2022-10-31T00:00:00\u002b00:00","datePublished":"2022-10-31T00:00:00\u002b00:00","dateModified":"2022-10-31T00:00:00\u002b00:00","keywords":["2022 iThome 鐵人賽 - 學習 eBPF 系列","技術分享"],"mainEntityOfPage":"true","wordCount":"6589"}]</script><meta name=author content="Louis Li"><link href=mailto:me@louisif.me rel=me><link href=https://github.com/gamerslouis rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-79VDS4QY8D"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-79VDS4QY8D")</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>快轉到主要內容</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>Louis Li&rsquo;s Blog</span>
<img src=/img/logo512.png width=32 height=32 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Louis Li's Blog"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Louis Li&rsquo;s Blog</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>首頁</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>文章</p></a><a href=/categories/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>分類</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>標籤</p></a><a href=/awesome/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Awesome</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>首頁</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>文章</p></a></li><li class=mt-1><a href=/categories/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>分類</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>標籤</p></a></li><li class=mt-1><a href=/awesome/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Awesome</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">學習 eBPF 系列 2 - 基本概念</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-10-31T00:00:00+00:00>October 31 2022</time><span class="px-2 text-primary-500">&#183;</span><span>6589 字</span><span class="px-2 text-primary-500">&#183;</span><span title=預計閱讀時間>14 分鐘</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.eea5245cf9244ecbdf2c150d1c8833226c1541cadf6e98f63a7c9192b1a3676df2c3ec603b14f4cfaaa53971fd9d8955640c0f405bf3de2b43ee7a5fb29ae721.js integrity="sha512-7qUkXPkkTsvfLBUNHIgzImwVQcrfbpj2OnyRkrGjZ23yw+xgOxT0z6qlOXH9nYlVZAwPQFvz3itD7npfsprnIQ=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title data-title-i18n-disable data-title-i18n-enable><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/categories/ebpf/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">EBPF
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/2022-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD---%E5%AD%B8%E7%BF%92-ebpf-%E7%B3%BB%E5%88%97/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">2022 IThome 鐵人賽 - 學習 EBPF 系列
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">技術分享</span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Louis Li" src=/img/avatar_hu12588003992603441027.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Louis Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">努力畢業的菸酒生</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:me@louisif.me target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/gamerslouis target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目錄</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#program-type>Program Type</a></li><li><a href=#使用流程>使用流程</a></li><li><a href=#使用條件>使用條件</a></li><li><a href=#載入流程>載入流程</a></li><li><a href=#jit>JIT</a></li><li><a href=#生命週期>生命週期</a></li><li><a href=#helper-funtions>Helper Funtions</a></li><li><a href=#debug-tracing>Debug Tracing</a></li><li><a href=#map>Map</a><ul><li><a href=#原始碼解析>原始碼解析</a></li><li><a href=#使用範例>使用範例</a></li><li><a href=#map-載入流程>map 載入流程</a></li><li><a href=#map-持久化>Map 持久化</a></li></ul></li><li><a href=#tail-call>Tail call</a><ul><li><a href=#如何使用>如何使用</a></li></ul></li><li><a href=#參考資料>參考資料</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目錄</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#program-type>Program Type</a></li><li><a href=#使用流程>使用流程</a></li><li><a href=#使用條件>使用條件</a></li><li><a href=#載入流程>載入流程</a></li><li><a href=#jit>JIT</a></li><li><a href=#生命週期>生命週期</a></li><li><a href=#helper-funtions>Helper Funtions</a></li><li><a href=#debug-tracing>Debug Tracing</a></li><li><a href=#map>Map</a><ul><li><a href=#原始碼解析>原始碼解析</a></li><li><a href=#使用範例>使用範例</a></li><li><a href=#map-載入流程>map 載入流程</a></li><li><a href=#map-持久化>Map 持久化</a></li></ul></li><li><a href=#tail-call>Tail call</a><ul><li><a href=#如何使用>如何使用</a></li></ul></li><li><a href=#參考資料>參考資料</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>本篇文章將會介紹包含 program type, map 等重要概念還有 eBPF 的載入流程</p><h2 class="relative group">Program Type<div id=program-type class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#program-type aria-label=定位點>#</a></span></h2><p>我們可以把 eBPF 程式區分成不同的 BPF program type，不同的 program type 代表實現不同功能的 eBPF 程式。通常不同的 program type 也會有不同 hook point，eBPF 程式的輸入和輸出格式也不同，也就影響到不同的 kernal 組件。</p><p>到目前 Linux kernal 5.19 版，linux 總共定義了 32 種的 program type。在 linux kernal source code 的 <a href=https://github.com/torvalds/linux/blob/master/include/uapi/linux/bpf.h target=_blank>include/uapi/linux/bpf.h</a> 中定義了 <code>bpf_prog_type</code> 列舉，列舉了所有的 program type。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>enum</span> <span class=n>bpf_prog_type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_UNSPEC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_SOCKET_FILTER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_KPROBE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_SCHED_CLS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_SCHED_ACT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_TRACEPOINT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_XDP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_PERF_EVENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_CGROUP_SKB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>BPF_PROG_TYPE_CGROUP_SOCK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>以 <code>BPF_PROG_TYPE_XDP</code> 為例，XDP 是 <code>Express Data Path</code> 的縮寫，XDP 程式會在封包從網路卡進入到 kernal 的最早期被觸發。</p><p>一個 eBPF 程式大致上可以看成一個 c 的 function，在 XDP program type 下，kernal 會帶入 xdp_md 資料結構作為 eBPF 程式的輸入，包含了封包的內容、封包的來源介面等資訊。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//include/uapi/linux/bpf.h
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* user accessible metadata for XDP packet hook */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>xdp_md</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>data_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>data_meta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Below access go through struct xdp_rxq_info */</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>ingress_ifindex</span><span class=p>;</span> <span class=cm>/* rxq-&gt;dev-&gt;ifindex */</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>rx_queue_index</span><span class=p>;</span>  <span class=cm>/* rxq-&gt;queue_index  */</span>
</span></span><span class=line><span class=cl>    <span class=n>__u32</span> <span class=n>egress_ifindex</span><span class=p>;</span>  <span class=cm>/* txq-&gt;dev-&gt;ifindex */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>eBPF 程式必須回傳一個 <code>xdp_action</code> 的 enum，其中 <code>XDP_PASS</code> 表示封包可以繼續通過到 kernal network stack，<code>XDP_DROP</code> 表示直接丟棄該封包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//include/uapi/linux/bpf.h
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>enum</span> <span class=n>xdp_action</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>XDP_ABORTED</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>XDP_DROP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>XDP_PASS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>XDP_TX</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>XDP_REDIRECT</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>透過這樣的 eBPF 程式，我們就可以在封包剛進入 kernal 的時候直接丟棄非法封包，能夠比較高效的處理 DDos 攻擊等問題。</p><p>以此可以寫出一個極簡單的 eBPF 程式範例 (只包含最主要的部份，完整的程式寫法會在後面提到)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>xdp_prog_simple</span> <span class=p>(</span><span class=k>struct</span> <span class=n>xdp_md</span> <span class=o>*</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>XDP_DROP</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這個 eBPF 程式可以被 attach 到某一個 interface 上，當封包進來時會被呼叫。由於無條件回傳 XDP_DROP，因此會丟棄所有的封包。</p><h2 class="relative group">使用流程<div id=%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B aria-label=定位點>#</a></span></h2><p>eBPF 程式碼要被編譯成 eBPF 虛擬機的 bytecode 才能夠執行。
以 XDP 為例，最底層的做法是直接使用 LLVM 編譯這段 eBPF 程式碼。
首先需要補齊使用 LLVM 編譯時，需要的 header file 和資訊。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;uapi/linux/bpf.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nf>SEC</span> <span class=p>(</span><span class=s>&#34;xdp_prog&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kt>int</span>  <span class=nf>xdp_program</span><span class=p>(</span><span class=k>struct</span> <span class=n>xdp_md</span> <span class=o>*</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>XDP_DROP</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>_license</span> <span class=p>[]</span> <span class=nf>SEC</span> <span class=p>(</span><span class=s>&#34;license&#34;</span><span class=p>)</span> <span class=o>=</span> <span class=s>&#34;GPL&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>接著使用 LLVM 編譯成 ELF 格式文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>clang -c -target bpf xdp.c -o xdp.o
</span></span></code></pre></div><p>然後使用 <code>bpf</code> system call 將 bytecode 載入到 kernal 的 eBPF 虛擬機內，並取得對應的 file descriptor。最後透過 netlink socket 發送一個 <code>NLA_F_NESTED | 43</code> 訊息來把 interface index 與 ebpf 程式的 file descriptor 綁定。就能夠讓 eBPF 程式在對應的 interface 封包處理過程中被呼叫。</p><p>iproute2 有實作載入 eBPF 的功能，因此可以透過下指令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip link <span class=nb>set</span> dev eth1 xdp xdp.o
</span></span></code></pre></div><p>可能會注意在程式碼的最後一行。特別標註了 GPL licence。由於 eBPF 程式會嵌入到 kernel，與 kernel 緊密的一起執行 (共用 address space、權限等)，在法律判斷獨立程式的邊界時，eBPF 程式和相關的 kernel 組件會被視為一體，因此 eBPF 程式會受到相關的 licence 限制。</p><p>而這邊提到的內核組件指的是 eBPF helper function。helper function 是 eBPF 程式與 kernel 溝通的橋梁，由於 eBPF 程式是在 eBPF 虛擬機內執行，因此如果要取得 kernel 的額外資訊或改變 kernel 的行為，必須透過虛擬機提供的 helper function 接口。</p><p>一部份的 helper function 基於 GPL 授權，因此當 eBPF 程式使用了 GPL 授權的 helper function 就必須標示為 GPL 授權，否則將 eBPF 程式載入到 kernel 時，會直接被 kernel 拒絕。</p><p>直接使用最底層的方法開發相對來說是不方便和困難的，不同 program type 的載入方式可能還完全不一樣，因此許多抽象的框架和 SDK 被發出來。雖然還是需要編寫 eBPF 的 c code，但是編譯、載入、溝通等工作被包在 SDK 裡面，可以方便的直接使用。</p><p>這邊舉例 BPF Compiler Collection (BCC) 這套工具，BCC 將 eBPF 的編譯和載入動作包裝成了 python 的 API，因此能夠簡單的完成 eBPF 的編譯和執行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bcc</span> <span class=kn>import</span> <span class=n>BPF</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>BPF</span> <span class=p>(</span><span class=n>text</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>#include &lt;uapi/linux/bpf.h&gt;
</span></span></span><span class=line><span class=cl><span class=s2>int xdp_prog1 (struct xdp_md *ctx)
</span></span></span><span class=line><span class=cl><span class=s2>{
</span></span></span><span class=line><span class=cl><span class=s2>    return XDP_DROP;
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fn</span> <span class=o>=</span> <span class=n>b</span><span class=o>.</span><span class=n>load_func</span> <span class=p>(</span><span class=s2>&#34;xdp_prog1&#34;</span><span class=p>,</span> <span class=n>BPF</span><span class=o>.</span><span class=n>XDP</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=o>.</span><span class=n>attach_xdp</span> <span class=p>(</span><span class=s2>&#34;wlp2s0&#34;</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>time</span><span class=o>.</span><span class=n>sleep</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=o>.</span><span class=n>remove_xdp</span> <span class=p>(</span><span class=s2>&#34;wlp2s0&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><h2 class="relative group">使用條件<div id=%E4%BD%BF%E7%94%A8%E6%A2%9D%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%BF%E7%94%A8%E6%A2%9D%E4%BB%B6 aria-label=定位點>#</a></span></h2><p>在開始玩 eBPF 之前，我們要先確定一下我們的環境能夠使用 eBPF。最早在 kernal 3.15 版加入了 eBPF 功能。後續在 3.15 到現在的 5.19 版間，eBPF 陸陸續續加入了許多新的功能，因此開發的時候，如果不是使用最新版的作業系統，就可能會需要確認一下版本是否支援，各個功能支援的版本可以在 <a href=https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md target=_blank>這邊</a> 參考</p><p>另外就是 eBPF 的功能需要在編譯 kernel 的時候啟用，大部分的發行版應該都直接啟用了，不過如果使用時出現問題可能還是到 <code>/proc/config.gz</code> 或 <code>/boot/config-&lt;kernel-version></code> 檢查內核編譯的設定，是否有開啟 <code>CONFIG_BPF</code>, <code>CONFIG_BPF_SYSCALL</code>, <code>CONFIG_BPF_JIT</code> 還有其他 BPF 相關 Kernal 選項。
設定可以參考 bcc 的 <a href=https://github.com/iovisor/bcc/blob/master/INSTALL.md#kernel-configuration target=_blank>安裝需求</a></p><h2 class="relative group">載入流程<div id=%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B aria-label=定位點>#</a></span></h2><p>當 eBPF 程式編譯完成後，就需要透過 <code>bpf</code> system call (<a href=https://elixir.bootlin.com/linux/v5.13/source/kernel/bpf/syscall.c#L4369 target=_blank>原始碼</a>)，將編譯後的 bytecode 載入 kernel 內執行。</p><p>為了安全性考量，要掛載 eBPF 程式需要 root 權限或 <code>CAP_BPF</code> capability，不過目前也有在設計讓非 root 權限帳號能載入 eBPF 程式，因此將 <code>kernel.unprivileged_bpf_disabled</code> sysctl 設置為 false 的情況下，非 root 帳號是有能力能夠使用 <code>BPF_PROG_TYPE_SOCKET_FILTER</code> 的 eBPF 程式。</p><p>eBPF 程式需要嵌入到 kernel 執行，因此 eBPF 程式的安全性是極為重要的，也要避免 eBPF 程式的錯誤有可能會導致 kernel 崩潰或卡死，因此每個載入 kernel 的 eBPF 程式都要先經過接著 verifier 檢查。</p><p>首先 eBPF 程式必須要在有限的時間內執行完成，不然就會造成 kernel 卡死，因此在早期的版本中 verifier 是拒絕任何 loop 的存在的，整個程式碼必須是一張 DAG (有向無環圖)。不過在 kernel 5.3 版本開始，verifier 允許了有限次數的循環，verifier 會透過模擬執行檢查 eBPF 是不是會在有限次數內在所有可能的分支上走到 <code>bpf_exit</code>。</p><p>接著 eBPF 程式的大小也存在限制，早期只一個 eBPF 程式只允許 4096 個 ebpf vm 的 instruction s，在設計比較複雜的 eBPF 程式上有些捉襟見肘，因此後來在 <a href=https://github.com/torvalds/linux/commit/c04c0d2b968ac45d6ef020316808ef6c82325a82 target=_blank>5.2 版</a> 這個限制被放寬成 1 million 個指令，基本上是十分夠用了，也還是能確保 ebpf 程式在 1/10 秒內執行完成。</p><p>然後程式的 stack 也存在大小限制，目前限制是 512。</p><p>當然 verifier 檢查的項目不只如此，前面提到 non-GPL licence eBPF 程式使用 GPL licence 的 helper function，也會被 verifier 拒絕，並收到一個 <code>cannot call GPL-restricted function from non-GPL compatible program</code> 的錯誤。</p><p>此外 verifier 也會針對 helper function 的函數呼叫參數合法性，暫存器數值合法性，或其他無效的使用方式、無效的回傳數值、特定必須的資料結構是否定義、是否非法存取修改數據、無效的 instruction 參數等等做出檢查以及拒絕存在無法執行到的程式碼。</p><p>具體的 verifier 可以參考 1 萬 5 千行的 <a href=https://github.com/torvalds/linux/blob/master/kernel/bpf/verifier.c target=_blank>原始碼</a></p><h2 class="relative group">JIT<div id=jit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#jit aria-label=定位點>#</a></span></h2><p>當 eBPF 程式通過 verifier 的驗證之後會進行 JIT (Just In Time) 的二次編譯。之前一直提到 eBPF 是一個執行在 kernel 內的虛擬機，因此編譯出來的 bytecode 需要再執行的過程中在轉換成 machine code，才能夠真正在 CPU 上面執行，然而這樣的虛擬化和轉換過程，會造成 eBPF 程式的執行效率，比直接執行 machine code 要低上很多。</p><p>因此 eBPF 加入了 JIT 的功能，簡單來說就是把 eBPF 的 bytecode 預先在載入的時候，直接編譯成 CPU 可執行的 machine code，在執行 eBPF 程式的時候就可以直接執行，而不用再經過 eBPF 虛擬機的轉換，使 eBPF 可以達到原生程式的執行效率。</p><p>由於 JIT 需要編譯出 machine code，因此針對不同的 CPU 平台他的支援是分開的，不過當然到了現在，基本上大部分主流的 CPU 架構 (x86, ARM, RISC, MIPS…) 都已經支援了，具體的支援情況可以參考這張 <a href=https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#jit-compiling target=_blank>表</a>。</p><p>同樣 JIT 是 eBPF 的一個可開關的獨立功能，透過設置 bpf_jit_enable 來啟用 JIT 的功能</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systcl -w net.core.bpf_jit_enable<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>(設置為 2 的話，可以在 kernel log 看到相關日誌)</p><p>到此 eBPF 程式就就完成載入了，雖然在 eBPF 程式的載入過程中還會完成一些資料結構的建立和維護，但是這個部分就不再本文的範圍內了。</p><p>當然到此 eBPF 程式只是載入到了內核之中，並未連接到任何的 hook point，因此到此為 eBPF 程式還未能真正被執行，不過這就是後面的故事了。</p><blockquote><p>從 kernel source code 來看，在 eBPF 程式載入的過程中會呼叫 <a href=https://elixir.bootlin.com/linux/v5.13/source/kernel/bpf/core.c#L1840 target=_blank>bpf_prog_select_runtime</a> 來判斷是否要呼叫 JIT compiler 去編譯，有興趣可以去 trace 這部分的 code。</p></blockquote><h2 class="relative group">生命週期<div id=%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F aria-label=定位點>#</a></span></h2><p>在透過 <code>bpf (BPF_PROG_LOAD, ...)</code> system call 將 eBPF 程式載入內核的過程 (可以參考 <a href=https://elixir.bootlin.com/linux/v5.13/source/kernel/bpf/syscall.c#L2079 target=_blank>原始碼</a>)，會替該 eBPF 程式建立 <code>struct bpf_prog</code> <a href=https://elixir.bootlin.com/linux/v5.13/source/include/linux/filter.h#L550 target=_blank>結構</a>，其中 <code>prog->aux->refcnt</code> 計數器記錄了該 eBPF 程式的參考數量，載入的時候會透過 <code>atomic64_set (&amp;prog->aux->refcnt, 1);</code> 將 refcnt 設置為一，並返為對應的 file descriptor。</p><p>當 refcnt 降為 0 的時候，就會觸發 unload，將 eBPF 程式資源給釋放掉。(<a href=https://elixir.bootlin.com/linux/v5.13/source/kernel/bpf/syscall.c#L1714 target=_blank>原始碼</a>)
因此如果呼叫 <code>BPF_PROG_LOAD</code> 的程式沒有進一步操作，並直接結束的話，當 file descriptor 被 release，就會觸發 refcnt–，而變成 0 並移除 eBPF 程式。</p><p>要增加 eBPF 程式 refcnf 大致上有幾種方式</p><ul><li>透過 bpf systemcall 的 BPF_BTF_GET_FD_BY_ID 等方式取得 eBPF 程式對應的 file descriptor</li><li>將 eBPF 程式 attach 到事件、Link 上，使 eBPF 程式能真的開始工作。<ul><li>因此當 eBPF 被 attach 到 hook points 上之後，即便原始載入程式結束也不會導致 eBPF 程式被回收，而可以正常繼續工作。</li><li>Link 是 eBPF 後來提供的新特性，因此暫時超出了本文的討論範圍</li></ul></li><li>透過 bpf systemcall 的 BPF_OBJ_PIN，將 eBPF 程式釘到 BPFFS 上。<ul><li>BPFFS 是 BPF file system，本質上是一個虛擬的檔案系統，一樣透過 bpf system call 的 BPF_OBJ_PIN，我們可以把 eBPF 程式放到 <code>/sys/fs/bpf/</code> 路徑下的指定位置，並透過 <code>open</code> 的方式直接取得 file descriptor。PIN 同樣會增加 refcnt，因此 PIN 住的程式不會被回收</li><li>要釋放 PIN 住的程式，可以使用 unlink 指令移除虛擬檔案，即可取消 PIN。</li></ul></li></ul><p>透過以上的操作都會增加 refcnt，相反的，對應的資源釋放則會減少 refcnt。因此只要確保有任何一個 eBPF 程式的參考存在，即可保證 eBPF 程式一直存在 kernel 內。</p><h2 class="relative group">Helper Funtions<div id=helper-funtions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#helper-funtions aria-label=定位點>#</a></span></h2><p>之前在介紹 eBPF 的 GPL 授權的時候，有提到 eBPF helper function 這個東西，接下來我們來比較仔細的介紹一下。</p><p>之前提到 eBPF 程式是在 eBPF 虛擬機內執行，由於 eBPF 程式會嵌入 kernel 內，在 kernel space 執行，所以為了安全性考量我們不能讓 eBPF 程式任意的存取和修改 kernel 記憶體和呼叫 kernel 函數，因此 eBPF 的解決方案是提供了一系列的 API，讓 eBPF 程式只能夠過限定的 API 去與 kernel 溝通，因此可以讓 eBPF 程式對 kernel 的操作限制在一個可控的範圍，也可以透過 verifier 和 API 後面的實作去確保 API 呼叫的有效和安全性。</p><p>在 eBPF 裡這一系列的 API 就稱之為 eBPF helper funtions。</p><p>另外不同的對於 eBPF program type 的 eBPF 程式，由於他們執行的時機點和在 kernel 的位置不同，因此他們能夠取得的 kernel 資訊也就不同，他們可以呼叫執行的 helper funtions 也就不同。具體每個不同 program type 可以執行的 helper function 可以參考 bcc 的 <a href=https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#program-types target=_blank>文件</a></p><p>下面列幾舉個所有 program type 都可以呼叫的 helper function</p><ul><li>u64 bpf_ktime_get_ns (void)<ul><li>取得從開機開始到現在的時間，單位是奈秒</li></ul></li><li>u32 bpf_get_prandom_u32 (void)<ul><li>取得一個 random number</li></ul></li></ul><p>接著我們舉例在 BPF_PROG_TYPE_SOCKET_FILTER 下才能使用的 helper function</p><ul><li>long bpf_skb_load_bytes (const void *skb, u32 offset, void *to, u32 len)<ul><li>由於 socket filter 的功能就是對 socket 的流量做過濾，因此我們可以透過 skb_load_bytes 來取得 socket 傳輸的封包內容</li></ul></li></ul><p>完整的 helper function 列表還有每個函數具體的定義以及使用說明描述可以在 <a href=https://github.com/torvalds/linux/blob/master/include/uapi/linux/bpf.h target=_blank>bpf.h</a> 查找到。</p><p>另外特別要注意的是受限於 eBPF 虛擬機的限制，eBPF helper function 的參數數量最多只可以有五個，在使用不定參數長度的參數時，最多也只能有 5 個參數 (如之後會提到的 trace_printk)。</p><p>因此雖然 eBPF 非常強大能夠非常方便的動態對 kernel 做修改，但為了安全，他可以執行的操作是訂定在一個非常嚴格的框架上的，在開發時需要熟習整個框架的限制和可利用的 API 資源。</p><h2 class="relative group">Debug Tracing<div id=debug-tracing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#debug-tracing aria-label=定位點>#</a></span></h2><p>在將 eBPF 程式載入 kernel 工作後，我們勢必需要一些手段來與 eBPF 程式做溝通，一方面我們需要輸出偵錯訊息，來對 eBPF 程式 debug，一方面我們可能會希望能夠實時透過 eBPF 程式取得 kernel 的某些資訊又或著動態調整 eBPF 程式的執行規則。</p><p>如果只是需要 eBPF 程式單方面的輸出訊息，讓我們可以偵錯，可以使用比較簡單的手段。eBPF 有提供一個 helper function <code>long bpf_trace_printk (const char *fmt, u32 fmt_size, ...)</code>，可以輸入一個格式化字串 <code>fmt</code>，及最多三個變數 (參數個數的限制)。輸出結果會被輸出到 <code>/sys/kernel/debug/tracing/trace_pipe</code> 中。.</p><p>可以透過指令查看輸出結果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo cat /sys/kernel/debug/tracing/trace_pipe
</span></span></code></pre></div><p>輸出的格式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>telnet-470   [001] .N.. 419421.045894: 0x00000001: &lt;formatted msg&gt;
</span></span></code></pre></div><ul><li>首先是 process name <code>telnet</code>，然後是 PID 470。</li><li>接續的 001 是指當前執行的 CPU 編號。</li><li>.N.. 的每個字元對應到一個參數<ul><li>irqs 中斷是否啟用</li><li><code>TIF_NEED_RESCHED</code> 和 <code>PREEMPT_NEED_RESCHED</code> 是否設置 (用於 kernel process scheduling)</li><li>硬中断 / 軟中断是否發生中</li><li>level of preempt_disabled</li></ul></li><li>419421.045894 時間</li><li>0x00000001: eBPF 內部的指令暫存器數值</li></ul><p>雖然 trace_printk 可以接收格式化字串，但是支援的格式字元比較少，只支援 <code>% d, % i, % u, % x, % ld, % li, % lu, % lx, % lld, % lli, % llu, % llx, % p, % s</code>。</p><p>另外有一個 bpf_printk 巨集，會使用 sizeof (fmt) 幫忙填上第二個 fmt_size。因此使用 bpf_printk 可以省略 fmt_size。</p><p>在比較新的版本提供了 bpf_snprintf 和 bpf_seq_printf 兩個新的 print 函數，前者是把資料寫入預先建立好的 buffer 內，後者可以寫入在特定 program type 下可以取得的 seg_file，兩者皆用陣列存放後面的參數列，因此可以打破 helper funtion 5 個參數的限制。</p><p>最後要特別注意的是使用 trace_printk 會大幅拖慢 eBPF 程式的執行效率，所以 trace_printk 只適用於開發時用來 debug 使用，不適用於正式環境當中。</p><h2 class="relative group">Map<div id=map class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#map aria-label=定位點>#</a></span></h2><p>接著介紹 eBPF 的另外一個重要組件 <code>map</code>，前面提到 trace_printk 只適合用在除錯階段，輸出 eBPF 的執行資訊到 user space，然而我們需要一個可以在正式環境內，提供 user space 程式和 eBPF 程式之間雙向數據交換的能力，另外每次觸發 eBPF 程式都可看作獨立執行 eBPF 程式，所以也需要在多次呼叫 eBPF 程式時共享資料的功能。因此 eBPF 程式引入了 <code>map</code>。</p><p>eBPF map 定義了一系列不同的不同的資料結構類型，包含了 hash, array, LRU hash, ring buffer, queue 等等，另外也提供 per-cpu hash, per-cpu array 等資料結構，由於每顆 CPU 可以獲得獨立的 map，因此可以減少 lock 的需求，提高執行效能。所有的 map type 一樣可以參考 <a href=https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/bpf.h#n880 target=_blank>bpf.h</a> 的 <code>enum bpf_map_type</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>bpf_map_def</span> <span class=nf>SEC</span> <span class=p>(</span><span class=s>&#34;maps&#34;</span><span class=p>)</span> <span class=n>map</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>BPF_MAP_TYPE_ARRAY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>key_size</span> <span class=o>=</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>int</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>value_size</span> <span class=o>=</span> <span class=k>sizeof</span> <span class=p>(</span><span class=n>__u32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>max_entries</span> <span class=o>=</span> <span class=mi>4096</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>首先要先在 eBPF 程式內定義 map 的資料結構，在 eBPF 程式內定義一個 map 時，基本需要定義四個東西分別是該資料結構的 map type, key 和 value 的大小以及資料結構內最多有含多少 entry，如果超出 max_entries 上限則會發生錯誤回傳 (-E2BIG)。</p><p>eBPF 提供了 <code>bpf_map_lookup_elem</code>, <code>bpf_map_update_elem</code>, <code>bpf_map_delete_elem</code> 等 helper functions 來對 map 資料做操作。lookup 的完整定義是 <code>void *bpf_map_lookup_elem (struct bpf_map *map, const void *key)</code>，透過 key 去尋找 map 裡面對應的 value，並返回其指標，由於返回的是指標，所以會指向 map 真實儲存的記憶體，可以直接對其值進行更新。</p><p>當然除了幾個基本的 helper function 外，不同的 map type 可能會支援更多的操作或功能，例如 bpf_skb_under_cgroup 是給 BPF_MAP_TYPE_CGROUP_ARRAY 專用的。</p><h3 class="relative group">原始碼解析<div id=%E5%8E%9F%E5%A7%8B%E7%A2%BC%E8%A7%A3%E6%9E%90 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8E%9F%E5%A7%8B%E7%A2%BC%E8%A7%A3%E6%9E%90 aria-label=定位點>#</a></span></h3><p>linux kernel 定義了 <a href=https://elixir.bootlin.com/linux/latest/source/include/linux/bpf.h#L64 target=_blank>struct bpf_map_ops</a>，來描述 map 可能會支援的所有功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>bpf_map_ops</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* funcs callable from userspace (via syscall) */</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>map_alloc_check</span><span class=p>)(</span><span class=k>union</span> <span class=n>bpf_attr</span> <span class=o>*</span><span class=n>attr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>map_alloc</span><span class=p>)(</span><span class=k>union</span> <span class=n>bpf_attr</span> <span class=o>*</span><span class=n>attr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>map_release</span><span class=p>)(</span><span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=n>map</span><span class=p>,</span> <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>map_file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>map_free</span><span class=p>)(</span><span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=n>map</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>map_get_next_key</span><span class=p>)(</span><span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=n>map</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>next_key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>map_release_uref</span><span class=p>)(</span><span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=n>map</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>map_lookup_elem_sys_only</span><span class=p>)(</span><span class=k>struct</span> <span class=n>bpf_map</span> <span class=o>*</span><span class=n>map</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>不同的 map 再根據需要去實作對應的操作，在 <a href=https://github.com/torvalds/linux/blob/master/include/linux/bpf_types.h target=_blank>include/linux/bpf_types.h</a> 定義。以 <code>BPF_MAP_TYPE_QUEUE</code> 這個 map type 來說對應到 queue_map_ops。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//kernel/bpf/queue_stack_maps.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=k>struct</span> <span class=n>bpf_map_ops</span> <span class=n>queue_map_ops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_meta_equal</span> <span class=o>=</span> <span class=n>bpf_map_meta_equal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_alloc_check</span> <span class=o>=</span> <span class=n>queue_stack_map_alloc_check</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_alloc</span> <span class=o>=</span> <span class=n>queue_stack_map_alloc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_free</span> <span class=o>=</span> <span class=n>queue_stack_map_free</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_lookup_elem</span> <span class=o>=</span> <span class=n>queue_stack_map_lookup_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_update_elem</span> <span class=o>=</span> <span class=n>queue_stack_map_update_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_delete_elem</span> <span class=o>=</span> <span class=n>queue_stack_map_delete_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_push_elem</span> <span class=o>=</span> <span class=n>queue_stack_map_push_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_pop_elem</span> <span class=o>=</span> <span class=n>queue_map_pop_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_peek_elem</span> <span class=o>=</span> <span class=n>queue_map_peek_elem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_get_next_key</span> <span class=o>=</span> <span class=n>queue_stack_map_get_next_key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_btf_name</span> <span class=o>=</span> <span class=s>&#34;bpf_queue_stack&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>map_btf_id</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>queue_map_btf_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>當呼叫 bpf_map_push_elem 時，就會呼叫 bpf_map_ops.map_push_elem 來調用 queue 的 queue_stack_map_push_elem 完成。</p><p>而具體每個 map 支援什麼 help function 可能就要參考 <a href=https://man7.org/linux/man-pages/man7/bpf-helpers.7.html target=_blank>helper function 文件描述</a></p><h3 class="relative group">使用範例<div id=%E4%BD%BF%E7%94%A8%E7%AF%84%E4%BE%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BD%BF%E7%94%A8%E7%AF%84%E4%BE%8B aria-label=定位點>#</a></span></h3><p>這邊我們一個特別的使用實例來看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>elem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>bpf_spin_lock</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>bpf_map_def</span> <span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;maps&#34;</span><span class=p>)</span> <span class=n>counter</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>BPF_MAP_TYPE_ARRAY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>key_size</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>value_size</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>elem</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>max_entries</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>首先我們定義了一個特別的 ARRAY map，它的 array size 只有 1，然後 value 是一個包含 u32 整數和一個 lock 的資料結構。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>SEC</span> <span class=p>(</span><span class=s>&#34;kprobe/sys_clone&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>hello_world</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>ctx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>u32</span> <span class=n>key</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>elem</span> <span class=o>*</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>val</span> <span class=o>=</span> <span class=nf>bpf_map_lookup_elem</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>counter</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>bpf_spin_lock</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>val</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>val</span><span class=o>-&gt;</span><span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>bpf_spin_unlock</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>val</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>bpf_trace_printk</span> <span class=p>(</span><span class=s>&#34;sys_clone count: % d&#34;</span><span class=p>,</span> <span class=n>val</span><span class=o>-&gt;</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>由於 key 我們固定是 0，透過 bpf_map_lookup_elem 我們永遠會取得同一筆資料，因此可以簡單看成我們把 <code>counter</code> 當作一個單一的容器來存放 cnt 變數，並使用 lock 避免 cnt 更新時的 race condition。</p><p>我們將這個程式附加到 kprobe/sys_clone，就可以用來統計 sys_clone 呼叫的次數。</p><p>和其他 eBPF 的操作一樣，我們透過 <code>bpf</code> 的 system call 去與 kernel 進行溝通。跟 helper fuction 類似，bpf systemcall 提供了 <code>BPF_MAP_LOOKUP_ELEM</code>, <code>BPF_MAP_UPDATE_ELEM</code>, <code>BPF_MAP_DELETE_ELEM</code> 等參數來提供搜尋、更新、刪除 map 數值的方法。另外為了減少 system call 的開銷，也提供 <code>BPF_MAP_LOOKUP_BATCH</code>, <code>BPF_MAP_LOOKUP_AND_DELETE_BATCH</code>, <code>BPF_MAP_UPDATE_BATCH</code>, <code>BPF_MAP_DELETE_BATCH</code> 等方法來在單次 system call 內完成多次 map 操作。</p><p>必要要注意的是 map 並不是 eBPF program 的附屬品，在 eBPF 虛擬機內，map 和 program 一樣是獨立的物件，每個 map 有自己的 refcnt 和生命週期，eBPF 程式的生命週期和 map 不一定是統一的。</p><h3 class="relative group">map 載入流程<div id=map-%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#map-%E8%BC%89%E5%85%A5%E6%B5%81%E7%A8%8B aria-label=定位點>#</a></span></h3><p>在透過函式庫將 eBPF 程式載入 kernel 時，先做的其實是建立 map，對每張 map 會呼叫 <code>bpf system call</code> 的 BPF_MAP_CREATE，並帶入 map type, key size, value size, max entries, flags 等資訊來建立 map，建立完成後會返回 map 對應的 fire descripter。</p><p>接著函數庫會修改編譯過的 ebpf bytecode 裡面參考到 map 變數的地方 (例如 lookup 等 helper function 的參數部分)，將原先流空的 map 地址修改成 map 對應的 file descripter。</p><p>接著一樣呼叫 <code>bpf</code> BPF_PROG_LOAD 來載入 eBPF bytecode，在載入過程中，verifier 會呼叫到 replace_map_fd_with_map_ptr 函數，將 bytecode 裡面 map 的 file descripter 在替換成 map 的實際地址。</p><h3 class="relative group">Map 持久化<div id=map-%E6%8C%81%E4%B9%85%E5%8C%96 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#map-%E6%8C%81%E4%B9%85%E5%8C%96 aria-label=定位點>#</a></span></h3><p>如前面所述，map 在 eBPF 虛擬機內和 prog 同等是獨立的存在，並且具有自己的 refcnt，因此和 prog 一樣，我們可以透過 <code>bpf</code> BPF_OBJ_PIN 將 map 釘到 BPFFS 的 <code>/sys/fs/bpf/</code> 路徑下，其他程式就一樣能透過 open file 的方式取得 map 的 file descripter，將 map 載入到其他的 eBPF 程式內，達成了多個 eBPF 程式 share 同一個 map 的效果。</p><h2 class="relative group">Tail call<div id=tail-call class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tail-call aria-label=定位點>#</a></span></h2><p>最後我們要來聊的是 tail call 的功能。</p><p>tail call 簡單來說就是在 eBPF 程式內執行另外一個 eBPF 程式，不過和一般的函數呼叫不一樣，eBPF 虛擬機在跳轉到另外一個 eBPF 程式後就不會再回到前一個程式了，所以他是一個單向的呼叫。</p><p>另外雖然他會直接複用前一個 eBPF 程式的 stack frame，但是被呼叫的 eBPF 程式不能夠存取前呼叫者的暫存器和 stack，只能透取得在呼叫 tail call 時，透過參數傳遞的 <code>ctx</code>。</p><p>使用 tail call 可以透過拆解簡化一個 eBPF 程式，打破單個 eBPF 程式只能有 512bytes 的 stack、1 million 個指令的限制。</p><p>一個使用範例是先使用一個 eBPF 程式作為 packet dispatcher，然後根據不同的 packet ether type 之類的欄位，將 packet 轉發給對應處理的 eBPF 程式。</p><p>另外一個就是將 eBPF 程式視為多個模組，透過 map 和 tail call 去動態的任意重整排序執行結構。</p><p>為了避免 eBPF 程式交替呼叫彼此導致卡死的狀況，kernel 定義了 <code>MAX_TAIL_CALL_CNT</code> 表示在單個 context 下最多可呼叫的 tail call 次數，目前是 32。如果 tail call 因為任何原因而執行失敗，則會繼續執行原本的 eBPF 程式。</p><h3 class="relative group">如何使用<div id=%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8 aria-label=定位點>#</a></span></h3><p>tail call 的 helper function 定義如下 <code>long bpf_tail_call (void *ctx, struct bpf_map *prog_array_map, u32 index)</code>。在使用的時候我們要一個 <code>BPF_MAP_TYPE_PROG_ARRAY</code> type 的 map，用來保存一個 eBPF program file descriptor 的陣列。在呼叫 tail call 的時候傳遞進去執行。</p><h2 class="relative group">參考資料<div id=%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99 aria-label=定位點>#</a></span></h2><ul><li><a href=https://blogs.oracle.com/linux/post/bpf-a-tour-of-program-types target=_blank>BPF: A Tour of Program Types</a></li><li><a href=https://arthurchiao.art/blog/bpf-advanced-notes-1-zh/ target=_blank>BPF 程序（BPF Prog）类型详解</a></li><li><a href=https://facebookmicrosites.github.io/bpf/blog/2018/08/31/object-lifetime.html target=_blank>Lifetime of BPF objects</a></li><li><a href=https://stackoverflow.com/questions/68278120/ebpf-difference-between-loading-attaching-and-linking target=_blank>difference between loading, attaching, and linking?</a></li><li><a href=https://vvl.me/2021/02/eBPF-3-eBPF-map/ target=_blank>eBPF map</a></li><li><a href=https://arthurchiao.art/blog/bpf-advanced-notes-3-zh/ target=_blank>BPF Map 内核实现</a></li><li><a href=https://www.ebpf.top/post/bpf_ring_buffer/ target=_blank>BPF 环形缓冲区</a></li><li><a href=https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/108612744 target=_blank>BPF 技术介绍及学习分享</a></li><li><a href=https://www.ebpf.top/post/map_internal/ target=_blank>揭秘 BPF map 前生今世</a></li><li><a href=https://davidlovezoe.club/wordpress/archives/1044 target=_blank>BPF 数据传递的桥梁 ——BPF MAP（一）</a></li><li><a href=https://man7.org/linux/man-pages/man7/bpf-helpers.7.html target=_blank>bpf-helpers man page</a></li><li><a href=https://lwn.net/Articles/645169/ target=_blank>introduce bpf_tail_call () helper</a></li><li><a href=https://www.readfog.com/a/1663618518017478656 target=_blank>從 BPF to BPF Calls 到 Tail Calls</a></li></ul></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;title=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title="分享到 LinkedIn" aria-label="分享到 LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;text=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title="推到 Twitter" aria-label="推到 Twitter"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5+https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/" title aria-label><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5%20https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;resubmit=true&amp;title=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title="發送到 Reddit" aria-label="發送到 Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;description=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title="釘到 Pinterest" aria-label="釘到 Pinterest"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;quote=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title="分享到 Facebook" aria-label="分享到 Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;subject=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title=以電子郵件發送 aria-label=以電子郵件發送><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;resubmit=true&amp;title=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://blog.louisif.me/posts/learn-ebpf-serial-2-basic-concept/&amp;resubmit=true&amp;title=%e5%ad%b8%e7%bf%92%20eBPF%20%e7%b3%bb%e5%88%97%202%20-%20%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" title aria-label><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></section></div><script>var oid="views_posts/learn-ebpf-serial-2-basic-concept.md",oid_likes="likes_posts/learn-ebpf-serial-2-basic-concept.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/learn-ebpf-serial-3-introduction-to-bcc/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">學習 eBPF 系列 3 - BCC 介紹</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2022-10-31T00:00:00+00:00>October 31 2022</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/learn-ebpf-serial-1-abstract-and-background/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">學習 eBPF 系列 1 - 摘要與簡介</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2022-10-31T00:00:00+00:00>October 31 2022</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=捲動到頁頂 title=捲動到頁頂>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/categories/ title>分類</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title>標籤</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=https://github.com/gamerslouis/gamerslouis.github.io title><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span>GitHub</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">Copyright © 2022-2025 Louis Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">以 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> 製作</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://blog.louisif.me/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜尋 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="關閉 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>