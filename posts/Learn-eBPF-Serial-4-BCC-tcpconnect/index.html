<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>學習 eBPF 系列 4 - BCC tcpconnect | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF實例tcpconnect以及kprobe">
    <meta name="og:title" content="學習 eBPF 系列 4 - BCC tcpconnect">
    <meta name="og:description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF實例tcpconnect以及kprobe">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9566bf8.css" as="style"><link rel="preload" href="/assets/js/app.fd10c8b2.js" as="script"><link rel="preload" href="/assets/js/2.abd11f75.js" as="script"><link rel="preload" href="/assets/js/15.bcf04feb.js" as="script"><link rel="prefetch" href="/assets/js/10.a4a57a95.js"><link rel="prefetch" href="/assets/js/11.07008736.js"><link rel="prefetch" href="/assets/js/12.58f7cde8.js"><link rel="prefetch" href="/assets/js/13.167587bb.js"><link rel="prefetch" href="/assets/js/14.ba4cf81d.js"><link rel="prefetch" href="/assets/js/16.76c0ba1e.js"><link rel="prefetch" href="/assets/js/17.f762e910.js"><link rel="prefetch" href="/assets/js/18.8956c649.js"><link rel="prefetch" href="/assets/js/19.96ee1a4f.js"><link rel="prefetch" href="/assets/js/20.4f3578d8.js"><link rel="prefetch" href="/assets/js/21.d5b1dc5d.js"><link rel="prefetch" href="/assets/js/22.e083d81d.js"><link rel="prefetch" href="/assets/js/23.053a181b.js"><link rel="prefetch" href="/assets/js/24.f17b354d.js"><link rel="prefetch" href="/assets/js/25.f313e86f.js"><link rel="prefetch" href="/assets/js/26.8e32042c.js"><link rel="prefetch" href="/assets/js/27.374e1436.js"><link rel="prefetch" href="/assets/js/28.0bac4585.js"><link rel="prefetch" href="/assets/js/29.3c2e46f7.js"><link rel="prefetch" href="/assets/js/3.1dd456ea.js"><link rel="prefetch" href="/assets/js/30.901456ee.js"><link rel="prefetch" href="/assets/js/4.5ca1880f.js"><link rel="prefetch" href="/assets/js/5.d77edfd3.js"><link rel="prefetch" href="/assets/js/6.f0fdf8b0.js"><link rel="prefetch" href="/assets/js/7.a519000e.js"><link rel="prefetch" href="/assets/js/8.fb002ea2.js"><link rel="prefetch" href="/assets/js/9.e1595287.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9566bf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>學習 eBPF 系列 4 - BCC tcpconnect</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Learn-eBPF-Serial-4-BCC-tcpconnect/#tcpconnect-介紹" class="sidebar-link">tcpconnect 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-4-BCC-tcpconnect/#tcpconnect-實作" class="sidebar-link">tcpconnect 實作</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-2df51549><div class="articleInfo" data-v-2df51549><!----> <div class="info" data-v-2df51549><div title="作者" class="author iconfont icon-touxiang" data-v-2df51549><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-2df51549>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-2df51549><a href="javascript:;" data-v-2df51549>2022-10-31</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-2df51549><a href="/categories/?category=%E5%AD%B8%E7%BF%92%20eBPF%20%E7%B3%BB%E5%88%97" data-v-2df51549>學習 eBPF 系列 </a><a href="/categories/?category=2022%20iThome%E9%90%B5%E4%BA%BA%E8%B3%BD" data-v-2df51549>2022 iThome鐵人賽 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">學習 eBPF 系列 4 - BCC tcpconnect<!----></h1>  <div class="theme-vdoing-content content__default"><p>我們要來看 BCC 的   <code>tools/tcpconnect.py</code>   這支程式。原始碼在  <a href="https://github.com/iovisor/bcc/blob/master/tools/tcpconnect.py" target="_blank" rel="noopener noreferrer">這邊<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="tcpconnect-介紹"><a href="#tcpconnect-介紹" class="header-anchor">#</a> tcpconnect 介紹</h2> <p>這隻程式會追蹤紀錄 kernel 發起的 TCP 連線，可以看到發起連線的 pid, 指令名稱，ip version, IP 地址和目標 port 等資訊。</p> <p>執行結果如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python3 tools/tcpconnect
Tracing connect <span class="token punctuation">..</span>. Hit Ctrl-C to end
PID     COMM         IP SADDR            DADDR            DPORT
<span class="token number">2553</span>    <span class="token function">ssh</span>          <span class="token number">4</span>  <span class="token number">10.0</span>.2.15        <span class="token number">10.0</span>.2.1         <span class="token number">22</span>
<span class="token number">2555</span>    <span class="token function">wget</span>         <span class="token number">4</span>  <span class="token number">10.0</span>.2.15        <span class="token number">172.217</span>.160.100  <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="tcpconnect-實作"><a href="#tcpconnect-實作" class="header-anchor">#</a> tcpconnect 實作</h2> <p>首先透過   <code>argparse</code>   定義了指令的參數輸入，主要是提供 filter 的選項，讓使用者可以透過 pid, uid, namespace 等參數去 filter 連線紀錄。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser <span class="token punctuation">(</span>
    description<span class="token operator">=</span><span class="token string">&quot;Trace TCP connects&quot;</span><span class="token punctuation">,</span>
    formatter_class<span class="token operator">=</span>argparse<span class="token punctuation">.</span>RawDescriptionHelpFormatter<span class="token punctuation">,</span>
    epilog<span class="token operator">=</span>examples<span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument <span class="token punctuation">(</span><span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--pid&quot;</span><span class="token punctuation">,</span>
    <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;trace this PID only&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接著就來到主要的 eBPF 程式碼的定義</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>bpf_text <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>&quot;
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;uapi/linux/ptrace.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;net/sock.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bcc/proto.h&gt;</span></span>

<span class="token function">BPF_HASH</span> <span class="token punctuation">(</span>currsock<span class="token punctuation">,</span> u32<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>首先可以看到   <code>BPF_HASH</code> ，這是 BCC 提供的一個巨集，用來定一個 hash type 的 map，對於不同 map type BCC 都定義了對應的巨集來建立 map。具體列表可以參考  <a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#maps" target="_blank" rel="noopener noreferrer">這邊<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。第一個參數是 map 的名稱，這邊叫做 currsock，同時這個變數也用於後續程式碼中對 map 的參考和 API 呼叫，例如   <code>currsock.lookup (&amp;tid);</code>   就是對 currsock 這個 map 進行 lookup 操作。接著兩個欄位分別對應 key 和 value 的 type，key 是一個 32 位元整數，value 則對應到 sock struct 指標。sock 結構在  <a href="https://elixir.bootlin.com/linux/latest/source/include/net/sock.h#L352" target="_blank" rel="noopener noreferrer">net/sock.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  內定義，是 linux kernel 用來維護 socket 的資料結構。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ipv4_data_t</span> <span class="token punctuation">{</span>
    u64 ts_us<span class="token punctuation">;</span>
    u32 pid<span class="token punctuation">;</span>
    u32 uid<span class="token punctuation">;</span>
    u32 saddr<span class="token punctuation">;</span>
    u32 daddr<span class="token punctuation">;</span>
    u64 ip<span class="token punctuation">;</span>
    u16 lport<span class="token punctuation">;</span>
    u16 dport<span class="token punctuation">;</span>
    <span class="token keyword">char</span> task <span class="token punctuation">[</span>TASK_COMM_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_PERF_OUTPUT</span> <span class="token punctuation">(</span>ipv4_events<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ipv6_data_t</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>接著分別針對 ipv4 和 ipv6 定義了一個 data_t 的資料結構，用於 bpf 和 userspace client 之間傳輸 tcp connect 的資訊用。</p> <p>這邊可以看到另外一個特別的巨集   <code>BPF_PERF_OUTPUT</code> 。這邊用到了 eBPF 提供的 perf event 機制，定義了一個 per-CPU 的 event ring buffer，並提供了對應的 bpf_perf_event_output helper function 來把資料推進 ring buffer 給 userspace 存取。在 bcc 這邊則使用   <code>ipv4_events.perf_submit (ctx, &amp;data, sizeof (data));</code>   的 API 來傳輸資料。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//separate flow keys per address family</span>
<span class="token keyword">struct</span> <span class="token class-name">ipv4_flow_key_t</span> <span class="token punctuation">{</span>
    u32 saddr<span class="token punctuation">;</span>
    u32 daddr<span class="token punctuation">;</span>
    u16 dport<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_HASH</span> <span class="token punctuation">(</span>ipv4_count<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ipv4_flow_key_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接著又是一個 HASH map，tcpdconnect 提供一個功能選項是統計各種 connection 的次數，所以這邊定義了一個 ipv4_flow_key_t 當作 key 來作為統計依據， <code>BPF_HASH</code>   在預設情況下 value 的 type 是   <code>u64</code> ，一個 64 位元無號整數，因此可以直接拿來統計。</p> <p>接著就來到了 bpf 函數主體，這個函數會被 attach 到 tcp_v4_connect 和 tcp_v6_connect 的 kprobe 上，當呼叫 tcp_v4_connect 和 tcp_v6_connect 時被觸發。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">trace_connect_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">container_should_be_filtered</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    u64 pid_tgid <span class="token operator">=</span> <span class="token function">bpf_get_current_pid_tgid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32 pid <span class="token operator">=</span> pid_tgid <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">;</span>
    u32 tid <span class="token operator">=</span> pid_tgid<span class="token punctuation">;</span>
    FILTER_PID
    u32 uid <span class="token operator">=</span> <span class="token function">bpf_get_current_uid_gid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FILTER_UID
    <span class="token comment">//stash the sock ptr for lookup on return</span>
    currsock<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>首先它接收的參數是 pt_regs 結構和 tcp_v4_connect 的參數，pt_regs 包含了 CPU 佔存器的數值資訊，作為 eBPF 的上下文。後面 tcp_v4_connect 的第一個參數 sock 結構對應到當次連線的 socket 資訊，由於後面幾個參數不會使用到所以可以省略掉。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./tcpconnect <span class="token parameter variable">--cgroupmap</span> mappath  <span class="token comment"># only trace cgroups in this BPF map</span>
./tcpconnect <span class="token parameter variable">--mntnsmap</span> mappath   <span class="token comment"># only trace mount namespaces in the map</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>首先呼叫的是   <code>container_should_be_filtered</code> 。在 argparser 中定義了兩個參數 cgroupmap 和 mntnsmap 用來針對特定的 cgroups 或 mount namespace。 <code>container_should_be_filtered</code>   則會負責這兩項的檢查。</p> <p>一開始看可能會發現在 eBPF 程式裡面找不到這個函數定的定義，由於這兩個 filter 非常常用因此 bcc 定義了   <code>bcc.containers.filter_by_containers</code> <a href="https://github.com/iovisor/bcc/blob/master/src/python/bcc/containers.py" target="_blank" rel="noopener noreferrer"> 函數<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在 python 程式碼裡面會看到， <code>bpf_text = filter_by_containers (args) + bpf_text</code> 。以 cgroup 來說，如果使用者有提供   <code>cgroupmap</code>   這個參數， <code>filter_by_containers</code>   會在 mappath 透過   <code>BPF_TABLE_PINNED</code>   在 BPFFS 建立一個 hash type 的 map，根據這個 map 的 key 來 filter cgroup id，透過   <code>bpf_get_current_cgroup_id ()</code>   取得當前上下文的 cgroup_id 並只保留有在 map 內的上下文。</p> <p>接著   <code>FILTER_PID</code>   和   <code>FILTER_UID</code>   分別是針對 pid 和 uid 去 filter，在後面的 python 程式碼中會根據是否有啟用這個選項來把字串替代成對應的程式碼或空字串</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">if</span> args<span class="token punctuation">.</span>pid<span class="token punctuation">:</span>
    bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">'FILTER_PID'</span><span class="token punctuation">,</span>
        <span class="token string">'if (pid != % s) { return 0; }'</span> <span class="token operator">%</span> args<span class="token punctuation">.</span>pid<span class="token punctuation">)</span>
bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">'FILTER_PID'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果一切都滿足，就會使用 tid 當 key，將 sock 結構更新到   <code>currsock</code>  map 當中。</p> <p>後半部分的 eBPG 程式碼定義了   <code>trace_connect_return</code> ，這個函數會被 attach 到 tcp_v4_connect 和 tcp_v6_connect 的 kretprobe 上。kprobe 是在函數被呼叫時被觸發，kretprobe 則是在函數回傳時被觸發，因此可以取得函數的回傳值和執行結果。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">trace_connect_v4_return</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">trace_connect_return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>真正的進入點分成 ip v4 和 v6 的版本來傳入 ipver 變數。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">trace_connect_return</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">short</span> ipver<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">PT_REGS_RC</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u64 pid_tgid <span class="token operator">=</span> <span class="token function">bpf_get_current_pid_tgid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32 pid <span class="token operator">=</span> pid_tgid <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">;</span>
    u32 tid <span class="token operator">=</span> pid_tgid<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span><span class="token operator">*</span>skpp<span class="token punctuation">;</span>
    skpp <span class="token operator">=</span> currsock<span class="token punctuation">.</span><span class="token function">lookup</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skpp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//missed entry</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//failed to send SYNC packet, may not have populated</span>
        <span class="token comment">//socket __sk_common.{skc_rcv_saddr, ...}</span>
        currsock<span class="token punctuation">.</span><span class="token function">delete</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//pull in details</span>
    <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>skp <span class="token operator">=</span> <span class="token operator">*</span>skpp<span class="token punctuation">;</span>
    u16 lport <span class="token operator">=</span> skp<span class="token operator">-&gt;</span>__sk_common<span class="token punctuation">.</span>skc_num<span class="token punctuation">;</span>
    u16 dport <span class="token operator">=</span> skp<span class="token operator">-&gt;</span>__sk_common<span class="token punctuation">.</span>skc_dport<span class="token punctuation">;</span>
    FILTER_PORT
    FILTER_FAMILY
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ipver <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IPV4_CODE
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token comment">/* 6 */</span> <span class="token punctuation">{</span>
        IPV6_CODE
    <span class="token punctuation">}</span>
    currsock<span class="token punctuation">.</span><span class="token function">delete</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>透過   <code>PT_REGS_RC</code>   可以取得函數的回傳值，根據函數的定義，如果執行成功應該要回傳 0 所以如果   <code>ret</code>   不為零，表示執行錯誤，直接忽略。透過   <code>currsock.lookup</code>   我們可以取回對應 tid 的 sock 指標，然後取得 dst port 和 src port (lport)，由於這時候 tcp_connect 已經執行完成，所以 src port 已經被 kernel 分配。</p> <blockquote><p>這邊可以看到 eBPF 程式設計上比較複雜的地方，sock 結構體要在 kprobe 取得，但是我們又需要 kretprobe 後的一些資訊，因此整個架構要被拆成兩個部分，然後透過 map 來進行傳輸。</p></blockquote> <p>接著   <code>FILTER_PORT</code>   和   <code>FILTER_FAMILY</code>   一樣會被替換，然後根據 dst port 和 family 來 filter。</p> <p>由於 tcpconnect 有紀錄和統計連線次數兩種模式，因此最後一段的 code 一樣先被標記成   <code>IPV4_CODE</code> 。然後根據模式的不同來取代成不同的 code。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">if</span> args<span class="token punctuation">.</span>count<span class="token punctuation">:</span>
    bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">&quot;IPV4_CODE&quot;</span><span class="token punctuation">,</span> struct_init <span class="token punctuation">[</span><span class="token string">'ipv4'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">&quot;IPV6_CODE&quot;</span><span class="token punctuation">,</span> struct_init <span class="token punctuation">[</span><span class="token string">'ipv6'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">&quot;IPV4_CODE&quot;</span><span class="token punctuation">,</span> struct_init <span class="token punctuation">[</span><span class="token string">'ipv4'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bpf_text <span class="token operator">=</span> bpf_text<span class="token punctuation">.</span>replace <span class="token punctuation">(</span><span class="token string">&quot;IPV6_CODE&quot;</span><span class="token punctuation">,</span> struct_init <span class="token punctuation">[</span><span class="token string">'ipv6'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'trace'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我們這邊就只看 ipv4 trace 的版本。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ipv4_data_t</span> data4 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> pid<span class="token punctuation">,</span> <span class="token punctuation">.</span>ip <span class="token operator">=</span> ipver<span class="token punctuation">}</span><span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token function">bpf_get_current_uid_gid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>ts_us <span class="token operator">=</span> <span class="token function">bpf_ktime_get_ns</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>saddr <span class="token operator">=</span> skp<span class="token operator">-&gt;</span>__sk_common<span class="token punctuation">.</span>skc_rcv_saddr<span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>daddr <span class="token operator">=</span> skp<span class="token operator">-&gt;</span>__sk_common<span class="token punctuation">.</span>skc_daddr<span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>lport <span class="token operator">=</span> lport<span class="token punctuation">;</span>
data4<span class="token punctuation">.</span>dport <span class="token operator">=</span> <span class="token function">ntohs</span> <span class="token punctuation">(</span>dport<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bpf_get_current_comm</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>data4<span class="token punctuation">.</span>task<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data4<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ipv4_events<span class="token punctuation">.</span><span class="token function">perf_submit</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data4<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>這邊其實就是去填充 ipv4_data_t 結構、透過 bpf_get_current_comm 取得當前程式的名稱，最後透過前面透過 BPP_PERF_OUT 定義的 ipv4_events，呼叫   <code>perf_submit (ctx, &amp;data4, sizeof (data4))</code>   將資料送到 user space。</p> <p>到這邊就完成了整個的 eBPF 程式碼   <code>bpf_text</code>   的定義，後面就會先經過前面講的，將 IPV4_CODE 等字段，根據 tcpconnect 的參數進行取代。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>b <span class="token operator">=</span> BPF <span class="token punctuation">(</span>text<span class="token operator">=</span>bpf_text<span class="token punctuation">)</span>
b<span class="token punctuation">.</span>attach_kprobe <span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">&quot;tcp_v4_connect&quot;</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">&quot;trace_connect_entry&quot;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>attach_kprobe <span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">&quot;tcp_v6_connect&quot;</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">&quot;trace_connect_entry&quot;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>attach_kretprobe <span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">&quot;tcp_v4_connect&quot;</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">&quot;trace_connect_v4_return&quot;</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>attach_kretprobe <span class="token punctuation">(</span>event<span class="token operator">=</span><span class="token string">&quot;tcp_v6_connect&quot;</span><span class="token punctuation">,</span> fn_name<span class="token operator">=</span><span class="token string">&quot;trace_connect_v6_return&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接著透過 BCC 的 library 完成 eBPF 程式碼的編譯、載入和 attach。</p> <p>最後是輸出的部分，前面會先輸出一些下列的欄位資訊，但是由於這不是很重要所以就省略掉。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Tracing connect ... Hit Ctrl-C to end
PID     COMM         IP SADDR            DADDR            DPORT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>b <span class="token operator">=</span> BPF <span class="token punctuation">(</span>text<span class="token operator">=</span>bpf_text<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># read events</span>
b <span class="token punctuation">[</span><span class="token string">&quot;ipv4_events&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open_perf_buffer <span class="token punctuation">(</span>print_ipv4_event<span class="token punctuation">)</span>
b <span class="token punctuation">[</span><span class="token string">&quot;ipv6_events&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>open_perf_buffer <span class="token punctuation">(</span>print_ipv6_event<span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		b<span class="token punctuation">.</span>perf_buffer_poll <span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
		exit <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>完成載入後，我們可以拿到一個對應的 BPF 物件，透過 b [MAP_NAME]，我們可以調用 map 對應的   <code>open_perf_buffer</code> API，透過   <code>open_perf_buffer</code> ，我們可以定義一個 callback function 當有資料從 kernel 透過 perf_submit 被傳輸的時候被呼叫來處理 eBPF 程式送過來的資料。</p> <p>最後會呼叫   <code>b.perf_buffer_poll</code>   來持續檢查 perf map 是不是有新的 perf event，以及呼叫對應的 callback function。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">print_ipv4_event</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    event <span class="token operator">=</span> b <span class="token punctuation">[</span><span class="token string">&quot;ipv4_events&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>event <span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">global</span> start_ts
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>timestamp<span class="token punctuation">:</span>
        <span class="token keyword">if</span> start_ts <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            start_ts <span class="token operator">=</span> event<span class="token punctuation">.</span>ts_us
        printb <span class="token punctuation">(</span><span class="token string">b&quot;%-9.3f&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>ts_us<span class="token punctuation">)</span> <span class="token operator">-</span> start_ts<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nl<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>print_uid<span class="token punctuation">:</span>
        printb <span class="token punctuation">(</span><span class="token string">b&quot;%-6d&quot;</span> <span class="token operator">%</span> event<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> nl<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    dest_ip <span class="token operator">=</span> inet_ntop <span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> pack <span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>daddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>lport<span class="token punctuation">:</span>
        printb <span class="token punctuation">(</span><span class="token string">b&quot;%-7d %-12.12s %-2d %-16s %-6d %-16s %-6d % s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>
            event<span class="token punctuation">.</span>task<span class="token punctuation">,</span> event<span class="token punctuation">.</span>ip<span class="token punctuation">,</span>
            inet_ntop <span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> pack <span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>lport<span class="token punctuation">,</span>
            dest_ip<span class="token punctuation">,</span> event<span class="token punctuation">.</span>dport<span class="token punctuation">,</span> print_dns <span class="token punctuation">(</span>dest_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        printb <span class="token punctuation">(</span><span class="token string">b&quot;%-7d %-12.12s %-2d %-16s %-16s %-6d % s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>
            event<span class="token punctuation">.</span>task<span class="token punctuation">,</span> event<span class="token punctuation">.</span>ip<span class="token punctuation">,</span>
            inet_ntop <span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> pack <span class="token punctuation">(</span><span class="token string">&quot;I&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dest_ip<span class="token punctuation">,</span> event<span class="token punctuation">.</span>dport<span class="token punctuation">,</span> print_dns <span class="token punctuation">(</span>dest_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> x
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>透過   <code>b [&quot;ipv4_events&quot;].event</code>   可以直接將 data 數據轉換成 BPF 程式內定義的資料結構，方便存取。取得的資料再經過一些清洗和轉譯就能夠直接輸出了。</p> <p>雖然我們跳過了 count 功能還有一個紀錄 dst ip 的 DNS 查詢，但到此我們大致上看完了整個 tcpconnect 的主要的實作內容。</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=eBPF" title="標簽">#eBPF</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/29</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.fd10c8b2.js" defer></script><script src="/assets/js/2.abd11f75.js" defer></script><script src="/assets/js/15.bcf04feb.js" defer></script>
  </body>
</html>
