<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>學習 eBPF 系列 9 - eBPF helper functions | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="2022 iThome鐵人賽 學習eBPF系列 列舉eBPF helper function及其用途">
    <meta name="og:title" content="學習 eBPF 系列 9 - eBPF helper functions">
    <meta name="og:description" content="2022 iThome鐵人賽 學習eBPF系列 列舉eBPF helper function及其用途">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9566bf8.css" as="style"><link rel="preload" href="/assets/js/app.fd10c8b2.js" as="script"><link rel="preload" href="/assets/js/2.abd11f75.js" as="script"><link rel="preload" href="/assets/js/20.4f3578d8.js" as="script"><link rel="prefetch" href="/assets/js/10.a4a57a95.js"><link rel="prefetch" href="/assets/js/11.07008736.js"><link rel="prefetch" href="/assets/js/12.58f7cde8.js"><link rel="prefetch" href="/assets/js/13.167587bb.js"><link rel="prefetch" href="/assets/js/14.ba4cf81d.js"><link rel="prefetch" href="/assets/js/15.bcf04feb.js"><link rel="prefetch" href="/assets/js/16.76c0ba1e.js"><link rel="prefetch" href="/assets/js/17.f762e910.js"><link rel="prefetch" href="/assets/js/18.8956c649.js"><link rel="prefetch" href="/assets/js/19.96ee1a4f.js"><link rel="prefetch" href="/assets/js/21.d5b1dc5d.js"><link rel="prefetch" href="/assets/js/22.e083d81d.js"><link rel="prefetch" href="/assets/js/23.053a181b.js"><link rel="prefetch" href="/assets/js/24.f17b354d.js"><link rel="prefetch" href="/assets/js/25.f313e86f.js"><link rel="prefetch" href="/assets/js/26.8e32042c.js"><link rel="prefetch" href="/assets/js/27.374e1436.js"><link rel="prefetch" href="/assets/js/28.0bac4585.js"><link rel="prefetch" href="/assets/js/29.3c2e46f7.js"><link rel="prefetch" href="/assets/js/3.1dd456ea.js"><link rel="prefetch" href="/assets/js/30.901456ee.js"><link rel="prefetch" href="/assets/js/4.5ca1880f.js"><link rel="prefetch" href="/assets/js/5.d77edfd3.js"><link rel="prefetch" href="/assets/js/6.f0fdf8b0.js"><link rel="prefetch" href="/assets/js/7.a519000e.js"><link rel="prefetch" href="/assets/js/8.fb002ea2.js"><link rel="prefetch" href="/assets/js/9.e1595287.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9566bf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>學習 eBPF 系列 9 - eBPF helper functions</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#ebpf-map-操作類" class="sidebar-link">eBPF map 操作類</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#通用函數" class="sidebar-link">通用函數</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#tracing-相關-kprobe-tracepoint-perf-event" class="sidebar-link">Tracing 相關 (kprobe, tracepoint, perf event)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#cgroup-相關" class="sidebar-link">Cgroup 相關</a></li></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#其他類別" class="sidebar-link">其他類別</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#xdp-相關" class="sidebar-link">XDP 相關</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#lwt-相關" class="sidebar-link">LWT 相關</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-9-eBPF-helper-functions/#socket-socket-buffer-相關" class="sidebar-link">socket, socket buffer 相關</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-2df51549><div class="articleInfo" data-v-2df51549><!----> <div class="info" data-v-2df51549><div title="作者" class="author iconfont icon-touxiang" data-v-2df51549><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-2df51549>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-2df51549><a href="javascript:;" data-v-2df51549>2022-10-31</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-2df51549><a href="/categories/?category=%E5%AD%B8%E7%BF%92%20eBPF%20%E7%B3%BB%E5%88%97" data-v-2df51549>學習 eBPF 系列 </a><a href="/categories/?category=2022%20iThome%E9%90%B5%E4%BA%BA%E8%B3%BD" data-v-2df51549>2022 iThome鐵人賽 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">學習 eBPF 系列 9 - eBPF helper functions<!----></h1>  <div class="theme-vdoing-content content__default"><p>本篇是本系列文章的最後一篇，在 eBPF 程式裡面要與 kernel 交互很重要的是 helper function，因此在最後的兩天時間，我們要把所有的 helper function 速覽過一遍。這邊介紹以 bpf-helper 的  <a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">man 文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  的內容為主，部分的 helper function 可能因為文件更新而有遺漏。</p> <p>接下來的介紹會稍微對 helper function 做一定程度的分類，但是具體不同的 eBPF program type 支援那些 helper function 可能還是要根據  <a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md" target="_blank" rel="noopener noreferrer">bcc 文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、每個 helper function 對應的 commit 資訊等查詢。</p> <h2 id="ebpf-map-操作類"><a href="#ebpf-map-操作類" class="header-anchor">#</a> eBPF map 操作類</h2> <ul><li>array, map 類型 map 的操作函數，對應到查詢、插入或更新、刪除 map 內的元素。其中 update 可以透過 flag ( <code>BPF_NOEXIST</code> ,  <code>BPF_EXIST</code> ,  <code>BPF_ANY</code> ) 決定 key 是不是不能先存在或一定要存在於 map 內。
<ul><li>bpf_map_lookup_elem</li> <li>bpf_map_update_elem</li> <li>bpf_map_delete_elem</li></ul></li> <li>用於 stack, queue 類型 map 的操作函數。
<ul><li>bpf_map_peek_elem</li> <li>bpf_map_pop_elem</li> <li>bpf_map_push_elem</li></ul></li> <li>用於 ringbuff 的操作函數 (改進原本 perf event map 的問題)
<ul><li>bpf_ringbuf_output</li> <li>bpf_ringbuf_reserve</li> <li>bpf_ringbuf_submit</li> <li>bpf_ringbuf_discard</li> <li>bpf_ringbuf_query</li></ul></li></ul> <h2 id="通用函數"><a href="#通用函數" class="header-anchor">#</a> 通用函數</h2> <ul><li>生成隨機數
<ul><li>get_prandom_u32</li></ul></li> <li><code>atol</code> ,  <code>atoul</code> <ul><li>bpf_strtol</li> <li>bpf_strtoul</li></ul></li> <li>取得當前執行 eBPF 程式的 (SMP) processor ID。由於 eBPF 是 no preemption 的所以在整個執行過程中 processor id 不會變。
<ul><li>bpf_get_smp_processor_id</li></ul></li> <li>取得當前 NUMA (Non-uniform memory access) 的 node id。受於匯流排限制，CPU 核心可以比較快存取同節點上的 memory，透過 node id 區分。通常是當 attach 的 socket 有啟用   <code>SO_ATTACH_REUSEPORT_EBPF</code>   選項時會用到。
<ul><li>bpf_get_numa_node_id</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_PROG_ARRAY</code>  map 去執行 tail call。
<ul><li>bpf_tail_call</li></ul></li> <li>取得開機到當下經過的時間，單位是 ns，差別在於後者會多包含 suspend (暫停) 的時間
<ul><li>bpf_ktime_get_ns</li> <li>bpf_ktime_get_boot_ns</li></ul></li> <li>取得 jiffies64
<ul><li>bpf_jiffies64</li></ul></li> <li>將字串訊息發送到 /sys/kernel/debug/tracing/trace ，主要用於開發除錯
<ul><li>bpf_trace_printk</li></ul></li> <li>寫入 seq_file
<ul><li>bpf_seq_write</li> <li>bpf_seq_printf</li></ul></li> <li>搭配   <code>struct bpf_spin_lock</code>   提供一個給   <code>BPF_MAP_TYPE_HASH</code>   和   <code>BPF_MAP_TYPE_ARRAY</code>  (目前只支援這兩著) 裡面 value 使用的 lock，由於一個 map 裡面只能有一個 spin_lock，所以通常是使用把之前提過，整個 map 固定只有一個元素，把整個 map 當作一個 global variable 的用法
<ul><li>bpf_spin_lock</li> <li>bpf_spin_unlock</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code>   使用，傳輸資料到 user space
<ul><li>bpf_perf_event_output</li></ul></li></ul> <h2 id="tracing-相關-kprobe-tracepoint-perf-event"><a href="#tracing-相關-kprobe-tracepoint-perf-event" class="header-anchor">#</a> Tracing 相關 (kprobe, tracepoint, perf event)</h2> <ul><li>取得當前的 tgid, uid, gid, command name, task structure
<ul><li>bpf_get_current_pid_tgid</li> <li>bpf_get_current_uid_gid</li> <li>bpf_get_current_comm</li> <li>bpf_get_current_task</li></ul></li> <li>發 signal 到當前 (process, thread)
<ul><li>bpf_send_signal</li> <li>bpf_send_signal_thread</li></ul></li> <li>用於讀取記憶體資料、字串及寫入記憶體。帶 user 的版本用於 user space memory，其餘用於 kernel space memory。
<ul><li>bpf_probe_read (通常使用後倆著)</li> <li>bpf_probe_read_user</li> <li>bpf_probe_read_kernel</li> <li>bpf_probe_read_str (通常使用後倆著)</li> <li>bpf_probe_read_user_str</li> <li>bpf_probe_read_kernel_str</li> <li>bpf_probe_write_user</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_STACK_TRACE</code>   使用，取得一個 stack address hash 過的 stack id
<ul><li>bpf_get_stackid</li></ul></li> <li>取得 userspace 或 kernel space 的 stack 資料
<ul><li>bpf_get_stack</li> <li>bpf_get_task_stack</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code>   取得 perf-event counter 的讀數
<ul><li>bpf_perf_event_read</li> <li>bpf_perf_event_read_value (建議使用)</li></ul></li> <li>用於   <code>BPF_PROG_TYPE_PERF_EVENT</code>   取得 struct perf_branch_entry
<ul><li>bpf_read_branch_records</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_CGROUP_ARRAY</code>   使用，檢查是否在某個 cgroup v2 節點內
<ul><li>bpf_current_task_under_cgroup</li></ul></li> <li>查看當前上下文的 cgroup 節點的祖先節點 id
<ul><li>bpf_get_current_ancestor_cgroup_id</li></ul></li> <li>取得當前上下文對應的 cgroup id
<ul><li>bpf_get_current_cgroup_id</li></ul></li> <li>用於 kprobe，修改函數回傳值
<ul><li>bpf_override_return</li></ul></li></ul> <h3 id="cgroup-相關"><a href="#cgroup-相關" class="header-anchor">#</a> Cgroup 相關</h3> <ul><li>取得一個當前 network namespace 對應的 cookie (identifer)
<ul><li>bpf_get_netns_cookie</li></ul></li> <li>取得 local storage 的指標 (cgroup 相關可使用的一個儲存區)
<ul><li>bpf_get_local_storage</li></ul></li> <li>用於   <code>BPF_PROG_TYPE_CGROUP_SYSCTL</code> <ul><li>取得、更新 sysctl 資訊
<ul><li>bpf_sysctl_get_name</li> <li>bpf_sysctl_get_current_value</li> <li>bpf_sysctl_get_new_value</li> <li>bpf_sysctl_set_new_value</li></ul></li></ul></li></ul> <h2 id="其他類別"><a href="#其他類別" class="header-anchor">#</a> 其他類別</h2> <ul><li>LIRC 紅外線收發相關 (BPF_PROG_TYPE_LIRC_MODE2)
<ul><li>bpf_rc_repeat</li> <li>bpf_rc_keydown</li> <li>bpf_rc_pointer_rel</li></ul></li></ul> <h2 id="xdp-相關"><a href="#xdp-相關" class="header-anchor">#</a> XDP 相關</h2> <ul><li>於 XDP 修改封包大小 (可以增大或縮小)
<ul><li>bpf_xdp_adjust_head</li> <li>bpf_xdp_adjust_tail</li></ul></li> <li>XDP_TX redirect 使用
<ul><li>bpf_redirect_map</li></ul></li> <li>XDP 輸出封包內容到 perf event
<ul><li>bpf_xdp_output</li></ul></li> <li>調整   <code>xdp_md-&gt;data_meta</code> <ul><li>bpf_xdp_adjust_meta</li></ul></li> <li>查詢 fid (Forward Information Base, L2)
<ul><li>bpf_fib_lookup (也可用在 TC)</li></ul></li></ul> <h2 id="lwt-相關"><a href="#lwt-相關" class="header-anchor">#</a> LWT 相關</h2> <ul><li>attach 在 routing table
<ul><li>替 L3 封包進行 tunnel header encap
<ul><li>bpf_lwt_push_encap</li></ul></li> <li>外封包 (underlay) 內容修改
<ul><li>bpf_lwt_seg6_store_bytes</li> <li>bpf_lwt_seg6_adjust_srh</li></ul></li> <li>套用 IPv6 Segment Routing action 決策
<ul><li>bpf_lwt_seg6_action</li></ul></li></ul></li></ul> <h2 id="socket-socket-buffer-相關"><a href="#socket-socket-buffer-相關" class="header-anchor">#</a> socket, socket buffer 相關</h2> <ul><li>用於   <code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code> ，修改 bind address
<ul><li>bpf_bind</li></ul></li> <li>讀取封包內容
<ul><li>bpf_skb_load_bytes</li> <li>bpf_skb_load_bytes_relative</li></ul></li> <li>修改封包內容，可自動更新 chekcsum
<ul><li>bpf_skb_store_bytes</li></ul></li> <li>改寫 l3, l4 的 checksum
<ul><li>bpf_l3_csum_replace</li> <li>bpf_l4_csum_replace</li></ul></li> <li>用於計算 check sum，可搭配前兩個 replace 函數使用
<ul><li>bpf_csum_diff</li></ul></li> <li>取得 xfrm (IPsec 相關)
<ul><li>bpf_skb_get_xfrm_state</li></ul></li> <li>將封包發到其他的 device。後者會複製一分封包。
<ul><li>bpf_redirect</li> <li>bpf_clone_redirect</li></ul></li> <li>取得 classid，參考 cgroup 的 net_cls，使用於 TC egress path。
<ul><li>bpf_get_cgroup_classid</li></ul></li> <li>增減 vlan header
<ul><li>bpf_skb_vlan_push</li> <li>bpf_skb_vlan_pop</li></ul></li> <li>取得、修改封包的 tunnel (ex. GRE) 的 tunnel key 資訊
<ul><li>bpf_skb_get_tunnel_key</li> <li>bpf_skb_set_tunnel_key</li></ul></li> <li>取得、修改封包的 tunnel 資訊
<ul><li>bpf_skb_get_tunnel_opt</li> <li>bpf_skb_set_tunnel_opt</li></ul></li> <li>取得 skb 的 tclassid 欄位，用於 clsact TC egress
<ul><li>bpf_get_route_realm</li></ul></li> <li>修改封包 prtocol (ipv4, ipv6)
<ul><li>bpf_skb_change_proto</li></ul></li> <li>修改封包類型 (broadcast, multicast, unitcast..)
<ul><li>bpf_skb_change_type</li></ul></li> <li>搭配   <code>BPF_MAP_TYPE_CGROUP_ARRAY</code>   使用，檢查 skb 是不是在某個 cgroup v2 節點的子節點內。
<ul><li>bpf_skb_under_cgroup</li></ul></li> <li>取得 skb 對應的 cgroup id
<ul><li>bpf_skb_cgroup_id</li></ul></li> <li>向上查找 skb 對應 cgroup 節點的祖先節點 id
<ul><li>bpf_sk_ancestor_cgroup_id</li></ul></li> <li>取得、修改   <code>skb-&gt;hash</code> <ul><li>bpf_get_hash_recalc</li> <li>bpf_set_hash</li></ul></li> <li>修改封包大小
<ul><li>bpf_skb_change_tail</li></ul></li> <li>用於封包 payload 存取，具體內容有點難理解 (non-linear data)
<ul><li>bpf_skb_pull_data</li></ul></li> <li>修改   <code>skb-&gt;csum</code> <ul><li>bpf_csum_update</li></ul></li> <li>修改   <code>skb-&gt;csum_level</code> <ul><li>bpf_csum_level</li></ul></li> <li>標註   <code>skb-&gt;hash</code>   為無效，觸發重算
<ul><li>bpf_set_hash_invalid</li></ul></li> <li>將   <code>skb-&gt;sk</code>   轉成所有欄位都可以訪問的版本
<ul><li>bpf_sk_fullsock</li></ul></li> <li>從   <code>skb-&gt;sk</code>   取得   <code>struct bpf_tcp_sock</code> <ul><li>bpf_tcp_sock</li></ul></li> <li>向 tcp-sock 對應的方向發一個 tcp-ack
<ul><li>bpf_tcp_send_ack</li></ul></li> <li>從   <code>skb-&gt;sk</code>   取得   <code>bpf_sock</code> <ul><li>bpf_get_listener_sock</li></ul></li> <li>設置   <code>skb-&gt;sk</code> <ul><li>bpf_sk_assign</li></ul></li> <li>取得 bpf_sock 對應的 cgroupv2 id
<ul><li>bpf_sk_cgroup_id</li></ul></li> <li>取得 bpf_sock 對應 cgroupv2 節點的祖先 id
<ul><li>bpf_sk_ancestor_cgroup_id</li></ul></li> <li>強制轉型 sk 成特定的 XXX_sock 結構
<ul><li>bpf_skc_to_tcp6_sock</li> <li>bpf_skc_to_tcp_sock</li> <li>bpf_skc_to_tcp_timewait_sock</li> <li>bpf_skc_to_tcp_request_sock</li> <li>bpf_skc_to_udp6_sock</li></ul></li> <li>增加 packet header 區 (headroom) 長度，用於為 L3 封包直接加上 L2 的 header
<ul><li>bpf_skb_change_head</li></ul></li> <li>幫 socket 建立一個 cookie，作為 socket 的 identifier，用於追蹤
<ul><li>bpf_get_socket_cookie (sk_buff)</li> <li>bpf_get_socket_cookie (bpf_sock_addr)</li> <li>bpf_get_socket_cookie (bpf_sock_ops)</li></ul></li> <li>取得 socket 的 owner UID
<ul><li>bpf_get_socket_uid</li></ul></li> <li>模擬呼叫 getsocketopt、setsockopt
<ul><li>bpf_getsockopt</li> <li>bpf_setsockopt</li></ul></li> <li>存取 skb 的 ebpf local storage
<ul><li>bpf_sk_storage_get</li> <li>bpf_sk_storage_delete</li></ul></li> <li>將封包內容輸出到 perf event
<ul><li>bpf_skb_output</li></ul></li> <li>修改封包 payload 大小，可以從 L2 或 L3 的角度來看
<ul><li>bpf_skb_adjust_room</li></ul></li> <li>產生、尋找封包對應的   <code>SYN cookie ACK</code> + bpf_tcp_gen_syncookie+ bpf_tcp_check_syncookie</li> <li><code>BPF_PROG_TYPE_SK_SKB</code>  (ingress 方向)
<ul><li>搭配   <code>BPF_MAP_TYPE_SOCKMAP</code>   做 socket redierct
<ul><li>bpf_sk_redirect_map</li> <li>bpf_sk_redirect_hash</li></ul></li> <li>搜尋滿足對應 5-tuple 的 socket
<ul><li>bpf_sk_lookup_tcp</li> <li>bpf_skc_lookup_tcp</li> <li>bpf_sk_lookup_udp</li></ul></li> <li>釋放上面兩個找到的 socket 的 reference
<ul><li>bpf_sk_release</li></ul></li></ul></li> <li><code>BPF_PROG_TYPE_SK_MSG</code>  (egress 方向)
<ul><li>搭配   <code>BPF_MAP_TYPE_SOCKMAP</code>   做 socket redierct
<ul><li>bpf_msg_redirect_map</li> <li>bpf_msg_redirect_hash</li></ul></li> <li>替特定長度的內容作 verdict (SK_PASS…)，可用於截短封包，優化處理速度 (tc 相關的東西不太熟…/)
<ul><li>bpf_msg_apply_bytes</li></ul></li> <li>跳過接下來某長度的內容不做 veridct
<ul><li>bpf_msg_cork_bytes</li></ul></li> <li>讀寫修改特定長度的資料
<ul><li>bpf_msg_pull_data</li> <li>bpf_msg_pop_data</li> <li>bpf_msg_push_data</li></ul></li></ul></li> <li>更新   <code>BPF_MAP_TYPE_SOCKMAP</code> <ul><li>bpf_sock_map_update</li></ul></li> <li>設置   <code>bpf_sock_ops-&gt;bpf_sock_ops_cb_flags</code>   欄位
<ul><li>bpf_sock_ops_cb_flags_set</li></ul></li> <li>更新 sockhash
<ul><li>bpf_sock_hash_update</li></ul></li> <li>用於   <code>BPF_PROG_TYPE_SK_REUSEPORT</code>  (將多個程式綁定在同一個 port 上)
<ul><li>sk_select_reuseport</li></ul></li> <li>用於   <code>BPF_PROG_TYPE_CGROUP_SKB</code> ，設置 ECN (Explicit Congestion Notification)
<ul><li>bpf_skb_ecn_set_ce</li></ul></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=eBPF" title="標簽">#eBPF</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/29</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.fd10c8b2.js" defer></script><script src="/assets/js/2.abd11f75.js" defer></script><script src="/assets/js/20.4f3578d8.js" defer></script>
  </body>
</html>
