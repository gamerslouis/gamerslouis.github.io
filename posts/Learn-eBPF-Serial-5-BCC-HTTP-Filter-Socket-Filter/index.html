<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>學習 eBPF 系列 5 - BCC HTTP Filter &amp; Socket Filter | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="2022 iThome鐵人賽 學習eBPF系列 介紹http-parser實例以及socket filter">
    <meta name="og:title" content="學習 eBPF 系列 5 - BCC HTTP Filter &amp; Socket Filter">
    <meta name="og:description" content="2022 iThome鐵人賽 學習eBPF系列 介紹http-parser實例以及socket filter">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9566bf8.css" as="style"><link rel="preload" href="/assets/js/app.d4ae833f.js" as="script"><link rel="preload" href="/assets/js/2.abd11f75.js" as="script"><link rel="preload" href="/assets/js/16.76c0ba1e.js" as="script"><link rel="prefetch" href="/assets/js/10.a4a57a95.js"><link rel="prefetch" href="/assets/js/11.07008736.js"><link rel="prefetch" href="/assets/js/12.58f7cde8.js"><link rel="prefetch" href="/assets/js/13.167587bb.js"><link rel="prefetch" href="/assets/js/14.ba4cf81d.js"><link rel="prefetch" href="/assets/js/15.bcf04feb.js"><link rel="prefetch" href="/assets/js/17.f762e910.js"><link rel="prefetch" href="/assets/js/18.bbb1cd20.js"><link rel="prefetch" href="/assets/js/19.96ee1a4f.js"><link rel="prefetch" href="/assets/js/20.4f3578d8.js"><link rel="prefetch" href="/assets/js/21.d5b1dc5d.js"><link rel="prefetch" href="/assets/js/22.e083d81d.js"><link rel="prefetch" href="/assets/js/23.053a181b.js"><link rel="prefetch" href="/assets/js/24.0e29934f.js"><link rel="prefetch" href="/assets/js/25.f313e86f.js"><link rel="prefetch" href="/assets/js/26.8e32042c.js"><link rel="prefetch" href="/assets/js/27.374e1436.js"><link rel="prefetch" href="/assets/js/28.0bac4585.js"><link rel="prefetch" href="/assets/js/29.3c2e46f7.js"><link rel="prefetch" href="/assets/js/3.1dd456ea.js"><link rel="prefetch" href="/assets/js/30.901456ee.js"><link rel="prefetch" href="/assets/js/4.5ca1880f.js"><link rel="prefetch" href="/assets/js/5.d77edfd3.js"><link rel="prefetch" href="/assets/js/6.f0fdf8b0.js"><link rel="prefetch" href="/assets/js/7.a519000e.js"><link rel="prefetch" href="/assets/js/8.fb002ea2.js"><link rel="prefetch" href="/assets/js/9.669bd080.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9566bf8.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>學習 eBPF 系列 5 - BCC HTTP Filter &amp; Socket Filter</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#socket-filter-介紹" class="sidebar-link">Socket filter 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#http-parse-simple-介紹" class="sidebar-link">http-parse-simple 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#http-parse-simple-實作" class="sidebar-link">http-parse-simple 實作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#ebpf-實作" class="sidebar-link">eBPF 實作</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#python-實作" class="sidebar-link">python 實作</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#問題" class="sidebar-link">問題</a></li></ul></li><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#深入了解-socket-filter" class="sidebar-link">深入了解 Socket filter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#bcc-debug" class="sidebar-link">BCC Debug</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#解析-simple-http-parse-編譯結果" class="sidebar-link">解析 simple-http-parse 編譯結果</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#了解-ebpf-bpf-abs-instruction" class="sidebar-link">了解 eBPF BPF_ABS instruction</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#sk-buff-的限制" class="sidebar-link">\_skbuff 的限制</a></li></ul></li><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#結語" class="sidebar-link">結語</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-5-BCC-HTTP-Filter-Socket-Filter/#參考資料" class="sidebar-link">參考資料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-2df51549><div class="articleInfo" data-v-2df51549><!----> <div class="info" data-v-2df51549><div title="作者" class="author iconfont icon-touxiang" data-v-2df51549><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-2df51549>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-2df51549><a href="javascript:;" data-v-2df51549>2022-10-31</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-2df51549><a href="/categories/?category=%E5%AD%B8%E7%BF%92%20eBPF%20%E7%B3%BB%E5%88%97" data-v-2df51549>學習 eBPF 系列 </a><a href="/categories/?category=2022%20iThome%E9%90%B5%E4%BA%BA%E8%B3%BD" data-v-2df51549>2022 iThome鐵人賽 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">學習 eBPF 系列 5 - BCC HTTP Filter &amp; Socket Filter<!----></h1>  <div class="theme-vdoing-content content__default"><p>這篇文章會介紹 eBPF socket filter 的概念，並使用 bcc 的  <a href="https://github.com/iovisor/bcc/tree/master/examples/networking/http_filter" target="_blank" rel="noopener noreferrer">http-parse-simple.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  作為範例，來說明如何使用 eBPF socket filter 來過濾 HTTP 請求，並且會深入底下 eBPF 的 socket filter 底層部分的實作。</p> <h2 id="socket-filter-介紹"><a href="#socket-filter-介紹" class="header-anchor">#</a> Socket filter 介紹</h2> <p>前一篇文章介紹的 tcpconnect 是使用   <code>BPF_PROG_TYPE_KPROBE</code>   這個 program type，透過 kprobe/kretprobe 機制在 kernel function 被呼叫和回傳的時候執行。</p> <p>這次使用的是   <code>BPF_PROG_TYPE_SOCKET_FILTER</code> ，socket filter 可以對進出 socket 的封包進行截斷或過濾。特別注意這邊如果會需要擷取封包 (長度不等於原始封包長度) 則會觸發對封包進行複製，然後修改封包大小。</p> <p>socket filter program 會在 socket 層被呼叫 (在 net/core/sock.c 的 sock_queue_rcv_skb 被呼叫)，並傳入  <a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L5745" target="_blank" rel="noopener noreferrer">_sk_buff 結構<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  取得 socket 上下文及封包的內容。</p> <p>透過回傳的數值來決定如何處理該封包，如果回傳的數值大於等於封包長度，等價於保留完整封包，如果長度小於封包長度，則截斷只保留回傳數值長度的封包。其中兩個特例是回傳 0 和 - 1。回傳 0 等價解取一個長度為 0 的封包，也就是直接丟棄該封包。回傳 - 1 時，由於封包長度是無號整數，-1 等價於整數的最大數值，因此保證保留整個完整的封包。</p> <p>另外一個關鍵技術是 raw socket，我們可以將 raw socket 監聽某個網路介面上所有進出封包。</p> <p>因此整個程式的執行方式是這樣的，在目標網路卡上開啟一個 raw socket，透過 eBPF 程式過濾掉所有非 http 的封包，只保留 http 封包送出到 raw socket，userspace client 接收到封包時，可以直接解析封包欄位提取出 http 封包資訊。</p> <h2 id="http-parse-simple-介紹"><a href="#http-parse-simple-介紹" class="header-anchor">#</a> http-parse-simple 介紹</h2> <p>首先一樣先了解一下這支程式的功能，http-parse 能夠綁定到一張網路卡上面執行，然後提取經過 http 流量，將 http version, method, uri 和 status 輸出顯示。(當然如果經過 tls 加密的話是沒辦法的)</p> <p>執行結果如下</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>python http-parse-complete.py
GET /pipermail/iovisor-dev/ HTTP/1.1
HTTP/1.1 200 OK
GET /favicon.ico HTTP/1.1
HTTP/1.1 404 Not Found
GET /pipermail/iovisor-dev/2016-January/thread.html HTTP/1.1
HTTP/1.1 200 OK
GET /pipermail/iovisor-dev/2016-January/000046.html HTTP/1.1
HTTP/1.1 200 OK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="http-parse-simple-實作"><a href="#http-parse-simple-實作" class="header-anchor">#</a> http-parse-simple 實作</h2> <h3 id="ebpf-實作"><a href="#ebpf-實作" class="header-anchor">#</a> eBPF 實作</h3> <p>在這次的程式中 eBPF c code 直接寫在一個獨立的 http-parse-simple.c 檔案中。</p> <p>這次的 ebpf 程式很簡單只有單一個函數   <code>http_filter</code> ，作為 socket filter 的進度點。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">http_filter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//filter IP packets (ethernet type = 0x0800)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ethernet<span class="token operator">-&gt;</span>type <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">goto</span> DROP<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">struct</span> <span class="token class-name">ip_t</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//drop the packet returning 0</span>
	DROP<span class="token operator">:</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>相信很多人跟我一樣第一眼看到這個程式會覺得非常疑惑，首先看到的是   <code>cursor</code>   和   <code>cursor_advance</code>   這兩個東西，從 ip 那行大概可以猜的出來，cursor 是對封包內容存取位置的指標，cursor_advance 會輸出當前 cursor 的位置，然後將 cursor 向後移動第二個參數的長度。由於我們要分析的是 http 封包，所以他的 ether type 勢必得是 0x0800 (IP)，所以對於不滿足的封包，我們直接 goto 到 drop，return 0。表示我們要擷取一個長度為 0 的封包等價於丟棄該封包。</p> <p>在 bcc 的  <a href="https://github.com/iovisor/bcc/blob/master/src/cc/export/helpers.h" target="_blank" rel="noopener noreferrer">helpers.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  輔助函數標頭檔裡面可以看到 cursor_advane 的定義。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//packet parsing state machine helpers</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cursor_advance</span> <span class="token expression"><span class="token punctuation">(</span>_cursor<span class="token punctuation">,</span> _len<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token operator">*</span>_tmp <span class="token operator">=</span> _cursor<span class="token punctuation">;</span> _cursor <span class="token operator">+=</span> _len<span class="token punctuation">;</span> _tmp<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>果然符合我們的預期，先將原先 cursor 指標的數值保留起來，將 cursor 向後移動 len 後回傳原始數值。</p> <p>後面的程式碼其實就很簡單，首先一路解析封包確保他是一個 ip/tcp/http 封包、封包長度夠長塞的下一個有效的 http 封包內容</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>payload_offset <span class="token operator">=</span> ETH_HLEN <span class="token operator">+</span> ip_header_length <span class="token operator">+</span> tcp_header_length<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> p <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p <span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">load_byte</span> <span class="token punctuation">(</span>skb<span class="token punctuation">,</span> payload_offset <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接著將 http packet 的前 7 個 byte 讀出來，load_byte 同樣是定義在  <a href="https://github.com/iovisor/bcc/blob/master/src/cc/export/helpers.h" target="_blank" rel="noopener noreferrer">helpers.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">load_byte</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> off<span class="token punctuation">)</span> <span class="token keyword">asm</span> <span class="token punctuation">(</span><span class="token string">&quot;llvm.bpf.load.byte&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>他會直接轉譯成 BPF_LD_ABS，從 payload_offset 位置開始讀一個 byte 出來，payload_offset，是前面算出來從 ethernet header 開始到 http payload 的位移。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//HTTP</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'H'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'T'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'T'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'P'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">goto</span> KEEP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//GET</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'G'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'E'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'T'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">goto</span> KEEP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//no HTTP match</span>
<span class="token keyword">goto</span> DROP<span class="token punctuation">;</span>

<span class="token comment">//keep the packet and send it to userspace returning -1</span>
KEEP<span class="token operator">:</span>
<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>接著檢查如果封包屬於 HTTP (以 HTTP, GET, POST, PUT, DELETE HEAD… 開頭)，就會跳到 keep，保留整個完整的封包送到 userspace client program。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>GET <span class="token operator">/</span>favicon<span class="token punctuation">.</span>ico HTTP<span class="token operator">/</span><span class="token number">1.1</span>
HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> OK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>HTTP request 會以 method 開頭、response 會以 HTTP 開頭，所以需要查找這些字樣開頭的封包。</p> <h3 id="python-實作"><a href="#python-實作" class="header-anchor">#</a> python 實作</h3> <p>接著我們很快速的來看一下 python 程式碼的部分。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bpf <span class="token operator">=</span> BPF <span class="token punctuation">(</span>src_file <span class="token operator">=</span> <span class="token string">&quot;http-parse-simple.c&quot;</span><span class="token punctuation">,</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
function_http_filter <span class="token operator">=</span> bpf<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;http_filter&quot;</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SOCKET_FILTER<span class="token punctuation">)</span>
BPF<span class="token punctuation">.</span>attach_raw_socket <span class="token punctuation">(</span>function_http_filter<span class="token punctuation">,</span> interface<span class="token punctuation">)</span>
socket_fd <span class="token operator">=</span> function_http_filter<span class="token punctuation">.</span>sock
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>fromfd <span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>PF_PACKET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_RAW<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>IPPROTO_IP<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setblocking <span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>首先我們一樣透過 BPF 物件完成 bpf 程式碼的編譯，不一樣的是是這邊直接指定 src_file 從檔案讀取。接著透過 load_func，指定 socket filter 這個 program type type 和 http_filter 這個入口函數，並載入 ebpf bytecode 到 kernel 接著透過 bcc 提供的 attach_raw_socket API 在 interface 上建立 row socket 並將 socket filter program attach 上去。接著從   <code>function_http_filter.sock</code>   取得 raw socket 的 file descripter 並封裝成 python 的 socket 物件。由於後面需要 socket 是阻塞的，但是 attach_raw_socket 建立出來的 socket 是非阻塞的，所以這邊透過   <code>sock.setblocking (True)</code>   阻塞 socket</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
  <span class="token comment">#retrieve raw packet from socket</span>
  packet_str <span class="token operator">=</span> os<span class="token punctuation">.</span>read <span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span><span class="token number">2048</span><span class="token punctuation">)</span>
  packet_bytearray <span class="token operator">=</span> <span class="token builtin">bytearray</span> <span class="token punctuation">(</span>packet_str<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span>payload_offset<span class="token punctuation">,</span><span class="token builtin">len</span> <span class="token punctuation">(</span>packet_bytearray<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_bytearray <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span> <span class="token number">0x0A</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># \n</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_bytearray <span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x0D</span><span class="token punctuation">)</span><span class="token punctuation">:</span> \r
        <span class="token keyword">break</span> <span class="token comment"># 遇到 http 的換行 \r\n 則結束 &lt; br&gt;    print (&quot;% c&quot; % chr (packet_bytearray [i]), end = &quot;&quot;)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>後面的程式碼其實就和 ebpf 的部分大同小異，從 socket 讀取封包內容、解析到 http payload 後，將 http payload 的第一行輸出出來。</p> <p>到此我們就完成了   <code>http-parse-simple</code>   的解析。</p> <h3 id="問題"><a href="#問題" class="header-anchor">#</a> 問題</h3> <ol><li><p>cursor 指標數值為 0，但是可以存取到封包的內容。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ethernet<span class="token operator">-&gt;</span>type <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">goto</span> DROP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>特別的 load_bytes 函數呼叫，來取得封包內容</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">load_byte</span> <span class="token punctuation">(</span>skb<span class="token punctuation">,</span> payload_offset <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>首先雖然 ebpf 使用 c 來編寫，但是經由 LLVM 編譯後會轉換成 eBPF bytecode，在進入 kernel 後會再經過 verifier 的修改。(經過這次的探索，可以理解 verifier 雖然叫做 verifier，但是他的功能確包羅萬象，對 eBPF 架構來說非常重要)</p> <h2 id="深入了解-socket-filter"><a href="#深入了解-socket-filter" class="header-anchor">#</a> 深入了解 Socket filter</h2> <p>為了理解這段 eBPF code 後面發生了什麼事，我們先查看 LLVM 編譯出來的 eBPF bytecode。</p> <h3 id="bcc-debug"><a href="#bcc-debug" class="header-anchor">#</a> BCC Debug</h3> <p>在 BCC 編譯時，我們可以透過   <code>debug</code>   這個參數取得編譯過程中的資訊，當然也包含取得 LLVM 編譯出來的 eBPF bytecode，可以使用的 debug 選項如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># Debug flags</span>

<span class="token comment"># Debug output compiled LLVM IR.</span>
DEBUG_LLVM_IR <span class="token operator">=</span> <span class="token number">0x1</span>
<span class="token comment"># Debug output loaded BPF bytecode and register state on branches.</span>
DEBUG_BPF <span class="token operator">=</span> <span class="token number">0x2</span>
<span class="token comment"># Debug output pre-processor result.</span>
DEBUG_PREPROCESSOR <span class="token operator">=</span> <span class="token number">0x4</span>
<span class="token comment"># Debug output ASM instructions embedded with source.</span>
DEBUG_SOURCE <span class="token operator">=</span> <span class="token number">0x8</span>
<span class="token comment"># Debug output register state on all instructions in addition to DEBUG_BPF.</span>
DEBUG_BPF_REGISTER_STATE <span class="token operator">=</span> <span class="token number">0x10</span>
<span class="token comment"># Debug BTF.</span>
DEBUG_BTF <span class="token operator">=</span> <span class="token number">0x20</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="解析-simple-http-parse-編譯結果"><a href="#解析-simple-http-parse-編譯結果" class="header-anchor">#</a> 解析 simple-http-parse 編譯結果</h3> <p>透過   <code>BPF (src='simple-http-parse.c', debug=DEBUG_PREPROCESSOR)</code> ，我們可以看到上面的 code 被 LLVM 重新解釋為</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//filter IP packets (ethernet type = 0x0800)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">bpf_dext_pkt</span> <span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span> ethernet<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">goto</span> DROP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因此 cursor 在這邊的用途真的只是計算 offset。bpf_dext_pkt 在 bcc 的  <a href="https://github.com/iovisor/bcc/blob/master/src/cc/export/helpers.h" target="_blank" rel="noopener noreferrer">helper.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  有所定義</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>u64 <span class="token function">bpf_dext_pkt</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pkt<span class="token punctuation">,</span> u64 off<span class="token punctuation">,</span> u64 bofs<span class="token punctuation">,</span> u64 bsz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bofs <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bsz <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">load_byte</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bofs <span class="token operator">+</span> bsz <span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">load_byte</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> off<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> <span class="token punctuation">(</span>bofs <span class="token operator">+</span> bsz<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>  <span class="token function">MASK</span> <span class="token punctuation">(</span>bsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bofs <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bsz <span class="token operator">==</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token function">load_half</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到他是根據參數大小和類型去正確呼叫 load_byte, load_half, load_dword 系列函數，所以其實他做的事情與我們感興趣的第二段 code  <code>load_byte (skb, payload_offset + i);</code>   是一致的。</p> <p>接著我們使用   <code>BPF (src='simple-http-parse.c', debug=DEBUG_SOURCE)</code>   查看編譯出來的 eBPF binary code。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">;</span> <span class="token keyword">int</span> <span class="token function">http_filter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Line  27</span>
   <span class="token number">0</span><span class="token operator">:</span>	bf <span class="token number">16</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>	r6 <span class="token operator">=</span> r1
   <span class="token number">1</span><span class="token operator">:</span>	<span class="token number">28</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">0</span>c <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>	r0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u16 <span class="token operator">*</span><span class="token punctuation">)</span> skb <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>
<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">bpf_dext_pkt</span> <span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span> ethernet<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Line  34</span>
   <span class="token number">2</span><span class="token operator">:</span>	<span class="token number">55</span> <span class="token number">00</span> <span class="token number">5</span>c <span class="token number">00</span> <span class="token number">00</span> <span class="token number">08</span> <span class="token number">00</span> <span class="token number">00</span>	<span class="token keyword">if</span> r0 <span class="token operator">!=</span> <span class="token number">2048</span> <span class="token keyword">goto</span> <span class="token operator">+</span><span class="token number">92</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中 r0, r1, r6 是 eBPF 的 register，我們這邊只關注第 1 行   <code>r0 = *(u16 *) skb [12]</code> ，這行是從 skb 的第 12 個 byte 拿取資料出來，剛好對應到 bpf_dext_pkt。</p> <p>根據 ebpf instruction set 的定義，第一個 byte 28 (0010 1000) 是 op code。最後 3 個 bit 000 是 op code 的種類。這邊的 0x00 對應到   <code>BPF_LD</code>  (non-standard load operations)</p> <table><thead><tr><th>3 bits (MSB)</th> <th>2 bits</th> <th>3 bits (LSB)</th></tr></thead> <tbody><tr><td>mode</td> <td>size</td> <td>instruction class</td></tr></tbody></table> <p>在   <code>BPF_LD</code>   這個分類內，size bits 01 剛好對應到   <code>BPF_H</code>  (half word (2 bytes)) 最前面的 3 個 bit 000 代表   <code>BPF_ABS</code> (legacy BPF packet access)。</p> <p>到這邊我們就理解它是怎麼運作了了，eBPF 定義了   <code>BPF_ABS</code>   來代表對封包的存取操作，LLVM 在編譯的時會將對 skb 的 load_byte 轉譯成對應的 instruction。</p> <h3 id="了解-ebpf-bpf-abs-instruction"><a href="#了解-ebpf-bpf-abs-instruction" class="header-anchor">#</a> 了解 eBPF BPF_ABS instruction</h3> <p>我們可以更深入的了解一下 eBPF 對   <code>BPF_ABS</code>   做了什麼事情，在 verifier 這個神奇的地方搜尋   <code>BPF_ABS</code>   這個 instruction，會找到下面這段內容 (簡化版)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">/</span><span class="token operator">*</span> Implement LD_ABS <span class="token keyword">and</span> LD_IND <span class="token keyword">with</span> a rewrite<span class="token punctuation">,</span> <span class="token keyword">if</span> supported by the program <span class="token builtin">type</span><span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>BPF_CLASS <span class="token punctuation">(</span>insn<span class="token operator">-</span><span class="token operator">&gt;</span>code<span class="token punctuation">)</span> <span class="token operator">==</span> BPF_LD <span class="token operator">&amp;</span><span class="token operator">&amp;</span>
	<span class="token punctuation">(</span>BPF_MODE <span class="token punctuation">(</span>insn<span class="token operator">-</span><span class="token operator">&gt;</span>code<span class="token punctuation">)</span> <span class="token operator">==</span> BPF_ABS <span class="token operator">|</span><span class="token operator">|</span>
	 BPF_MODE <span class="token punctuation">(</span>insn<span class="token operator">-</span><span class="token operator">&gt;</span>code<span class="token punctuation">)</span> <span class="token operator">==</span> BPF_IND<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	cnt <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">&gt;</span>ops<span class="token operator">-</span><span class="token operator">&gt;</span>gen_ld_abs <span class="token punctuation">(</span>insn<span class="token punctuation">,</span> insn_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	new_prog <span class="token operator">=</span> bpf_patch_insn_data <span class="token punctuation">(</span>env<span class="token punctuation">,</span> i <span class="token operator">+</span> delta<span class="token punctuation">,</span> insn_buf<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>首先執行條件是   <code>BPF_LD</code>   及   <code>BPF_ABS</code> ，我們的 code 剛好符合這個條件，接著會呼叫   <code>env-&gt;ops-&gt;gen_ld_abs</code> ，根據原本的 instrunction  <code>insn</code> ，生成新的 instruction 寫入   <code>insn_buf</code> ，接著呼叫   <code>bpf_patch_insn_data</code>   將原本的指令取代為新的指令。</p> <p>接著我們要找一下   <code>gen_ld_abs</code> ，跟 day 11 介紹 map 的情況類似，verifier 定義了 bpf_verifier_ops 結構，讓不同的 program type 根據需要，實作 bpf_verifier_ops 定義的 function 來提供不同的功能和行為。</p> <p>socket filter 的定義如下</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">bpf_verifier_ops</span> sk_filter_verifier_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>get_func_proto		<span class="token operator">=</span> sk_filter_func_proto<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>is_valid_access	<span class="token operator">=</span> sk_filter_is_valid_access<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>convert_ctx_access	<span class="token operator">=</span> bpf_convert_ctx_access<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>gen_ld_abs		<span class="token operator">=</span> bpf_gen_ld_abs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所以讓我們看到   <code>bpf_gen_ld_abs</code>  (一樣經過簡化只看我們需要的部分)</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bpf_gen_ld_abs</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">bpf_insn</span> <span class="token operator">*</span>insn<span class="token punctuation">,</span>
			  <span class="token keyword">struct</span> <span class="token class-name">bpf_insn</span> <span class="token operator">*</span>insn_buf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token operator">*</span>insn<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">BPF_MOV64_REG</span> <span class="token punctuation">(</span>BPF_REG_2<span class="token punctuation">,</span> orig<span class="token operator">-&gt;</span>src_reg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* We're guaranteed here that CTX is in R6. */</span>
	<span class="token operator">*</span>insn<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">BPF_MOV64_REG</span> <span class="token punctuation">(</span>BPF_REG_1<span class="token punctuation">,</span> BPF_REG_CTX<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">*</span>insn<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">BPF_EMIT_CALL</span> <span class="token punctuation">(</span>bpf_skb_load_helper_16_no_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>看到最後一行就很清晰了，最後其實等於調用了內部使用的 helper function 來存取資料。eBPF 也提提供了類似的 helper function  <code>bpf_skb_load_bytes</code> ，來提供存取封包內容的功能。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">BPF_CALL_2</span> <span class="token punctuation">(</span>bpf_skb_load_helper_16_no_cache<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token punctuation">,</span> skb<span class="token punctuation">,</span>
	   <span class="token keyword">int</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">____bpf_skb_load_helper_16</span> <span class="token punctuation">(</span>skb<span class="token punctuation">,</span> skb<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> skb<span class="token operator">-&gt;</span>len <span class="token operator">-</span> skb<span class="token operator">-&gt;</span>data_len<span class="token punctuation">,</span>
					  offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>而 bpf_skb_load_helper_16_no_cache 其實就是直接從   <code>sk_buff-&gt;data</code>   的位置取得資料，data 是 sk_buff 用來指到封包開頭的指標。</p> <h3 id="sk-buff-的限制"><a href="#sk-buff-的限制" class="header-anchor">#</a> __sk_buff 的限制</h3> <p>既然整個指令的本質是從   <code>sk_buff-&gt;data</code>   拿取資料，那我們是不是能夠直接從   <code>__sk_buff</code>   裡面拿到資料呢？</p> <p>在 socket program type 下 program context 是   <code>__sk_buff</code> ，他其實本質是對 sk_buff 的多一層封裝 (原因  <a href="https://lwn.net/Articles/636647" target="_blank" rel="noopener noreferrer">參見<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，在執行的時候，verifier 換將其取代回 sk_buff，因此__sk_buff 等於是 sk_buff 暴露出來的介面。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	__u32 data<span class="token punctuation">;</span>
	__u32 data_end<span class="token punctuation">;</span>
	__u32 napi_id<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>參考 **sk_buff 的定義， <code>**sk_buff</code>  是有定義將  <code>data</code>  和  <code>data_end</code> ，那我們原始的 eBPF 程式是不是可以改成</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__sk_buff<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ethernet<span class="token operator">-&gt;</span>type <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">goto</span> DROP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果完成這樣的修改，重新跑一遍   <code>http-parse-simple.py</code> ，你會得到</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python3 http-parse-simple.py <span class="token parameter variable">-i</span> eno0
binding socket to <span class="token string">'enp0s3'</span>
bpf: Failed to load program: Permission denied
<span class="token punctuation">;</span> int http_filter <span class="token punctuation">(</span>struct __sk_buff *skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">0</span>: <span class="token punctuation">(</span>bf<span class="token punctuation">)</span> r6 <span class="token operator">=</span> r1
<span class="token punctuation">;</span> void *cursor <span class="token operator">=</span> <span class="token punctuation">(</span>void*<span class="token punctuation">)</span><span class="token punctuation">(</span>long<span class="token punctuation">)</span> skb-<span class="token operator">&gt;</span>data<span class="token punctuation">;</span>
<span class="token number">1</span>: <span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span> r7 <span class="token operator">=</span> *<span class="token punctuation">(</span>u32 *<span class="token punctuation">)</span><span class="token punctuation">(</span>r6 +76<span class="token punctuation">)</span>
invalid bpf_context access <span class="token assign-left variable">off</span><span class="token operator">=</span><span class="token number">76</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">4</span>
processed <span class="token number">2</span> insns <span class="token punctuation">(</span>limit <span class="token number">1000000</span><span class="token punctuation">)</span> max_states_per_insn <span class="token number">0</span> total_states <span class="token number">0</span> peak_states <span class="token number">0</span> mark_read <span class="token number">0</span>

Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">&quot;http-parse-simple.py&quot;</span>, line <span class="token number">69</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    function_http_filter <span class="token operator">=</span> bpf.load_func <span class="token punctuation">(</span><span class="token string">&quot;http_filter&quot;</span>, BPF.SOCKET_FILTER<span class="token punctuation">)</span>
  File <span class="token string">&quot;/usr/lib/python3/dist-packages/bcc/__init__.py&quot;</span>, line <span class="token number">526</span>, <span class="token keyword">in</span> load_func
    raise Exception <span class="token punctuation">(</span><span class="token string">&quot;Failed to load BPF program % s: % s&quot;</span> %
Exception: Failed to load BPF program b<span class="token string">'http_filter'</span><span class="token builtin class-name">:</span> Permission denied
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>可以看到程式碼被 verifier 拒絕，並拿到了一個   <code>invalid bpf_context access off=76 size=4</code>   的錯誤，表示存取   <code>__sk_buff-&gt;data</code>   是非法的。</p> <p>回去追蹤程式碼的話，會看到在 verifier 裡面會用   <code>env-&gt;ops-&gt;is_valid_access</code>   來檢查該存取是否有效，這同樣定義在   <code>bpf_verifier_ops</code>   結構內。</p> <p>其中 socket filter program 的實作是</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> bool <span class="token function">sk_filter_is_valid_access</span> <span class="token punctuation">(</span><span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span>
				      <span class="token keyword">enum</span> <span class="token class-name">bpf_access_type</span> type<span class="token punctuation">,</span>
				      <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">bpf_prog</span> <span class="token operator">*</span>prog<span class="token punctuation">,</span>
				      <span class="token keyword">struct</span> <span class="token class-name">bpf_insn_access_aux</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>off<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> tc_classid<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> data_meta<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> data_end<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range_till</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> family<span class="token punctuation">,</span> local_port<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> tstamp<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> wire_len<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token keyword">case</span> <span class="token function">bpf_ctx_range</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span><span class="token punctuation">,</span> hwtstamp<span class="token punctuation">)</span><span class="token operator">:</span>
		<span class="token keyword">return</span> false<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以很直接看到拒絕了 data 的存取。</p> <p>從 linux kernel 的  <a href="https://github.com/torvalds/linux/commit/db58ba45920255e967cc1d62a430cebd634b5046" target="_blank" rel="noopener noreferrer">變更紀錄<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  來推測，data 欄位好像本來就不是給 socket filter 使用的，只是單純因為 cls_bpf 和 socker filter 可能共用了這部分的程式碼，因此要額外阻擋這部分的 code 不讓使用。</p> <h2 id="結語"><a href="#結語" class="header-anchor">#</a> 結語</h2> <p>最後還有一個沒解決的問題， <code>u8 *cursor = 0;</code> ，為甚麼空指標經過 LLVM 編譯後會編譯成對 skb 的存取還是未知的，看起來像是 BCC 特別的機制，但是找不太到相關資料，只好保留這個問題。</p> <h2 id="參考資料"><a href="#參考資料" class="header-anchor">#</a> 參考資料</h2> <ul><li><a href="https://www.kernel.org/doc/html/v5.17/bpf/instruction-set.html" target="_blank" rel="noopener noreferrer">eBPF Instruction Set<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://stackoverflow.com/questions/61702223/bpf-verifier-rejects-code-invalid-bpf-context-access" target="_blank" rel="noopener noreferrer">Stackoverflow: invalid bpf_context access”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">bpf-helpers man page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=eBPF" title="標簽">#eBPF</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/10/29</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2023
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.d4ae833f.js" defer></script><script src="/assets/js/2.abd11f75.js" defer></script><script src="/assets/js/16.76c0ba1e.js" defer></script>
  </body>
</html>
