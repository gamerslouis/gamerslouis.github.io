<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>學習 eBPF 系列 8 - cgroups &amp; socket map | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF socket map以及Linux cgroups">
    <meta name="og:title" content="學習 eBPF 系列 8 - cgroups &amp; socket map">
    <meta name="og:description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF socket map以及Linux cgroups">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    <meta name="charset" content="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.2ebaa67f.css" as="style"><link rel="preload" href="/assets/js/app.ad93c9f8.js" as="script"><link rel="preload" href="/assets/js/2.2b01b354.js" as="script"><link rel="preload" href="/assets/js/19.eb7eb15a.js" as="script"><link rel="prefetch" href="/assets/js/10.6a4ce372.js"><link rel="prefetch" href="/assets/js/11.d3560910.js"><link rel="prefetch" href="/assets/js/12.7dbcb6d5.js"><link rel="prefetch" href="/assets/js/13.02b26798.js"><link rel="prefetch" href="/assets/js/14.4fd9b6ba.js"><link rel="prefetch" href="/assets/js/15.37e1037d.js"><link rel="prefetch" href="/assets/js/16.8f6395a3.js"><link rel="prefetch" href="/assets/js/17.53c69df4.js"><link rel="prefetch" href="/assets/js/18.a472fde3.js"><link rel="prefetch" href="/assets/js/20.f6da8ff4.js"><link rel="prefetch" href="/assets/js/21.7d208469.js"><link rel="prefetch" href="/assets/js/22.a00a1a38.js"><link rel="prefetch" href="/assets/js/23.501c2967.js"><link rel="prefetch" href="/assets/js/24.0b90cd8d.js"><link rel="prefetch" href="/assets/js/25.58482239.js"><link rel="prefetch" href="/assets/js/26.e40f46b7.js"><link rel="prefetch" href="/assets/js/27.b3b48379.js"><link rel="prefetch" href="/assets/js/28.de68677f.js"><link rel="prefetch" href="/assets/js/29.3384551f.js"><link rel="prefetch" href="/assets/js/3.62d7cadb.js"><link rel="prefetch" href="/assets/js/30.fb6e4035.js"><link rel="prefetch" href="/assets/js/4.5de74737.js"><link rel="prefetch" href="/assets/js/5.81cf5ff3.js"><link rel="prefetch" href="/assets/js/6.e0637f95.js"><link rel="prefetch" href="/assets/js/7.fb0750a4.js"><link rel="prefetch" href="/assets/js/8.62c01479.js"><link rel="prefetch" href="/assets/js/9.62355ca7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2ebaa67f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>學習 eBPF 系列 8 - cgroups &amp; socket map</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#cgroups-介紹" class="sidebar-link">cgroups 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#socketmap-介紹" class="sidebar-link">socketmap 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#sockmap-py-介紹" class="sidebar-link">sockmap.py 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#sock-ops-program-type" class="sidebar-link">SOCK_OPS program type</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#sk-msg-sk-skb-program-type" class="sidebar-link">SKMSG SKSKB program type</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#sockmap-實作" class="sidebar-link">sockmap 實作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#ebpf-實作" class="sidebar-link">eBPF 實作</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#python-實作" class="sidebar-link">python 實作</a></li></ul></li><li><a href="/posts/Learn-eBPF-Serial-8-cgroups-socket-map/#參考文件" class="sidebar-link">參考文件</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-12a44dd8><div class="articleInfo" data-v-12a44dd8><!----> <div class="info" data-v-12a44dd8><div title="作者" class="author iconfont icon-touxiang" data-v-12a44dd8><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-12a44dd8>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-12a44dd8><a href="javascript:;" data-v-12a44dd8>2022-10-31</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-12a44dd8><a href="/categories/?category=%E5%AD%B8%E7%BF%92%20eBPF%20%E7%B3%BB%E5%88%97" data-v-12a44dd8>學習 eBPF 系列 </a><a href="/categories/?category=2022%20iThome%E9%90%B5%E4%BA%BA%E8%B3%BD" data-v-12a44dd8>2022 iThome鐵人賽 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">學習 eBPF 系列 8 - cgroups &amp; socket map<!----></h1>  <div class="theme-vdoing-content content__default"><p>本篇是 BCC 學習歷程的最後一篇，這篇文章會介紹 linux cgroups、eBPF socketmap 的功能，並以  <a href="https://github.com/iovisor/bcc/blob/master/examples/networking/sockmap.py" target="_blank" rel="noopener noreferrer">sockmap.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  作為範例。</p> <h2 id="cgroups-介紹"><a href="#cgroups-介紹" class="header-anchor">#</a> cgroups 介紹</h2> <p>cgroups 是 Linux kernel 內建的一個機制，可以以進程為最小單位，對可使用的 CPU、memory、裝置 I/O 等資源進行限制、分割。</p> <blockquote><p>cgroups 目前有 v1 和 v2 兩個版本，在分組策略架構上有所差異，這邊介紹只以 v1 為主</p></blockquote> <p>在 cgroup 的架構內，我們可以針對不同的資源類型進行獨立管理 (稱為不同的 subsystem 或 controller) ，一些可能的資源類型和一部份的功能簡介如下</p> <ul><li>cpu: 對一定時間週期內，可使用的 cpu 時間長度限制</li> <li>memory: 限制記憶體使用上限以及超出上限時的行為</li> <li>blkio: 控制對硬碟等設備的訪問速度上限</li> <li>cpuacct: 用來統計目前的 CPU 使用情況</li> <li>devices: 控制可以訪問那些 device</li> <li>pids: 限制 cgroup 內可建立的 pid 數量，也就是進程數量</li></ul> <p>接著是   <code>hierarchy</code> ，cgroup 使用樹狀結構來管理資源，一個   <code>hierarchy</code>   預設會有一個根結點，所有的 process (pid 都會 attach 在這個節點上)。</p> <p>一個   <code>hierarchy</code>   可以對應到零個或多個上述的 subsystem，並在一個節點內設置上述的那些限制，那這些限制就會套用到在這個節點內的所有 process。</p> <p>可以在   <code>hierarchy</code>   內建立子節點，那子節點就會預設套用父節點的所有設置，然後可以只針對有興趣的項目作更細緻的調正。</p> <p>一個 process 在一棵   <code>hierarchy</code>   只能 attach 在一個節點上，可以對 process 設定所在的節點。從 process fork 出來的 process 會在同一個節點上，但是搬運 process 到不同的節點，並不會影響子 process。</p> <p>Linux 透過虛擬檔案系統來提供修改調整 cgroups 的 user space 介面。通常來說介面會被掛載在   <code>/sys/fs/cgroup</code>   這個路徑下。</p> <p>我們可以透過 mount 來建立   <code>hierarchy</code>   並把他關連到一個或多個 subsystem</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#  關連到 CPU</span>
<span class="token function">mkdir</span> /sys/fs/cgroup/cpu
<span class="token function">mount</span> <span class="token parameter variable">-t</span> cgroup <span class="token parameter variable">-o</span> cpu none /sys/fs/cgroup/cpu
<span class="token comment">#  關連到 CPU 和 CPUACCT</span>
<span class="token function">mkdir</span> /sys/fs/cgroup/cpu,cpuacct
<span class="token function">mount</span> <span class="token parameter variable">-t</span> cgroup <span class="token parameter variable">-o</span> cpu,cpuacct none /sys/fs/cgroup/cpu,cpuacct
<span class="token comment">#  不過 /sys/fs/cgroup 目錄可能會被系統設置為 &lt; span class=&quot;hljs-built_in&quot;&gt;read only，避免隨意變更，而且通常不需要增減 hierarchy 本身，只是在 hierarchy 內增減節點管理</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>查看所有目前的 hierarchy</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ls</span> /sys/fs/cgroup/-l
total <span class="token number">0</span>
dr-xr-xr-x <span class="token number">4</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 blkio
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">11</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 cpu -<span class="token operator">&gt;</span> cpu,cpuacct
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">11</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 cpuacct -<span class="token operator">&gt;</span> cpu,cpuacct
dr-xr-xr-x <span class="token number">4</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 cpu,cpuacct
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 cpuset
dr-xr-xr-x <span class="token number">4</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 devices
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 freezer
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 hugetlb
dr-xr-xr-x <span class="token number">4</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 memory
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 misc
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">16</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 net_cls -<span class="token operator">&gt;</span> net_cls,net_prio
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 net_cls,net_prio
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">16</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 net_prio -<span class="token operator">&gt;</span> net_cls,net_prio
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 perf_event
dr-xr-xr-x <span class="token number">4</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 pids
dr-xr-xr-x <span class="token number">2</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 rdma
dr-xr-xr-x <span class="token number">5</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 systemd
dr-xr-xr-x <span class="token number">5</span> root root  <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">22</span>:50 unified
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>接著查看 cpu 的根結點</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ls</span> /sys/fs/cgroup/cpu/-l
total <span class="token number">0</span>
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cgroup.clone_children
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cgroup.procs
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cgroup.sane_behavior
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.stat
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_all
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_percpu
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_percpu_sys
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_percpu_user
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_sys
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpuacct.usage_user
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpu.cfs_period_us
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpu.cfs_quota_us
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpu.shares
-r--r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cpu.stat
drwxr-xr-x  <span class="token number">4</span> root root <span class="token number">0</span>  八  <span class="token number">24</span> <span class="token number">14</span>:50 <span class="token function">docker</span>
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 notify_on_release
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 release_agent
drwxr-xr-x <span class="token number">96</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> 06:05 system.slice
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 tasks
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:31 user.slice
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>由於前面可以看到 cpu 被 link 到 cpu,cpuacct，所以可以同時查看到 cpu._ 和 cpuacct._ 的選項。</p> <p>透過 cpu.cfs_quota_us 和 cpu.cfs_period_us 我們就能控制這個節點上所有 process 在 period 內可使用的 CPU 時間 (quota)。</p> <p>透過   <code>cat tasks</code>   我們可以看到所有 attach 在這個節點上的 pid。</p> <p>可以看到有三個資料夾   <code>docker</code> ,  <code>system.slice</code> ,  <code>user.slice</code> ，是三個 hierarchy 上的子節點，我們可以簡單的透過   <code>mkdir</code>   的方式建立子節點。由於這台設備上有跑 docker，所以 docker 會在 /sys/fs/cgroup/cpu/docker/ 目錄下為每個 container 建立獨立的子節點，透過 cgroup 的方式限制容器的資源使用量。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">&quot;{{.ID}}&quot;</span>
90f64cb70ee0
177d1a3920ec

<span class="token function">ls</span> /sys/fs/cgroup/cpu/docker <span class="token parameter variable">-l</span>
total <span class="token number">0</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">0</span>  八  <span class="token number">24</span> <span class="token number">14</span>:50 177d1a3920ec9<span class="token punctuation">..</span><span class="token punctuation">..</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">0</span>  八  <span class="token number">24</span> <span class="token number">14</span>:50 90f64cb70ee068<span class="token punctuation">..</span>.
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cgroup.clone_children
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">0</span>  十  <span class="token number">11</span> <span class="token number">21</span>:39 cgroup.procs
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>在許多發行版上使用 systemd 來做為核心系統管理程式，也就會透過 systemd 來管理 cgroup，因此在設置 kubelet 時會建議將 cgroup driver 從 cgroupfs 改成 systemd，統一由 systemd 來管理，避免同時有兩個系統在調整 cgroup</p></blockquote> <p>cgroup v2 調整了管理介面的結構，只保留了單一個 hierarchy (/sys/fs/cgroup/unified) 管理所有的 subsystem，因為切出多個 hierarchy 來管理的方式被認為是不必要且增加系統複雜度的。</p> <p>到這邊大概介紹完了 cgroup，由於這次 sockmap.py 使用的 program type 的 hook point 會在 cgroup 上，所以趁這個機會詳細了解了一下 cgroup。</p> <h2 id="socketmap-介紹"><a href="#socketmap-介紹" class="header-anchor">#</a> socketmap 介紹</h2> <p>這邊我們拿 Cilium CNI <a href="https://www.slideshare.net/ThomasGraf5/accelerating-envoy-and-istio-with-cilium-and-the-linux-kernel" target="_blank" rel="noopener noreferrer">介紹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  的一張圖來說明。</p> <p><img src="/img/pages/8b86be37f7cbdec6c7d97c3b0bcb34d1.png" alt="無 socket redirect 架構"></p> <p>圖中是一個使用 envoy sidecar 的 kubernetes pod 網路連線示意圖，簡單來說 kubernetes 上面容器 (Pod) 服務 (Service) 的網路流量會透過 iptables 的機制全部重新導向到跑在同一個容器內的 sidecar，透過 sidecar 當作中介完成網路監控、服務發現等功能後才會真正離開容器。進入容器的流量同樣先都重導向到 sidecar 處理。</p> <p>這樣的好處是可以完全不對 service 本身修改，完全由獨立的 sidecar 來提供附加的網路功能，但是也有一個很明顯的問題，一個封包在傳輸的過程中，要經過 3 次 Linux kernel 的 network stack 處理，大大降低了封包的傳輸效率。</p> <p>其中由於都是在同一台設備的同一個網路空間內傳輸，因此 TPC/IP/ethernet 等底層網路完全可以省略。</p> <p><img src="/img/pages/688dfb0d59d389e0d1df77d8d99401d0.png" alt="socket redirect 架構"></p> <p>因此我們可以透過 eBPF 的 socket redirect 技術來簡化這個封包的傳輸過程，簡單來說，在同一個設備的兩個 socket 間的傳輸，我們完全可以直接跳過底層的網路堆疊，直接在 socket layer 將封包內容從一個 socket 搬到另外一個 socket，跳過底層 TCP/IP/ethernet 處理。</p> <h2 id="sockmap-py-介紹"><a href="#sockmap-py-介紹" class="header-anchor">#</a> sockmap.py 介紹</h2> <p>bcc 的   <code>sockmap.py</code>   提供的就是 socket redirect 的功能，他會監聽機器上的所有 socket，將 local to local 的 tcp 連線資料封包直接透過 socket redirect 的方式進行搬運。</p> <blockquote><p>socket redirect 機制好像同時也節省了 packet 在 userspace 和 kernel space 之間複製搬運的過程，不過這件事情沒有完全確定。</p></blockquote> <p>我們一樣先看看執行起來怎麼樣，我們透過 python 建立一個 http server 並透過 curl 來測試</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python3 <span class="token parameter variable">-m</span> http.server <span class="token operator">&amp;</span>
<span class="token function">curl</span> <span class="token number">127.0</span>.0.1:8000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接著是 eBPF 程式的執行結果</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>python3 sockmap.py <span class="token parameter variable">-c</span> /sys/fs/cgroup/unified/
b<span class="token string">'curl-3043    [000] d...1  7164.673950: bpf_trace_printk: remote-port: 8000, local-port: 46246'</span>
b<span class="token string">'curl-3043    [000] dN..1  7164.673973: bpf_trace_printk: Sockhash op: 4, port 46246 --&gt; 8000'</span>
b<span class="token string">'curl-3043    [000] dNs11  7164.673985: bpf_trace_printk: remote-port: 46246, local-port: 8000'</span>
b<span class="token string">'curl-3043    [000] dNs11  7164.673988: bpf_trace_printk: Sockhash op: 5, port 8000 --&gt; 46246'</span>
b<span class="token string">'curl-3043    [000] d...1  7164.674643: bpf_trace_printk: try redirect port 46246 --&gt; 8000'</span>
b<span class="token string">'python3-3044    [000] d...1  7164.675211: bpf_trace_printk: try redirect port 8000 --&gt; 46246'</span>
b<span class="token string">'python3-3044    [000] d...1  7164.675492: bpf_trace_printk: try redirect port 8000 --&gt; 46246'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>這邊可以看到 sockmap 要指定一個 - c 的參數，後面是指定一個 cgroup，sockmap 只會監控在這個 cgroup 節點上的 socket 連線。這邊 unified 是 cgroup v2 的 hierarchy，在 cgroup v2 只有 unified 一個 hierarchy，所有 subsystem 都在這個 hierarchy 上。</p></blockquote> <p>首先是   <code>curl remote-port: 8000, local-port: 46246' Sockhash op: 4, port 46246 --&gt; 8000'</code> ，這兩條是 curl 發起連線時，記錄下來的 socket 連線請求。</p> <p>接著   <code>curl remote-port: 46246, local-port: 8000' Sockhash op: 5, port 8000 --&gt; 46246'</code> ，是 curl 跟 http server 之間連線建立成功後，返回給 curl 的 socket 通知。</p> <p>接著可以看到 3 條   <code>try redirect</code>   是 curl 傳遞 http request 和 http server 返回 http response 的 msg，直接透過 socket redirect 的方式在兩個 socket 之間交互。</p> <p>這邊我們使用 tcpdump 去監聽   <code>lo</code>  interface 的方式來驗證 socket redirect 有真的運作到。同樣是透過   <code>curl 127.0.0.1:8000</code>   發起連線傳輸資料。在沒有啟用 sockmap 的情況下 tcpdump 捕捉到 12 個封包。而開啟 socketmap 後只會捕捉到 6 個封包。</p> <p>透過封包內容會發現，在 socketmap 啟動後，只能夠捕捉到帶   <code>SYN</code> 、 <code>FIN</code>   等 flag 的 TCP 控制封包，不會捕捉到中間純粹的資料交換封包。</p> <h2 id="sock-ops-program-type"><a href="#sock-ops-program-type" class="header-anchor">#</a> SOCK_OPS program type</h2> <p>完成驗證後，我們接著來介紹這次用到的兩種 eBPG program type，分別是   <code>BPF_PROG_TYPE_SOCK_OPS</code>   和   <code>BPF_PROG_TYPE_SK_MSG</code> 。</p> <p><code>BPF_PROG_TYPE_SOCK_OPS</code>   可以 attach 在一個 cgroup 節點上，當該節點上任意 process 的 socket 發生特定事件時，該 eBPF program 會被觸發。可能的事件定義在  <a href="https://elixir.bootlin.com/linux/v6.0/source/include/uapi/linux/bpf.h" target="_blank" rel="noopener noreferrer">bpf.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。其中 CB 結尾的表示特定事件完成後觸發，例如   <code>BPF_SOCK_OPS_TCP_LISTEN_CB</code>   表示在 socket tcp 連線轉乘 LISTEN 狀態後觸發。有些則是觸發來透過回傳值設置一些控制項， <code>BPF_SOCK_OPS_TIMEOUT_INIT</code>   是在 TCP Timeout 後觸發，透過 eBPF 的 return value 設置 RTO，-1 表示使用系統預設。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">enum</span> <span class="token punctuation">{</span>
	BPF_SOCK_OPS_VOID<span class="token punctuation">,</span>
	BPF_SOCK_OPS_TIMEOUT_INIT<span class="token punctuation">,</span>
	BPF_SOCK_OPS_RWND_INIT<span class="token punctuation">,</span>
	BPF_SOCK_OPS_TCP_CONNECT_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_NEEDS_ECN<span class="token punctuation">,</span>
	BPF_SOCK_OPS_BASE_RTT<span class="token punctuation">,</span>
	BPF_SOCK_OPS_RTO_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_RETRANS_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_STATE_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_TCP_LISTEN_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_RTT_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_PARSE_HDR_OPT_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_HDR_OPT_LEN_CB<span class="token punctuation">,</span>
	BPF_SOCK_OPS_WRITE_HDR_OPT_CB<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>這邊要特別介紹的是   <code>BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB</code>   和   <code>BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB</code>   分別是在主動建立連線時 (發送 SYN，tcp 三手交握第一手)，和被動建立連線時 (發送 SYN+ACK，tcp 三手交握第二手) 觸發。</p> <p>觸發後會拿到 bpf_sock_ops 上下文，並根據事件不同，eBPF 回傳值也代表不同的意義。其中   <code>bpf_sock_ops-&gt;op</code>   對應到上述的事件類型。args 則是不同 op 可能帶的一些特殊參數。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">bpf_sock_ops</span> <span class="token punctuation">{</span>
	__u32 op<span class="token punctuation">;</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		__u32 args <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* Optionally passed to bpf program */</span>
		__u32 reply<span class="token punctuation">;</span>		<span class="token comment">/* Returned by bpf program	    */</span>
		__u32 replylong <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* Optionally returned by bpf prog  */</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	__u32 family<span class="token punctuation">;</span>
	__u32 remote_ip4<span class="token punctuation">;</span>	<span class="token comment">/* Stored in network byte order */</span>
	__u32 local_ip4<span class="token punctuation">;</span>	<span class="token comment">/* Stored in network byte order */</span>
	__u32 remote_ip6 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* Stored in network byte order */</span>
	__u32 local_ip6 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* Stored in network byte order */</span>
	__u32 remote_port<span class="token punctuation">;</span>	<span class="token comment">/* Stored in network byte order */</span>
	__u32 local_port<span class="token punctuation">;</span>	<span class="token comment">/* stored in host byte order */</span>
	__u32 is_fullsock<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="sk-msg-sk-skb-program-type"><a href="#sk-msg-sk-skb-program-type" class="header-anchor">#</a> SK_MSG SK_SKB program type</h2> <p>接著要介紹另外兩個 program type  <code>BPF_PROG_TYPE_SK_SKB</code>   和   <code>BPF_PROG_TYPE_SK_MSG</code> 。</p> <p>首先他們不 attach linux 本身的某個地方而是 attach 在一個 eBPF map 上，這個 map 必須是   <code>BPF_MAP_TYPE_SOCKMAP</code>   或   <code>BPF_MAP_TYPE_SOCKHASH</code> 。兩個 map 都是某個 key 對應到 socket，可以使用 sock_hash_update 更新 sockhash map，將 sock_ops 的上下文 bpf_sock_ops 結構當作 value 去插入。</p> <p>當 sockmap 裡面的 socket 有訊息要送出，封包要被放到 socket 的 TXQueue 時會觸發   <code>BPF_PROG_TYPE_SK_MSG</code> ，而當封包從外界送入被主機接收，要放到 socket 的 RXQueue 時則會觸發   <code>BPF_PROG_TYPE_SK_SKB</code> 。</p> <p>以這次會用到的   <code>BPF_PROG_TYPE_SK_MSG</code>   來說，當 userspace 呼叫 sendmsg 時，就會被 eBPF 程式攔截。</p> <p>可以透過回傳   <code>__SK_DROP</code> ,  <code>__SK_PASS</code> ,  <code>__SK_REDIRECT</code>   來決定是要丟棄、接收或做 socket redirect。</p> <p>透過 socket redirect，封包會從發送端 socket 直接被丟到接收端 socket RXQ。</p> <blockquote><p>目前 redirect 的功能只能用於 TCP 連線。</p></blockquote> <h2 id="sockmap-實作"><a href="#sockmap-實作" class="header-anchor">#</a> sockmap 實作</h2> <h3 id="ebpf-實作"><a href="#ebpf-實作" class="header-anchor">#</a> eBPF 實作</h3> <p>大致上的概念介紹完了就讓我們回到 bcc sockmap 的程式碼。</p> <p>首先一樣先看 eBPF 的程式碼。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_SOCK_OPS_MAP_ENTRIES</span> <span class="token expression"><span class="token number">65535</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">sock_key</span> <span class="token punctuation">{</span>
    u32 remote_ip4<span class="token punctuation">;</span>
    u32 local_ip4<span class="token punctuation">;</span>
    u32 remote_port<span class="token punctuation">;</span>
    u32 local_port<span class="token punctuation">;</span>
    u32 family<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_SOCKHASH</span> <span class="token punctuation">(</span>sock_hash<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock_key</span><span class="token punctuation">,</span> MAX_SOCK_OPS_MAP_ENTRIES<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>這邊定義了一個   <code>sock_key</code> ，作為 BPF_SOCKHASH socket map 的 key，透過 five tuple (IP src/dst, sct/dst port 及 TCP/UDP) 來定位一個連線。</p> <p>接著我們看到第一種 program type  <code>SOCK_OPS</code>   的入口函數。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">bpf_sockhash</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bpf_sock_ops</span> <span class="token operator">*</span>skops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u32 op <span class="token operator">=</span> skops<span class="token operator">-&gt;</span>op<span class="token punctuation">;</span>
    <span class="token comment">/* ipv4 only */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skops<span class="token operator">-&gt;</span>family <span class="token operator">!=</span> AF_INET<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB<span class="token operator">:</span>
        <span class="token keyword">case</span> BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB<span class="token operator">:</span>
            <span class="token function">bpf_sock_ops_ipv4</span> <span class="token punctuation">(</span>skops<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>這邊做的事情很簡單，在 socket 建立連線 (ACTIVE_ESTABLISHED_CB) 和接收連線 (PASSIVE_ESTABLISHED_CB) 時，呼叫 bpf_sock_ops_ipv4 將 socket 放到 sock map 內，讓 socket 被第二個 program type  <code>SK_MSG</code>   的程式能夠在 socket 呼叫 sendmsg 等 API 時被攔截處理。由於 socker redirect 只能處裡 TCP 連線，所以非   <code>AF_INET</code>   的連線會被過濾掉。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token function">bpf_sock_ops_ipv4</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bpf_sock_ops</span> <span class="token operator">*</span>skops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sock_key</span> skk <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>remote_ip4 <span class="token operator">=</span> skops<span class="token operator">-&gt;</span>remote_ip4<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>local_ip4  <span class="token operator">=</span> skops<span class="token operator">-&gt;</span>local_ip4<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>local_port <span class="token operator">=</span> skops<span class="token operator">-&gt;</span>local_port<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>remote_port  <span class="token operator">=</span> <span class="token function">bpf_ntohl</span> <span class="token punctuation">(</span>skops<span class="token operator">-&gt;</span>remote_port<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>family <span class="token operator">=</span> skops<span class="token operator">-&gt;</span>family<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token function">bpf_trace_printk</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> sock_hash<span class="token punctuation">.</span><span class="token function">sock_hash_update</span> <span class="token punctuation">(</span>skops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>skk<span class="token punctuation">,</span> BPF_NOEXIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bpf_trace_printk</span> <span class="token punctuation">(</span><span class="token string">&quot;bpf_sock_hash_update () failed. % d\\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">bpf_trace_printk</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>這邊的 bpf_sock_ops_ipv4 其實也很簡單，從 sock_opt 裡面提取出 IP 地址 / TCP port 的資訊，填充 sock_key 結構，然後呼叫 sock_hash_update 把 key-value piar 塞進去 sock_hash。後面的 flag 有   <code>BPF_NOEXIST</code> ,  <code>BPF_EXIST</code> ,  <code>BPF_ANY</code> 。 <code>BPF_NOEXIST</code>   表示只有 key 不在 map 裡面的時候可以插入。</p> <p>接著是   <code>BPF_PROG_TYPE_SK_MSG</code>   的入口函數。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">bpf_redir</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_msg_md</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>family <span class="token operator">!=</span> AF_INET<span class="token punctuation">)</span>
        <span class="token keyword">return</span> SK_PASS<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>remote_ip4 <span class="token operator">!=</span> msg<span class="token operator">-&gt;</span>local_ip4<span class="token punctuation">)</span>
        <span class="token keyword">return</span> SK_PASS<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sock_key</span> skk <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>remote_ip4 <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>local_ip4<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>local_ip4  <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>remote_ip4<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>local_port <span class="token operator">=</span> <span class="token function">bpf_ntohl</span> <span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>remote_port<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>remote_port <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>local_port<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>family <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>family<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> sock_hash<span class="token punctuation">.</span><span class="token function">msg_redirect_hash</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>skk<span class="token punctuation">,</span> BPF_F_INGRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bpf_trace_printk</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> SK_PASS<span class="token punctuation">)</span>
        <span class="token function">bpf_trace_printk</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>首先一樣我們只能處裡 TCP 連線所有把非   <code>AF_INET</code>   的連線透過   <code>return SK_PASS;</code>   交回 linux kernel 處理。</p> <p>接著由於 socket redirect 只在本機起作用，所以這邊簡單判斷 src ip 和 dst ip 相不相同，來判斷是否是 local to local 連線。</p> <p>接著由於 socket redirect 時要從發送端的 socket redirect 到接收端的 socket，因此我們要從 socket map 中找到接收端的 socket，對發送端和接收端的 socket 來說 src addres 和 dst address 的是顛倒的，所以這邊在生 sock_key 時會把 local 和 remote 顛倒。</p> <p>接著這邊的   <code>msg_redirect_hash</code>   是對   <code>bpf_msg_redirect_hash</code>  helper function 的包裝，會嘗試從 socket map 找到對應的 socket，然後完成 redirect 的設置，不過成功是回傳是 SK_PASS 而不是 SK_REDIRECT。</p> <p>到這邊就完成 eBPF 程式的部分了，接下來 python 的部分就很簡單，只是把 eBPG 程式掛進去。</p> <h3 id="python-實作"><a href="#python-實作" class="header-anchor">#</a> python 實作</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code>examples <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;examples:
    ./sockmap.py -c /root/cgroup # attach to /root/cgroup
&quot;&quot;&quot;</span>
parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser <span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">&quot;pipe data across multiple sockets&quot;</span><span class="token punctuation">,</span>
        formatter_class<span class="token operator">=</span>argparse<span class="token punctuation">.</span>RawDescriptionHelpFormatter<span class="token punctuation">,</span>
        epilog<span class="token operator">=</span>examples<span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument <span class="token punctuation">(</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--cgroup&quot;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Specify the cgroup address. Note. must be cgroup2&quot;</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>前面有提到 SOCK_OPS 要掛在一個 cgroup 下面，所以先吃一個 cgroup 路徑參數來。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>bpf <span class="token operator">=</span> BPF <span class="token punctuation">(</span>text<span class="token operator">=</span>bpf_text<span class="token punctuation">)</span>
func_sock_ops <span class="token operator">=</span> bpf<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;bpf_sockhash&quot;</span><span class="token punctuation">,</span> bpf<span class="token punctuation">.</span>SOCK_OPS<span class="token punctuation">)</span>
func_sock_redir <span class="token operator">=</span> bpf<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;bpf_redir&quot;</span><span class="token punctuation">,</span> bpf<span class="token punctuation">.</span>SK_MSG<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>編譯 eBPF 程式，取得兩個入口函數</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># raise if error</span>
fd <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>cgroup<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">)</span>
map_fd <span class="token operator">=</span> lib<span class="token punctuation">.</span>bpf_table_fd <span class="token punctuation">(</span>bpf<span class="token punctuation">.</span>module<span class="token punctuation">,</span> <span class="token string">b&quot;sock_hash&quot;</span><span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>attach_func <span class="token punctuation">(</span>func_sock_ops<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> BPFAttachType<span class="token punctuation">.</span>CGROUP_SOCK_OPS<span class="token punctuation">)</span>
bpf<span class="token punctuation">.</span>attach_func <span class="token punctuation">(</span>func_sock_redir<span class="token punctuation">,</span> map_fd<span class="token punctuation">,</span> BPFAttachType<span class="token punctuation">.</span>SK_MSG_VERDICT<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>前面提到 cgroup 介面是一個虛擬檔案系統，所以當然要透過 open 去取得對應的 file descriptor。接著就是 attach func_sock_ops 到 SOCK_OPS。由於 func_sock_redir 要 attach 到 sock map，所以先透過 bcc 的 API 取得 sock_hash map 的 file descripter，然後 attach 上去。</p> <p>這樣就完成 sockemap 的設置，可以成功提供 socket redirect 的服務了！</p> <h2 id="參考文件"><a href="#參考文件" class="header-anchor">#</a> 參考文件</h2> <ul><li><a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener noreferrer">cgroups man page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjx6a-q-eH9AhUjS2wGHZlPAbcQFnoECA4QAQ&amp;url=https%3A%2F%2Fmedium.com%2Fstarbugs%2F%25E7%25AC%25AC%25E4%25B8%2580%25E5%258D%2583%25E9%259B%25B6%25E4%25B8%2580%25E7%25AF%2587%25E7%259A%2584-cgroups-%25E4%25BB%258B%25E7%25B4%25B9-a1c5005be88c&amp;usg=AOvVaw10RsC5HM91QrnN5fKUCIld" target="_blank" rel="noopener noreferrer">第一千零一篇的 cgroups 介紹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/qq_46595591/article/details/107634756" target="_blank" rel="noopener noreferrer">Cgroups 中的资源管理 hierarchy 层级树<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=eBPF" title="標簽">#eBPF</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/10/13</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2024
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ad93c9f8.js" defer></script><script src="/assets/js/2.2b01b354.js" defer></script><script src="/assets/js/19.eb7eb15a.js" defer></script>
  </body>
</html>
