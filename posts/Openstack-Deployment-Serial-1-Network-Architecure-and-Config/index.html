<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenStack 架設系列 (1) - 網路架構解析及設置 | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="釐清OpenStack的網路架構，介紹flat, vlan, vxlan三種不同網路模式的差別，以及provider, self-service的不同">
    <meta name="og:title" content="OpenStack 架設系列 (1) - 網路架構解析及設置">
    <meta name="og:description" content="釐清OpenStack的網路架構，介紹flat, vlan, vxlan三種不同網路模式的差別，以及provider, self-service的不同">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    <meta name="charset" content="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.2ebaa67f.css" as="style"><link rel="preload" href="/assets/js/app.ad93c9f8.js" as="script"><link rel="preload" href="/assets/js/2.2b01b354.js" as="script"><link rel="preload" href="/assets/js/22.a00a1a38.js" as="script"><link rel="prefetch" href="/assets/js/10.6a4ce372.js"><link rel="prefetch" href="/assets/js/11.d3560910.js"><link rel="prefetch" href="/assets/js/12.7dbcb6d5.js"><link rel="prefetch" href="/assets/js/13.02b26798.js"><link rel="prefetch" href="/assets/js/14.4fd9b6ba.js"><link rel="prefetch" href="/assets/js/15.37e1037d.js"><link rel="prefetch" href="/assets/js/16.8f6395a3.js"><link rel="prefetch" href="/assets/js/17.53c69df4.js"><link rel="prefetch" href="/assets/js/18.a472fde3.js"><link rel="prefetch" href="/assets/js/19.eb7eb15a.js"><link rel="prefetch" href="/assets/js/20.f6da8ff4.js"><link rel="prefetch" href="/assets/js/21.7d208469.js"><link rel="prefetch" href="/assets/js/23.501c2967.js"><link rel="prefetch" href="/assets/js/24.0b90cd8d.js"><link rel="prefetch" href="/assets/js/25.58482239.js"><link rel="prefetch" href="/assets/js/26.e40f46b7.js"><link rel="prefetch" href="/assets/js/27.b3b48379.js"><link rel="prefetch" href="/assets/js/28.de68677f.js"><link rel="prefetch" href="/assets/js/29.3384551f.js"><link rel="prefetch" href="/assets/js/3.62d7cadb.js"><link rel="prefetch" href="/assets/js/30.fb6e4035.js"><link rel="prefetch" href="/assets/js/4.5de74737.js"><link rel="prefetch" href="/assets/js/5.81cf5ff3.js"><link rel="prefetch" href="/assets/js/6.e0637f95.js"><link rel="prefetch" href="/assets/js/7.fb0750a4.js"><link rel="prefetch" href="/assets/js/8.62c01479.js"><link rel="prefetch" href="/assets/js/9.62355ca7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2ebaa67f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>OpenStack 架設系列 (1) - 網路架構解析及設置</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#openstack-網路類型概念" class="sidebar-link">Openstack 網路類型概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#flat-network" class="sidebar-link">Flat network</a></li><li class="sidebar-sub-header level3"><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#vlan-networ" class="sidebar-link">Vlan networ</a></li><li class="sidebar-sub-header level3"><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#vxlan-network" class="sidebar-link">Vxlan network</a></li></ul></li><li><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#openstack-網路設置" class="sidebar-link">Openstack 網路設置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#provider-vs-self-service-networks" class="sidebar-link">Provider vs Self-service networks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/#openstack-self-service-指令" class="sidebar-link">Openstack self-service 指令</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-12a44dd8><div class="articleInfo" data-v-12a44dd8><!----> <div class="info" data-v-12a44dd8><div title="作者" class="author iconfont icon-touxiang" data-v-12a44dd8><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-12a44dd8>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-12a44dd8><a href="javascript:;" data-v-12a44dd8>2022-10-05</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-12a44dd8><a href="/categories/?category=OpenStack%20%E6%9E%B6%E8%A8%AD%E7%B3%BB%E5%88%97" data-v-12a44dd8>OpenStack 架設系列 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">OpenStack 架設系列 (1) - 網路架構解析及設置<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在嘗試布建 openstack 的過程中，卡關最久的應該是網路的部分，由於在設置 openstack 的過程中，需要先把網路介面和線路連接設定好，所以必須要對 openstack 的網路架構，有清晰的認知，不然在設置的過程中會遇到許多障礙…</p> <p>特別是 openstack 有  <code>flat, vlan, vxlan</code>  以及  <code>provider, self-service</code>  兩種不同維度的概念分類，因此在釐清的過程中花費許多時間，因此這邊整理一下 openstack 的各種網路架構。</p> <p>這篇文章不會介紹具體的 openstack 搭建，不過之後會有一篇介紹如何使用 openstack-ansible 來部屬 openstack。</p> <p>首先為了後續討論方便我們這邊要先幫 openstack 裡面的幾個網路層級訂個名子。</p> <ul><li>物理網路：由 openstack 節點上面的實體網卡以及結點外的網路構成</li> <li>覆蓋 (Overlay) 網路：以虛擬機的視角看到的 L2 網路後續會持續出現這三個名詞，在介紹的過程中來解釋和分析這三者的差別。</li></ul> <h2 id="openstack-網路類型概念"><a href="#openstack-網路類型概念" class="header-anchor">#</a> Openstack 網路類型概念</h2> <p>首先我們先撇開 openstack，我們看一個最簡單在多台實體設備上面裝設虛擬機構建出來的一個網路結構。</p> <p><img src="/img/pages/93ac534eca58dc84b691dbe9c3651980.png" alt="基礎網路架構"></p> <p>在這個架構裡，所有的 VM 和實體網卡都接在同一個 linux bridge 上，由於實體網卡也橋接在 bridge 上了，所以節點上的覆蓋網路是物理網路的延伸，可以看成所有實體共同構成了一個 L2 網路。
由於 bridge 本身可以給予 IP，當成是接在節點上的網路介面，因此 VM 和節點本身也都同在一個 L2 網路內彼此互相可見。
在這個網路架構中，物理網路和覆蓋網路是完全等價通透的。</p> <h3 id="flat-network"><a href="#flat-network" class="header-anchor">#</a> Flat network</h3> <p><img src="/img/pages/bc6c8e4d9cbc9cfbeeb5a25e1f257ecb.png" alt="基礎 Openstack 網路架構"></p> <p>接著我們加入 openstack 的組件。
首先是 controller 節點，我們在 controller 節點上部屬了 openstack 的 API 服務。
接著我們在 compute 節點上增加一張實體網卡  <code>eth1</code>  讓節點上的 nova agent 和 neutron agent 可以與 contrroller node 溝通。
在這個架構中，所有的 service 和 agent 是直接安裝在節點上的程式，因此可以透過 eth1 實體網卡的 ip 直接進行訪問。
在圖中的 linux bridge 換了顏色，因為這個 bridge 並不是由我們手動建立出來的而是由 neutron agent 自行建立出來的。同時當 nova 建立 VM 後，neutron 也會建立 veth pair 連接 bridge 和 VM。
到此我們就建立了最簡單的 openstack 網路，在這個網路架構下雖然節點本身的網路從 bridge 分離出來成為了獨立的網卡，但是節點本身和所有的 VM 還是同處在一個 L2 網路內，因此在這個網路架構中，物理網路和覆蓋網路是完全等價通透的。</p> <p>到此我們就建構了 neutron 的第一個種網路模式  <code>flat</code> 。Neutron 的不同模式差異在於說 neuitron 管理的 bridge 是如何接入物理網路的。在  <code>flat</code>  模式下對外網卡直接橋接到 bridge 上，不對封包做處理。</p> <p>在 openstack 中有 tenant networks 租戶網路的概念，我們可以在 openstack 上切出若干個獨立的 L2 網路，分給不同的 project 和 vms 使用。在使用單一個  <code>flat</code>  網路的時候，這件事是做不到了，因為所有 VM 都在同一個 L2 網路內。</p> <p><img src="/img/pages/0e50dff9a3c9098c92713afe3d961264.png" alt="flat 網路運算節點架構"></p> <p>直觀的第一個方法當然是切出多個  <code>flat</code>  network 給不同的 tenat 使用，然而這樣使用的限制非常大，首先我們需要替每個 flat 預先切出獨立的 L2 網路，在這個範例中我們使用獨立的網卡和交換機來分割，非常麻煩。</p> <p>因此比較可行的方法是使用 vlan 或 vxlan 來切割租戶網路，並將 vlan、vxlan 的建立管理交給 neutron agent 來處理。</p> <h3 id="vlan-networ"><a href="#vlan-networ" class="header-anchor">#</a> Vlan networ</h3> <p><img src="/img/pages/d73bbe6de54d701f57db6b2a5c235f41.png" alt="vlan 網路運算節點架構"></p> <p>首先是  <code>vlan</code>  模式，在 vlan 模式下我們一樣提供一個網路介面  <code>eth0</code>  給 neutron 使用，並一樣假設所有節點上的  <code>eth0</code>  介面都在 L2 互通。</p> <p>接著當我們透過 openstack 建立網路並指定為  <code>vlan</code>  type 時，neutron 會替該網路分配一個 vlan id，並建立對應的 vlan 網路卡，vlan 網路卡是 linux 本身的功能，經過 vlan 網路卡的封包會從該網路卡榜定的原始網卡送出去 (eth0)，但是封包會加上 vlan 網卡綁定的 vlan id。</p> <p>如上圖所示，我們切割出了 vlan 356 和 vlan 357 兩個租戶網路，並統一透過 eth0 物理網路與其他節點溝通。</p> <h3 id="vxlan-network"><a href="#vxlan-network" class="header-anchor">#</a> Vxlan network</h3> <p>首先我們先介紹一下 vxlan。和 vlan 的功能類似，vxlan 的功能也是在一個網路內切割出多個覆蓋網路，不過教於 vlan，vxlan 有以下特點:</p> <ul><li>vlan id 只能夠切出 4096 個網路，但是 vxlan id 可以切出 2 的 24 次方個網路。</li> <li>vlan 只是在 ethernet header 和 IP header 中間插了一個 vlan header，因此 vlan 只能在 L2 的物理網路內傳輸。但是 vxlan 的封裝方式是將整個 L2 封包加上一個 vxlan header 後，封裝在一個 UDP 封包內，因此透過外面的 UDP 封包，vxlan 能夠跨越 L3 網路建立 L2 的通道，連結兩個不相連的 L2 網路。</li></ul> <p>在 Linux 上建立 vxlan 介面時要指定兩個東西，一個是 vni (vxlan id), 另一個是 local ip，當封包通共 vxlan 介面時，會被加上包含 vni 的 vxlan id，外部的 UDP 封包則會利用 local ip 當作 src ip，同時利用該 local ip 對應的 interface 來收發 vxlan 封包。</p> <p>在 vlan 網路裡面，由於 vlan 一樣是 L2 封包，因此封包是透過 L2 的廣播學習機制來傳遞的。然而如前面所示，vxlan 封包會封裝成 UDP 封包，因此 vxlan 靠的是 L3 的路由機制來傳遞。</p> <p>在 Linux 上這個路由機制有幾種作法</p> <ul><li><p>在建立 vxlan interface 時直接指定 remote ip，建立成點對點的 vxlan tunnel</p></li> <li><p>透過 linux bridge forwarding database，下達 forwarding rule，指定當 L2 封包的 mac address 是多少的時候要送到哪個 remote ip</p></li> <li><p>最後也是 openstack 使用的方式，將封包發送到一個 L3 廣播地址 (例如 239.1.1.1)，linux 會自動在 L2 加上 multicast mac address，所有在同一個 L2 物理網路上的設備就能夠同時收到 vxlan 的封包。回到 openstack 上，在設置  <code>vxlan</code>  時和  <code>vlan</code> 、 <code>flat</code>  不太一樣，我們不用指定綁定的網路介面 (eth0)，而是要指定  <code>local_ip</code>  跟  <code>vxlan_group</code> ，前者對應到綁定解面 (eth0) 的 IP，後者則是 vxlan 廣播域的 IP (239.1.1.1)。後面就和 vlan 一樣，在 openstack 上建立的網路時，netruon 為該網路建立對應的 vxlan 介面和 linux bridge，來提供給該網路的虛擬機使用。</p> <p><img src="/img/pages/6255b50e4d5379c12f4a8b9044464387.png" alt="vxlan 網路運算節點架構"></p></li></ul> <p>雖然在一台節點上面不太可能開到 4096 個 tenant，但是在整個 openstack 叢集內可以將不同 tenant 分配在不同的節點上，因此 vxlan 是有意義的。</p> <h2 id="openstack-網路設置"><a href="#openstack-網路設置" class="header-anchor">#</a> Openstack 網路設置</h2> <p>在 openstack neutron 中，我們要設定每個節點上的 ml2 設定檔來提供 neutron 網路的基本資訊。路徑在  <code>/etc/neutron/plugins/ml2/</code> 。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2]
type_drivers = flat,vlan,vxlan,local
tenant_network_types = vxlan,vlan,flat
mechanism_drivers = linuxbridge
extension_drivers = port_security
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>首先對於上述三種不同的網路類型，如果要在 openstack 內使用需要指定啟用對應的  <code>type_drivers</code> 。(除了前面介紹的三種網路類型，還有 local 跟 gre 這兩種，前者用於單機情況 neutron 的 linux bridge 不連接到任何對外網路，後者使用 gre tunnel 來取代 vxlan tunnel，這邊不多作介紹)</li> <li>接著  <code>tenant_network_types</code>  表示在 openstack 設可以用於建立 project 租戶網路的網路類型，同時順序也代表了在建立網路時預設使用的網路類型優先順序。</li> <li><code>mechanism_drivers</code>  這邊指定是 linuxbridge，前面提到 neutron 會建立 bridge 來連接 VM 跟外部網路介面，其實這邊還有很多其他選項，例如 open vSwitch，來提供更多網路管理功能，但是這邊就只以 linux bridge 為主要介紹對象。</li> <li><code>extension_drivers</code>  則可以載入其他 plugin 來提供 QoS、安全管理的功能。</li></ul> <p>接著我們要設定物理網路和網路介面的對應，在 flat 和 vlan 網路模式下，我們都需要將網路與一張可以連接到物理網路的網路介面做綁定 (前面的 eth0 或 eth1)，但是在實際情況中，每個節點上網路介面卡的名稱可能不相通，因此需要在每個節點上指定物理網路和網路介面的對應。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[linux_bridge]
physical_interface_mappings = vlan1:eth0,flat1:eth1,flat2:eth2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接著對不同的網路類型有各自的網路設置，首先是 flat，要指定的東西很簡單，就是可以用於建立 flat network 的物理網路，如果所有網路都可以，則指定為 *</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2_type_flat]
flat_networks = flat1, flat2
# Example:flat_networks = *
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 vlan 部分則要指定在每個物理網路上允許的租戶網路 vlan id，格式是 <code>&lt;physical_network&gt;[:&lt;vlan_min&gt;:&lt;vlan_max&gt;]</code></p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2_type_vlan]
network_vlan_ranges = vlan1:101:200,vlan1:301:400
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最後 vxlan 分成兩個部分，首先和 vlan 類似，我們要指定可使用的 vxlan vni 和廣播域 ip</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2_type_vxlan]
vxlan_group = 239.1.1.1
vni_ranges = 1:1000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接著我們要設置綁定的網卡 ip</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[vxlan]
enable_vxlan = True
vxlan_group = 239.1.1.1
# VXLAN local tunnel endpoint
local_ip = 192.168.56.101
l2_population = False
ttl = 32
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>這邊有一個特別的東西是 l2 population，l2 population 是一種降低廣播封包造成網路負載的方式，在傳統網路內 ARP 封包需要廣播到所有的節點上，大大增加的網路的負擔，透過 l2 population 提供的 proxy ARP 機制，ARP 會在節點上直接由 neutron 回應，而不用透過物理網路廣播到所有節點上，大大降低網路負擔，由於 openstack 內所有的 VM IP、網卡 mac address 都會受到 openstack 的管理，因此 openstack 可以做到 proxy ARP。如果需要啟用 l2 population 則需要額外的 driver，這邊一樣不做詳細介紹。</p> <p>最後是網路安全的部分，在 openstack 我們可以使用 iptables 來建立 VM 的網路管理，iptables 會阻擋所有進出虛擬機網路的流量，並透過 security group 來下達 iptables 的規則允許特定流量進出。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code># /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[securitygroup]
firewall_driver = iptables
enable_security_group = True

# /etc/neutron/plugins/ml2/ml2_conf.ini
[securitygroup]
enable_security_group = True
enable_ipset = True
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="provider-vs-self-service-networks"><a href="#provider-vs-self-service-networks" class="header-anchor">#</a> Provider vs Self-service networks</h2> <p>接著我們要介紹 openstack 裡面另外一個重要的網路概念，provider network 跟 self-service network 的差別。</p> <p>首先要特別注意的是，這邊提到的分類方式和前面的網路類型是兩種不同的角度和分類方式。</p> <p>雖然 flat network 通常會搭配 provider networks，vlan 和 vxlan 通常會搭配 self service network 但是這並不是一定而且必要的。</p> <p>前面的網路類型我們探討的是要如何在跨節點的網路架構下提供一個或多個 L2 網路讓 VMs 之間可以彼此連接。</p> <p>這邊 provider 和 self-service 的差別則是要探討，如何提供前面切割出來的網路 L3 的網路功能 (gateway, routing…)</p> <p>在 provider 網路模式下，我們假設 L3 的網路功能可以直接由物理網路提供，因此 openstack 只負責提供 DHCP，以及將虛擬機接到物理網路上，其餘的 gateway, routing 功能，openstack 只假設存在，不多做處理。在最簡單的  <code>flat</code>  網路模式下這麼做當然是非常簡單可行的，最簡單的方法就是將  <code>flat</code>  網路直接接入節點間 openstack 管理用的網段，並與節點共用 ip subnet，直接由物理網路提供功能。</p> <p>然而在  <code>vlan</code>  和  <code>vxlan</code>  模式下使用 proider 網路就不是這麼好用了，前面提到相較於  <code>flat</code> ， <code>vlan</code>  和  <code>vxlan</code>  的特點就是能夠動態建立獨立的租戶網路，如果要使用 provider 機制，變成說我們要導入額外的自動化方式，替每個 vlan 或 vxlan 提供 gateway 的功能，因此通常會使用 self-service network。</p> <p>self-service network 指的是 openstack self service，也就是由 openstack 本身來提供 L3 網路的 gateway, router 的功能。</p> <p>為了要提供 router 的功能，openstack 的作法是使用 network namespace。</p> <p>首先我們需要在一個節點上部署 neutron 的 L3 agent。
當我們透過 openstack 的 API 建立一個 virtual router 的時候，netron L3 agent 會在節點上建立一個獨立的 network namespace 當作這台 virtual router 的主體。</p> <p><img src="/img/pages/afdd1a1876f49cd8274dfe38fba5ac17.png" alt=""></p> <p>接著我們就可以將不同的租戶網路接入 router，透過 linux 本身的 iptables, routing 的功能來提供租戶網路間 routing 的功能。</p> <p><img src="/img/pages/53d5638f933d3bc5fb6e059ab155d846.png" alt=""></p> <p>我們也可以透過把其中一個租戶網路或  <code>flat</code>  網路接入物理網路，使用 provider network 的方式，其他的租戶網路可以透過 virtual router routing 到 provider network 的租戶網路來上網。</p> <h3 id="openstack-self-service-指令"><a href="#openstack-self-service-指令" class="header-anchor">#</a> Openstack self-service 指令</h3> <p>這邊補充一下如何透過 cli 在 openstack 上建立 router 還有把租戶網路加入 router</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openstack router create router1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>首先建立 router1</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openstack port create <span class="token parameter variable">--network</span> net1 net1-router-port
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接著為了讓租戶網路能夠 “接線” 到 router，我們需要幫網路建立一個 port</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>openstack router <span class="token function">add</span> port router1 net1-router-port
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最後把 port 接到 router 上</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=OpenStack" title="標簽">#OpenStack</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/10/13</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2024
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ad93c9f8.js" defer></script><script src="/assets/js/2.2b01b354.js" defer></script><script src="/assets/js/22.a00a1a38.js" defer></script>
  </body>
</html>
