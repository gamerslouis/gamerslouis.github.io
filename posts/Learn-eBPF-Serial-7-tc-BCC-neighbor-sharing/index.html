<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing | Louis Li&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF實例neighbor_sharing以及Linux tc子系統">
    <meta name="og:title" content="學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing">
    <meta name="og:description" content="2022 iThome鐵人賽 學習eBPF系列 介紹eBPF實例neighbor_sharing以及Linux tc子系統">
    <meta name="og:image" content="/img/og_image.png">
    <meta name="keywords" content="個人技術部落格,網路,Kubernetes,Linux">
    <meta name="theme-color" content="#11a8cd">
    <meta name="charset" content="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.2ebaa67f.css" as="style"><link rel="preload" href="/assets/js/app.ad93c9f8.js" as="script"><link rel="preload" href="/assets/js/2.2b01b354.js" as="script"><link rel="preload" href="/assets/js/18.a472fde3.js" as="script"><link rel="prefetch" href="/assets/js/10.6a4ce372.js"><link rel="prefetch" href="/assets/js/11.d3560910.js"><link rel="prefetch" href="/assets/js/12.7dbcb6d5.js"><link rel="prefetch" href="/assets/js/13.02b26798.js"><link rel="prefetch" href="/assets/js/14.4fd9b6ba.js"><link rel="prefetch" href="/assets/js/15.37e1037d.js"><link rel="prefetch" href="/assets/js/16.8f6395a3.js"><link rel="prefetch" href="/assets/js/17.53c69df4.js"><link rel="prefetch" href="/assets/js/19.eb7eb15a.js"><link rel="prefetch" href="/assets/js/20.f6da8ff4.js"><link rel="prefetch" href="/assets/js/21.7d208469.js"><link rel="prefetch" href="/assets/js/22.a00a1a38.js"><link rel="prefetch" href="/assets/js/23.501c2967.js"><link rel="prefetch" href="/assets/js/24.0b90cd8d.js"><link rel="prefetch" href="/assets/js/25.58482239.js"><link rel="prefetch" href="/assets/js/26.e40f46b7.js"><link rel="prefetch" href="/assets/js/27.b3b48379.js"><link rel="prefetch" href="/assets/js/28.de68677f.js"><link rel="prefetch" href="/assets/js/29.3384551f.js"><link rel="prefetch" href="/assets/js/3.62d7cadb.js"><link rel="prefetch" href="/assets/js/30.fb6e4035.js"><link rel="prefetch" href="/assets/js/4.5de74737.js"><link rel="prefetch" href="/assets/js/5.81cf5ff3.js"><link rel="prefetch" href="/assets/js/6.e0637f95.js"><link rel="prefetch" href="/assets/js/7.fb0750a4.js"><link rel="prefetch" href="/assets/js/8.62c01479.js"><link rel="prefetch" href="/assets/js/9.62355ca7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2ebaa67f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目錄" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo512.png" alt="Louis Li's Blog" class="logo"> <span class="site-name can-hide">Louis Li's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>Louis Li</h3> <span>努力畢業的菸酒生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首頁</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分類</a></div><div class="nav-item"><a href="/tags/" class="nav-link">標籤</a></div><div class="nav-item"><a href="/archives/" class="nav-link">Archives</a></div> <a href="https://github.com/gamerslouis/gamerslouis.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#linux-tc-介紹" class="sidebar-link">Linux tc 介紹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#ebpf-與-tc" class="sidebar-link">eBPF 與 tc</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#bcc-neighbor-sharing" class="sidebar-link">BCC neighbor_sharing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#介紹" class="sidebar-link">介紹</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#python-實作" class="sidebar-link">python 實作</a></li><li class="sidebar-sub-header level3"><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#ebpf-實作" class="sidebar-link">eBPF 實作</a></li></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#tc-與-xdp-比較" class="sidebar-link">tc 與 XDP 比較</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#direct-action" class="sidebar-link">Direct action</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#clsact" class="sidebar-link">clsact</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/posts/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/#參考資料" class="sidebar-link">參考資料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-12a44dd8><div class="articleInfo" data-v-12a44dd8><!----> <div class="info" data-v-12a44dd8><div title="作者" class="author iconfont icon-touxiang" data-v-12a44dd8><a href="https://github.com/gamerslouis" target="_blank" title="作者" class="beLink" data-v-12a44dd8>Louis</a></div> <div title="創建時間" class="date iconfont icon-riqi" data-v-12a44dd8><a href="javascript:;" data-v-12a44dd8>2022-10-31</a></div> <div title="分類" class="date iconfont icon-wenjian" data-v-12a44dd8><a href="/categories/?category=%E5%AD%B8%E7%BF%92%20eBPF%20%E7%B3%BB%E5%88%97" data-v-12a44dd8>學習 eBPF 系列 </a><a href="/categories/?category=2022%20iThome%E9%90%B5%E4%BA%BA%E8%B3%BD" data-v-12a44dd8>2022 iThome鐵人賽 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目錄</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing<!----></h1>  <div class="theme-vdoing-content content__default"><p>接續前一篇主題   <code>XDP</code> ，今天我們要繼續來聊聊 eBPF 在 linux netowrk data path 上的另外一個進入點   <code>tc</code> ，並同樣以 bcc 的  <a href="https://github.com/iovisor/bcc/blob/master/examples/networking/neighbor_sharing/" target="_blank" rel="noopener noreferrer">neighbor_sharing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  作為範例。</p> <h2 id="linux-tc-介紹"><a href="#linux-tc-介紹" class="header-anchor">#</a> Linux tc 介紹</h2> <p>首先我們要先聊聊   <code>tc</code>   是什麼東西。Traffic Control (tc) 是 linux kernel 網路系統裡面和 netfilter/iptables 同等重要的一個組件。不過 netfilter 主要著重在 packet mangling (封包修改) 和 filter (過濾)。而 tc 的重點是在調控流量，提供限速、整形等功能。</p> <p>tc 的工作時機點分成   <code>ingress tc</code>   和   <code>egress tc</code> ，以   <code>ingress tc</code>   來說，他發生在 skb allocation 之後，進入 netfilter 之前。 <code>ingress tc</code>   主要用於輸入流量控制， <code>egress tc</code>   則用於流量優先級、QoS 的功能。在傳統使用上，tc 更主要是用在   <code>egress tc</code> ， <code>ingress tc</code>   本身有比較大的功能限制。</p> <p>在   <code>tc</code>   裡面有三個主要的概念， <code>qdisc</code> 、 <code>class</code>   和   <code>filter (classifier)</code> 。</p> <p>tc 的基礎是 queue，封包要進出主機時，會先進入 queue，根據特定的策略重新排序、刪除、延遲後再交給網卡送出，或 netfilter 等系統收入。</p> <p><code>qdisc</code>   是套用在這個 queue 上面的策略規則。下列舉例一部份:</p> <ul><li>最基本的策略規則是 pfifo，就是一個簡單的 FIFO queue，只能設定 queue 的可儲存的封包大小和封包個數。</li> <li>更進階的如 pfifo_fast，會根據 ip 封包內的   <code>ToS</code>   欄位將封包分成三個優先度，每個優先度內是走 FIFO 規則，但是會優先清空高優先度的封包。</li> <li><a href="https://man7.org/linux/man-pages/man8/tc-sfq.8.html" target="_blank" rel="noopener noreferrer">sfq<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  則是會根據 tcp/udp/ip 欄位 hash 的結果區分出不同的連線，將不同連線的封包放入獨立的 bucket 內，然後 bucket 間使用輪尋的方式，來讓不同連線均等的輸出。</li> <li>ingress 是專門用在 ingress tc 的 qdisc 上面的 qdisc 都歸為 classless QDisc，因為我們不能透過自定義的方式對流量進行分類，提供不同的策略。</li></ul> <p>與 classless 相反的是 classful qdisc，在 classful qdisc 內，我們可以以定義出多個   <code>class</code> ，針對不同的 class 設定不同的限速策略等規則。也可以將多個 class 附屬在另外一個 class 下，讓子 class 共用一個父 class 的最大總限速規則，但是子分類又獨立有限速規則等等。</p> <p>而要對流量進行分類就會用到   <code>filter</code> , 對於某個 qdisc (classless/classful 皆可) 或著父 class 上的封包，如果滿足 filter 的條件，就可以把封包歸到某個 class 上。除了歸類到某個 class 上，filter 也可以設置為執行某個 action，包括丟棄封包、複製封包流量到另外一個網路介面上之類的…</p> <p>對於 qdisc 和 class 在建立時需指定或自動分配一個在網卡上唯一的 handle 作為識別 id，格式是   <code>&lt;major&gt;:&lt;minor&gt;</code> (數字)，對於 qdisc 來說只有 major 的部分   <code>&lt;major&gt;:</code> ，對 class 來說 major 必須與對應 qdisc 相同。</p> <p>另外在 egress pipeline 可以有多個 qdisc，其中一個作為 root，其他的藉由 filter 從 root qdisc dispatch 過去，所以需要有 major 這個欄位。</p> <p>在 linux 上面主要透過   <code>tc</code>   這個指令來設置   <code>qdisc</code> 、 <code>class</code>   和   <code>filter</code> 。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#  添加 eth0 egress 的 root qdisc，類型是 htb，後面是 htb 的參數</span>
tc qdisc <span class="token function">add</span> dev enp0s3 root handle <span class="token number">1</span>: htb default <span class="token number">30</span>
<span class="token comment">#  添加 eth 的 ingress qdisc</span>
tc qdisc <span class="token function">add</span> dev enp0s3 ingress

<span class="token comment">#  設置一個 class，速度上下限都是 20mbps，附屬於 eth0 的 root qdisc (1:) 下</span>
tc class <span class="token function">add</span> dev enp0s3 partent <span class="token number">1</span>: classid <span class="token number">1</span>:1 htb rate 20mbit ceil 20mbit

<span class="token comment">#  當封包為 ip, dst port 80 時分類到上述分類</span>
tc filter <span class="token function">add</span> dev enp0s3 protocol <span class="token function">ip</span> parent <span class="token number">1</span>: prio <span class="token number">1</span> u32 match <span class="token function">ip</span> dport <span class="token number">80</span> 0xffff flowid <span class="token number">1</span>:1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#  查看 egress filter</span>
tc filter show dev eth0

<span class="token comment">#  查看 ingress filter</span>
tc filter show dev eth0 ingress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="ebpf-與-tc"><a href="#ebpf-與-tc" class="header-anchor">#</a> eBPF 與 tc</h2> <p>eBPF 在 tc 系統裡面是在   <code>filter</code>   的部分作用，並可分成兩種模式，classifier (BPF_PROG_TYPE_SCHED_CLS) 和 action (BPF_PROG_TYPE_SCHED_ACT)。</p> <ul><li>classifier: 前者分析封包後，決定是否 match，並可以將封包分類給透過 tc 指令預設的 classid 或著重新指定 classid。
<ul><li>0: mismatch</li> <li>1: match, 使用 filter 預設的 classid</li> <li>直接回傳一個 classid</li></ul></li> <li>action: 作為該   <code>filter</code>   的 action，當 tc 設置的 filter 規則 match 後，呼叫 eBPF 程式決定 action 是 drop (2), 執行預設 action (-1) 等。下列是 action 的完整定義</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_UNSPEC</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_OK</span>		<span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_RECLASSIFY</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_SHOT</span>		<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_PIPE</span>		<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_STOLEN</span>		<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_QUEUED</span>		<span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_REPEAT</span>		<span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_REDIRECT</span>		<span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TC_ACT_JUMP</span>		<span class="token expression"><span class="token number">0x10000000</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="bcc-neighbor-sharing"><a href="#bcc-neighbor-sharing" class="header-anchor">#</a> BCC neighbor_sharing</h2> <h3 id="介紹"><a href="#介紹" class="header-anchor">#</a> 介紹</h3> <p>這次要看的是   <code>examples/networking/neighbor_sharing</code> 。(<a href="https://github.com/iovisor/bcc/blob/master/examples/networking/neighbor_sharing/" target="_blank" rel="noopener noreferrer">原始碼<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p> <p>這次的 eBPF 程式會提供 QoS 的服務，對經過某張網卡的針對往特定的 IP 提供不同的限速群組。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>                         /------------\                        |
neigh1 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |                        |
neigh2 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|    &amp;lt;-128kb-|        /------\        |
neigh3 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |  wan0  | wan  |        |
         | ^             |   br100    |-&amp;lt;-&amp;lt;-&amp;lt;--| sim  |        |
         | clsfy_neigh () |            |   ^    \------/        |
lan1 ----|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|    &amp;lt;--1Mb--|   |                    |
lan2 ----|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |   classify_wan ()       |
           ^             \------------/                        |
           pass ()                                              |
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上圖是 neighbor_sharing 自帶的網路拓譜圖，neight1-3, lan1-2, wan0 是獨立的 network namespace 擁有獨立的 IP，neighbor_sharing 會在 wansim 到 br100 的介面上建立   <code>ingress tc</code> ，針對 neigh1-3 的 IP 提供總共 128kb/s 的網路速度，對其他 IP 提供總共 1024kb/s 的網路速度。</p> <p>首先在測試之前要先安裝 pyroute2 和 netperf，前者是 python 接接 tc 指令的 library，後者是用來測試網速的工具。另外要記得設置防火牆規則不然 br100 不會轉發封包</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>pip3 <span class="token function">install</span> pyroute2
<span class="token function">apt</span> <span class="token function">install</span> netperf
iptables <span class="token parameter variable">-P</span> FORWARD ACCEPT
<span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">net.ipv4.ip_forward</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>neight1-3 會被分配 172.16.1.100-102 的 IP, lan 則是 172.16.1.150-151。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> wan0 netperf <span class="token parameter variable">-H</span> <span class="token number">172.16</span>.1.100 <span class="token parameter variable">-l</span> <span class="token number">2</span> <span class="token parameter variable">-k</span>
MIGRATED TCP STREAM TEST from <span class="token number">0.0</span>.0.0 <span class="token punctuation">(</span><span class="token number">0.0</span>.0.0<span class="token punctuation">)</span> port <span class="token number">0</span> AF_INET to <span class="token number">172.16</span>.1.100 <span class="token punctuation">(</span><span class="token punctuation">)</span> port <span class="token number">0</span> AF_INET <span class="token builtin class-name">:</span> demo
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    <span class="token number">10</span>^6bits/sec

 <span class="token number">131072</span>  <span class="token number">16384</span>  <span class="token number">16384</span>    <span class="token number">6.00</span>      <span class="token number">161.45</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>透過 netperf 可以測出來到 neight1 的封包流量被限制在約 161.45 kbits/sec。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> wan0 netperf <span class="token parameter variable">-H</span> <span class="token number">172.16</span>.1.150 <span class="token parameter variable">-l</span> <span class="token number">2</span> <span class="token parameter variable">-f</span> k
MIGRATED TCP STREAM TEST from <span class="token number">0.0</span>.0.0 <span class="token punctuation">(</span><span class="token number">0.0</span>.0.0<span class="token punctuation">)</span> port <span class="token number">0</span> AF_INET to <span class="token number">172.16</span>.1.150 <span class="token punctuation">(</span><span class="token punctuation">)</span> port <span class="token number">0</span> AF_INET <span class="token builtin class-name">:</span> demo
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    <span class="token number">10</span>^3bits/sec

<span class="token number">131072</span>  <span class="token number">16384</span>  <span class="token number">16384</span>    <span class="token number">2.67</span>     <span class="token number">1065.83</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>而到 lan1 大約是 1065.83kbits/sec，接近預先設置的規則。</p> <h3 id="python-實作"><a href="#python-實作" class="header-anchor">#</a> python 實作</h3> <p>這次會先看 python 的程式碼，由於這次的程式碼包含大量用來建立測試環境的部分，所以會跳過只看相關的內容。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>b <span class="token operator">=</span> BPF <span class="token punctuation">(</span>src_file<span class="token operator">=</span><span class="token string">&quot;tc_neighbor_sharing.c&quot;</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

wan_fn <span class="token operator">=</span> b<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;classify_wan&quot;</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SCHED_CLS<span class="token punctuation">)</span>
pass_fn <span class="token operator">=</span> b<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;pass&quot;</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SCHED_CLS<span class="token punctuation">)</span>
neighbor_fn <span class="token operator">=</span> b<span class="token punctuation">.</span>load_func <span class="token punctuation">(</span><span class="token string">&quot;classify_neighbor&quot;</span><span class="token punctuation">,</span> BPF<span class="token punctuation">.</span>SCHED_CLS<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>首先這次的 eBPF 程式包含三個部分，因此會分別載入，並且全部都是 classifier (BPF_PROG_TYPE_SCHED_CLS)</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>ipr<span class="token punctuation">.</span>tc <span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ingress&quot;</span><span class="token punctuation">,</span> wan_if <span class="token punctuation">[</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;ffff:&quot;</span><span class="token punctuation">)</span>
ipr<span class="token punctuation">.</span>tc <span class="token punctuation">(</span><span class="token string">&quot;add-filter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bpf&quot;</span><span class="token punctuation">,</span> wan_if <span class="token punctuation">[</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;:1&quot;</span><span class="token punctuation">,</span> fd<span class="token operator">=</span>wan_fn<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>
	   prio<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>wan_fn<span class="token punctuation">.</span>name<span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token string">&quot;ffff:&quot;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&quot;drop&quot;</span><span class="token punctuation">,</span>
	   classid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token string">&quot;128kbit&quot;</span><span class="token punctuation">,</span> burst<span class="token operator">=</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> mtu<span class="token operator">=</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
ipr<span class="token punctuation">.</span>tc <span class="token punctuation">(</span><span class="token string">&quot;add-filter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bpf&quot;</span><span class="token punctuation">,</span> wan_if <span class="token punctuation">[</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;:2&quot;</span><span class="token punctuation">,</span> fd<span class="token operator">=</span>pass_fn<span class="token punctuation">.</span>fd<span class="token punctuation">,</span>
	   prio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span>pass_fn<span class="token punctuation">.</span>name<span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token string">&quot;ffff:&quot;</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">&quot;drop&quot;</span><span class="token punctuation">,</span>
	   classid<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token string">&quot;1024kbit&quot;</span><span class="token punctuation">,</span> burst<span class="token operator">=</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> mtu<span class="token operator">=</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接著會建立 wan_if 的 ingress qdisc (wan_if 是 wan0 接到 br100 的介面)，並且會 ingress qdisc 下建立兩條 filter，首先它的 type 指定為 bpf 並透過   <code>fd=wan_fn.fd</code>   選定 eBPF program，所以會交由 eBPF classifier 來決定是不是要 match。</p> <blockquote><p>classifier match 後就會執行下屬的 policing action，跟 classid 無關，且在這次的範例中並不存在 class，所以 classid 其實是無意義的，不一定要設置。</p></blockquote> <p>後半段   <code>action=&quot;drop&quot;, rate=&quot;128kbit&quot;, burst=1024 * 32, mtu=16 * 1024</code>   定義了一條 policing action，只有當封包滿足 policy 條件時才會觸發具體的 action，這邊指定是流量超出 128kbit 時執行 drop，也就達到了限制 neigh 流量的效果。</p> <p>第二條同理，match pass_fn 並且流量到達 1024kbit 時執行 drop，由於 pass_fn 顧名思義是無條件 match 的意思，所以等價於所有非 neigh 的流量共用這一條的 1024kbit 流量限制。</p> <p>因此總結來說，eBPF 程式 wan_fn 透過某種方式判斷封包是否是往 neigh 的 ip，是的話就 match 第一條 filter 執行 policing action 來限流，不然就 match 第二條 filter 來做限流。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>ret <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_ns <span class="token punctuation">(</span><span class="token string">&quot;neighbor% d&quot;</span> <span class="token operator">%</span> i<span class="token punctuation">,</span> ipaddr<span class="token operator">=</span>ipaddr<span class="token punctuation">,</span>
                                  fn<span class="token operator">=</span>neighbor_fn<span class="token punctuation">,</span> cmd<span class="token operator">=</span>cmd<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接著就會看到，在建立 neigh1-3 的 namespace 時，attach 了 neighbor_fn 到網卡上，因此就很好理解了 neighbor_fn 監聽了從 neigh 發出的封包，解析拿到 neigh 的 IP 後，透過 map share 給 wan_fn，讓 wan_fn 可以根據 ip 決定要不要 match 第一條 policing action。</p> <h3 id="ebpf-實作"><a href="#ebpf-實作" class="header-anchor">#</a> eBPF 實作</h3> <p>到這裡其實就分析出整個程式的執行邏輯了，我們接續來看看 neighbor_sharing 的 eBPF 程式，這次的 eBPF 程式分成三個部分，首先是接在每個 neigh ingress 方向的 classify_neighbor，接著是接在 wan0 ingress 方向的 classify_wan 和 pass。</p> <p>前面說到出來   <code>classify_neighbor</code>   要做的事情就是紀錄 neigh1-3 的 IP，提供給   <code>classify_wan</code>   判斷是否要 match 封包，執行 128kbits 的流量限制。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ipkey</span> <span class="token punctuation">{</span>
  u32 client_ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">BPF_HASH</span> <span class="token punctuation">(</span>learned_ips<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ipkey</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>首先定義了一個 hash map 用 key 來儲存所有 neigh 的 IP</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">classify_neighbor</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  ethernet<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ethernet<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ETH_P_IP<span class="token operator">:</span> <span class="token keyword">goto</span> ip<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">goto</span> EOP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ip<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_t</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32 sip <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>src<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipkey</span> key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>client_ip<span class="token operator">=</span>sip<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    learned_ips<span class="token punctuation">.</span><span class="token function">insert</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> EOP<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
EOP<span class="token operator">:</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>接著   <code>classify_neighbor</code>   就會用 cursor 解析出 source ip，將其作為 hash map 的 key 放到 learned_ips 裡面，value 則都設為 1。不論如何都會 return 1 放行封包。雖然其實這是 neighbor ingress 方向上唯一的一條 filter，所以不論回傳值為多少其實都可以，不影響執行結果。</p> <blockquote><p>這邊就要提到第一次學習 tc 還有 classifier 時會感到很困惑的地方了，首先 classifier 的回傳值 0 表示 mismatch, 1 表示 match 並轉移到預設的 class，其餘回傳值表示直接指定 classid 為回傳的數值。接著不論 classid 是多少，都會執行 filter 上面綁定的 action。在這次的範例中，所有的 filter 其實都不存在任何的 class，因此 return 值唯一的意義是控制是否要執行 action。這邊 classify_neighbor 綁定的 action 是 ok，表示放行封包的意思</p></blockquote> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">classify_wan</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  u8 <span class="token operator">*</span>cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  ethernet<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ethernet_t</span> <span class="token operator">*</span>ethernet <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ethernet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ethernet<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ETH_P_IP<span class="token operator">:</span> <span class="token keyword">goto</span> ip<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">goto</span> EOP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ip<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_t</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token function">cursor_advance</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u32 dip <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>dst<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipkey</span> key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>client_ip<span class="token operator">=</span>dip<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>val <span class="token operator">=</span> learned_ips<span class="token punctuation">.</span><span class="token function">lookup</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> EOP<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
EOP<span class="token operator">:</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>接著看到   <code>classify_wan</code> ，他會提取封包的 dst ip address，並嘗試搜尋 learned_ips，如果找的到就表示這個是 neighbor 的 ip，回傳 map 對應的 value，前面提到所有的 value 都會設置為 1，因此表示 match 的意思，不然就跳轉到 EOP 回傳 0，表示 mismatch。同樣由於這邊不存在 class，因此 value 只要是非 0 即可，只是用來 match 執行 policing action。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pass</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最後的   <code>pass</code>   其實就是一條無條件回傳 1 表示 match，來執行 wan0 方向第二條 1024kbits/sec 的限流政策用的。</p> <h2 id="tc-與-xdp-比較"><a href="#tc-與-xdp-比較" class="header-anchor">#</a> tc 與 XDP 比較</h2> <p>在 eBPF 裡面，XDP 和 TC 兩個功能常常被拿來一起討輪，前面有提到 eBPF 可以做為 tc actions 使用來達到封包過濾之類的效果，雖然實行效果上是比不上 XDP 的，但是 tc ingress 的 eBPF hook point 也在 kernel data path 的最早期，因此也能夠提供不錯的效能，加上 tc ebpf program 的 context 是   <code>sk_buff</code> ，相較於   <code>xdp_buff</code> ，可以直接透過   <code>__sk_buff</code>   取得和修改更多的 meta data，加上 tc 在 ingress 和 egress 方向都有 hook point，不像 XDP 只能作用在 ingress 方向，且 tc 完全不需要驅動支援即可工作，因此 tc 在使用彈性和靈活度上是比 XDP 更占優的。</p> <blockquote><p>不過 tc 其實也有提供 offload 的功能，將 eBPF 程式 offload 到網卡上面執行。</p></blockquote> <h2 id="direct-action"><a href="#direct-action" class="header-anchor">#</a> Direct action</h2> <p>然而由於 tc 的 hook point 分成 classifier 和 action 因此無法透過單一個 eBPF 程式做到 match-action 的效果，然而大多數時候 eBPF tc 程式的開發並不是要利用 tc 系統的功能做限速等功能，而是要利用 tc 在 kernel path 極早期這點做 packet mangling 和 filter 等事項，再加上 tc 系統的使用學習難度相對高，因此 eBPC 在 tc 後引入了  <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=045efa82ff563cd4e656ca1c2e354fa5bf6bbda4" target="_blank" rel="noopener noreferrer">direct-action<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  和  <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=1f211a1b929c804100e138c5d3d656992cfd5622" target="_blank" rel="noopener noreferrer">clsact<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  這兩個功能。</p> <p>首先介紹 direct-action (da)，這個是在 classifier (BPF_PROG_TYPE_SCHED_CLS) 可啟用的一個選項，如果啟用 da，classifier 的回傳值就變成是 action，和 BPF_PROG_TYPE_SCHED_ACT 相同，而原本的 classid 改成設置__skb_buff-&gt;tc_classid 來傳輸。</p> <blockquote><p>在 kernel code 內使用 prog-&gt;exts_integrated 標示是否啟用 da 功能</p></blockquote> <p>透過 da 可以透過單一個 eBPF 程式完成 classifier 和 action 的功能，降低了 tc hook point 對原本 tc 系統框架的依賴，能夠透過 eBPF 程式簡潔的完成功能。</p> <p>在 da 的使用上可以參考 bcc 的範例   <code>examples/networking/tc_perf_event.py</code> ，使用上與普通的 classifer 幾乎無異，只要在載入時   <code>ipr.tc (&quot;add-filter&quot;,&quot;bpf&quot;, me,&quot;:1&quot;, fd=fn.fd, ... ,direct_action=True)</code>   加上 direct_action 選項即可。</p> <p>透過 tc 指令查看時也可以看到   <code>direct-action</code>   字樣。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>tc filter show dev t1a
filter parent <span class="token number">1</span>: protocol all pref <span class="token number">49152</span> bpf chain <span class="token number">0</span>
filter parent <span class="token number">1</span>: protocol all pref <span class="token number">49152</span> bpf chain <span class="token number">0</span> handle 0x1 flowid :1 hello direct-action not_in_hw <span class="token function">id</span> <span class="token number">308</span> tag 57cd311f2e27366b jited
	action order <span class="token number">1</span>: gact action pass
	 random <span class="token builtin class-name">type</span> none pass val <span class="token number">0</span>
	 index <span class="token number">2</span> ref <span class="token number">1</span> <span class="token builtin class-name">bind</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="clsact"><a href="#clsact" class="header-anchor">#</a> clsact</h2> <p>後來 tc 加入了 clsact，clsact 是一個專為 eBPF 設計的偽 qdisc。首先 clsact 同時作用在 ingress 和 egress 方向，也進一步簡化了 ebpf 程式的掛載。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>tc qdisc <span class="token function">add</span> dev em1 clsact
tc filter <span class="token function">add</span> dev em1 ingress bpf da obj tc-example.o sec ingress
tc filter <span class="token function">add</span> dev em1 egress bpf da obj tc-example.o sec egress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同時 clsact 工作在真的 qdisc 本身的 lock 之前，因此可以避免 lock 的開銷，預先完成比較複雜繁重的封包分類，在進入到真的 queue filter 時只根據更簡單的欄位 (如 tc_index) 做分類。另外 da 本來只能使用在 ingress 方向，透過 clsact，da 可以工作在 egress 方向。</p> <p>關於 eBPF tc 的部分就大致上介紹到這裡，對於 tc 這個子系統相對來說是真的蠻陌生的，因此介紹這個部分的確是有比較大的難度和說不清楚的地方。</p> <h2 id="參考資料"><a href="#參考資料" class="header-anchor">#</a> 參考資料</h2> <ul><li><a href="https://tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.qdisc.filters.html" target="_blank" rel="noopener noreferrer">Classifying packets with filters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://man7.org/linux/man-pages/man8/tc.8.html" target="_blank" rel="noopener noreferrer">tc man page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://arthurchiao.art/blog/lartc-qdisc-zh/" target="_blank" rel="noopener noreferrer">用 tc qdisc 管理 Linux 网络带宽<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cloud.tencent.com/developer/article/1409664" target="_blank" rel="noopener noreferrer">TC (Traffic Control) 命令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.aliyun.com/article/4000" target="_blank" rel="noopener noreferrer">Linux TC (Traffic Control) 简介<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=eBPF" title="標簽">#eBPF</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/10/13</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/posts/proxmox-hard-disk-replacement-and-expansion/"><div>
            Proxmox硬碟更換及擴容
            <!----></div></a> <span class="date">08-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/posts/Openstack-Deployment-Serial-3-Basic-Management-Commands/"><div>
            OpenStack 架設系列文章 (3) - 基本指令操作
            <!----></div></a> <span class="date">11-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/Solve-Openstack-vm-create-fail/"><div>
            解決 OpenStack  VM 建立失敗問題
            <!----></div></a> <span class="date">11-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:me@louisif.me" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/gamerslouis" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主題">Vdoing</a> 
    | Copyright © 2022-2024
    <span>Louis Li</span></div> <div class="buttons"><div title="返回頂部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去評論" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主題模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟隨係統
        </li><li class="iconfont icon-rijianmoshi">
          淺色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ad93c9f8.js" defer></script><script src="/assets/js/2.2b01b354.js" defer></script><script src="/assets/js/18.a472fde3.js" defer></script>
  </body>
</html>
