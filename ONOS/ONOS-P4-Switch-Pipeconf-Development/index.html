<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ONOS P4 Switch Pipeconf 開發 - Louis Li&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Louis Li&#039;s Blog"><meta name="msapplication-TileImage" content="/img/mylogo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Louis Li&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="這篇文章會介紹一下，在ONOS上P4相關的模組和功能，以及怎麼開發ONOS APP與設置ONOS，讓ONOS可以控制p4 switch的pipeline。"><meta property="og:type" content="blog"><meta property="og:title" content="ONOS P4 Switch Pipeconf 開發"><meta property="og:url" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/"><meta property="og:site_name" content="Louis Li&#039;s Blog"><meta property="og:description" content="這篇文章會介紹一下，在ONOS上P4相關的模組和功能，以及怎麼開發ONOS APP與設置ONOS，讓ONOS可以控制p4 switch的pipeline。"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_Architecture.png"><meta property="og:image" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_FlowRule_Abstract.png"><meta property="og:image" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_P4_Architecture.png"><meta property="og:image" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/P4_PAA_Compare.png"><meta property="og:image" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/p4mn_topo.png"><meta property="article:published_time" content="2022-08-27T16:25:46.000Z"><meta property="article:modified_time" content="2022-08-27T17:40:09.971Z"><meta property="article:author" content="Louis Li"><meta property="article:tag" content="P4"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_Architecture.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/"},"headline":"ONOS P4 Switch Pipeconf 開發","image":["https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_Architecture.png","https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_FlowRule_Abstract.png","https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_P4_Architecture.png","https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/P4_PAA_Compare.png","https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/p4mn_topo.png"],"datePublished":"2022-08-27T16:25:46.000Z","dateModified":"2022-08-27T17:40:09.971Z","author":{"@type":"Person","name":"Louis Li"},"publisher":{"@type":"Organization","name":"Louis Li's Blog","logo":{"@type":"ImageObject","url":"https://blog.louisif.me/img/mylogo.svg"}},"description":"這篇文章會介紹一下，在ONOS上P4相關的模組和功能，以及怎麼開發ONOS APP與設置ONOS，讓ONOS可以控制p4 switch的pipeline。"}</script><link rel="canonical" href="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/"><link rel="alternate" href="/atom.xml" title="Louis Li&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/mylogo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.6.0/styles/atom-one-dark-reasonable.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-79VDS4QY8D" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-79VDS4QY8D');</script><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/archives">Archives</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜尋" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-27T16:25:46.000Z" title="8/28/2022, 12:25:46 AM">2022-08-28</time>發表</span><span class="level-item"><a class="link-muted" href="/categories/ONOS/">ONOS</a></span><span class="level-item">1 小時讀完 (大約7315個字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次訪問</span></div></div><h1 class="title is-3 is-size-4-mobile">ONOS P4 Switch Pipeconf 開發</h1><div class="content"><p> 這篇文章會介紹一下，在 ONOS 上 P4 相關的模組和功能，以及怎麼開發 ONOS APP 與設置 ONOS，讓 ONOS 可以控制 p4 switch 的 pipeline。</p>
<span id="more"></span> 

<h2 id="背景介紹"><a href="# 背景介紹" class="headerlink" title="背景介紹"></a > 背景介紹 </h2><h3 id="P4Runtime"><a href="#P4Runtime" class="headerlink" title="P4Runtime"></a>P4Runtime</h3><p>P4Runtime 是 P4 API Working Group 制定的一套基於 Protobuf 以及 gRPC 的傳輸協定，他可以提供不同的 P4 交換機和不同的 SDN 控制器一套統一的 API 標準，提供控制器直接透過 p4runtime 將編譯出來 p4 pipeline 直接上傳到 p4 switch 上、設置 p4 pipeline 的 table entry 以及接收 packet-in 的封包和 counter 的資訊等功能。</p>
<h3 id="ONOS 架構"><a href="#ONOS 架構" class="headerlink" title="ONOS 架構"></a>ONOS 架構 </h3><p><img src="/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_Architecture.png" alt="ONOS 架構圖"></p>
<p>ONOS 使用分層架構和介面抽象的方式隱藏了底層交換機和和控制協定的具體內容，讓上層的應用可以用統一的 API 來管理網路的行為，因此上層網路可以用完全相同的方式來控制 Openflow switch 及 P4 switch，也可以不用理會各個 switch table 順序和具體規則的下達方式。</p>
<h3 id="ONOS-Flow-programmable"><a href="#ONOS-Flow-programmable" class="headerlink" title="ONOS Flow programmable"></a>ONOS Flow programmable</h3><p><img src="/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_FlowRule_Abstract.png" alt="ONOS FlowRule 抽象架構"></p>
<p > 即便是在北向提供給使用者的 API，ONOS 也對其做了很多層級的抽象，讓使用者可以自由決定要使用哪一個層級的 API。</p>
<p > 在 flow rule 的部分，ONOS 大致上提供了三個層級的抽象，分別是 <code>Flow Rule</code>, <code>Flow Objective</code> 及 <code>Intent</code> ，不論在哪一個層級，我們主要都是要操作兩個集合 <code>Selector</code> 和 <code>Treatment</code></p>
<p><code>Selector</code> 決定了哪些封包受這條 flow rule 管理。一個 <code>Selector</code> 包含了若干個 <code>Criterion</code> ，ONOS 透過 <code>Enum</code> 定義了常用的 Criterion Type，來對應封包的不同欄位，例如 <code>IPV4_SRC</code> , <code>ETH_SRC</code> 等。</p>
<p><code>Treatment</code> 則是 <code>Instruction</code> 的集合，一個 instruction 通常對應到對封包的某個欄位進行修改，或著指定封包在交換機的 output port。</p>
<p > 三個抽象層積的差別在於這兩個集合套用到的對象，在最高層級的 <code>Intent</code> ，我們操作的對象是整個網路流，除了 <code>Selector</code> 和 <code>Treatment</code>，我們還要定義整個網路流在 SDN 網路的入口 (Ingress Point) 和出口 (Egress Point)，ONOS 核心的 <code>Intent Service</code> 會幫我們把一個 <code>Intent</code> 編譯成多個 <code>FlowObjective</code>。</p>
<p > 由於 <code>Intent</code> 操作的是整個網路流，在這個層級定義 Output port 是沒有意義的，但是由於在 ONOS 使用的 JAVA API 是共通的，所以 intent service 會忽略掉這個 instruction，這個在 ONOS 的實作上是很重要的觀念，對 treatment 裡的 instructions，底層的編譯器只會取他可以處理的 instructions 往更底層送，對於不可以處理的 instructions，有些會有 warnning log，有些會直接跳 exception，更有的會直接忽略，因此如果 selector 和 treatment 的執行結果不符合我們的預期，有可能是有些不支援的 instruction 在轉換成交換機可以懂得規則的過程中被忽略的。</p>
<p><code>FlowObjective</code> 操作的對象是一台網路設備 (通常是一台交換機)，同樣我們定義一個 <code>Selector</code> 和 <code>Treatment</code> ，告訴這台交換機我們要處理哪些封包和怎麼處理。</p>
<p > 最底下到了 Flow Rule 這個層級，Flow rule 這個層級對象是交換機上的一張 table，因此他加入了 table id 這個欄位。一個 < code>FlowObjective</code > 可能會包含多個不同的 instruction，例如我們要修改封包的 mac address，修改 ip 的 ttl 欄位，同時也要決定這個封包的 output port，這些 instruction 在 flow objective 層級可以包含在一個 treatment 內，但是在實際的交換機上這些 instruction 可能分別屬於不同的 table，因此一個 flow objective 會需要對應到一條或多條得 flow rule，這依據底下交換機的不同、傳輸協定的不同而不同，因此 ONOS 引入了 <code>Pipeliner</code> ，Driver 可以實作 <code>Pipeliner</code> 的介面，讓 ONOS 知道如何把 flow objective 轉換成 flow rules。</p>
<h3 id="P4-in-ONOS"><a href="#P4-in-ONOS" class="headerlink" title="P4 in ONOS"></a>P4 in ONOS</h3><p><img src="/ONOS/ONOS-P4-Switch-Pipeconf-Development/ONOS_P4_Architecture.png" alt="ONOS P4 南向介面架構"></p>
<p > 上圖是 p4 在 ONOS 南向架構上的組件 </p>
<p > 在 Protocol layer 由 <code>P4Runtime</code> 組件實作 p4runtime procotol，維護 switch 的連線和具體的 gRPC&#x2F;Protobuf 傳輸內容 </p>
<p > 接著是 Driver layer，不同的 p4 switch 在 pipeline 的結構等方面存在差異，因此在 ONOS 設定交換機資訊時要根據不同的 Switch 選擇 driver</p>
<ul>
<li > 如果是 bmv2 switch 使用 <code>org.onosproject.bmv2</code>，如果是 tofino 交換機使用 <code>org.onosproject.barefoot</code></li>
</ul>
<p > 最上面是 ONOS 核心，這邊有 translation services 和 pipeconf 架構。p4 交換機的特色是能透過 p4lang 定義出完全不同的 pipeline，在使用 ONOS 控制 p4 switch 的時候，我們就需要針對 pipeline 定義註冊 <code>pipeconf</code>，ONOS 核心可以調用 pipeconf 將 flow objective 或 flow rule 的 flow rule 轉換成真正可以下達到 p4 pipeline table 上的 entry。<br > 在 ONOS 核心定義的這套 pipeconf 及轉換架構被稱之為 Pipeline Independent (PI) framework，因此 ONOS 相關的 class 和 interface 都會有一個 PI 的前綴。</p>
<p><img src="/ONOS/ONOS-P4-Switch-Pipeconf-Development/P4_PAA_Compare.png" alt="P4 FlowRule 設置流程"></p>
<p > 另外就要提到 Pipeline-agnostic APP 和 Pipeline-aware APP 的差別，這邊指的都是北向介面上面處理網路邏輯的 APP，差別在於 Pipeline-agnostic app 完全不考慮底下的 pipeline，因此通常操作的是 flow objective，而 pipeline aware app 必須知道底層 pipeline 的架構，直接產出特定的 flow rule。</p>
<p > 開發 Pipeline-agnostic APP 的好處是他足夠抽象因此可以應用在各種不同的交換機和網路，但是我們就需要額外實作 pipeliner 等編譯器來做轉換，因此直接如果只針對單一 pipeline 的情況下，直接開發 pipeline aware app 會比較簡單。</p>
<h2 id="Pipeconf - 開發"><a href="#Pipeconf - 開發" class="headerlink" title="Pipeconf 開發"></a>Pipeconf 開發 </h2><p > 在使用 ONOS 控制 p4 switch 時，最基本要做的就是撰寫 pipeline 對應的 pipeconf。一個完整的 Pipeconf 會包含 </p>
<ul>
<li><p > 從 p4 compiler 拿到 pipeline 資訊檔案，p4info, bmv2 json, Tofino binary….</p>
</li>
<li><p>PipeconfLoader: 一個 pipeconf 的進入點，向 PiPipeconfService 註冊一個或多個 pipeconf，定義 pipeconf 的 id, 對應的 interpreter, pipeliner, p4info 檔案路徑等資訊。</p>
</li>
<li><p>Interpreter: 主要負責兩件事 </p>
<ul>
<li > 提供 ONOS 核心資訊並協助將 common flow rule 轉換成 protocol independent flow rule，包含了 table id 的 mapping, 欄位名稱和數值的轉換等 </li>
<li > 處理 packet-in&#x2F;packet-out 的封包，當封包從 p4 switch packet-in 到 controller 時，會把 metadata (input port 等資訊) 當作 packet 的一個 header 附加在 packet 中，一起送到 controller，pipeconf 需要解析封包，將封包資訊提取出來。當封包 packet-out 時，同樣需要 metadata 轉換成 pipeline 定義的 packet-out header，附加在封包內送至交換機，pipeline parser 才能重新將資訊解析出來處理。</li>
</ul>
</li>
<li><p>Pipeliner: 負責將 flow objective 轉換成 flow rule</p>
</li>
</ul>
<p > 但是 Interpreter 和 Pipeliner 的功能是不一定要實作的，如果對應的功能沒有被實作，那北向的 APP 就只能呼叫比較底層的 API 而無法調動 flow objective 等功能。</p>
<h3 id="開發目標"><a href="# 開發目標" class="headerlink" title="開發目標"></a > 開發目標 </h3><p > 下面會用一個非常簡單的 p4 pipeline 作為範例，我們預期要實作一個基本的 Layer 2 switch pipeline，使 ProxyARP APP 和 Reactive Forwarding APP 能夠正常的運作。(使用 bmv2 和 ONOS v2.7.0 開發)</p>
<h3 id="建立 ONOS-APP"><a href="# 建立 ONOS-APP" class="headerlink" title="建立 ONOS APP"></a > 建立 ONOS APP</h3><p > 跟任何其他 ONOS 模組一樣，pipeconf 可以作為一個獨立的 ONOS APP 開發，再安裝到 ONOS 上，所以首先建立我們的 <code>simepleswitch</code> APP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">onos-create-app<br>Define value for property &#x27;groupId&#x27;: me.louisif.pipelines<br>Define value for property &#x27;artifactId&#x27;: simpleswitch<br>Define value for property &#x27;version&#x27; 1.0-SNAPSHOT: :<br>Define value for property &#x27;package&#x27; me.louisif: : me.louisif.pipelines.simpleswitch<br></code></pre></td></tr></table></figure>

<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><p > 在 pipeconf 的開發中，使用到 p4 相關的 api 並沒有被包含在 onos 標準 api 內，需要額外加入 p4runtime-model 這個 dependency。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.onosproject<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>onos-protocols-p4runtime-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;onos.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p > 另外可以在 onos 的 dependency app 列表內加入 pipeline 對應的 driver，這樣啟動 pipeconf 時就會自動啟用相關的 driver app，而不用事前手動啟動。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">onos.app.requires</span>&gt;</span>org.onosproject.drivers.bmv2<span class="hljs-tag">&lt;/<span class="hljs-name">onos.app.requires</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="P4 - 撰寫"><a href="#P4 - 撰寫" class="headerlink" title="P4 撰寫"></a>P4 撰寫 </h3><p > 接著撰寫我們的 p4 檔案，路徑是 src&#x2F;main&#x2F;resource&#x2F;simpleswitch.p4。resource 資料夾在編譯的時候會被附加到編譯出來的 oar 裡面，所以可以直接在 ONOS 執行的時候存取到編譯出來的 p4info 等檔案。完整的檔案在 <a target="_blank" rel="noopener" href="https://github.com/gamerslouis/onos-p4-tutorial">github</a > 上。</p>
<p > 在 simpleswitch 的 ingress pipeline 內只包含一張 table0，用於 L2 的 packet forwarding，使用 send 這個 action 來將封包丟到指定的 output port，在 bmv2 switch 會定義一個 cpu port，當 egress_port 為該 port number 時，封包就會被送至 ONOS，因此 send_to_cpu 這個 action 只單純做 set egress port 這個動作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c">control <span class="hljs-title function_">table0_control</span><span class="hljs-params">(inout <span class="hljs-type">headers_t</span> hdr,</span><br><span class="hljs-params">                inout <span class="hljs-type">local_metadata_t</span> local_metadata,</span><br><span class="hljs-params">                inout <span class="hljs-type">standard_metadata_t</span> standard_metadata)</span> &#123;<br>    action <span class="hljs-title function_">send</span><span class="hljs-params">(<span class="hljs-type">port_t</span> port)</span> &#123;<br>        standard_metadata.egress_spec = port;<br>    &#125;<br><br>    action <span class="hljs-title function_">send_to_cpu</span><span class="hljs-params">()</span> &#123;<br>        standard_metadata.egress_spec = CPU_PORT;<br>    &#125;<br><br>    action <span class="hljs-title function_">drop</span><span class="hljs-params">()</span> &#123;<br>        mark_to_drop (standard_metadata);<br>    &#125;<br><br>    table table0 &#123;<br>        key = &#123;<br>            standard_metadata.ingress_port : ternary;<br>            hdr.ethernet.src_addr          : ternary;<br>            hdr.ethernet.dst_addr          : ternary;<br>            hdr.ethernet.ether_type        : ternary;<br>        &#125;<br><br>        actions = &#123;<br>            send;<br>            send_to_cpu;<br>            drop;<br>        &#125;<br>        default_action = drop;<br>        size = <span class="hljs-number">512</span>;<br>    &#125;<br><br>    apply &#123;<br>        table0.apply ();<br>    &#125;<br>&#125;<br>control <span class="hljs-title function_">MyIngress</span><span class="hljs-params">(inout <span class="hljs-type">headers_t</span> hdr,</span><br><span class="hljs-params">                  inout <span class="hljs-type">local_metadata_t</span> meta,</span><br><span class="hljs-params">                  inout <span class="hljs-type">standard_metadata_t</span> standard_metadata)</span> &#123;<br>    apply &#123;<br>        <span class="hljs-comment">// 這個後面在介紹 </span><br>        <span class="hljs-comment">//if (standard_metadata.ingress_port == CPU_PORT) &#123;</span><br>        <span class="hljs-comment">//    standard_metadata.egress_spec = hdr.packet_out.egress_port;</span><br>        <span class="hljs-comment">//    hdr.packet_out.setInvalid ();</span><br>        <span class="hljs-comment">//    exit;</span><br>        <span class="hljs-comment">// &#125; else &#123;</span><br>            table0_control.apply (hdr, meta, standard_metadata);<br>        <span class="hljs-comment">// &#125;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="P4 - 編譯"><a href="#P4 - 編譯" class="headerlink" title="P4 編譯"></a>P4 編譯 </h3><p > 編譯 bmv2 pipeline 可以直接複製 ONOS 內建的 basic pipeline 使用的 <a target="_blank" rel="noopener" href="https://github.com/opennetworkinglab/onos/tree/master/pipelines/basic/src/main/resources"> 編譯腳本 </a>，將 Makefile 和 bmv2-compile.sh 這兩個檔案複製到 resources 資料夾下，然後修改 Makefile 把 basic 改成 simpleswitch，並刪除 int pipeline。可以簡單下 <code>make</code> 來完成 pipeline 的編譯。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile">ROOT_DIR:=<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> dirname $(<span class="hljs-built_in">realpath</span> $(<span class="hljs-built_in">firstword</span> <span class="hljs-variable">$(MAKEFILE_LIST)</span>)</span>))/..<br><br><span class="hljs-section">all: p4 constants</span><br><br><span class="hljs-section">p4: simpleswitch.p4</span><br>        @./bmv2-compile.sh <span class="hljs-string">&quot;simpleswitch&quot;</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-section">constants:</span><br>        docker run -v <span class="hljs-variable">$(ONOS_ROOT)</span>:/onos -w /onos/tools/dev/bin \<br>                -v <span class="hljs-variable">$(ROOT_DIR)</span>:/source \<br>                --entrypoint ./onos-gen-p4-constants opennetworking/p4mn:stable \<br>                -o /source/java/me/louisif/pipelines/simpleswitch/SimpleswitchConstants.java \<br>                simpleswitch /source/resources/p4c-out/bmv2/simpleswitch_p4info.txt<br><br><span class="hljs-section">clean:</span><br>        rm -rf p4c-out/bmv2/*<br></code></pre></td></tr></table></figure>

<p > 這個 makefile 主要分為兩個部分。p4 會呼叫 bmv2-compile，編譯出 bmv2 的 p4info 和描述 pipeline 的 json 檔案。constants 則會使用 p4mn 這個 container 生成出一個 SimpleswitchConstants.java 的檔案，這個檔案會把 pipeline 所有 table 名稱、欄位、action 名稱列舉出來，方便 pipeconf 的程式碼直接調用，以 table0 來說，它的完整名稱為 <code>MyIngress.table0_control.table0</code> ，可以使用 MY_INGRESS_TABLE0_CONTROL_TABLE0 變數來代表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">PiTableId</span> <span class="hljs-variable">MY_INGRESS_TABLE0_CONTROL_TABLE0</span> <span class="hljs-operator">=</span><br>            PiTableId.of (<span class="hljs-string">&quot;MyIngress.table0_control.table0&quot;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="最小可執行 Pipeconf"><a href="# 最小可執行 Pipeconf" class="headerlink" title="最小可執行 Pipeconf"></a > 最小可執行 Pipeconf</h2><h3 id="撰寫 - PipeconfLoader"><a href="# 撰寫 - PipeconfLoader" class="headerlink" title="撰寫 PipeconfLoader"></a><strong><strong > 撰寫 PipeconfLoader</strong></strong></h3><p > 接著我們要先寫一個最小可以動的 pipeconf，只包含 PipeconfLoader.java 這個檔案，路徑是 src&#x2F;main&#x2F;java&#x2F;me&#x2F;louisif&#x2F;simpleswitch&#x2F;PipeconfLoader.java，前文提到 PipeconfLoader 的工作是向 <code>PipeconfService</code> 註冊 pipeconf 的資訊，因此我們幫 PipeconfLoader 加上 <code>Component</code> 的 Annotation，讓 activate function 在 APP 啟動時被呼叫，接著在 activate function 裡面去註冊 pipeconf。</p>
<p > 以我們的例子而言，我們使用的是 bmv2 的 pipeline，所以我們可以這樣寫 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">URL</span> <span class="hljs-variable">jsonUrl</span> <span class="hljs-operator">=</span> PipeconfLoader.class.getResource (<span class="hljs-string">&quot;/p4c-out/bmv2/simpleswitch.json&quot;</span>);<br><span class="hljs-keyword">final</span> <span class="hljs-type">URL</span> <span class="hljs-variable">p4InfoUrl</span> <span class="hljs-operator">=</span> PipeconfLoader.class.getResource (<span class="hljs-string">&quot;/p4c-out/bmv2/simpleswitch_p4info.txt&quot;</span>);<br><br><span class="hljs-type">PiPipeconf</span> <span class="hljs-variable">pipeconf</span> <span class="hljs-operator">=</span> DefaultPiPipeconf.builder ()<br>        .withId (PIPECONF_ID)<br>        .withPipelineModel (P4InfoParser.parse (p4InfoUrl))<br>        .addExtension (P4_INFO_TEXT, p4InfoUrl)<br>        .addExtension (BMV2_JSON, jsonUrl)<br>        .build ();<br>piPipeconfService.register (pipeconf);<br></code></pre></td></tr></table></figure>

<p > 檔案路徑要填寫相對於 resource 這個資料夾的路徑，另外 <code>addExtension</code> 的內容會根據 switch 的不同而不同，如果我們今天使用的是 tonifo 的 pipeline 那就要改成 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">URL</span> <span class="hljs-variable">binUrl</span> <span class="hljs-operator">=</span> PipeconfLoader.class.getResource (<span class="hljs-string">&quot;/p4c-out/tofino.bin&quot;</span>);<br><span class="hljs-keyword">final</span> <span class="hljs-type">URL</span> <span class="hljs-variable">p4InfoUrl</span> <span class="hljs-operator">=</span> PipeconfLoader.class.getResource (<span class="hljs-string">&quot;/p4c-out/p4info.txt&quot;</span>);<br><span class="hljs-keyword">final</span> <span class="hljs-type">URL</span> <span class="hljs-variable">contextJsonUrl</span> <span class="hljs-operator">=</span> PipeconfLoader.class.getResource (<span class="hljs-string">&quot;/p4c-out/context.json&quot;</span>);<br><br>DefaultPiPipeconf.builder ()<br>                .withId (PIPECONF_ID)<br>                .withPipelineModel (parseP4Info (p4InfoUrl))<br>								.addExtension (P4_INFO_TEXT, p4InfoUrl)<br>                .addExtension (TOFINO_BIN, binUrl)<br>                .addExtension (TOFINO_CONTEXT_JSON, contextJsonUrl)<br>                .build ();<br>piPipeconfService.register (pipeconf);<br></code></pre></td></tr></table></figure>

<h3 id="測試"><a href="# 測試" class="headerlink" title="測試"></a > 測試 </h3><p > 完成 PipeconfLoader.java 就構成了一個可以運作的 pipeconf，為了測試我們使用 opennetworking&#x2F;p4mn 這個 container 來實驗，p4mn 是一個 mininet 的 docker image，可以很簡單的啟動一個 mininet 的測試拓譜，並使用 bmv2 switch 取代 mininet 原本使用的 openflow switch。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">docker run -v /tmp/p4mn:/tmp --privileged --rm -it -p <span class="hljs-number">50001</span>:<span class="hljs-number">50001</span> opennetworking/p4mn:stable<br></code></pre></td></tr></table></figure>

<p > 使用這個指令可以啟動一個包含一個叫做 bmv2-s1 的 bmv2 switch 和兩個 host</p>
<p><img src="/ONOS/ONOS-P4-Switch-Pipeconf-Development/p4mn_topo.png" alt="P4mn 拓譜"></p>
<p > 同時會生成一個 onos 的 netcfg 檔案，路徑 &#x2F;tmp&#x2F;p4mn&#x2F;bmv2-s1-netcfg.json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;devices&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;device:bmv2:s1&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;ports&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;1&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;s1-eth1&quot;</span>,<br>                    <span class="hljs-string">&quot;speed&quot;</span>: <span class="hljs-number">10000</span>,<br>                    <span class="hljs-string">&quot;enabled&quot;</span>: <span class="hljs-literal">true</span>,<br>                    <span class="hljs-string">&quot;number&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;removed&quot;</span>: <span class="hljs-literal">false</span>,<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;copper&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;2&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;s1-eth2&quot;</span>,<br>                    <span class="hljs-string">&quot;speed&quot;</span>: <span class="hljs-number">10000</span>,<br>                    <span class="hljs-string">&quot;enabled&quot;</span>: <span class="hljs-literal">true</span>,<br>                    <span class="hljs-string">&quot;number&quot;</span>: <span class="hljs-number">2</span>,<br>                    <span class="hljs-string">&quot;removed&quot;</span>: <span class="hljs-literal">false</span>,<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;copper&quot;</span><br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&quot;basic&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;managementAddress&quot;</span>: <span class="hljs-string">&quot;grpc://localhost:50001?device_id=1&quot;</span>,<br>                <span class="hljs-string">&quot;driver&quot;</span>: <span class="hljs-string">&quot;bmv2&quot;</span>,<br>                <span class="hljs-string">&quot;pipeconf&quot;</span>: <span class="hljs-string">&quot;me.louisif.pipelines.simpleswitch&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 這個檔案包含了 ONOS P4 需要的所有資訊，主要分為兩個部分，ports 定義了這個交換機所有的 port 資訊。basic 部分，managementAddress 是 ONOS 用來使用 p4runtime 連線到 switch 的路徑，pipeconf 指定了這個 switch 使用的 pipeconf，預設會是 org.onosproject.pipelines.basic，在我們的範例中需要改為 me.louisif.pipelines.simpleswitch。</p>
<p > 只要將 me.louisif.pipelines.simpleswitch 的 app 啟用，並上傳 bmv2-s1-netcfg.json，ONOS 就可以成功連線到這個 bmv2 switch，並正常提供北向的 APP 服務了。</p>
<h3 id="如何下 flow-rule"><a href="# 如何下 flow-rule" class="headerlink" title="如何下 flow rule"></a > 如何下 flow rule</h3><p > 完成 pipeconf 後，我們就可以透過下 flow rule 的方式來讓 switch 工作了，為了要讓 h1 和 h2 能夠互相溝通，最簡單的方法就是將所有 port 1 進來的封包送到 port 2、所有從 port 2 進來的封包送到 port 1。</p>
<p > 為此我們需要兩條 table0 的 entry，分別是 </p>
<ul>
<li>standard_metadata.ingress_port &#x3D;&#x3D; 1 (mask 0x1ff) → send port&#x3D;2</li>
<li>standard_metadata.ingress_port &#x3D;&#x3D; 2 (mask 0x1ff) → send port&#x3D;1</li>
</ul>
<p > 由於 standard_metadata.ingress_port 這個 key 是 ternary，因此我們需要包含 mask, port 這個 type 的長度是 9 bits，因為要完全一致，所以 mask 是 0x1ff。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> PiCriterion.<span class="hljs-type">Builder</span> <span class="hljs-variable">criterionBuilder</span> <span class="hljs-operator">=</span> PiCriterion.builder ()<br>                .matchTernary (PiMatchFieldId.of (<span class="hljs-string">&quot;standard_metadata.ingress_port&quot;</span>), inPortNumber.toLong (), <span class="hljs-number">0x1ff</span>);<br><span class="hljs-keyword">final</span> <span class="hljs-type">PiAction</span> <span class="hljs-variable">piAction</span> <span class="hljs-operator">=</span> PiAction.builder ().withId (PiActionId.of (<span class="hljs-string">&quot;MyIngress.table0_control.send&quot;</span>))<br>        .withParameter (<span class="hljs-keyword">new</span> <span class="hljs-title class_">PiActionParam</span>(PiActionParamId.of (<span class="hljs-string">&quot;port&quot;</span>), outPortNumber.toLong ()))<br>        .build ();<br><span class="hljs-keyword">final</span> <span class="hljs-type">FlowRule</span> <span class="hljs-variable">flowRule</span> <span class="hljs-operator">=</span> DefaultFlowRule.builder ()<br>        .fromApp (coreService.getAppId (APP_NAME))<br>        .forDevice (deviceId)<br>        .forTable (PiTableId.of (<span class="hljs-string">&quot;MyIngress.table0_control.table0&quot;</span>)).makePermanent ().withPriority (<span class="hljs-number">65535</span>)<br>        .withSelector (DefaultTrafficSelector.builder ().matchPi (criterionBuilder.build ()).build ())<br>        .withTreatment (DefaultTrafficTreatment.builder ().piTableAction (piAction).build ()).build ();<br>flowRuleService.applyFlowRules (flowRule);<br></code></pre></td></tr></table></figure>

<p > 我們可以透過這樣的方式來下達第一條 table entry，可以發現和平常的 flow entry 不一樣的地方是 table id 使用的是 PiTableId 這個 type，並指定了 table0 的完整 id <code>MyIngress.table0_control.table0</code>，另外 <code>Selector</code> 和 <code>Treatment</code> 分別使用了 matchPi 和 piTableAction 這兩個特別的函數。</p>
<p > 我們這邊將只使用 PiTableId, PiCriterion 和 PiAction 定義的 flow rule 稱之為 PI flow rule，PI flow rule 是 onos 的 p4runtime 可以直接處理的 flow rule，所有的欄位名稱都唯一對應到 p4 pipeline 的某個欄位，前面提到這些 PiTableId, PiMatchFieldId 等都會在 SimpleswitchConstants.java 內被定義，因此可以直接使用來縮短程式碼長度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> me.louisif.pipelines.simpleswitch.SimpleswitchConstants.*;<br><br><span class="hljs-keyword">final</span> PiCriterion.<span class="hljs-type">Builder</span> <span class="hljs-variable">criterionBuilder</span> <span class="hljs-operator">=</span> PiCriterion.builder ()<br>                .matchTernary (INGRESS_PORT, inPortNumber.toLong (), <span class="hljs-number">0x1ff</span>);<br><span class="hljs-keyword">final</span> <span class="hljs-type">PiAction</span> <span class="hljs-variable">piAction</span> <span class="hljs-operator">=</span> PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND)<br>        .withParameter (PORT, outPortNumber.toLong ()))<br>        .build ();<br><span class="hljs-keyword">final</span> <span class="hljs-type">FlowRule</span> <span class="hljs-variable">flowRule</span> <span class="hljs-operator">=</span> DefaultFlowRule.builder ()<br>        .fromApp (coreService.getAppId (APP_NAME))<br>        .forDevice (deviceId)<br>        .forTable (MY_INGRESS_TABLE0_CONTROL_TABLE0).makePermanent ().withPriority (<span class="hljs-number">65535</span>)<br>        .withSelector (DefaultTrafficSelector.builder ().matchPi (criterionBuilder.build ()).build ())<br>        .withTreatment (DefaultTrafficTreatment.builder ().piTableAction (piAction).build ()).build ();<br>flowRuleService.applyFlowRules (flowRule);<br></code></pre></td></tr></table></figure>

<blockquote>
<p > 在範例程式碼裡面包含了簡單的 cli 指令實作，因此可以在 ONOS CLI 使用 <code>add-pi-flow-rule &lt;device id&gt; &lt;input port&gt; &lt;output port&gt;</code > 的方式來下達上面的 flow rule。詳情可以參考檔案。</p>
</blockquote>
<p > 當然這樣編寫出來的 flow rule 會產生一個問題，如果相同的 pipeline，我們希望能從 bmv2 移植到 tonifo 上面去使用，由於欄位的名稱會存在差異，因此所有下達 flow rule 的 APP 都需要重新寫，顯然這樣不是一個很好的做法，增加了程式碼維護上的困難，因此 ONOS 加入前面提到的 Interpreter 還有 translator 機制，下一節會介紹如何為 pipeline 編寫 Interpreter 還有用比較通用的方法來下 flow rule，在完成 interpreter 後上述的 flow rule，可以用下面這個我們比較熟悉的方法來下達。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TABLE0_TABLE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">final</span> <span class="hljs-type">FlowRule</span> <span class="hljs-variable">flowRule</span> <span class="hljs-operator">=</span> DefaultFlowRule.builder ()<br>  .fromApp (coreService.getAppId (APP_NAME))<br>  .forDevice (deviceId)<br>  .forTable (TABLE0_TABLE_ID).makePermanent ().withPriority (<span class="hljs-number">65535</span>)<br>  .withSelector (DefaultTrafficSelector.builder ().matchInPort (inPortNumber).build ())<br>  .withTreatment (DefaultTrafficTreatment.builder ().setOutput (outPortNumber).build ())<br>  .build ();<br><br>flowRuleService.applyFlowRules (flowRule);<br></code></pre></td></tr></table></figure>

<h2 id="撰寫 - Interpreter"><a href="# 撰寫 - Interpreter" class="headerlink" title="撰寫 Interpreter"></a > 撰寫 Interpreter</h2><p > 在前一節我們完成了基本的 pipeconf 註冊，並使用 PI flow rule 的方式來控制交換機，但是直接使用 PI flow rule 會降低 APP 的彈性，使移植到不同 pipeline 的困難度提高。另外 SDN 的一個特色是可以使用 packet-in&#x2F;packet-out 的方式來讓 controller 即時性的處理封包，因此本結會介紹如何實作 Interpreter 來提供 packet-in&#x2F;packet-out，以及 flow rule translation 的功能。</p>
<p > 要提供一個 pipeline interpreter，我們需要實作 PiPipelineInterpreter 這個介面，要注意的是 Interpreter class 需要繼承 AbstractHandlerBehaviour，然後再 PipeconfLoader 去指定這個實作 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSwitchInterpreterImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandlerBehaviour</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PiPipelineInterpreter</span> &#123;<br>&#125;<br><br><span class="hljs-type">PiPipeconf</span> <span class="hljs-variable">pipeconf</span> <span class="hljs-operator">=</span> DefaultPiPipeconf.builder ()<br>        .withId (PIPECONF_ID)<br>        .withPipelineModel (P4InfoParser.parse (p4InfoUrl))<br>				.addBehaviour (PiPipelineInterpreter.class, SimpleSwitchInterpreterImpl.class)<br>        .addExtension (P4_INFO_TEXT, p4InfoUrl)<br>        .addExtension (BMV2_JSON, jsonUrl)<br>        .build ();<br></code></pre></td></tr></table></figure>

<p > 當一條 flow rule 被加入到 ONOS 時，PI framework 會將其翻譯成 PI flow rule，也就是將非 PI * 的欄位轉換成 PI flow rule 的欄位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">FlowRule</span> <span class="hljs-variable">flowRule</span> <span class="hljs-operator">=</span> DefaultFlowRule.builder ()<br>  .forTable (<span class="hljs-number">0</span>)<br>	.withSelector (DefaultTrafficSelector.builder ().matchInPort (inPortNumber).build ())<br>  .withTreatment (DefaultTrafficTreatment.builder ().setOutput (outPortNumber).build ())<br>  .build ();<br><br></code></pre></td></tr></table></figure>

<h3 id="Table-Id-translation"><a href="#Table-Id-translation" class="headerlink" title="Table Id translation"></a>Table Id translation</h3><p > 以前面提到的 port 1 送到 port 2 的 flow rule 來示範，我們需要把 table id 0，轉換成 <code>PiTableId.of (&quot;MyIngress.table0_control.table0&quot;)</code> ，這對應到 Interpreter 的 mapFlowRuleTableId 函數，我們可以定義一個 map 來記錄，table index 跟 Pi table id 之間的關係，然後實作 mapFlowRuleTableId。這邊的 id 0 並不具有特定的意義，只是單純我們 interpreter 定義的 table index，因此當 APP 使用時，需要知道這個 index 對應到的 table 具體是什麼功能，當然通常我們會再加上一層 pipeliner，透過 flow objective 來隱藏 table id 的細節。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Integer, PiTableId&gt; TABLE_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmutableMap</span>.Builder&lt;Integer, PiTableId&gt;()<br>	    .put (<span class="hljs-number">0</span>, MY_INGRESS_TABLE0_CONTROL_TABLE0)<br>	    .build ();<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Optional&lt;PiTableId&gt; <span class="hljs-title function_">mapFlowRuleTableId</span><span class="hljs-params">(<span class="hljs-type">int</span> flowRuleTableId)</span> &#123;<br>    <span class="hljs-keyword">return</span> Optional.ofNullable (TABLE_MAP.get (flowRuleTableId));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Selector-Translation"><a href="#Selector-Translation" class="headerlink" title="Selector Translation"></a>Selector Translation</h3><p > 我們通常使用 <code>DefaultTrafficSelector.builder</code> 來定義 Selector。 <code>matchInPort</code> 會在 selector 內加入一個 <code>PortCriterion</code> ，他的 criterion tpye 是 <code>Criterion.Type.IN_PORT</code> ，為此 Interpreter 需要根據 Criterion type，將其轉換成 p4 table 對應的 key，同樣我們使用 map 的方式來維護其關係。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Criterion.Type, PiMatchFieldId&gt; CRITERION_MAP =<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmutableMap</span>.Builder&lt;Criterion.Type, PiMatchFieldId&gt;()<br>          .put (Criterion.Type.IN_PORT, HDR_STANDARD_METADATA_INGRESS_PORT)<br>          .put (Criterion.Type.ETH_SRC, HDR_HDR_ETHERNET_SRC_ADDR)<br>          .put (Criterion.Type.ETH_DST, HDR_HDR_ETHERNET_DST_ADDR)<br>          .put (Criterion.Type.ETH_TYPE, HDR_HDR_ETHERNET_ETHER_TYPE)<br>          .build ();<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Optional&lt;PiMatchFieldId&gt; <span class="hljs-title function_">mapCriterionType</span><span class="hljs-params">(Criterion.Type type)</span> &#123;<br>    <span class="hljs-keyword">return</span> Optional.ofNullable (CRITERION_MAP.get (type));<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 可能有些人會有些疑惑說，p4 table key 可能會是 exact 或是 ternary，那 ONOS 要怎麼把 <code>matchInPort</code> 轉換成 ternary mask 0x1ff </p>
<p > 前面提到在註冊 pipeconf 時，我們透過 <code>.withPipelineModel (P4InfoParser.parse (p4InfoUrl))</code> 載入 p4info (在 ONOS 內稱之為 <code>PiPipelineModel</code>)，每個 key 具體的類型和資料長度會包含在 p4info 內，PI framework 在轉換時會根據不同 criterion type 和 key type 的不同和需求自動做轉換。</p>
<h3 id="Treatment-Translation"><a href="#Treatment-Translation" class="headerlink" title="Treatment Translation"></a>Treatment Translation</h3><p > 不像 table id 和 criterion，在 p4 內，每個 action 是一個可帶參數的 function，和 ONOS 定義的 treatment 不存在簡單的對應關係，因此 interpreter 定義了 mapTreatment，輸入是 treatment 和 table id，輸出是 PiAction，讓 interpreter 完整的處理整個 treatment。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PiAction <span class="hljs-title function_">mapTreatment</span><span class="hljs-params">(TrafficTreatment treatment, PiTableId piTableId)</span> <span class="hljs-keyword">throws</span> PiInterpreterException &#123;<br>    <span class="hljs-comment">// 檢查 table id 是否有效，由於只有 table0 一張 table，因此這邊直接檢查 table id 是不是 table 0</span><br>		<span class="hljs-keyword">if</span> (!piTableId.equals (MY_INGRESS_TABLE0_CONTROL_TABLE0)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PiInterpreterException</span>(<span class="hljs-string">&quot;Unsupported table id: &quot;</span> + piTableId);<br>    &#125;<br>    <span class="hljs-comment">// 我們的 pipeline 只支援 set output port 一個 instruction</span><br>    <span class="hljs-keyword">if</span> (treatment.allInstructions ().size () != <span class="hljs-number">1</span> ||<br>            !treatment.allInstructions ().get (<span class="hljs-number">0</span>).type ().equals (Instruction.Type.OUTPUT)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PiInterpreterException</span>(<span class="hljs-string">&quot;Only output instruction is supported&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">PortNumber</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> ((Instructions.OutputInstruction) treatment.allInstructions ().get (<span class="hljs-number">0</span>)).port ();<br>    <br>    <span class="hljs-comment">// 像 controller、flooding 這些特別的 port，稱之為 Logical port</span><br>    <span class="hljs-keyword">if</span> (port.isLogical ()) &#123;<br>        <span class="hljs-keyword">if</span> (port.exactlyEquals (PortNumber.CONTROLLER)) &#123;<br>            <span class="hljs-comment">// 我們支援使用 send_to_controller 這個 action 將封包送到 ONOS</span><br>            <span class="hljs-keyword">return</span> PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND_TO_CPU)<br>                    .build ();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PiInterpreterException</span>(<span class="hljs-string">&quot;Unsupported logical port: &quot;</span> + port);<br>        &#125;<br>    &#125;<br>    <br>    一般的使用用 send 這個 action 來傳送封包 < br>    <span class="hljs-keyword">return</span> PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND)<br>            .withParameter (<span class="hljs-keyword">new</span> <span class="hljs-title class_">PiActionParam</span>(PORT, port.toLong ()))<br>            .build ();<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 到此我們已經完成了 flow rule 的轉換，可以使用 ONOS 標準的 flow rule 來操作 pipeline 了。</p>
<blockquote>
<p > 如果希望對轉換機制有更詳細的瞭解可以查看 <a target="_blank" rel="noopener" href="https://github.com/opennetworkinglab/onos/blob/master/core/net/src/main/java/org/onosproject/net/pi/impl/PiFlowRuleTranslatorImpl.java">ONOS 原始碼 </a></p>
</blockquote>
<h3 id="Packet-in-x2F-Packet-out"><a href="#Packet-in-x2F-Packet-out" class="headerlink" title="Packet-in&#x2F;Packet-out"></a>Packet-in&#x2F;Packet-out</h3><p>Interpreter 另外一個重要的功能是使 pipeline 支援 packet-in&#x2F;packet-out 的功能。為此我們需要先修改我們的 p4 pipeline。</p>
<p > 首先我們會先加入兩個特別的 header，並使用 controller_header anotation 標記，<code>@controller_header (&quot;packet_in&quot;)</code> 來得知這個 packet_in_header_t 對應的是 packet-in 時，附加在這個封包的 meta data，通常會定義 ingress port 來表示封包的 input port。同樣的 packet_out_header_t 是 packet-out 時，ONOS 送來 pipeline 處理的 meta data</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@controller_header (&quot;packet_in&quot;)</span><br>header packet_in_header_t &#123;<br>    bit&lt;<span class="hljs-number">7</span>&gt; _padding;<br>    bit&lt;<span class="hljs-number">9</span>&gt; ingress_port;<br>&#125;<br><br><span class="hljs-meta">@controller_header (&quot;packet_out&quot;)</span><br>header packet_out_header_t &#123;<br>    bit&lt;<span class="hljs-number">7</span>&gt; _padding;<br>    bit&lt;<span class="hljs-number">9</span>&gt; egress_port;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 接著我們要修改 header、parser，從 ONOS packet out 出來的封包對 p4 交換機來說相當於從特定一個 port 送進來的封包，因此一樣會經過整個 pipeline</p>
<blockquote>
<p > 以 bmv2 來說，controller 的 port number 可以自由指定，在我們使用的 p4mn container 內這個 port 被定義成 255，為此我們在 pipeline 的 p4 檔案內定義了 CPU_PORT 巨集為 255</p>
</blockquote>
<p > 我們將 packet-in&#x2F;packet-out header 加入到 headers 內，當 packet-out 時，packet_out 會在封包的開頭，因此在 parser 的 start state，我們先根據 ingress port 是不是 CPU_PORT 來決定是不是要 parse packet_out header。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">struct headers_t &#123;<br>    packet_in_header_t packet_in;<br>    packet_out_header_t packet_out;<br>    ethernet_h ethernet;<br>&#125;<br><br>parser <span class="hljs-title function_">MyParser</span><span class="hljs-params">(packet_in packet,</span><br><span class="hljs-params">                out headers_t hdr,</span><br><span class="hljs-params">                inout local_metadata_t meta,</span><br><span class="hljs-params">                inout standard_metadata_t standard_metadata)</span> &#123;<br><br>    state start &#123;<br>        transition <span class="hljs-title function_">select</span><span class="hljs-params">(standard_metadata.ingress_port)</span> &#123;<br>            CPU_PORT: parse_packet_out;<br>            <span class="hljs-keyword">default</span>: parse_ethernet;<br>        &#125;<br>    &#125;<br><br>    state parse_packet_out &#123;<br>        packet.extract (hdr.packet_out);<br>        transition parse_ethernet;<br>    &#125;<br><br>    state parse_ethernet &#123;<br>        packet.extract (hdr.ethernet);<br>        transition accept;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 在 Ingress 部分，如果是 packet-out packet，我們沒有必要讓他經過整個 ingress pipeline，為此我們直接將 egress_spec 設置為 packet_out header 內的 egress_port，然後直接呼叫 exit。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">control <span class="hljs-title function_">MyIngress</span><span class="hljs-params">(inout headers_t hdr,</span><br><span class="hljs-params">                  inout local_metadata_t meta,</span><br><span class="hljs-params">                  inout standard_metadata_t standard_metadata)</span> &#123;<br>    apply &#123;<br>        <span class="hljs-keyword">if</span> (standard_metadata.ingress_port == CPU_PORT) &#123;<br>            standard_metadata.egress_spec = hdr.packet_out.egress_port;<br>            hdr.packet_out.setInvalid ();<br>            exit;<br>        &#125;<br>        table0_control.apply (hdr, meta, standard_metadata);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 我們的 table0 則加入了 send_to_cpu 這個 action，做的事情就是把 egress_spec 設定成 CPU port。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">control <span class="hljs-title function_">table0_control</span><span class="hljs-params">(inout headers_t hdr,</span><br><span class="hljs-params">                inout local_metadata_t local_metadata,</span><br><span class="hljs-params">                inout standard_metadata_t standard_metadata)</span> &#123;<br>    action <span class="hljs-title function_">send_to_cpu</span><span class="hljs-params">()</span> &#123;<br>        standard_metadata.egress_spec = CPU_PORT;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 當封包要 packet-in 到 ONOS 時，需要將 packet-in header 設為 valid，並填入對應的資料，這個部分會再 Egress pipeline 完成 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">control <span class="hljs-title function_">MyEgress</span><span class="hljs-params">(inout headers_t hdr,</span><br><span class="hljs-params">                 inout local_metadata_t meta,</span><br><span class="hljs-params">                 inout standard_metadata_t standard_metadata)</span> &#123;<br>    apply &#123;<br>        <span class="hljs-keyword">if</span> (standard_metadata.egress_port == CPU_PORT) &#123;<br>            hdr.packet_in.setValid ();<br>            hdr.packet_in.ingress_port = standard_metadata.ingress_port;<br>            hdr.packet_in._padding = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 最後為了讓 packet-in header 能後被傳到 ONOS，需要再 deparser 加入該 header，注意 packet-out header 是為了讓 pipeline 能夠根據該 header 來處理 pecket-out header 用的，因此他不應該被加入到 deparser。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">control <span class="hljs-title function_">MyDeparser</span><span class="hljs-params">(packet_out packet, in headers_t hdr)</span> &#123;<br>    apply &#123;<br>        packet.emit (hdr.packet_in);<br>        packet.emit (hdr.ethernet);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 接著回到我們的 interpreter，在 interpreter 內定義了兩個函數 mapInboundPacket 和 mapOutboundPacket，分別對應 packet-in 和 packet-out 封包的處理。先前我們在 p4 pipeline 定義了 packet_in 和 packet_out 的 header，這兩個函數最基本的功能是讀取和寫入這兩個 header 的資訊。由於這兩個函數的功能相對固定，因此可以直接從 ONOS 的 <a target="_blank" rel="noopener" href="https://github.com/opennetworkinglab/onos/blob/master/pipelines/basic/src/main/java/org/onosproject/pipelines/basic/BasicInterpreterImpl.java">basic pipeline interpreter</a > 複製過來修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Collection&lt;PiPacketOperation&gt; <span class="hljs-title function_">mapOutboundPacket</span><span class="hljs-params">(OutboundPacket packet)</span> <span class="hljs-keyword">throws</span> PiInterpreterException &#123;<br>      <span class="hljs-type">TrafficTreatment</span> <span class="hljs-variable">treatment</span> <span class="hljs-operator">=</span> packet.treatment ();<br><br>      <span class="hljs-comment">// 由於 outbound packet 的內容通常不用在 switch 上在做修改，因此我們只需要取得 </span><br>      <span class="hljs-comment">//set output port 的 instruction</span><br>      <span class="hljs-comment">// 當然如果有特別的功能需求，可以透過修改 pipeline 來支援更多 instruction</span><br>      List&lt;Instructions.OutputInstruction&gt; outInstructions = ...<br><br>      ImmutableList.Builder&lt;PiPacketOperation&gt; builder = ImmutableList.builder ();<br>      <span class="hljs-keyword">for</span> (Instructions.OutputInstruction outInst : outInstructions) &#123;<br>          ...<br>          <span class="hljs-comment">// 這邊透過呼叫 createPiPacketOperation 來填入 packet_out header 的資訊 </span><br>          builder.add (createPiPacketOperation (packet.data (), outInst.port ().toLong ()));<br>          ...<br>      &#125;<br>      <span class="hljs-keyword">return</span> builder.build ();<br>  &#125;<br><br><span class="hljs-keyword">private</span> PiPacketOperation <span class="hljs-title function_">createPiPacketOperation</span><span class="hljs-params">(ByteBuffer data, <span class="hljs-type">long</span> portNumber)</span><br>            <span class="hljs-keyword">throws</span> PiInterpreterException &#123;<br>        <span class="hljs-type">PiPacketMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> createPacketMetadata (portNumber);<br>        <span class="hljs-keyword">return</span> PiPacketOperation.builder ()<br>                .withType (PACKET_OUT)<br>                .withData (copyFrom (data))<br>                .withMetadatas (ImmutableList.of (metadata))<br>                .build ();<br>  &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> InboundPacket <span class="hljs-title function_">mapInboundPacket</span><span class="hljs-params">(PiPacketOperation packetIn, DeviceId deviceId)</span> <span class="hljs-keyword">throws</span> PiInterpreterException &#123;<br>    Ethernet ethPkt;<br>    ...<br>    ethPkt = Ethernet.deserializer ().deserialize (packetIn.data ().asArray (), <span class="hljs-number">0</span>,<br>    ...<br>    <span class="hljs-comment">//packet_in header 的資訊會以 key-value 的方式存在 packetIn.metadatas</span><br>		Optional&lt;PiPacketMetadata&gt; packetMetadata = packetIn.metadatas ()<br>                .stream ().filter (m -&gt; m.id ().equals (INGRESS_PORT))<br>                .findFirst ()<br>    <span class="hljs-comment">// 從中提取出 input port number</span><br>    <span class="hljs-type">ImmutableByteSequence</span> <span class="hljs-variable">portByteSequence</span> <span class="hljs-operator">=</span> packetMetadata.get ().value ();<br>    <span class="hljs-type">short</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> portByteSequence.asReadOnlyBuffer ().getShort ();<br>    <span class="hljs-type">ConnectPoint</span> <span class="hljs-variable">receivedFrom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectPoint</span>(deviceId, PortNumber.portNumber (s));<br>    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">rawData</span> <span class="hljs-operator">=</span> ByteBuffer.wrap (packetIn.data ().asArray ());<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultInboundPacket</span>(receivedFrom, ethPkt, rawData);<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 到此我們已經完成了 interpreter 的實現了，Interpreter 目前還包含 <code>mapLogicalPortNumber</code> 和 <code>getOriginalDefaultAction</code> ，不過基本的 interpreter 不需要實現這兩個功能，所以這邊就不再展開介紹。</p>
<blockquote>
<p > 同樣使用範例程式碼時，可以在 ONOS CLI 使用 <code>add-common-flow-rule &lt;device id&gt; &lt;input port&gt; &lt;output port&gt;</code > 的方式來使用下達 ONOS 標準的 flow rule。詳情可以參考檔案。</p>
</blockquote>
<h2 id="撰寫 - Pipeliner"><a href="# 撰寫 - Pipeliner" class="headerlink" title="撰寫 Pipeliner"></a > 撰寫 Pipeliner</h2><p > 到目前為止我們已經完成了 pipeconf 的基本功能，可以下 flow rule 還有使用 packet-in&#x2F;packet-out 的功能，不過到目前我們還是需要直接使用 flow rule，要知道 table id 對應的功能，為了能夠隱藏 table 的細節還有銜接 ONOS 內建的網路功能 APP，我們需要實作 pipeliner 讓我們的交換機支援 flow objective 的功能。</p>
<p > 和 Interpreter 類似，我們需要實作 <code>Pipeliner</code> 這個介面並繼承 <code>AbstractHandlerBehaviour</code> 然後在 PipeconfLoader 透過 <code>addBehaviour (Pipeliner.class, SimpleSwitchPipeliner.class)</code> 的方式加入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSwitchPipeliner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandlerBehaviour</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Pipeliner</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> getLogger (getClass ());<br><br>    <span class="hljs-keyword">private</span> FlowRuleService flowRuleService;<br>    <span class="hljs-keyword">private</span> DeviceId deviceId;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(DeviceId deviceId, PipelinerContext context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.deviceId = deviceId;<br>        <span class="hljs-built_in">this</span>.flowRuleService = context.directory ().get (FlowRuleService.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 首先我們實作 init 方法，pipeliner 和交換機之間是 1 對 1 的關係，因此當交換機被初始化的時候，可以透過 init 方法取得 device 的 id。context 最主要的部份是使用 directory ().get 方法。平常我們在 APP 開發時是使用 Reference annotation 來取得 onos 的 service，這邊我們可以直接透過 get 方法來取得 service，由於 pipeliner 需要完成 flow ojbective 到 flow rule 的轉換，並直接送到 flow rule service，因此這邊先取得 flow rule service。</p>
<p > 在 ONOS Flow Objective Service 的架構內，其實總共有三種 objective，分別是 forward、filter 和 next，他們都需要透過 pipeliner 來和 ONOS 核心互動，由於我們只想要實作 forwarding objective 的部分，因此 filter 和 next 可以單純回應不支援的錯誤訊息 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">filter</span><span class="hljs-params">(FilteringObjective obj)</span> &#123;<br>    obj.context ().ifPresent (c -&gt; c.onError (obj, ObjectiveError.UNSUPPORTED));<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">next</span><span class="hljs-params">(NextObjective obj)</span> &#123;<br>    obj.context ().ifPresent (c -&gt; c.onError (obj, ObjectiveError.UNSUPPORTED));<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getNextMappings</span><span class="hljs-params">(NextGroup nextGroup)</span> &#123;<br>    <span class="hljs-comment">// We do not use nextObjectives or groups.</span><br>    <span class="hljs-keyword">return</span> Collections.emptyList ();<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 接著就到了我們的主角 forward objective，在實作邏輯上其實與 interpreter 對 treatment 的處理方式類似，forward 方法會取得一個 ForwardingObjective 物件，我們根據 treatment 和 selector 生成出一條或多條 flow rule，然後透過 flow rule service 下放到交換機上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forward</span><span class="hljs-params">(ForwardingObjective obj)</span> &#123;<br>    <span class="hljs-keyword">if</span> (obj.treatment () == <span class="hljs-literal">null</span>) &#123;<br>        obj.context ().ifPresent (c -&gt; c.onError (obj, ObjectiveError.UNSUPPORTED));<br>    &#125;<br><br>    <span class="hljs-comment">// Simply create an equivalent FlowRule for table 0.</span><br>    <span class="hljs-keyword">final</span> FlowRule.<span class="hljs-type">Builder</span> <span class="hljs-variable">ruleBuilder</span> <span class="hljs-operator">=</span> DefaultFlowRule.builder ()<br>            .forTable (MY_INGRESS_TABLE0_CONTROL_TABLE0)<br>            .forDevice (deviceId)<br>            .withSelector (obj.selector ())<br>            .fromApp (obj.appId ())<br>            .withPriority (obj.priority ())<br>            .withTreatment (obj.treatment ());<br><br>    <span class="hljs-keyword">if</span> (obj.permanent ()) &#123;<br>        ruleBuilder.makePermanent ();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ruleBuilder.makeTemporary (obj.timeout ());<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span> (obj.op ()) &#123;<br>        <span class="hljs-keyword">case</span> ADD:<br>            flowRuleService.applyFlowRules (ruleBuilder.build ());<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> REMOVE:<br>            flowRuleService.removeFlowRules (ruleBuilder.build ());<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            log.warn (<span class="hljs-string">&quot;Unknown operation &#123;&#125;&quot;</span>, obj.op ());<br>    &#125;<br><br>    obj.context ().ifPresent (c -&gt; c.onSuccess (obj));<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 最後我們還需要實作 purgeAll，當刪除所有 flow obejctive 的時候，刪除所有的 flow rule，這邊我們只需要簡單呼叫 flow rule service 的 purgeFlowRules 就好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">purgeAll</span><span class="hljs-params">(ApplicationId appId)</span> &#123;<br>    flowRuleService.purgeFlowRules (deviceId, appId);<br>&#125;<br></code></pre></td></tr></table></figure>

<p > 到此我們已經完成了整個 pipeconf 的實作，可以透過 flow objective 的方式來管理交換機並與 ONOS 內建的 APP 整合，因此我們可以透過使用 <code>proxyarp</code> 和 <code>fwd</code> 兩個 APP 來讓我們的交換機能夠正常的工作。</p>
<h2 id="小結"><a href="# 小結" class="headerlink" title="小結"></a > 小結 </h2><p > 以上就是 ONOS P4 Pipeconf 的基本開發教學，使用的範例程式碼在 <a target="_blank" rel="noopener" href="https://github.com/gamerslouis/onos-p4-tutorial">github</a>，如果有遇到任何問題或有說明不清楚的地方，歡迎留言提問，我會盡力為大家解答。</p>
<h2 id="參考資料"><a href="# 參考資料" class="headerlink" title="參考資料"></a > 參考資料 </h2><p><a target="_blank" rel="noopener" href="https://hackmd.io/@cnsrl/onos_p4#% E6%92% B0% E5% AF% AB-Pipeliner">https:&#x2F;&#x2F;hackmd.io&#x2F;@cnsrl&#x2F;onos_p4# 撰寫 - Pipeliner</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.onosproject.org/pages/viewpage.action?pageId=16122675">https://wiki.onosproject.org/pages/viewpage.action?pageId=16122675</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/p4lang/tutorials/blob/master/exercises/basic/solution/basic.p4">https://github.com/p4lang/tutorials/blob/master/exercises/basic/solution/basic.p4</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/opennetworkinglab/onos/tree/master/pipelines/basic/src/main/java/org/onosproject/pipelines/basic">ONOS Basic Pipeline</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>ONOS P4 Switch Pipeconf 開發</p><p><a href="https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/">https://blog.louisif.me/ONOS/ONOS-P4-Switch-Pipeconf-Development/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Louis Li</p></div></div><div class="level-item is-narrow"><div><h6>發表於</h6><p>2022-08-28</p></div></div><div class="level-item is-narrow"><div><h6>更新於</h6><p>2022-08-28</p></div></div><div class="level-item is-narrow"><div><h6>許可協議</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/P4/">P4</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/ONOS/Analyze-why-ONOS-Packet-Processor-Treatment-not-Work/"><span class="level-item">分析 ONOS Packet Processor Treatment 無效之原因</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">評論</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "d640db7e67f69e29145811c2c6300d0d",
            repo: "gamerslouis.github.io",
            owner: "gamerslouis",
            clientID: "cf78daa30b8e9f05c59c",
            clientSecret: "118c8f1c02174173599308284f6f0c39f42a8de6",
            admin: ["gamerslouis"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mylogo.svg" alt="Louis Li"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Louis Li</p><p class="is-size-6 is-block">NYCU CS</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hsinchu, Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分類</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">標籤</p><a href="/tags"><p class="title">1</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/gamerslouis" target="_blank" rel="noopener">追蹤</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/gamerslouis"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Mail" href="mailto:me@louisif.me"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分類</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/ONOS/"><span class="level-start"><span class="level-item">ONOS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-27T16:25:46.000Z">2022-08-28</time></p><p class="title"><a href="/ONOS/ONOS-P4-Switch-Pipeconf-Development/">ONOS P4 Switch Pipeconf 開發</a></p><p class="categories"><a href="/categories/ONOS/">ONOS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-12T03:26:42.000Z">2022-08-12</time></p><p class="title"><a href="/ONOS/Analyze-why-ONOS-Packet-Processor-Treatment-not-Work/">分析 ONOS Packet Processor Treatment 無效之原因</a></p><p class="categories"><a href="/categories/ONOS/">ONOS</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">彙整</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">標籤</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/P4/"><span class="tag">P4</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">文章目錄</h3><ul class="menu-list"><li><a class="level is-mobile" href="#背景介紹"><span class="level-left"><span class="level-item">1</span><span class="level-item"> 背景介紹 </span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#P4Runtime"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">P4Runtime</span></span></a></li><li><a class="level is-mobile" href="#ONOS 架構"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">ONOS 架構 </span></span></a></li><li><a class="level is-mobile" href="#ONOS-Flow-programmable"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">ONOS Flow programmable</span></span></a></li><li><a class="level is-mobile" href="#P4-in-ONOS"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">P4 in ONOS</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Pipeconf - 開發"><span class="level-left"><span class="level-item">2</span><span class="level-item">Pipeconf 開發 </span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#開發目標"><span class="level-left"><span class="level-item">2.1</span><span class="level-item"> 開發目標 </span></span></a></li><li><a class="level is-mobile" href="#建立 ONOS-APP"><span class="level-left"><span class="level-item">2.2</span><span class="level-item"> 建立 ONOS APP</span></span></a></li><li><a class="level is-mobile" href="#pom-xml"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">pom.xml</span></span></a></li><li><a class="level is-mobile" href="#P4 - 撰寫"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">P4 撰寫 </span></span></a></li><li><a class="level is-mobile" href="#P4 - 編譯"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">P4 編譯 </span></span></a></li></ul></li><li><a class="level is-mobile" href="#最小可執行 Pipeconf"><span class="level-left"><span class="level-item">3</span><span class="level-item"> 最小可執行 Pipeconf</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#撰寫 - PipeconfLoader"><span class="level-left"><span class="level-item">3.1</span><span class="level-item"> 撰寫 PipeconfLoader</span></span></a></li><li><a class="level is-mobile" href="#測試"><span class="level-left"><span class="level-item">3.2</span><span class="level-item"> 測試 </span></span></a></li><li><a class="level is-mobile" href="#如何下 flow-rule"><span class="level-left"><span class="level-item">3.3</span><span class="level-item"> 如何下 flow rule</span></span></a></li></ul></li><li><a class="level is-mobile" href="#撰寫 - Interpreter"><span class="level-left"><span class="level-item">4</span><span class="level-item"> 撰寫 Interpreter</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Table-Id-translation"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Table Id translation</span></span></a></li><li><a class="level is-mobile" href="#Selector-Translation"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">Selector Translation</span></span></a></li><li><a class="level is-mobile" href="#Treatment-Translation"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">Treatment Translation</span></span></a></li><li><a class="level is-mobile" href="#Packet-in-x2F-Packet-out"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">Packet-in/Packet-out</span></span></a></li></ul></li><li><a class="level is-mobile" href="#撰寫 - Pipeliner"><span class="level-left"><span class="level-item">5</span><span class="level-item"> 撰寫 Pipeliner</span></span></a></li><li><a class="level is-mobile" href="#小結"><span class="level-left"><span class="level-item">6</span><span class="level-item"> 小結 </span></span></a></li><li><a class="level is-mobile" href="#參考資料"><span class="level-left"><span class="level-item">7</span><span class="level-item"> 參考資料 </span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Louis Li</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>個訪客</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-TW");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到頁首" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此網站使用Cookie來改善您的體驗。",
          dismiss: "知道了！",
          allow: "允許使用Cookie",
          deny: "拒絕",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="請輸入關鍵字..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"請輸入關鍵字...","untitled":"(無標題)","posts":"文章","pages":"頁面","categories":"分類","tags":"標籤"});
        });</script></body></html>