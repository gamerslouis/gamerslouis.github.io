[{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/","section":"","summary":"","title":"","type":"page"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/categories/linux/","section":"åˆ†é¡","summary":"","title":"Linux","type":"categories"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/categories/networking/","section":"åˆ†é¡","summary":"","title":"Networking","type":"categories"},{"content":"åœ¨æ¯”è¼ƒè¤‡é›œçš„ç¶²è·¯æ¶æ§‹åŠä½¿ç”¨å ´æ™¯ä¸­ï¼Œæˆ‘å€‘å¯èƒ½æœƒéœ€è¦æ›´ç²¾ç´°åœ°æ§åˆ¶ç¶²è·¯å°åŒ…çš„èµ°å‘ï¼Œä¾‹å¦‚è®“ç‰¹å®šçš„ä¾†æº IP ä½å€èµ°æŒ‡å®šçš„ç¶²è·¯å‡ºå£ï¼Œæˆ–æ˜¯è¨­å®š VPN é€£ç·šï¼Œè®“éƒ¨åˆ†æµé‡é€šé VPN é€šé“ï¼Œå…¶é¤˜æµé‡å‰‡èµ°é è¨­é–˜é“ã€‚å–®ç´”ä¾è³´ä¸€å¼µè·¯ç”±è¡¨æœƒæ¯”è¼ƒé›£éˆæ´»åœ°å¯¦ç¾é€™äº›éœ€æ±‚ã€‚\nå¹¸é‹çš„æ˜¯ï¼ŒLinux æ ¸å¿ƒæä¾›äº†å¼·å¤§çš„è·¯ç”±ç­–ç•¥ (Routing Policy) æ©Ÿåˆ¶ï¼Œå…è¨±æˆ‘å€‘å»ºç«‹å¤šå¼µè·¯ç”±è¡¨ (routing table)ï¼Œä¸¦é€éè¦å‰‡ (rule) ä¾†æ±ºå®šåœ¨ä»€éº¼æ¢ä»¶ä¸‹è¦ä½¿ç”¨å“ªä¸€å¼µè·¯ç”±è¡¨ã€‚é€™ç¯‡æ–‡ç« ï¼Œæˆ‘å€‘å°‡å¾å¤§å®¶ç†Ÿæ‚‰çš„Â ip routeÂ æŒ‡ä»¤é–‹å§‹ï¼Œä¸€æ­¥æ­¥æ·±å…¥äº†è§£ Linux å¤šé‡è·¯ç”±è¡¨èˆ‡è·¯ç”±ç­–ç•¥çš„é‹ä½œåŸç†ï¼Œæœ€çµ‚æŒæ¡å¦‚ä½•é‹ç”¨é€™äº›å·¥å…·ä¾†æ‰“é€ æ›´å…·å½ˆæ€§çš„ç¶²è·¯ç’°å¢ƒã€‚\nè¤‡ç¿’è·¯ç”±è¡¨åŸºç¤ # é¦–å…ˆï¼Œè®“æˆ‘å€‘å¾æœ€åŸºæœ¬çš„Â ip routeÂ æŒ‡ä»¤çœ‹èµ·ï¼Œé€™å€‹æŒ‡ä»¤èƒ½é¡¯ç¤ºå‡º Linux é è¨­çš„è·¯ç”±è¡¨ã€‚\n$ ip route default via 192.168.5.2 dev eth0 proto dhcp src 192.168.5.1 metric 200 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown 192.168.5.0/24 dev eth0 proto kernel scope link src 192.168.5.1 metric 200 192.168.5.2 dev eth0 proto dhcp scope link src 192.168.5.1 metric 200 é¦–å…ˆçœ‹ç¬¬äºŒæ¢è·¯ç”±ï¼Œ172.17.0.0/16 dev docker0 ...ï¼Œé€™æ˜¯ä¸€å€‹åœ¨åŒä¸€å€‹ L2 ç¶²åŸŸçš„æœ¬åœ°è·¯ç”±ï¼š\n172.17.0.0/16ï¼šé€™æ˜¯ç›®çš„åœ°çš„ CIDRã€‚ç•¶ä¸€å€‹å°åŒ…çš„ç›®çš„ IP ä½å€ç¬¦åˆé€™å€‹ç¯„åœæ™‚ï¼Œé€™æ¢è¦å‰‡å°±æœƒè¢«åŒ¹é…ã€‚ dev docker0ï¼šæŒ‡ç¤ºå°åŒ…æ‡‰è©²å¾Â docker0Â é€™å€‹ç¶²è·¯ä»‹é¢é€å‡ºã€‚ proto kernelï¼šä»£è¡¨é€™æ¢è·¯ç”±è¦å‰‡çš„ä¾†æº (protocol)ã€‚ scope linkï¼šä»£è¡¨ç›®æ¨™æ‡‰è™•åœ¨åŒä¸€å€‹ L2 ç¶²åŸŸã€‚ linkdownï¼šè¡¨ç¤ºè©²è·¯ç”±å°æ‡‰çš„ interface è™•æ–¼ down çš„ç‹€æ…‹ï¼Œé€™æ˜¯ docker å»ºç«‹çš„ç‰¹æ®Š interfaceï¼Œå¦‚æœæ˜¯ä¸€èˆ¬çš„ä»‹é¢ï¼Œæ­£å¸¸é‹ä½œçš„ç‹€æ…‹å°±ä¸æœƒé¡¯ç¤ºã€‚ æ¥è‘—ç¬¬ä¸€æ¢ route æ˜¯æˆ‘å€‘çš„ default routeï¼Œæ‰€ä»¥å°±æœƒæœ‰ via é—œéµå­—ä¾†è¡¨ç¤ºä¸‹ä¸€è·³çš„ä½ç½®ï¼Œä¸¦ä¸”ç”¨ src è¡¨ç¤ºå¦‚æœæ˜¯æœ¬æ©Ÿå°åŒ…æ ¹æ“šè©²è·¯ç”±å‡ºå»çš„æ™‚å€™ï¼Œsource ip æ‡‰è©²è¨­ç½®ç‚º192.168.5.1ã€‚\nproto æ¬„ä½ # proto kernelÂ è¡¨ç¤ºé€™æ¢è·¯ç”±æ˜¯ç”± Linux æ ¸å¿ƒè‡ªå‹•ç”¢ç”Ÿçš„ã€‚ä¾‹å¦‚ï¼Œç•¶æˆ‘å€‘ç‚ºæŸå€‹ç¶²è·¯ä»‹é¢è¨­å®š IP ä½å€å’Œå­ç¶²è·¯é®ç½©æ™‚ï¼Œæ ¸å¿ƒå°±æœƒè‡ªå‹•å»ºç«‹ä¸€æ¢å°æ‡‰çš„å€åŸŸç¶²è·¯è·¯ç”±ã€‚\nå¸¸è¦‹çš„é‚„æœ‰Â staticÂ (ç”±ç®¡ç†è€…æ‰‹å‹•éœæ…‹è¨­å®š) å’ŒÂ dhcpÂ (ç”± DHCP client è¨­å®š)ã€‚\nprotoÂ æ¬„ä½æœ¬èº«æ˜¯ä¸€å€‹æ•¸å­—ï¼Œip route æœƒæ ¹æ“šÂ /etc/iproute2/rt_protosÂ é€™å€‹å°ç…§è¡¨ä¾†é¡¯ç¤ºå…¶å°æ‡‰çš„åç¨±ã€‚\n$ cat /etc/iproute2/rt_protos # # Reserved protocols. # 0\tunspec 1\tredirect 2\tkernel 3\tboot 4\tstatic ... 16\tdhcp ... å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘å€‘æ‰‹å‹•ä½¿ç”¨Â ip route addÂ æ–°å¢è·¯ç”±ï¼Œé è¨­çš„Â protoÂ æœƒæ˜¯Â 0 (unspec)ã€‚å¦‚æœå¸Œæœ›æ˜ç¢ºæ¨™ç¤ºç‚ºéœæ…‹è·¯ç”±ï¼Œéœ€è¦é¡å¤–åŠ ä¸ŠÂ proto staticÂ é—œéµå­—ã€‚\nscope æŒ‰ç…§èªªæ˜è¡¨ç¤ºè©² route çš„ä½œç”¨ç¯„åœï¼Œä¸»è¦çš„å€¼æ˜¯ host, link, globalï¼Œhostè¡¨ç¤ºæœ¬æ©Ÿè·¯ç”±ï¼Œlink è¡¨ç¤ºåŒ L2 ç¶²åŸŸï¼Œåœ¨åˆæ­¥è¿½è¹¤ kernel çš„åŸå§‹ç¢¼ï¼Œçœ‹èµ·ä¾†ä¸»è¦æ˜¯åœ¨å»ºç«‹ route çš„æ™‚å€™ï¼Œæœƒæˆç‚º gateway æ˜¯å¦æœ‰æ•ˆçš„ä¸€å€‹åˆ¤æ–·ä¾æ“šï¼Œä½†æ˜¯æŒ‰ç…§æ‰¾åˆ°çš„è³‡è¨Šæ˜¯èªªä¸»è¦æ˜¯ ipv6 æ¯”è¼ƒæœƒæœ‰å½±éŸ¿ï¼Œæ‰€ä»¥å°±ä¸ç´°è¿½äº†ï¼Œç…§ç†ä¾†èªªæœƒè¢«è‡ªå‹•è¨­ç½®æˆåˆé©çš„æ•¸å€¼ï¼Œæ‡‰è©²æ˜¯ä¸å¤ªéœ€è¦ç®¡\nå»ºç«‹å¤šé‡è·¯ç”±è¡¨ # å¯¦éš›ä¸Šï¼ŒLinux é è¨­å°±æ“æœ‰å¤šå¼µè·¯ç”±è¡¨ã€‚æ¯å¼µè·¯ç”±è¡¨æ˜¯ç”±ä¸€å€‹æ•¸å­—ä»£è¡¨ï¼Œç„¶å¾Œæœ‰äº›ç‰¹å®šçš„è¡¨ï¼Œæœ‰æ…£ä¾‹çš„åç¨±ï¼Œæˆ‘å€‘å¯ä»¥é€éÂ /etc/iproute2/rt_tablesÂ æª”æ¡ˆçœ‹åˆ°é€™äº›é è¨­çš„å°æ‡‰é—œä¿‚ã€‚\ncat /etc/iproute2/rt_tables # # reserved values # 255\tlocal 254\tmain 253\tdefault 0\tunspec # # local # #1\tinr.ruhep Linux é è¨­æœ‰ä¸‰å¼µä¸»è¦çš„è·¯ç”±è¡¨ï¼šlocalã€mainÂ å’ŒÂ defaultã€‚\nmainÂ (ID: 254)ï¼šé€™æ˜¯æˆ‘å€‘æœ€å¸¸æ“ä½œçš„è·¯ç”±è¡¨ï¼Œip routeÂ æŒ‡ä»¤é è¨­é¡¯ç¤ºçš„å°±æ˜¯é€™å¼µè¡¨çš„å…§å®¹ã€‚ localÂ (ID: 255)ï¼šé€™å¼µè¡¨ç”±æ ¸å¿ƒè‡ªå‹•ç¶­è­·ï¼Œå­˜æ”¾è‘—æœ¬åœ°ä»‹é¢ä½å€å’Œå»£æ’­ä½å€çš„è·¯ç”±ã€‚æ‰€æœ‰é€å¾€æœ¬æ©Ÿçš„å°åŒ…éƒ½æœƒåœ¨é€™è£¡è¢«åŒ¹é…ï¼Œç¢ºä¿æœ¬æ©Ÿé€šè¨Šçš„æ­£å¸¸é‹ä½œã€‚ defaultÂ (ID: 253)ï¼šé€™å¼µè¡¨é è¨­æ˜¯ç©ºçš„ï¼Œé€šå¸¸ä½œç‚ºä¸€å€‹å‚™ç”¨çš„è·¯ç”±è¡¨ã€‚ æˆ‘å€‘å¯ä»¥é€éÂ ip route show table \u0026lt;table_id/name\u0026gt;Â ä¾†æŸ¥çœ‹ä¸åŒè·¯ç”±è¡¨çš„å…§å®¹ã€‚\n$ ip route show table local local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 ... local 192.168.5.1 dev eth0 proto kernel scope host src 192.168.5.1 å¯ä»¥çœ‹åˆ°ï¼ŒlocalÂ è¡¨ä¸­å­˜æ”¾çš„éƒ½æ˜¯æŒ‡å‘æœ¬æ©ŸÂ loÂ ä»‹é¢æˆ–ç‰¹å®šä»‹é¢è‡ªèº« IP çš„è·¯ç”±ã€‚\næ–°å¢è·¯ç”±è¡¨ # ç•¶æˆ‘å€‘éœ€è¦ä½¿ç”¨è‡ªè¨‚çš„è·¯ç”±è¡¨æ™‚ï¼Œå…¶å¯¦ä¸éœ€è¦ç‰¹åˆ¥ã€Œå»ºç«‹ã€ä¸€å¼µè·¯ç”±è¡¨ï¼Œåªè¦åœ¨å»ºç«‹ route çš„æ™‚å€™çµ¦å®šè·¯ç”±è¡¨çš„ ID å°±å¯ä»¥äº†ã€‚\n# å°‡ä¸€æ¢è·¯ç”±æ–°å¢åˆ° ID ç‚º 123 çš„è·¯ç”±è¡¨ä¸­ ip route add 10.0.0.1 dev eth0 table 123 ç•¶ç„¶ï¼Œå¦‚æœå¸Œæœ›èƒ½å¤ æ›´å¥½ç†è§£è·¯ç”±è¡¨ ID çš„æ„ç¾©ï¼Œä¹Ÿå¯ä»¥å»ä¿®æ”¹Â rt_tablesÂ æª”æ¡ˆï¼Œå¹«è·¯ç”±è¡¨å–ä¸€å€‹åˆ¥åã€‚\nè·¯ç”±ç­–ç•¥ï¼šæ±ºå®šå°åŒ…è©²èµ°å“ªæ¢è·¯ # æ—¢ç„¶æœ‰å¤šå¼µè·¯ç”±è¡¨ï¼Œé‚£éº¼æ ¸å¿ƒæ˜¯å¦‚ä½•æ±ºå®šä¸€å€‹å°åŒ…åˆ°ä¾†æ™‚ï¼Œæ‡‰è©²æŸ¥è©¢å“ªä¸€å¼µè¡¨å‘¢ï¼Ÿé€™å°±æ˜¯è·¯ç”±ç­–ç•¥ (Routing Policy) ç™¼æ®ä½œç”¨çš„åœ°æ–¹ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨Â ip ruleÂ æŒ‡ä»¤ä¾†æŸ¥çœ‹å’Œç®¡ç†å®ƒã€‚\n$ ip rule 0:\tfrom all lookup local 32766:\tfrom all lookup main 32767:\tfrom all lookup default ip ruleÂ çš„è¼¸å‡ºé¡¯ç¤ºäº†ç³»çµ±ä¸­æ‰€æœ‰çš„è·¯ç”±ç­–ç•¥è¦å‰‡ï¼Œæ¯ä¸€æ¢è¦å‰‡éƒ½ç”±ä¸‰å€‹ä¸»è¦éƒ¨åˆ†çµ„æˆï¼š\nå„ªå…ˆç´š (Priority)ï¼šå‰é¢çš„æ•¸å­— (å¦‚Â 0,Â 32766)ã€‚æ ¸å¿ƒæœƒå¾æ•¸å­—æœ€å°çš„è¦å‰‡é–‹å§‹ä¾åºåŒ¹é…ã€‚ é¸æ“‡å™¨ (Selector/Condition)ï¼šä¾‹å¦‚Â from allï¼Œç”¨ä¾†å®šç¾©åŒ¹é…å°åŒ…çš„æ¢ä»¶ã€‚ è¡Œç‚º (Action)ï¼šä¾‹å¦‚Â lookup localï¼ŒæŒ‡ç¤ºåœ¨æ»¿è¶³æ¢ä»¶å¾Œæ‡‰è©²åŸ·è¡Œçš„æ“ä½œï¼Œæœ€å¸¸è¦‹çš„å°±æ˜¯å»æŸ¥è©¢ (lookup) æŸä¸€å¼µè·¯ç”±è¡¨ã€‚ ç•¶ Linux Kernel è¦è·¯ç”±ä¸€å€‹å°åŒ…çš„æ™‚å€™ï¼Œæœƒå¾ priority ä½çš„ policy é–‹å§‹åŒ¹é…ï¼Œå¦‚æœæ»¿è¶³é¸æ“‡å™¨ï¼Œå°±æœƒå»æŸ¥ policy å°æ‡‰çš„é‚£å¼µ routing tableã€‚å¦‚æœ routing table å…§æœ‰ç¬¦åˆçš„è·¯ç”±ï¼Œé‚£ Linux å°±æœƒç›´æ¥ä½¿ç”¨è©²çµæœã€‚å¦‚æœéƒ½ä¸æ»¿è¶³ï¼Œæ‰æœƒå˜—è©¦å»åŒ¹é…ä¸‹ä¸€æ¢ routing policyã€‚\næ ¹æ“šé è¨­çš„è¦å‰‡ï¼Œä¸€å€‹å°åŒ…çš„è·¯ç”±æ±ºç­–æµç¨‹å¦‚ä¸‹ï¼š\nPriority 0ï¼šæŸ¥è©¢Â localÂ è¡¨ã€‚å¦‚æœç›®çš„åœ°æ˜¯æœ¬æ©Ÿ IPï¼Œå°åŒ…æœƒåœ¨é€™è£¡æ‰¾åˆ°åŒ¹é…çš„è·¯ç”±ï¼Œæ±ºç­–éç¨‹çµæŸã€‚ Priority 32766ï¼šå¦‚æœÂ localÂ è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…ï¼Œæ¥è‘—æŸ¥è©¢Â mainÂ è¡¨ã€‚å¤§éƒ¨åˆ†çš„ç¶²è·¯æµé‡ï¼ŒåŒ…æ‹¬èµ°é è¨­é–˜é“ (default gateway)ï¼Œéƒ½æœƒåœ¨é€™å¼µè¡¨è£¡æ‰¾åˆ°å‡ºè·¯ã€‚ Priority 32767ï¼šå¦‚æœÂ mainÂ è¡¨ä¹Ÿæ‰¾ä¸åˆ°åŒ¹é…ï¼Œæœ€å¾ŒæŸ¥è©¢Â defaultÂ è¡¨ï¼ˆé›–ç„¶å®ƒé€šå¸¸æ˜¯ç©ºçš„ï¼‰ã€‚ é€™å€‹æµç¨‹ç¢ºä¿äº†æœ¬åœ°æµé‡çš„å„ªå…ˆè™•ç†ï¼Œç„¶å¾Œæ‰æ˜¯ä¸€èˆ¬çš„ç¶²è·¯æµé‡ã€‚\né€²éšæ§åˆ¶ï¼šæ‰“é€ è‡ªå·±çš„è·¯ç”±è¦å‰‡ # ip ruleÂ çš„å¼·å¤§ä¹‹è™•åœ¨æ–¼æˆ‘å€‘å¯ä»¥è‡ªè¨‚è¦å‰‡ï¼Œåˆ©ç”¨è±å¯Œçš„é¸æ“‡å™¨ä¾†å¯¦ç¾ç²¾ç´°çš„æµé‡æ§åˆ¶ã€‚å¸¸è¦‹çš„é¸æ“‡å™¨åŒ…æ‹¬ï¼š\nfrom \u0026lt;source_prefix\u0026gt;ï¼šæ ¹æ“šä¾†æº IP ä½å€åŒ¹é…ã€‚ to \u0026lt;destination_prefix\u0026gt;ï¼šæ ¹æ“šç›®çš„ IP ä½å€åŒ¹é…ã€‚ iif \u0026lt;interface_name\u0026gt;ï¼šæ ¹æ“šå°åŒ…é€²å…¥çš„ç¶²è·¯ä»‹é¢ (input interface) åŒ¹é…ã€‚ fwmark \u0026lt;mark\u0026gt;ï¼šæ ¹æ“šÂ netfilterÂ (iptables/nftables) è¨­å®šçš„é˜²ç«ç‰†æ¨™è¨˜ (firewall mark) ä¾†åŒ¹é…ã€‚é€™æä¾›äº†ä¸€å€‹çµ•ä½³çš„æ©Ÿåˆ¶ï¼Œè®“æˆ‘å€‘å¯ä»¥åœ¨é˜²ç«ç‰†å±¤é¢å°å°åŒ…é€²è¡Œåˆ†é¡æ¨™è¨˜ï¼Œç„¶å¾Œåœ¨è·¯ç”±å±¤æ ¹æ“šæ¨™è¨˜æ±ºå®šå…¶èµ°å‘ã€‚ æ­¤å¤–ï¼Œæˆ‘å€‘é‚„å¯ä»¥åœ¨è¦å‰‡ä¸­åŠ å…¥ä¸€äº›é€²éšè¨­å®šä¾†æ‹’çµ•æŸäº›åŒ¹é…çµæœï¼š\nsuppress_prefixlength \u0026lt;length\u0026gt;ï¼šå¦‚æœåŒ¹é…åˆ°çš„è·¯ç”±å…¶å­ç¶²è·¯é®ç½©é•·åº¦å°æ–¼æŒ‡å®šå€¼ï¼Œå‰‡å¿½ç•¥é€™æ¬¡åŒ¹é…ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€æ¢è¦å‰‡ã€‚ä¸€å€‹ç¶“å…¸ç”¨æ³•æ˜¯Â suppress_prefixlength 0ï¼Œé€™æ„å‘³è‘—å¦‚æœåœ¨é€™å¼µè¡¨ä¸­åªåŒ¹é…åˆ°äº†é è¨­è·¯ç”± (prefix length ç‚º 0)ï¼Œå°±ç•¶ä½œæ²’æ‰¾åˆ°ï¼Œè®“å°åŒ…æœ‰æ©Ÿæœƒå»æŸ¥è©¢ä¸‹ä¸€å¼µè·¯ç”±è¡¨ã€‚ suppress_ifgroup \u0026lt;group\u0026gt;ï¼šå¦‚æœåŒ¹é…åˆ°çš„è·¯ç”±å…¶å‡ºå£ä»‹é¢å±¬æ–¼æŸå€‹ç‰¹å®šçš„ä»‹é¢ç¾¤çµ„ï¼Œå‰‡å¿½ç•¥é€™æ¬¡åŒ¹é…ã€‚ å¯¦æˆ°æ‡‰ç”¨ï¼šVPN è·¯ç”±åˆ†æµ # è®“æˆ‘å€‘é€éä¸€å€‹å¸¸è¦‹çš„ VPN æ‡‰ç”¨å ´æ™¯ï¼Œä¾†å¯¦éš›æ“ä½œä¸€ä¸‹è·¯ç”±ç­–ç•¥ã€‚å‡è¨­æˆ‘å€‘æœ‰ä»¥ä¸‹éœ€æ±‚ï¼š\næœ¬åœ°å€åŸŸç¶²è·¯çš„æµé‡ (192.168.5.0/16) æ‡‰è©²ç›´æ¥å¾Â eth0Â å‡ºå»ï¼Œä¸ç¶“é VPNã€‚ ä¸€äº›ä¸åœ¨åŒä¸€å€‹ L2 ç¶²åŸŸï¼Œä½†æ˜¯ä¹Ÿåœ¨æœ¬åœ°çš„æµé‡ (192.168.4.0/24) ä¹Ÿæ‡‰è©²ç›´æ¥ç›´æ¥å¾Â eth0Â å‡ºå»åˆ° gatewayã€‚ VPN ç³»çµ±æœƒå®šç¾©ä¸€äº›ç¶²æ®µ (192.168.4.0/30, 192.168.3.0/24)ï¼Œåœ¨é€™äº›ç¶²æ®µçš„æµé‡æ‡‰è©²èµ°åˆ° VPN ä»‹é¢Â tun0ï¼Œä½†æ˜¯ VPN ç¶²æ®µå¯èƒ½æœƒè·Ÿæœ¬åœ°ç¶²æ®µé‡ç–Šã€‚ éƒ½ä¸åŒ¹é…ï¼Œæœ€çµ‚èµ°åˆ°é è¨­é–˜é“ é¦–å…ˆï¼ŒmainÂ è·¯ç”±è¡¨ä¸­å·²ç¶“æœ‰æˆ‘å€‘çš„æœ¬åœ°è·¯ç”±å’Œé è¨­é–˜é“ã€‚\n# main table $ ip route show table main default via 192.168.5.254 dev eth0 192.168.5.0/24 dev eth0 proto kernel scope link src 192.168.5.1 192.168.4.0/24 via 192.168.5.254 dev eth0 proto static scope link æ¥è‘—ï¼Œæˆ‘å€‘ç‚º VPN å»ºç«‹ä¸€å¼µæ–°çš„è·¯ç”±è¡¨ï¼ŒID è¨­ç‚ºÂ 100ï¼Œä¸¦åœ¨å…¶ä¸­åŠ å…¥å°æ‡‰çš„è·¯ç”±ã€‚\nip route add 192.168.4.0/30 dev tun0 table 100 ip route add 192.168.3.0/24 dev tun0 table 100 ç¾åœ¨ï¼Œæˆ‘å€‘éœ€è¦æ–°å¢ä¸€æ¢è·¯ç”±ç­–ç•¥ï¼Œè®“å°åŒ…å»æŸ¥è©¢é€™å¼µæ–°çš„Â vpn_tableÂ (ID 100)ã€‚æˆ‘å€‘è¨­å®šä¸€å€‹æ¯”Â mainÂ è¡¨ï¼ˆ32766ï¼‰æ›´é«˜çš„å„ªå…ˆç´šï¼Œä¾‹å¦‚Â 10000ã€‚\nBash\n# æ–°å¢è¦å‰‡ï¼šæ‰€æœ‰å°åŒ…éƒ½å»æŸ¥è©¢ table 100 ip rule add prio 10000 lookup 100 é€™æ¨£ä¸€ä¾†ï¼Œè·¯ç”±æ±ºç­–æµç¨‹å°±è®Šæˆäº†ï¼šlocalÂ -\u0026gt;Â vpn_tableÂ -\u0026gt;Â mainã€‚æ‰€æœ‰éæœ¬åœ°æµé‡éƒ½æœƒå„ªå…ˆå˜—è©¦èµ° VPNã€‚é€™æ¨£çš„å¥½è™•æ˜¯æˆ‘å€‘å¯ä»¥æŠŠ VPN ç›¸é—œçš„è·¯ç”±éƒ½åœ¨ä¸€å¼µç¨ç«‹çš„ vpn_table ç®¡ç†ã€‚\nä½†æ˜¯ï¼Œå°æ–¼ 192.168.4.1 è€Œè¨€ï¼Œä»–æœƒå…ˆ match vpn_table è£¡é¢çš„ 192.168.4.0/30ï¼Œå°±ä¸æ»¿è¶³æˆ‘å€‘å¸Œæœ› main è£¡é¢æœ‰å®šç¾© 192.168.4.0/24çš„æƒ…æ³ä¸‹ï¼Œå„ªå…ˆèµ°æœ¬åœ°çš„è·¯ç”±åˆ° eth0ã€‚\né€™æ™‚Â suppress_prefixlengthÂ å°±æ´¾ä¸Šç”¨å ´äº†ã€‚æˆ‘å€‘å¯ä»¥ä¿®æ”¹Â mainÂ è¡¨çš„æŸ¥è©¢è¦å‰‡ï¼š\nBash\n# æ–°å¢ä¸€æ¢è¦å‰‡ï¼ŒæŸ¥è©¢ main è¡¨ï¼Œä½†å¿½ç•¥é è¨­è·¯ç”± ip rule add prio 5000 suppress_prefixlength 0 lookup main # å†æ–°å¢ä¸€æ¢è¦å‰‡ï¼Œå°ˆé–€ç”¨ä¾†è™•ç†é è¨­è·¯ç”± ip rule add prio 32766 lookup main ç¾åœ¨ routing policy é•·é€™æ¨£ï¼š\n$ ip rule 0:\tfrom all lookup local 5000:\tfrom all lookup main suppress_prefixlength 0 10000: from all lookup 100 32766:\tfrom all lookup main 32767:\tfrom all lookup default é€™æ¨£ï¼Œæˆ‘å€‘å°±å¯¦ç¾äº†æ›´è¤‡é›œçš„é‚è¼¯ï¼šlocalÂ -\u0026gt;Â mainÂ (åƒ…æœ¬åœ°è·¯ç”±) -\u0026gt;Â vpn_tableÂ -\u0026gt;Â mainÂ (é è¨­é–˜é“)ã€‚\nç•¶ç„¶ï¼Œé€™æ¨£æœ‰é‡è¤‡çš„ route å¯èƒ½æœƒæœ‰é»å¥‡æ€ªï¼Œä½†å¯¦éš›ä½¿ç”¨ä¸Šï¼Œæˆ‘å€‘å¯èƒ½æ˜¯å¸Œæœ› VPN table è£¡é¢åŒ…å«é€šç”¨çš„ä¸€äº› routeï¼Œç„¶å¾Œæˆ‘å€‘æœ¬åœ°é€é main table å¯¦ç¾ä¸€äº›ç‰¹æ®Šè·¯ç”±è¦å‰‡ã€‚\nç¸½çµ # é€éæœ¬æ–‡çš„æ¢è¨ï¼Œæˆ‘å€‘äº†è§£äº† Linux ç¶²è·¯ä¸åƒ…åƒ…åªæœ‰ä¸€å¼µè·¯ç”±è¡¨ã€‚å…¶æ ¸å¿ƒæ˜¯ä¸€å€‹ç”±Â ip ruleï¼ˆè·¯ç”±ç­–ç•¥ï¼‰å’Œå¤šå¼µÂ ip routeï¼ˆè·¯ç”±è¡¨ï¼‰çµ„æˆçš„å¼·å¤§æ±ºç­–ç³»çµ±ã€‚å°åŒ…é¦–å…ˆç”±Â ip ruleÂ æ ¹æ“šå…¶å„ªå…ˆç´šå’Œé¸æ“‡å™¨é€²è¡ŒåŒ¹é…ï¼Œæ±ºå®šè¦å»å“ªä¸€å¼µÂ ip routeÂ è¡¨ä¸­å°‹æ‰¾è·¯ç”±ï¼Œæœ€çµ‚ç¢ºå®šå…¶é›¢é–‹æœ¬æ©Ÿçš„ä»‹é¢ã€‚\næŒæ¡äº†è·¯ç”±ç­–ç•¥ï¼Œä½ å°±èƒ½å¤ åœ¨ Linux ç’°å¢ƒä¸‹å¯¦ç¾ä¾†æºè·¯ç”±ã€ç­–ç•¥è·¯ç”±ã€VPN åˆ†æµç­‰å„ç¨®è¤‡é›œçš„ç¶²è·¯éœ€æ±‚ï¼Œè®“ä½ çš„ç¶²è·¯é…ç½®æ›´åŠ éˆæ´»èˆ‡å¼·å¤§ã€‚\n","date":"September 30 2025","externalUrl":null,"permalink":"/posts/understanding-linux-routing-table-and-policy/","section":"æ–‡ç« ","summary":"","title":"äº†è§£ Linux å¤šè·¯ç”±è¡¨èˆ‡è·¯ç”±ç­–ç•¥","type":"posts"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/categories/","section":"åˆ†é¡","summary":"","title":"åˆ†é¡","type":"categories"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/posts/","section":"æ–‡ç« ","summary":"","title":"æ–‡ç« ","type":"posts"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/tags/%E6%8A%80%E8%A1%93%E5%88%86%E4%BA%AB/","section":"æ¨™ç±¤","summary":"","title":"æŠ€è¡“åˆ†äº«","type":"tags"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/tags/%E5%8E%9F%E5%A7%8B%E7%A2%BC%E5%88%86%E6%9E%90/","section":"æ¨™ç±¤","summary":"","title":"åŸå§‹ç¢¼åˆ†æ","type":"tags"},{"content":"cgroup v2 æä¾›äº†Â io.maxÂ æ§åˆ¶å™¨ï¼Œè®“æˆ‘å€‘å¯ä»¥é™åˆ¶ç‰¹å®š cgroup å°å–®ä¸€å€å¡Šè¨­å‚™ï¼ˆblock deviceï¼‰çš„è®€å¯«é€Ÿåº¦ï¼ˆBPS æˆ– IOPSï¼‰ã€‚ä»Šå¤©æˆ‘å€‘è¦æ¢ç´¢çš„å•é¡Œæ˜¯ï¼šio.maxÂ ç©¶ç«Ÿåœ¨æª”æ¡ˆè®€å¯«æµç¨‹çš„å“ªå€‹ç’°ç¯€ä»‹å…¥ï¼Ÿå®ƒåˆæ˜¯å¦‚ä½•é€éä½•ç¨®æ©Ÿåˆ¶å¯¦ç¾æµé‡æ§åˆ¶çš„ï¼Ÿæœ¬ç¯‡æ–‡ç« å°‡ä»¥Â Linux æ ¸å¿ƒ v6.14 ç‰ˆæœ¬çš„åŸå§‹ç¢¼ç‚ºåŸºç¤ï¼Œæ·±å…¥æ¢è¨Â io.maxÂ åœ¨ Block I/O Layer çš„å®Œæ•´å¯¦ç¾åŸç†ã€‚\nI/O è«‹æ±‚çš„æ—…ç¨‹ï¼šå¾ç³»çµ±å‘¼å«åˆ° Block Layer # é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦å° Linux çš„ I/O Stack æœ‰ä¸€å€‹æ•´é«”çš„äº†è§£ã€‚ç•¶æˆ‘å€‘åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨Â write()Â é€™é¡ system call ä¾†æ“ä½œæª”æ¡ˆæ™‚ï¼Œè«‹æ±‚æœƒé¦–å…ˆé€²å…¥è™›æ“¬æª”æ¡ˆç³»çµ± (Virtual File System, VFS)Â å±¤ï¼Œå‘¼å« VFS å‡½æ•¸ï¼Œå¦‚ vfs_write ã€‚VFS ä½œç‚ºä¸€å€‹æŠ½è±¡å±¤ï¼Œæä¾›äº†çµ±ä¸€çš„ä»‹é¢ï¼Œè®“ä¸Šå±¤çš„ç³»çµ±å‘¼å«ç„¡éœ€é—œå¿ƒåº•å±¤æª”æ¡ˆç³»çµ±ï¼ˆå¦‚ ext4, XFSï¼‰çš„å…·é«”å¯¦ç¾ã€‚\nå¦‚æˆ‘åœ¨è™›æ“¬æª”æ¡ˆç³»çµ± VFS (1) - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©ä»‹ç´¹åˆ°çš„ï¼Œæª”æ¡ˆç³»çµ±éœ€è¦å¯¦ç¾ VFS çš„ä»‹é¢ï¼Œä¾†æä¾›æª”æ¡ˆç³»çµ±åŠŸèƒ½ã€‚é€éé€™æ¨£çš„æŠ½è±¡ï¼Œåº•å±¤çš„æª”æ¡ˆç³»çµ±å¯¦ç¾å°±ä¸æœƒè¢«é™åˆ¶ï¼Œä¹Ÿä½¿ procs é€™æ¨£çš„è™›æ“¬æª”æ¡ˆç³»çµ±æˆç‚ºå¯èƒ½ï¼Œæ˜¯ Linux æ¶æ§‹ä¸­ï¼Œè¬ç‰©çš†ç‚ºæª”æ¡ˆçš„é‡è¦åŸºç¤ã€‚\nflowchart TD C[\u0026#34;system call\u0026#34;] --\u0026gt; n1@{ label: \u0026#34;\u0026lt;span style=\\\u0026#34;color:\\\u0026#34;\u0026gt;Virtual File System\u0026lt;/span\u0026gt;\u0026#34; } n1 --\u0026gt; n2[\u0026#34;ext4 File System\u0026#34;] n2 --\u0026gt; n4[\u0026#34;Page Cache\u0026#34;] n4 --\u0026gt; n5@{ label: \u0026#34;\u0026lt;p class=\\\u0026#34;p1\\\u0026#34;\u0026gt;Block I/O Layer\u0026lt;/p\u0026gt;\u0026#34; } n5 --\u0026gt; n6[\u0026#34;device mapper/driver\u0026#34;] n1@{ shape: rect} n5@{ shape: rect} æª”æ¡ˆç³»çµ±çš„æ ¸å¿ƒè·è²¬æ˜¯ç®¡ç†æª”æ¡ˆçš„çµ„ç¹”çµæ§‹ã€ä¸­ç¹¼è³‡æ–™ (metadata) ç­‰ï¼Œä½†å®ƒä¸ç›´æ¥èˆ‡ç¡¬ç¢Ÿç­‰å„²å­˜ä»‹è³ªæºé€šã€‚è³‡æ–™çš„è®€å¯«æœ€çµ‚éœ€è¦é€šéÂ Block I/O Layerï¼Œç”±å®ƒä¾†è™•ç†ä¾†è‡ªæª”æ¡ˆç³»çµ±çš„è«‹æ±‚ï¼Œä¸¦å°‡é€™äº›è«‹æ±‚æ’ç¨‹ã€åˆ†æ´¾çµ¦å°æ‡‰çš„è¨­å‚™é©…å‹•ç¨‹å¼ (device driver)ã€‚\næ­¤å¤–ï¼Œç‚ºäº†æå‡æ•ˆèƒ½ï¼Œæª”æ¡ˆç³»çµ±èˆ‡ Block I/O Layer ä¹‹é–“é‚„æœ‰ä¸€å±¤é‡è¦çš„é é¢å¿«å– (Page Cache)ï¼Œå®ƒæœƒæš«å­˜æª”æ¡ˆçš„è®€å¯«å…§å®¹ï¼Œä»¥æ¸›å°‘æ˜‚è²´çš„ç£ç¢Ÿ I/O æ“ä½œæ¬¡æ•¸ã€‚\næ‰€æœ‰å°å¯¦é«”å„²å­˜è¨­å‚™çš„ I/O æ“ä½œéƒ½å¿…é ˆç¶“é Block I/O Layerã€‚å› æ­¤ï¼Œio.maxÂ çš„é™åˆ¶æ©Ÿåˆ¶è‡ªç„¶ä¹Ÿæ˜¯åœ¨é€™è£¡å¯¦ç¾çš„ã€‚åœ¨ Block Layer ä¸­ï¼Œä¸€å€‹ I/O è«‹æ±‚è¢«å°è£åœ¨Â struct bioÂ é€™å€‹æ ¸å¿ƒè³‡æ–™çµæ§‹ä¸­ï¼Œè€ŒÂ submit_bio()Â å‰‡æ˜¯ä¸Šå±¤å‘ Block Layer æäº¤ I/O è«‹æ±‚çš„ä¸»è¦å…¥å£ã€‚\nblk_throtl_bio: I/O é™é€Ÿçš„å…¥å£ # è®“æˆ‘å€‘å¾Â submit_bioÂ é–‹å§‹è¿½è¹¤ç¨‹å¼ç¢¼ã€‚\n// block/blk-core.c void submit_bio(struct bio *bio) { // ... æ›´æ–°çµ±è¨ˆè³‡æ–™ ... if (bio_op(bio) == REQ_OP_READ) { task_io_account_read(bio-\u0026gt;bi_iter.bi_size); count_vm_events(PGPGIN, bio_sectors(bio)); } else if (bio_op(bio) == REQ_OP_WRITE) { count_vm_events(PGPGOUT, bio_sectors(bio)); } bio_set_ioprio(bio); submit_bio_noacct(bio); // noacct = no accounting } EXPORT_SYMBOL(submit_bio); submit_bioÂ åœ¨åšäº†ä¸€äº›çµ±è¨ˆå¾Œï¼Œæœƒå‘¼å«Â submit_bio_noacctã€‚é€™å€‹å‡½æ•¸ï¼Œæœƒå…ˆå° bio request åšä¸€äº›åŸºæœ¬çš„é©—è­‰ï¼Œç„¶å¾Œæœ€é‡è¦çš„æ˜¯æœƒå‘¼å«Â blk_throtl_bio(bio)Â ã€‚\nvoid submit_bio_noacct(struct bio *bio) { // ... ä¸€äº›åŸºæœ¬çš„ bio é©—è­‰ ... struct block_device *bdev = bio-\u0026gt;bi_bdev; struct request_queue *q = bdev_get_queue(bdev); blk_status_t status = BLK_STS_IOERR; ... switch (bio_op(bio)) { case REQ_OP_READ: break; case REQ_OP_WRITE: if (bio-\u0026gt;bi_opf \u0026amp; REQ_ATOMIC) { status = blk_validate_atomic_write_op_size(q, bio); if (status != BLK_STS_OK) goto end_io; } break; ... default: goto not_supported; } // throttling æ©Ÿåˆ¶ if (blk_throtl_bio(bio)) return; // æ”¾å…¥è«‹æ±‚ä½‡åˆ— submit_bio_noacct_nocheck(bio); return; not_supported: status = BLK_STS_NOTSUPP; end_io: bio-\u0026gt;bi_status = status; bio_endio(bio); } å¦‚æœÂ blk_throtl_bio()Â å›å‚³Â trueï¼Œä»£è¡¨é€™å€‹Â bioÂ è«‹æ±‚å·²ç¶“è¢« I/O throttling æ©Ÿåˆ¶é™é€Ÿï¼Œå‡½æ•¸æœƒç›´æ¥Â returnã€‚é€™å€‹Â bioÂ ä¸æœƒç«‹åˆ»è¢«æäº¤åˆ°è¨­å‚™ä½‡åˆ—ï¼Œè€Œæ˜¯æœƒè¢«æ”¾å…¥ä¸€å€‹ throttling çš„å¾…è¾¦ä½‡åˆ—ï¼Œç­‰å¾…æœªä¾†è¢«é‡æ–°æ´¾ç™¼ã€‚\nå¦‚æœå›å‚³Â falseï¼Œä»£è¡¨è«‹æ±‚æœªè¢«é™é€Ÿï¼Œå¯ä»¥ç¹¼çºŒåŸ·è¡ŒÂ submit_bio_noacct_nocheck()ï¼Œå°‡Â bioÂ æ”¾å…¥è¨­å‚™çš„è«‹æ±‚ä½‡åˆ—ä¸­ã€‚\nvoid submit_bio_noacct_nocheck(struct bio *bio) { ... if (current-\u0026gt;bio_list) bio_list_add(\u0026amp;current-\u0026gt;bio_list[0], bio); ... } blk_throtl_bioÂ å¯¦éš›ä¸Šæ˜¯ I/O é™é€Ÿçš„ç¸½å…¥å£ã€‚è®“æˆ‘å€‘çœ‹çœ‹å®ƒå¦‚ä½•åˆ¤æ–·ä¸€å€‹Â bioÂ æ˜¯å¦éœ€è¦è¢«é™é€Ÿã€‚\nstatic inline bool blk_throtl_bio(struct bio *bio) { if (!blk_should_throtl(bio)) // æª¢æŸ¥æ˜¯å¦éœ€è¦å•Ÿç”¨é™é€Ÿ return false; return __blk_throtl_bio(bio); // åŸ·è¡Œé™é€Ÿçš„æ ¸å¿ƒé‚è¼¯ } static inline bool blk_should_throtl(struct bio *bio) { struct throtl_grp *tg = blkg_to_tg(bio-\u0026gt;bi_blkg); int rw = bio_data_dir(bio); // ... çœç•¥ cgroup v1 ç›¸é—œé‚è¼¯ ... /* iops limit is always counted */ if (tg-\u0026gt;has_rules_iops[rw]) // æ˜¯å¦è¨­å®šäº† IOPS é™åˆ¶ return true; if (tg-\u0026gt;has_rules_bps[rw] \u0026amp;\u0026amp; !bio_flagged(bio, BIO_BPS_THROTTLED)) // æ˜¯å¦è¨­å®šäº† BPS é™åˆ¶ return true; return false; } blk_should_throtlÂ çš„é‚è¼¯å¾ˆç›´æ¥ï¼šå®ƒæœƒå¾Â bioÂ ä¸­å–å¾—å…¶æ‰€å±¬çš„ cgroupï¼Œä¸¦æª¢æŸ¥è©² cgroupï¼ˆç”±Â struct throtl_grpÂ è¡¨ç¤ºï¼‰æ˜¯å¦è¨­å®šäº† BPS (has_rules_bps) æˆ– IOPS (has_rules_iops) è¦å‰‡ã€‚åªè¦æœ‰ä»»ä½•ä¸€é …è¦å‰‡å­˜åœ¨ï¼Œå°±è¡¨ç¤ºé€™å€‹Â bioÂ éœ€è¦ç¶“éé™é€Ÿæª¢æŸ¥ã€‚\n__blk_throtl_bio: é™é€Ÿæ©Ÿåˆ¶çš„æª¢æŸ¥èˆ‡æ’éšŠ # ç¢ºèªéœ€è¦é™é€Ÿå¾Œï¼Œæ ¸å¿ƒé‚è¼¯å°±äº¤çµ¦äº†Â __blk_throtl_bioã€‚ç”±æ–¼ cgroup æ˜¯éšå±¤å¼æ¶æ§‹ï¼Œä¸€å€‹ I/O è«‹æ±‚å¿…é ˆåŒæ™‚æ»¿è¶³å¾è‡ªèº« cgroup åˆ° root cgroup çš„æ¯ä¸€å±¤é™åˆ¶ã€‚\n// block/blk-throttle.c bool __blk_throtl_bio(struct bio *bio) { // ... åˆå§‹åŒ–è®Šæ•¸ ... struct throtl_grp *tg = blkg_to_tg(bio-\u0026gt;bi_blkg); bool throttled = false; // ... // è¿´åœˆæª¢æŸ¥å¾ç•¶å‰ cgroup åˆ° root cgroup çš„æ¯ä¸€å±¤ while (true) { if (tg_within_limit(tg, bio, rw)) { // åœ¨é™åˆ¶å…§ï¼Œç´¯åŠ ç”¨é‡ä¸¦ç¹¼çºŒæª¢æŸ¥çˆ¶ cgroup throtl_charge_bio(tg, bio); throtl_trim_slice(tg, rw); } else if (bio_issue_as_root_blkg(bio)) { // ... ç‰¹æ®Šæƒ…æ³è™•ç†ï¼Œä¾‹å¦‚é¿å…å„ªå…ˆç´šåè½‰ ... tg_dispatch_in_debt(tg, bio, rw); } else { // è¶…å‡ºé™åˆ¶ï¼Œè·³å‡ºè¿´åœˆï¼Œæº–å‚™æ’éšŠ break; } // çˆ¬åˆ°çˆ¶ cgroup tg = sq_to_tg(sq-\u0026gt;parent_sq); if (!tg) { // å·²åˆ° root ä¸”éƒ½é€šéï¼Œä¸éœ€é™é€Ÿ bio_set_flag(bio, BIO_BPS_THROTTLED); goto out_unlock; } } // è¶…å‡ºé™åˆ¶ï¼Œå°‡ bio åŠ å…¥åˆ° tg çš„ä½‡åˆ—ä¸­ td-\u0026gt;nr_queued[rw]++; throtl_add_bio_tg(bio, qn, tg); throttled = true; // å¦‚æœä½‡åˆ—ä¹‹å‰æ˜¯ç©ºçš„ï¼Œå‰‡éœ€è¦å®‰æ’ä¸‹ä¸€æ¬¡çš„æ´¾ç™¼ if (tg-\u0026gt;flags \u0026amp; THROTL_TG_WAS_EMPTY) { tg_update_disptime(tg); throtl_schedule_next_dispatch(tg-\u0026gt;service_queue.parent_sq, true); } out_unlock: // ... return throttled; } é€™æ®µç¨‹å¼ç¢¼çš„æ ¸å¿ƒæ˜¯ä¸€å€‹Â whileÂ è¿´åœˆï¼Œå®ƒæœƒæ²¿è‘— cgroup æ¨¹å‘ä¸Šéæ­·ã€‚åœ¨æ¯ä¸€å±¤ï¼š\nå‘¼å«Â tg_within_limit()Â æª¢æŸ¥ç•¶å‰çš„Â bioÂ æ˜¯å¦åœ¨è¶…å‡ºè©²å±¤ cgroup çš„é™åˆ¶ã€‚\nå¦‚æœåœ¨é™åˆ¶å…§ï¼šå‘¼å«Â throtl_charge_bio()Â å°‡Â bioÂ çš„å¤§å°æˆ–æ•¸é‡è¨ˆå…¥å·²ç”¨é¡åº¦ï¼Œç„¶å¾Œç¹¼çºŒå‘ä¸Šæª¢æŸ¥çˆ¶ cgroupã€‚\nå¦‚æœè¶…å‡ºé™åˆ¶ï¼šè¿´åœˆä¸­æ–·ï¼Œé€™å€‹Â bioÂ è¢«åˆ¤å®šéœ€è¦è¢«é™é€Ÿã€‚å®ƒæœƒè¢«Â throtl_add_bio_tg()Â åŠ å…¥åˆ°ç•¶å‰ cgroup çš„Â throtlÂ ä½‡åˆ—ä¸­ï¼Œä¸¦è¨­å®šÂ throttled = trueã€‚\næœ€å¾Œï¼Œthrotl_schedule_next_dispatch()Â æœƒè¢«å‘¼å«ï¼Œç”¨ä¾†è¨­å®šä¸€å€‹è¨ˆæ™‚å™¨ï¼Œä»¥ä¾¿åœ¨æœªä¾†æŸå€‹æ™‚é–“é»é‡æ–°æ´¾ç™¼ä½‡åˆ—ä¸­çš„Â bioã€‚\né€™é‚Šæœ‰ä¸€å€‹ç‰¹åˆ¥çš„è™•ç†é‚è¼¯æ˜¯ã€Œé¿å…å„ªå…ˆç´šåè½‰ã€ï¼Œä¹Ÿå°±æ˜¯èªªæŸäº› I/O å¦‚æœè¢« throttle å¡ä½ï¼Œå¯èƒ½æœƒå°è‡´é«˜å„ªå…ˆæ¬Šçš„æµç¨‹å› ä½å„ªå…ˆæ¬Šæµç¨‹è¢«é˜»å¡è€Œå¡ä½ï¼Œå¦‚æª”æ¡ˆç³»çµ±çš„ metadata I/Oï¼ˆjournalã€ext4 commit blockï¼‰ã€swap-in I/Oï¼ˆç¼ºé è¦è®€è³‡æ–™é€²ä¾†ï¼‰ã€fsync() è§¸ç™¼çš„ writebackã€‚é€™äº› I/O å¦‚æœè¢«å»¶é²ï¼Œæœƒå°è‡´ç³»çµ±ä¸Šå±¤ç¨‹å¼å®Œå…¨å¡ä½ã€‚\nstatic inline bool bio_issue_as_root_blkg(struct bio *bio) { return (bio-\u0026gt;bi_opf \u0026amp; (REQ_META | REQ_SWAP)) != 0; } tg_may_dispatchï¼šæ™‚é–“ç‰‡èˆ‡æµé‡è¨ˆç®— # é‚£éº¼ï¼Œtg_within_limitÂ æ˜¯å¦‚ä½•åˆ¤æ–·æ˜¯å¦ã€Œåœ¨é™åˆ¶å…§ã€çš„å‘¢ï¼Ÿå®ƒå…§éƒ¨æœƒå‘¼å«Â tg_may_dispatchï¼Œé€™æ‰æ˜¯è¨ˆç®—çš„æ ¸å¿ƒã€‚\nstatic bool tg_within_limit(struct throtl_grp *tg, struct bio *bio, bool rw) { /* throtl is FIFO - if bios are already queued, should queue */ // ç°¡å–®ä¾†èªªï¼Œå¦‚æœå‰ä¸€å€‹ request å·²ç¶“è¢«å¡ä½äº†ï¼Œé‚£ç¾åœ¨é€™å€‹ request ç•¶ç„¶ä¹Ÿè¢«å¡ä½äº† if (tg-\u0026gt;service_queue.nr_queued[rw]) return false; return tg_may_dispatch(tg, bio, NULL); } Linux çš„ I/O é™é€Ÿæ˜¯åŸºæ–¼æ™‚é–“ç‰‡ (time slice)Â æ©Ÿåˆ¶ä¾†å¯¦ç¾çš„ã€‚Linux æœƒè¨˜éŒ„åœ¨ä¸€å€‹ç‰¹å®šçš„æ™‚é–“ç‰‡å…§ï¼Œä¸€å€‹ cgroup å·²ç¶“ä½¿ç”¨äº†å¤šå°‘ I/O è³‡æºï¼Œä¸¦æ“šæ­¤ä¾†åˆ¤æ–·å…¶ä½¿ç”¨é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚\nç•¶ä¸€å€‹æ–°çš„ I/O è«‹æ±‚ï¼ˆbio è«‹æ±‚ï¼‰å‚³å…¥æ™‚ï¼Œæ ¸å¿ƒæœƒå…ˆæª¢æŸ¥ç•¶å‰è«‹æ±‚æ˜¯å¦ä»åœ¨èˆŠçš„æ™‚é–“ç‰‡æ™‚é–“ç¯„åœå…§ã€‚å¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæ ¸å¿ƒæœƒæ ¹æ“šå¾è©²æ™‚é–“ç‰‡é–‹å§‹åˆ°ç›®å‰çš„æ™‚é–“ï¼Œè¨ˆç®—å‡ºæ­¤ cgroup é æœŸå¯ä½¿ç”¨çš„ I/O ç¸½é‡ï¼Œä¹Ÿå°±æ˜¯ (ç¾åœ¨æ™‚é–“âˆ’æ™‚é–“ç‰‡é–‹å§‹æ™‚é–“)Ã—cgroup é™åˆ¶ï¼Œç„¶å¾Œå†åˆ¤æ–·é€™å€‹æ–°çš„è«‹æ±‚æ˜¯å¦æœƒå°è‡´ç¸½ç”¨é‡è¶…å‡ºé æœŸå€¼ã€‚\næ¯æ¬¡æœ‰æ–°çš„è«‹æ±‚é€²ä¾†ï¼Œè©²æ™‚é–“ç‰‡çš„çµæŸæ™‚é–“éƒ½æœƒè¢«å»¶é•·ã€‚ç›¸ååœ°ï¼Œå¦‚æœé•·æ™‚é–“æ²’æœ‰ä»»ä½•æ–°çš„è«‹æ±‚ï¼Œç•¶å‰æ™‚é–“å°±æœƒè¶…éè©²æ™‚é–“ç‰‡çš„çµæŸæ™‚é–“ï¼Œæ­¤æ™‚ç³»çµ±ä¾¿æœƒå•Ÿå‹•ä¸€å€‹æ–°çš„æ™‚é–“ç‰‡ä¾†é‡æ–°è¨ˆç®—ã€‚\n// block/blk-throttle.c static bool tg_may_dispatch(struct throtl_grp *tg, struct bio *bio, unsigned long *wait) { bool rw = bio_data_dir(bio); unsigned long bps_wait = 0, iops_wait = 0, max_wait = 0; u64 bps_limit = tg_bps_limit(tg, rw); // å–å¾—è¨­å®šçš„ BPS ä¸Šé™ u32 iops_limit = tg_iops_limit(tg, rw); // å–å¾—è¨­å®šçš„ IOPS ä¸Šé™ // å¦‚æœæ²’æœ‰è¨­å®šé™åˆ¶ï¼Œç›´æ¥é€šé if ((bps_limit == U64_MAX \u0026amp;\u0026amp; iops_limit == UINT_MAX) || tg-\u0026gt;flags \u0026amp; THROTL_TG_CANCELING) { if (wait) *wait = 0; return true; } // å¦‚æœä¸Šä¸€å€‹æ™‚é–“ç‰‡ç”¨å®Œäº† (current time \u0026gt; slice end time)ï¼Œå°±é–‹å§‹ä¸€å€‹æ–°çš„ if (throtl_slice_used(tg, rw) \u0026amp;\u0026amp; !(tg-\u0026gt;service_queue.nr_queued[rw])) throtl_start_new_slice(tg, rw, true); else { // å¦å‰‡ï¼Œç¢ºä¿ç•¶å‰æ™‚é–“ç‰‡è‡³å°‘é‚„æœ‰ throtl_slice çš„é•·åº¦ if (time_before(tg-\u0026gt;slice_end[rw], jiffies + tg-\u0026gt;td-\u0026gt;throtl_slice)) throtl_extend_slice(tg, rw, jiffies + tg-\u0026gt;td-\u0026gt;throtl_slice); } // è¨ˆç®— BPS å’Œ IOPS æ˜¯å¦åœ¨ç•¶å‰æ™‚é–“ç‰‡çš„é¡åº¦å…§ bps_wait = tg_within_bps_limit(tg, bio, bps_limit); iops_wait = tg_within_iops_limit(tg, bio, iops_limit); // å¦‚æœè¨ˆç®—å‡ºçš„ç­‰å¾…æ™‚é–“æ˜¯ 0ï¼Œè¡¨ç¤ºé¡åº¦è¶³å¤  if (bps_wait + iops_wait == 0) { if (wait) *wait = 0; return true; } // å¦‚æœéœ€è¦ç­‰å¾…ï¼Œè¨ˆç®—æœ€é•·çš„ç­‰å¾…æ™‚é–“ max_wait = max(bps_wait, iops_ wait); if (wait) *wait = max_wait; // å»¶é•·æ™‚é–“ç‰‡ä»¥åŒ…å«ç­‰å¾…æ™‚é–“ if (time_before(tg-\u0026gt;slice_end[rw], jiffies + max_wait)) throtl_extend_slice(tg, rw, jiffies + max_wait); return false; // è¿”å› falseï¼Œè¡¨ç¤ºéœ€è¦ç­‰å¾…ï¼Œç„¡æ³•ç«‹å³æ´¾ç™¼ } tg_may_dispatchÂ çš„é‚è¼¯å¯ä»¥ç¸½çµå¦‚ä¸‹ï¼š\næª¢æŸ¥ç•¶å‰æ™‚é–“ç‰‡çš„é¡åº¦æ˜¯å¦é‚„è¶³ä»¥å®¹ç´é€™å€‹Â bioã€‚\nå¦‚æœé¡åº¦è¶³å¤ ï¼Œå›å‚³Â trueï¼ŒbioÂ å¯ä»¥ç«‹å³æ´¾ç™¼ã€‚\nå¦‚æœé¡åº¦ä¸è¶³ï¼Œä¸¦å›å‚³Â falseã€‚é€™é‚Šé‚„æœƒè¨ˆç®— wait è¡¨ç¤ºè¦ç­‰å¾…å¤šå°‘æ™‚é–“ï¼Œä¸éé€™å€‹å€¼ç›®å‰æ²’ç”¨ã€‚\n#define DFL_THROTL_SLICE_HD (HZ / 10) #define DFL_THROTL_SLICE_SSD (HZ / 50) #define MAX_THROTL_SLICE (HZ) static int blk_throtl_init(struct gendisk *disk) { ... if (blk_queue_nonrot(q)) td-\u0026gt;throtl_slice = DFL_THROTL_SLICE_SSD; else td-\u0026gt;throtl_slice = DFL_THROTL_SLICE_HD; ... } éåŒæ­¥æ´¾ç™¼ï¼šè¢«é™é€Ÿçš„ I/O ä½•å»ä½•å¾ï¼Ÿ # æˆ‘å€‘å·²ç¶“çŸ¥é“ï¼Œè¶…å‡ºé™åˆ¶çš„Â bioÂ æœƒè¢«æ”¾å…¥ä¸€å€‹ä½‡åˆ—ã€‚é‚£é€™äº›Â bioÂ æœ€çµ‚æ˜¯å¦‚ä½•è¢«é‡æ–°æäº¤çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€éæ ¸å¿ƒè¨ˆæ™‚å™¨ (kernel timer)Â å’ŒÂ å·¥ä½œä½‡åˆ— (workqueue)Â å¯¦ç¾çš„éåŒæ­¥æ´¾ç™¼ã€‚\nè¨­å®šè¨ˆæ™‚å™¨ï¼šç•¶Â __blk_throtl_bioÂ æ±ºå®šè¦é™é€Ÿä¸€å€‹Â bioÂ æ™‚ï¼Œthrotl_schedule_next_dispatchÂ æœƒæ ¹æ“šÂ tg_may_dispatchÂ è¨ˆç®—å‡ºçš„ç­‰å¾…æ™‚é–“ï¼Œè¨­å®šä¸€å€‹è¨ˆæ™‚å™¨ã€‚\nè¨ˆæ™‚å™¨è§¸ç™¼ï¼šç•¶ç­‰å¾…æ™‚é–“çµæŸå¾Œï¼Œè¨ˆæ™‚å™¨æœƒè§¸ç™¼å‡½å¼Â throtl_pending_timer_fnã€‚\næ’å…¥å·¥ä½œä½‡åˆ—ï¼šé€™å€‹å‡½å¼ä¸æœƒç›´æ¥æäº¤Â bioï¼Œè€Œæ˜¯å°‡ä¸€å€‹æ´¾ç™¼ä»»å‹™ (dispatch_work) æ’å…¥åç‚ºÂ kthrotld_workqueueÂ çš„å·¥ä½œä½‡åˆ—ã€‚\nå·¥ä½œåŸ·è¡Œç·’æ´¾ç™¼ï¼škthrotldÂ é€™å€‹æ ¸å¿ƒåŸ·è¡Œç·’æœƒåŸ·è¡ŒÂ blk_throtl_dispatch_work_fnã€‚é€™å€‹å‡½å¼æœƒå¾é™é€Ÿä½‡åˆ—ä¸­å–å‡ºæ‰€æœ‰å·²ç¶“å¯ä»¥è¢«æ´¾ç™¼çš„Â bioï¼Œä¸¦æœ€çµ‚å‘¼å«Â submit_bio_noacct_nocheckÂ å°‡å®ƒå€‘æäº¤çµ¦è¨­å‚™é©…å‹•ã€‚\nç¸½çµ # æˆ‘å€‘å¾Â io.maxÂ é€™å€‹ cgroup ä»‹é¢å‡ºç™¼ï¼Œä¸€è·¯è¿½è¹¤åˆ° Linux Block I/O Layer çš„æ·±è™•ï¼Œå®Œæ•´è§£æäº†å…¶é™é€Ÿæ©Ÿåˆ¶çš„å¯¦ç¾åŸç†ï¼š\nç•¶ I/O è«‹æ±‚é€éÂ submit_bioÂ é€²å…¥ Block Layer æ™‚ï¼Œblk_throtl_bioÂ æœƒä½œç‚ºé™é€Ÿçš„å…¥å£ï¼Œæª¢æŸ¥è«‹æ±‚æ‰€å±¬çš„ cgroup æ˜¯å¦è¨­å®šäº†Â io.maxÂ è¦å‰‡ã€‚\næª¢æŸ¥æ˜¯éšå±¤å¼çš„ï¼Œè«‹æ±‚å¿…é ˆæ»¿è¶³å¾è‡ªèº«åˆ° root çš„æ¯ä¸€å±¤ cgroup é™åˆ¶ã€‚\né™é€Ÿçš„è¨ˆç®—åŸºæ–¼æ™‚é–“ç‰‡å’Œé¡åº¦ã€‚tg_may_dispatchÂ å‡½å¼æœƒåˆ¤æ–·åœ¨ç•¶å‰æ™‚é–“ç‰‡å…§ï¼Œæ˜¯å¦é‚„æœ‰è¶³å¤ çš„ BPS/IOPS é¡åº¦ä¾†è™•ç†è«‹æ±‚ã€‚\nè‹¥é¡åº¦ä¸è¶³ï¼ŒbioÂ æœƒè¢«æš«æ™‚æ”¾å…¥ä¸€å€‹å°ˆå±¬çš„é™é€Ÿä½‡åˆ—ï¼Œä¸¦é€éæ ¸å¿ƒè¨ˆæ™‚å™¨å’Œå·¥ä½œä½‡åˆ—çš„éåŒæ­¥æ©Ÿåˆ¶ï¼Œåœ¨ç­‰å¾…è¶³å¤ é•·çš„æ™‚é–“å¾Œï¼Œè¢«é‡æ–°æ´¾ç™¼åˆ°è¨­å‚™ä½‡åˆ—ï¼Œå¾è€Œå¯¦ç¾ç²¾ç¢ºçš„æµé‡æ§åˆ¶ã€‚\n","date":"September 30 2025","externalUrl":null,"permalink":"/posts/how-cgroup-io-max-work-in-block-layer/","section":"æ–‡ç« ","summary":"","title":"æ·±å…¥ Linux Kernelï¼šcgroup io.max å¦‚ä½•åœ¨ Block Layer ä¸­å¯¦ç¾ I/O é™é€Ÿ","type":"posts"},{"content":"","date":"September 30 2025","externalUrl":null,"permalink":"/tags/","section":"æ¨™ç±¤","summary":"","title":"æ¨™ç±¤","type":"tags"},{"content":"Cilium è—‰ç”± eBPF æŠ€è¡“ï¼Œå·§å¦™åœ°ç¹éäº† Linux Kernel å‚³çµ±çš„ network stack ä¾†åŠ é€Ÿå°åŒ…å‚³è¼¸ï¼Œç„¶è€Œï¼Œé€™ä¹Ÿæ„å‘³è‘—å°åŒ…çš„è™•ç†è·¯å¾‘ä¸å†æ˜¯æˆ‘å€‘æ‰€ç†Ÿæ‚‰çš„ netfilter æˆ– IPVSï¼Œå°åŒ…å¯èƒ½åœ¨æ›´æ—©çš„éšæ®µå°±è¢« Cilium æˆªç²ä¸¦è½‰ç™¼åˆ°å…¶ä»–ç¶²è·¯ä»‹é¢ï¼Œä½¿å¾—æ•´é«”çš„ç¶²è·¯è¡Œç‚ºè®Šå¾—é™Œç”Ÿä¸”é›£ä»¥è¿½è¹¤ã€‚\nå› æ­¤ï¼Œä»Šå¤©æˆ‘å€‘è¦ä¾†æ·±å…¥æ¢è¨ä¸€å€‹æ ¸å¿ƒå•é¡Œï¼šåœ¨ Cilium v1.17.3 ç‰ˆæœ¬ä¸­ï¼Œç•¶å•Ÿç”¨ kube-proxy replacement å’Œ native routing æ¨¡å¼æ™‚ï¼Œä¸€å€‹å°åŒ…å¾ç¯€é» A çš„ Pod å‡ºç™¼ï¼Œåˆ°ç¯€é» B çš„ Podï¼Œç©¶ç«Ÿæœƒç¶“éå“ªäº› eBPF ç¨‹å¼ï¼Ÿåˆæ˜¯åœ¨å“ªå€‹ç’°ç¯€ç¹éäº† kernel network stackï¼Ÿ\nç’°å¢ƒè¨­ç½® # åœ¨é–‹å§‹è¿½è¹¤å°åŒ…ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆå»ºç«‹ä¸€å€‹ç”¨æ–¼æœ¬æ¬¡åˆ†æçš„ç’°å¢ƒã€‚æˆ‘å€‘ä½¿ç”¨ kind æ­å»ºä¸€å€‹é›™ç¯€é»çš„ Kubernetes å¢é›†ï¼Œä¸¦ä¸”ç‚ºäº†è®“ Cilium å®Œå…¨æ¥ç®¡ç¶²è·¯ï¼Œéœ€è¦é—œé–‰é è¨­çš„ CNI å’Œ kube-proxyã€‚\nKind å¢é›†è¨­å®šï¼š\nkind create cluster --config - \u0026lt;\u0026lt;EOF kind: Cluster apiVersion: kind.x-k8s.io/v1alpha4 nodes: - role: control-plane - role: control-plane networking: disableDefaultCNI: true kubeProxyMode: none EOF # ç§»é™¤ control-plane çš„ taintï¼Œè®“ Pod å¯ä»¥è¢«èª¿åº¦ä¸Šå» kubectl taint nodes kind-control-plane node-role.kubernetes.io/control-plane:NoSchedule- kubectl taint nodes kind-control-plane2 node-role.kubernetes.io/control-plane:NoSchedule- Cilium Helm Values è¨­å®š (cilium.yaml)ï¼š\n# è®“ Cilium å®Œå…¨å–ä»£ kube-proxy kubeProxyReplacement: true # ä½¿ç”¨åŸç”Ÿè·¯ç”±æ¨¡å¼ï¼Œä¸é€²è¡Œå°è£ routingMode: native autoDirectNodeRoutes: true # æŒ‡å®š Pod çš„ CIDR ipv4NativeRoutingCIDR: \u0026#34;10.0.0.0/16\u0026#34; # å…¶ä»–ç›¸é—œè¨­å®š k8sServiceHost: kind-control-plane k8sServicePort: 6443 bpf: masquerade: true debug: enabled: true verbose: \u0026#34;datapath\u0026#34; å®‰è£ Ciliumï¼š\nhelm install cilium cilium/cilium --version 1.17.3 -f cilium.yaml -n kube-system ç‚ºäº†æ–¹ä¾¿å¾ŒçºŒè¨è«–ï¼Œæˆ‘å€‘å‡è¨­ç’°å¢ƒä¸­çš„ IP åˆ†é…å¦‚ä¸‹ï¼ˆå¯¦éš›ç’°å¢ƒå¯èƒ½ä¸åŒï¼‰ï¼š\nç¯€é» IP: ç¯€é» 1 (172.16.0.1/24)ï¼Œç¯€é» 2 (172.16.0.2/24) Pod CIDR: ç¯€é» 1 (10.0.1.0/24)ï¼Œç¯€é» 2 (10.0.2.0/24) cilium_host ä»‹é¢ IP: ç¯€é» 1 (10.0.1.254/24)ï¼Œç¯€é» 2 (10.0.2.254/24) Pod IP: Pod 1 (10.0.1.1)ï¼ŒPod 2 (10.0.2.1) graph BT subgraph \u0026#34;ç¯€é» 2 (Node 2)\u0026#34; direction TB Pod_2(Pod 2\u0026lt;br/\u0026gt;IP: 10.0.2.1) Cilium_Host_2(cilium_host\u0026lt;br/\u0026gt;IP: 10.0.2.254) Node_2_eth0(\u0026#34;eth0: 172.16.0.2/24\u0026#34;) Pod_2 --\u0026gt; Cilium_Host_2 Cilium_Host_2 --\u0026gt; Node_2_eth0 end subgraph \u0026#34;ç¯€é» 1 (Node 1)\u0026#34; direction TB Pod_1(Pod 1\u0026lt;br/\u0026gt;IP: 10.0.1.1) Cilium_Host_1(cilium_host\u0026lt;br/\u0026gt;IP: 10.0.1.254) Node_1_eth0(\u0026#34;eth0: 172.16.0.1/24\u0026#34;) Pod_1 --\u0026gt; Cilium_Host_1 Cilium_Host_1 --\u0026gt; Node_1_eth0 end å¾ ARP é–‹å§‹ # è®“æˆ‘å€‘å…ˆå¾ Pod 1 çš„è¦–è§’å‡ºç™¼ï¼Œçœ‹çœ‹å®ƒçš„ç¶²è·¯è¨­å®šï¼š\n# åœ¨ Pod 1 å…§åŸ·è¡Œ ip addr 6: eth0@if7: \u0026lt;...\u0026gt; inet 10.0.1.1/32 scope global eth0 # åœ¨ Pod 1 å…§åŸ·è¡Œ ip route default via 10.0.1.254 dev eth0 10.0.1.254 dev eth0 scope link å¯ä»¥çœ‹åˆ°ï¼ŒPod çš„ IP æ˜¯ä¸€å€‹ /32 çš„ä½å€ï¼Œæ‰€æœ‰çš„å°å¤–æµé‡éƒ½æœƒé€é 10.0.1.254 é€™å€‹ gatewayï¼Œä¹Ÿå°±æ˜¯ Host ä¸Šçš„ cilium_host ä»‹é¢ã€‚æ ¹æ“šæ¨™æº–çš„ Linux ç¶²è·¯è¡Œç‚ºï¼Œç•¶ Pod 1 è¦å‚³é€å°åŒ…åˆ° Pod 2 (10.0.2.1) æ™‚ï¼Œå®ƒé¦–å…ˆéœ€è¦çŸ¥é“ gateway 10.0.1.254 çš„ MAC addressã€‚å› æ­¤ï¼Œå®ƒæœƒç™¼é€ä¸€å€‹ ARP requestã€‚\næ¶ˆå¤±çš„ proxy_arp èˆ‡ eBPF ARP Responder # åœ¨ Host 1 ä¸Šï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°èˆ‡ Pod 1 eth0 é…å°çš„ veth ä»‹é¢ï¼Œä¾‹å¦‚ lxc12345ã€‚ç•¶ Pod ç™¼å‡º ARP request æ™‚ï¼Œé€™å€‹ lxc12345 ä»‹é¢æœƒå›æ‡‰è‡ªå·±çš„ MAC addressã€‚\nflowchart LR subgraph s1[\u0026#34;ç¯€é» 1 (Node 1)\u0026#34;] A[\u0026#34;cilium_host\u0026lt;br\u0026gt;10.0.1.254/32\u0026#34;] B(\u0026#34;lxc12345\u0026#34;) end subgraph s2[\u0026#34;Pod 1\u0026#34;] n1[\u0026#34;eth0\u0026lt;br\u0026gt;10.0.1.1/32\u0026#34;] end n1 -- \u0026#34;ARP Request: Who has 10.0.1.254?\u0026#34; --\u0026gt; B B -- \u0026#34;ARP Reply: It\u0026#39;s me!\u0026#34; --\u0026gt; n1 é€™å°±å¥‡æ€ªäº†ï¼Œå¾ host å¯ä»¥ç™¼ç¾ lxc12345 ä»‹é¢æœ¬èº«ä¸¦æ²’æœ‰ 10.0.1.254 é€™å€‹ IPï¼Œé‚£ä»–æ€éº¼æœƒå›æ‡‰å‘¢ï¼Ÿåœ¨å‚³çµ±çš„ CNIï¼ˆå¦‚ Calicoï¼‰ä¸­ï¼Œé€™é€šå¸¸æ˜¯é€éå•Ÿç”¨ proxy_arp ä¾†å¯¦ç¾çš„ï¼Œç•¶ä»‹é¢å•Ÿç”¨ proxy_arpï¼Œå¦‚æœè©² IP å¯å¾æœ¬åœ°è·¯ç”±åˆ°é”ï¼ŒLinux å°±æœƒå›æ‡‰æœ¬ä»‹é¢çš„ macã€‚ç„¶è€Œï¼Œç•¶æˆ‘å€‘æª¢æŸ¥ Cilium ç’°å¢ƒä¸‹çš„è¨­å®šæ™‚ï¼Œæœƒç™¼ç¾ proxy_arp ä¸¦æœªé–‹å•Ÿã€‚\ncat /proc/sys/net/ipv4/conf/*/proxy_arp # è¼¸å‡ºå…¨ç‚º 0 ç­”æ¡ˆç•¶ç„¶å°±åœ¨ eBPFã€‚Cilium é€éåœ¨ veth ä»‹é¢çš„ tc ingress hook é»æ›è¼‰ eBPF ç¨‹å¼ï¼Œå¯¦ä½œäº†ä¸€å€‹é«˜æ•ˆçš„ ARP Responderã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ bpftool ä¾†é©—è­‰ï¼Œåœ¨ lxc12345 ä»‹é¢ä¸Šæ›è¼‰äº† cil_from_container é€™å€‹ eBPF ç¨‹å¼ã€‚\né€™å€‹ç¨‹å¼çš„åŸå§‹ç¢¼ä½æ–¼ bpf/bpf_lxc.cï¼Œå…¶é‚è¼¯ç›¸ç•¶ç›´æ¥ï¼š\n// bpf/bpf_lxc.c __section_entry int cil_from_container(struct __ctx_buff *ctx) { __u16 proto; // ... switch (proto) { // ... #if defined(ENABLE_ARP_RESPONDER) case bpf_htons(ETH_P_ARP): // é‡åˆ° ARP å°åŒ…ï¼Œè·³è½‰åˆ° ARP è™•ç†ç¨‹å¼ ret = tail_call_internal(ctx, CILIUM_CALL_ARP, \u0026amp;ext_err); break; #endif // ... } } __section_tail(CILIUM_MAP_CALLS, CILIUM_CALL_ARP) int tail_handle_arp(struct __ctx_buff *ctx) { union macaddr mac = THIS_INTERFACE_MAC; // ... // ç›´æ¥ç”¨ veth ä»‹é¢è‡ªå·±çš„ MAC address å›æ‡‰ ARP request return arp_respond(ctx, \u0026amp;mac, tip, \u0026amp;smac, sip, 0); } ç•¶ä¾†è‡ª Pod çš„ ARP å°åŒ…é€²å…¥ lxc12345 ä»‹é¢æ™‚ï¼Œcil_from_container æœƒæ””æˆªå®ƒï¼Œä¸¦é€é tail_call è·³è½‰åˆ° tail_handle_arpã€‚é€™å€‹å‡½æ•¸æœƒç›´æ¥å½é€ ä¸€å€‹ ARP replyï¼Œå‘Šè¨´ Pod gateway çš„ MAC addressï¼Œé€™é‚Šé€é THIS_INTERFACE_MAC å®šç¾©ï¼Œç•¶ç„¶å°±æ˜¯ lxc12345 çš„ MAC addressã€‚æ•´å€‹éç¨‹å®Œå…¨åœ¨ eBPF ä¸­å®Œæˆï¼Œå®Œå…¨æ²’æœ‰é€²å…¥ Host çš„æ ¸å¿ƒç¶²è·¯å †ç–Šï¼Œæ¥µå¤§åœ°æå‡äº†æ•ˆç‡ã€‚\nIP å°åŒ…çš„ Egress è·¯å¾‘ # åœ¨æ‹¿åˆ° gateway çš„ MAC address å¾Œï¼ŒPod 1 çµ‚æ–¼å¯ä»¥ç™¼å‡º IP å°åŒ…äº†ã€‚é€™å€‹å°åŒ…åŒæ¨£æœƒè¢« lxc12345 ä»‹é¢ä¸Šçš„ cil_from_container ç¨‹å¼æ””æˆªã€‚\né€™æ¬¡ï¼Œå› ç‚ºå°åŒ…é¡å‹æ˜¯ ETH_P_IPï¼ŒeBPF ç¨‹å¼æœƒèµ°å¦ä¸€æ¢æ›´è¤‡é›œçš„è™•ç†è·¯å¾‘ã€‚ç¶“éä¸€ç³»åˆ—çš„ tail_callï¼ˆä¸»è¦ç”¨æ–¼è™•ç† conntrack å’Œ service è½‰è­¯ï¼‰ï¼Œæœ€çµ‚æœƒåŸ·è¡Œåˆ° handle_ipv4_from_lxc é€™å€‹æ ¸å¿ƒå‡½æ•¸ã€‚\n// bpf/bpf_lxc.c static __always_inline int handle_ipv4_from_lxc(struct __ctx_buff *ctx, ...) { // ... (Network Policy, Conntrack è™•ç†) #if defined(TUNNEL_MODE) ... #end // å› ç‚ºæˆ‘å€‘æ˜¯ native routing æ¨¡å¼ï¼Œæœƒé€²å…¥é€™å€‹ block if (is_defined(ENABLE_HOST_ROUTING)) { int oif = 0; // æ ¸å¿ƒæ­¥é©Ÿï¼šåœ¨ eBPF ä¸­æŸ¥è©¢æ ¸å¿ƒè·¯ç”±è¡¨ ret = fib_redirect_v4(ctx, ETH_HLEN, ip4, false, false, ext_err, \u0026amp;oif); // ... return ret; } // ... } handle_ipv4_from_lxc æ˜¯ä¸€å€‹é¾å¤§è€Œè¤‡é›œçš„å‡½æ•¸ï¼Œå®ƒè² è²¬åŸ·è¡Œ Egress Network Policyã€æ›´æ–° conntrack æ¢ç›®ã€è™•ç† NodePort ç­‰ã€‚åœ¨æˆ‘å€‘çš„æ¡ˆä¾‹ä¸­ï¼Œæœ€é—œéµçš„ä¸€æ­¥æ˜¯è·¯ç”±è™•ç†ã€‚å› ç‚ºæˆ‘å€‘å•Ÿç”¨äº† native routing æ¨¡å¼ï¼ŒTunnel mode çš„éƒ¨åˆ†æœƒè¢«è·³éï¼Œç¨‹å¼æœƒé€²å…¥ ENABLE_HOST_ROUTING çš„é‚è¼¯åˆ†æ”¯ï¼Œä¸¦å‘¼å« fib_redirect_v4ã€‚\né€™é‚Šæœ‰å€‹å°é™·é˜± ENABLE_HOST_ROUTING ä¸æ˜¯ native routing mode çš„æ„æ€ï¼Œè€Œæ˜¯é—œé–‰ legacy routing modeï¼Œlegacy routing mode æ˜¯èˆŠçš„ã€ä¸é€é ebpf è€Œæ˜¯äº¤çµ¦ kernel è™•ç†çš„æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘å€‘ç•¶ç„¶ä¸æœƒé–‹ã€‚\n// bpf/lib/fib.h static __always_inline int fib_redirect_v4(struct __ctx_buff *ctx, ...) { // ... // å‘¼å« bpf_fib_lookup helper function fib_result = fib_lookup_v4(ctx, \u0026amp;fib_params, ip4-\u0026gt;saddr, ip4-\u0026gt;daddr, 0); // ... // æ ¹æ“šæŸ¥è©¢çµæœï¼Œç›´æ¥é‡å°å‘å°åŒ… return fib_do_redirect(ctx, ...); } fib_lookup_v4 å…§éƒ¨æœƒå‘¼å« bpf_fib_lookup é€™å€‹ eBPF helper functionï¼Œå®ƒå…è¨± eBPF ç¨‹å¼ç›´æ¥æŸ¥è©¢ Linux æ ¸å¿ƒçš„ FIB (Forwarding Information Baseï¼Œå³è·¯ç”±è¡¨)ã€‚æŸ¥è©¢çµæœæœƒå‘Šè¨´ eBPFï¼Œè¦åˆ°é” 10.0.2.1ï¼Œæ‡‰è©²å¾ Host çš„ eth0 ä»‹é¢ç™¼å‡ºã€‚\næ¥è‘—ï¼Œfib_do_redirect æœƒå‘¼å« bpf_redirect helperï¼Œå°‡å°åŒ…ç›´æ¥å¡åˆ° eth0 ä»‹é¢çš„ egress queue ä¸­ã€‚\nè‡³æ­¤ï¼Œå°åŒ…å·²ç¶“å®Œæˆäº†åœ¨ç¯€é» 1 çš„æ—…ç¨‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¾ veth ä»‹é¢é€²ä¾†å¾Œï¼Œå°åŒ…ç¶“é eBPF è™•ç†ï¼ˆç­–ç•¥ã€è·¯ç”±ï¼‰ï¼Œç„¶å¾Œå°±è¢«ç›´æ¥é€åˆ°äº† eth0 ä»‹é¢ï¼Œå®Œå…¨ç¹éäº† Host æ ¸å¿ƒçš„ iptables/netfilter ç­‰æ•´å€‹ TCP/IP å †ç–Šã€‚é€™å°±æ˜¯ Cilium é«˜æ•ˆèƒ½çš„ç§˜å¯†ã€‚\nflowchart TD subgraph \u0026#34;Pod 1 Namespace\u0026#34; A[IP Packet Egress] end subgraph \u0026#34;Host 1 Namespace\u0026#34; B[\u0026#34;lxc12345 (veth) TC Ingress\u0026#34;] --\u0026gt; C{eBPF: cil_from_container}; C --\u0026gt; D[Egress Policy Check]; D --\u0026gt; E[Conntrack Update]; E --\u0026gt; F[eBPF FIB Lookup]; F --\u0026gt; G[\u0026#34;eth0 (physical) TC Egress\u0026#34;]; H[\u0026#34;Kernel Network Stack\u0026lt;br/\u0026gt;(iptables, ip_vs, routing)\u0026#34;] end A --\u0026gt; B; G --\u0026gt; I[To Node 2]; F -- Bypassed --\u0026gt; H; å°åŒ…æŠµé”ç¯€é» 2 # å°åŒ…ç©¿éå¯¦é«”ç¶²è·¯ï¼ŒæŠµé”ç¯€é» 2 çš„ eth0 ä»‹é¢ï¼Œè§¸ç™¼äº†æ›è¼‰åœ¨ eth0 ä¸Šçš„ tc ingress eBPF ç¨‹å¼ cil_from_netdevã€‚\n// bpf/bpf_host.c __section_entry int cil_from_netdev(struct __ctx_buff *ctx) { // ... // ç¶“éä¸€ç³»åˆ— tail_call è™•ç† conntrack // æœ€çµ‚æœƒå‘¼å«åˆ° handle_ipv4_cont // ... } é€™å€‹ç¨‹å¼çš„è™•ç†æµç¨‹èˆ‡ egress è·¯å¾‘é¡ä¼¼ï¼Œç¶“éä¸€ç³»åˆ— conntrack æª¢æŸ¥å¾Œï¼Œæœƒå‘¼å«åˆ° handle_ipv4_contã€‚\n// bpf/bpf_host.c static __always_inline int handle_ipv4_cont(struct __ctx_buff *ctx, ...) { // ... // æŸ¥è©¢ç›®çš„ IP æ˜¯å¦ç‚ºæœ¬æ©Ÿçš„ endpoint ep = lookup_ip4_endpoint(ip4); if (ep) { // æ˜¯æœ¬æ©Ÿ Podï¼Œé€²è¡Œæœ¬åœ°äº¤ä»˜ return ipv4_local_delivery(ctx, ...); } // ... } lookup_ip4_endpoint æœƒåœ¨ BPF Map (cilium_lxc) ä¸­æŸ¥è©¢ç›®çš„ IP 10.0.2.1ã€‚å› ç‚ºé€™å€‹ IP å±¬æ–¼ç¯€é» 2 ä¸Šçš„ Pod 2ï¼ŒæŸ¥è©¢æœƒæˆåŠŸï¼Œä¸¦å›å‚³ Pod 2 çš„ endpoint è³‡è¨Šã€‚æ¥è‘—ï¼Œç¨‹å¼æœƒå‘¼å« ipv4_local_deliveryã€‚\nå·§å¦™çš„è·³è½‰ï¼štail_call_policy # ipv4_local_delivery è£¡æœ‰ä¸€å€‹éå¸¸å·§å¦™çš„è¨­è¨ˆï¼Œå®ƒä¸¦ä¸æ˜¯ç›´æ¥è½‰ç™¼å°åŒ…ï¼Œè€Œæ˜¯é€²è¡Œäº†ä¸€æ¬¡ç‰¹æ®Šçš„ tail_call\n// bpf/lib/l3.h static __always_inline int ipv4_local_delivery(struct __ctx_buff *ctx, ...) { // ... // è·³è½‰åˆ°ç›®æ¨™ Pod å°æ‡‰çš„ eBPF ç¨‹å¼ä¾†åŸ·è¡Œ Ingress Policy ret = tail_call_policy(ctx, ep-\u0026gt;lxc_id); // ... } tail_call_policy æœƒæ ¹æ“š Pod 2 çš„ endpoint IDï¼Œå¾ä¸€å€‹ç‰¹æ®Šçš„ BPF map (cilium_call_policy) ä¸­æ‰¾åˆ°èˆ‡ Pod 2 veth ä»‹é¢ï¼ˆä¾‹å¦‚ lxc67890ï¼‰é—œè¯çš„ cil_lxc_policy (bpf/bpf_lxc.c) eBPF ç¨‹å¼ï¼Œä¸¦å°‡åŸ·è¡Œæ¬Šè·³è½‰éå»ã€‚\n// bpf/bpf_lxc.c /* * è™•ç†é€²å…¥ endpoint çš„å°åŒ…çš„ policy æ±ºç­–... * é€™å€‹ç¨‹å¼æœƒè¢« bpf_host, bpf_overlay, æˆ– bpf_lxc ä¸­çš„ * ipv{4,6}_local_delivery é€é tail call å‘¼å«ã€‚ */ __section_entry int cil_lxc_policy(struct __ctx_buff *ctx) { // ... switch (proto) { #ifdef ENABLE_IPV4 case bpf_htons(ETH_P_IP): // é€²è¡Œ conntrack æŸ¥è©¢å¾Œï¼Œå† tail call åˆ° tail_ipv4_policy ret = invoke_tailcall_if(..., CILIUM_CALL_IPV4_CT_INGRESS_POLICY_ONLY, tail_ipv4_ct_ingress_policy_only, \u0026amp;ext_err); break; #endif // ... } } cil_lxc_policyÂ æ˜¯æœƒè™•ç†æº–å‚™é€²å…¥æœ¬åœ° Pod æµé‡çš„ï¼Œæ ¹æ“šå°åŒ…å”å®šï¼ˆIPv4/IPv6ï¼‰ï¼Œå…ˆé€²è¡Œ conntrack æŸ¥è©¢ï¼Œç„¶å¾Œå†å°‡å°åŒ…Â tail_callÂ çµ¦çœŸæ­£çš„ç­–ç•¥è™•ç†å‡½æ•¸Â tail_ipv4_policyã€‚\ntail_ipv4_policyÂ æ±ºå®šæ˜¯å¦å°‡å°åŒ…äº¤ä»˜çµ¦ç›®æ¨™ Podã€‚\n// bpf/bpf_lxc.c __declare_tail(CILIUM_CALL_IPV4_TO_LXC_POLICY_ONLY) static __always_inline int tail_ipv4_policy(struct __ctx_buff *ctx) { // ... // å‘¼å« ipv4_policy åŸ·è¡Œ Ingress ç­–ç•¥æª¢æŸ¥ ret = ipv4_policy(ctx, ip4, src_label, \u0026amp;tuple, \u0026amp;ext_err, \u0026amp;proxy_port, from_tunnel); switch (ret) { // ... case CTX_ACT_OK: // ç­–ç•¥å…è¨±é€šé if (do_redirect) // å‘¼å« redirect_ep é€²è¡Œæœ€çµ‚çš„å°åŒ…é‡å°å‘ ret = redirect_ep(ctx, THIS_INTERFACE_IFINDEX, from_host, from_tunnel); break; // ... } // ... } ipv4_policyÂ æ ¹æ“šä¾†æº Pod çš„ security identity å’Œç›®æ¨™ Pod çš„ identityï¼Œæª¢æŸ¥ Ingress ç­–ç•¥æ˜¯å¦å…è¨±æ­¤æµé‡ï¼Œä»¥åŠæ˜¯å¦éœ€è¦é‡å°å‘åˆ° L7 proxy (envoy)ã€‚\nå°æˆ‘å€‘è€Œè¨€ï¼Œç¨‹å¼æœƒå‘¼å«Â redirect_epÂ å‡½æ•¸ä¾†é‡å°å‘å°åŒ…ï¼Œå®ƒå…§éƒ¨ä½¿ç”¨ bpf_redirect_peer é€™å€‹ç‰¹æ®Šçš„ helper functionï¼Œå°‡å°åŒ…ç›´æ¥é€é€² veth pair çš„å¦ä¸€ç«¯ï¼Œä¹Ÿå°±æ˜¯ Pod 2 å…§çš„ eth0 ä»‹é¢ã€‚\n// bpf/lib/lxc.h static __always_inline int redirect_ep(struct __ctx_buff *ctx, ...) { ... // ä½¿ç”¨ bpf_redirect_peer é€²è¡Œè·¨ namespace çš„é«˜æ•ˆé‡å°å‘ return ctx_redirect_peer(ctx, ifindex, 0); } bpf_redirect_peer çš„å¼·å¤§ä¹‹è™•åœ¨æ–¼ï¼Œå®ƒå¯ä»¥è·¨ network namespace å‚³éå°åŒ…ï¼Œå¾¹åº•ç¹éäº† veth é©…å‹•å±¤å’Œæ ¸å¿ƒçš„è·¯ç”±æ±ºç­–ã€‚\nflowchart TD subgraph \u0026#34;ç¯€é» 2 (Node 2)\u0026#34; A[eth0 Ingress] --\u0026gt; B{eBPF: cil_from_netdev}; B --\u0026gt; C{Is Dest local EP?}; C -- Yes --\u0026gt; D[\u0026#34;tail_call_policy\u0026lt;br/\u0026gt;(Jump to cil_lxc_policy)\u0026#34;]; D --\u0026gt; E{eBPF: cil_lxc_policy}; E --\u0026gt; F[\u0026#34;Ingress Policy Check\u0026lt;br/\u0026gt;(in tail_ipv4_policy)\u0026#34;]; F -- Allowed --\u0026gt; G[redirect_ep]; G -- bpf_redirect_peer --\u0026gt; H[Pod 2 eth0 Ingress]; I[\u0026#34;Kernel Network Stack\u0026lt;br/\u0026gt;(iptables, ip_vs, routing)\u0026#34;] end C -- Bypassed --\u0026gt; I; ç¸½çµ # é€éé€™æ¬¡çš„è¿½è¹¤ï¼Œæˆ‘å€‘æ­é–‹äº† Cilium åœ¨ native routing æ¨¡å¼ä¸‹è·¨ç¯€é»é€šè¨Šçš„ç¥ç¥•é¢ç´—ã€‚å…¶æ ¸å¿ƒæ˜¯åˆ©ç”¨ eBPF åœ¨ç¶²è·¯è·¯å¾‘çš„é—œéµç¯€é»ï¼ˆtc ingress/egressï¼‰é€²è¡Œæ””æˆªå’Œè™•ç†ï¼Œå¯¦ç¾äº†ä¸€æ¢ç¹éæ ¸å¿ƒç¶²è·¯å †ç–Šçš„å¿«é€Ÿè·¯å¾‘ï¼š\né«˜æ•ˆ ARPï¼šPod ç™¼å‡ºçš„ ARP request ç”± eBPF ç›´æ¥å›æ‡‰ã€‚ Egress æ ¸å¿ƒç¹é“ï¼šåœ¨ä¾†æºç¯€é»ï¼ŒeBPF ç¨‹å¼åœ¨åŸ·è¡Œå®Œç­–ç•¥å¾Œï¼Œç›´æ¥æŸ¥è©¢æ ¸å¿ƒè·¯ç”±è¡¨ï¼ˆFIBï¼‰ï¼Œä¸¦é€é bpf_redirect å°‡å°åŒ…é€è‡³å¯¦é«”ç¶²å¡ï¼Œå®Œå…¨ç¹é iptables ã€‚ Ingress æ ¸å¿ƒç¹é“ï¼šåœ¨ç›®çš„ç¯€é»ï¼ŒeBPF ç¨‹å¼è­˜åˆ¥å‡ºæœ¬åœ° Pod æµé‡å¾Œï¼Œé€é tail_call æ©Ÿåˆ¶è·³è½‰åˆ°å°æ‡‰ Pod çš„ç­–ç•¥ç¨‹å¼ï¼Œä¸¦æœ€çµ‚ä½¿ç”¨ bpf_redirect_peer è·¨ namespace å°‡å°åŒ…ç›´æ¥æ³¨å…¥ Podï¼Œå†æ¬¡ç¹éäº†æ ¸å¿ƒç¶²è·¯å †ç–ŠåŠ veth driverã€‚ æ­£æ˜¯é€™ä¸€ç³»åˆ—ç²¾å·§çš„ eBPF è¨­è¨ˆï¼Œè®“ Cilium æä¾›æ¥µè‡´çš„ç¶²è·¯æ•ˆèƒ½ã€‚å¸Œæœ›é€™ç¯‡æ–‡ç« èƒ½å¹«åŠ©ä½ æ›´æ·±å…¥åœ°ç†è§£ Cilium çš„é‹ä½œåŸç†ã€‚\n","date":"August 23 2025","externalUrl":null,"permalink":"/posts/how-cilium-transfer-packet-between-nodes-with-native-route/","section":"æ–‡ç« ","summary":"","title":"Cilium è·¨ç¯€é» Pod to Pod å°åŒ…å‚³è¼¸è·¯å¾‘è§£æ","type":"posts"},{"content":"","date":"August 23 2025","externalUrl":null,"permalink":"/tags/cni/","section":"æ¨™ç±¤","summary":"","title":"CNI","type":"tags"},{"content":"","date":"August 23 2025","externalUrl":null,"permalink":"/tags/ebpf/","section":"æ¨™ç±¤","summary":"","title":"EBPF","type":"tags"},{"content":"","date":"August 23 2025","externalUrl":null,"permalink":"/tags/kubernetes/","section":"æ¨™ç±¤","summary":"","title":"Kubernetes","type":"tags"},{"content":"","date":"August 23 2025","externalUrl":null,"permalink":"/categories/kubernetes/","section":"åˆ†é¡","summary":"","title":"Kubernetes","type":"categories"},{"content":"","date":"June 28 2025","externalUrl":null,"permalink":"/tags/https/","section":"æ¨™ç±¤","summary":"","title":"HTTPS","type":"tags"},{"content":"","date":"June 28 2025","externalUrl":null,"permalink":"/tags/tls/","section":"æ¨™ç±¤","summary":"","title":"TLS","type":"tags"},{"content":" åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Šææ‡‚æ•¸ä½æ†‘è­‰ï¼šæª”æ¡ˆæ ¼å¼ã€ç°½ç½²èˆ‡é©—è­‰æµç¨‹ã€‹ä¸­ï¼Œæˆ‘å€‘æ¢è¨äº†æ•¸ä½æ†‘è­‰çš„åŸºç¤ã€‚æœ¬æ–‡å°‡ä»¥æ­¤ç‚ºåŸºç¤ï¼Œæ¥è‘—å­¸ç¿’ TLS 1.2 çš„é‹ä½œåŸç†ï¼Œç‚ºå¾ŒçºŒç†è§£ TLS 1.3 çš„æ¼”é€²åšå¥½æº–å‚™ã€‚é€™ç¯‡ä¸»è¦é›†ä¸­åœ¨æ¦‚å¿µå’Œæ¶æ§‹ä¸Šï¼Œä¸æœƒéå¤šè¨è«–å¯†ç¢¼å­¸çš„å…§å®¹ã€‚\nå‰è¨€ # TLS å”å®šçš„æ ¸å¿ƒç›®æ¨™ä¹‹ä¸€ï¼Œæ˜¯è®“å®¢æˆ¶ç«¯ï¼ˆClientï¼‰èˆ‡ä¼ºæœå™¨ç«¯ï¼ˆServerï¼‰åœ¨ä¸å®‰å…¨çš„ç¶²è·¯ä¸Šï¼Œèƒ½å¤ å”å•†å‡ºä¸€çµ„å…±ç”¨çš„å°ç¨±é‡‘é‘°ï¼Œé€™å€‹éç¨‹ç¨±ç‚ºé‡‘é‘°äº¤æ›ï¼ˆKey Exchangeï¼‰ã€‚ä¸€æ—¦é‡‘é‘°äº¤æ›å®Œæˆï¼Œå¾ŒçºŒçš„é€šè¨Šå°±èƒ½ä½¿ç”¨é€™çµ„é‡‘é‘°ï¼Œé€é AES ç­‰è¼ƒé«˜æ•ˆç‡çš„å°ç¨±åŠ å¯†æ¼”ç®—æ³•ä¾†åŠ å¯†å‚³è¼¸å…§å®¹ã€‚åœ¨ TLS æ¶æ§‹ä¸­ï¼Œé€™å€‹äº¤æ›çš„é‡‘é‘°è¢«ç¨±ç‚º premaster secretã€‚\npremaster secret ä¸¦ä¸æœƒç›´æ¥ç”¨æ–¼åŠ å¯†é€šè¨Šæµé‡ã€‚å®ƒæœƒèˆ‡å®¢æˆ¶ç«¯åŠä¼ºæœå™¨äº¤æ›çš„éš¨æ©Ÿæ•¸ï¼ˆrandomsï¼‰çµåˆï¼Œç¶“éä¸€å€‹å½éš¨æ©Ÿå‡½æ•¸ï¼ˆPseudorandom Function, PRFï¼‰çš„é‹ç®—ï¼Œè¡ç”Ÿå‡ºçœŸæ­£çš„ master secretã€‚è€Œ master secret ä¹Ÿéç›´æ¥ä½¿ç”¨ï¼Œå®ƒæœƒå†é€é PRF è¡ç”Ÿå‡ºå¤šçµ„æœƒè©±é‡‘é‘°ï¼ˆsession keysï¼‰ï¼Œé€™äº›é‡‘é‘°æ‰æœƒå¯¦éš›ç”¨æ–¼åŠ å¯†èˆ‡é©—è­‰è³‡æ–™çš„å®Œæ•´æ€§ã€‚ä¸é master secret å°±ä¸åœ¨é€™ç¯‡æ–‡ç« çš„è¨è«–ç¯„åœäº†ã€‚\nmaster_secret = PRF(pre_master_secret, \u0026#34;master secret\u0026#34;, ClientHello.random + ServerHello.random) [0..47]; æˆ‘å€‘æœƒå…ˆä»‹ç´¹ TLS é‡‘é‘°äº¤æ›çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç„¶å¾Œäº†è§£å®Œæ•´çš„ TLS 1.2 æ¡æ‰‹æµç¨‹ã€‚\né‡‘é‘°äº¤æ›æ–¹å¼ # 1. RSA é‡‘é‘°äº¤æ› # è®“æˆ‘å€‘å¾ç¶“å…¸çš„ RSA æ¼”ç®—æ³•ä¾†ä»‹ç´¹é‡‘é‘°äº¤æ›çš„æ–¹å¼ã€‚RSA é‡‘é‘°äº¤æ›çš„æµç¨‹æ¦‚å¿µå¦‚ä¸‹ï¼š\nsequenceDiagram participant Client participant Server Note left of Client: ç”¢ç”Ÿ premaster secret ğŸ¤«Â Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: é€£ç·šå•Ÿå‹•æ¡æ‰‹ Server-\u0026gt;\u0026gt;Client: å›å‚³ ğŸ”‘ RSA æ†‘è­‰å…¬é‘° Client-\u0026gt;\u0026gt;Server: å‚³é€ ğŸ”’[premaster secret]\u0026lt;br/\u0026gt;ï¼ˆç”¨ RSA æ†‘è­‰å…¬é‘°åŠ å¯†ï¼‰ Note right of Server: ç”¨ ğŸ”‘ ç§é‘° è§£å¯†ç²å¾— premaster secret Client ç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿçš„ premaster secretã€‚ Client å¾ Server çš„æ†‘è­‰ä¸­å–å¾—å…¬é‘°ã€‚ Client ä½¿ç”¨è©²å…¬é‘°å°‡ premaster secret åŠ å¯†å¾Œå‚³é€çµ¦ Serverã€‚ Server ä½¿ç”¨è‡ªå·±çš„ç§é‘°è§£å¯†ï¼Œå–å¾— premaster secretã€‚ æ†‘è­‰ç¢ºä¿äº†å…¬é‘°çš„åˆæ³•æ€§ï¼Œä»¥é˜²æ­¢ä¸­é–“äººæ”»æ“Šã€‚ç„¶è€Œï¼Œå®ƒå­˜åœ¨ä¸€å€‹è‡´å‘½ç¼ºé™·ï¼šç¼ºä¹å‘å‰ä¿å¯†æ€§ï¼ˆForward Secrecyï¼‰ã€‚\nå› ç‚ºåŠ å¯† premaster secret çš„æ˜¯æ†‘è­‰ä¸­çš„é•·æœŸå…¬é‘°ï¼Œä¸€æ—¦ä¼ºæœå™¨çš„ç§é‘°åœ¨æœªä¾†æŸå€‹æ™‚é–“é»å¤–æ´©ï¼Œæ”»æ“Šè€…ä¾¿èƒ½è§£å¯†æ‰€æœ‰éå»æ””æˆªåˆ°çš„ TLS æµé‡ï¼Œé‚„åŸå‡º premaster secretï¼Œé€²è€Œç ´è§£æ‰€æœ‰æ­·å²é€šè¨Šå…§å®¹ã€‚\nRSA å¯ä»¥æ‡‰ç”¨åœ¨åŠ å¯†ï¼Œæ•¸ä½ç°½ç« ç­‰ä¸åŒé ˜åŸŸï¼Œæ ¹æ“šåŠŸèƒ½å’Œå…·é«”è¨ˆç®—å…¬å¼æœ‰ä¸åŒçš„ç¨®é¡ã€‚ åœ¨ RFC 3447ï¼ˆPKCS #1ï¼‰ä¸­è¦ç¯„äº†å…¶åŠ å¯†èˆ‡æ•¸ä½ç°½ç« çš„å…·é«”ç”¨æ³•ã€‚åŠ å¯†æ–¹æ¡ˆç¨±ç‚º RSAESï¼ˆå¦‚ RSAES-OAEPã€RSAES-PKCS1-v1_5ï¼‰ï¼Œæ•¸ä½ç°½ç« æ–¹æ¡ˆç¨±ç‚º RSASSAï¼ˆå¦‚ RSASSA-PSSã€RSASSA-PKCS1-v1_5ï¼‰ã€‚å®ƒå€‘çš„ä¸»è¦å·®ç•°åœ¨æ–¼å°åŸå§‹è³‡æ–™çš„å¡«å……ï¼ˆpaddingï¼‰èˆ‡åŠ é¹½ï¼ˆsaltingï¼‰è¨­è¨ˆï¼Œå…¶ä¸­ RSAES-OAEP å’Œ RSASSA-PSS æ˜¯è¼ƒæ–°ä¸”æ›´å®‰å…¨çš„é¸æ“‡ã€‚\ngraph LR A[RSA] --\u0026gt; B{æ‡‰ç”¨é ˜åŸŸ}; B --\u0026gt; C1[åŠ å¯†ï¼šRSAES]; B --\u0026gt; D1[æ•¸ä½ç°½ç« ï¼šRSASSA]; C1 --\u0026gt; C1_1[RSAES-OAEP\u0026lt;br/\u0026gt;è¼ƒæ–°ä¸”æ›´å®‰å…¨]; C1 --\u0026gt; C1_2[RSAES-PKCS1-v1_5]; D1 --\u0026gt; D1_1[RSASSA-PSS\u0026lt;br/\u0026gt;è¼ƒæ–°ä¸”æ›´å®‰å…¨]; D1 --\u0026gt; D1_2[RSASSA-PKCS1-v1_5]; å¦‚æœå»æŸ¥é–± RSA å’Œå…¶ä»–éå°ç¨±åŠ å¯†æ¼”ç®—æ³•çš„å¯¦ä½œç´°ç¯€ï¼Œæœƒç™¼ç¾å…¬é‘°å’Œç§é‘°å¯¦éš›ä¸Šä¸¦ä¸åªæ˜¯å–®ä¸€å€‹æ•¸å­—ï¼Œè€Œæ˜¯ç”±å…©åˆ°ä¸‰å€‹æ•¸å€¼æ‰€æ§‹æˆã€‚ä¾‹å¦‚ï¼Œåœ¨ RSA åŠ å¯†æ¼”ç®—æ³• - ç¶­åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨æ›¸ ä¸­æŒ‡å‡ºï¼ŒRSA å…¬é‘°ç”± \\(\\displaystyle (N,e)\\) çµ„æˆï¼Œè€Œç§é‘°å‰‡æ˜¯ \\(\\displaystyle (N,d)\\)ã€‚æˆ‘å€‘å¹³å¸¸ä½¿ç”¨çš„ä¸€é•·ä¸² public key èˆ‡ private keyï¼Œå¯¦éš›ä¸Šå°±æ˜¯å°‡é€™äº›æ•¸å€¼ç¶“é ASN.1/DER ç·¨ç¢¼å¾Œçš„çµæœã€‚å› æ­¤ï¼Œåœ¨è§£æé€™äº›é‡‘é‘°æª”æ¡ˆæ™‚ï¼Œæœƒçœ‹åˆ°çµæ§‹åŒ–çš„æ¬„ä½å°æ‡‰ä¸Šè¿°æ•¸å€¼ï¼Œè€Œä¸æ˜¯å–®ä¸€çš„ç´”é‡å€¼ã€‚\n2. è‡¨æ™‚é‡‘é‘°äº¤æ›ï¼ˆEphemeral Key Exchangeï¼‰ # ç‚ºäº†å¯¦ç¾å‘å‰ä¿å¯†æ€§ï¼ŒTLS å¼•å…¥äº†è‡¨æ™‚é‡‘é‘°äº¤æ›æ©Ÿåˆ¶ã€‚å³ä½¿æ†‘è­‰çš„ç§é‘°å¤–æ´©ï¼Œéå»çš„é€šè¨Šå…§å®¹ä¾ç„¶å®‰å…¨ã€‚é€™é¡æ©Ÿåˆ¶çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ˜¯å°‡ä¼ºæœå™¨èº«ä»½é©—è­‰èˆ‡é‡‘é‘°äº¤æ›çš„å…¬ç§é‘°åˆ†é›¢ã€‚\nä½†åœ¨é€™ä¹‹å‰è¦ä»‹ç´¹è¿ªè² - èµ«çˆ¾æ›¼é‡‘é‘°äº¤æ› (Diffieâ€“Hellman key exchange, DHï¼‰æ¼”ç®—æ³•ï¼Œé€™æ˜¯æœ‰åˆ¥æ–¼ RSA çš„å¦ä¸€å¥—å°ˆé–€ç”¨æ–¼é‡‘é‘°äº¤æ›çš„æ¼”ç®—æ³•ã€‚åœ¨åŸºæ–¼ DH çš„ TLS æ¡æ‰‹éç¨‹ä¸­ï¼š\nsequenceDiagram participant Client participant Server Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: é€£ç·šå•Ÿå‹•æ¡æ‰‹ Client-\u0026gt;\u0026gt;Server: ç™¼é€ Client å…¬é‘° ğŸ–¥ï¸ ğŸ”‘ Server-\u0026gt;\u0026gt;Client: ç™¼é€ Server å…¬é‘° â˜ï¸ ğŸ”‘ Note left of Client: æŒæœ‰ Client ç§é‘° ğŸ–¥ï¸ ğŸ¤« Note right of Server: æŒæœ‰ Server ç§é‘° â˜ï¸ ğŸ¤« Note right of Client: Client ç§é‘° ğŸ–¥ï¸ ğŸ¤« \u0026#43; Server å…¬é‘° â˜ï¸ ğŸ”‘ = Premaster Secret ğŸ¤« Note left of Server: Client å…¬é‘° ğŸ–¥ï¸ ğŸ”‘ \u0026#43; Server ç§é‘° â˜ï¸ ğŸ¤« = Premaster Secret ğŸ¤« é›™æ–¹äº¤æ›å½¼æ­¤çš„ DH å…¬é‘°ã€‚ é›™æ–¹å°‡è‡ªå·±çš„ DH ç§é‘°èˆ‡å°æ–¹çš„ DH å…¬é‘°é€é DH æ¼”ç®—æ³•ï¼Œå„è‡ªç¨ç«‹è¨ˆç®—å‡ºå®Œå…¨ç›¸åŒçš„ premaster secretã€‚ ä¸é DH ä¸»è¦æ˜¯åœ¨æ•¸å­¸è¨ˆç®—ä»¥åŠé›™æ–¹åŒæ™‚äº¤æ›é€™é»ä¸Šèˆ‡ RSA ä¸åŒã€‚å¦‚æœä¾èˆŠä½¿ç”¨å›ºå®šæ†‘è­‰ï¼Œé‚„æ˜¯æœƒç¼ºä¹å‘å‰ä¿å¯†æ€§ã€‚å› æ­¤æ›´å¸¸ç”¨çš„æ˜¯ DH çš„è®Šé«” DHEï¼ˆD-H Ephemeralï¼‰ã€‚\nflowchart LR subgraph s1[\u0026#34;ä¼ºæœå™¨ç«¯\u0026#34;] S1[\u0026#34;è‡¨æ™‚ DH å…¬é‘°\u0026#34;] S0[\u0026#34;è‡¨æ™‚ DH ç§é‘°\u0026#34;] S2[\u0026#34;æ†‘è­‰ç§é‘°\u0026#34;] S3[\u0026#34;DHå…¬é‘°\u0026#43;æ†‘è­‰å…¬é‘°\u0026#34;] end S0 -- ç”Ÿæˆ ---\u0026gt; S1 S2 -- ç°½ç½² ---\u0026gt; S1 S1 ---\u0026gt; S3 S3 ---\u0026gt; å®¢æˆ¶ç«¯[\u0026#34;å®¢æˆ¶ç«¯\u0026#34;] n1[\u0026#34;æ†‘è­‰éˆ\u0026#34;] -- é©—è­‰ --\u0026gt; S3 åœ¨ DHE éç¨‹ä¸­ï¼Œäº¤æ›çš„ä¸æ˜¯é•·æœŸä¿å­˜çš„æ†‘è­‰ï¼Œè€Œæ˜¯è‡¨æ™‚ç”Ÿæˆå‡ºä¾†çš„ DH å…¬ç§é‘°ã€‚ä¼ºæœå™¨æœƒä½¿ç”¨æ†‘è­‰ä¸­çš„ç§é‘°å°å…¶è‡¨æ™‚ç”Ÿæˆçš„ DH å…¬é‘°é€²è¡Œæ•¸ä½ç°½ç« ï¼Œç„¶å¾Œå°‡ç°½ç« èˆ‡ DH å…¬é‘°ä¸€ä½µå‚³çµ¦å®¢æˆ¶ç«¯ã€‚å®¢æˆ¶ç«¯å‰‡ä½¿ç”¨æ†‘è­‰ä¸­çš„å…¬é‘°ä¾†é©—è­‰ç°½ç« ï¼Œç¢ºä¿é€™å€‹è‡¨æ™‚çš„ DH å…¬é‘°ç¢ºå¯¦ä¾†è‡ªåˆæ³•çš„ä¼ºæœå™¨ï¼Œå¾è€Œé˜²å µä¸­é–“äººæ”»æ“Šã€‚\nç”±æ–¼ç”¨æ–¼é‡‘é‘°äº¤æ›çš„ DH é‡‘é‘°æ˜¯è‡¨æ™‚çš„ï¼Œé€£ç·šçµæŸå¾Œå³è¢«éŠ·æ¯€ï¼Œå› æ­¤å°±ç®—æœªä¾†ç°½ç½²æ•¸ä½ç°½ç« ç”¨çš„æ†‘è­‰çš„ç§é‘°å¤–æ´©ï¼Œä¹Ÿç„¡æ³•é‚„åŸå‡ºä»»ä½• premaster secretï¼Œé€™å°±å¯¦ç¾äº†å‘å‰ä¿å¯†æ€§ã€‚\n3. æ©¢åœ“æ›²ç·šå¯†ç¢¼å­¸ï¼ˆElliptic Curve Cryptography, ECCï¼‰ # ECC æ˜¯é‡‘é‘°äº¤æ›ä¸­å¸¸ç”¨çš„æŠ€è¡“ï¼Œèˆ‡ RSAã€DH çš„æŠ€è¡“å·®ç•°åœ¨æ–¼å…¶åº•å±¤çš„æ•¸å­¸åŸç†ï¼šRSA å’Œ DH çš„å®‰å…¨æ€§åŸºæ–¼å¤§è³ªæ•¸å› å¼åˆ†è§£çš„å›°é›£åº¦ï¼Œè€Œ ECC å‰‡å»ºç«‹åœ¨æ©¢åœ“æ›²ç·šä¸Šçš„é›¢æ•£å°æ•¸å•é¡Œã€‚\næˆ‘å€‘ç„¡éœ€æ·±å…¥æ¢è¨è¤‡é›œçš„æ•¸å­¸åŸç†ï¼Œä½†éœ€è¦äº†è§£ ECC å¸¶ä¾†çš„é¡¯è‘—å„ªå‹¢ï¼š\næ›´é«˜æ•ˆç‡ï¼šåœ¨ç›¸åŒçš„å®‰å…¨ç­‰ç´šä¸‹ï¼ŒECC çš„åŠ è§£å¯†é‹ç®—é€Ÿåº¦æ›´å¿«ã€‚ æ›´çŸ­é‡‘é‘°ï¼šECC èƒ½ç”¨æ¯” RSA çŸ­å¾—å¤šçš„é‡‘é‘°é•·åº¦ï¼Œé”åˆ°åŒç­‰çš„å®‰å…¨å¼·åº¦ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹ 256 ä½å…ƒçš„ ECC é‡‘é‘°æä¾›çš„å®‰å…¨æ€§ç´„ç­‰æ–¼ä¸€å€‹ 3072 ä½å…ƒçš„ RSA é‡‘é‘°ã€‚ é€™ä½¿å¾— ECC ç‰¹åˆ¥é©åˆé‹ç®—èƒ½åŠ›æœ‰é™çš„è¨­å‚™ï¼Œå¦‚è¡Œå‹•è£ç½®å’Œç‰©è¯ç¶²è£ç½®ã€‚ç„¶è€Œä½œç‚ºè¼ƒæ–°çš„æŠ€è¡“ï¼Œå®ƒåœ¨å°èˆŠç³»çµ±çš„å…¼å®¹æ€§ä¸Šï¼Œç›¸è¼ƒæ–¼ RSA ä»æœ‰ä¸è¶³ã€‚\nåœ¨ TLS ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨çš„æ˜¯ ECDHEï¼Œä¹Ÿå°±æ˜¯åŸºæ–¼ DHE æµç¨‹ï¼Œä½†æ˜¯ä½¿ç”¨ ECC å–ä»£åŸºç¤å…¬å¼ã€‚\nECC åŸºæ–¼æ©¢åœ“æ›²ç·šï¼Œå®ƒåŒ…å«äº†ä¸€ç³»åˆ—æ¨™æº–åŒ–çš„ã€Œæ›²ç·šã€ï¼ˆå¦‚ secp256r1 (P-256), secp384r1ï¼‰ï¼Œä¸åŒçš„æ›²ç·šåœ¨å®‰å…¨æ€§ã€æ•ˆç‡ä¸Šå„æœ‰å´é‡ã€‚\nå¦å¤–ï¼Œç•¶ ECC ç”¨æ–¼å¯¦ç¾æ•¸ä½ç°½ç« æ™‚ï¼Œå…¶æ¼”ç®—æ³•ç¨±ç‚º ECDSAï¼ˆElliptic Curve Digital Signature Algorithmï¼‰ï¼Œæ‰®æ¼”è‘—èˆ‡ RSA ä¸­çš„ RSASSA ç›¸åŒçš„è§’è‰²ã€‚\né †å¸¶ä¸€æï¼Œå¦ä¸€å€‹å¸¸è¦‹çš„æ•¸ä½ç°½ç« æ¨™æº–æ˜¯ DSAï¼ˆDigital Signature Algorithmï¼‰ï¼Œå®ƒèˆ‡ RSA/ECDSA ä¸¦åˆ—ï¼Œä½†åŸºæ–¼ä¸åŒçš„æ•¸å­¸åŸç†ã€‚\nTLS ä¸­å¸¸è¦‹é‡‘é‘°äº¤æ›æ–¹æ³•é—œä¿‚åœ– # graph LR A[TLS Key Exchange] --\u0026gt; cert(æ†‘è­‰å…¬ç§é‘°åŠ å¯†äº¤æ›) A --\u0026gt; ephemeral(è‡¨æ™‚å…¬ç§é‘°äº¤æ›) cert --\u0026gt; RSA cert --\u0026gt; DH cert --\u0026gt; ECDH ephemeral --\u0026gt; DHE ephemeral --\u0026gt; ECDHE RSA --\u0026gt; P[å¤§è³ªæ•¸å› å¼åˆ†è§£] DH --\u0026gt; P DHE --\u0026gt; P ECDH --\u0026gt; ECC[æ©¢åœ“æ›²ç·š] ECDHE --\u0026gt; ECC subgraph æ–¹æ³• cert ephemeral end subgraph \u0026#34;å”å®š(æ¼”ç®—æ³•)\u0026#34; RSA DH DHE ECDH ECDHE end subgraph \u0026#34;æ•¸å­¸åŸç†\u0026#34; P ECC end è¨Šæ¯é©—è­‰ç¢¼ï¼šç¢ºä¿è³‡æ–™çš„å®Œæ•´æ€§ # é™¤äº†åŠ å¯†ï¼ŒTLS çš„å¦ä¸€å¤§åŠŸèƒ½æ˜¯ç¢ºä¿è³‡æ–™åœ¨å‚³è¼¸éç¨‹ä¸­æœªè¢«ç«„æ”¹ã€‚ç‚ºæ­¤ï¼Œæˆ‘å€‘éœ€è¦é™„åŠ ä¸€å€‹è¨Šæ¯é©—è­‰ç¢¼ï¼ˆMessage Authentication Code, MACï¼‰ä¾†å¯¦ç¾ã€‚\nTLS 1.2 ä½¿ç”¨ HMACï¼ˆHash-based Message Authentication Codeï¼‰ï¼Œå®ƒæ˜¯ä¸€ç¨®å¸¶æœ‰é‡‘é‘°çš„é›œæ¹Šå‡½æ•¸ã€‚ç°¡å–®ä¾†èªªï¼ŒHMAC æœƒå°‡é‡‘é‘°èˆ‡åŸå§‹è¨Šæ¯çµåˆï¼Œé€²è¡Œä¸€ç³»åˆ—é‹ç®—å’Œé›œæ¹Šã€‚æ¥æ”¶æ–¹ä½¿ç”¨ç›¸åŒçš„é‡‘é‘°èˆ‡æ”¶åˆ°çš„è¨Šæ¯åŸ·è¡ŒåŒæ¨£çš„è¨ˆç®—ï¼Œæ¯”å°çµæœæ˜¯å¦ä¸€è‡´ï¼Œå³å¯ç¢ºèªè¨Šæ¯çš„å®Œæ•´æ€§èˆ‡ä¾†æºçš„çœŸå¯¦æ€§ã€‚åœ¨ TLS 1.2 ä¸­ï¼ŒHMAC å¯ä»¥æ­é… MD5ã€SHA1ã€SHA256 ç­‰ä¸åŒçš„é›œæ¹Šå‡½æ•¸ã€‚\nflowchart LR subgraph s1[\u0026#34;HMAC\u0026#34;] n2[\u0026#34;Hash Algo. (MD5, SHA1, SHA256)\u0026#34;] n3@{ label: \u0026#34;HMAC\u0026lt;span style=\\\u0026#34;background-color:\\\u0026#34;\u0026gt;formula\u0026#34; } end n1[\u0026#34;Message\u0026#34;] --\u0026gt; n2 n2 --\u0026gt; n3 n3 --\u0026gt; n4[\u0026#34;MAC\u0026#34;] n5[\u0026#34;secret\u0026#34;] --\u0026gt; n3 n3@{ shape: rect} n1@{ shape: text} n4@{ shape: text} n5@{ shape: text} æ ¹æ“š RFC 2104ï¼ŒHMAC çš„æ•¸å­¸å…¬å¼ç‚ºï¼š\n$$ {\\displaystyle {\\textit {HMAC}}(K,m)=H{\\Bigl (}(K\u0026rsquo;\\oplus opad);||;H{\\bigl (}(K\u0026rsquo;\\oplus ipad);||;m{\\bigr )}{\\Bigr )}} $$\nè©³ç´°èªªæ˜åƒè€ƒï¼šHMAC - ç¶­åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨æ›¸\nPRFï¼šç”¨æ–¼é‡‘é‘°è¡ç”Ÿçš„å½éš¨æ©Ÿå‡½æ•¸ # å‰é¢æåˆ°ç”¨æ–¼ç”Ÿæˆ master secret å’Œå…¶ä»–é‡‘é‘°çš„ pseudorandom functionï¼ˆPRFï¼‰ä¹Ÿæ˜¯åŸºæ–¼ HMAC å‡½æ•¸ï¼š\nP_hash(secret, seed) = HMAC_hash(secret, A(1) + seed) + HMAC_hash(secret, A(2) + seed) + HMAC_hash(secret, A(3) + seed) + ... æ ¹æ“š HMAC ä¸­ä½¿ç”¨çš„é›œæ¹Šå‡½æ•¸ä¸åŒï¼Œå°æ‡‰çš„ PRF å¯å¯«ä½œ P_hashã€‚åœ¨ TLS 1.2 ä¸­ï¼ŒPRF å›ºå®šä½¿ç”¨ SHA256ï¼Œå› æ­¤ç¨±ç‚º P_SHA256ã€‚\nåŠ å¯†å¥—ä»¶ï¼ˆCipher Suiteï¼‰ # ç¶œåˆä¸Šè¿°çš„é‡‘é‘°äº¤æ›å”å®šã€å°ç¨±åŠ å¯†æ¼”ç®—æ³•èˆ‡ HAMC ä¸­çš„é›œæ¹Šæ•¸ï¼Œä¸‰è€…çµ„åˆèµ·ä¾†å°±å½¢æˆäº†ä¸€å€‹ TLS 1.2 çš„åŠ å¯†å¥—ä»¶ï¼ˆCipher Suiteï¼‰ã€‚åŠ å¯†å¥—ä»¶çš„åç¨±çœ‹èµ·ä¾†åƒä¸€ä¸²ç¥ç§˜çš„å’’èªï¼Œä¾‹å¦‚ï¼šTLS_DHE_RSA_WITH_AES_128_CBC_SHAã€‚\næˆ‘å€‘å¯ä»¥å°‡å®ƒæ‹†è§£ä¾†ç†è§£ï¼š\ngraph TD B{TLS åŠ å¯†å¥—ä»¶} --\u0026gt; C[é‡‘é‘°äº¤æ›å”å®š]; C --\u0026gt; C1[DHE_RSA]; C1 --\u0026gt; C1_1[DHE: è‡¨æ™‚ Diffie-Hellman]; C1_1 --\u0026gt; C1_1_1[æä¾›å‘å‰ä¿å¯†æ€§]; C1 --\u0026gt; C1_2[RSA: ä¼ºæœå™¨æ†‘è­‰ä½¿ç”¨ RSA]; C1_2 --\u0026gt; C1_2_1[å° DHE åƒæ•¸é€²è¡Œæ•¸ä½ç°½ç« ]; B --\u0026gt; D[å°ç¨±åŠ å¯†æ¼”ç®—æ³•]; D --\u0026gt; D1[AES_128_CBC]; D1 --\u0026gt; D1_1[AES: å°ç¨±åŠ å¯†æ¼”ç®—æ³•]; D1_1 --\u0026gt; D1_1_1[128 ä½å…ƒé‡‘é‘°]; D1 --\u0026gt; D1_2[CBC: åŠ å¯†æ¨¡å¼]; D1_2 --\u0026gt; D1_2_1[Cipher Block Chaining]; B --\u0026gt; E[MAC æ¼”ç®—æ³•]; E --\u0026gt; E1[SHA]; E1 --\u0026gt; E1_1[SHA-1: é›œæ¹Šå‡½æ•¸]; E1_1 --\u0026gt; E1_1_1[æ­é… HMAC å¯¦ä½œè¨Šæ¯é©—è­‰ç¢¼]; style C1_1 fill:#f9f,stroke:#333,stroke-width:2px; style C1_2 fill:#f9f,stroke:#333,stroke-width:2px; style D1_1 fill:#f9f,stroke:#333,stroke-width:2px; style D1_2 fill:#f9f,stroke:#333,stroke-width:2px; style E1_1 fill:#f9f,stroke:#333,stroke-width:2px; DHE_RSAï¼šä»£è¡¨é‡‘é‘°äº¤æ›æ–¹å¼ã€‚DHE è¡¨ç¤ºä½¿ç”¨è‡¨æ™‚ Diffie-Hellmanï¼ˆEphemeral DHï¼‰äº¤æ›ï¼Œå…·å‚™å‘å‰ä¿å¯†æ€§ï¼›RSA å‰‡è¡¨ç¤ºä¼ºæœå™¨çš„æ†‘è­‰ä½¿ç”¨ RSA å…¬ç§é‘°ï¼Œç”¨ä¾†å° DHE çš„åƒæ•¸é€²è¡Œæ•¸ä½ç°½ç« ã€‚ AES_128_CBCï¼šä»£è¡¨å°ç¨±åŠ å¯†æ¼”ç®—æ³•ï¼Œè¡¨ç¤ºä½¿ç”¨ 128 ä½å…ƒé‡‘é‘°çš„ AESï¼ŒåŠ å¯†æ¨¡å¼ç‚º CBCï¼ˆCipher Block Chainingï¼‰ã€‚ SHAï¼šä»£è¡¨ MAC æ¼”ç®—æ³•ï¼Œè¡¨ç¤ºä½¿ç”¨ SHA-1 é›œæ¹Šå‡½æ•¸æ­é… HMAC ä¾†å¯¦ä½œè¨Šæ¯é©—è­‰ç¢¼ã€‚ åœ¨ TLS æ¡æ‰‹ä¹‹åˆï¼ŒClient æœƒåˆ—å‡ºæ‰€æœ‰å®ƒæ”¯æ´çš„åŠ å¯†å¥—ä»¶ï¼›Server å‰‡å¾ä¸­æŒ‘é¸ä¸€å€‹é›™æ–¹éƒ½æ”¯æ´ï¼Œä¸”ç¬¦åˆå…¶å®‰å…¨ç­–ç•¥çš„å¥—ä»¶ï¼Œä¸¦é€šçŸ¥ Clientã€‚é€™å€‹éç¨‹ç¢ºä¿äº†é›™æ–¹èƒ½ä»¥å…±åŒèªè¨€å»ºç«‹å®‰å…¨çš„é€£ç·šã€‚\nåœ¨ RFC 5246 ä¸­åˆ—å‡ºäº† TLS 1.2 æ”¯æ´çš„ Cipher Suitesã€‚ä»¥é‡‘é‘°äº¤æ›è€Œè¨€ï¼Œå¯èƒ½ä½¿ç”¨ RSAã€DH æˆ– DHEï¼š\nDH/DHE é‡‘é‘°äº¤æ›æœƒæ­é… DSSï¼ˆDSAï¼‰æˆ– RSA æ•¸ä½ç°½ç« é€²è¡Œé©—è­‰ï¼Œå¦‚ï¼šTLS_DHE_DSS_WITH_3DES_EDE_CBC_SHAã€‚ RSA é‡‘é‘°äº¤æ›å‰‡ä¸éœ€è¦é¡å¤–çš„ç°½ç« ï¼Œå› ç‚ºåŠ å¯† premaster secret çš„å°±æ˜¯æ†‘è­‰ä¸­çš„ RSA å…¬é‘°ã€‚å› æ­¤ï¼Œcipher åªæœƒæœ‰ RSA ä¸€å€‹å­—ï¼Œå¦‚ TLS_RSA_WITH_AES_256_CBC_SHA256ã€‚ é‚„æœ‰ä¸€ç¨®æ¯”è¼ƒç‰¹æ®Šçš„ dh_anonï¼ˆanonymous DH, å¦‚ TLS_DH_anon_WITH_RC4_128_MD5ï¼‰ï¼Œå®ƒä»£è¡¨ä¸é©—è­‰ä¼ºæœå™¨èº«ä»½ï¼Œå› æ­¤æœƒé¢è‡¨ä¸­é–“äººæ”»æ“Šçš„é¢¨éšªï¼Œå¯¦å‹™ä¸Šä¸å»ºè­°ä½¿ç”¨ã€‚\nèˆ‡ ECCï¼ˆæ©¢åœ“æ›²ç·šå¯†ç¢¼å­¸ï¼‰ç›¸é—œçš„å¥—ä»¶å‰‡å®šç¾©æ–¼ RFC 4492ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å¹¾ç¨®å¸¸è¦‹çµ„åˆï¼š\nECDH_ECDSAã€ECDHE_ECDSA ECDH_RSAã€ECDHE_RSA ECDH_anon é€™äº›çµ„åˆåŸºæœ¬ä¸Šæ˜¯é‡‘é‘°äº¤æ›ï¼ˆECDH vs ECDHEï¼‰èˆ‡ç°½ç« æ–¹å¼ï¼ˆRSA vs ECDSAï¼‰çš„æ’åˆ—çµ„åˆã€‚\nå°ç¨±åŠ å¯†æ–¹é¢ï¼ŒRFC 5246 ä¸­å®šç¾©äº†ä»¥ä¸‹å¹¾ç¨®ï¼š\nRC4_128 3DES_EDE_CBC AES_128_CBC AES_256_CBC ä½†é€™äº›æ–¹å¼å¤šæ•¸å·²å­˜åœ¨å®‰å…¨æ€§ç–‘æ…®ï¼Œå°¤å…¶æ˜¯ RC4 å’Œ 3DESï¼Œç”šè‡³ CBC æ¨¡å¼æœ¬èº«ä¹Ÿæœ‰ä¸€äº›å·²çŸ¥æ”»æ“Šã€‚å› æ­¤ï¼Œè¼ƒå»ºè­°ä½¿ç”¨å…·å‚™ã€Œèªè­‰åŠ å¯†ï¼ˆAEADï¼‰ã€ç‰¹æ€§çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š\nAES-GCMï¼ˆCipher å®šç¾©æ–¼ RFC 5288ï¼‰ ChaCha20-Poly1305ï¼ˆCipher å®šç¾©æ–¼ RFC 7905ï¼‰ ä¾‹å¦‚ï¼šTLS_RSA_WITH_AES_256_GCM_SHA384 å°±æ˜¯ä¸€å€‹ç¬¦åˆ AEAD è¨­è¨ˆçš„åŠ å¯†å¥—ä»¶ã€‚ æœ€å¾Œï¼ŒMAC æ‰€ç”¨çš„é›œæ¹Šå‡½æ•¸ä¸»è¦åŒ…æ‹¬ï¼šMD5ã€SHA-1ã€SHA-256 ç­‰ã€‚é€™äº›æœƒæ­é… HMAC ä½¿ç”¨ä¾†é€²è¡Œè¨Šæ¯é©—è­‰ã€‚\nTLS 1.2 å®Œæ•´æ¡æ‰‹æµç¨‹ # åœ¨ç†è§£äº† Cipher Suite èˆ‡åŠ å¯†æ©Ÿåˆ¶å¾Œï¼Œæˆ‘å€‘å¯ä»¥ä¾†çœ‹çœ‹ TLS 1.2 çš„å®Œæ•´æ¡æ‰‹æµç¨‹ã€‚ä»¥ä¸‹æ˜¯æ¡æ‰‹çš„äº¤äº’æµç¨‹ç¤ºæ„åœ–ï¼š\nsequenceDiagram participant Client participant Server rect rgb(200, 255, 200) Note over Client,Server: Phase 1: Hello Message Negotiation Client-\u0026gt;\u0026gt;Server: ClientHello (version, random, session ID, cipher suites, extensions) Server-\u0026gt;\u0026gt;Client: ServerHello (version, random, session ID, chosen cipher suite, extensions) end rect rgb(200, 200, 255) Note over Client,Server: Phase 2: Server Authentication \u0026amp; Key Exchange Server-\u0026gt;\u0026gt;Client: Certificate* (Server\u0026#39;s public key certificate chain) alt If DHE/ECDHE key exchange Server-\u0026gt;\u0026gt;Client: ServerKeyExchange* (Ephemeral public key, signed) end alt If Client authentication is required Server-\u0026gt;\u0026gt;Client: CertificateRequest* (Types of certs, CAs accepted) end Server-\u0026gt;\u0026gt;Client: ServerHelloDone end rect rgb(255, 200, 200) Note over Client,Server: Phase 3: Client Authentication \u0026amp; Key Exchange alt If Server requested Client certificate Client-\u0026gt;\u0026gt;Server: Certificate* (Client\u0026#39;s public key certificate chain) Client-\u0026gt;\u0026gt;Server: CertificateVerify* (Client\u0026#39;s signature on handshake messages) end Client-\u0026gt;\u0026gt;Server: ClientKeyExchange (Encrypted premaster secret OR ephemeral public key) end rect rgb(255, 255, 200) Note over Client,Server: Phase 4: Change Cipher Spec \u0026amp; Finished Client-\u0026gt;\u0026gt;Server: ChangeCipherSpec (Switch to agreed cipher suite) Client-\u0026gt;\u0026gt;Server: Finished (First encrypted message, verification hash) Server-\u0026gt;\u0026gt;Client: ChangeCipherSpec (Switch to agreed cipher suite) Server-\u0026gt;\u0026gt;Client: Finished (Verification hash) end Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: Application Data (Encrypted) è¡¨ç¤ºç‚ºé¸æ“‡æ€§æˆ–ä¾ä½¿ç”¨å ´æ™¯è€Œå®šçš„è¨Šæ¯ã€‚ éšæ®µä¸€ï¼šHello è¨Šæ¯å”å•† # ç›®çš„ï¼šé›™æ–¹ç¢ºèª TLS ç‰ˆæœ¬ã€åŠ å¯†å¥—ä»¶ç­‰åŸºæœ¬åƒæ•¸ã€‚\nClientHello # Client ç™¼èµ·é€£ç·šï¼Œå‘ŠçŸ¥ Serverï¼š\nclient_versionï¼šæ”¯æ´çš„æœ€é«˜ TLS ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ TLS 1.2 ç‚º 0x0303ï¼‰ã€‚ randomï¼š32 bytes éš¨æ©Ÿæ•¸ client_randomï¼Œåƒèˆ‡ master secret çš„ç”¢ç”Ÿã€‚ session_idï¼šç”¨æ–¼æœƒè©±æ¢å¾©ï¼Œè‹¥ç„¡å‰‡ç‚ºç©ºã€‚å¾Œé¢æœƒåœ¨ä»‹ç´¹æœƒè©±æ¢å¾©çš„éƒ¨åˆ†ã€‚ cipher_suitesï¼šæ”¯æ´çš„åŠ å¯†å¥—ä»¶æ¸…å–®ï¼ŒæŒ‰åå¥½æ’åºã€‚ extensionsï¼šæ”¯æ´çš„ TLS æ“´å……åŠŸèƒ½ã€‚ compression_methodsï¼šåŸæœ¬æ˜¯ç”¨ä¾†å”å•† TLS å‚³è¼¸å£“ç¸®æ–¹æ³•çš„æ¬„ä½ï¼Œä½†æ˜¯ TLS å£“ç¸®æœ‰æ¼æ´ï¼Œæ‰€ä»¥å…¶å¯¦å¯¦å‹™ä¸Šå®Œå…¨ä¸æœƒä½¿ç”¨ã€‚ struct { ProtocolVersion client_version; Random random; SessionID session_id; CipherSuite cipher_suites\u0026lt;2..2^16-2\u0026gt;; CompressionMethod compression_methods\u0026lt;1..2^8-1\u0026gt;; select (extensions_present) { case false: struct {}; case true: Extension extensions\u0026lt;0..2^16-1\u0026gt;; }; } ClientHello; ServerHello # Server å›æ‡‰ä¸¦é¸å®šåƒæ•¸ï¼š\nserver_versionï¼šèˆ‡ Client å”å•†å‡ºçš„ TLS ç‰ˆæœ¬ã€‚ randomï¼šServer ç”¢ç”Ÿçš„ 32 bytes server_randomã€‚ session_idï¼šæ˜¯å¦æ”¯æ´ session æ¢å¾©ã€‚ cipher_suiteï¼šå¾ Client æä¾›çš„åˆ—è¡¨ä¸­é¸å®šä¸€å€‹å¯æ¥å—çš„åŠ å¯†å¥—ä»¶ã€‚ extensionsï¼šå›æ‡‰æ”¯æ´çš„ TLS extensionã€‚ struct { ProtocolVersion server_version; Random random; SessionID session_id; CipherSuite cipher_suite; CompressionMethod compression_method; select (extensions_present) { case false: struct {}; case true: Extension extensions\u0026lt;0..2^16-1\u0026gt;; }; } ServerHello; éšæ®µäºŒä¹‹ä¸€ï¼šä¼ºæœå™¨é©—è­‰èˆ‡é‡‘é‘°äº¤æ› # ç›®çš„ï¼šä¼ºæœå™¨é©—è­‰èº«ä»½ï¼Œæä¾›é‡‘é‘°äº¤æ›å¿…è¦è³‡æ–™ã€‚\nCertificateï¼šä¼ºæœå™¨ç™¼é€æ†‘è­‰éˆï¼ˆX.509ï¼‰ï¼Œä¾› Client é©—è­‰å…¶èº«ä»½ã€‚ ServerKeyExchangeï¼ˆå¯é¸ï¼‰ï¼šè‹¥ä½¿ç”¨ DHE / ECDHEï¼ŒServer å‚³é€è‡¨æ™‚å…¬é‘°èˆ‡ç°½ç« ã€‚ CertificateRequestï¼ˆå¯é¸ï¼‰ï¼šè‹¥éœ€é›™å‘èªè­‰ï¼ŒServer è¦æ±‚ Client æä¾›æ†‘è­‰ã€‚ ServerHelloDoneï¼šServer å®£å‘Šæ¡æ‰‹ç›¸é—œè³‡æ–™ç™¼é€å®Œç•¢ã€‚ éšæ®µäºŒä¹‹äºŒï¼šå®¢æˆ¶ç«¯é©—è­‰èˆ‡é‡‘é‘°äº¤æ› # ç›®çš„ï¼šClient æä¾›æ†‘è­‰ï¼ˆè‹¥æœ‰ï¼‰ä¸¦é€å‡º premaster secret æˆ–å…¬é‘°ã€‚\nCertificateï¼ˆå¯é¸ï¼‰ï¼šè‹¥ Server è¦æ±‚ï¼ŒClient å›å‚³è‡ªèº«æ†‘è­‰ã€‚ ClientKeyExchangeï¼š - è‹¥æ˜¯ RSAï¼šå‚³é€ç”¨ Server å…¬é‘°åŠ å¯†çš„ premaster secretã€‚ - è‹¥æ˜¯ (EC)DHEï¼šå‚³é€è‡¨æ™‚å…¬é‘°ã€‚ CertificateVerifyï¼ˆå¯é¸ï¼‰ï¼šè‹¥ Client æœ‰é€æ†‘è­‰ï¼Œå‰‡ç”¨ç§é‘°ç°½ç½²ã€Œä¹‹å‰æ‰€æœ‰æ¡æ‰‹è¨Šæ¯çš„ hashã€ï¼Œè­‰æ˜è‡ªå·±æŒæœ‰è©²ç§é‘°ã€‚ éšæ®µäºŒä¹‹ä¸‰ï¼šå®ŒæˆåŠ å¯†åˆ‡æ› # ç›®çš„ï¼šé›™æ–¹åˆ‡æ›ç‚ºå”å•†å¾Œçš„åŠ å¯†æ¨¡å¼ä¸¦é©—è­‰æ¡æ‰‹å®Œæ•´æ€§ã€‚\nChangeCipherSpecï¼šClient é€šçŸ¥ Server æ¥ä¸‹ä¾†çš„è³‡æ–™æœƒé–‹å§‹åŠ å¯†ã€‚ Finishedï¼š - Client å‚³é€ç¬¬ä¸€å€‹åŠ å¯†è¨Šæ¯ï¼Œå…§å®¹ç‚º verify_dataã€‚ - verify_data æ˜¯æ ¹æ“šæ¡æ‰‹éšæ®µæ‰€æœ‰è¨Šæ¯åš MAC è¨ˆç®—å¾Œçš„çµæœï¼ˆåŸºæ–¼ master secretï¼‰ï¼ŒServer ç”¨ç›¸åŒæ–¹å¼é©—è­‰å¯ç¢ºèªæ¡æ‰‹éç¨‹æœªé­ç«„æ”¹ã€‚ Server ç«¯å›æ‡‰ï¼š - Server åŒæ¨£é€å‡º ChangeCipherSpec å’Œ Finishedã€‚ - Client æ”¶åˆ°å¾Œé©—è­‰ Finished æ­£ç¢ºï¼Œå³å®Œæˆæ¡æ‰‹ã€‚ TLS Extension # åœ¨ ClientHello èˆ‡ ServerHello ä¸­ï¼Œé™¤äº†åŸºæœ¬æ¬„ä½ï¼Œé‚„èƒ½é€é Extension æ”œå¸¶é¡å¤–è³‡è¨Šã€‚å¸¸è¦‹çš„ Extension åŒ…æ‹¬ï¼š\nExtension åç¨± åŠŸèƒ½ç°¡è¿° server_name (SNI) å‘ŠçŸ¥ Server è¦è¨ªå•çš„ hostnameï¼Œè®“å¦‚ Nginx ç­‰å¯é‡å°ä¸åŒ host name å›å‚³ä¸åŒæ†‘è­‰ã€‚ç”±æ–¼æœªåŠ å¯†ï¼Œæœƒæ›éœ²è¨ªå•ç›®æ¨™ã€‚ encrypted_client_hello (ECH) å°æŠ— SNI æš´éœ²ï¼Œå˜—è©¦è®“ ClientHello è¢«éƒ¨åˆ†åŠ å¯†ã€‚ä»åœ¨é€æ­¥éƒ¨ç½²ä¸­ã€‚ supported_versions æ˜ç¢ºåˆ—å‡º Client æ”¯æ´çš„ TLS ç‰ˆæœ¬ï¼ˆé¿å…é™ç´šæ”»æ“Šï¼‰ã€‚ signature_algorithms æŒ‡å‡ºæ”¯æ´çš„æ•¸ä½ç°½ç« æ¼”ç®—æ³•ï¼ˆå¦‚ RSA-PSSã€ECDSAï¼‰ã€‚ application_layer_protocol_negotiation (ALPN) æä¾›æ‡‰ç”¨å±¤å”å®šé¸æ“‡ï¼Œå¦‚ HTTP/1.1 æˆ– HTTP/2ã€‚ status_request è¦æ±‚ Server é™„ä¸Š OCSP æ†‘è­‰æ’¤éŠ·è³‡è¨Šï¼ˆé¿å… Client å†æŸ¥è©¢ CAï¼‰ã€‚ renegotiation_info TLS session renegotiation å…è¨±åœ¨ç¾æœ‰çš„ TLS é€£ç·šä¸­ï¼Œé‡æ–°å”å•†ï¼Œæ›´æ–°é€£ç·šçš„å®‰å…¨æ€§åƒæ•¸ï¼Œä¾‹å¦‚åŠ å¯†å¥—ä»¶ã€é‡‘é‘°ï¼Œæˆ–è€…è¦æ±‚å®¢æˆ¶ç«¯æ†‘è­‰ç­‰ã€‚ä¸éå› ç‚ºæ¼æ´ï¼Œä¾‹å¦‚ SSL é‡æ–°å”å•†æ”»æ“Šï¼Œé€™å€‹åœ¨ TLS 1.3 è¢«ç§»é™¤äº†ã€‚ session_ticket ç”¨æ–¼ session æ¢å¾©çš„æ©Ÿåˆ¶ã€‚å¾Œé¢æœƒåœ¨ä»‹ç´¹ã€‚ é€£ç·šæ¢å¾©ï¼ˆSession Resumptionï¼‰ï¼šåŠ é€Ÿæ¡æ‰‹éç¨‹ # å®Œæ•´çš„ TLS æ¡æ‰‹éç¨‹æ¶‰åŠå¤šæ¬¡ç¶²è·¯å¾€è¿”èˆ‡æ˜‚è²´çš„å¯†ç¢¼å­¸é‹ç®—ï¼Œæœƒå°å»¶é²èˆ‡è³‡æºé€ æˆæ˜é¡¯è² æ“”ã€‚ç‚ºäº†æå‡æ•ˆèƒ½ï¼ŒTLS 1.2 æä¾›äº†é€£ç·šæ¢å¾©æ©Ÿåˆ¶ï¼Œå…è¨± Client èˆ‡ Server é‡ç”¨å…ˆå‰å”å•†å¥½çš„ master secretï¼Œè·³éé‡‘é‘°äº¤æ›èˆ‡æ†‘è­‰é©—è­‰çš„æ­¥é©Ÿï¼Œç›´æ¥é€²å…¥åŠ å¯†é€šè¨Šã€‚é€™åœ¨åƒæ˜¯ç¶²é è¼‰å…¥ç­‰å ´æ™¯ä¸­ï¼Œèƒ½é¡¯è‘—é™ä½å»¶é²èˆ‡ CPU æ¶ˆè€—ã€‚\nTLS 1.2 æ”¯æ´å…©ç¨®ä¸»è¦çš„é€£ç·šæ¢å¾©æ–¹å¼ï¼š\nä¸€ã€Session ID # é€™æ˜¯æœ€å‚³çµ±çš„é€£ç·šæ¢å¾©æ–¹æ³•ï¼Œç”± Server ç¶­è­·æœƒè©±ç‹€æ…‹ã€‚\nsequenceDiagram participant Client participant Server Note over Client,Server: \u0026#34;Initial Handshake (First Connection)\u0026#34; Client-\u0026gt;\u0026gt;Server: \u0026#34;ClientHello (no session ID)\u0026#34; Server-\u0026gt;\u0026gt;Client: \u0026#34;ServerHello (with new Session ID)\u0026#34; Server\u0026lt;\u0026lt;-\u0026gt;\u0026gt;Client: å®Œæˆæ¡æ‰‹ Note right of Server: Server stores Session ID \u0026amp; state Note over Client,Server: Session Resumption (Subsequent Connection) Client-\u0026gt;\u0026gt;Server: ClientHello (with previous Session ID) alt Server finds valid Session ID Server-\u0026gt;\u0026gt;Client: ServerHello (same Session ID) Server-\u0026gt;\u0026gt;Client: ChangeCipherSpec, Finished Client-\u0026gt;\u0026gt;Server: ChangeCipherSpec, Finished Note over Client,Server: Connection established quickly! else Server does not find valid Session ID Server-\u0026gt;\u0026gt;Client: ServerHello (new Session ID) Note over Client,Server: Fallback to Full Handshake end Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: Application Data (Encrypted) é¦–æ¬¡æ¡æ‰‹ï¼š # Server æœƒåœ¨ ServerHello è¨Šæ¯ä¸­ç”¢ç”Ÿä¸€å€‹å”¯ä¸€çš„ Session IDã€‚ Server å…§éƒ¨å°‡è©² Session ID èˆ‡å°æ‡‰çš„ master secretã€åŠ å¯†æ¼”ç®—æ³•ç­‰ç‹€æ…‹è³‡æ–™ç¶å®šï¼Œå„²å­˜åœ¨å¿«å–ä¸­ã€‚ æ¢å¾©é€£ç·šï¼š # Client å†æ¬¡é€£ç·šæ™‚ï¼Œåœ¨ ClientHello ä¸­æ”œå¸¶è©² Session IDã€‚ Server è‹¥åœ¨å¿«å–ä¸­æ‰¾åˆ°åŒ¹é…ä¸”æœ‰æ•ˆçš„ Sessionï¼Œå³åŒæ„æ¢å¾©é€£ç·šã€‚ é›™æ–¹ä¾¿å¯ç›´æ¥é€²è¡Œç°¡åŒ–æ¡æ‰‹ï¼ˆAbbreviated Handshakeï¼‰æµç¨‹ï¼Œåªéœ€äº¤æ› ChangeCipherSpec èˆ‡ Finishedï¼Œå³å¯å»ºç«‹å®‰å…¨é€šé“ã€‚ ç¼ºé»ï¼š # æ­¤æ–¹å¼è¦æ±‚ Server å„²å­˜æ¯å€‹ Session çš„ç‹€æ…‹è³‡è¨Šã€‚å°æ–¼å¤§å‹åˆ†æ•£å¼æ¶æ§‹ï¼ˆå¦‚å¤šç¯€é» Web å¢é›†ï¼‰è€Œè¨€ï¼Œæœƒé€ æˆåŒæ­¥èˆ‡å¿«å–ç®¡ç†ä¸Šçš„è² æ“”ï¼Œä¸åˆ©æ–¼ç„¡ç‹€æ…‹ï¼ˆstatelessï¼‰æœå‹™éƒ¨ç½²ã€‚\näºŒã€Session Ticketï¼ˆRFC 5077ï¼‰ # ç‚ºäº†è§£æ±º Session ID çš„ç‹€æ…‹å„²å­˜å•é¡Œï¼ŒRFC 5077 å¼•å…¥äº† Session Ticketï¼Œå¯¦ç¾ ç„¡ç‹€æ…‹çš„é€£ç·šæ¢å¾©ï¼ˆStateless Session Resumptionï¼‰ã€‚\nsequenceDiagram participant Client participant Server Note over Client,Server: \u0026#34;Initial Handshake (First Connection)\u0026#34; Client-\u0026gt;\u0026gt;Server: ClientHello Server-\u0026gt;\u0026gt;Client: ServerHello, Certificate, etc. Client-\u0026gt;\u0026gt;Server: ClientKeyExchange, etc. Server-\u0026gt;\u0026gt;Client: \u0026#34;NewSessionTicket (encrypted session state)\u0026#34; Client-\u0026gt;\u0026gt;Server: ChangeCipherSpec, Finished Server-\u0026gt;\u0026gt;Client: ChangeCipherSpec, Finished Note left of Client: Client stores Session Ticket Note over Client,Server: \u0026#34;Session Resumption (Subsequent Connection)\u0026#34; Client-\u0026gt;\u0026gt;Server: ClientHello (with session_ticket extension) Note right of Server: Server decrypts \u0026amp; verifies ticket alt Server successfully decrypts ticket Server-\u0026gt;\u0026gt;Client: ServerHello (with empty session ID or ticket acknowledgement) Server-\u0026gt;\u0026gt;Client: ChangeCipherSpec, Finished Client-\u0026gt;\u0026gt;Server: ChangeCipherSpec, Finished Note over Client,Server: Connection established quickly! (Stateless on server) else Server fails to decrypt OR ticket expired Server-\u0026gt;\u0026gt;Client: ServerHello (no session ID or new ticket) Note over Client,Server: Fallback to Full Handshake end Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: Application Data (Encrypted) é¦–æ¬¡æ¡æ‰‹ï¼š # æ¡æ‰‹æ™‚ï¼ŒServer ä½¿ç”¨å…§éƒ¨ç§é‘°å°‡æ•´å€‹æœƒè©±ç‹€æ…‹ï¼ˆä¾‹å¦‚ master secretã€cipher suite ç­‰ï¼‰åŠ å¯†å°è£æˆä¸€å€‹ Ticketã€‚ Server é€é NewSessionTicket è¨Šæ¯å°‡è©² Ticket å‚³çµ¦ Clientã€‚ æ•´å€‹ Ticket æ˜¯ä¸€å€‹ Server åŠ å¯†å¾Œçš„ blobï¼ŒClient ä¸éœ€ç†è§£å…¶å…§å®¹ã€‚ å®¢æˆ¶ç«¯å„²å­˜ï¼š # Client å°‡ Ticket å„²å­˜èµ·ä¾†ï¼Œç­‰å¾…æœªä¾†é‡é€£ä½¿ç”¨ã€‚ æ¢å¾©é€£ç·šï¼š # Client æ–¼ä¹‹å¾Œçš„ ClientHello è¨Šæ¯ä¸­ï¼Œé€é session_ticket extension é™„ä¸Šè©² Ticketã€‚ Server æ”¶åˆ°å¾Œç”¨è‡ªå·±çš„é‡‘é‘°è§£å¯†ï¼Œè‹¥æˆåŠŸä¸” Ticket æœ‰æ•ˆï¼Œå³é‚„åŸå‡ºå®Œæ•´çš„æœƒè©±ç‹€æ…‹ï¼Œç¹¼çºŒç°¡åŒ–æ¡æ‰‹ã€‚ å„ªé»ï¼š # Server ç„¡éœ€ç¶­è­·ä»»ä½•æœƒè©±å¿«å–ï¼Œæ‰€æœ‰ç‹€æ…‹ç”± Client æ”œå¸¶ã€‚ éå¸¸é©åˆåˆ†æ•£å¼éƒ¨ç½²èˆ‡è² è¼‰å¹³è¡¡å ´æ™¯ã€‚ ç¼ºé»ï¼š # NewSessionTicket è¨Šæ¯æ˜¯åœ¨ TLS 1.2 å®Œæ•´æ¡æ‰‹çš„æœ«ç«¯æ˜æ–‡å‚³é€çš„ã€‚ å¦‚æœ Server ç§é‘°æ´©æ¼ï¼Œæ”»æ“Šè€…å¯è§£å¯† Ticketï¼Œå–å¾— master secretï¼Œé€²è€Œé›¢ç·šè§£å¯† TLS å°åŒ…ã€‚ ç‚ºäº†é¿å… Ticket é•·æœŸæœ‰æ•ˆé€ æˆé¢¨éšªï¼Œå¯¦å‹™ä¸Šæ‡‰æ­é… key rotation èˆ‡éæœŸæ©Ÿåˆ¶ã€‚ é å…±äº«é‡‘é‘°ï¼ˆPre-Shared Key, PSKï¼‰ # é™¤äº†ä½¿ç”¨æ†‘è­‰é€²è¡Œèº«ä»½é©—è­‰ï¼ŒTLS 1.2 ä¹Ÿæ”¯æ´é€é é å…±äº«é‡‘é‘°ï¼ˆPSKï¼‰ çš„æ–¹å¼ä¾†å»ºç«‹å®‰å…¨é€šé“ï¼Œå®šç¾©æ–¼ RFC 4279ã€‚æ­¤æ–¹å¼ä¸ä¾è³´å…¬é–‹é‡‘é‘°åŸºç¤è¨­æ–½ï¼ˆPKIï¼‰ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ç„¡æ³•éƒ¨ç½²æ†‘è­‰æˆ–é‹ç®—è³‡æºæœ‰é™çš„ç’°å¢ƒï¼Œä¾‹å¦‚ IoT è£ç½®ã€‚\nPSK æ¨¡å¼åˆ†é¡ # TLS 1.2 ä¸­çš„ PSK å¯æ­é…ä¸åŒé‡‘é‘°äº¤æ›æ–¹æ³•ï¼Œåˆ†ç‚ºä»¥ä¸‹å¹¾ç¨®å¥—ä»¶å½¢å¼ï¼š\ngraph LR A[PSK æ¨¡å¼] --\u0026gt; B[ç´” PSK: TLS_PSK_*] A --\u0026gt; C[DHE \u0026#43; PSK: TLS_DHE_PSK_*] A --\u0026gt; D[RSA \u0026#43; PSK: TLS_RSA_PSK_*] B --\u0026gt; B1[åƒ…ç”¨ PKS] C --\u0026gt; C1[ä½¿ç”¨ Ephemeral DH \u0026#43; PSK] D --\u0026gt; D1[ä½¿ç”¨ RSA åŠ å¯†å”å•† \u0026#43; PSK] subgraph \u0026#34;premaster key ä¾†æº\u0026#34;Â B1 C1 D1 end 1. ç´” PSK æ¨¡å¼ (TLS_PSK_*) # å®Œå…¨ä¸ä½¿ç”¨æ†‘è­‰ã€‚ é›™æ–¹é å…ˆå”è­°ä¸€çµ„å°ç¨±é‡‘é‘°ï¼ˆPSKï¼‰ã€‚ æ¡æ‰‹æœŸé–“ï¼ŒPSK ç›´æ¥æˆ–é–“æ¥ä½œç‚º premaster secret ä½¿ç”¨ã€‚ ç¼ºé»ï¼šä¸å…· forward secrecyï¼ˆå‰å‘ä¿å¯†æ€§ï¼‰ï¼Œè‹¥ PSK æ´©æ¼ï¼Œæ­·å²å°åŒ…äº¦å¯è§£å¯†ã€‚ 2. æ··åˆæ¨¡å¼ï¼ˆTLS_DHE_PSK_*, TLS_RSA_PSK_*ï¼‰ # ä½¿ç”¨ DHE æˆ– RSA åŸ·è¡Œé‡‘é‘°äº¤æ›æµç¨‹ã€‚ PSK ä¸¦éç›´æ¥ä½œç‚º keyï¼Œè€Œæ˜¯ä½œç‚ºé¡å¤–è¼¸å…¥åƒèˆ‡ master secret æ´¾ç”Ÿã€‚ å„ªé»ï¼šå¯çµåˆ PSK çš„ä½æˆæœ¬èˆ‡å…¬é–‹é‡‘é‘°äº¤æ›çš„å‰å‘ä¿å¯†æ€§ã€‚ ä½¿ç”¨å ´æ™¯å¦‚ï¼šéœ€æä¾› fallback é€£ç·šã€æ”¯æ´é›™å‘èº«ä»½é©—è­‰ï¼Œæˆ–å°é–‰å‹å°ˆç¶²ã€‚ å°çµ # è‡³æ­¤ï¼Œæˆ‘å€‘å·²å…¨é¢äº†è§£ TLS 1.2 çš„æ¡æ‰‹æµç¨‹ã€Session Resumption æŠ€è¡“èˆ‡ PSK é©—è­‰æ–¹å¼ã€‚é€™äº›æ©Ÿåˆ¶è¨­è¨ˆçš†åœ¨å¹³è¡¡ å®‰å…¨æ€§ã€æ•ˆèƒ½ èˆ‡ å¯æ“´å±•æ€§ï¼Œä½†ä¹Ÿæœ‰å…¶æ½›åœ¨é¢¨éšªèˆ‡é™åˆ¶ã€‚\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥æ¢è¨ TLS 1.3 å°é€™äº›æ©Ÿåˆ¶çš„é‡å¤§æ”¹é€²èˆ‡é‡æ–°è¨­è¨ˆï¼ŒåŒ…å«ï¼š\næ›´ç°¡æ½”çš„æ¡æ‰‹æµç¨‹ é è¨­å‰å‘ä¿å¯†æ€§ çµ±ä¸€èˆ‡å¼·åŒ–çš„ PSK/Session æ©Ÿåˆ¶ åŠ å¯†çš„ SNI èˆ‡æ¡æ‰‹å…§å®¹ä¿è­·ï¼ˆEncrypted Client Helloï¼‰ åƒè€ƒæ–‡ç«  # RFC 4279 - Pre-Shared Key Ciphersuites for Transport Layer Security (TLS) RFC 5077 - Transport Layer Security (TLS) Session Resumption without Server-Side State RFC 5246 - The Transport Layer Security (TLS) Protocol Version 1.2 ","date":"June 28 2025","externalUrl":null,"permalink":"/posts/understanding-tls-1-2-key-exchange-and-handshake/","section":"æ–‡ç« ","summary":"","title":"ææ‡‚ TLS 1.2 é‡‘é‘°äº¤æ›åŸç†èˆ‡æ¡æ‰‹","type":"posts"},{"content":"åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Šææ‡‚ TLS 1.2 é‡‘é‘°äº¤æ›åŸç†èˆ‡æ¡æ‰‹ã€‹ä¸­ï¼Œæˆ‘å€‘å·²ç¶“å° TLS 1.2 çš„é‹ä½œåŸç†æœ‰äº†å…¨é¢çš„äº†è§£ã€‚æœ¬æ–‡å°‡ä»¥æ­¤ç‚ºåŸºç¤ï¼Œæ·±å…¥æ¢è¨ TLS 1.3 å¸¶ä¾†çš„æ”¹è®Šã€‚TLS 1.3 æ˜¯ä¸€æ¬¡å¤§å¹…åº¦çš„é‡æ–°è¨­è¨ˆï¼Œè§£æ±ºäº†è¨±å¤šæ­·å²éºç•™çš„å®‰å…¨æ€§å•é¡Œã€‚\nç§»é™¤éæ™‚èˆ‡ä¸å®‰å…¨çš„å…ƒç´  # TLS 1.3 çš„æ ¸å¿ƒè¨­è¨ˆç†å¿µä¹‹ä¸€æ˜¯ã€ŒåŒ–ç¹ç‚ºç°¡ï¼Œé è¨­å®‰å…¨ã€ã€‚å®ƒé¦–å…ˆåšçš„ï¼Œå°±æ˜¯æœæ–·åœ°ç§»é™¤æ‰€æœ‰åœ¨ TLS 1.2 ä¸­è¢«è¦–ç‚ºè„†å¼±æˆ–ä¸æ¨è–¦çš„åŠ å¯†ç®—æ³•èˆ‡åŠŸèƒ½ï¼Œå¤§å¹…ç¸®å°äº†æ”»æ“Šé¢ã€‚\nå°ç¨±åŠ å¯†ï¼šå¾¹åº•å‘Šåˆ¥ RC4 å’Œæ‰€æœ‰ CBC æ¨¡å¼çš„åŠ å¯†ç®—æ³•ã€‚åªä¿ç•™å…·å‚™èªè­‰åŠ å¯†ï¼ˆAEADï¼‰ ç‰¹æ€§çš„ç®—æ³•ï¼Œä¾‹å¦‚ AES-GCM å’Œ ChaCha20-Poly1305ï¼Œå¾æ ¹æœ¬ä¸Šæœçµ•äº† Padding Oracle ç­‰é‡å° CBC çš„æ”»æ“Šã€‚ é‡‘é‘°äº¤æ›ï¼šç§»é™¤äº†éœæ…‹ RSA èˆ‡éœæ…‹ DH é‡‘é‘°äº¤æ›ã€‚åªä¿ç•™æ”¯æ´å‘å‰ä¿å¯†æ€§ï¼ˆForward Secrecyçš„è‡¨æ™‚é‡‘é‘°äº¤æ›æ–¹æ¡ˆï¼ˆDHE å’Œ ECDHEï¼‰ï¼Œç¢ºä¿å³ä½¿ä¼ºæœå™¨ç§é‘°æ´©æ¼ï¼Œéå»çš„é€šè¨Šå…§å®¹ä¾ç„¶å®‰å…¨ã€‚ é›œæ¹Šèˆ‡é‡‘é‘°è¡ç”Ÿï¼šç”¨æ–¼é‡‘é‘°è¡ç”Ÿçš„å½éš¨æ©Ÿå‡½æ•¸ï¼ˆPRFï¼‰è¢«æ›´ç¾ä»£ã€æ›´å®‰å…¨çš„ HKDFï¼ˆHMAC-based Extract-and-Expand Key Derivation Functionï¼‰ å–ä»£ã€‚ æ•¸ä½ç°½ç« ï¼šæ–°å¢ EdDSAï¼ˆå¦‚ ed25519 å’Œ ed448ï¼‰ç­‰ç¾ä»£æ©¢åœ“æ›²ç·šç°½ç« æ¼”ç®—æ³•ï¼Œæä¾›æ›´é«˜æ•ˆèƒ½èˆ‡æ›´é«˜å®‰å…¨æ€§ã€‚ å…¶ä»–ç§»é™¤é …ç›®ï¼š å®Œå…¨ç§»é™¤äº†å£“ç¸®åŠŸèƒ½ï¼Œä»¥é˜²æ­¢ CRIMEã€BREACH ç­‰åˆ©ç”¨å£“ç¸®é€²è¡Œçš„æ”»æ“Šã€‚ ç§»é™¤äº†æœ‰å®‰å…¨ç–‘æ…®çš„é‡æ–°å”å•†ï¼ˆRenegotiationï¼‰åŠŸèƒ½ã€‚ åŠ å¯†å¥—ä»¶çš„é©å‘½ï¼šåŒ–ç¹ç‚ºç°¡ # åœ¨ TLS 1.2 ä¸­ï¼Œä¸€å€‹åŠ å¯†å¥—ä»¶ï¼ˆCipher Suiteï¼‰å®šç¾©äº†é‡‘é‘°äº¤æ›ã€èº«ä»½é©—è­‰ã€å°ç¨±åŠ å¯†å’Œ MAC å››å€‹éƒ¨åˆ†ï¼Œçµ„åˆéå¸¸è¤‡é›œã€‚TLS 1.3 å°å…¶èªæ„é€²è¡Œäº†å¾¹åº•çš„ç°¡åŒ–ã€‚\nç¾åœ¨ï¼ŒCipher Suite åªå®šç¾©ã€Œå°ç¨±åŠ å¯†ç®—æ³•ï¼ˆAEADï¼‰ã€å’Œã€Œç”¨æ–¼ HKDF çš„é›œæ¹Šå‡½æ•¸ã€ã€‚é‡‘é‘°äº¤æ›ï¼ˆå¦‚ ECDHEï¼‰å’Œæ•¸ä½ç°½ç« ï¼ˆå¦‚ RSAã€ECDSAï¼‰å‰‡è¢«åˆ†é›¢åˆ°ç¨ç«‹çš„æ“´å±•ï¼ˆextensionsï¼‰ä¸­é€²è¡Œå”å•†ã€‚\né€™æ¨£çš„æ”¹è®Šä½¿å¾—åŠ å¯†å¥—ä»¶çš„æ•¸é‡å¾æ•¸åç¨®éŠ³æ¸›åˆ°åƒ…æœ‰äº”ç¨®æ¨™æº–åŒ–çš„çµ„åˆï¼š\nåŠ å¯†å¥—ä»¶åç¨± (Description) å€¼ (Value) TLS_AES_128_GCM_SHA256 {0x13,0x01} TLS_AES_256_GCM_SHA384 {0x13,0x02} TLS_CHACHA20_POLY1305_SHA256 {0x13,0x03} TLS_AES_128_CCM_SHA256 {0x13,0x04} TLS_AES_128_CCM_8_SHA256 {0x13,0x05} äº¤æ¡æµç¨‹å†é€²åŒ–ï¼šå¾ 2-RTT åˆ° 1-RTT # æ¥è‘—æ•´å€‹é€£ç·šå»ºç«‹çš„æµç¨‹ä¹Ÿæœ‰å¤§å¹…çš„ä¿®æ”¹ã€‚åœ¨ TLS 1.2 ä¸­ï¼Œä¸€æ¬¡å®Œæ•´çš„äº¤æ¡è¢«ç¨±ç‚ºÂ 2-RTTï¼Œæ„å‘³è‘—éœ€è¦å…©æ¬¡ç¶²è·¯å¾€è¿”ï¼ˆRound-Trip Timeï¼‰æ‰èƒ½å»ºç«‹é€£ç·šï¼šç¬¬ä¸€æ¬¡å¾€è¿”ç”¨æ–¼ Hello è¨Šæ¯èˆ‡åŠ å¯†å¥—ä»¶çš„å”å•†ï¼Œç¬¬äºŒæ¬¡å¾€è¿”å‰‡ç”¨æ–¼é‡‘é‘°äº¤æ›ã€‚\nä¸€å€‹ RTT ä¸æ„å‘³è‘—é›™æ–¹åªç™¼é€ä¸€å€‹å°åŒ…ï¼Œå…¶é‡é»åœ¨æ–¼ã€Œç­‰å¾…ã€ã€‚ä»¥ Client çš„è¦–è§’ä¾†çœ‹ï¼Œå®ƒç™¼å‡ºÂ ClientHelloÂ å¾Œï¼Œå¿…é ˆç­‰åˆ° Server å›æ‡‰Â ServerHelloDoneÂ è¨Šæ¯ï¼Œæ‰èƒ½ç¹¼çºŒå¾ŒçºŒçš„å‹•ä½œã€‚é€™æ•´å€‹ã€Œç™¼é€ -\u0026gt; ç­‰å¾… -\u0026gt; æ”¶åˆ°å›æ‡‰ã€çš„éç¨‹å°±æ˜¯ä¸€å€‹ RTTã€‚\nTLS 1.3 é€éå¤§è†½çš„æµç¨‹é‡æ§‹ï¼Œå°‡å…¶ç¸®æ¸›ç‚ºä¸€æ¬¡å¾€è¿”ï¼ˆ1-RTTï¼‰ï¼Œé¡¯è‘—é™ä½äº†å»ºç«‹é€£ç·šçš„å»¶é²ã€‚\nsequenceDiagram participant Client participant Server rect rgb(200, 255, 200) Note over Client,Server: åˆå§‹ Client Hello (ç¬¬ä¸€è¼ªé€šè¨Šæ™‚é–“ RTT é–‹å§‹) Client-\u0026gt;\u0026gt;Server: ClientHello (ç‰ˆæœ¬ã€éš¨æ©Ÿæ•¸ã€åŠ å¯†å¥—ä»¶ã€supported_groupsã€key_shareã€PSK*ã€ECH*) end rect rgb(200, 200, 255) Note over Client,Server: ä¼ºæœå™¨å›æ‡‰ (ç¬¬ä¸€è¼ªé€šè¨Šæ™‚é–“ RTT çµæŸ) Server-\u0026gt;\u0026gt;Client: ServerHello (ç‰ˆæœ¬ã€éš¨æ©Ÿæ•¸ã€é¸å®šçš„åŠ å¯†å¥—ä»¶ã€key_shareã€PSK*) Note right of Server: ä¼ºæœå™¨å·²è¨ˆç®—å‡ºå…±äº«å¯†é‘° Server-\u0026gt;\u0026gt;Client: {EncryptedExtensions} (ä¾‹å¦‚ï¼šALPNã€supported_versions) alt å¦‚æœä¼ºæœå™¨èªè­‰ Server-\u0026gt;\u0026gt;Client: {Certificate*} Server-\u0026gt;\u0026gt;Client: {CertificateVerify*(ç”¨æ†‘è­‰å°å‰é¢çš„æ¡æ‰‹è¨Šæ¯ç°½ç« )} end Server-\u0026gt;\u0026gt;Client: {Finished} (é©—è­‰é›œæ¹Š) end rect rgb(255, 200, 200) Note over Client,Server: å®¢æˆ¶ç«¯èªè­‰ (å¯é¸) èˆ‡å®Œæˆ alt å¦‚æœä¼ºæœå™¨è¦æ±‚å®¢æˆ¶ç«¯èªè­‰ (é€é EncryptedExtensions) Client-\u0026gt;\u0026gt;Server: {Certificate*} Client-\u0026gt;\u0026gt;Server: {CertificateVerify*(ç”¨æ†‘è­‰å°å‰é¢çš„æ¡æ‰‹è¨Šæ¯ç°½ç« )} end Client-\u0026gt;\u0026gt;Server: {Finished} (é©—è­‰é›œæ¹Š) end Client\u0026lt;\u0026lt;--\u0026gt;\u0026gt;Server: æ‡‰ç”¨ç¨‹å¼è³‡æ–™ (åŠ å¯†) alt HelloRetryRequest (å¦‚æœå®¢æˆ¶ç«¯çŒœæ¸¬éŒ¯èª¤) Server--\u0026gt;\u0026gt;Client: HelloRetryRequest Client-\u0026gt;\u0026gt;Server: ClientHello (å¸¶æœ‰æ­£ç¢ºçš„ key_share) Note over Client,Server: æ­¤è·¯å¾‘è®Šæˆ 2-RTT end ç‚ºäº†å¯¦ç¾ 1-RTTï¼ŒTLS 1.3 çš„åšæ³•æ˜¯è®“ Client è®Šå¾—æ›´ã€Œç©æ¥µä¸»å‹•ã€ï¼š\næ¨æ¸¬æ€§é‡‘é‘°äº¤æ›ï¼šåœ¨ TLS 1.2 ä¸­ï¼ŒClient éœ€ç­‰å¾… Server ç¢ºèªé‡‘é‘°äº¤æ›ç®—æ³•å¾Œï¼Œæ‰æœƒåœ¨ç¬¬äºŒè¼ªé€šè¨Šä¸­ç™¼é€è‡ªå·±çš„å…¬é‘°ã€‚åœ¨ TLS 1.3 ä¸­ï¼ŒClient æœƒåœ¨ç¬¬ä¸€å€‹ ClientHello è¨Šæ¯è£¡ï¼Œé€é supported_groups æ“´å±•åˆ—å‡ºè‡ªå·±æ”¯æ´çš„ (EC)DHE æ¼”ç®—æ³•åƒæ•¸ï¼ˆå¦‚æ©¢åœ“æ›²ç·š secp256r1ï¼‰ï¼Œä¸¦æ¨æ¸¬ Server å¯èƒ½æœƒé¸æ“‡çš„åƒæ•¸ï¼Œç›´æ¥åœ¨ key_share æ“´å±•ä¸­é™„ä¸Šå°æ‡‰çš„ (EC)DHE è‡¨æ™‚å…¬é‘°ã€‚ supported_groups æ“´å±•åœ¨ TLS 1.2 æ—©æœŸå«åš elliptic_curvesï¼Œç”¨ä¾†å”å•† ECDHE å…·é«”ä½¿ç”¨çš„æ©¢åœ“æ›²ç·šåƒæ•¸ã€‚å¾Œä¾†åœ¨ RFC 7919 ä¸­ï¼Œè®Šæ›´ç‚º supported_groupsã€‚Finite Field DHE (FFDHE) æŒ‡çš„æ˜¯åŸºæ–¼è³ªæ•¸è¨ˆç®—çš„ FFDHEï¼Œé€šå¸¸æˆ‘å€‘èªª DHE æ™‚ï¼ŒæŒ‡ä»£çš„æ˜¯ FFDHEï¼Œé€é supported_groups é™¤äº†å”å•† ECDHE ä½¿ç”¨çš„æ›²ç·šå¤–ï¼Œä¹Ÿå¯ä»¥å”å•† FFDHE ä½¿ç”¨çš„åƒæ•¸é•·åº¦ï¼Œæ¯”å¦‚ ffdhe2048ã€‚\næˆåŠŸæƒ…å¢ƒï¼šå¦‚æœ Server æ”¯æ´ Client æ¨æ¸¬çš„é‡‘é‘°äº¤æ›æ¼”ç®—æ³•å’Œåƒæ•¸ï¼Œå®ƒå°±æœƒåœ¨ ServerHello ä¸­ä¹Ÿé™„ä¸Šè‡ªå·±çš„ key_shareï¼Œæ­¤æ™‚é›™æ–¹ç«‹åˆ»å°±èƒ½è¨ˆç®—å‡ºå…±äº«å¯†é‘°ï¼Œé‡‘é‘°äº¤æ›åœ¨ä¸€å€‹ä¾†å›å…§å®Œæˆï¼\nå¤±æ•—æƒ…å¢ƒï¼šå¦‚æœ Clientã€ŒçŒœéŒ¯äº†ã€ï¼ŒServer æœƒå›è¦†ä¸€å€‹ HelloRetryRequest è¨Šæ¯ï¼Œå‘ŠçŸ¥è‡ªå·±é¸æ“‡çš„é‡‘é‘°äº¤æ›æ¼”ç®—æ³•å’Œåƒæ•¸ï¼Œè¦æ±‚ Client é‡æ–°ç™¼é€ä¸€å€‹å¸¶æœ‰æ­£ç¢º key_share çš„ ClientHelloã€‚é€™ç¨®æƒ…æ³ä¸‹äº¤æ¡æ™‚é–“æœƒé€€åŒ–ç‚º 2-RTTã€‚\nç›¡æ—©åŠ å¯†ï¼šé è¨­çš„éš±ç§ä¿è­· # åœ¨ TLS 1.2 ä¸­ï¼ŒServerHello ä¹‹å¾Œçš„ä¼ºæœå™¨æ†‘è­‰ï¼ˆCertificateï¼‰ç­‰è¨Šæ¯éƒ½æ˜¯æ˜æ–‡å‚³è¼¸çš„ã€‚è€Œåœ¨ TLS 1.3 ä¸­ï¼Œä¸€æ—¦ Server é€å‡º ServerHelloï¼Œå¾ŒçºŒæ‰€æœ‰äº¤æ¡è¨Šæ¯ï¼ˆåŒ…æ‹¬ä¼ºæœå™¨æ†‘è­‰ã€æ“´å±•ç­‰ï¼‰éƒ½æœƒè¢«åŠ å¯†åœ¨ EncryptedExtensions ä¸­ï¼Œå¤§å¤§å¢å¼·äº†éš±ç§æ€§ã€‚\nç‚ºäº†ç›¸å®¹è€Œç”Ÿçš„å·§æ€ # TLS 1.3 çš„æ”¹å‹•å¦‚æ­¤å·¨å¤§ï¼Œå¦‚ä½•åœ¨å……æ»¿è€èˆŠè¨­å‚™çš„ç¶²è·¯ä¸Šé †åˆ©éƒ¨ç½²ï¼Ÿç‚ºæ­¤ï¼ŒTLS 1.3 æ¡ç”¨äº†å·§å¦™çš„ã€Œå½è£ã€ç­–ç•¥ä¾†æ‡‰å°ï¼š\nå½è£ç‰ˆæœ¬è™Ÿï¼šTLS 1.3 çš„ ClientHello å°åŒ…ä¸­ï¼Œlegacy_version æ¬„ä½æœƒè¢«è¨­ç‚º 0x0303ï¼ˆå³ TLS 1.2ï¼‰ã€‚è€ŒçœŸæ­£æ”¯æ´çš„ç‰ˆæœ¬åˆ—è¡¨å‰‡æ”¾åœ¨ supported_versions é€™å€‹æ“´å±•ä¸­ã€‚é›–ç„¶æ¬„ä½åç¨±å«åš legacy_version ä½†å¯¦éš›ç·¨ç¢¼æˆäºŒé€²ä½å¾Œï¼Œlegacy_version å’ŒåŸæœ¬çš„ version æ¬„ä½æ˜¯åŒæ¨£çš„ï¼Œåªæ˜¯åç¨±ä¸Šä¸åŒã€‚ RFC ä¸­æåˆ°ï¼Œé€™éº¼åšçš„åŸå› æ˜¯è¨±å¤šè€èˆŠçš„ä¼ºæœå™¨æˆ–ç¶²è·¯ä¸­ä»‹è¨­å‚™ï¼ˆMiddleboxesï¼‰å¯¦ç¾æ²’æœ‰æ­£ç¢ºå¯¦ä½œç‰ˆæœ¬å”å•†çš„åŠŸèƒ½ï¼Œé€²è€Œç„¡æ³•æ­£ç¢ºè™•ç†æœªçŸ¥çš„ TLS ç‰ˆæœ¬è™Ÿã€‚å¦‚æœ Client ç›´æ¥å®£å‘Š 1.3 ç‰ˆï¼Œé€™äº›è¨­å‚™å¯èƒ½æœƒç›´æ¥ä¸­æ–·é€£ç·šï¼Œé€ æˆã€Œç‰ˆæœ¬ä¸å®¹å¿ã€ï¼ˆVersion Intoleranceï¼‰å•é¡Œã€‚\næ ¼å¼å…¼å®¹ï¼šé›–ç„¶ TLS 1.3 æœ‰è¨±å¤šæ”¹å‹•çš„éƒ¨åˆ†ï¼Œä½†é€™äº›æ”¹å‹•çš„å…§å®¹éƒ½è¢«ç§»å‹•åˆ° extension ä¸­ï¼ŒTLS 1.3 çš„ ClientHello æ ¼å¼æ˜¯å®Œå…¨ç¬¦åˆçš„ ClientHelloã€‚å°ä¸€å€‹åªæ”¯æ´åˆ° TLS 1.2 çš„è¨­å‚™ï¼Œå®Œå…¨å¯ä»¥é™ç´šåˆ° TLS 1.2 å®Œæˆæ¡æ‰‹ã€‚ ç‚ºäº†é¿å…é™ç´šæ”»æ“Šï¼ŒTLS 1.3 æœ‰å°ˆé–€è¨­è¨ˆçš„é™ç´šä¿è­·æ©Ÿåˆ¶ã€‚é™ç´šæ”»æ“Šæ˜¯é€éæŸäº›æ‰‹æ®µè®“ä¼ºæœå™¨å’Œå®¢æˆ¶ç«¯å”å•†æ±ºå®šä½¿ç”¨è¼ƒèˆŠå­˜åœ¨æ¼æ´çš„ TLS/SSL ç‰ˆæœ¬ã€‚æ¯”å¦‚é˜»æ–· client ä½¿ç”¨ TLS 1.3 æ¡æ‰‹çš„å°åŒ…ï¼Œé‚£ Client å¯èƒ½å°±æœƒå˜—è©¦ä½¿ç”¨è¼ƒèˆŠçš„ç‰ˆæœ¬æ¡æ‰‹ã€‚æ”¯æ´ TLS 1.3 çš„ server ç™¼ç¾å®¢æˆ¶ç«¯æ±ºå®šä½¿ç”¨è¼ƒèˆŠçš„ TLS ç‰ˆæœ¬ (TLS 1.2 æˆ–æ›´æ—©) æ™‚ï¼Œæœƒå°‡ ServerHello çš„ random number çš„æœ«å¹¾ä½å¡«æˆä¸€å€‹å›ºå®šå€¼ï¼Œclient ç™¼ç¾ random number åŒ…å«é€™å€‹å›ºå®šå€¼ï¼Œå°±çŸ¥é“ server å…¶å¯¦æ˜¯æ”¯æ´ TLS 1.3 çš„ï¼Œå¤±æ•—æ˜¯å› ç‚ºæœ‰å¤–éƒ¨å½±éŸ¿ã€‚åˆå› ç‚º random number è¢« TLS æ¡æ‰‹æœ¬èº«æ©Ÿåˆ¶ä¿è­·ï¼Œæ‰€ä»¥ä¹Ÿä¸å¯èƒ½è¢«ç¯¡æ”¹ã€‚\næ¨¡æ“¬èˆŠæµç¨‹ï¼šç‚ºäº†æ¬ºé¨™é‚£äº›åš´æ ¼æª¢æŸ¥ TLS 1.2 æµç¨‹çš„ä¸­ä»‹è¨­å‚™ï¼ŒTLS 1.3 çš„äº¤æ¡éç¨‹æœƒç™¼é€ä¸€äº›ç„¡æ„ç¾©çš„è™›æ“¬å°åŒ…ï¼Œä¾‹å¦‚ ChangeCipherSpecï¼Œä¸¦åœ¨ session_id æ¬„ä½å¡«å…¥éš¨æ©Ÿå€¼ï¼Œä½¿å…¶çœ‹èµ·ä¾†æ›´åƒä¸€å€‹æ¨™æº–çš„ TLS 1.2 æµç¨‹ï¼Œå¾è€Œé¿å…è¢«éŒ¯èª¤åœ°é˜»æ“‹ã€‚ PSKã€é€£ç·šæ¢å¾©èˆ‡ 0-RTTï¼šå…¼é¡§æ•ˆèƒ½èˆ‡å®‰å…¨ # TLS 1.3 å¦å¤–ä¸€å€‹é‡å¤§æ”¹è®Šæ˜¯ï¼Œé‡æ–°è¨­è¨ˆäº†é€£ç·šæ¢å¾©æ©Ÿåˆ¶ï¼Œå°‡ TLS 1.2 çš„ Session ID å’Œ Session Ticket çµ±ä¸€æ•´åˆåˆ°ä¸€å€‹æ›´å®‰å…¨ã€æ›´å¼·å¤§çš„**é å…±äº«é‡‘é‘°ï¼ˆPSKï¼‰**æ¡†æ¶ä¸­ï¼Œä¸¦å¾¹åº•è§£æ±ºäº†å…ˆå‰ç‰ˆæœ¬ä¸­ Session Ticket ç¼ºä¹å‘å‰ä¿å¯†æ€§çš„å•é¡Œã€‚\nåœ¨ä»‹ç´¹ TLS 1.2 PSK æ™‚æœ‰èªªæ˜ï¼Œå› ç‚ºé›™æ–¹æœƒç›´æ¥ä½¿ç”¨ PSK ä½œç‚º premaster secretï¼Œæ‰€ä»¥å¦‚ PSK å¤–æ´©ï¼Œå°±å¯ä»¥è§£å¯†æ‰€æœ‰æ­·å²å°åŒ…ã€‚\nå…·å‚™å‘å‰ä¿å¯†æ€§çš„é€£ç·šæ¢å¾© # åœ¨ TLS 1.3 ä¸­ï¼Œç•¶ä¸€æ¬¡æˆåŠŸçš„å®Œæ•´äº¤æ¡çµæŸå¾Œï¼ŒServer æœƒç™¼é€ NewSessionTicket çµ¦ Clientï¼Œé€™å€‹ Ticket å°±è¢«è¦–ç‚ºä¸€å€‹ PSKã€‚\nç•¶ Client å¸Œæœ›æ¢å¾©é€£ç·šæ™‚ï¼š\nå®ƒåœ¨ ClientHello ä¸­åŒæ™‚æä¾› PSKï¼ˆä¾†è‡ª Ticketï¼‰å’Œä¸€å€‹æ–°çš„è‡¨æ™‚å…¬é‘°ï¼ˆåœ¨ key_share æ“´å±•ä¸­ï¼‰ã€‚ Server é©—è­‰ PSK å¾Œï¼Œä¹Ÿæœƒæä¾›ä¸€å€‹æ–°çš„è‡¨æ™‚å…¬é‘°ã€‚ æœ€çµ‚çš„æœƒè©±é‡‘é‘°ï¼Œæ˜¯ç”± PSK å’Œæœ¬æ¬¡æ–°çš„ (EC)DHE äº¤æ›çµæœï¼Œå…©è€…ä¸€åŒç¶“é HKDF æ··åˆè¡ç”Ÿå‡ºä¾†çš„ã€‚ graph TD subgraph \u0026#34;TLS 1.3 PSK Key Derivation\u0026#34; A[\u0026#34;Previous Session PSK\u0026lt;br/\u0026gt;(from Ticket)\u0026#34;] --\u0026gt; HKDF_Extract0(HKDF-Extract); HKDF_Extract0(HKDF-Extract) --\u0026gt;Early[Early Secret] B[\u0026#34;Current Handshake (EC)DHE Shared Secret\u0026#34;] --\u0026gt; HKDF_Extract; Early--\u0026gt;HKDF_Extract(HKDF_Extract) HKDF_Extract --\u0026gt; C[Handshake Secret]; C --\u0026gt; HKDF_Extract2(HKDF-Extract); HKDF_Extract2 --\u0026gt; D[\u0026#34;Master Secret\u0026#34;]; end å› æ­¤åœ¨é€™å€‹æ¶æ§‹ä¸‹ï¼Œå³ä½¿æ”»æ“Šè€…ç«Šå–äº†ç”¨æ–¼åŠ å¯† Ticket çš„ä¼ºæœå™¨é‡‘é‘°ä¸¦è§£å‡ºäº† PSKï¼Œä½†ç”±æ–¼ç¼ºä¹ç•¶æ¬¡é€£ç·šè‡¨æ™‚ç”Ÿæˆçš„ (EC)DHE ç§é‘°ï¼Œä»–ä¾ç„¶ç„¡æ³•è¨ˆç®—å‡ºæœ€çµ‚çš„æœƒè©±é‡‘é‘°ã€‚\n0-RTTï¼šé›¶å¾€è¿”æ™‚é–“æ¢å¾© # åœ¨ PSK çš„åŸºç¤ä¸Šï¼ŒTLS 1.3 é‚„å¼•å…¥äº† 0-RTTï¼ˆZero Round Trip Time Resumptionï¼‰ã€‚Client å¯ä»¥åœ¨ç™¼é€ç¬¬ä¸€å€‹ ClientHello çš„åŒæ™‚ï¼Œå°±ä½¿ç”¨ PSK è¡ç”Ÿçš„é‡‘é‘°åŠ å¯†ç¬¬ä¸€æ‰¹æ‡‰ç”¨æ•¸æ“šï¼ˆEarly Dataï¼‰ä¸¦é€é early_data extension ç™¼é€å‡ºå»ã€‚\n0-RTT çš„é¢¨éšªï¼šé‡æ”¾æ”»æ“Šï¼ˆReplay Attack) # 0-RTT æå‡äº†æ•ˆèƒ½ï¼Œä½†ä¹Ÿå¸¶ä¾†äº†åš´é‡çš„å®‰å…¨éš±æ‚£ã€‚ç”±æ–¼ Server åœ¨æ”¶åˆ° 0-RTT æ•¸æ“šæ™‚ï¼Œå°šæœªå®Œæˆå®Œæ•´çš„äº¤æ¡ä¾†é©—è­‰ Client çš„å”¯ä¸€æ€§ï¼Œæ”»æ“Šè€…å¯ä»¥å–å¾—é€™æ‰¹åŠ å¯†å°åŒ…ä¸¦å¤šæ¬¡ç™¼é€çµ¦ä¼ºæœå™¨ã€‚\nåœ¨ TLS å…§éƒ¨ä¹Ÿå…·æœ‰ seqence number æ©Ÿåˆ¶ï¼Œæœƒè¨˜éŒ„ç•¶å‰å‚³è¼¸åˆ°ç¬¬å¹¾å€‹ TLS å°åŒ…ï¼Œä¸¦åŠ å…¥åˆ°å°åŒ…çš„ MAC è¨ˆç®—ä¸­ï¼Œæ‰€ä»¥ä¸€èˆ¬çš„ TLS é€£ç·šå¯ä»¥é˜²ç¦¦ replay attackã€‚å° 0-RTT è€Œè¨€ï¼Œæ”»æ“Šçš„æ°¸é æ˜¯ç¬¬ä¸€å€‹å°åŒ…æ‰€ä»¥ seqence number æ©Ÿåˆ¶ç„¡æ³•é˜²ç¦¦ã€‚\nä¸€å€‹ç”¨æ–¼æ‰£æ¬¾çš„ API è«‹æ±‚è‹¥ä»¥ 0-RTT ç™¼é€ï¼Œæ”»æ“Šè€…é‡æ”¾è©²è«‹æ±‚å°±å¯èƒ½å°è‡´ç”¨æˆ¶è¢«é‡è¤‡æ‰£æ¬¾ã€‚å› æ­¤ï¼Œ0-RTT åªé©ç”¨æ–¼é‚£äº›è¢«é‡æ”¾ä¹Ÿç„¡å®³çš„è«‹æ±‚ï¼ˆå¦‚å†ªç­‰çš„ GET è«‹æ±‚ï¼‰ï¼Œæ‡‰ç”¨ç¨‹å¼å±¤å¯ä»¥é€é Early-Data: 1ï¼Œä¾†ç¢ºèªé€™æ˜¯ä¸€å€‹ 0-RTT requetsï¼Œè¬¹æ…è™•ç†ã€‚æŠ‘æˆ–æ˜¯ä¼ºæœå™¨å¯ä»¥å¯¦ç¾ One-Shot Ticketsï¼Œç™¼è¡Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡çš„ Session Ticketï¼Œä½†å°æ–¼ç¾åœ¨çš„å¤šä¼ºæœå™¨æ¶æ§‹è€Œè¨€ï¼Œå¯¦ç¾è·¨ä¼ºæœå™¨çš„åŒæ­¥æœƒæœ‰é¡å¤–çš„å›°é›£ã€‚\nEncrypted Client Hello # TLS 1.3 æˆåŠŸè®“ TLS è®Šå¾—æ›´åŠ å®‰å…¨èˆ‡éš±ç§ï¼Œä½†ä»å­˜åœ¨ä¸€å€‹é‡å¤§çš„éš±ç§æ¼æ´ï¼Œé‚£å°±æ˜¯é™„å±¬åœ¨ ClientHello ä¸­çš„ Server Name Indicationï¼ˆSNIï¼‰ã€‚SNI çš„åŠŸèƒ½æ˜¯è®“ä¼ºæœå™¨çŸ¥é“ç”¨æˆ¶ç«¯è¦é€£ç·šçš„ä¸»æ©Ÿåç¨±ï¼Œå°æ–¼åŒæ™‚æœå‹™å¤šå€‹åŸŸåçš„ä¼ºæœå™¨è€Œè¨€ï¼Œæ‰èƒ½æ­£ç¢ºåœ°è¼‰å…¥å°æ‡‰çš„ä¸»æ©Ÿè¨­å®šæª”ä¾†è™•ç†è«‹æ±‚ã€‚ä½†é€™ä¹Ÿæ„å‘³è‘—ï¼Œç”¨æˆ¶ç«¯æ‰€è¨ªå•çš„ä¸»æ©Ÿåç¨±æœƒä»¥æ˜æ–‡å½¢å¼æš´éœ²åœ¨ç¶²è·¯ä¸Šï¼Œæˆç‚ºæ½›åœ¨çš„éš±ç§æ´©æ¼é»ã€‚\næœ€åˆæå‡ºçš„è§£æ³•æ˜¯ ESNIï¼ˆEncrypted SNIï¼‰ã€‚ç°¡å–®ä¾†èªªï¼ŒESNI åˆ©ç”¨ DNS è¨˜éŒ„ä¸­çš„å…¬é‘°åŠ å¯† SNIï¼Œä¸¦å°‡å…¶å°è£åœ¨ encrypted_sni æ“´å……æ¬„ä½ä¸­ï¼ŒåŒæ™‚æ­é… DoHï¼ˆDNS over HTTPSï¼‰ä¾†åŠ å¯† DNS æŸ¥è©¢ï¼Œè—‰æ­¤é˜²æ­¢å¤–éƒ¨è§€å¯Ÿè€…å¾—çŸ¥ç”¨æˆ¶å¯¦éš›æ¬²é€£ç·šçš„ä¸»æ©Ÿåç¨±ã€‚\nç„¶è€Œï¼ŒESNI é‡åˆ°äº†å¤šé …å¯¦å‹™ä¸Šçš„æŒ‘æˆ°ï¼šä¾‹å¦‚ç‰¹å¾µæ˜é¡¯ï¼Œå®¹æ˜“è¢«åµæ¸¬å‡ºæ­£åœ¨ä½¿ç”¨ ESNIï¼›å…¬é‘°é€é DNS å‚³éå­˜åœ¨å¿«å–èˆ‡åŒæ­¥å•é¡Œï¼›æ­¤å¤–ï¼ŒESNI åƒ…åŠ å¯† SNIï¼ŒClientHello å…¶ä»–æ¬„ä½ä»ç‚ºæ˜æ–‡ï¼Œä¸”ä¸€æ—¦è§£å¯†å¤±æ•—ï¼Œé€£ç·šå°±ç„¡æ³•ç¹¼çºŒå»ºç«‹ã€‚\n![[understanding-tls-1-3-key-exchange-and-handshake-1750351514981.png]]\nå› æ­¤ï¼Œç›®å‰ä¸»æµæ–¹å‘æ˜¯æ”¹æ¡ Encrypted Client Helloï¼ˆECHï¼‰ã€‚ECH ç›¸è¼ƒæ–¼ ESNI æ›´é€²ä¸€æ­¥ï¼Œç›´æ¥å°‡æ•´å€‹ ClientHello åŠ å¯†å¾Œï¼Œå°è£åœ¨å¦ä¸€å€‹å¤–å±¤çš„ ClientHello extension ä¸­ã€‚å¤–å±¤ ClientHello çœ‹èµ·ä¾†å°±åƒæ˜¯æ­£å¸¸çš„å°åŒ…ï¼Œé¿å…äº†æ˜é¡¯çš„ç‰¹å¾µæš´éœ²ã€‚\nä¸éï¼ŒESNI èˆ‡ ECH åœ¨å¯¦ä½œä¸Šä»æœ‰è¨±å¤šç´°ç¯€èˆ‡æŠ€è¡“æŒ‘æˆ°ï¼ŒåŒ…æ‹¬å¯†é‘°åˆ†ç™¼ã€å…¼å®¹æ€§è™•ç†ã€å›é€€æ©Ÿåˆ¶ç­‰ï¼Œé€™äº›éƒ¨åˆ†æœ¬æ–‡æš«ä¸æ·±å…¥è¨è«–ã€‚\nå°çµ # TLS 1.3 ç„¡ç–‘æ˜¯ç¶²è·¯å®‰å…¨é ˜åŸŸçš„ä¸€æ¬¡å·¨å¤§é£›èºã€‚å®ƒé€éç§»é™¤ä¸å®‰å…¨çš„è€èˆŠè¨­è¨ˆã€ç°¡åŒ–åŠ å¯†å¥—ä»¶ã€å°‡äº¤æ¡æµç¨‹æœ€ä½³åŒ–è‡³ 1-RTTï¼Œä¸¦æä¾›å…·å‚™å‘å‰ä¿å¯†æ€§çš„é€£ç·šæ¢å¾©æ©Ÿåˆ¶ï¼Œç‚ºæˆ‘å€‘å¸¶ä¾†äº†æ›´å¿«é€Ÿã€æ›´å®‰å…¨çš„ç¶²è·¯é«”é©—ã€‚é›–ç„¶ 0-RTT ç­‰æ–°åŠŸèƒ½å¼•å…¥äº†æ–°çš„æŒ‘æˆ°ï¼Œä½†æ•´é«”è€Œè¨€ï¼ŒTLS 1.3 ç‚ºæœªä¾†åå¹´ç¶²è·¯å‚³è¼¸å®‰å…¨å¥ å®šäº†å …å¯¦çš„åŸºç¤ã€‚\nåƒè€ƒæ–‡ç«  # RFC 8446 - The Transport Layer Security (TLS) Protocol Version 1.3 RFC 5246 - The Transport Layer Security (TLS) Protocol Version 1.2 How does TLS 1.3 protect against downgrade attacks? | The blog of a gypsy engineer https://www.cloudflare.com/zh-tw/learning/ssl/what-is-encrypted-sni/ ä¼ºæœå™¨åç¨±æŒ‡ç¤º - ç¶­åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨æ›¸\n","date":"June 28 2025","externalUrl":null,"permalink":"/posts/understanding-tls-1-3-key-exchange-and-handshake/","section":"æ–‡ç« ","summary":"","title":"ææ‡‚ TLS 1.3ï¼šæ›´å¿«ã€æ›´å®‰å…¨çš„æ¬¡ä¸–ä»£å‚³è¼¸å±¤å®‰å…¨å”å®š","type":"posts"},{"content":"","date":"June 28 2025","externalUrl":null,"permalink":"/tags/%E8%B3%87%E5%AE%89/","section":"æ¨™ç±¤","summary":"","title":"è³‡å®‰","type":"tags"},{"content":"","date":"June 28 2025","externalUrl":null,"permalink":"/tags/%E7%B6%B2%E8%B7%AF%E5%8D%94%E5%AE%9A/","section":"æ¨™ç±¤","summary":"","title":"ç¶²è·¯å”å®š","type":"tags"},{"content":"åœ¨ Kubernetes ä¸­ï¼Œæˆ‘å€‘æœƒç‚ºå®¹å™¨æŒ‡å®šÂ memoryÂ çš„Â limitsÂ èˆ‡Â requestsï¼Œé€™äº›é™åˆ¶åˆæœƒè¢«è½‰æ›æˆ Linux cgroup çš„è¨­å®šã€‚Linux æ ¸å¿ƒæ˜¯å¦‚ä½•å¯¦ç¾è¨˜æ†¶é«”é™åˆ¶çš„ï¼Ÿç•¶ä¸€å€‹è¡Œç¨‹çš„è¨˜æ†¶é«”ç”³è«‹è¶…éä¸Šé™æ™‚ï¼Œåˆæ˜¯ä»€éº¼æ©Ÿåˆ¶è§¸ç™¼äº† OOM (Out Of Memory) Killï¼Ÿ\næœ¬ç¯‡æ–‡ç« æ·±å…¥æ¢ç´¢ Linux æ ¸å¿ƒçš„è¨˜æ†¶é«” cgroup ç®¡ç†æ©Ÿåˆ¶ï¼Œä»¥Â Linux æ ¸å¿ƒ v6.15 ç‰ˆæœ¬çš„åŸå§‹ç¢¼ç‚ºåŸºç¤ï¼Œå¾ cgroup v2 memory controller çš„ä½¿ç”¨è€…ä»‹é¢å‡ºç™¼ï¼Œä¸€æ­¥æ­¥å‘ä¸‹è¿½è¹¤ï¼Œè©³ç´°è§£æå…¶æ ¸å¿ƒè³‡æ–™çµæ§‹ (struct mem_cgroup,Â struct page_counter)ã€éšå±¤å¼çš„è¨˜æ†¶é«”ã€Œæ”¶è²»ã€(charge) æ©Ÿåˆ¶ã€è¨˜æ†¶é«”å›æ”¶èˆ‡ OOM Kill çš„å®Œæ•´è§¸ç™¼è·¯å¾‘ã€‚æœ€çµ‚ï¼Œæˆ‘å€‘å°‡é€™ä¸€åˆ‡èˆ‡ Kubernetes çš„è¨˜æ†¶é«”è³‡æºé…ç½® (limitsÂ èˆ‡ QoS) è¯ç¹«èµ·ä¾†ï¼Œå¾¹åº•æ‰“é€šå¾ K8s YAML è¨­å®šåˆ° Kernel åº•å±¤å¯¦ç¾çš„ä»»ç£äºŒè„ˆã€‚\ncgroup v2 memory controller çš„ä½¿ç”¨æ–¹å¼ # cgroup v2 æä¾›äº†è±å¯Œçš„æª”æ¡ˆä»‹é¢ä¾†ç®¡ç†å’Œç›£æ§è¨˜æ†¶é«”è³‡æºã€‚è¦ä½¿ç”¨ memory cgroupï¼Œé¦–å…ˆéœ€è¦å»ºç«‹ä¸€å€‹ cgroupï¼š\nmkdir /sys/fs/cgroup/test å»ºç«‹å¾Œï¼Œè©²ç›®éŒ„ä¸‹æœƒè‡ªå‹•ç”Ÿæˆä¸€ç³»åˆ—èˆ‡è¨˜æ†¶é«”ç›¸é—œçš„æ§åˆ¶æª”æ¡ˆï¼Œæˆ‘å€‘å¯ä»¥é€éé€™äº›æª”æ¡ˆä¾†é…ç½®å’ŒæŸ¥çœ‹ cgroup çš„è¨˜æ†¶é«”ç‹€æ…‹ï¼š\nls /sys/fs/cgroup/test | grep memory memory.current memory.events memory.events.local memory.high memory.low memory.max memory.min memory.numa_stat memory.oom.group memory.peak memory.pressure memory.reclaim memory.stat memory.swap.current memory.swap.events memory.swap.high memory.swap.max memory.swap.peak memory.zswap.current memory.zswap.max memory.zswap.writeback ä»¥ä¸‹æ˜¯é€™äº›æª”æ¡ˆçš„è©³ç´°èªªæ˜ï¼š\nmemory.currentÂ (å”¯è®€): é¡¯ç¤ºæ­¤ cgroup åŠå…¶æ‰€æœ‰å¾Œä»£ cgroup ç›®å‰ä½¿ç”¨çš„ç¸½è¨˜æ†¶é«”é‡ï¼ˆåŒ…å«æª”æ¡ˆå¿«å–å’ŒåŒ¿åè¨˜æ†¶é«”ï¼‰ï¼Œå–®ä½ç‚ºä½å…ƒçµ„ (Bytes)ã€‚\nmemory.eventsÂ (å”¯è®€): åŒ…å«æ­¤ cgroup åŠå…¶å¾Œä»£ cgroup ç´¯è¨ˆçš„è¨˜æ†¶é«”äº‹ä»¶è¨ˆæ•¸ï¼Œä¾‹å¦‚Â lowÂ (è¨˜æ†¶é«”ä½¿ç”¨é‡ä½æ–¼Â memory.lowÂ çš„æ¬¡æ•¸)ã€highÂ (è¨˜æ†¶é«”ä½¿ç”¨é‡è¶…éÂ memory.highÂ ä¸¦è§¸ç™¼è¨˜æ†¶é«”å›æ”¶çš„æ¬¡æ•¸)ã€maxÂ (è¨˜æ†¶é«”ä½¿ç”¨é‡é”åˆ°Â memory.maxÂ ä¸Šé™çš„æ¬¡æ•¸)ã€oomÂ (ç™¼ç”Ÿ OOM çš„æ¬¡æ•¸) å’ŒÂ oom_killÂ (å›  OOM killer è¢«æ®ºæ­»çš„æ¬¡æ•¸)ï¼Œä»¥åŠè¨­å®š memory.oom.group è®“æ‰€æœ‰ process ä¸€èµ·è¢« OOM Kill æ®ºæ‰çš„æ¬¡æ•¸ oom_group_killã€‚\ncat /sys/fs/cgroup/kubepods/memory.events low 0 high 0 max 0 oom 0 oom_kill 0 oom_group_kill 0 memory.events.localÂ (å”¯è®€): é¡ä¼¼æ–¼Â memory.eventsï¼Œä½†åªåŒ…å«æ­¤ cgroup æœ¬èº«çš„è¨˜æ†¶é«”äº‹ä»¶è¨ˆæ•¸ï¼Œä¸åŒ…å«å…¶å¾Œä»£ cgroupã€‚\nmemory.maxÂ (å¯è®€å¯«): è¨­å®šè¨˜æ†¶é«”ä½¿ç”¨çš„ç¡¬ä¸Šé™ã€‚cgroup åŠå…¶å¾Œä»£çš„ç¸½è¨˜æ†¶é«”ä½¿ç”¨é‡ä¸å…è¨±è¶…éæ­¤å€¼ï¼Œè‹¥è¶…éä¸”ç„¡æ³•å›æ”¶è¶³å¤ è¨˜æ†¶é«”ï¼Œå¯èƒ½è§¸ç™¼ OOM killerã€‚å–®ä½ç‚ºä½å…ƒçµ„ï¼Œå¯å¯«å…¥Â maxÂ è¡¨ç¤ºä¸é™åˆ¶ã€‚\nmemory.highÂ (å¯è®€å¯«): è¨­å®šè¨˜æ†¶é«”ä½¿ç”¨çš„é«˜æ°´ä½ç·šã€‚ç•¶ cgroup è¨˜æ†¶é«”ç”¨é‡è¶…éæ­¤å€¼æ™‚ï¼Œæ ¸å¿ƒæœƒé–‹å§‹é€²è¡Œè¨˜æ†¶é«”å›æ”¶ã€‚å–®ä½ç‚ºä½å…ƒçµ„ï¼Œè¨­å®šç‚ºÂ 0Â å‰‡ç¦ç”¨æ­¤æ©Ÿåˆ¶ã€‚\nmemory.lowÂ (å¯è®€å¯«): è¨­å®šè¨˜æ†¶é«”ä½¿ç”¨çš„ä½æ°´ä½ç·šã€‚ç•¶ cgroup è¨˜æ†¶é«”ç”¨é‡ä½æ–¼æ­¤å€¼æ™‚ï¼Œæ ¸å¿ƒæœƒç›¡åŠ›ä¿è­·å…¶è¨˜æ†¶é«”ä¸è¢«å›æ”¶ã€‚å–®ä½ç‚ºä½å…ƒçµ„ï¼Œè¨­å®šç‚ºÂ 0Â å‰‡ç¦ç”¨æ­¤æ©Ÿåˆ¶ã€‚\nmemory.minÂ (å¯è®€å¯«): è¨­å®šè¨˜æ†¶é«”ä½¿ç”¨çš„æœ€ä½ä¿è­‰ã€‚æ ¸å¿ƒæœƒç›¡åŠ›ç¢ºä¿ cgroup è¨˜æ†¶é«”ä½¿ç”¨é‡ä¸ä½æ–¼æ­¤å€¼ï¼Œå³ä½¿ç³»çµ±è¨˜æ†¶é«”å£“åŠ›å¤§ä¹Ÿæœƒå˜—è©¦æ»¿è¶³ã€‚å–®ä½ç‚ºä½å…ƒçµ„ï¼Œè¨­å®šç‚ºÂ 0Â å‰‡ç¦ç”¨æ­¤æ©Ÿåˆ¶ã€‚é€™èˆ‡Â memory.lowÂ é¡ä¼¼ï¼Œä½†Â memory.minÂ æä¾›äº†æ›´å¼·çš„ä¿è­‰ï¼Œåœ¨ç³»çµ±è¨˜æ†¶é«”å£“åŠ›æ¥µå¤§æ™‚ï¼Œä»æœƒå˜—è©¦æ»¿è¶³æ­¤ä¸‹é™ã€‚å¦‚æœå¤šå€‹ cgroup çš„Â memory.minÂ ç¸½å’Œè¶…éç³»çµ±å¯ç”¨è¨˜æ†¶é«”ï¼Œå‰‡æŒ‰æ¯”ä¾‹åˆ†é…ã€‚\nmemory.numa_statÂ (å”¯è®€): æä¾›æ­¤ cgroup åœ¨æ¯å€‹ NUMA ç¯€é»ä¸Šçš„è¨˜æ†¶é«”ä½¿ç”¨çµ±è¨ˆã€‚\ncat /sys/fs/cgroup/kubepods/memory.numa_stat anon N0=38768640 file N0=136495104 kernel_stack N0=442368 pagetables N0=733184 sec_pagetables N0=0 shmem N0=0 file_mapped N0=117633024 file_dirty N0=0 file_writeback N0=0 swapcached N0=0 anon_thp N0=0 file_thp N0=0 shmem_thp N0=0 inactive_anon N0=10817536 active_anon N0=27951104 inactive_file N0=31703040 active_file N0=104792064 unevictable N0=0 slab_reclaimable N0=601576 slab_unreclaimable N0=831064 workingset_refault_anon N0=0 workingset_refault_file N0=0 workingset_activate_anon N0=0 workingset_activate_file N0=0 workingset_restore_anon N0=0 workingset_restore_file N0=0 workingset_nodereclaim N0=0 memory.oom.groupÂ (å¯è®€å¯«): æ§åˆ¶ OOM killer çš„è¡Œç‚ºã€‚è¨­å®šç‚ºÂ 0Â (é è¨­) æ™‚ï¼ŒOOM killer åªæ®ºæ­»è§¸ç™¼ OOM çš„ç¨‹åºã€‚è¨­å®šç‚ºÂ 1Â æ™‚ï¼ŒOOM killer æœƒæ®ºæ­» cgroup å…§æ‰€æœ‰ç¨‹åºã€‚\nmemory.peakÂ (å”¯è®€ï¼Œå¯å¯«å…¥Â 0Â é‡ç½®): é¡¯ç¤ºæ­¤ cgroup è‡ªå»ºç«‹æˆ–ä¸Šæ¬¡é‡ç½®ä»¥ä¾†çš„è¨˜æ†¶é«”ä½¿ç”¨é‡æ­·å²æœ€é«˜å³°å€¼ã€‚å–®ä½ç‚ºä½å…ƒçµ„ã€‚\nmemory.pressureÂ (å”¯è®€): æä¾›è¨˜æ†¶é«”å£“åŠ›æŒ‡æ¨™ï¼Œè¡¡é‡å› è¨˜æ†¶é«”ä¸è¶³å°è‡´çš„æ€§èƒ½æå¤±ã€‚avg10, avg60, avg300 åˆ†åˆ¥è¡¨æ˜¯éå» 10, 60, 300 ç§’ï¼Œæœ‰ç™¾åˆ†ä¹‹å¹¾çš„æ™‚é–“è§¸ç™¼è¨˜æ†¶é«”å›æ”¶æ“ä½œæˆ– OOM Killï¼Œtotal å‰‡æ˜¯ç´¯é€²æ™‚é–“ã€‚some è·Ÿ full å‰‡æ˜¯ä»£è¡¨æ˜¯æ‰€æœ‰ä¸€éƒ¨ä»½çš„ process é‚„æ˜¯æ‰€æœ‰çš„ process éƒ½å—åˆ°å½±éŸ¿ã€‚è©³ç´°ä»‹ç´¹\ncat /sys/fs/cgroup/kubepods/memory.pressure some avg10=0.00 avg60=0.00 avg300=0.00 total=0 full avg10=0.00 avg60=0.00 avg300=0.00 total=0 memory.reclaimÂ (å¯å¯«å…¥): è§¸ç™¼ä»‹é¢ï¼Œå‘æ­¤æª”æ¡ˆå¯«å…¥æ­£æ•´æ•¸å¯æ‰‹å‹•è§¸ç™¼ cgroup çš„è¨˜æ†¶é«”å›æ”¶ã€‚å–®ä½ç‚ºä½å…ƒçµ„ã€‚\nmemory.statÂ (å”¯è®€): æä¾› cgroup è©³ç´°è¨˜æ†¶é«”ä½¿ç”¨çµ±è¨ˆè³‡è¨Šã€‚å…§å®¹æ¯”Â memory.currentÂ æ›´è±å¯Œï¼ŒåŒ…æ‹¬Â anon(åŒ¿åè¨˜æ†¶é«”)ã€fileÂ (æª”æ¡ˆå¿«å–è¨˜æ†¶é«”)ã€kernel_stackÂ (æ ¸å¿ƒå †ç–Š) ç­‰ã€‚é€™äº›çµ±è¨ˆå€¼åƒ…é‡å°æ­¤ cgroup æœ¬èº«ï¼Œä¸éè¿´åŒ…å«å¾Œä»£ã€‚\nå‰©ä¸‹å¸¶æœ‰ swap è·Ÿ zswap çš„ï¼Œèˆ‡ä¸Šé¢æ‰€ä»‹ç´¹çš„ç›¸ä¼¼ï¼Œåªæ˜¯æ˜¯é‡å° swap å’Œ zswapã€‚swap å¤§å®¶éƒ½çŸ¥é“æ˜¯ä½¿ç”¨ç¡¬ç¢Ÿä¾†æš«å­˜è¨˜æ†¶é«”è³‡æ–™çš„æŠ€è¡“ï¼Œzswap å‰‡æ˜¯ linux çš„è¨˜æ†¶é«”å£“ç¸®åŠŸèƒ½ï¼ŒæœƒæŠŠæ²’ç”¨åˆ°çš„ page å£“ç¸®å­˜å›è¨˜æ†¶é«”è£¡é¢ï¼Œæ¸›å°‘ swap æ“ä½œéœ€è¦çš„æ˜‚è²´ç¡¬ç¢Ÿ IO æ“ä½œã€‚\ncgroup æ¶æ§‹ # åœ¨äº†è§£å®Œ cgroup memory controller çš„ä½¿ç”¨è€…ä»‹é¢å¾Œï¼Œç‚ºäº†æ·±å…¥ç†è§£é€™äº›æª”æ¡ˆèƒŒå¾Œçš„é‹ä½œæ©Ÿåˆ¶ï¼Œæˆ‘å€‘å¿…é ˆå…ˆæ¢è¨ cgroup åœ¨ Linux æ ¸å¿ƒä¸­çš„åŸºç¤æ¶æ§‹ï¼Œä»¥åŠå®ƒå¦‚ä½•å°‡è¡Œç¨‹èˆ‡å„å€‹è³‡æºå­ç³»çµ±é€£çµèµ·ä¾†ã€‚\ncgroup çš„æ ¸å¿ƒæ˜¯ä¸€å€‹éšå±¤å¼çš„çµæ§‹ã€‚æ¯å€‹ cgroup å¯¦é«”éƒ½ç”±Â struct cgroupÂ è¡¨ç¤ºï¼Œå®ƒé€éÂ subsysÂ é™£åˆ—é—œè¯åˆ°æ‰€æœ‰å·²å•Ÿç”¨çš„å­ç³»çµ±ï¼ˆä¾‹å¦‚ memoryã€cpu ç­‰ï¼‰ã€‚æ¯å€‹å­ç³»çµ±éƒ½æœ‰å…¶å°æ‡‰çš„çµæ§‹é«”ï¼ˆä¾‹å¦‚Â struct mem_cgroupï¼‰ï¼Œé€™äº›çµæ§‹é«”éƒ½ç¹¼æ‰¿è‡ªÂ struct cgroup_subsys_stateã€‚\ngraph TD subgraph \u0026#34;Process Context\u0026#34; A[task_struct] -- cgroups --\u0026gt; B[css_set] end subgraph \u0026#34;Cgroup Hierarchy\u0026#34; C[Root cgroup] --\u0026gt; D[Parent cgroup] D --\u0026gt; E[\u0026#34;Current cgroup (test)\u0026#34;] end subgraph \u0026#34;Subsystem States\u0026#34; F[struct mem_cgroup] G[struct cpu_cgroup] H[...] end B -- subsys[0] --\u0026gt; F B -- subsys[1] --\u0026gt; G B -- subsys[..] --\u0026gt; H E -- subsys[0] --\u0026gt; F linkStyle 0 stroke:#ff7878,stroke-width:2px; linkStyle 3 stroke:#ff7878,stroke-width:2px; linkStyle 4 stroke:#ff7878,stroke-width:2px; classDef process fill:#d4e4ff,stroke:#333,stroke-width:2px; class A,B process; classDef cgroup fill:#d2ffd2,stroke:#333,stroke-width:2px; class C,D,E cgroup; classDef subsys fill:#fff0d6,stroke:#333,stroke-width:2px; class F,G,H subsys; åœ¨è¡Œç¨‹æ–¹é¢ï¼Œæ¯å€‹Â task_structï¼ˆä»£è¡¨ä¸€å€‹è¡Œç¨‹ï¼‰éƒ½åŒ…å«ä¸€å€‹Â cgroupsÂ æŒ‡æ¨™ï¼ŒæŒ‡å‘ä¸€å€‹Â css_setÂ çµæ§‹é«”ã€‚css_setå‰‡åŒ…å«ä¸€ç³»åˆ—Â cgroup_subsys_stateÂ æŒ‡æ¨™ï¼Œé€™äº›æŒ‡æ¨™åˆ†åˆ¥æŒ‡å‘è©²è¡Œç¨‹æ‰€å±¬çš„æ¯å€‹ cgroup å­ç³»çµ±çš„ç‹€æ…‹å¯¦ä¾‹ã€‚é€™ä½¿å¾—è¡Œç¨‹èƒ½å¤ å¿«é€ŸæŸ¥è©¢å’Œç®¡ç†å…¶åœ¨å„å€‹ cgroup ä¸­çš„è³‡æºä½¿ç”¨æƒ…æ³ã€‚\ncgroup_subsys_state é¡ä¼¼ç¹¼æ‰¿çš„æ¦‚å¿µå¯ä»¥åƒè€ƒ å°è©¦èº«æ‰‹ - Double Linked List - iT é‚¦å¹«å¿™::ä¸€èµ·å¹«å¿™è§£æ±ºé›£é¡Œï¼Œæ‹¯æ•‘ IT äººçš„ä¸€å¤©å° container_ofçš„ä»‹ç´¹ã€‚\n// include/linux/cgroup-defs.h struct cgroup { // æŒ‡å‘æ‰€æœ‰å­ç³»çµ±çš„é™£åˆ— struct cgroup_subsys_state *subsys[CGROUP_SUBSYS_COUNT]; } // include/linux/memcontrol.h // memory å­ç³»çµ±çš„å¯¦ç¾ struct mem_cgroup { // é¡ä¼¼ç¹¼æ‰¿çš„æ¦‚å¿µ struct cgroup_subsys_state css; ... } // include/linux/sched.h // è¡Œç¨‹ã€åŸ·è¡Œç·’çš„ç‰©ä»¶ struct task_struct { ... #ifdef CONFIG_CGROUPS /* Control Group info protected by css_set_lock: */ // æŒ‡å‘åˆ° Cgroup SubSystem SET struct css_set __rcu\t*cgroups; /* cg_list protected by css_set_lock and tsk-\u0026gt;alloc_lock: */ struct list_head\tcg_list; #endif ... } // include/linux/cgroup-defs.h struct css_set { /* * Set of subsystem states, one for each subsystem. This array is * immutable after creation apart from the init_css_set during * subsystem registration (at boot time). */ struct cgroup_subsys_state *subsys[CGROUP_SUBSYS_COUNT]; ... } memory cgroup # åœ¨ç†è§£äº†æ•´é«”çš„ cgroup éšå±¤å¼æ¶æ§‹å¾Œï¼Œæˆ‘å€‘ç¾åœ¨å¯ä»¥å°‡ç„¦é»æ·±å…¥åˆ° memory å­ç³»çµ±ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€é struct mem_cgroup é€™å€‹æ ¸å¿ƒçµæ§‹ä¾†å¯¦ç¾è³‡æºçš„ç²¾ç¢ºè¿½è¹¤èˆ‡æ§åˆ¶ã€‚\nåŸºæœ¬çµæ§‹ # struct mem_cgroupÂ æ˜¯ memory cgroup çš„æ ¸å¿ƒçµæ§‹ï¼Œå®ƒå…§éƒ¨ä¸»è¦é€éÂ struct page_counterÂ ä¾†è¿½è¹¤è¨˜æ†¶é«”ä½¿ç”¨é‡å’Œè¨­å®šé™åˆ¶ã€‚page_counterÂ ä»¥è¨˜æ†¶é«”é  (page) ç‚ºå–®ä½é€²è¡Œè¨ˆæ•¸ã€‚\n// include/linux/memcontrol.h struct mem_cgroup { ... struct page_counter memory;\t/* Both v1 \u0026amp; v2 */ union { struct page_counter swap;\t/* v2 only */ struct page_counter memsw;\t/* v1 only */ }; ... } struct page_counterÂ åŒ…å«äº†å¤šå€‹é‡è¦æ¬„ä½ï¼š\nusage: ç•¶å‰ cgroup çš„è¨˜æ†¶é«”ä½¿ç”¨é‡ã€‚ failcnt: åœ¨ cgroup v1 ä¸­ç”¨æ–¼è¿½è¹¤è¨˜æ†¶é«”åˆ†é…å¤±æ•—æ¬¡æ•¸ã€‚ min,Â low,Â high,Â max: å°æ‡‰ cgroup è¨˜æ†¶é«”é™åˆ¶è¨­å®šçš„å…·é«”æ•¸å€¼ã€‚ parent: æŒ‡å‘çˆ¶ cgroup çš„Â page_counterï¼Œé€™å°æ–¼éšå±¤å¼è¨ˆè²»è‡³é—œé‡è¦ã€‚ éœ€æ³¨æ„ï¼Œé€™é‚Šè¨˜éŒ„çš„å–®ä½éƒ½æ˜¯ Page ä¸æ˜¯ bytes\nstruct page_counter { /* * Make sure \u0026#39;usage\u0026#39; does not share cacheline with any other field in * v2. The memcg-\u0026gt;memory.usage is a hot member of struct mem_cgroup. */ atomic_long_t usage; unsigned long failcnt; /* v1-only field */ CACHELINE_PADDING(_pad1_); /* effective memory.min and memory.min usage tracking */ unsigned long emin; atomic_long_t min_usage; atomic_long_t children_min_usage; /* effective memory.low and memory.low usage tracking */ unsigned long elow; atomic_long_t low_usage; atomic_long_t children_low_usage; unsigned long watermark; /* Latest cg2 reset watermark */ unsigned long local_watermark; /* Keep all the read most fields in a separete cacheline. */ CACHELINE_PADDING(_pad2_); bool protection_support; bool track_failcnt; unsigned long min; unsigned long low; unsigned long high; unsigned long max; struct page_counter *parent; } ____cacheline_internodealigned_in_smp; cgroup çš„å»ºç«‹ # ç•¶æˆ‘å€‘é€éÂ mkdir /sys/fs/cgroup/testÂ å»ºç«‹ä¸€å€‹æ–°çš„ cgroup ç›®éŒ„æ™‚ï¼Œç„¡è«–æ˜¯ cgroup v1 é‚„æ˜¯ v2ï¼Œéƒ½æœƒè§¸ç™¼æ ¸å¿ƒä¸­çš„Â cgroup_mkdirÂ å‡½æ•¸ã€‚\n// kernel/cgroup/cgroup-v1.c struct kernfs_syscall_ops cgroup1_kf_syscall_ops = { .rename\t= cgroup1_rename, .show_options\t= cgroup1_show_options, .mkdir\t= cgroup_mkdir, // è¨»å†Š cgroupv1 å° cgroupfs mkdir æ“ä½œçš„è™•ç†å‡½æ•¸ .rmdir\t= cgroup_rmdir, .show_path\t= cgroup_show_path, }; // kernel/cgroup/cgroup.c static struct kernfs_syscall_ops cgroup_kf_syscall_ops = { .show_options\t= cgroup_show_options, .mkdir\t= cgroup_mkdir, // è¨»å†Š cgroupv2 å° cgroupfs mkdir æ“ä½œçš„è™•ç†å‡½æ•¸ .rmdir\t= cgroup_rmdir, .show_path\t= cgroup_show_path, }; å› ç‚ºç¾åœ¨é€æ¼¸è½‰å‘åˆ° cgroup v2 æ˜¯ä¸»é«”ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ v1 çš„å‡½æ•¸æœƒå¸¶æœ‰ cgroup1 å­—æ¨£ï¼Œå¦‚æœç›´æ¥å¯« cgroup ä¸æ˜¯é€šç”¨å°±æ˜¯ cgroupv2 å°ˆç”¨çš„ã€‚\ncgroup_mkdirÂ å‡½æ•¸æœƒåŸ·è¡Œä»¥ä¸‹é—œéµæ­¥é©Ÿï¼š\nå–å¾—çˆ¶ cgroup çš„ cgroup ç‰©ä»¶ã€‚ å‘¼å«Â cgroup_createÂ å»ºç«‹æ–°çš„ cgroup ç‰©ä»¶ (struct cgroup)ã€‚ å‘¼å«Â cgroup_apply_control_enableÂ å•Ÿç”¨ cgroup ä¸­çš„å„å€‹å­ç³»çµ±ã€‚ // cgroup/cgroup.c int cgroup_mkdir(struct kernfs_node *parent_kn, const char *name, umode_t mode) { ... // å¾ cgroupfs ç‰©ä»¶å–å¾— cgroup ç‰©ä»¶ parent = cgroup_kn_lock_live(parent_kn, false); cgrp = cgroup_create(parent); cgroup_apply_control_enable(cgrp); // åˆå§‹åŒ–æ‰€æœ‰ cgroup å­ç³»çµ± ... } // cgroup/cgroup.c static int cgroup_apply_control_enable(struct cgroup *cgrp) { ... cgroup_for_each_live_descendant_pre(dsct, d_css, cgrp) { for_each_subsys(ss, ssid) { // iterace æ¯å€‹å­ç³»çµ± struct cgroup_subsys_state *css = cgroup_css(dsct, ss); css = css_create(dsct, ss); ... } } return 0; } static struct cgroup_subsys_state *css_create(struct cgroup *cgrp, struct cgroup_subsys *ss) { ... css = ss-\u0026gt;css_alloc(parent_css); ... return css; ... } åœ¨Â cgroup_apply_control_enableÂ å…§éƒ¨ï¼Œå°æ–¼æ¯å€‹å•Ÿç”¨çš„å­ç³»çµ±ï¼Œæ ¸å¿ƒæœƒå‘¼å«å…¶Â css_allocÂ å‡½æ•¸ä¾†åˆå§‹åŒ–å°æ‡‰çš„å­ç³»çµ±ç‹€æ…‹ç‰©ä»¶ã€‚å°æ–¼ memory å­ç³»çµ±è€Œè¨€ï¼Œé€™å€‹å‡½æ•¸æ˜¯Â mem_cgroup_css_allocã€‚\n// mm/memcontrol.c struct cgroup_subsys memory_cgrp_subsys = { .css_alloc = mem_cgroup_css_alloc, // memory å­ç³»çµ±è¨»å†Šçš„ css_alloc è™•ç†å‡½æ•¸ .css_online = mem_cgroup_css_online, .css_offline = mem_cgroup_css_offline, .css_released = mem_cgroup_css_released, .css_free = mem_cgroup_css_free, .css_reset = mem_cgroup_css_reset, .css_rstat_flush = mem_cgroup_css_rstat_flush, .attach = mem_cgroup_attach, .fork = mem_cgroup_fork, .exit = mem_cgroup_exit, .dfl_cftypes = memory_files, #ifdef CONFIG_MEMCG_V1 .legacy_cftypes = mem_cgroup_legacy_files, #endif .early_init = 0, }; mem_cgroup_css_allocÂ æœƒåˆ†é…ä¸€å€‹æ–°çš„Â mem_cgroupÂ ç‰©ä»¶ï¼Œä¸¦å°å…¶é€²è¡Œåˆå§‹åŒ–ã€‚å…¶ä¸­ä¸€å€‹é‡è¦çš„åˆå§‹åŒ–æ­¥é©Ÿæ˜¯å‘¼å«Â page_counter_initï¼Œé€™æœƒè¨­å®šÂ mem_cgroupÂ å…§éƒ¨Â page_counterÂ çš„Â usageÂ ç‚º 0ï¼ŒmaxÂ ç‚ºÂ PAGE_COUNTER_MAXï¼Œä¸¦å°‡å…¶Â parentÂ æŒ‡å‘çˆ¶Â mem_cgroupÂ çš„Â page_counterã€‚é€™å€‹Â parentÂ æŒ‡æ¨™åœ¨å¾ŒçºŒçš„è¨˜æ†¶é«”è¨ˆè²»ä¸­æ‰®æ¼”é—œéµè§’è‰²ï¼Œå› ç‚ºå®ƒå…è¨±è¨˜æ†¶é«”ä½¿ç”¨é‡æ²¿è‘— cgroup éšå±¤å‘ä¸Šç´¯ç©ã€‚\nstatic struct cgroup_subsys_state * __ref mem_cgroup_css_alloc(struct cgroup_subsys_state *parent_css) { struct mem_cgroup *parent = mem_cgroup_from_css(parent_css); ... memcg = mem_cgroup_alloc(parent); // å»ºç«‹æ–°çš„ memcg ç‰©ä»¶ ... /* ä¸€äº›åˆå§‹åŒ– */ page_counter_set_high(\u0026amp;memcg-\u0026gt;memory, PAGE_COUNTER_MAX); memcg1_soft_limit_reset(memcg); #ifdef CONFIG_ZSWAP memcg-\u0026gt;zswap_max = PAGE_COUNTER_MAX; WRITE_ONCE(memcg-\u0026gt;zswap_writeback, true); #endif page_counter_set_high(\u0026amp;memcg-\u0026gt;swap, PAGE_COUNTER_MAX); if (parent) { WRITE_ONCE(memcg-\u0026gt;swappiness, mem_cgroup_swappiness(parent)); // åˆå§‹åŒ– counters page_counter_init(\u0026amp;memcg-\u0026gt;memory, \u0026amp;parent-\u0026gt;memory, memcg_on_dfl); page_counter_init(\u0026amp;memcg-\u0026gt;swap, \u0026amp;parent-\u0026gt;swap, false); #ifdef CONFIG_MEMCG_V1 memcg-\u0026gt;memory.track_failcnt = !memcg_on_dfl; WRITE_ONCE(memcg-\u0026gt;oom_kill_disable, READ_ONCE(parent-\u0026gt;oom_kill_disable)); page_counter_init(\u0026amp;memcg-\u0026gt;kmem, \u0026amp;parent-\u0026gt;kmem, false); page_counter_init(\u0026amp;memcg-\u0026gt;tcpmem, \u0026amp;parent-\u0026gt;tcpmem, false); #endif } ... } static inline void page_counter_init(struct page_counter *counter, struct page_counter *parent, bool protection_support) { counter-\u0026gt;usage = (atomic_long_t)ATOMIC_LONG_INIT(0); counter-\u0026gt;max = PAGE_COUNTER_MAX; counter-\u0026gt;parent = parent; // ä¿å­˜ parent cgroup counter çš„æŒ‡æ¨™ counter-\u0026gt;protection_support = protection_support; counter-\u0026gt;track_failcnt = false; } memory cgroup åƒæ•¸çš„è®€å¯« # ä½¿ç”¨è€…å¯ä»¥é€éå¯«å…¥Â /sys/fs/cgroup/test/memory.maxÂ ç­‰æª”æ¡ˆä¾†è¨­å®šè¨˜æ†¶é«”é™åˆ¶ï¼Œä¾‹å¦‚ï¼š\necho \u0026#34;1500\u0026#34; \u0026gt; /sys/fs/cgroup/test/memory.max memory.max çš„æª”æ¡ˆç³»çµ±æ“ä½œå®šåœ¨ memory_filesï¼Œé€™å€‹æ“ä½œæœ€çµ‚æœƒå‘¼å«åˆ°Â memory_max_writeÂ å‡½æ•¸ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œroot cgroup ä¸å…è¨±è¨­å®šè¨˜æ†¶é«”é™åˆ¶ï¼Œå› æ­¤Â memory.maxÂ æª”æ¡ˆä¸æœƒåœ¨ root cgroup ç›®éŒ„ä¸‹é¡¯ç¤ºã€‚\n// mm/memcontrol.c static struct cftype memory_files[] = { ... { .name = \u0026#34;max\u0026#34;, .flags = CFTYPE_NOT_ON_ROOT, # å° root cgroup ä¸é¡¯ç¤º .seq_show = memory_max_show, }, ... } è©²å‡½æ•¸æœƒè§£æè¼¸å…¥çš„å­—ä¸²ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºä»¥é ç‚ºå–®ä½çš„æ•´æ•¸ï¼Œç„¶å¾Œæ›´æ–°Â memcg-\u0026gt;memory.maxÂ æ¬„ä½ã€‚å¦‚æœæ–°çš„Â maxÂ å€¼ä½æ–¼ç•¶å‰è¨˜æ†¶é«”ä½¿ç”¨é‡ï¼Œæ ¸å¿ƒæœƒç«‹å³å˜—è©¦è§¸ç™¼è¨˜æ†¶é«”å›æ”¶æ©Ÿåˆ¶ã€‚\nå› ç‚ºç´€éŒ„å–®ä½æ˜¯ Pageï¼Œæ‰€ä»¥çµ¦çš„æ•¸å€¼å¦‚æœä¸æ˜¯ Page å¤§å°çš„æ•´æ•¸å€ï¼Œä¹Ÿæœƒè¢«è‡ªå‹•å–æ•´ã€‚\nstatic ssize_t memory_max_write(struct kernfs_open_file *of, char *buf, size_t nbytes, loff_t off) { struct mem_cgroup *memcg = mem_cgroup_from_css(of_css(of)); unsigned int nr_reclaims = MAX_RECLAIM_RETRIES; bool drained = false; unsigned long max; int err; // è§£æè¼¸å…¥å­—ä¸² buf = strstrip(buf); err = page_counter_memparse(buf, \u0026#34;max\u0026#34;, \u0026amp;max); if (err) return err; // å¯«å…¥ counter xchg(\u0026amp;memcg-\u0026gt;memory.max, max); ... // æª¢æŸ¥ç¾åœ¨çš„ä½¿ç”¨é‡æœ‰æ²’æœ‰è¶…éæ–°çš„ maxï¼Œæœ‰çš„è©±è§¸ç™¼å›æ”¶æ©Ÿåˆ¶ ... memcg_wb_domain_size_changed(memcg); return nbytes; } // å°‡ä½¿ç”¨è€…è¼¸å…¥çš„ bytes å–®ä½å­—ä¸²è½‰æˆ page ç‚ºå–®ä½çš„æ•´æ•¸ // mm/page_counter.c /** * page_counter_memparse - memparse() for page counter limits * @buf: string to parse * @max: string meaning maximum possible value * @nr_pages: returns the result in number of pages * * Returns -EINVAL, or 0 and @nr_pages on success. @nr_pages will be * limited to %PAGE_COUNTER_MAX. */ int page_counter_memparse(const char *buf, const char *max, unsigned long *nr_pages) { char *end; u64 bytes; if (!strcmp(buf, max)) { *nr_pages = PAGE_COUNTER_MAX; return 0; } bytes = memparse(buf, \u0026amp;end); if (*end != \u0026#39;\\0\u0026#39;) return -EINVAL; *nr_pages = min(bytes / PAGE_SIZE, (u64)PAGE_COUNTER_MAX); return 0; } cgroup è¨˜æ†¶é«”é™åˆ¶çš„å¯¦ç¾æµç¨‹ # äº†è§£ mem_cgroup çš„çµæ§‹ä»¥åŠå…¶åƒæ•¸å¦‚ä½•è¨­å®šå¾Œï¼Œæ¥ä¸‹ä¾†çš„é—œéµå•é¡Œæ˜¯ï¼šLinux æ ¸å¿ƒç©¶ç«Ÿå¦‚ä½•åœ¨è¡Œç¨‹ç”³è«‹è¨˜æ†¶é«”æ™‚ï¼Œæ‡‰ç”¨æˆ‘å€‘è¨­å®šçš„ memory.max é™åˆ¶ï¼Ÿé€™èƒŒå¾Œæ¶‰åŠä¸€å¥—ç²¾å¯†çš„éšå±¤å¼æª¢æŸ¥ã€æ”¶è²»èˆ‡å›æ”¶æ©Ÿåˆ¶ã€‚\nç”±æ–¼ cgroup æ˜¯éšå±¤å¼çµæ§‹ï¼Œæ‰€ä»¥æ¯ä¸€å±¤éƒ½æœƒæœ‰ç¨ç«‹çš„æª¢æŸ¥ã€‚\nflowchart TD A[Root] A --\u0026gt; B[Systemd\u0026lt;br/\u0026gt;limit 50MiB] B --\u0026gt; C[Ningx] B --\u0026gt; D[Docker\u0026lt;br/\u0026gt;limit 30MiB] C --\u0026gt; C1(pid 123) C --\u0026gt; C2(pid 124) D --\u0026gt; D1(pid 223) D --\u0026gt; D2(pid 224) ç•¶ä¸€å€‹è¡Œç¨‹ï¼ˆä¾‹å¦‚ PID 223ï¼‰éœ€è¦é¡å¤–ç”³è«‹ 10MiB è¨˜æ†¶é«”æ™‚ï¼Œç³»çµ±æœƒä»¥éšå±¤æ–¹å¼æª¢æŸ¥å…¶Â cgroupÂ ä¸­çš„è¨˜æ†¶é«”é™åˆ¶ã€‚\nDocker cgroup æª¢æŸ¥ï¼šÂ é¦–å…ˆæœƒæª¢æŸ¥Â Docker cgroupã€‚å¦‚æœè©² cgroup ä¸‹çš„æ‰€æœ‰è¡Œç¨‹ç›®å‰å…±ä½¿ç”¨ 10MiB è¨˜æ†¶é«”ï¼Œä¸”è©² cgroup çš„é™åˆ¶ç‚º 30MiBï¼Œé‚£éº¼é¡å¤–ç”³è«‹çš„ 10MiB (10MiB + 10MiB = 20MiB) å°‡æœƒé ä½æ–¼é™åˆ¶ï¼Œå› æ­¤åœ¨é€™å€‹å±¤ç´šä¸æœƒæœ‰å•é¡Œã€‚\nSystemd cgroup æª¢æŸ¥ï¼šÂ æ¥è‘—ï¼Œç³»çµ±æœƒæª¢æŸ¥Â Systemd cgroupã€‚é€™å€‹ cgroup åŒ…å«æ‰€æœ‰åœ¨ Systemd ä¸‹çš„è¡Œç¨‹ï¼Œä¹ŸåŒ…å«å…¶å­ cgroup ä¸­çš„è¡Œç¨‹ã€‚å¦‚æœ Systemd cgroup ä¸‹çš„è¡Œç¨‹ç›®å‰å·²ç¶“ä½¿ç”¨äº† 45MiB è¨˜æ†¶é«”ï¼Œé‚£éº¼é¡å¤–ç”³è«‹ 10MiB å°±æœƒè¶…éå…¶è¨˜æ†¶é«”é™åˆ¶ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼ŒSystemd cgroup æœƒåœ¨å…¶å±¤ç´šè§¸ç™¼è¨˜æ†¶é«”å›æ”¶ä»¥é‡‹æ”¾è¨˜æ†¶é«”ã€‚\nLinux æ ¸å¿ƒä¸»è¦é€éä»¥ä¸‹æ©Ÿåˆ¶ä¾†å¯¦æ–½ cgroup è¨˜æ†¶é«”é™åˆ¶ï¼šç¼ºé ä¸­æ–·æ™‚çš„ã€Œæ”¶è²»ã€æ©Ÿåˆ¶ã€è¨˜æ†¶é«”å›æ”¶å’Œ OOM Killã€‚\nç¼ºé ä¸­æ–· # ç•¶è¡Œç¨‹å˜—è©¦å­˜å–æœªæ˜ å°„åˆ°ç‰©ç†è¨˜æ†¶é«”çš„è™›æ“¬ä½å€æ™‚ï¼Œæœƒè§¸ç™¼ç¼ºé ä¸­æ–· (page fault)ã€‚æ ¸å¿ƒçš„ç¼ºé ä¸­æ–·è™•ç†å‡½æ•¸æœƒè² è²¬åˆ†é…å¯¦éš›çš„ç‰©ç†è¨˜æ†¶é«”ä¸¦æ›´æ–°é è¡¨ï¼Œå°‡è™›æ“¬ä½å€èˆ‡ç‰©ç†è¨˜æ†¶é«”ç¶å®šã€‚\né€™å€‹éç¨‹çš„æ ¸å¿ƒè·¯å¾‘å¦‚ä¸‹ï¼š\nexc_page_faultÂ (ä¸­æ–·) -\u0026gt;Â handle_page_faultÂ -\u0026gt;Â do_user_addr_faultÂ (è™•ç†ä½¿ç”¨è€…ç©ºé–“ç¼ºé ) -\u0026gt;Â handle_mm_fault-\u0026gt;Â __handle_mm_faultÂ -\u0026gt;Â handle_pte_faultÂ -\u0026gt;Â do_pte_missingÂ -\u0026gt;Â do_anonymous_pageÂ (åˆ†é…åŒ¿åé ) -\u0026gt;Â alloc_anon_folioã€‚\nåœ¨Â alloc_anon_folioÂ å‡½æ•¸ä¸­ï¼Œé™¤äº†åˆ†é…ç‰©ç†é  (ç¾åœ¨é€šå¸¸ä»¥ folio å½¢å¼åˆ†é…ï¼Œå®ƒæ˜¯æ¯”å–®ä¸€é æ›´å¤§çš„è¨˜æ†¶é«”ç®¡ç†å–®ä½ï¼Œä½†æ¦‚å¿µä¸Šä»å¯ç†è§£ç‚ºé ) ä¹‹å¤–ï¼Œæœ€é—œéµçš„ä¸€æ­¥å°±æ˜¯å‘¼å«Â mem_cgroup_chargeÂ ä¾†å°ç•¶å‰è¡Œç¨‹æ‰€å±¬çš„ memory cgroup é€²è¡Œã€Œæ”¶è²»ã€ã€‚\nstatic struct folio *alloc_anon_folio(struct vm_fault *vmf) { ... // åˆ†é…ç‰©ç† page folio = vma_alloc_folio(gfp, order, vma, addr, true); ... // æ›´æ–° memory cgroup mem_cgroup_charge(folio, vma-\u0026gt;vm_mm, gfp) ... } åŒ¿åé  (anonymous page) æŒ‡çš„æ˜¯ä¸èˆ‡ä»»ä½•æª”æ¡ˆé—œè¯çš„è¨˜æ†¶é«”ï¼Œä¾‹å¦‚å †ç–Š (stack)ã€å † (heap) ä»¥åŠé€éÂ mmap(MAP_ANONYMOUS)Â åˆ†é…çš„è¨˜æ†¶é«”ã€‚\ncgroup æ”¶è²» # mem_cgroup_chargeÂ å‡½æ•¸æœƒå¾è¡Œç¨‹çš„Â mm_structÂ ä¸­å–å¾—å°æ‡‰çš„Â mem_cgroupï¼Œç„¶å¾Œå‘¼å«Â charge_memcgÂ é€²è¡Œå¯¦éš›çš„è¨ˆè²»æ“ä½œã€‚å°æ–¼ root cgroupï¼Œè¨ˆè²»ç¸½æ˜¯æˆåŠŸã€‚\nint __mem_cgroup_charge(struct folio *folio, struct mm_struct *mm, gfp_t gfp) { struct mem_cgroup *memcg; int ret; // å¾ process çš„ mm struct æ‹¿åˆ°å°æ‡‰çš„ cgroup memory subsystem memcg = get_mem_cgroup_from_mm(mm); ret = charge_memcg(folio, memcg, gfp); css_put(\u0026amp;memcg-\u0026gt;css); return ret; } static int charge_memcg(struct folio *folio, struct mem_cgroup *memcg, gfp_t gfp) { int ret; // å˜—è©¦æ”¶è²» ret = try_charge(memcg, gfp, folio_nr_pages(folio)); if (ret) goto out; css_get(\u0026amp;memcg-\u0026gt;css); commit_charge(folio, memcg); // folio-\u0026gt;memcg_data = (unsigned long)memcg; memcg1_commit_charge(folio, memcg); out: return ret; } static inline int try_charge(struct mem_cgroup *memcg, gfp_t gfp_mask, unsigned int nr_pages) { // root cgroup ä¸é™åˆ¶ if (mem_cgroup_is_root(memcg)) return 0; return try_charge_memcg(memcg, gfp_mask, nr_pages); } å°æ–¼é root cgroupï¼Œæ ¸å¿ƒæœƒå‘¼å«Â try_charge_memcgã€‚é€™å€‹å‡½æ•¸çš„æ ¸å¿ƒé‚è¼¯æ˜¯å˜—è©¦æ›´æ–°æ‰€æœ‰å±¤ç´šçš„ cgroup memory counterï¼š\næª¢æŸ¥Â page_counter_try_charge: é€™æ˜¯è¨ˆè²»çš„æ ¸å¿ƒå‡½æ•¸ã€‚å®ƒæœƒå¾ç•¶å‰ cgroup é–‹å§‹ï¼Œæ²¿è‘—Â parentÂ æŒ‡æ¨™å‘ä¸Šéæ­·æ‰€æœ‰çˆ¶ cgroup çš„Â page_counterã€‚å°æ–¼æ¯ä¸€å±¤ï¼Œå®ƒæœƒå˜—è©¦å¢åŠ Â usageÂ æ¬„ä½ã€‚ è¶…é™è™•ç†: å¦‚æœåœ¨ä»»ä½•ä¸€å±¤ï¼Œå¢åŠ Â usageÂ å¾Œå°è‡´è©² cgroup çš„è¨˜æ†¶é«”ä½¿ç”¨é‡è¶…éå…¶Â maxÂ é™åˆ¶ï¼Œpage_counter_try_chargeÂ æœƒå›å ±å¤±æ•—ã€‚æ­¤æ™‚ï¼Œtry_charge_memcgÂ æœƒæ¡å–ä»¥ä¸‹è¡Œå‹•ï¼š ç™¼é€Â MEMCG_MAXÂ cgroup äº‹ä»¶ã€‚ è¨˜éŒ„å£“åŠ›åœæ»¯è³‡è¨Š (PSI)ï¼Œè¡¨ç¤ºç³»çµ±é¢è‡¨è¨˜æ†¶é«”å£“åŠ›ã€‚ å‘¼å«Â try_to_free_mem_cgroup_pagesÂ å˜—è©¦å›æ”¶è¨˜æ†¶é«”ã€‚ å¦‚æœå›æ”¶å¾Œä»ä¸è¶³ä»¥æ»¿è¶³ç•¶å‰åˆ†é…è«‹æ±‚ï¼Œä¸¦ä¸”å…è¨± OOM (Out Of Memory) Killï¼Œå‰‡æœƒè§¸ç™¼ OOM Killerã€‚ å¦‚æœ OOM Kill ä¹Ÿç„¡æ³•é‡‹æ”¾è¶³å¤ çš„è¨˜æ†¶é«”ï¼Œå‰‡æœ€çµ‚è¿”å›Â -ENOMEMÂ éŒ¯èª¤ã€‚ MEMCG_MAX é™¤äº†æ›´æ–° memory.events æª”æ¡ˆå…§å®¹å¤–ï¼Œä¹Ÿæœƒè§¸ç™¼ file modified eventï¼Œå¯ä»¥é€é eventfd æ©Ÿåˆ¶ç›£æ§ memory.events æª”æ¡ˆæ¥æ”¶åˆ°äº‹ä»¶ã€‚\né«˜æ°´ä½ç·šæª¢æŸ¥: å¦‚æœè¨ˆè²»æˆåŠŸï¼Œtry_charge_memcgÂ é‚„æœƒæª¢æŸ¥ç•¶å‰ cgroup çš„è¨˜æ†¶é«”ä½¿ç”¨é‡æ˜¯å¦è¶…éäº†Â memory.highÂ è¨­ç½®çš„é«˜æ°´ä½ç·šã€‚å¦‚æœè¶…éï¼Œå³ä½¿æ²’æœ‰é”åˆ°ç¡¬é™åˆ¶ï¼Œæ ¸å¿ƒä¹Ÿæœƒè§¸ç™¼è¨˜æ†¶é«”å›æ”¶ï¼Œå˜—è©¦å°‡è¨˜æ†¶é«”ä½¿ç”¨é‡é™è‡³é«˜æ°´ä½ç·šä»¥ä¸‹ï¼Œé€™æ˜¯ä¸€ç¨®æ›´æŸ”å’Œçš„ç¯€æµæ©Ÿåˆ¶ã€‚ flowchart TD Start[Page Fault: ç”³è«‹è¨˜æ†¶é«”] --\u0026gt; A{try_charge: éšå±¤å¼è¨˜å¸³}; A -- æˆåŠŸ --\u0026gt; B{è¶…é memory.high?}; A -- å¤±æ•— (è¶…é memory.max) --\u0026gt; C[\u0026#34;è§¸ç™¼ memory.events (max)\u0026#34;]; B -- æ˜¯ --\u0026gt; D[éåŒæ­¥è§¸ç™¼è¨˜æ†¶é«”å›æ”¶]; B -- å¦ --\u0026gt; End[åˆ†é…æˆåŠŸ]; D --\u0026gt; End; C --\u0026gt; E{try_to_free_mem_cgroup_pages}; E -- æˆåŠŸå›æ”¶è¶³å¤ è¨˜æ†¶é«” --\u0026gt; F[å›åˆ° A é‡è©¦]; E -- å›æ”¶è¨˜æ†¶é«”ä¸è¶³ --\u0026gt; G{å…è¨± OOM Kill?}; G -- æ˜¯ --\u0026gt; H[mem_cgroup_oom: åŸ·è¡Œ OOM Killer]; G -- å¦ --\u0026gt; I[åˆ†é…å¤±æ•—, è¿”å› -ENOMEM]; classDef action fill:#cde4ff,stroke:#333; class A,E,H,D action; classDef decision fill:#ffefc1,stroke:#333; class B,G decision; classDef result fill:#ffcccc,stroke:#333; class C,I,End result; // mm/memcontrol.c static int try_charge_memcg(struct mem_cgroup *memcg, gfp_t gfp_mask, unsigned int nr_pages) { ... retry: // æ¯å€‹ memcg åœ¨æ¯å€‹ CPU ä¸Šéƒ½æœ‰ä¸€å€‹ \u0026#34;stock\u0026#34;ï¼ˆåº«å­˜ï¼‰ï¼Œé å…ˆè¨ˆè²»äº†ä¸€äº›é é¢ä»¥åŠ é€Ÿå¸¸è¦‹çš„å°é¡åˆ†é…ã€‚å¦‚æœè«‹æ±‚çš„Â `nr_pages`Â å¯ä»¥å¾ stock ä¸­æ»¿è¶³ï¼Œå‰‡è¨ˆè²»æˆåŠŸ if (consume_stock(memcg, nr_pages, gfp_mask)) return 0; batch = nr_pages; struct page_counter *counter; // é™¤äº† memory é‚„æœ‰ memsw è¨˜å¸³ (å° swap æ§åˆ¶ï¼‰ï¼Œé€™é‚Šç°¡åŒ–æ‰ // å˜—è©¦æ”¶è²» (æ›´æ–°æ‰€æœ‰å±¤ç´šçš„ cgroup memory counter) if (page_counter_try_charge(\u0026amp;memcg-\u0026gt;memory, batch, \u0026amp;counter)) goto done_restock; // è¨˜å¸³æˆåŠŸ // æ”¶è²»å¤±æ•—ï¼Œæœ‰ä¸€å±¤è¶…é memory.max é™åˆ¶äº† // å–å¾—è¶…é¡çš„ cgroup struct mem_cgroup *mem_over_limit = mem_cgroup_from_counter(counter, memory); ... // ç™¼é€ cgroup event memcg_memory_event(mem_over_limit, MEMCG_MAX); psi_memstall_enter(\u0026amp;pflags); // è¨˜éŒ„å£“åŠ›åœæ»¯ä¿¡æ¯ (PSI) é–‹å§‹ (memory.pressure) nr_reclaimed = try_to_free_mem_cgroup_pages(mem_over_limit, nr_pages, gfp_mask, reclaim_options, NULL); // å˜—è©¦å›æ”¶è¨˜æ†¶é«” psi_memstall_leave(\u0026amp;pflags); // PSI çµæŸ ifÂ (mem_cgroup_margin(mem_over_limit) \u0026gt;= nr_pages)Â // å¦‚æœæ¸…å‡ºè¶³å¤ çš„ç©ºé–“ï¼Œåœ¨å˜—è©¦å……å€¼ä¸€æ¬¡ gotoÂ retry; // å°‡ stock ä¸­çš„é ç•™é é¢è¿”å›çµ¦ cgroupï¼Œç„¶å¾Œå†è©¦ä¸€æ¬¡ if (!drained) { drain_all_stock(mem_over_limit); // æ’ç©º mem_over_limit cgroup çš„æ‰€æœ‰ CPU stock drained = true; goto retry; } if (gfp_mask \u0026amp; __GFP_NORETRY) // å¦‚æœä¸å…è¨±é‡è©¦ goto nomem; ... if (passed_oom \u0026amp;\u0026amp; task_is_dying()) // å¯èƒ½è‡ªå·±è¢«æ®ºæ‰äº†ï¼Œå°±ä¸è™•ç†äº† goto nomem; // å˜—è©¦é€é OOM Kill é‡‹æ”¾ä½œå¤ çš„è¨˜æ†¶é«” if (mem_cgroup_oom(mem_over_limit, gfp_mask, get_order(nr_pages * PAGE_SIZE))) { passed_oom = true; nr_retries = MAX_RECLAIM_RETRIES; goto retry; } nomem: // ç”³è«‹è¨˜æ†¶é«”å¤±æ•—ï¼Œè¿”å›éŒ¯èª¤ if (!(gfp_mask \u0026amp; (__GFP_NOFAIL | __GFP_HIGH))) return -ENOMEM; ... force: // æœ‰ä¸€äº› Kernel ç”¨çš„ï¼Œä¸å…è¨±å¤±æ•—ï¼Œèµ°é¡å¤–é‚è¼¯ done_restock: // æª¢æŸ¥æ˜¯å¦è¶…å‡ºé«˜æ°´ä½ç·šï¼Œæ˜¯çš„è©±ï¼Œè§¸ç™¼é«˜æ°´ä½å›æ”¶æ©Ÿåˆ¶ do { bool mem_high, swap_high; mem_high = page_counter_read(\u0026amp;memcg-\u0026gt;memory) \u0026gt; READ_ONCE(memcg-\u0026gt;memory.high); swap_high = page_counter_read(\u0026amp;memcg-\u0026gt;swap) \u0026gt; READ_ONCE(memcg-\u0026gt;swap.high); ... if (mem_high || swap_high) { current-\u0026gt;memcg_nr_pages_over_high += batch; set_notify_resume(current); break; } } while ((memcg = parent_mem_cgroup(memcg))); if (current-\u0026gt;memcg_nr_pages_over_high \u0026gt; MEMCG_CHARGE_BATCH \u0026amp;\u0026amp; !(current-\u0026gt;flags \u0026amp; PF_MEMALLOC) \u0026amp;\u0026amp; gfpflags_allow_blocking(gfp_mask)) mem_cgroup_handle_over_high(gfp_mask); return 0; } è¨˜æ†¶é«”å›æ”¶ # ç•¶ cgroup çš„è¨˜æ†¶é«”ä½¿ç”¨é‡è¶…å‡ºé™åˆ¶æˆ–é«˜æ°´ä½ç·šæ™‚ï¼Œæ ¸å¿ƒæœƒå‘¼å«Â try_to_free_mem_cgroup_pagesÂ å‡½æ•¸ä¾†åŸ·è¡Œè¨˜æ†¶é«”å›æ”¶æ“ä½œï¼Œå˜—è©¦é‡‹æ”¾ä¸æ´»èºçš„é é¢ï¼Œä¾‹å¦‚æª”æ¡ˆå¿«å–æˆ–åŒ¿åé é¢ã€‚é€™è£¡ä¸æ·±å…¥å±•é–‹å…¶å…§éƒ¨ç´°ç¯€ã€‚\nOOM Kill # å¦‚æœè¨˜æ†¶é«”å›æ”¶å¾Œä»ç„¶ç„¡æ³•é‡‹æ”¾è¶³å¤ çš„è¨˜æ†¶é«”ä»¥æ»¿è¶³åˆ†é…è«‹æ±‚ï¼Œä¸¦ä¸”æ»¿è¶³ OOM Kill çš„è§¸ç™¼æ¢ä»¶ï¼Œæ ¸å¿ƒæœƒå‘¼å«Â mem_cgroup_oomÂ å‡½æ•¸ä¾†å•Ÿå‹• OOM Killerã€‚\nOOM Killer çš„ç›®æ¨™æ˜¯æ‰¾åˆ°ä¸€å€‹æˆ–å¤šå€‹å€’éœ‰çš„è¡Œç¨‹ä¸¦å°‡å…¶æ®ºæ­»ï¼Œä»¥é‡‹æ”¾è¨˜æ†¶é«”ã€‚\nstatic bool mem_cgroup_oom(struct mem_cgroup *memcg, gfp_t mask, int order) { bool locked, ret; if (order \u0026gt; PAGE_ALLOC_COSTLY_ORDER) return false; memcg_memory_event(memcg, MEMCG_OOM); // cgroup v1 ç‰¹æ®Šè™•ç†é‚è¼¯ if (!memcg1_oom_prepare(memcg, \u0026amp;locked)) return false; // oom ä¸»è¦è™•ç†å‡½æ•¸ ret = mem_cgroup_out_of_memory(memcg, mask, order); memcg1_oom_finish(memcg, locked); return ret; } åœ¨ cgroup v1 ä¸­ï¼Œå¯ä»¥é€éÂ memory.oom_controlÂ æª”æ¡ˆä¾†ç¦ç”¨ OOM Kill åŠŸèƒ½ï¼Œé€™æœƒå°è‡´ cgroup åœ¨ OOM æ™‚å‡çµç›¸é—œç¨‹åºè€Œä¸æ˜¯æ®ºæ­»å®ƒå€‘ã€‚ç„¶è€Œï¼Œcgroup v2 ä¸¦æ²’æœ‰æä¾›ç›´æ¥ç¦ç”¨ OOM Kill çš„æª”æ¡ˆä»‹é¢ã€‚\n```c bool memcg1_oom_prepare(struct mem_cgroup *memcg, bool *locked) { /* * cgroup1 allows disabling the OOM killer and waiting for outside * handling until the charge can succeed; remember the context and put * the task to sleep at the end of the page fault when all locks are * released. */ // å¦‚æœè¨­å®šäº† oom_kill_disable å°±ä¸åŸ·è¡Œ OOM Kill if (READ_ONCE(memcg-\u0026gt;oom_kill_disable)) { if (current-\u0026gt;in_user_fault) { css_get(\u0026amp;memcg-\u0026gt;css); current-\u0026gt;memcg_in_oom = memcg; } return false; } ... return true; } mem_cgroup_out_of_memory æœƒæŠŠåƒæ•¸åŒ…è£æˆ oom_control çµæ§‹ï¼Œå‘¼å«Â out_of_memoryÂ å‡½æ•¸ä¾†åŸ·è¡Œ OOM Kill çš„æ ¸å¿ƒé‚è¼¯ï¼š\n// å°åƒæ•¸åšä¸€å€‹åŒ…è£ï¼Œæ–¹ä¾¿åœ¨ out_of_memory å…§éƒ¨å‚³é static bool mem_cgroup_out_of_memory(struct mem_cgroup *memcg, gfp_t gfp_mask, int order) { struct oom_control oc = { .zonelist = NULL, .nodemask = NULL, .memcg = memcg, .gfp_mask = gfp_mask, .order = order, }; bool ret = true; ... ret = task_is_dying() || out_of_memory(\u0026amp;oc); // æ ¸å¿ƒè™•ç†å‡½æ•¸ unlock: mutex_unlock(\u0026amp;oom_lock); return ret; } OOM Kill çš„æ ¸å¿ƒé‚è¼¯ï¼š\næª¢æŸ¥å…¨å±€ OOM ç¦ç”¨ï¼šå¦‚æœæ ¸å¿ƒé…ç½®äº†Â oom_killer_disabledï¼Œå‰‡ä¸åŸ·è¡Œ OOM Killã€‚ è‡ªæˆ‘é¸æ“‡ï¼šå¦‚æœç•¶å‰è¡Œç¨‹æ­£åœ¨é€€å‡ºæˆ–å·²æ¥æ”¶åˆ°Â SIGKILLï¼Œå‰‡æœƒå„ªå…ˆé¸æ“‡å…¶è‡ªèº«ä½œç‚º OOM å—å®³è€…ã€‚å› ç‚ºç•¶å‰è¡Œç¨‹å·²ç¶“åœ¨é€€å‡ºç‹€æ…‹äº†ï¼Œæ‰€ä»¥ out_of_memory ä¹Ÿä¸éœ€è¦çœŸçš„å» Kill Processï¼Œæ¨™è¨˜å·²ç¶“æ®ºæ‰å°±å¥½ã€‚ Kernel Panic: å¦‚æœÂ sysctl_panic_on_oomÂ åƒæ•¸å•Ÿç”¨ï¼Œå‰‡åœ¨ OOM æ™‚ç›´æ¥è§¸ç™¼ kernel panicã€‚ é¸æ“‡æœ€å£çš„ç¨‹åº (select_bad_process): é€™æ˜¯ OOM Kill çš„é—œéµæ­¥é©Ÿï¼Œå®ƒæœƒéæ­· cgroup å…§çš„æ‰€æœ‰ç¨‹åºï¼Œä¸¦ç‚ºæ¯å€‹ç¨‹åºè¨ˆç®—ä¸€å€‹ã€Œå£å€¼ã€(badness score)ã€‚ æ®ºæ­»ç¨‹åº (oom_kill_process): æ‰¾åˆ°å¾—åˆ†æœ€é«˜çš„ç¨‹åºå¾Œï¼ŒOOM Killer æœƒå°‡å…¶æ®ºæ­»ã€‚ // mm/oom_kill.c // OOM é™¤äº† cgroup é™åˆ¶è¶…éå¤–ï¼Œä¹Ÿå¯èƒ½æ˜¯çœŸçš„ç‰©ç†è¨˜æ†¶é«”ä¸è¶³ç­‰æƒ…æ³ // é€™é‚Šçœç•¥æ‰ï¼Œåªç•™ä¸‹è™•ç†è¶…é cgroup é™åˆ¶ bool out_of_memory(struct oom_control *oc) { unsigned long freed = 0; // kernel option oom_killer_disabled ä¸å…è¨± OOM KILL if (oom_killer_disabled) return false; ... // å¦‚æœç•¶å‰ process æ¥æ”¶åˆ° SIGKILL æˆ–æ­£åœ¨é€€å‡ºï¼Œå°±ç•¶ä½œæ®ºæ­»ä»– /* * If current has a pending SIGKILL or is exiting, then automatically * select it. The goal is to allow it to allocate so that it may * quickly exit and free its memory. */ if (task_will_free_mem(current)) { mark_oom_victim(current); queue_oom_reaper(current); return true; } ... // sysctl åƒæ•¸å•Ÿç”¨ï¼Œåœ¨ oom æ™‚ç›´æ¥ kernel panic check_panic_on_oom(oc); // æ»¿è¶³æ¢ä»¶çš„è©±ï¼Œç¸½æ˜¯å„ªå…ˆæŠŠè‡ªå·±æ®ºæ‰ // ä¸æ˜¯ cgroup oomï¼Œä¸è¨è«– if (!is_memcg_oom(oc) ... } // æ‰¾åˆ°æœ€å£çš„ process select_bad_process(oc); ... // æ‰¾åˆ°åˆé©çš„ process å°±æŠŠå®ƒæ®ºæ‰ if (oc-\u0026gt;chosen \u0026amp;\u0026amp; oc-\u0026gt;chosen != (void *)-1UL) oom_kill_process(oc, !is_memcg_oom(oc) ? \u0026#34;Out of memory\u0026#34; : \u0026#34;Memory cgroup out of memory\u0026#34;); return !!oc-\u0026gt;chosen; } badness è¨ˆç®—æ–¹å¼ # select_bad_processÂ å‡½æ•¸æœƒå‘¼å«Â oom_evaluate_taskÂ å°æ¯å€‹ cgroup å…§çš„ç¨‹åºé€²è¡Œè©•ä¼°ï¼Œé€²è€Œå‘¼å«Â oom_badnessÂ ä¾†è¨ˆç®—ç¨‹åºçš„ã€Œå£å€¼ã€ã€‚\noom_badnessÂ çš„è¨ˆç®—å…¬å¼å¤§è‡´ç‚ºï¼š\npoints=(RSS+SWAP+PageTableé–‹éŠ·)/PAGE_SIZE+totalpages*adj/1000\nRSS (Resident Set Size): ç¨‹åºå¯¦éš›ä½¿ç”¨çš„ç‰©ç†è¨˜æ†¶é«”å¤§å°ã€‚ SWAP: ç¨‹åºä½¿ç”¨çš„äº¤æ›ç©ºé–“å¤§å°ã€‚ é è¡¨é–‹éŠ·: ç¨‹åºé è¡¨ä½”ç”¨çš„è¨˜æ†¶é«”ã€‚ totalpages: å°æ–¼ cgroup OOM è€Œè¨€ï¼Œæ˜¯Â memory.maxÂ è¨­å®šçš„ç¸½è¨˜æ†¶é«”é æ•¸ã€‚ adjÂ (oom_score_adj): æ˜¯ä¸€å€‹å¯èª¿æ•´çš„ä¹˜æ•¸ï¼Œç¯„åœä»‹æ–¼Â [-1000, 1000]ã€‚ä½¿ç”¨è€…å¯ä»¥é€éÂ /proc/\u0026lt;pid\u0026gt;/oom_score_adjÂ æª”æ¡ˆé‡å°å–®å€‹ process è¨­å®šï¼Œä»¥å½±éŸ¿ç¨‹åºè¢« OOM Killer é¸ä¸­çš„æ©Ÿç‡ï¼š ç­‰åŒæ–¼å°‡Â oom_score_adjÂ çš„å€¼ï¼ˆç¯„åœ -1000 åˆ° 1000ï¼‰æŒ‰æ¯”ä¾‹è½‰æ›æˆç­‰æ•ˆçš„è¨˜æ†¶é«”é æ•¸ï¼Œä¸¦åŠ åˆ°æœ€çµ‚çš„ badness åˆ†æ•¸ä¸Šã€‚adj ç‚º 1000 å°±ç´„ç­‰æ–¼å¢åŠ äº†Â totalpagesÂ çš„åˆ†æ•¸ã€‚ 500Â æ„å‘³è‘—è©²ç¨‹åºé¡å¤–ä½¿ç”¨äº†ç›¸ç•¶æ–¼Â memory.maxÂ çš„ 0.5 å€çš„è¨˜æ†¶é«”ã€‚totalpages*500/1000=memory.max*0.5 è¨­å®šç‚ºÂ -1000Â æ¯”è¼ƒç‰¹æ®Šï¼Œoom_badness æœƒç›´æ¥è·³éä»–ï¼Œä¿è­‰ä¸å¯èƒ½è¢«é¸ä¸­ï¼Œå¦‚æœæ‰€æœ‰ process éƒ½è¨­ç‚º -1000 é‚£å°±ä¸æœƒæœ‰ process è¢«é¸ä¸­äº†ã€‚ åœ¨ proc ç›®éŒ„ä¸‹å¯ä»¥çœ‹åˆ°ä¸‰å€‹è·Ÿ oom ç›¸é—œçš„æª”æ¡ˆ oom_score_adj, oom_score, oom_adjã€‚oom_score è¡¨ç¤ºæœ€çµ‚çš„ badness è¨ˆç®—çµæœï¼Œæœƒè¢«èª¿æ•´åˆ° [0, 2000] é€™å€‹å€¼åŸŸï¼Œè©³æƒ…åƒè€ƒ proc_oom_score å‡½æ•¸ ã€‚oom_adj æ˜¯oom_score_adj çš„èˆŠç‰ˆæœ¬ï¼Œå–å€¼ç¯„åœåªæœ‰ [-17,15]ï¼Œå¯¦éš›å¯«å…¥çš„è©±ï¼Œæœƒè¢«è½‰æ›æˆ oom_score_adj è™•ç†ã€‚\noom_badnessÂ çš„è¨­è¨ˆç›®æ¨™æ˜¯ç›¡å¯èƒ½ç°¡å–®ä¸”å¯é æ¸¬ï¼Œæ—¨åœ¨ç‚ºæ¶ˆè€—æœ€å¤šè¨˜æ†¶é«”çš„ä»»å‹™è¿”å›æœ€é«˜åˆ†ï¼Œä»¥é¿å…å¾ŒçºŒçš„ OOM å¤±æ•—ã€‚\né€™è£¡çš„è¨ˆç®—æ¦‚å¿µæ˜¯é€™æ¨£ã€‚ä¸€å€‹ process ä½¿ç”¨çš„è¨˜æ†¶é«”é‡ä¸€å®šæœƒå¤§æ–¼0ï¼Œå°æ–¼ memory.maxã€‚ç•¶è¨­ç½® oom_score_adj = -999ï¼Œåœ¨ç®—å‡ºä¾†çš„è¨˜æ†¶é«”ä½¿ç”¨é‡å¹¾ä¹æœƒå°æ–¼ 0ï¼Œå› ç‚ºç­‰æ–¼æ‰£æ‰ä¸€å€‹ memory.maxï¼Œä¿è­‰å…¶ä»–æ²’èª¿æ•´çš„ç¨‹å¼ä¸€å®šç”¨çš„æ¯”è¼ƒå¤šã€‚è¨­ç½®ç‚º 1000 æ™‚ï¼Œç­‰æ–¼åŠ ä¸Šä¸€å€‹ memory.maxï¼Œå› ç‚ºä¸å¯èƒ½æœ‰ç¨‹å¼ä½¿ç”¨è¶…é memory.max çš„è¨˜æ†¶é«”ï¼Œæ‰€ä»¥å¦‚æœå…¶ä»–ç¨‹å¼æ²’æœ‰èª¿æ•´ï¼Œé‚£å³ä¾¿è©²ç¨‹å¼ä¸€é»è¨˜æ†¶é«”éƒ½æ²’ç”¨ï¼Œä»–é‚„æ˜¯æœƒè¢«å„ªå…ˆé¸ç¨®ã€‚\nlong oom_badness(struct task_struct *p, unsigned long totalpages) { long points; long adj; /* * Do not even consider tasks which are explicitly marked oom * unkillable or have been already oom reaped or the are in * the middle of vfork */ // é€é /proc/[pid]/oom_score_adj è¨­ç½® // å¦‚æœè¨­ç½®ç‚º -1000 å‰‡ç›´æ¥è·³é adj = (long)p-\u0026gt;signal-\u0026gt;oom_score_adj; if (adj == OOM_SCORE_ADJ_MIN || test_bit(MMF_OOM_SKIP, \u0026amp;p-\u0026gt;mm-\u0026gt;flags) || in_vfork(p)) { task_unlock(p); return LONG_MIN; } /* * The baseline for the badness score is the proportion of RAM that each * task\u0026#39;s rss, pagetable and swap space use. */ points = get_mm_rss(p-\u0026gt;mm) + get_mm_counter(p-\u0026gt;mm, MM_SWAPENTS) + mm_pgtables_bytes(p-\u0026gt;mm) / PAGE_SIZE; task_unlock(p); /* Normalize to oom_score_adj units */ adj *= totalpages / 1000; points += adj; return points; } select_bad_processå‡½æ•¸æœƒå‘¼å« mem_cgroup_scan_tasksè¿­ä»£æ¯å€‹ processï¼Œä½¿ç”¨ oom_badness è¨ˆç®— badnessï¼Œç„¶å¾Œæ›´æ–°é¸ä¸­çš„ processï¼Œé€™é‚Šæœ‰ä¸€å€‹ç‰¹æ®Šæ¢ä»¶åˆ¤æ–·æ˜¯å›å‚³ LONG_MINå°±æœƒç›´æ¥è·³éï¼Œä¿è­‰ä¸æœƒé¸ä¸­ï¼Œå‰é¢èªªåˆ° oom_score_adj = -1000 å°±æ˜¯é€éé€™å€‹æ©Ÿåˆ¶è·³éçš„ã€‚\n/* * Simple selection loop. We choose the process with the highest number of * \u0026#39;points\u0026#39;. In case scan was aborted, oc-\u0026gt;chosen is set to -1. */ // çœ‹æ¯å€‹ process çš„ badness åˆ†æ•¸ (oom_evaluate_task)ï¼Œæ‰¾æœ€å£çš„ static void select_bad_process(struct oom_control *oc) { oc-\u0026gt;chosen_points = LONG_MIN; if (is_memcg_oom(oc)) mem_cgroup_scan_tasks(oc-\u0026gt;memcg, oom_evaluate_task, oc); else { ... } } static int oom_evaluate_task(struct task_struct *task, void *arg) { struct oom_control *oc = arg; long points; // ä¸å…è¨±æ®º init è·Ÿ kernel thread if (oom_unkillable_task(task)) goto next; ... // è¨ˆç®— badness points = oom_badness(task, oc-\u0026gt;totalpages); // å¦‚æœå‡ºä¾†æ˜¯ LONG_MIN å‰‡å®Œå…¨ä¸è€ƒæ…® if (points == LONG_MIN || points \u0026lt; oc-\u0026gt;chosen_points) goto next; select: if (oc-\u0026gt;chosen) put_task_struct(oc-\u0026gt;chosen); get_task_struct(task); oc-\u0026gt;chosen = task; oc-\u0026gt;chosen_points = points; next: return 0; abort: if (oc-\u0026gt;chosen) put_task_struct(oc-\u0026gt;chosen); oc-\u0026gt;chosen = (void *)-1UL; return 1; } å¦‚æœæ²’æœ‰ Process å¯æ®ºæœƒç™¼ç”Ÿä»€éº¼äº‹æƒ… # æˆ‘å€‘å¯ä»¥é€éè¨­ç½®ï¼Œè®“OOM Killer ç„¡æ³•æ•´åˆ°å¯ä»¥æ®ºæ­»çš„ process\ncgroup v1: å¯ä»¥ç›´æ¥è¨­ç½® cgroup çš„ memory.oom_control cgroup v1: éœ€è¦æŠŠæ‰€æœ‰åœ¨ cgroup å…§ process çš„ oom_score_adj èª¿æˆ -1000 å¦‚æœ OOM Killer ç„¡æ³•æ‰¾åˆ°åˆé©çš„ç¨‹åºä¾†æ®ºæ­»ï¼Œæˆ–è€…æ²’æœ‰é‡‹æ”¾å‡ºè¶³å¤ çš„è¨˜æ†¶é«”ï¼š\ncgroup v1: åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œcgroup v1 æœƒå‡çµè§¸ç™¼ OOM çš„ç¨‹åºï¼Œä½¿å…¶é€²å…¥ç¡çœ ç‹€æ…‹ï¼Œç›´åˆ°è¨˜æ†¶é«”å£“åŠ›ç·©è§£ã€‚é€™é€šå¸¸æ„å‘³è‘—è©²ç¨‹åºæœƒè¢«é˜»å¡ï¼Œç„¡æ³•ç¹¼çºŒåŸ·è¡Œã€‚ cgroup v2: cgroup v2 çš„è¡Œç‚ºå‰‡æ›´åŠ ç›´æ¥ã€‚å®ƒæœƒç°¡å–®åœ°è¿”å›éŒ¯èª¤å›åˆ°ä¸­æ–·è™•ç†å‡½æ•¸ï¼Œæ²’æœ‰è™•ç†ã€‚ä¸­æ–·è™•ç†å¤±æ•—å¾Œï¼Œå…·é«”MMUçš„è™•ç†é‚è¼¯ä¸å¤ªç¢ºå®šï¼Œ ä½†æ˜¯åœ¨ä½¿ç”¨ gcc æ¸¬è©¦æ™‚ï¼Œç™¼ç¾ç¨‹å¼æœƒå¡åœ¨ malloc è£¡é¢ç©ºè½‰ã€‚ alloc_anon_folio: return NULL -\u0026gt; mem_cgroup_charge: return -ENOMEM -\u0026gt; __mem_cgroup_charge: return -ENOMEM -\u0026gt; try_charge_memcg: return -ENOMEM å…·é«”ä¾†èªªï¼Œæ”¶è²»å¤±æ•—ç”¢ç”Ÿçš„ ENOMEM æœƒé€å±¤å›å‚³åˆ° alloc_anon_folio ã€‚alloc_anon_folio æœ€å¾Œæœƒå›å‚³ NULL è¡¨ç¤º allocate page å¤±æ•—\nstatic vm_fault_t do_anonymous_page(struct vm_fault *vmf) { ... /* Returns NULL on OOM or ERR_PTR(-EAGAIN) if we must retry the fault */ folio = alloc_anon_folio(vmf); if (IS_ERR(folio)) return 0; if (!folio) goto oom; ... oom: return VM_FAULT_OOM; } æ¥è‘—alloc_anon_folioçš„å‘¼å«è€…do_anonymous_pageæœƒåˆ¤å®šNULLæ˜¯å› ç‚ºOOMï¼Œæ¥è‘—å›å‚³VM_FAULT_OOMï¼Œéš¨è‘—ä¸­æ–·è™•ç†çš„å‘¼å«è·¯å¾‘å›åˆ°do_user_addr_faultã€‚\n// arch/x86/mm/fault.c exc_page_fault // ä¸­æ–· -\u0026gt; handle_page_fault // ä¸­æ–·è™•ç†å‡½æ•¸ï¼Œåˆ¤æ®µå­˜å–åœ°å€å±¬æ–¼ kernel é‚„æ˜¯ userspace -\u0026gt; do_user_addr_fault // è™•ç† userspace ç¼ºé ä¸­æ–· -\u0026gt; handle_mm_fault // mm/memory.c -\u0026gt; __handle_mm_fault -\u0026gt; handle_pte_fault -\u0026gt; do_pte_missing // åˆ¤æ–·ç¼ºå¤±çš„ pte page é¡å‹ï¼Œå‘¼å«å°æ‡‰çš„åˆ†é…å‡½æ•¸ -\u0026gt; do_anonymous_page // åˆ†é…åŒ¿å page -\u0026gt; alloc_anon_folio // åˆ†é… folio do_user_addr_fault æœƒå‘¼å« pagefault_out_of_memoryä¾†è™•ç† OOM éŒ¯èª¤ã€‚\nstatic inline void do_user_addr_fault(structpt_regs *regs, unsigned longerror_code, unsigned longaddress) { ... fault = handle_mm_fault(vma, address, flags | FAULT_FLAG_VMA_LOCK, regs); ... if (fault \u0026amp; VM_FAULT_OOM) { /* Kernel mode? Handle exceptions or die: */ if (!user_mode(regs)) { kernelmode_fixup_or_oops(regs, error_code, address, SIGSEGV, SEGV_MAPERR, ARCH_DEFAULT_PKEY); return; } /* * We ran out of memory, call the OOM killer, and return the * userspace (which will retry the fault, or kill us if we got * oom-killed): */ pagefault_out_of_memory(); } ... } é€™é‚Šæœƒå‘¼å«åˆ° mem_cgroup_oom_synchronize å‡½æ•¸ã€‚\nvoid pagefault_out_of_memory(void) { static DEFINE_RATELIMIT_STATE(pfoom_rs, DEFAULT_RATELIMIT_INTERVAL, DEFAULT_RATELIMIT_BURST); if (mem_cgroup_oom_synchronize(true)) return; if (fatal_signal_pending(current)) return; if (__ratelimit(\u0026amp;pfoom_rs)) pr_warn(\u0026#34;Huh VM_FAULT_OOM leaked out to the #PF handler. Retrying PF\\n\u0026#34;); } å°æ–¼ cgroup v2 è©²å‡½æ•¸æœƒè¢«é€£çµæˆç©ºå‡½æ•¸\nstatic inline bool mem_cgroup_oom_synchronize(bool wait) { return false; } ä½† cgroup v1 æœƒå‡çµ process // mm/memcontrol-v1.c bool mem_cgroup_oom_synchronize(bool handle) { struct mem_cgroup *memcg = current-\u0026gt;memcg_in_oom; struct oom_wait_info owait; bool locked; /* OOM is global, do not handle */ if (!memcg) return false; if (!handle) goto cleanup; owait.memcg = memcg; owait.wait.flags = 0; owait.wait.func = memcg_oom_wake_function; owait.wait.private = current; INIT_LIST_HEAD(\u0026amp;owait.wait.entry); prepare_to_wait(\u0026amp;memcg_oom_waitq, \u0026amp;owait.wait, TASK_KILLABLE); mem_cgroup_mark_under_oom(memcg); locked = mem_cgroup_oom_trylock(memcg); if (locked) mem_cgroup_oom_notify(memcg); schedule(); // èª¿åº¦å…¶ä»– processs mem_cgroup_unmark_under_oom(memcg); finish_wait(\u0026amp;memcg_oom_waitq, \u0026amp;owait.wait); if (locked) mem_cgroup_oom_unlock(memcg); cleanup: current-\u0026gt;memcg_in_oom = NULL; css_put(\u0026amp;memcg-\u0026gt;css); return true; } Kubernetes å¦‚ä½•ä½¿ç”¨ cgroup memory # ç¶“éå‰é¢æ·±å…¥çš„æ¢è¨ï¼Œæˆ‘å€‘å·²ç¶“å®Œæ•´è§£æäº† Linux æ ¸å¿ƒå±¤ç´šçš„ memory cgroup æ©Ÿåˆ¶ï¼Œå¾è¨˜å¸³ã€é™åˆ¶ã€å›æ”¶ï¼Œåˆ°æœ€çµ‚çš„ OOM Killã€‚ç¾åœ¨ï¼Œè®“æˆ‘å€‘å°‡è¦–è§’æ‹‰å›åˆ°æ›´é«˜å±¤æ¬¡çš„å®¹å™¨ç·¨æ’ç³»çµ±ï¼Œçœ‹çœ‹ Kubernetes æ˜¯å¦‚ä½•å·§å¦™åœ°é‹ç”¨é€™äº›åº•å±¤ cgroup åŠŸèƒ½ä¾†ç®¡ç† Pod çš„è¨˜æ†¶é«”è³‡æºèˆ‡æœå‹™å“è³ª (QoS)ã€‚\nåœ¨ Kubernetes ä¸­ï¼ŒPod çš„è¨˜æ†¶é«”è³‡æºé…ç½®ä¸»è¦é€éÂ resources.limits.memoryÂ å’ŒÂ resources.requests.memoryé€²è¡Œè¨­å®šï¼š\nresources: limits: cpu: 100m memory: 128Mi requests: cpu: 100m memory: 128Mi limits.memoryÂ (è¨˜æ†¶é«”é™åˆ¶) æœƒè¢«æ˜ å°„åˆ° cgroup çš„Â memory.maxÂ æª”æ¡ˆï¼Œè¨­å®š Pod æ‰€èƒ½ä½¿ç”¨çš„è¨˜æ†¶é«”ç¡¬ä¸Šé™ã€‚ requests.memoryÂ (è¨˜æ†¶é«”è«‹æ±‚) åœ¨ cgroup v1 å’Œæ—©æœŸ cgroup v2 çš„ Kubernetes ç‰ˆæœ¬ä¸­ï¼Œä¸»è¦ç”¨æ–¼æ’ç¨‹å™¨ (scheduler) åˆ†é…ç¯€é»æ™‚çš„è€ƒé‡ï¼Œä¸¦ä¸æœƒç›´æ¥è¨­å®š cgroup çš„Â memory.minÂ æˆ–Â memory.lowã€‚é›–ç„¶ KEP-2570 (Support Memory QoS with cgroups v2) å˜—è©¦åœ¨ cgroup v2 ä¸­æ”¯æ´å°‡Â requests.memoryÂ å°æ‡‰åˆ°Â memory.minÂ ä»¥æä¾›æ›´å¼·çš„è¨˜æ†¶é«” QoS ä¿è­‰ï¼Œä½†ç›´åˆ° Kubernetes v1.27 çš„ alpha ç‰ˆæœ¬æ‰é–‹å§‹æ”¯æ´ï¼Œä¸”ç›®å‰ç‰ˆæœ¬ (v1.32 alpha) è©²åŠŸèƒ½ä»æœªé è¨­å•Ÿç”¨ï¼Œä¸¦ä¸”ä»å­˜åœ¨æ½›åœ¨å•é¡Œã€‚å› æ­¤ï¼Œç›®å‰Â requests.memoryÂ ä¸»è¦ä»æ˜¯æ’ç¨‹å±¤é¢çš„è€ƒé‡ã€‚ å„˜ç®¡Â requests.memoryÂ æœªç›´æ¥å½±éŸ¿Â memory.minï¼Œä½† Kubernetes æœƒæ ¹æ“š Pod çš„ QoS ç­‰ç´šèª¿æ•´å…¶å…§éƒ¨å®¹å™¨çš„Â oom_score_adjï¼š\ngraph LR subgraph \u0026#34;Kubernetes Pod Spec\u0026#34; A(Pod) A -- QoS: Guaranteed --\u0026gt; B[\u0026#34; requests.memory = 128Mi limits.memory = 128Mi \u0026#34;]; A -- QoS: Burstable --\u0026gt; C[\u0026#34; requests.memory = 64Mi limits.memory = 128Mi \u0026#34;]; A -- QoS: BestEffort --\u0026gt; D[\u0026#34; (no requests/limits) \u0026#34;]; end subgraph \u0026#34;Cgroup/Procfs è¨­å®š\u0026#34; E[\u0026#34;memory.max = 134217728 (128MiB)\u0026#34;] F[\u0026#34;oom_score_adj = -997\u0026#34;] G[\u0026#34;memory.max = 134217728 (128MiB)\u0026#34;] H[\u0026#34;oom_score_adj = 937 (è¨ˆç®—å¾—å‡º)\u0026#34;] I[\u0026#34;memory.max = (node allocatable)\u0026#34;] J[\u0026#34;oom_score_adj = 1000\u0026#34;] end B --\u0026gt; E; B --\u0026gt; F; C --\u0026gt; G; C --\u0026gt; H; D --\u0026gt; I; D --\u0026gt; J; classDef k8s fill:#d4e4ff,stroke:#333; class A,B,C,D k8s; classDef cgroup fill:#d2ffd2,stroke:#333; class E,F,G,H,I,J cgroup; Guaranteed QoS ç­‰ç´šçš„ Podï¼šå…¶å®¹å™¨çš„Â oom_score_adjÂ è¨­å®šç‚ºä¸€å€‹è¼ƒä½çš„å€¼Â -997ï¼Œä»¥é™ä½å…¶è¢« OOM Killer æ®ºæ­»çš„æ©Ÿç‡ã€‚Kubelet å’Œ Kube-proxy ç­‰é—œéµç³»çµ±å…ƒä»¶çš„Â oom_score_adjÂ ç”šè‡³æœƒè¢«è¨­å®šç‚ºÂ -999ã€‚ BestEffort QoS ç­‰ç´šçš„ Podï¼šå…¶å®¹å™¨çš„Â oom_score_adjÂ é€šå¸¸è¨­å®šç‚ºÂ 1000ï¼Œè¡¨ç¤ºå®ƒå€‘æ˜¯ OOM Killer çš„é¦–é¸ç›®æ¨™ã€‚ Burstable QoS ç­‰ç´šçš„ Podï¼šå…¶Â oom_score_adjÂ ä»‹æ–¼ Guaranteed å’Œ BestEffort ä¹‹é–“ï¼Œå…¶è¨ˆç®—æ–¹å¼é€šå¸¸æ˜¯ä¸€å€‹å•Ÿç™¼å¼å…¬å¼ï¼Œä¾‹å¦‚Â min(max(2, 1000 - (1000 Ã— memoryRequestBytes) / machineMemoryCapacityBytes), 999)ã€‚é€™å€‹å…¬å¼æ—¨åœ¨è®“é‚£äº›å¯¦éš›ä½¿ç”¨è¨˜æ†¶é«”è¶…éå…¶Â requestsÂ å€¼çš„ Burstable å®¹å™¨ï¼Œæ›´å®¹æ˜“è¢« OOM Killï¼Œå¾è€Œä¿è­· Guaranteed å®¹å™¨å’Œæ•´å€‹ç³»çµ±ã€‚å…·é«”çš„åŸç†å°±ä¸å±•é–‹äº†ã€‚ // kubernetes/pkg/kubelet/qos/policy.go const ( // KubeletOOMScoreAdj is the OOM score adjustment for Kubelet KubeletOOMScoreAdj int = -999 // KubeProxyOOMScoreAdj is the OOM score adjustment for kube-proxy KubeProxyOOMScoreAdj int = -999 guaranteedOOMScoreAdj int = -997 besteffortOOMScoreAdj int = 1000 ) æ­¤å¤–ï¼ŒKubernetes ä¹Ÿæœƒè¨­å®šæ•´å€‹Â kubepodsÂ cgroup çš„Â memory.maxï¼Œç‚ºç³»çµ±ä¿ç•™ä¸€éƒ¨åˆ†è¨˜æ†¶é«”ï¼Œé€™æœ‰åŠ©æ–¼ç¢ºä¿ç¯€é»è‡ªèº«é‹è¡Œçš„ç©©å®šæ€§ã€‚\nç¸½çµä¾†èªªï¼ŒKubernetes é€é cgroup çš„Â memory.maxÂ é€²è¡Œç¡¬æ€§è¨˜æ†¶é«”é™åˆ¶ï¼Œä¸¦é€éèª¿æ•´Â oom_score_adjÂ ä¾†å¯¦ç¾ä¸åŒ QoS ç­‰ç´š Pod åœ¨è¨˜æ†¶é«”ä¸è¶³æ™‚çš„å„ªå…ˆç´šæ’åºã€‚å°æ–¼æ›´ç²¾ç¢ºçš„è¨˜æ†¶é«” QoS æ§åˆ¶ (å¦‚é€éÂ memory.minÂ å¯¦ç¾ä¿è­‰)ï¼Œç›¸é—œåŠŸèƒ½ä»åœ¨ Kubernetes çš„é–‹ç™¼å’Œæ¼”é€²ä¸­ã€‚\nç¸½çµ # å¾ cgroup v2 çš„æª”æ¡ˆä»‹é¢å‡ºç™¼ï¼Œæˆ‘å€‘ä¸€è·¯å‘ä¸‹è¿½è¹¤ï¼Œæ·±å…¥åˆ° Linux æ ¸å¿ƒä¸­Â mem_cgroupÂ çš„çµæ§‹è¨­è¨ˆã€page_counterçš„è¨ˆè²»åŸç†ï¼Œä¸¦æ²¿è‘—ç¼ºé ä¸­æ–·çš„è™•ç†è·¯å¾‘ï¼Œäº†è§£äº†Â mem_cgroup_chargeÂ å¦‚ä½•åœ¨å±¤å±¤ cgroup ä¹‹é–“é€²è¡Œåš´æ ¼çš„è¨˜å¸³ã€‚ç•¶è¨˜æ†¶é«”è§¸åŠÂ memory.maxÂ çš„ç´…ç·šæ™‚ï¼Œæˆ‘å€‘ä¹Ÿè©³ç´°å‰–æäº†æ ¸å¿ƒå¦‚ä½•å˜—è©¦å›æ”¶è¨˜æ†¶é«”ï¼Œä»¥åŠï¼Œoom_badnessÂ å‡½å¼å¦‚ä½•è¨ˆç®—åˆ†æ•¸ï¼Œç²¾æº–åœ°æŒ‘é¸å‡ºã€Œæœ€è©²è¢«çµ‚çµã€çš„è¡Œç¨‹ã€‚æ¢è¨äº† cgroup v1 å’Œ v2 åœ¨ OOM Kill å¤±æ•—æ™‚çš„è¡Œç‚ºã€‚ä¸¦ç°¡å–®æ¢è¨äº†ä¸€ä¸‹ Kubernetes å¦‚ä½•æ‡‰ç”¨ memory cgroup çš„æ©Ÿåˆ¶ã€‚\nåƒè€ƒæ›¸ç± # æ·±å…¥ç†è§£ Linux é€²ç¨‹èˆ‡å…§å­˜ ","date":"June 25 2025","externalUrl":null,"permalink":"/posts/how-linux-implement-cgroupv2-memory-control/","section":"æ–‡ç« ","summary":"","title":"è§£æ Linux Cgroup V2 çš„ memory control å¯¦ç¾","type":"posts"},{"content":"","date":"May 24 2025","externalUrl":null,"permalink":"/tags/obsidian/","section":"æ¨™ç±¤","summary":"","title":"Obsidian","type":"tags"},{"content":"ç¹¼å°‡éƒ¨è½æ ¼æ¡†æ¶å¾ Hexo æ›åˆ° Vue å†æ›åˆ° Hugoï¼Œæˆ‘çš„éƒ¨è½æ ¼æ’°å¯«æµç¨‹ä¹Ÿè¿ä¾†äº†ä¸€å€‹é‡å¤§çš„æ”¹è®Šã€‚å¾åŸæœ¬ä½¿ç”¨ Notion ä¾†ç®¡ç†åŠæ’°å¯«æ–‡ç« ï¼Œè½‰æ›åˆ°ä½¿ç”¨ Obsidian ä¾†å®Œæˆã€‚ä»Šå¤©ï¼Œæˆ‘å°‡ä»‹ç´¹æ˜¯ä»€éº¼ä¿ƒä½¿æˆ‘å¾ Notion è½‰æ›åˆ° Obsidianï¼Œä¸¦ä¸”èªªæ˜åœ¨ä½¿ç”¨ Obsidian æ­é… Hugo æ’°å¯« Markdown éƒ¨è½æ ¼æ™‚ï¼Œæ‡‰è©²å¦‚ä½•é€²è¡Œè¨­å®šèˆ‡æ•´åˆã€‚\né¸æ“‡ Markdown éƒ¨è½æ ¼çš„ç†ç”± # é¦–å…ˆè¦èªªæ˜ç‚ºä»€éº¼ï¼Œæˆ‘é¸æ“‡ä»¥ Markdown ç‚ºåŸºç¤çš„éƒ¨è½æ ¼æ¡†æ¶ã€‚ä½¿ç”¨ Markdown ä½œç‚ºéƒ¨è½æ ¼çš„åŸºç¤ï¼Œæœ€å¤§çš„å„ªå‹¢å°±æ˜¯å®ƒæ‰€æä¾›çš„æ¥µé«˜å½ˆæ€§ã€‚ç”±æ–¼å…§å®¹åŸºæ–¼ Markdown æª”æ¡ˆï¼Œåªè¦ä»»ä½•æ¡†æ¶èƒ½æ¥æ”¶ Markdown æ ¼å¼ä¸¦ç”Ÿæˆéƒ¨è½æ ¼ç¶²é ï¼Œå°±å¯ä»¥ä¸å—å¹³å°é™åˆ¶åœ°è‡ªç”±åˆ‡æ›ã€‚é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æˆ‘èƒ½å¾ Hexo å¿«é€Ÿè½‰ç§»åˆ° VuePressï¼Œå†åˆ°ç¾åœ¨çš„ Hugoã€‚æ­¤å¤–ï¼Œé€™é¡éƒ¨è½æ ¼å·¥å…·åœ¨åŠŸèƒ½å¼·å¤§çš„åŸºç¤ä¸Šï¼Œé€éæ¨¡æ¿ç­‰æ©Ÿåˆ¶æä¾›äº†ä¾¿æ·çš„ä¿®æ”¹ç©ºé–“ï¼Œè®“ä¸»é¡Œæ›´æ›æˆ–ç‰¹æ®ŠåŠŸèƒ½æ·»åŠ è®Šå¾—è¼•è€Œæ˜“èˆ‰ã€‚\nåŒæ¨£åœ°ï¼Œå°æ–¼æ–‡ç« çš„æ’°å¯«å·¥å…·ï¼Œåªè¦å®ƒæœ€çµ‚èƒ½ç”¢å‡º Markdown æ–‡ä»¶ï¼Œå°±èƒ½å¤ é·ç§»åˆ°ä»»ä½•å¹³å°ï¼Œç”šè‡³æ˜¯ç›´æ¥ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨é€²è¡Œå¯«ä½œã€‚è€Œå°æ–¼ Markdown ç·¨è¼¯å™¨ï¼Œæˆ‘èªç‚ºæœ€é‡è¦çš„ä¸€é»æ˜¯è¦è§£æ±ºåœ–ç‰‡ä¸Šå‚³çš„å•é¡Œã€‚å°æ–¼ Markdown éƒ¨è½æ ¼è€Œè¨€ï¼Œåœ–ç‰‡é€šå¸¸æœƒä¸Šå‚³åˆ°åœ–åºŠä¸¦å°‡é€£çµåµŒå…¥ Markdown æ–‡ä»¶ä¸­ï¼Œæˆ–è€…å°‡åœ–ç‰‡æ”¾åœ¨æœ¬åœ°çš„Â staticÂ è³‡æ–™å¤¾ï¼Œç„¶å¾ŒåŒæ¨£å°‡è·¯å¾‘æ”¾ç½®æ–¼ Markdown æ–‡ä»¶å…§ã€‚\nä½¿ç”¨ä¸€èˆ¬çš„æ–‡å­—ç·¨è¼¯å™¨ä¾†æ’°å¯«éƒ¨è½æ ¼ï¼Œé™¤äº†ç„¡æ³•é è¦½ä¹‹å¤–ï¼Œæˆ‘è¦ºå¾—æœ€å¤§çš„å•é¡Œæ˜¯å¢åŠ åœ–ç‰‡çš„å‹•ä½œæœƒéæ–¼ç¹ç‘£ï¼Œåš´é‡æ‰“äº‚å¯«ä½œæµç¨‹ã€‚\nå…¶æ¬¡ï¼Œç•¶ç„¶æ˜¯è¦æä¾›è‰¯å¥½çš„å¯«ä½œé«”é©—ã€‚é€™åŒ…æ‹¬è»Ÿé«”æœ¬èº«çš„åæ‡‰é€Ÿåº¦ã€é è¦½åŠŸèƒ½ï¼Œç”šè‡³æ˜¯æ‰€è¦‹å³æ‰€å¾—ï¼ˆWYSIWYGï¼‰çš„ç·¨è¼¯æ¨¡å¼ï¼Œä»¥åŠå­—é«”å¤§å°ã€æ¨£å¼ç­‰å¯è‡ªå®šç¾©çš„é¸é …ã€‚\næœ€å¾Œä¸€é»æ˜¯ Frontmatter çš„ç®¡ç†åŠŸèƒ½ã€‚å°æ–¼ Markdown éƒ¨è½æ ¼ï¼Œæˆ‘å€‘éœ€è¦ä½¿ç”¨ Frontmatter ä¾†ç®¡ç†æ–‡ç« çš„ metadataï¼Œä¾‹å¦‚è¨­å®šæ¨™ç±¤ã€æ¨™è¨˜ç‚ºè‰ç¨¿ç­‰ã€‚å¦‚æœç·¨è¼¯å™¨èƒ½å¤ æä¾›ç›¸é—œçš„ç®¡ç†åŠŸèƒ½ï¼Œé‚£ç„¡ç–‘æ˜¯å€‹åŠ åˆ†é …ã€‚\nä½¿ç”¨ Notion çš„å·¥ä½œæµ # å›é¡§æˆ‘çš„éƒ¨è½æ ¼æ’°å¯«æ­·ç¨‹ï¼Œæœ€æ—©æˆ‘æ˜¯ä½¿ç”¨ VSCode ä¾†æ’°å¯«éƒ¨è½æ ¼ï¼Œä¸¦å°‡æ–‡ç« ä¿å­˜åœ¨ GitHub Repo ä¸­ï¼Œé…åˆ GitHub Actions è‡ªå‹•ç·¨è­¯æˆ GitHub Pagesã€‚\nç•¶æ™‚ VSCode çš„ Markdown ç·¨è¼¯å™¨å°šæœªæä¾›è²¼ä¸Šåœ–ç‰‡è‡ªå‹•å„²å­˜è‡³åŒè³‡æ–™å¤¾çš„åŠŸèƒ½ï¼Œå› æ­¤æ¯æ¬¡å¢åŠ åœ–ç‰‡éƒ½éå¸¸éº»ç…©ã€‚ç”±æ–¼æˆ‘æœ¬èº«æœ‰åœ¨ä½¿ç”¨ Notionï¼Œä¾¿èŒç”Ÿäº†èƒ½å¦ä½¿ç”¨ Notion ä¾†æ’°å¯«éƒ¨è½æ ¼çš„æƒ³æ³•ã€‚é¦–å…ˆï¼ŒNotion çš„ä¸»è¦åŠŸèƒ½èˆ‡ Markdown æ ¼å¼ç›¸å®¹ï¼Œå¯ä»¥åŒ¯å‡º Markdown æ–‡ä»¶ï¼ŒåŒæ™‚ä¹Ÿæä¾›äº†æ‰€è¦‹å³æ‰€å¾—çš„ç·¨è¼¯å™¨å’Œåœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ã€‚æ­¤å¤–ï¼Œå¾—åŠ›æ–¼ Notion çš„çœ‹æ¿åŠŸèƒ½å’Œè³‡æ–™åº«åŠŸèƒ½ï¼Œæˆ‘å¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†æ–‡ç« çš„ metadataã€‚\nç‚ºäº†å°‡ Notion èˆ‡éƒ¨è½æ ¼æ•´åˆï¼Œæˆ‘åœ¨ç¶²è·¯ä¸Šæ‰¾åˆ°äº†ä¸€å€‹ç”±ä»–äººæä¾›çš„ GitHub Actions æµç¨‹ï¼Œå¯ä»¥å°‡æ–‡ç« ä¸‹è¼‰ä¸‹ä¾†ä¸¦æäº¤ç‚º Markdown æ–‡ä»¶ï¼ŒåŒæ™‚æä¾›è‡ªå‹•å°‡åœ–ç‰‡è½‰å‚³åˆ°åœ–åºŠçš„åŠŸèƒ½ã€‚ç”±æ–¼æˆ‘ä¸å–œæ­¡å°‡åœ–ç‰‡ä¸Šå‚³åˆ°åœ–åºŠï¼Œæ‰€ä»¥æˆ‘å°å…¶é€²è¡Œäº†ä¿®æ”¹ï¼Œè®“åœ–ç‰‡ä¸‹è¼‰åˆ°å„²å­˜åº«ä¸­ï¼Œä¸¦ä»¥ MD5 å€¼ä½œç‚ºæª”åã€‚\nå°±é€™æ¨£ï¼Œæˆ‘çš„ç¬¬ä¸€ä»£éƒ¨è½æ ¼ç·¨è¼¯å™¨å·¥ä½œæµèª•ç”Ÿäº†ã€‚\né‡è¦‹ Obsidian # å¤§ç´„åœ¨ä½¿ç”¨ Notion å¾Œä¸ä¹…ï¼Œæˆ‘æ¥è§¸åˆ°äº† Obsidian é€™å€‹ Markdown ç­†è¨˜å·¥å…·ã€‚å°æˆ‘ä¾†èªªï¼ŒObsidian æœ€å¤§çš„é‡é»åœ¨æ–¼å…¶é€Ÿåº¦åŠå¯èª¿æ•´æ€§ã€‚Notion åŸºæ–¼ç¶²é çš„æ¶æ§‹ï¼Œå°è‡´å³ä½¿ä¸‹è¼‰äº† Notion è»Ÿé«”ï¼Œæ¯æ¬¡æ‰“é–‹æ‡‰ç”¨ç¨‹å¼å’Œåˆ‡æ›é é¢é‚„æ˜¯æœƒæœ‰è‚‰çœ¼å¯è¦‹çš„æ™‚é–“å»¶é²ã€‚æ­¤å¤–ï¼ŒNotion æœ‰é™çš„å­—é«”å’Œä¸»é¡Œä¹Ÿè®“æˆ‘æœ‰äº›ä¸æ»¿ã€‚é‚„æœ‰ä¸€é»æ˜¯ Notion åŸºæ–¼å€å¡Šï¼ˆblockï¼‰çš„çµæ§‹ï¼Œæœ‰æ™‚åœ¨ä¿®æ”¹æ–‡ç« ã€è¤‡è£½è²¼ä¸Šæ™‚å¸¸å¸¸æœƒç™¼ç”Ÿèª¤æ“ä½œã€‚\nç›¸ååœ°ï¼ŒObsidian çš„æ•ˆç‡éå¸¸é«˜ï¼Œé–‹å•Ÿé€Ÿåº¦æ¥µå¿«ï¼ˆæˆ‘é‚„æ›¾ä½¿ç”¨ Logseq ä½œç‚ºç­†è¨˜å·¥å…·ï¼Œä½†å…¶å•Ÿå‹•æ™‚é–“å’Œä¸å¤ªç›´è§€çš„å€å¡Šçµæ§‹è®“æˆ‘å»æ­¥ï¼‰ã€‚Obsidian åŒæ¨£æ”¯æ´è²¼ä¸Šåœ–ç‰‡ï¼Œä¸¦æä¾›äº†æ–¹ä¾¿çš„ä¸»é¡ŒåŠå­—é«”èª¿æ•´åŠŸèƒ½ã€‚åœ¨æ’°å¯«Â Linux Kernel ç¶²è·¯å·¡ç¦® :: 2024 iThome éµäººè³½Â çš„éç¨‹ä¸­ï¼Œæˆ‘å°±æ˜¯å…ˆåœ¨ Obsidian å¯«å®Œå†è²¼åˆ° iThome çš„ç·¨è¼¯å™¨ã€‚æ­¤å¾Œï¼Œä¸€éƒ¨åˆ†çš„éƒ¨è½æ ¼æ–‡ç« ï¼Œä¹Ÿæ˜¯å…ˆåœ¨ Obsidian å¯«å®Œå†è²¼åˆ° Notion ç®¡ç†ã€‚\næ•´åˆ Obsidian èˆ‡ Hugo # åŸæœ¬æˆ‘åªæ˜¯å°‡ Obsidian ç•¶ä½œå–®ç´”çš„ç­†è¨˜è»Ÿé«”ä¾†ä½¿ç”¨ï¼Œç›´åˆ°æœ€è¿‘æ¯”è¼ƒå¤§é‡åœ°ä½¿ç”¨ Obsidian ä¸¦ç ”ç©¶å…¶æ’ä»¶åŠŸèƒ½ä¹‹å¾Œï¼Œæˆ‘æ‰æƒ³åˆ°ï¼šç‚ºä»€éº¼æˆ‘ä¸ç›´æ¥ä½¿ç”¨ Obsidian ä¾†ç·¨è¼¯ Hugo å„²å­˜åº«è³‡æ–™å¤¾ï¼Œç›´æ¥å°‡ Obsidian ä½œç‚ºéƒ¨è½æ ¼ç·¨è¼¯å™¨å‘¢ï¼Ÿ\nå‰é¢æåˆ°ä½¿ç”¨ Obsidian çš„è«¸å¤šå¥½è™•ï¼šé«˜æ•ˆå¿«é€Ÿã€å¯è‡ªå®šç¾©çš„ä¸»é¡Œè®“äººæ„Ÿåˆ°éå¸¸èˆ’é©ï¼Œä»¥åŠæ’ä»¶å’Œå±¬æ€§ï¼ˆpropertiesï¼‰å¯ä»¥æ–¹ä¾¿åœ°ç®¡ç† Frontmatterï¼Œé‚„æœ‰æ¨¡æ¿ç­‰æ’ä»¶å¯ä»¥æå‡å¯«ä½œæ•ˆç‡ã€‚å°æˆ‘ä¾†èªªï¼Œæœ¬åœ°åŒ–å„²å­˜ä¹Ÿä¸æ˜¯ç¼ºé»ï¼Œåæ­£æœ€çµ‚éƒ½æœƒä¿å­˜åˆ° Git Repoã€‚\nä½¿ç”¨ Obsidian ä½œç‚ºéƒ¨è½æ ¼ç·¨è¼¯å·¥å…·ï¼Œèªªèµ·ä¾†ä¸¦ä¸é›£ã€‚ç›´æ¥å°‡Â postsÂ è³‡æ–™å¤¾ä½œç‚º Vault æ‰“é–‹å³å¯é–‹å§‹æ’°å¯«ï¼Œé€™å¾—ç›Šæ–¼ Obsidian å®Œå…¨åŸºæ–¼ Markdown æ–‡ä»¶çš„ç‰¹æ€§ã€‚\nåœ–ç‰‡ä¸Šå‚³åŠå…¶ä»–å•é¡Œ # ç„¶è€Œï¼Œèªªç°¡å–®é‚„æ˜¯æœ‰ä¸€å€‹å¾ˆå¤§çš„å•é¡Œéœ€è¦è§£æ±ºï¼Œé‚£å°±æ˜¯åœ–ç‰‡ä¸Šå‚³çš„å•é¡Œã€‚é›–ç„¶ Obsidian æ”¯æ´åœ–ç‰‡è²¼ä¸Šä¸¦ä¿å­˜åˆ°ç‰¹å®šè³‡æ–™å¤¾ï¼Œä½†å°æ–¼ Hugo é€™é¡éƒ¨è½æ ¼ç³»çµ±è€Œè¨€ï¼Œæˆ‘å€‘æ”¾åœ¨Â static/imagesÂ ç›®éŒ„ä¸‹çš„åœ–ç‰‡ï¼Œå¯¦éš›å‡ºç¾åœ¨æ–‡ç« ä¸­çš„é€£çµæ˜¯Â /images/xxxx.pngï¼Œè€Œæ”¾åœ¨Â content/posts/Â ä¸­çš„æ–‡ç« å¯¦éš›ç¶²å€æ˜¯Â posts/xxxxx/ã€‚å› æ­¤ï¼ŒObsidian çš„é è¨­åœ–ç‰‡è™•ç†æ–¹å¼ç„¡æ³•æ­£å¸¸é‹ä½œã€‚\nç¶²è·¯ä¸Šæœ‰ä¸€äº›è§£æ±ºæ–¹æ¡ˆï¼š\né€éæ’ä»¶å°‡åœ–ç‰‡ä¸Šå‚³åˆ°åœ–åºŠï¼Œç„¶å¾ŒåµŒå…¥é€£çµã€‚ç„¶è€Œï¼Œä¸€æ–¹é¢æˆ‘ä¸å¸Œæœ›ä¸Šå‚³åˆ°åœ–åºŠï¼Œå¦ä¸€æ–¹é¢é€™æœƒå°è‡´èˆŠæ–‡ç« ç„¡æ³•æ­£å¸¸é¡¯ç¤ºåœ–ç‰‡ã€‚\nåœ¨æ ¹ç›®éŒ„å»ºç«‹ä¸€å€‹Â imagesÂ ç›®éŒ„ï¼Œç„¶å¾ŒæŒ‡å®š Obsidian å°‡åœ–ç‰‡ä¿å­˜åˆ°é€™å€‹ç›®éŒ„ä¸‹ï¼Œä¸¦åœ¨ Hugo çš„Â config.tomlä¸­é€²è¡Œè¨­å®šã€‚é€™æ¨£æ”¾åœ¨Â imagesÂ ä¸­çš„åœ–ç‰‡ï¼Œå°±æœƒè¢« Hugo è¦–ç‚ºæ”¾åœ¨Â staticÂ ç›®éŒ„ä¸‹ã€‚ä½†æ˜¯åŒæ¨£åœ°ï¼Œé€™æœƒå°è‡´èˆŠåœ–ç‰‡ç„¡æ³•è¢«è®€å–ï¼Œè€Œä¸”é€™æ¨£æœƒå¢åŠ ä¸€å€‹è³‡æ–™å¤¾ï¼Œè®“çµæ§‹é¡¯å¾—æœ‰äº›é›œäº‚ã€‚\n[[module.mounts]] source = \u0026#39;images\u0026#39; target = \u0026#39;static/images\u0026#39; æ­¤å¤–ï¼Œé‚„æœ‰å…©å€‹ä¸å¤ªç›¸é—œçš„å°å•é¡Œï¼šé è¨­çš„åœ–ç‰‡åç¨±æ˜¯Â Pasted image \u0026lt;timestage\u0026gt;ï¼Œéå¸¸ä¸ç¾è§€ï¼›è€Œä¸”å³ä½¿è¨­å®šç‚ºçµ•å°è·¯å¾‘æ¨¡å¼ï¼ŒObsidian æ’å…¥çš„é€£çµä¹Ÿä¸æœƒæœ‰æœ€å‰é¢çš„æ–œç·šï¼Œä¾‹å¦‚Â images/xxxxÂ è€Œä¸æ˜¯Â /images/xxxxã€‚é€™æ¨£çš„æ ¼å¼ Hugo æ˜¯ä¸æ¥å—çš„ï¼Œå› ç‚ºæœƒè¢«ç•¶ä½œç›¸å°è·¯å¾‘ï¼Œè€Œéç¶²ç«™çš„çµ•å°è·¯å¾‘ã€‚\né‚„æœ‰ä¸€å€‹ä¸å¤ªç›¸é—œçš„å°å•é¡Œæ˜¯ï¼Œå¦‚æœå°‡æ•´å€‹å„²å­˜åº«ç•¶ä½œ Vault æ‰“é–‹ï¼ŒObsidian è£¡é¢æœƒçœ‹åˆ°ä¸€å †ä¸ç›¸å¹²çš„è³‡æ–™å¤¾ï¼Œé¡¯å¾—å¾ˆé›œäº‚ã€‚\nè§£æ±ºå•é¡Œ # æœ€çµ‚ï¼Œæˆ‘æƒ³åˆ°çš„è§£æ±ºæ–¹æ¡ˆå°±æ˜¯å°‡ repo èˆ‡ Vault åˆ†é›¢ï¼Œè€Œä¸”è¦åšåˆ°é€™é»éå¸¸å®¹æ˜“ï¼Œåªéœ€ä½¿ç”¨è»Ÿé€£çµï¼ˆsymlinkï¼‰åŠŸèƒ½å³å¯ã€‚é¦–å…ˆå°‡ repo ä¿å­˜åœ¨Â blogÂ è³‡æ–™å¤¾ï¼Œç„¶å¾Œå»ºç«‹å¦å¤–ä¸€å€‹Â blog-obsidianÂ ä½œç‚º Obsidian çš„ Vault ç›®éŒ„ã€‚\n# mac cd blog-obsidian ln -s ../blog/static/img ln -s ../blog/content/posts å»ºç«‹é€™å…©å€‹é€£çµï¼Œå‰è€…æ˜¯æˆ‘æ”¾ç½®åœ–ç‰‡çš„ç›®éŒ„ï¼ˆæˆ‘çš„æ–‡ç« åœ–ç‰‡çµ±ä¸€æ”¾åœ¨Â static/img/pagesï¼‰ï¼Œå¾Œè€…æ˜¯æ–‡ç« çš„ç›®éŒ„ã€‚é€™æ¨£åœ¨ Obsidian æ‰“é–‹å¾Œï¼Œå°±å¯ä»¥æ­£å¸¸çœ‹åˆ°æ‰€æœ‰èˆŠæ–‡ç« çš„åœ–ç‰‡äº†ï¼è€Œä¸” Obsidian çš„ç›®éŒ„æœƒéå¸¸ä¹¾æ·¨ï¼Œä¸æœƒçœ‹åˆ°å…¶ä»–ä¸ç›¸å¹²çš„æ±è¥¿ã€‚\nåœ–ç‰‡ä¿å­˜è¨­å®š # æ¥è‘—ï¼Œæˆ‘å€‘è¦èª¿æ•´åœ–ç‰‡ä¿å­˜çš„ä½ç½®å’Œæ ¼å¼ã€‚æˆ‘å€‘éœ€è¦å°‡åœ–ç‰‡æ”¾åˆ°Â img/pages/Â è³‡æ–™å¤¾ï¼Œä½¿ç”¨æ›´å¥½çš„æª”æ¡ˆåç¨±å–ä»£Â Pasted image \u0026lt;timestage\u0026gt;ï¼Œä¸¦ä¸”æ¡ç”¨ Markdown é€£çµè€Œä¸æ˜¯ Obsidian çš„Â ![[]]Â æ ¼å¼ã€‚\né€™é‚Šæˆ‘å€‘ä¸ä¿®æ”¹ Obsidian çš„é è¨­è¨­å®šï¼Œè€Œæ˜¯ç›´æ¥å®‰è£Â Image converterÂ é€™å€‹æ’ä»¶ã€‚\né¦–å…ˆï¼Œæˆ‘å€‘åœ¨æ’ä»¶è¨­å®šè£¡é¢æŒ‡å®šä½¿ç”¨Â link formatã€‚æˆ‘å€‘å®šç¾©ä¸€å€‹æ–°çš„æ ¼å¼Â markdown-absï¼Œé¸æ“‡Â Markdownã€Absoluteã€‚é€™æ¨£åœ–ç‰‡å°±æœƒä»¥ Markdown é€£çµæ ¼å¼çš„çµ•å°è·¯å¾‘åµŒå…¥åˆ° Markdown æ–‡ä»¶ä¸­ï¼Œä¸¦ä¸”æ˜¯å¸¶æœ‰æœ€å‰é¢æ–œç·šçš„Â /img/xxx..ï¼Œè§£æ±ºäº†é è¨­è²¼ä¸Šçš„å•é¡Œã€‚\næ³¨æ„ï¼šå»ºç«‹å®ŒæŒ‰ Save å¾Œï¼Œé‚„è¦é»ä¸€ä¸‹æ–°å»ºçš„é¸é …ï¼Œä¸ç„¶é‚„æ˜¯æœƒä½¿ç”¨å…¶é è¨­è¨­å®šã€‚\næ¥è‘—ï¼ŒFilenameÂ ä½¿ç”¨é è¨­æä¾›çš„Â NoteName-TimestampÂ å³å¯ã€‚é›–ç„¶æˆ‘åŸæœ¬æ˜¯ä½¿ç”¨ MD5 hash ä½œç‚ºæª”æ¡ˆåç¨±ï¼Œä½†æ˜¯é€™å€‹æ’ä»¶æ²’æœ‰æä¾›ä»¥å…§å®¹ hash ä½œç‚ºæª”æ¡ˆåç¨±çš„åŠŸèƒ½ï¼Œè€Œä¸”æœƒé‡åˆ°å»ºç«‹å¤šå€‹åŒåæª”æ¡ˆçš„å•é¡Œï¼Œæ‰€ä»¥ä¹¾è„†æ¡ç”¨é€™ç¨®æ–¹å¼ï¼Œé‚„å¯ä»¥å¾æª”æ¡ˆåç¨±çœ‹å‡ºæœ€åˆä¾†æºæ–¼å“ªç¯‡æ–‡ç« ï¼Œé‚„ä¸éŒ¯ã€‚\næœ€å¾Œï¼ŒlocationÂ å°±æŒ‡å®šåˆ°æˆ‘çš„Â img/pagesÂ ç›®éŒ„ã€‚\né€™æ¨£ï¼Œåœ–ç‰‡ä¸Šå‚³çš„å•é¡Œå°±å®Œå…¨è§£æ±ºäº†ã€‚\nå…¶ä»–æ¨è–¦çš„ plugin # é™¤äº†ä¸Šè¿°çš„è¨­å®šï¼Œé€™è£¡é¡å¤–æ¨è–¦ä¸€äº›å¯¦ç”¨çš„ Obsidian æ’ä»¶ï¼š\nAuto Link Title: ç•¶è²¼ä¸Šé€£çµæ™‚ï¼Œæœƒè‡ªå‹•æŠ“å–ç¶²ç«™çš„æ¨™é¡Œä½œç‚ºé€£çµæ–‡å­—ã€‚\nQuickAdd: é€éè¨­å®šå¿«é€Ÿéµï¼Œå¯ä»¥å¿«é€Ÿå»ºç«‹æ–°æ–‡ç« é é¢åˆ°Â content/postsÂ ç›®éŒ„ä¸‹ã€‚å®ƒé‚„æä¾›äº†è¨±å¤šå…¶ä»–åŠŸèƒ½ï¼Œé€™è£¡ä¸å¤šåšä»‹ç´¹ã€‚æˆ‘æœƒæ­é…æˆ‘çš„æ¨¡æ¿ä½¿ç”¨ï¼Œæ¨¡æ¿å…§å®¹å¦‚ä¸‹ï¼š\n--- categories: description: tags: date: {{date:YYYY-MM-DD}} title: draft: true --- Dataview: å¯ä»¥é€éé¡ä¼¼ SQL çš„æŒ‡ä»¤æŠ“å– Frontmatter çš„è³‡æ–™ã€‚ä½ å¯ä»¥å»ºç«‹ä¸€å€‹é¦–é ï¼ˆhomepageï¼‰ï¼Œç„¶å¾Œæä¾›æ‰€æœ‰è‰ç¨¿çš„åˆ—è¡¨ï¼Œæ–¹ä¾¿æŸ¥é–±ã€‚\nlist file.frontmatter.title from \u0026#34;posts\u0026#34; WHERE file.frontmatter.draft = true åªè¦è²¼ä¸Šé€™æ®µç¨‹å¼ç¢¼å³å¯ã€‚ å…¶ä»–å¾…è§£æ±ºçš„å•é¡Œ # å„˜ç®¡ç›®å‰çš„è¨­å®šå·²ç¶“éå¸¸æµæš¢ï¼Œä½†ä»æœ‰ä¸€äº›å•é¡Œæœ‰å¾…è§£æ±ºï¼š\nObsidian ä¸æ”¯æ´ä¸­é–“å¸¶ç©ºç™½çš„æ¨™ç±¤ï¼ˆtagï¼‰ã€‚ä¾‹å¦‚ï¼Œæˆ‘æœ‰ä¸€å€‹æ¨™ç±¤æ˜¯Â 2022 IThome éµäººè³½ - å­¸ç¿’ EBPF ç³»åˆ—ï¼Œæœƒè¢« Obsidian åˆ‡æˆÂ 2022ã€IThomeÂ ç­‰å¥½å¹¾å€‹æ¨™ç±¤ã€‚æˆ‘çš„è§£æ±ºæ–¹æ¡ˆæ˜¯åœ¨ Markdown æ–‡ä»¶ä¸­ä½¿ç”¨Â _Â æ›¿ä»£ç©ºç™½ï¼Œç„¶å¾Œåœ¨ç·¨è­¯ Hugo éƒ¨è½æ ¼çš„ CI/CD æµç¨‹ä¸­å†å°‡å…¶æ›¿æ›å›ä¾†ã€‚\nç›®å‰è²¼ä¸Šçš„åœ–ç‰‡å¦‚æœå¾Œä¾†æ–‡ç« ä¸­ç§»é™¤ï¼Œåœ–ç‰‡ä»ç„¶æœƒä¿ç•™åœ¨å„²å­˜åº«ä¸­ï¼Œéœ€è¦æ‰‹å‹•åˆªé™¤ã€‚é›–ç„¶é»æ“Šåœ–ç‰‡å¯ä»¥é¸æ“‡Â Delete Link and Imageï¼Œä½†æ“”å¿ƒéºå¿˜è€Œæœªåˆªé™¤ä¹¾æ·¨ã€‚æœªä¾†æœƒç ”ç©¶æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹æ³•è™•ç†é€™å€‹å•é¡Œã€‚\nObsidian ç¨ç«‹æˆä¸€å€‹ç›®éŒ„å¾Œï¼ŒçœŸçš„è¦ä¿å­˜æª”æ¡ˆæ™‚é‚„æ˜¯éœ€è¦åˆ° repo é‚£é‚Šé€²è¡ŒÂ commit/pushÂ æ“ä½œã€‚ç¾éšæ®µè€Œè¨€ï¼Œæˆ‘è¦ºå¾—é€™ä¸¦ä¸éº»ç…©ï¼Œè€Œä¸”å¯ä»¥åœ¨ä¸Šå‚³å‰é€²è¡Œæœ€çµ‚æª¢æŸ¥ã€‚ä¸éç†æƒ³æƒ…æ³æ˜¯èƒ½åœ¨ Obsidian è£¡é¢æ–°å¢ä¸€å€‹æŒ‰éˆ•ï¼ŒæŒ‰ä¸‹å»å¾Œè‡ªå‹•Â commitÂ ä¸¦å°‡Â draftÂ ç‹€æ…‹æ”¹ç‚ºÂ falseã€‚å¾—ç›Šæ–¼å¼·å¤§çš„æ’ä»¶æ©Ÿåˆ¶ï¼Œç›¸ä¿¡é€™æ˜¯å¯ä»¥å¯¦ç¾çš„ã€‚\næœ€å¾Œï¼ŒHugo æœ‰ä¸€å€‹Â lastmodÂ æ¬„ä½ä¾†è¡¨ç¤ºæœ€å¾Œä¸Šå‚³æ™‚é–“ã€‚åŒæ¨£å¸Œæœ›èƒ½å¤ è—‰ç”± Obsidian è‡ªå‹•æ›´æ–°é€™å€‹æ¬„ä½ï¼Œä¸éä¹Ÿæœ‰è€ƒæ…®æ‡‰è©²æ”¾åœ¨ GitHub Actions çš„ CI/CD æµç¨‹ä¸­è™•ç†æœƒæ¯”è¼ƒåˆé©ï¼Œæ‰€ä»¥ä¹Ÿç­‰å¾…æœªä¾†å†è§£æ±ºã€‚\nçµèª # ç¸½çš„ä¾†èªªï¼Œå¾ Notion è½‰æ›åˆ° Obsidian é€²è¡Œéƒ¨è½æ ¼æ’°å¯«ï¼Œé›–ç„¶åœ¨åˆæœŸè¨­å®šä¸Šéœ€è¦ä¸€äº›èª¿æ•´ï¼Œä½†å…¶å¸¶ä¾†çš„é«˜æ•ˆã€å½ˆæ€§å’Œå¯è‡ªå®šç¾©æ€§ï¼Œå¤§å¹…æå‡äº†æˆ‘çš„å¯«ä½œé«”é©—ã€‚æœŸå¾…æœªä¾†èƒ½é€²ä¸€æ­¥æ¢ç´¢æ›´å¤šè‡ªå‹•åŒ–èˆ‡æ•ˆç‡æå‡çš„å¯èƒ½æ€§ã€‚å¸Œæœ›é€™ç¯‡æ–‡ç« èƒ½ç‚ºåŒæ¨£åœ¨å°‹æ‰¾ç†æƒ³éƒ¨è½æ ¼æ’°å¯«æµç¨‹çš„ä½ ï¼Œæä¾›ä¸€äº›æœ‰åƒ¹å€¼çš„åƒè€ƒã€‚\n","date":"May 24 2025","externalUrl":null,"permalink":"/posts/use-obsidian-as-markdown-blog-editor/","section":"æ–‡ç« ","summary":"","title":"ä½¿ç”¨ Obdidian ä½œç‚º markdown éƒ¨è½æ ¼çš„ç·¨è¼¯å™¨","type":"posts"},{"content":"","date":"May 24 2025","externalUrl":null,"permalink":"/categories/%E9%83%A8%E8%90%BD%E6%A0%BC/","section":"åˆ†é¡","summary":"","title":"éƒ¨è½æ ¼","type":"categories"},{"content":"æ†‘è­‰åœ¨é©—è­‰ç¶²ç«™èº«ä»½ã€ç¢ºä¿ TLS é€£ç·šå®‰å…¨ä¸­æ‰®æ¼”é—œéµè§’è‰²ï¼Œç„¶è€Œï¼Œæ†‘è­‰èƒŒå¾Œçš„å„ç¨®æ¨™æº–ã€ç·¨ç¢¼æ ¼å¼ã€é©—è­‰æ©Ÿåˆ¶ä»¥åŠç›¸é—œçš„æŠ€è¡“ç´°ç¯€ï¼Œå¾€å¾€å®¹æ˜“è®“äººæ„Ÿåˆ°æ¨¡ç³Šã€‚é€™ç¯‡æ–‡ç« å°‡æœƒæ¢³ç†æ•¸ä½æ†‘è­‰çš„æŠ€è¡“è„ˆçµ¡ï¼Œå¾å…¶åº•å±¤çš„ç·¨ç¢¼æ ¼å¼ã€æ ¸å¿ƒçš„ X.509 æ¨™æº–ã€åˆ°å¦‚ä½•å±¤å±¤é©—è­‰æ†‘è­‰éˆï¼Œä»¥åŠå„ç¨®å®‰å…¨æ©Ÿåˆ¶ã€‚\nPEM èˆ‡ DERï¼šæ†‘è­‰çš„ç·¨ç¢¼æ ¼å¼ # ç•¶æˆ‘å€‘è«‡è«–æ•¸ä½æ†‘è­‰æ™‚ï¼Œé¦–å…ˆæœƒé‡åˆ°çš„æ˜¯å®ƒå€‘çš„å„²å­˜èˆ‡å‚³è¼¸æ ¼å¼ã€‚å…¶ä¸­ï¼ŒDER (Distinguished Encoding Rules) æ˜¯åŸºæ–¼Â ASN.1 (Abstract Syntax Notation One)Â çš„ä¸€ç¨®åš´æ ¼çš„äºŒé€²ä½ç·¨ç¢¼æ ¼å¼ã€‚\nASN.1Â æ˜¯ä¸€å€‹ç¨ç«‹æ–¼ç‰¹å®šèªè¨€å’Œå¹³å°çš„æ¨™æº–ï¼Œå®ƒå®šç¾©äº†ä¸€å¥—æè¿°è³‡æ–™çµæ§‹çš„è¦å‰‡ï¼ˆé¡ä¼¼æ–¼ gRPC ä½¿ç”¨çš„ Protobufï¼‰ï¼Œä¸¦èƒ½å°‡é€™äº›çµæ§‹åŒ–çš„è³‡æ–™è½‰æ›ç‚ºç‰¹å®šçš„äºŒé€²ä½æ ¼å¼ã€‚é€™ç¨®æ¨™æº–åŒ–çš„æ–¹å¼ç¢ºä¿äº†ä¸åŒç³»çµ±é–“è³‡æ–™äº¤æ›çš„ä¸€è‡´æ€§ã€‚\nDER ç·¨ç¢¼çš„æ†‘è­‰é€šå¸¸ä»¥Â .derÂ ä½œç‚ºå‰¯æª”åï¼Œå…¶å…§å®¹æ˜¯ç·Šæ¹Šçš„äºŒé€²ä½è³‡æ–™ã€‚\nä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€å€‹ ASN.1 å®šç¾©çš„ç°¡å–®è³‡æ–™çµæ§‹ï¼š\nEmployeeRecord ::= SEQUENCE { employeeID INTEGER, isFullTime BOOLEAN } é€™å€‹å®šç¾©è¡¨ç¤ºÂ EmployeeRecordÂ æ˜¯ä¸€å€‹åŒ…å«Â employeeIDï¼ˆæ•´æ•¸ï¼‰å’ŒÂ isFullTimeï¼ˆBooleanï¼‰æ¬„ä½çš„è¤‡åˆçµæ§‹ã€‚\né€²ä¸€æ­¥åœ°ï¼ŒITU-T åˆ¶å®šçš„ X.690 æŠ€è¡“è¦ç¯„è©³ç´°å®šç¾©äº†å¤šç¨®å°‡ ASN.1 è³‡æ–™çµæ§‹è½‰æ›æˆäºŒé€²ä½çš„æ–¹å¼ï¼Œå…¶ä¸­å°±åŒ…å«äº†å¸¸è¦‹çš„Â BER (Basic Encoding Rules)Â å’ŒÂ DERÂ ç·¨ç¢¼ã€‚åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ†‘è­‰é€šå¸¸æœƒä½¿ç”¨ DER ç·¨ç¢¼é€²è¡Œä¿å­˜ï¼Œè€Œå…¶å…·é«”å…§å®¹çµæ§‹å‰‡ç”± X.509 ç­‰æ¨™æº–å®šç¾©çš„å„ç¨® ASN.1 çµæ§‹ä¾†è¦ç¯„ã€‚\nèˆ‡ DER ç›¸è¼”ç›¸æˆçš„æ˜¯Â PEM (Privacy Enhanced Mail)Â æ ¼å¼ã€‚PEM æœ¬è³ªä¸Šæ˜¯å° DER ç·¨ç¢¼çš„äºŒé€²ä½æª”æ¡ˆé€²è¡Œ Base64 ç·¨ç¢¼ï¼Œä½¿å…¶èƒ½å¤ ä»¥ç´”æ–‡å­—å½¢å¼è¡¨ç¤ºï¼Œæ–¹ä¾¿åœ¨é›»å­éƒµä»¶æˆ–æ–‡å­—ç’°å¢ƒä¸­å‚³è¼¸ã€‚PEM æ ¼å¼çš„ç‰¹å¾µæ˜¯å…¶å…§å®¹æœƒè¢«Â -----BEGIN...-----Â é–‹é ­å’ŒÂ -----END...-----Â çµå°¾çš„å€å¡Šæ‰€åŒ…åœï¼Œä¾‹å¦‚æˆ‘å€‘å¸¸è¦‹çš„Â -----BEGIN CERTIFICATE-----ã€‚\nPEM æª”æ¡ˆé€šå¸¸ä½¿ç”¨Â .pemÂ ä½œç‚ºå‰¯æª”åã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸€å€‹Â .pemÂ æª”æ¡ˆå¯ä»¥åŒ…å«å¤šå€‹é€™é¡Â BEGIN/ENDÂ å€å¡Šï¼Œé€™æ„å‘³è‘—å®ƒèƒ½å¤ åœ¨å–®ä¸€æª”æ¡ˆä¸­å„²å­˜å¤šå€‹æ†‘è­‰ï¼ˆä¾‹å¦‚æ†‘è­‰éˆä¸­çš„å¤šå€‹æ†‘è­‰ï¼‰æˆ–é‡‘é‘°ã€‚\nX.509ï¼šæ†‘è­‰çš„æ¨™æº– # äº†è§£äº†æ†‘è­‰çš„ç·¨ç¢¼æ ¼å¼å¾Œï¼Œæˆ‘å€‘éœ€è¦æ¢ç©¶æ†‘è­‰æœ¬èº«çš„å…§å®¹çµæ§‹ã€‚åœ¨æ•¸ä½æ†‘è­‰é ˜åŸŸï¼ŒX.509Â æ˜¯æœ€å»£æ³›ä½¿ç”¨çš„æ¨™æº–ã€‚æˆ‘å€‘é€šå¸¸æ‰€èªªçš„ X.509ï¼Œç‰¹æŒ‡ç”±Â RFC 5280Â æè¿°çš„ X.509 v3 ç‰ˆæœ¬ï¼Œå®ƒè©³ç´°å®šç¾©äº†å…¬é–‹é‡‘é‘°æ†‘è­‰çš„è³‡æ–™çµæ§‹å’Œèªç¾©ã€‚\nRFC 5280 å®šç¾©äº†æ†‘è­‰çš„æ ¸å¿ƒçµæ§‹å¦‚ä¸‹ï¼š\nCertificate ::= SEQUENCE { tbsCertificate TBSCertificate, signatureAlgorithm AlgorithmIdentifier, signatureValue BIT STRINGÂ } é€™å€‹çµæ§‹æ¸…æ™°åœ°è¡¨æ˜ï¼Œä¸€å€‹æ†‘è­‰ç”±ä¸‰å¤§éƒ¨åˆ†çµ„æˆï¼šå¾…ç°½ç½²çš„æ†‘è­‰è³‡è¨Šï¼ˆtbsCertificateï¼‰ã€ç°½ç« æ¼”ç®—æ³•ï¼ˆsignatureAlgorithmï¼‰å’Œæ•¸ä½ç°½ç« å€¼ï¼ˆsignatureValueï¼‰ã€‚æ‚¨å¯ä»¥é€éÂ ASN.1 JavaScript decoderÂ ç­‰å·¥å…·ï¼Œå¯¦éš›æŸ¥çœ‹æ†‘è­‰çš„ ASN.1 çµæ§‹ï¼Œä»¥åŠ æ·±ç†è§£ã€‚\nDistinguished Name (DN)ï¼šæ†‘è­‰ä¸­çš„å¯¦é«”è­˜åˆ¥ # åœ¨æ†‘è­‰çš„å…§å®¹ä¸­ï¼Œä¸€å€‹é‡è¦çš„æ¦‚å¿µæ˜¯Â DN (Distinguished Name)ã€‚DN æ˜¯ä¸€ç¨®æ¨™æº–åŒ–çš„éšå±¤å¼åç¨±æ ¼å¼ï¼Œç”¨æ–¼å”¯ä¸€è­˜åˆ¥æ†‘è­‰çš„ä¸»é«”æˆ–ç°½ç™¼è€…ã€‚å®ƒå¸¸è¦‹æ–¼æ†‘è­‰å’Œ LDAP (Lightweight Directory Access Protocol) ä¸­ï¼Œä¾‹å¦‚åœ¨ LDAP ä¸­ï¼ŒCN=Jeff Smith,OU=Sales,DC=Fabrikam,DC=COMÂ ç”¨æ–¼æè¿°ä¸€å€‹ä½¿ç”¨è€…ã€‚\nDN æ˜¯ä¸€å€‹ç”±Â Relative Distinguished Name (RDN)Â åºåˆ—çµ„æˆçš„ã€‚æ¯å€‹ RDN éƒ½æ˜¯ä¸€å€‹éµï¼ˆæ­£å¼åç¨±ç‚º AttributeTypeï¼‰- å€¼å°ã€‚\nDN çš„è®€å–é †åºé€šå¸¸æ˜¯å¾å³åˆ°å·¦ï¼Œè¡¨ç¤ºå¾ä¸Šå±¤å¾€ä¸‹ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œå°æ–¼Â cn=Alice Smith,ou=Sales,o=Example Corp,c=USÂ é€™å€‹ DNï¼Œå®ƒå¯ä»¥è¢«ç†è§£ç‚ºä»¥ä¸‹çš„éšå±¤çµæ§‹ï¼š\nc=US (åœ‹å®¶ï¼šç¾åœ‹) | o=Example Corp (çµ„ç¹”ï¼šç¯„ä¾‹å…¬å¸) | ou=Sales (çµ„ç¹”å–®ä½ï¼šéŠ·å”®éƒ¨) | cn=Alice Smith (é€šç”¨åç¨±ï¼šAlice Smith) RFC 4519 (LDAP Schema) è¦ç¯„äº†ä¸€äº›å¸¸è¦‹çš„å±¬æ€§é¡å‹ (Attribute Type)ï¼Œé€™äº›å±¬æ€§é¡å‹åœ¨ X.500 å’Œ X.509 ä¸­ä¹Ÿå»£æ³›ä½¿ç”¨ï¼š\nString X.500 AttributeType CN commonName (2.5.4.3) L localityName (2.5.4.7) ST stateOrProvinceName (2.5.4.8) O organizationName (2.5.4.10) OU organizationalUnitName (2.5.4.11) C countryName (2.5.4.6) STREET streetAddress (2.5.4.9) DC domainComponent (0.9.2342.19200300.100.1.25) UID userId (0.9.2342.19200300.100.1.1) è¿½æº¯æ­·å²ï¼Œæœ€æ—©å‡ºç¾çš„æ˜¯ ITU-T X.500 æ¨™æº–ï¼Œæ—¨åœ¨å®šç¾©ä¸€å¥—å…¨é¢çš„ç›®éŒ„æœå‹™ç³»çµ±ï¼Œä¸¦åˆ©ç”¨ Distinguished Name ä¾†æè¿°å’Œå®šä½å”¯ä¸€çš„å¯¦é«”ã€‚X.500 çš„ DN å®šç¾©äº†è«¸å¦‚Â commonNameã€organizationNameÂ ç­‰å±¬æ€§ï¼Œæ¯å€‹å±¬æ€§éƒ½æœ‰å°æ‡‰çš„ç‰©ä»¶è­˜åˆ¥ç¢¼ (OID)ã€‚ç”±æ–¼ X.500 éæ–¼è¤‡é›œï¼Œç°¡åŒ–ç‰ˆçš„ LDAP æ‡‰é‹è€Œç”Ÿã€‚LDAP åœ¨ RFC 4514 ä¸­è¦ç¯„äº†æ‡‰ä»¥Â CN=Jeff Smith,OU=Sales,DC=Fabrikam,DC=COMÂ å½¢å¼çš„å­—ä¸²ä¾†æè¿° DNï¼Œä¸¦åœ¨ RFC 4519 ä¸­å®šç¾©äº† RDN ä¸­å¯èƒ½å‡ºç¾çš„å±¬æ€§é¡å‹ï¼ˆåŸºæœ¬æ²¿ç”¨äº† X.500 çš„å®šç¾©ï¼‰ã€‚åŒæ¨£åœ°ï¼ŒX.509 æ†‘è­‰æ¨™æº–ä¹Ÿæ¡ç”¨äº† DN ä½œç‚ºæè¿°æ†‘è­‰è³‡è¨Šçš„æ ¼å¼ï¼Œä¸¦å®šç¾©äº†ä¸€äº›å¿…é ˆæ”¯æ´çš„å±¬æ€§ï¼Œé€™äº›å±¬æ€§å¤§å¤šä¾†è‡ª X.500 çš„å®šç¾©ã€‚\nCertificateï¼šæ†‘è­‰çš„æ ¸å¿ƒå…§å®¹è§£æ # æ†‘è­‰çš„æ ¸å¿ƒåœ¨æ–¼å…¶æ‰€åŒ…å«çš„è³‡è¨Šï¼Œé€™äº›è³‡è¨Šå…±åŒå®šç¾©äº†æ†‘è­‰çš„èº«ä»½ã€æœ‰æ•ˆæœŸå’Œç”¨é€”ã€‚ä»¥ä¸‹æˆ‘å€‘ä»¥ Let\u0026rsquo;s Encrypt çš„ä¸€å€‹ä¸­ç¹¼æ†‘è­‰ç‚ºä¾‹ï¼Œè§£ææ†‘è­‰ä¸­çš„é‡è¦æ¬„ä½ï¼š\ntbsCertificateÂ (To Be Signed Certificate)ï¼šé€™æ˜¯æ†‘è­‰ä¸­æ‰€æœ‰å¾…ç°½ç½²çš„è³‡è¨Šï¼Œå®ƒåŒ…å«äº†æ†‘è­‰çš„å¯¦è³ªå…§å®¹ã€‚\nversion: æ†‘è­‰çš„ç‰ˆæœ¬è™Ÿï¼Œç¾ä»ŠåŸºæœ¬éƒ½ä½¿ç”¨ X.509 v3 (0x2) ã€‚\nSerial Number: ç”±æ†‘è­‰ç°½ç™¼æ©Ÿæ§‹ (CA) çµ¦å®šçš„ä¸€å€‹å”¯ä¸€è­˜åˆ¥è©²æ†‘è­‰çš„åºåˆ—è™Ÿï¼Œé€™åœ¨æ†‘è­‰æ’¤éŠ·åˆ—è¡¨ (CRL) ä¸­ä¹Ÿæ‰®æ¼”é‡è¦è§’è‰²ã€‚\nIssuer: è¡¨ç¤ºé€™å¼µæ†‘è­‰æ˜¯ç”±å“ªå€‹ CA ç°½ç½²çš„ï¼Œä¾‹å¦‚Â CN=DST Root CA X3, O=Digital Signature Trust Co.ã€‚\nsubject: æ†‘è­‰æ‰€å±¬çš„ä¸»é«”ï¼Œå³æ†‘è­‰æ‰€é©—è­‰çš„å¯¦é«”ï¼Œä¾‹å¦‚Â CN=Let's Encrypt Authority X3, O=Let's Encrypt, C=USã€‚\nvalidity: æ†‘è­‰çš„æœ‰æ•ˆæœŸé™ï¼ŒåŒ…å«èµ·å§‹æ—¥æœŸ (Not Before) å’ŒçµæŸæ—¥æœŸ (Not After)ã€‚ä¾‹å¦‚ï¼š\nNot Before: Mar 17 16:40:46 2016 GMT Not After: Mar 17 16:40:46 2021 GMT subjectPublicKeyInfo: æ†‘è­‰æŒæœ‰è€…æä¾›çš„å…¬é–‹é‡‘é‘°è³‡è¨Šï¼ŒåŒ…å«é‡‘é‘°çš„æ¼”ç®—æ³•ï¼ˆä¾‹å¦‚Â rsaEncryption (PKCS #1)ï¼‰å’Œé‡‘é‘°çš„å¯¦éš›æ•¸å€¼ã€‚\nextensions: é€™æ˜¯ X.509 v3 æ†‘è­‰çš„é‡è¦åŠŸèƒ½ï¼Œé€éä¸åŒçš„æ“´å±•æä¾›é¡å¤–çš„è³‡è¨Šå’ŒåŠŸèƒ½ï¼Œä¾‹å¦‚æ†‘è­‰çš„ç”¨é€”ã€æ†‘è­‰éˆçš„ç›¸é—œè³‡è¨Šç­‰ã€‚\nsignatureAlgorithmÂ å’ŒÂ signatureValueï¼šé€™å…©éƒ¨åˆ†å…±åŒæ§‹æˆäº†æ†‘è­‰çš„æ•¸ä½ç°½ç« ã€‚CA æ©Ÿæ§‹æœƒä½¿ç”¨å…¶ä¸Šå±¤æ†‘è­‰çš„ç§æœ‰é‡‘é‘°å°Â tbsCertificateÂ çš„é›œæ¹Šå€¼é€²è¡ŒåŠ å¯†ï¼Œç”Ÿæˆæ•¸ä½ç°½ç« ã€‚ä¸¦å¯ç”¨ä¸Šå±¤æ†‘è­‰çš„ Public Key é©—è­‰ã€‚\nsignatureAlgorithm: æŒ‡æ˜ç”¨æ–¼ç”Ÿæˆæ•¸ä½ç°½ç« çš„æ¼”ç®—æ³•ï¼Œä¾‹å¦‚Â sha256WithRSAEncryptionã€‚\nsignatureValue: å¯¦éš›çš„æ•¸ä½ç°½ç« å€¼ã€‚\né›œæ¹Šæ¼”ç®—æ³•åœ¨æ•¸ä½ç°½ç« ä¸­çš„è§’è‰² # åœ¨æ•¸ä½ç°½ç« çš„ç”Ÿæˆéç¨‹ä¸­ï¼Œç°½ç½²è€…æœƒå…ˆå°åŸå§‹è³‡æ–™ï¼ˆåœ¨æ†‘è­‰ä¸­å³ç‚ºÂ tbsCertificateÂ çš„å…§å®¹ï¼‰è¨ˆç®—å…¶é›œæ¹Šå€¼ï¼Œç„¶å¾Œä½¿ç”¨è‡ªå·±çš„ç§æœ‰é‡‘é‘°å°é€™å€‹é›œæ¹Šå€¼é€²è¡ŒåŠ å¯†ï¼Œå¾—åˆ°æ•¸ä½ç°½ç« ã€‚æ¥æ”¶è€…åœ¨é©—è­‰æ™‚ï¼Œå‰‡æœƒä½¿ç”¨ç°½ç½²è€…çš„å…¬é–‹é‡‘é‘°è§£å¯†æ•¸ä½ç°½ç« ï¼Œå¾—åˆ°åŸå§‹çš„é›œæ¹Šå€¼ï¼ŒåŒæ™‚ä¹Ÿå°æ¥æ”¶åˆ°çš„åŸå§‹è³‡æ–™é‡æ–°è¨ˆç®—é›œæ¹Šå€¼ï¼Œå¦‚æœå…©å€‹é›œæ¹Šå€¼ä¸€è‡´ï¼Œå‰‡è­‰æ˜è³‡æ–™æœªè¢«ç¯¡æ”¹ä¸”ç¢ºå¯¦ç”±ç°½ç½²è€…ç™¼å‡ºã€‚\nSource: Digital Signature diagram.svg - Wikipedia\næ†‘è­‰éˆçš„é©—è­‰æµç¨‹ï¼š # æ•¸ä½æ†‘è­‰çš„ä¿¡ä»»æ¨¡å‹æ˜¯å»ºç«‹åœ¨ã€Œä¿¡ä»»éˆã€çš„æ¦‚å¿µä¹‹ä¸Šã€‚ç•¶æˆ‘å€‘æ”¶åˆ°ä¸€å€‹æ†‘è­‰æ™‚ï¼Œå¿…é ˆé©—è­‰å®ƒæ˜¯å¦ç”±ä¸€å€‹å—ä¿¡ä»»çš„æ©Ÿæ§‹ç°½ç™¼ã€‚é€™å€‹é©—è­‰éç¨‹æ¶‰åŠå¾ç›®æ¨™æ†‘è­‰å‘ä¸Šè¿½æº¯ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€å€‹æˆ‘å€‘é å…ˆä¿¡ä»»çš„æ ¹æ†‘è­‰ã€‚\nå…¶æ ¸å¿ƒé©—è­‰æ­¥é©Ÿå¦‚ä¸‹ï¼š\nèº«ä»½åŒ¹é…ï¼šç›®æ¨™æ†‘è­‰çš„Â IssuerÂ æ¬„ä½å¿…é ˆèˆ‡å…¶ä¸Šå±¤æ†‘è­‰çš„Â SubjectÂ æ¬„ä½å®Œå…¨åŒ¹é…ã€‚é€™ç¢ºä¿äº†æ†‘è­‰æ˜¯ç”±è²ç¨±çš„ç°½ç™¼è€…æ‰€ç°½ç™¼ã€‚\næ•¸ä½ç°½ç« é©—è­‰ï¼šä½¿ç”¨ä¸Šå±¤æ†‘è­‰çš„Â subjectPublicKeyInfoÂ ä¸­åŒ…å«çš„å…¬é–‹é‡‘é‘°ï¼Œä¾†è§£å¯†ç›®æ¨™æ†‘è­‰çš„Â signatureValueã€‚è§£å¯†å¾Œæœƒå¾—åˆ°ä¸€å€‹é›œæ¹Šå€¼ã€‚åŒæ™‚ï¼Œå°ç›®æ¨™æ†‘è­‰çš„Â tbsCertificateÂ å…§å®¹é‡æ–°è¨ˆç®—é›œæ¹Šå€¼ã€‚å¦‚æœé€™å…©å€‹é›œæ¹Šå€¼ä¸€è‡´ï¼Œå‰‡è­‰æ˜ç›®æ¨™æ†‘è­‰çš„å…§å®¹æœªè¢«ç¯¡æ”¹ï¼Œä¸”ç¢ºå¯¦ç”±ä¸Šå±¤æ†‘è­‰çš„ç§æœ‰é‡‘é‘°æ‰€ç°½ç½²ã€‚ é€™å€‹éç¨‹æœƒå±¤å±¤éé€²ï¼Œç›´åˆ°é”åˆ°ä¸€å€‹ã€Œä¿¡ä»»éŒ¨é»ã€(Trust Anchor)ï¼Œé€šå¸¸æ˜¯ä¸€å€‹é å…ˆå®‰è£åœ¨ä½œæ¥­ç³»çµ±æˆ–ç€è¦½å™¨ä¸­çš„æ ¹æ†‘è­‰ (Root Certificate)ã€‚é€™äº›æ ¹æ†‘è­‰æ˜¯è‡ªæˆ‘ç°½ç½²çš„ï¼Œå®ƒå€‘çš„ä¿¡ä»»æ˜¯å…§å»ºçš„ï¼Œç„¡éœ€é€²ä¸€æ­¥é©—è­‰ã€‚\næ†‘è­‰éˆä¸­é–“çš„æ†‘è­‰å“ªè£¡ä¾†ï¼Ÿ # åœ¨ TLS æ¡æ‰‹éç¨‹ä¸­ï¼Œä¼ºæœå™¨é€šå¸¸æœƒæä¾›å…¶è‡ªèº«çš„æ†‘è­‰ä»¥åŠä»»ä½•å¿…è¦çš„ä¸­ç¹¼æ†‘è­‰ (Intermediate Certificates)ï¼Œä»¥ä¾¿ç”¨æˆ¶ç«¯èƒ½å¤ å»ºç«‹å®Œæ•´çš„æ†‘è­‰éˆã€‚ç„¶è€Œï¼Œæœ‰æ™‚ç”¨æˆ¶ç«¯å¯èƒ½éœ€è¦é¡å¤–ç²å–é€™äº›ä¸­ç¹¼æ†‘è­‰ã€‚\nX.509 æ†‘è­‰æä¾›äº†ä¸€å€‹åç‚ºÂ Authority Information Access (AIA)Â çš„æ“´å±•ï¼Œå…¶ä¸­å¯ä»¥åŒ…å«ä¸€å€‹ URLï¼Œè®“ç”¨æˆ¶ç«¯èƒ½å¤ ä¸‹è¼‰æ‰€éœ€çš„ä¸­ç¹¼æ†‘è­‰ã€‚\nä¾‹å¦‚ï¼Œç•¶æˆ‘å€‘é€éÂ Qualys SSL LabsÂ ç¶²ç«™æŸ¥çœ‹Â c2.synology.comÂ çš„æ†‘è­‰è³‡è¨Šæ™‚ï¼š æ‚¨å¯ä»¥çœ‹åˆ°Â c2.synology.comÂ çš„æ†‘è­‰éˆä¸­ï¼Œå‰ä¸‰å€‹æ†‘è­‰æ˜¯ç”±ä¼ºæœå™¨åœ¨ TLS æ¡æ‰‹éç¨‹ä¸­ç™¼é€éä¾†çš„ï¼Œè€Œæœ€å¾Œä¸€å€‹å‰‡æ˜¯æœ¬åœ°ä¿¡ä»»çš„æ ¹ CAã€‚ç¬¬å››å€‹æ†‘è­‰æ¨™è¨»ç‚ºÂ Extra downloadã€‚å¦‚æœæˆ‘å€‘é€²ä¸€æ­¥è§£æç¬¬ä¸‰å€‹æ†‘è­‰çš„è³‡è¨Šï¼Œå°±æœƒç™¼ç¾å…¶ä¸­åŒ…å«äº† AIA çš„è³‡è¨Šï¼ŒæŒ‡æ˜äº†ç²å–ç¬¬å››å€‹æ†‘è­‰çš„ URLï¼š Authority Information Access:Â OCSP - URI:http://ocsp.rootg2.amazontrust.com CA Issuers - URI:http://crt.rootg2.amazontrust.com/rootg2.cer é€éé€™å€‹æ©Ÿåˆ¶ï¼Œç”¨æˆ¶ç«¯å¯ä»¥å‹•æ…‹åœ°ç²å–æ†‘è­‰éˆä¸­ç¼ºå¤±çš„éƒ¨åˆ†ï¼Œå¾è€Œå®Œæˆæ†‘è­‰çš„å®Œæ•´é©—è­‰ã€‚\näº¤äº’ç°½å (Cross-Signing) # åœ¨æ†‘è­‰ä¿¡ä»»éˆä¸­ï¼Œäº¤äº’ç°½åæ˜¯ä¸€ç¨®å¸¸è¦‹çš„æ©Ÿåˆ¶ï¼Œç”¨æ–¼è®“æ–°èˆˆçš„æ†‘è­‰ç°½ç™¼æ©Ÿæ§‹ (CA) æ‰€ç°½ç™¼çš„æ†‘è­‰èƒ½å¤ è¢«å»£æ³›ä¿¡ä»»ï¼Œå°¤å…¶æ˜¯åœ¨å…¶è‡ªèº«çš„æ ¹æ†‘è­‰å°šæœªè¢«æ‰€æœ‰ç€è¦½å™¨å’Œä½œæ¥­ç³»çµ±ä¿¡ä»»çš„æƒ…æ³ä¸‹ã€‚\nä»¥ Let\u0026rsquo;s Encrypt ç‚ºä¾‹ï¼Œå…¶å®˜æ–¹èªªæ˜ä¸­æåˆ°ï¼šLet\u0026rsquo;s Encrypt Authority X3 ä¸­é–“æ†‘è­‰æ“æœ‰ä¸€å°å…¬é–‹é‡‘é‘°å’Œç§æœ‰é‡‘é‘°ã€‚Let\u0026rsquo;s Encrypt ä½¿ç”¨é€™å€‹ç§æœ‰é‡‘é‘°ä¾†ç°½ç½²æ‰€æœ‰çµ‚ç«¯æ†‘è­‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘æœ€çµ‚å¾ Let\u0026rsquo;s Encrypt ç²å¾—çš„æ†‘è­‰ã€‚Let\u0026rsquo;s Encrypt Authority X3 ä¸­é–“æ†‘è­‰æœ¬èº«å‰‡æ˜¯ç”± ISRG Root X1 æ ¹æ†‘è­‰æ‰€ç°½ç™¼ã€‚ç„¶è€Œï¼ŒISRG Root X1 åœ¨æ—©æœŸå°šæœªå—åˆ°å¤§å¤šæ•¸ç€è¦½å™¨çš„ä¿¡ä»»ã€‚ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼Œä¸¦ä½¿ Let\u0026rsquo;s Encrypt é ’ç™¼çš„æ†‘è­‰èƒ½å¤ è¢«å»£æ³›ä¿¡ä»»ï¼ŒLet\u0026rsquo;s Encrypt å‘ä¸€å€‹å·²å—ä¸»æµç€è¦½å™¨ä¿¡ä»»çš„æ ¹æ†‘è­‰ DST Root CA X3 è«‹æ±‚äº†äº¤äº’ç°½åã€‚ç¶“é DST Root CA X3 çš„ç°½åå¾Œï¼Œç”¢ç”Ÿäº†å¦ä¸€å€‹ç‰ˆæœ¬çš„ Let\u0026rsquo;s Encrypt Authority X3 ä¸­é–“æ†‘è­‰ã€‚\ngraph TD A[ISRG Root X1] --\u0026gt; C[Let\u0026#39;s Encrypt Authority X3] B[DST Root CA X3] --\u0026gt; C C --\u0026gt; D[Server Cert] C --\u0026gt; E[Server Cert] C --\u0026gt; F[Server Cert] å¤šè·¯å¾‘ä¿¡ä»»éˆï¼šå½ˆæ€§èˆ‡å…¼å®¹æ€§ # é€éäº¤äº’ç°½åæ©Ÿåˆ¶ï¼Œä¸€å€‹çµ‚ç«¯æ†‘è­‰å¯èƒ½ä¸åªä¸€æ¢æœ‰æ•ˆçš„æ†‘è­‰éˆå¯ä»¥è¢«é©—è­‰ã€‚é€™è¡¨ç¤ºç€è¦½å™¨ä¸è«–ä¿¡ä»» ISRG æ ¹æ†‘è­‰é‚„æ˜¯ DST Root CA X3 æ ¹æ†‘è­‰ï¼Œéƒ½å¯ä»¥å»ºç«‹ä¸€æ¢å®Œæ•´çš„ä¿¡ä»»éˆã€‚æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å°‡èªªæ˜é€™æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚\nå‰é¢æåˆ°ï¼Œå°æ–¼ä¸€å€‹çµ‚ç«¯æ†‘è­‰è€Œè¨€ï¼Œå…¶ä¸Šå±¤æ†‘è­‰éœ€è¦æ»¿è¶³å…©å€‹è¦æ±‚ï¼š\nSubject NameÂ ç­‰æ–¼çµ‚ç«¯æ†‘è­‰çš„Â Issuerã€‚\nä¸Šå±¤æ†‘è­‰çš„å…¬é–‹é‡‘é‘°è¦èƒ½é©—è­‰é™„åŠ åœ¨çµ‚ç«¯æ†‘è­‰ä¸Šçš„æ•¸ä½ç°½ç« ã€‚\nç„¶è€Œï¼Œé€™å…©å€‹è¦æ±‚ä¸¦æ²’æœ‰å¼·åˆ¶è¦å®šä¸Šå±¤æ†‘è­‰å¿…é ˆæ˜¯å®Œå…¨ç›¸åŒçš„ä¸€å¼µæ†‘è­‰ï¼Œåªè¦ä¸Šå±¤æ†‘è­‰çš„Â Subject NameÂ å’ŒÂ Public KeyÂ èƒ½å¤ æ»¿è¶³åŒ¹é…å’Œé©—è­‰æ¢ä»¶å³å¯ã€‚å› æ­¤ï¼Œå¯¦éš›ä¸Šï¼Œåƒ Let\u0026rsquo;s Encrypt é€™æ¨£çš„æ†‘è­‰ç°½ç™¼æ©Ÿæ§‹æœƒæº–å‚™å…©å¼µï¼ˆæˆ–æ›´å¤šï¼‰å…§å®¹ç›¸åŒä½†ç”±ä¸åŒæ ¹ CA ç°½ç½²çš„ä¸­ç¹¼æ†‘è­‰ã€‚\nä¾‹å¦‚ï¼ŒLet\u0026rsquo;s Encrypt æœƒå°‡ä¸€ä»½ CSR åˆ†åˆ¥æäº¤çµ¦ ISRGï¼ˆå…¶è‡ªèº«çš„æ ¹ CAï¼‰å’Œ DST Root CA X3ï¼ˆä¸€å€‹è¼ƒæ—©ä¸”å»£æ³›ä¿¡ä»»çš„æ ¹ CAï¼‰é€²è¡Œç°½ç½²ã€‚ç”±æ–¼ç°½ç½²éç¨‹æ˜¯ä½¿ç”¨é€™å…©å€‹æ ¹ CA å„è‡ªçš„ç§æœ‰é‡‘é‘°é€²è¡Œçš„ï¼Œæ‰€ä»¥æœ€çµ‚ç”Ÿæˆçš„ä¸­ç¹¼æ†‘è­‰ï¼ˆä¾‹å¦‚ï¼Œä¸­ç¹¼æ†‘è­‰ A å’Œä¸­ç¹¼æ†‘è­‰ Bï¼‰é›–ç„¶å…¶Â Subject NameÂ ç›¸åŒï¼Œä½†å…¶å…§éƒ¨åŒ…å«çš„Â Signature ValueÂ æ•¸å€¼æœƒä¸åŒã€‚\né€™æ¨£ä¸€ä¾†ï¼Œå°±æœƒå­˜åœ¨å…©æ¢å¯é©—è­‰çš„æ†‘è­‰éˆï¼š\néˆä¸€ï¼šå¾ ISRG æ ¹æ†‘è­‰ -\u0026gt; ä¸­ç¹¼æ†‘è­‰ A -\u0026gt; çµ‚ç«¯æ†‘è­‰ã€‚\néˆäºŒï¼šå¾ DST Root CA X3 æ ¹æ†‘è­‰ -\u0026gt; ä¸­ç¹¼æ†‘è­‰ B -\u0026gt; çµ‚ç«¯æ†‘è­‰ã€‚\nç€è¦½å™¨æˆ–ä½œæ¥­ç³»çµ±åªéœ€è¦ä¿¡ä»»å…¶ä¸­ä¸€å¼µæ ¹ CA æ†‘è­‰ï¼ˆç„¡è«–æ˜¯ ISRG æˆ– DST Root CA X3ï¼‰ï¼Œå°±å¯ä»¥æˆåŠŸå®Œæˆçµ‚ç«¯æ†‘è­‰çš„é©—è­‰ã€‚é€™ç¨®è¨­è¨ˆæä¾›äº†æ¥µå¤§çš„å½ˆæ€§èˆ‡å…¼å®¹æ€§ï¼Œå°¤å…¶å°æ–¼ç¢ºä¿èˆŠæœ‰ç³»çµ±ä¹Ÿèƒ½ä¿¡ä»»æ–°ç°½ç™¼çš„æ†‘è­‰è‡³é—œé‡è¦ã€‚\næ†‘è­‰åŠéŠ·æ©Ÿåˆ¶ï¼š # åŸºæ–¼æ†‘è­‰éˆçš„ä¿¡ä»»æ©Ÿåˆ¶ï¼Œæˆ‘å€‘ç™¼ç¾ä¸Šå±¤ CA æ©Ÿæ§‹ä¸¦æ²’æœ‰ç›´æ¥æ’¤å›å·²ç°½ç™¼æ†‘è­‰çš„èƒ½åŠ›ï¼Œåªèƒ½ç­‰å¾…æ†‘è­‰è‡ªç„¶éæœŸã€‚ç„¶è€Œï¼Œåœ¨æ†‘è­‰ç§æœ‰é‡‘é‘°æ´©æ¼ã€CA æ©Ÿæ§‹å—ææˆ–æ†‘è­‰è³‡è¨ŠéŒ¯èª¤ç­‰ç·Šæ€¥æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘éœ€è¦ä¸€ç¨®æ©Ÿåˆ¶èƒ½å¤ ç«‹å³æ’¤éŠ·æ†‘è­‰çš„æœ‰æ•ˆæ€§ã€‚ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼ŒX.509 æä¾›äº†å…©ç¨®ä¸»è¦çš„æ†‘è­‰åŠéŠ·æ©Ÿåˆ¶ï¼šæ†‘è­‰æ’¤éŠ·åˆ—è¡¨ (Certificate Revocation List, CRL)Â å’ŒÂ ç·šä¸Šæ†‘è­‰ç‹€æ…‹å”å®š (Online Certificate Status Protocol, OCSP)ã€‚\næ†‘è­‰æ’¤éŠ·åˆ—è¡¨ (Certificate Revocation List, CRL)ï¼š\nCA æœƒå®šæœŸç™¼å¸ƒä¸€å€‹åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰å·²è¢«å…¶æ’¤éŠ·çš„æ†‘è­‰ Serial Numberã€‚ç”¨æˆ¶ç«¯å¯ä»¥ä¸‹è¼‰é€™å€‹åˆ—è¡¨ï¼Œä¸¦åœ¨é©—è­‰æ†‘è­‰æ™‚æª¢æŸ¥ç›®æ¨™æ†‘è­‰çš„ Serial Number æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ã€‚\nX.509 æ†‘è­‰ä¸­é€šå¸¸åŒ…å«ä¸€å€‹Â CRL Distribution PointsÂ æ“´å±•ï¼Œå®ƒæœƒå‘Šè¨´ç”¨æˆ¶ç«¯è©²å»å“ªè£¡æ‰¾åˆ°å¯èƒ½åŒ…å«ç›®æ¨™æ†‘è­‰çš„ CRL åˆ—è¡¨ã€‚\nç·šä¸Šæ†‘è­‰ç‹€æ…‹å”å®š (Online Certificate Status Protocol, OCSP)ï¼š\nç›¸è¼ƒæ–¼ CRLï¼ŒOCSP æä¾›äº†ä¸€ç¨®æ›´å³æ™‚çš„æ†‘è­‰ç‹€æ…‹æŸ¥è©¢æ–¹å¼ã€‚ç”¨æˆ¶ç«¯æœƒå‘ OCSP ä¼ºæœå™¨ç™¼é€æŸ¥è©¢ï¼Œè©¢å•ç‰¹å®šæ†‘è­‰çš„æ’¤éŠ·ç‹€æ…‹ï¼ˆæœ‰æ•ˆã€å·²æ’¤éŠ·æˆ–æœªçŸ¥ï¼‰ã€‚\nç”±æ–¼ CRL å¯èƒ½å­˜åœ¨æ»¯å¾Œæ€§ä¸”å¤§å‹ CRL åˆ—è¡¨æœƒæ¶ˆè€—è¼ƒå¤šé »å¯¬ï¼Œç€è¦½å™¨é€šå¸¸æœƒå„ªå…ˆä½¿ç”¨ OCSP é€²è¡Œæ†‘è­‰ç‹€æ…‹æª¢æŸ¥ã€‚OCSP ä¼ºæœå™¨çš„ä½å€åŒæ¨£å¯ä»¥é€éæ†‘è­‰çš„ AIA æ“´å±•ç²å¾—ã€‚\næ†‘è­‰çš„ç°½ç™¼ï¼šå¾è«‹æ±‚åˆ°ç”Ÿæˆ # äº†è§£äº†æ†‘è­‰çš„çµæ§‹å’Œé©—è­‰æ©Ÿåˆ¶å¾Œï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹æ†‘è­‰æ˜¯å¦‚ä½•è¢«ç°½ç™¼çš„ã€‚æ•´å€‹æµç¨‹é€šå¸¸å§‹æ–¼ç”³è«‹äººç”Ÿæˆä¸€å€‹Â æ†‘è­‰ç°½ç½²è«‹æ±‚ (Certificate Signing Request, CSR)ã€‚\nCSR é€šå¸¸åŸºæ–¼Â PKCS#10 (RFC 2986)Â æ ¼å¼ï¼Œé€™åŒæ¨£æ˜¯ä¸€å€‹é€é ASN.1 å®šç¾©çš„è³‡æ–™çµæ§‹ï¼Œä¸¦å¸¸ä½¿ç”¨Â .csrä½œç‚ºå‰¯æª”åã€‚CSR ä¸­åŒ…å«äº†æ†‘è­‰æ‰€éœ€çš„å„ç¨®è³‡è¨Šï¼Œä¾‹å¦‚æ†‘è­‰çš„ä¸»é«” (Subject)ã€ç”³è«‹è€…çš„å…¬é–‹é‡‘é‘°è³‡è¨Š (subjectPublicKeyInfo) ç­‰ã€‚\né€éÂ openssl req -newkey rsa:2048 -nodes -keyout domain.key -out domain.csrÂ é€™æ¨£çš„å‘½ä»¤ï¼Œå¯ä»¥åŒæ™‚å®Œæˆç§æœ‰é‡‘é‘° (domain.key) å’Œ CSR (domain.csr) çš„ç”Ÿæˆã€‚\nç”± OpenSSL ç”¢ç”Ÿçš„Â .csrÂ æª”æ¡ˆé€šå¸¸ä¹Ÿæ˜¯ PEM æ ¼å¼çš„ï¼ˆå³ DER ç·¨ç¢¼å¾Œå†é€²è¡Œ Base64 ç·¨ç¢¼ï¼‰ï¼Œå…¶å…§å®¹æœƒè¢«Â -----BEGIN CERTIFICATE REQUEST-----Â å’ŒÂ -----END CERTIFICATE REQUEST-----Â å€å¡ŠåŒ…åœã€‚\n-----BEGIN CERTIFICATE REQUEST----- MIICijCCAXICAQAwRTELMAkGA1UEBhMCQVUxE ... -----END CERTIFICATE REQUEST----- æ­¤å¤–ï¼Œç§æœ‰é‡‘é‘°æª”æ¡ˆé€šå¸¸éµå¾ªÂ PKCS#8 (RFC 5208)Â æ¨™æº–ã€‚\n-----BEGIN PRIVATE KEY----- ... -----END PRIVATE KEY----- ç•¶ CSR è¢«æäº¤çµ¦ CA å¾Œï¼ŒCA æœƒé©—è­‰ç”³è«‹è€…çš„èº«ä»½ï¼Œç„¶å¾Œä½¿ç”¨å…¶ç§æœ‰é‡‘é‘°å° CSR ä¸­çš„è³‡è¨Šï¼ˆç‰¹åˆ¥æ˜¯ç”³è«‹è€…çš„å…¬é–‹é‡‘é‘°å’Œæ†‘è­‰ä¸»é«”è³‡è¨Šï¼‰é€²è¡Œæ•¸ä½ç°½ç« ï¼Œæœ€çµ‚å½¢æˆä¸€å€‹å®Œæ•´çš„æ†‘è­‰ã€‚é€™å€‹ç°½ç™¼å®Œæˆçš„æ†‘è­‰é€šå¸¸æœƒä»¥Â .crtÂ æˆ–Â .cerÂ ä½œç‚ºå‰¯æª”åï¼Œå„˜ç®¡å®ƒå€‘çš„å…§å®¹é€šå¸¸æ˜¯ PEM æ ¼å¼çš„ X.509 æ†‘è­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯æœªç¶“ Base64 ç·¨ç¢¼çš„ DER æ ¼å¼ã€‚æœ‰æ™‚ï¼Œ.caÂ å‰¯æª”åæœƒç”¨æ–¼ä»£è¡¨ä¸­ç¹¼æˆ–æ ¹æ†‘è­‰ï¼Œä½†å…¶å…§å®¹é€šå¸¸ä¹Ÿæ˜¯ PEM æ ¼å¼çš„ X.509 æ†‘è­‰ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸Šè¿°æåˆ°çš„Â PKCS#1ã€PKCS#8ã€PKCS#10Â éƒ½æ˜¯Â **Public Key Cryptography Standards (PKCS)**æ¨™æº–çš„ä¸€éƒ¨åˆ†ï¼Œé€™äº›æ¨™æº–ç”± RSA Security LLC åˆ¶å®šï¼Œæ—¨åœ¨è¦ç¯„å…¬é–‹é‡‘é‘°å¯†ç¢¼å­¸çš„å„ç¨®å¯¦è¸ã€‚å…¶ä»–é‡è¦çš„ PKCS æ¨™æº–é‚„åŒ…æ‹¬ï¼š\nPKCS#12ï¼šç”¨æ–¼å°‡æ†‘è­‰ï¼ˆ.crtï¼‰å’Œå…¶å°æ‡‰çš„ç§æœ‰é‡‘é‘°ï¼ˆ.keyï¼‰å°è£åˆ°ä¸€å€‹å–®ä¸€æª”æ¡ˆä¸­ï¼Œé€šå¸¸ä½¿ç”¨Â *.pfxæˆ–Â *.p12Â å‰¯æª”åï¼Œæ–¹ä¾¿æ”œå¸¶å’Œéƒ¨ç½²ã€‚\nPKCS#7ï¼šç”¨æ–¼åŠ å¯†ã€ç°½ç« å’Œå‚³è¼¸è³‡æ–™ã€‚CA æœ‰æ™‚æœƒä½¿ç”¨ PKCS#7 å°‡ä¸­ç¹¼æ†‘è­‰å’Œç°½ç½²å¾Œçš„ç›®æ¨™æ†‘è­‰æ‰“åŒ…æˆÂ .p7bÂ æˆ–Â .p7cÂ æª”æ¡ˆäº¤ä»˜çµ¦ç”³è«‹è€…ã€‚\næ†‘è­‰ï¼ŒTLS é€£ç·šèˆ‡ Domain Nameï¼š # ç•¶æˆ‘å€‘é€éç€è¦½å™¨è¨ªå•ä¸€å€‹ç¶²åŸŸä¸¦å»ºç«‹ TLS é€£ç·šæ™‚ï¼Œç¢ºä¿æ†‘è­‰çš„åˆæ³•æ€§è‡³é—œé‡è¦ã€‚é‚£éº¼ï¼Œç¶²åŸŸåç¨±æ˜¯å¦‚ä½•èˆ‡æ†‘è­‰é—œè¯èµ·ä¾†çš„å‘¢ï¼Ÿ\næ—©æœŸï¼Œæ†‘è­‰ä¸»è¦é€éÂ subjectÂ æ¬„ä½ä¸­çš„Â Common Name (CN)Â ä¾†å°æ‡‰ç¶²åŸŸã€‚ä¾‹å¦‚ï¼Œå¦‚æœÂ github.comÂ çš„æ†‘è­‰Â subjectÂ æ˜¯Â CN=github.comï¼Œé‚£éº¼é€™å€‹æ†‘è­‰å°±å¯ä»¥ç”¨ä¾†é©—è­‰è©²ç¶²åŸŸçš„æœ‰æ•ˆæ€§ã€‚\nç„¶è€Œï¼Œä½¿ç”¨ CN çš„å•é¡Œåœ¨æ–¼å®ƒåªèƒ½æ¨™è¨˜ä¸€å€‹ç¶²åŸŸåç¨±ï¼Œä¸¦ä¸”åœ¨æ ¼å¼ä¸Šå­˜åœ¨ä¸€å®šçš„é™åˆ¶ã€‚ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼ŒX.509 v3 å¼•å…¥äº†Â Subject Alternative Name (SAN) æ“´å±•ã€‚é€éÂ subjectAltNameÂ æ¬„ä½ï¼Œæ†‘è­‰å¯ä»¥æ¨™è¨˜å¤šå€‹ç¶²åŸŸåç¨±ï¼Œä¹Ÿæ”¯æ´é›»å­éƒµä»¶åœ°å€ã€IP ä½å€ã€URI ç­‰å¤šç¨®æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œgithub.comÂ çš„æ†‘è­‰åœ¨Â subjectAltNameÂ ä¸­å¯èƒ½åŒæ™‚æ¨™è¨»äº†Â github.comÂ å’ŒÂ www.github.comï¼Œé€™ä½¿å¾—è©²æ†‘è­‰èƒ½å¤ åŒæ™‚é©—è­‰é€™å…©å€‹ç¶²åŸŸçš„æœ‰æ•ˆæ€§ã€‚SAN æ“´å±•æ¥µå¤§åœ°æå‡äº†æ†‘è­‰çš„éˆæ´»æ€§å’Œå¯¦ç”¨æ€§ã€‚\næ­¤å¤–ï¼Œé›–ç„¶ RFC 5280 ä¸¦æœªæ˜ç¢ºå®šç¾©è¬ç”¨å­—å…ƒï¼ˆwildcardï¼‰çš„ä½¿ç”¨ï¼Œä½†åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘é€šå¸¸å¯ä»¥ä½¿ç”¨Â *.xxxx.xxxÂ é€™æ¨£çš„æ ¼å¼ä¾†ä»£è¡¨æ‰€æœ‰å­ç¶²åŸŸï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„è¬ç”¨å­—å…ƒæ†‘è­‰ (Wildcard Certificate)ã€‚\nå…¶ä»–é‡è¦çš„æ†‘è­‰æ“´å±• # é™¤äº†ä¸Šè¿°æåˆ°çš„æ“´å±•å¤–ï¼ŒX.509 æ†‘è­‰é‚„åŒ…å«è¨±å¤šå…¶ä»–é‡è¦çš„æ“´å±•ï¼Œå®ƒå€‘å®šç¾©äº†æ†‘è­‰çš„è¡Œç‚ºå’Œç´„æŸï¼š\nBasic Constraints Extensionï¼šé€™å€‹æ“´å±•é€éÂ cAÂ (boolean) æ¬„ä½ä¾†æ§åˆ¶æ†‘è­‰æ˜¯å¦èƒ½å¤ ä½œç‚º CA æ†‘è­‰ï¼Œå³æ˜¯å¦èƒ½å¤ ç°½ç™¼ä¸‹ä¸€å±¤æ†‘è­‰ã€‚å¦‚æœÂ cAÂ ç‚ºÂ TRUEï¼Œå‰‡è©²æ†‘è­‰æ˜¯ä¸€å€‹ CA æ†‘è­‰ï¼›å¦‚æœç‚ºÂ FALSEï¼Œå‰‡å®ƒæ˜¯ä¸€å€‹å¯¦é«”æ†‘è­‰ï¼Œä¸èƒ½ç”¨æ–¼ç°½ç™¼å…¶ä»–æ†‘è­‰ã€‚\nName Constraints Extensionï¼šé€™å€‹æ“´å±•é€šå¸¸å‡ºç¾åœ¨ CA æ†‘è­‰ä¸­ï¼Œå®ƒå¯ä»¥é™åˆ¶è©² CA æ†‘è­‰èƒ½å¤ ç°½ç™¼çš„ä¸‹ä¸€å±¤æ†‘è­‰å¿…é ˆå±¬æ–¼ç‰¹å®šçš„ç¶²åŸŸæˆ– IP ç¯„åœã€‚é€™å°æ–¼å»ºç«‹æ›´ç²¾ç´°çš„ä¿¡ä»»ç­–ç•¥å’Œé˜²æ­¢ CA èª¤ç™¼æ†‘è­‰éå¸¸æœ‰ç”¨ã€‚\nKey Usage Extensionï¼šé€™å€‹æ“´å±•å®šç¾©äº†æ†‘è­‰ä¸­å…¬é–‹é‡‘é‘°çš„ç‰¹å®šç”¨é€”ï¼Œä¾‹å¦‚ç”¨æ–¼æ•¸ä½ç°½ç« ã€é‡‘é‘°åŠ å¯†ã€æ†‘è­‰ç°½ç« ç­‰ã€‚\nExtended Key Usage Extensionï¼šé€™å€‹æ“´å±•é€²ä¸€æ­¥å®šç¾©äº†æ†‘è­‰çš„ç‰¹å®šæ‡‰ç”¨ç¨‹å¼ç”¨é€”ï¼Œä¾‹å¦‚ç”¨æ–¼ä¼ºæœå™¨èªè­‰ (TLS/SSL ä¼ºæœå™¨)ã€å®¢æˆ¶ç«¯èªè­‰ (TLS/SSL å®¢æˆ¶ç«¯)ã€ç¨‹å¼ç¢¼ç°½ç« ç­‰ã€‚\nè‡ªç°½æ†‘è­‰ (Self-Signed Certificates) # æ ¹æ†‘è­‰æœ¬è³ªä¸Šæ˜¯ä¸€ç¨®è‡ªç°½æ†‘è­‰ã€‚è‡ªç°½æ†‘è­‰æ˜¯ç”±å…¶è‡ªèº«ç§æœ‰é‡‘é‘°ç°½ç½²çš„æ†‘è­‰ï¼Œé€™æ„å‘³è‘—å®ƒçš„Â IssuerÂ å’ŒÂ Subjectæ¬„ä½æ˜¯ç›¸åŒçš„ã€‚ æ†‘è­‰å®‰å…¨æ©Ÿåˆ¶ï¼šæ†‘è­‰å›ºå®šèˆ‡æ†‘è­‰é€æ˜åº¦ # ç‚ºäº†é€²ä¸€æ­¥å¢å¼·æ†‘è­‰çš„å®‰å…¨æ€§ï¼Œæ¥­ç•Œé‚„ç™¼å±•å‡ºäº†ä¸€äº›æ›´é«˜ç´šçš„æ©Ÿåˆ¶ï¼š\næ†‘è­‰å›ºå®š ( Certificate Pinning )ï¼šé€™æ˜¯ä¸€ç¨®å®‰å…¨æ©Ÿåˆ¶ï¼Œæ‡‰ç”¨ç¨‹å¼ï¼ˆä¾‹å¦‚è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ï¼‰æœƒé å…ˆã€Œè¨˜ä½ã€æˆ–ã€Œå›ºå®šã€å…¶é æœŸä¼ºæœå™¨æ†‘è­‰çš„å…¬é–‹é‡‘é‘°æˆ–å…¶é›œæ¹Šå€¼ã€‚ç•¶æ‡‰ç”¨ç¨‹å¼é€£æ¥åˆ°ä¼ºæœå™¨æ™‚ï¼Œå®ƒä¸åƒ…æœƒé©—è­‰æ†‘è­‰éˆï¼Œé‚„æœƒæª¢æŸ¥ä¼ºæœå™¨æä¾›çš„æ†‘è­‰æ˜¯å¦èˆ‡å…¶é å…ˆå›ºå®šçš„é‡‘é‘°åŒ¹é…ã€‚å¦‚æœæ†‘è­‰éˆæœ‰æ•ˆä½†é‡‘é‘°ä¸åŒ¹é…ï¼Œé€£ç·šå°‡è¢«æ‹’çµ•ã€‚é€™æœ‰åŠ©æ–¼é˜²ç¯„æƒ¡æ„çš„ä¸­ç¹¼æ†‘è­‰æ”»æ“Šã€‚\næ†‘è­‰é€æ˜åº¦ (Certificate Transparency, CT)ï¼šCT æ˜¯ä¸€ç¨®å…¬é–‹æ—¥èªŒç³»çµ±ï¼Œè¦æ±‚æ‰€æœ‰æ–°ç°½ç™¼çš„æ†‘è­‰éƒ½å¿…é ˆè¢«è¨˜éŒ„åœ¨å…¬é–‹å¯å¯©è¨ˆçš„æ—¥èªŒä¸­ã€‚ç€è¦½å™¨å’Œå…¶ä»–ç”¨æˆ¶ç«¯å¯ä»¥æª¢æŸ¥é€™äº›æ—¥èªŒï¼Œä»¥ç¢ºä¿å…¶æ‰€ä¿¡ä»»çš„ CA æ²’æœ‰éŒ¯èª¤åœ°æˆ–æƒ¡æ„åœ°ç°½ç™¼æ†‘è­‰ã€‚é€™å¢åŠ äº†æ†‘è­‰ç°½ç™¼éç¨‹çš„é€æ˜åº¦ï¼Œæœ‰åŠ©æ–¼åŠæ—©ç™¼ç¾å’Œç³¾æ­£å•é¡Œæ†‘è­‰ã€‚\nçµèª # å¾åº•å±¤çš„ ASN.1 ç·¨ç¢¼èˆ‡ PEM/DER æ ¼å¼ï¼Œåˆ° X.509 æ¨™æº–å®šç¾©çš„æ†‘è­‰çµæ§‹ï¼Œä»¥åŠé—œéµçš„æ†‘è­‰éˆé©—è­‰ã€åŠéŠ·æ©Ÿåˆ¶ï¼Œä¹ƒè‡³æ–¼æ†‘è­‰ç°½ç™¼çš„æµç¨‹èˆ‡å„ç¨®æ“´å±•ï¼Œé€™äº›çŸ¥è­˜å°æ–¼ä»»ä½•æ¶‰åŠç¶²è·¯å®‰å…¨ã€ç³»çµ±ç®¡ç†æˆ–è»Ÿé«”é–‹ç™¼çš„å·¥ç¨‹å¸«éƒ½è‡³é—œé‡è¦ã€‚æŒæ¡é€™äº›æŠ€è¡“ç´°ç¯€ï¼Œä¸åƒ…èƒ½æ›´å¥½åœ°æ’æŸ¥å•é¡Œã€è¨­è¨ˆæ›´å®‰å…¨çš„ç³»çµ±ï¼Œä¹Ÿèƒ½åœ¨é¢å°è¤‡é›œçš„æ†‘è­‰è­°é¡Œæ™‚ï¼Œå…·å‚™æ›´å¼·çš„åˆ†æèˆ‡è§£æ±ºèƒ½åŠ›ã€‚\n","date":"May 22 2025","externalUrl":null,"permalink":"/posts/understanding-digital-certificates-formats-signatures-and-verification/","section":"æ–‡ç« ","summary":"","title":"ææ‡‚æ•¸ä½æ†‘è­‰ï¼šæª”æ¡ˆæ ¼å¼ã€ç°½ç½²èˆ‡é©—è­‰æµç¨‹","type":"posts"},{"content":"","date":"May 22 2025","externalUrl":null,"permalink":"/tags/%E6%86%91%E8%AD%89/","section":"æ¨™ç±¤","summary":"","title":"æ†‘è­‰","type":"tags"},{"content":"","date":"April 7 2025","externalUrl":null,"permalink":"/tags/%E7%94%9F%E6%B4%BB%E7%B6%93%E6%AD%B7/","section":"æ¨™ç±¤","summary":"","title":"ç”Ÿæ´»ç¶“æ­·","type":"tags"},{"content":"","date":"April 7 2025","externalUrl":null,"permalink":"/categories/%E7%94%9F%E6%B4%BB%E7%B6%93%E6%AD%B7/","section":"åˆ†é¡","summary":"","title":"ç”Ÿæ´»ç¶“æ­·","type":"categories"},{"content":"","date":"April 7 2025","externalUrl":null,"permalink":"/tags/%E9%9D%9E%E6%8A%80%E8%A1%93/","section":"æ¨™ç±¤","summary":"","title":"éæŠ€è¡“","type":"tags"},{"content":"é€™ç¯‡æ˜¯æˆ‘åœ¨ 2025/3/13 ~ 2025/4/3 æœŸé–“æœå½¹ç ”ç™¼æ›¿ä»£å½¹ 127 æ¢¯æ¬¡ (æ›¿ä»£å½¹ 263 æ¢¯æ¬¡) ç¬¬ä¹ä¸­éšŠçš„å¿ƒå¾—åŠæ•´ç†ï¼Œå¸Œæœ›èƒ½å¤ å¹«åŠ©åˆ°ä¸€äº›æœªä¾†è¦é€²ä¾†çš„æœ‹å‹å€‘ã€‚\næ¯”è¼ƒè©³ç´°çš„å¿ƒå¾—ã€æœ‰è¶£ã€å¥‡æ€ªçš„äº‹æƒ…ï¼Œå¯ä»¥åƒè€ƒåŒæ¢¯çš„æ–‡ç« ï¼Œé€™é‚Šåªæœƒè¬›ä¸€äº›æˆ‘è¦ºå¾—é‡è¦ï¼Œå°é€²å»æœ‰å¹«åŠ©çš„äº‹é …ã€‚\næ”œå¸¶æ¸…å–® # ä¸€åŒ…è¡›ç”Ÿç´™ï¼šå¯ä»¥ç¬¬ä¸€å¤©å»æ´ K è²·\nåˆ®é¬åˆ€ï¼šå»ºè­°å¸¶è‡ªå·±çš„ï¼Œæ´ K è²·çš„å¾ˆçˆ›ï¼Œæˆ–è‘—æˆ‘ä¸æœƒç”¨ä¸€èˆ¬çš„åˆ®é¬åˆ€ï¼Œå¯ä»¥å¸¶é›»å‹•çš„ï¼Œåªæ˜¯ä¸èƒ½å……é›»\næŒ‡ç”²åˆ€ï¼šè¦æœ‰æ”¶é›†ç›’çš„ï¼Œå¯ä»¥ç¬¬ä¸€å¤©å»æ´ K è²·\næ¿•ç´™å·¾ã€ç‰™ç·šã€é˜²èšŠæ¶²ã€è­·æ‰‹éœœï¼šæˆ‘å€‹äººéœ€è¦çš„æ±è¥¿ï¼Œæ‰‹ä¸çŸ¥åˆ°ç‚ºå•¥è¶…ç´šä¹¾çš„\nå¥‡ç•°ç­†ï¼šæ˜¯é•ç¦å“ï¼Œä½†ç¬¬ä¸€å¤©æœƒç”¨ä¾†åœ¨è¢‹å­ä¸Šé¢å¯«å­—ï¼Œå¯«å®Œå†è¢«æ”¶åˆ°é•ç¦å“è¢‹å­è£¡é¢ã€‚é•ç¦å“æ”¾å‡é›¢é–‹å‰æœƒé‚„ä½ \næ‰‹éŒ¶ï¼šå°ä¸­é€™æ¬¡å…¬æ‰€æœ‰ç™¼ï¼Œè¦çœ‹ä¸€ä¸‹å¾µé›†ä»¤é™„çš„æ–‡ä»¶æœ‰æ²’æœ‰æåˆ°æœƒé€ï¼Œå…¶ä»–åœ°æ–¹å°±è¦è‡ªå·±å¸¶äº†\nå¸½å­ï¼šè‡ªå·±çš„å¸½å­æ˜¯å‡ºä¾†å¾Œè¦å¸¶çš„ï¼Œåœ¨è£¡é¢æ˜¯å¸¶éƒ¨éšŠçš„å¸½å­\nä¸€æ®µæ³¡æ£‰è† ã€ä¸€äº›å°çš„é•·å°¾å¤¾ï¼šæœ‰äº›äººå»ºè­°å¯ä»¥å¸¶ä¾†æ•´ç†å…§å‹™ï¼Œæˆ‘å€‹äººèªç‚ºç´™æ¿å°±å¤ ç”¨çš„\nå¾ˆå¤šå–‰ç³–ï¼Œäº¬éƒ½å¿µæ…ˆé‚£ç¨®çš„è©±ï¼Œå»ºè­°å¯ä»¥å¸¶å€‹ä¸‰åˆ°å››ç›’ï¼Œç¬¬ä¸€å¤©å»æ´ K è²·ä¹Ÿè¡Œã€‚é™¤äº†ç·´æ›¿æ­Œå¯ä»¥åƒï¼Œæ¯å¤©ç„¡èŠä¹Ÿæœƒæƒ³æ‹¿ä¾†åƒï¼Œä¹Ÿå¯ä»¥æ‹¿ä¾†ç•¶ç©å…·ï¼Œå¾ˆæœ‰ç”¨ã€‚\nè¢–çåŒ…çš„è¡›ç”Ÿç´™ï¼šæ—¥å¸¸ä½¿ç”¨\nå¨›æ¨‚ç´™å¼µå€‘ï¼šç©ºç™½ç´™å¯«æ—¥è¨˜ã€å°èªªã€æ•¸ç¨ã€paper?ã€æˆ–ä»»ä½•æ±è¥¿ï¼Œè¨˜å¾—åªèƒ½å¸¶æ•£è£çš„ï¼Œå¸¶æ›¸çš„è©±ï¼Œé™¤éæŠŠå®ƒæ‹†æˆæ•£è£ï¼Œä¸ç„¶æ˜¯é•ç¦å“ï¼Œæ­é… 1~2 å€‹è³‡æ–™å¤¾ï¼Œæ–¹ä¾¿æ”¶ç´ï¼Œé‚„æœ‰å¥½å¯«çš„åŸå­ç­†ã€‚\nä¸€å®šè¦å¸¶çš„æ±è¥¿ï¼šå¾µé›†ä»¤ã€èº«åˆ†è­‰ã€å¥ä¿å¡ã€éƒµå±€å¸³æˆ¶å½±æœ¬ã€ç•¢æ¥­è­‰æ›¸å½±æœ¬ã€æŠ˜æŠµçš„æ–‡ä»¶ï¼Œçœ‹å…¬æ‰€æ–‡ä»¶å†ç¢ºèªä¸€ä¸‹é‚„å·®å•¥\néŒ¢ï¼š3 åƒè¶³å¤ äº†ï¼Œå»ºè­°ä¸€éƒ¨åˆ†æ›æˆç™¾æŠ„ï¼Œä¸­é–“å¦‚æœæœ‰æ©Ÿæœƒå¯ä»¥è²·åƒåƒå–å–çš„æœƒæ¯”è¼ƒæ–¹ä¾¿ã€‚\nç›¥æ´—ç”¨å“ï¼šç‰™è†ã€ç‰™åˆ·ã€ä¸‰åˆä¸€\nå€‹äººè—¥å“\nå¸¶ææŠŠçš„å¡‘è† è¢‹ï¼šå…¶åŠŸä¸€å€‹æ˜¯æ‹¿ä¾†æ”¾ç¬¬ä¸€å¤©çš„é«’è¡£æœï¼Œé€™å€‹ç”¨åƒåœ¾è¢‹ä¹Ÿè¡Œã€‚é€²å»ä¹‹å¾Œï¼Œé•ç¦å“ã€è²´é‡ç‰©å“ã€è—¥å“æœƒåˆ†æˆä¸‰å€‹è¢‹å­è£ï¼Œç„¶å¾Œçµ±ä¸€æ”¶èµ·ä¾†ä¿ç®¡ï¼Œæ‰éœ€è¦ç°½å­—ç­†ä¾†å¯«åå­ï¼Œæ²’è¢‹å­ç¬¬ä¸€å¤©æœƒå»æ´ K æ‹¿ï¼Œæ‰€ä»¥ä¹Ÿé‚„å¥½ï¼Œä½†ç”¨è‡ªå·±çš„è¢‹å­åœ¨æ‰¾è¢‹å­çš„æ™‚å€™è¾¨è­˜åº¦å°±å¾ˆé«˜ï¼Œä¸ç„¶å…¨éƒ¨å †åœ¨ä¸€èµ·é‚„è¦ç¿»æ‰¾ã€‚\nä¸è¦å¸¶è‡ªå·±çš„å…§è¡£è¤²ã€è¥ªå­ã€é›¨è¡£ã€å£ç½©ã€æ°´å£ºã€è—ç™½è„«ï¼Œå› ç‚ºä½ åªèƒ½ç”¨æˆåŠŸå¶ºç™¼çš„ï¼Œè—ç™½æ‹–æœ‰æ¬¾å¼å•é¡Œï¼Œé€²å»åœ¨æ´ K è²·\næ´ K (OK ä¾¿åˆ©å•†åº—) è¦è²·çš„æ±è¥¿ # ä¸€åŒ…è¡›ç”Ÿç´™ (é€£åŒè‡ªå·±å¸¶çš„ï¼Œç¸½å…±å…©åŒ…ï¼Œæª¢æŸ¥ç”¨ï¼Œé›–ç„¶åªå¸¶ä¸€åŒ…ç†è«–ä¸Šä¹Ÿè¡Œï¼Œå¯æ˜¯é€™æ¨£æ¯”è¼ƒçœäº‹) è—ç™½æ‹– é¡å¤– 1 ~ 2 ä»¶å…§è¤²ï¼šæœ‰äººèªªå…¬ç™¼çš„ä¸å¥½ç©¿ï¼Œæˆ‘æ˜¯æ¹Šåˆè‘—å°ˆ å…§è¡£ã€å…§è¤²ã€è¥ªå­åŸºæœ¬ä¸Šè²·äº†å°±æ˜¯ç•¶å‚™ç”¨ï¼Œé¿å…å‡ºå•é¡Œã€‚ä½†ç†è«–ä¸Šæ˜¯å®Œå…¨ä¸æœƒéœ€è¦è²·ï¼Œä¹Ÿå¯ä»¥æ´»å¾—å¥½å¥½çš„ï¼Œé™¤éä½ å¼„ä¸Ÿæˆ–è¢«å·èµ°â€¦.ï¼Œå»ºè­°æ˜¯æœ€å¤šè²·ä¸€å¥—å‚™ç”¨ï¼Œä¸ç„¶æ”¶ç´ä¸æ–¹ä¾¿ï¼Œä¹Ÿæµªè²»ã€‚åˆæˆ–è‘—ä½ æƒ³æŠŠä»–ç•¶æˆæ¶ˆè€—å“çš„è©±ï¼Œé‚£ä¹Ÿå¯ä»¥å¤šå¸¶å¹¾å¥—ï¼Œç©¿å¹¾æ¬¡å°±ç›´æ¥ä¸Ÿæ‰ã€‚ ä¸è¦è²·é‹¼ç›”æµ·ç¶¿å¢Šï¼šç†è«–ä¸Šæ˜¯æ‰“é¶ç”¨çš„ï¼Œä½†æ˜¯æ²’æœ‰å®Œå…¨æ²’æœ‰ä»»ä½•å•é¡Œ ç”Ÿæ´»èªªæ˜ # ç¸½é«”ä¾†èªªæ¯å¤©çš„æµç¨‹å…¶å¯¦é‚„è »è¦å¾‹çš„ï¼Œ5 é»å·¦å³èµ·ä¾†æ•´ç†å…§å‹™ï¼Œ6 é»é›†åˆè·‘æ­¥ï¼Œåƒæ—©é¤ï¼Œä¸Šä¸€å€‹æ—©ä¸Šçš„èª²ï¼Œæ¥è‘—åƒåˆé¤ã€åˆä¼‘ï¼Œä¸Šä¸‹åˆçš„èª²ï¼Œç„¶å¾Œåƒæ™šé¤ï¼Œæ™šä¸Šæœ‰æ™‚å€™æœƒæœ‰æ´»å‹•æˆ–è‘—éƒ¨éšŠè¦å¡«è³‡æ–™ç™¼æ±è¥¿ï¼Œä¸­æœŸä¹‹å¾Œæ™šä¸Šè¦ç·´æ›¿æ­Œï¼Œæœ€å¾Œæ´—æ‰“ã€ç¡è¦ºï¼Œæ¯éš”å¹¾å¤©ç«™å€‹å¤œå“¨ (ä¸€å€‹å°æ™‚å·¦å³)ã€‚ä¸Šèª²æœ‰ä¸Šé‡è¦çš„æŠ€è¡“æ¯”å¦‚ EMT-1ï¼Œä¹Ÿæœ‰äº›å–®ç´”å°±æ˜¯è½æ³•è¦èªªæ˜ã€‚èªªå……å¯¦å—ï¼Œæ¯å¤©éƒ½æœ‰äº‹æƒ…è¦åšï¼Œä½†æ˜¯ä¹Ÿå¾ˆå¤šç„¡èŠç ´ç¢çš„ç©ºé–’æ™‚é–“ï¼Œéœ€è¦æƒ³è¾¦æ³•æ‰“ç™¼ã€‚æ¯”è¼ƒæœ‰è¶£çš„éƒ¨åˆ†å°æˆ‘ä¾†èªªå°±æ˜¯æˆé•·ç‡Ÿå’Œæ‰“é¶ã€‚æœ€æœ‰åƒ¹å€¼çš„å­¸ç¿’å°±æ˜¯ EMT-1 ç›¸é—œçš„æŠ€è¡“å’ŒçŸ¥è­˜ã€‚\næœƒæ¯”è¼ƒä¸é©æ‡‰çš„å¤§æ¦‚æœ‰å¹¾å€‹é»ï¼š\nä½œæ¯ï¼š5 é»èµ·åºŠï¼Œ22 é»ç¡è¦ºçš„ä½œæ¯ å…§å‹™æ•´ç†ï¼šå…§å‹™æ•´ç†å°±æ˜¯æ•´å€‹æ›¿ä»£å½¹æœŸé–“æœ€å›°é›£çš„æ±è¥¿ï¼Œæ¯å¤©éƒ½è¦æ•´ç†ï¼Œä¸€ä¸å°å¿ƒé‚„æœƒè¢«æ‰£åˆ†ï¼Œé‚„è¦ç‰¹åˆ¥ææ—©èµ·ä¾†æ‘¸é»‘æ•´ç†ã€‚è«‹è¨˜å¾—ä¸‹åˆ—äº‹é …ï¼Œä¸è¦è·Ÿæˆ‘ä¸€æ¨£è¢«æ‰£åˆ†äº†ï¼š æ£‰è¢«è¦æ•´å¹³ ç‰™è†æ˜¯å°å…¶ç‰™åˆ·çš„åº•æ“ºæ”¾ æ›é‹å‹•è¤²æ™‚ï¼Œç·šé ­ä¸è¦æ‰å‡ºä¾†ï¼Œæ²’å›ºå®šå¥½å¯èƒ½æœƒéš¨æ©Ÿåœ¨è‡ªå·±æ‰å‡ºä¾† æœ€é‚Šé‚Šçš„è¡£æ¶è«‹è²¼å…¶ç‰†å£ èšŠå¸³è¦éº»ç…©è‡¨å…µåˆä½œå¹«å¿™ï¼Œå¡ç´™æ¿çœŸçš„æ˜¯ç¥å™¨ è¡›ç”Ÿï¼šé›–ç„¶å…§è¡£è¤²æ¯å¤©éƒ½å¯ä»¥æ´—ï¼Œä½†å¤–è¡£é ‚å¤šä¸€å‘¨æ´—ä¸€æ¬¡ï¼Œæ¯›å·¾ä¸èƒ½é€æ´—ï¼Œå‰äººç•™ä¸‹ä¾†ä¸ä¸€å®šä¹¾æ·¨çš„åºŠçµ„ï¼Œå¾ˆé›£æ´—çš„é¤å…·ã€‚æ’éå»å°±æ²’äº‹äº†\u0026hellip; æ´—æ‰“ï¼šåªæœ‰æ´—æ‰“æ™‚é–“å¯ä»¥ç”¨æ‰‹æ©Ÿï¼Œæ´—æ‰“å°±æ˜¯æ´—æ¾¡åŠ æ‰“é›»è©±ï¼ŒçŸ­å¯èƒ½å°±åªæœ‰ 40 åˆ†é˜ï¼Œé•·é€šå¸¸ä¹Ÿé ‚å¤šä¸€å€‹å¤šå°æ™‚ï¼Œé‚„è¦æ’éšŠæ´—æ¾¡ï¼Œæ™‚é–“çœŸçš„æ˜¯ä¸å¤š éƒ¨éšŠç¿’æ…£ï¼šä¸€äº›éƒ¨éšŠæœƒæœ‰çš„ï¼Œæ¯”å¦‚ç²¾ç¥ç­”æ•¸ã€è½å£ä»¤å‹•ä½œå•¥çš„è¦çŸ©è¦é©æ‡‰ã€‚ é¤é»ï¼šåŸºæœ¬ä¸Šå°±æ˜¯æ¸›é…ç‰ˆçš„åœ˜è†³ï¼Œ10 é “è£¡é¢æœ‰ 9 é “å°ç™½èœï¼Œè‚‰ 90% ç‚¸æ’ï¼Œæ°¸é æ˜¯ç†±çš„é¹¹æ¹¯ã€ç”œæ¹¯ï¼Œä½†åæ­£å°±è©²åƒåƒè©²å–å–ï¼Œä¸ç„¶æœƒé¤“çš„ã€‚æ¯å¤©åªèƒ½æœŸå¾…æœ‰ 85 åº¦ C è£œèœçš„æ—¥å­ã€‚ æ‰“ç™¼æ™‚é–“ï¼šæœƒæœ‰ä¸å°‘ç©ºæª”æ™‚é–“ï¼Œä¸‹èª²ä¼‘æ¯çš„æ™‚é–“ã€æ™šä¸Šå¡«è³‡æ–™ç™¼æ±è¥¿çš„æ™‚é–“ï¼Œæœ€å¾Œä¸€å…©å¤©çš„å¾ˆå¤šæ™‚é–“ï¼Œé€™äº›æ™‚é–“ä¸èƒ½åˆä¸èƒ½ç”¨æ‰‹æ©Ÿï¼Œé‚„æ˜¯è¦æƒ³è¾¦æ³•æ‰“ç™¼ä¸€ä¸‹ï¼Œä¸ç„¶åªèƒ½ç¡è¦ºç™¼å¾…çš„è©±å¾ˆç„¡èŠã€‚ é‡é»åˆ†äº« # æˆ‘è¦ºå¾—æ²’å¿…è¦è³¼è²·é¡å¤–çš„ä¸‰å¯¶ (å…§è¡£è¤²ã€è¥ªå­)ï¼Œé¦–å…ˆä½ åªèƒ½æ´—æ¶ˆç™¼æˆ–æ´ K è²·çš„ä¸‰å¯¶ï¼Œæ­¤å¤–ä¸€å¤©åŸºæœ¬ä¸Šåªèƒ½æ´—ä¸€å¥—ï¼Œé›–ç„¶å¥½åƒå¯ä»¥é¡å¤–åŠ éŒ¢æ´—å¦å¤–ä¸€å¥—ï¼Œä½†æ²’å•¥ç†ç”±ä¸€å¤©æ´—å…©å¥—ã€‚æ´ K çš„è©±ï¼Œæœ‰å‚³è¨€æ´ K çš„å…§è¤²æ¯”æ¶ˆç™¼å¥½ç©¿ï¼Œä½†æ˜¯æˆ‘æ²’ç©¿éï¼Œä¸çŸ¥é“ã€‚å»ºè­°é ‚å¤šè²·ä¸€å¥—ç•¶ä½œé¿å…ä¸å°å¿ƒå¼„ä¸Ÿæˆ–å¼„é«’çš„å‚™æ¡ˆã€‚ å¯«æ—¥è¨˜æ˜¯ä¸€å€‹éå¸¸å¥½æ¶ˆç£¨æ™‚é–“çš„äº‹æƒ…ï¼Œæ‡‰è©²æœƒç™¼ä¸€æœ¬ç­†è¨˜æœ¬ï¼Œä½†ä¹Ÿå¯ä»¥è‡ªå·±å¸¶ç™½ç´™ï¼Œæˆ–è‘—å¸¶ä¸€æœ¬å°æœ¬çš„ç©ºç™½ç­†è¨˜æœ¬ (å¥½åƒå¯ä»¥å¸¶é€²å») é ­é«®çš„æ¨™æº–æ˜¯çŸ­æ–¼ 3 mmï¼Œå¦‚æœå¤ªé•·ï¼Œé€²å»ç¬¬ä¸€å¤©æœƒè¢«æ‹‰å»å‰ªé ­é«®ï¼Œè¦é¡å¤–èŠ±éŒ¢ã€‚æœ‰å‚³è¨€ï¼Œå› ç‚ºå‰ªé ­é«®é˜¿å§¨å¯ä»¥æ‹¿åˆ°éŒ¢ï¼Œæ‰€ä»¥çŸ­æ–¼æ¨™æº–ä½†æ˜¯ç•¥é•·çš„é ­é«®ä¹Ÿæœƒè¢«æŠ“å»å‰ªã€‚æˆ‘å€‘ä¸­éšŠå»çš„æ™‚å€™ï¼Œæœ‰é•·å®˜ç”¨å°ºé‡ï¼Œæœ‰ä¸€å€‹åŒæ¢¯å°±çœŸçš„å‰›å¥½ 3mmï¼Œé˜¿å§¨è¦æŠŠä»–æŠ“éå»å‰ªçš„æ™‚å€™å°±è¢«é•·å®˜æ“‹å›å»äº† å»ºè­°è‡ªå·±å¸¶å¥½ç”¨çš„åŸå­ç­†ï¼Œæ¶ˆç™¼çš„æœ‰é»çˆ›ï¼Œä¸å¥½å¯«å­— ç¬¬ä¸€å¤©åªèƒ½æ´—è‡ªå·±çš„å…§è¡£è¤²ï¼Œå¤–è¡£åªèƒ½ç­‰æ”¾å‡é›¢ç‡Ÿå¸¶å‡ºå»æ´—ï¼Œè€Œä¸”æœƒé–åœ¨å€‰åº«è£¡é¢ ä¸‰å¯¶æœƒæ¯å¤©é€æ´—ï¼Œåˆ¶æœã€é‹å‹•è¤²å¤§æ¦‚ä¸€å‘¨æ´—ä¸€æ¬¡ã€‚æ¯›å·¾ä¸èƒ½é€æ´—ï¼Œåªèƒ½è‡ªå·±æƒ³è¾¦æ³•æ´—ã€‚ æ‰“é£¯ç­ (å¹«å¤§å®¶ç™¼ç›¤å­ã€æ‰“èœã€æ´—é‹å­ã€è™•ç†å»šé¤˜) é›–ç„¶å¯ä»¥ç²å¾—åŠ åˆ†æ©Ÿæœƒï¼Œä½†çœŸçš„æ˜¯éå¸¸ç´¯çš„ä¸€å€‹å·¥ä½œï¼Œè€Œä¸”æˆ‘å€‘ä¸­éšŠç›´æ¥æŒ‡å®š 1~40 ç‚ºæ‰“é£¯ç­ï¼Œå…¶ä»–å›ºå®šå…¬å·®ç­ä¹Ÿæ˜¯æŒ‡å®šçš„ã€‚åŸºæœ¬å°±çœ‹ç·£åˆ†äº†ï¼Œæˆ‘å€‘æ˜¯ç¬¬ä¸€å¤©ä¸€åˆ°æˆåŠŸå¶ºå°±é¦¬ä¸Šé ˜åˆ°è™Ÿç¢¼è¡£ï¼Œæ±ºå®šå­¸è™Ÿäº†ï¼Œä¹Ÿæ²’æœ‰åƒæœ‰äº›äººèªªçš„æœƒåˆ°æ•™å®¤è£¡é¢æ‰ç™¼ã€‚ æ‰‹æ©Ÿæœƒæ”¾é‡è¦ç‰©å“æ«ƒï¼Œç„¶å¾Œé‘°åŒ™æœƒçµ¦æˆ‘å€‘è‡ªå·±ä¿ç®¡ï¼Œå…¬æ‰€å‰›å¥½ç™¼äº†ä¸€å€‹å¯ä»¥æ”¾åœ¨å£è¢‹å¤§å°çš„æ–‡å…·è¢‹ï¼Œæˆ‘å°±æŠŠé‘°åŒ™å’ŒéŒ¢éŒ¢éƒ½æ¯å¤©éš¨èº«ä¿ç®¡ã€‚ éš¨æ™‚éƒ½è¦æˆ´å£ç½© éŒ¢ä¸»è¦ç”¨åœ¨ä¸‰å€‹åœ°æ–¹ï¼Œç¬¬ä¸€å¤©å»æ´ K æ¡è³¼ã€çµ±ä¸€æ”¶å–çš„ç…§ç‰‡è²»ç”¨å’Œæ´—è¡£è²»ç”¨ (æ²’è²·ç…§ç‰‡ã€æ²’ç”¨å®Œæœƒé€€å›)ã€æœ‰æ©Ÿæœƒçš„è©±ï¼Œæœƒæœ‰å¹¾æ¬¡å¯ä»¥è²· 85 åº¦ C çš„å°é»å¿ƒã€é£²æ–™ã€‚æˆ‘è‡ªå·±çš„èŠ±è²»å¤§ç´„æ˜¯ 2000 å…ƒï¼Œé‚„æ˜¯å¯ä»¥å¸¶å€‹ä¸‰åƒæ¯”è¼ƒä¿éšªã€‚ å› ç‚ºè¦è‡ªå·±ä¿ç®¡ç­·å­å’Œç¢—ï¼Œæ‰€ä»¥å»ºç«‹å¸¶å€‹å¤¾éˆè¢‹æ¯”è¼ƒæ–¹ä¾¿ æœ‰å¿…è¦çš„è©±ï¼Œå¯ä»¥å¸¶ä¸€é»é»é›™é¢è† å¸¶æˆ–æ³¡æ£‰è† å¸¶ã€é•·å°¾å¤¾ï¼Œæ•´ç†å…§å‹™çš„æ™‚å€™æœƒæ–¹ä¾¿ä¸€é»é»ï¼Œå¯ä»¥å›ºå®šç‰™è†ç‰™åˆ·ã€é‹å‹•è¤²çš„è¤²é ­ï¼Œé¿å…è¢«è‡¨å…µæ’é£›ã€‚ ä¸‰åˆä¸€ä¸è¦è²·å¤ªå¤§ç½çš„ï¼Œå»ºè­°é•·åº¦è·Ÿä¸€èˆ¬çš„ç‰™è†å·®ä¸å¤šï¼Œå¤ªå¤§çš„è©±ï¼Œæ•´ç†å…§å‹™çš„æ™‚å€™å¯èƒ½æœƒå‡ºä¸€é»å°å•é¡Œ æ©¡çš®ç­‹ä¹Ÿæ˜¯å¯ä»¥å¸¶å€‹å…©ã€ä¸‰æ¢æ‹‰ï¼Œæœ‰éœ€è¦çš„æ™‚å€™å¯ä»¥æ‹¿ä¾†ç”¨ ç¾åœ¨é‹å­ (çš®é‹ã€é‹å‹•é‹) éƒ½æ˜¯æ¶ˆç™¼ (é€çµ¦ä½ ) çš„æ±è¥¿ï¼Œå°ºå¯¸ä¸æœƒè·Ÿè‡ªå·±çš„è…³å·®å¤ªå¤šï¼Œæ‰€ä»¥ä¸éœ€è¦é‹æ ¹è²¼äº†ï¼Œä½†æ˜¯é‹å­å¾ˆçˆ›ï¼Œæœ‰äººè‡ªå·±å¸¶å¥½ä¸€é»çš„é‹å¢Šä¾†å¡é‹å­ã€‚ ä¸çŸ¥é“ç‚ºå•¥ï¼Œæˆ‘çš„æ‰‹è¶…ç´šä¹¾ï¼Œå¯ä»¥å¸¶ä¸€ä¸‹è­·æ‰‹éœœ å¯ä»¥å¸¶é›»å‹•åˆ®é¬åˆ€ï¼Œåªæ˜¯ä¸èƒ½å……é›» ä¸æœƒè£ MDMï¼Œæ‰‹æ©Ÿæœƒè¢«æ”¶èµ·ä¾†ï¼Œåªæœ‰æ´—æ‰“æ™‚é–“å¯ä»¥ç”¨ æ”¾å‡çš„æ™‚å€™ï¼Œæœƒèµ°å‡ºä¾†åˆ°ä¸­å±±è·¯ä¸Šé¢ã€‚éšŠä¼æœƒåˆ†å®¶é•·æ¥é€å’Œè¨ˆç¨‹è»Šå…©ç¨®ã€‚å®¶é•·æ¥é€çš„è©±æœƒå¾€ç®­é ­æ–¹å‘åœ¨èµ°éå»ã€‚ ä¸­é–“æœ‰æ”¾å‡çš„è©±ï¼ŒçœŸçš„è¦æŠŠä¸éœ€è¦çš„æ±è¥¿å¸¶å›å®¶ï¼Œä¸ç„¶çœŸçš„æœƒå¾ˆéº»ç…©ï¼Œæœƒç™¼ä¸€å€‹é»‘å¤§ (å¯ä»¥è£å…©åˆ°ä¸‰å€‹èƒŒåŒ…åœ¨è£¡é¢çš„è¶…å¤§èƒŒåŒ…)ï¼Œä½†æ˜¯åˆ°æ™‚å€™è¦å¡ä½ çš„èƒŒåŒ…ï¼Œå…©é›™é‹å­ï¼Œä¸€å€‹ç›’å­ï¼Œä¸€å€‹è‡‰ç›†ï¼Œæˆ‘é‚„æ˜¯å·®é»å¡ä¸ä¸‹äº†ã€‚ è¦æŠŠæ¡å¥½ EMT-1 å›ç­”å•é¡Œã€äº’å‹•åŠ åˆ†çš„æ©Ÿæœƒï¼Œä¸è€ƒæ…®æ‰“é£¯ç­å’Œæ›¿æ­Œç¬¬ä¸€çš„è©±ï¼Œè¦åŠ åˆ†çš„æ©Ÿæœƒé‚„æ˜¯æ¯”è¼ƒç¨€ç¼ºçš„ï¼Œä½†æ˜¯å…§å‹™åˆå®¹æ˜“æ‰£ä¸€å¤§å †ï¼Œå¦‚æœä½ ä¸æ˜¯æ‰“é£¯èˆ¬çš„ï¼Œæƒ³è¦æ¹Šåˆ°æ¦® 6 é›¢é–‹é‚„æ˜¯æ¯”è¼ƒå›°é›£çš„ï¼Œæƒ³æ—©é»é›¢é–‹çš„è©±ï¼ŒåŠ åˆ†çš„æ©Ÿæœƒéƒ½è¦çˆ­å–ä¸€ä¸‹ æˆ‘å€‘ä¸­éšŠå‰å¹¾å¤©ä¸æ‡‚äº‹ï¼Œèµ·åºŠé›†åˆçš„æ™‚å€™ï¼Œæ²’æœ‰æŠŠå¯¢å®¤å’Œæ•™å®¤çš„ç‡ˆé—œæ‰ï¼Œé›†é«”æ‰£ 2 åˆ†ï¼Œè¶…ç´šè™§ï¼Œè«‹æ ¼å¤–å°å¿ƒã€‚ äººç”Ÿç¬¬ä¸€æ¬¡æè¡€å°±åœ¨éƒ¨éšŠè£¡é¢äº†ï¼Œæä¸€ä¸‹é‚„æ˜¯ä¸éŒ¯çš„ 350 å¡Šçš„ç…§ç‰‡å¾ˆè²´ï¼Œå¾ˆå¤šäººèªªä¸è¦è²·ï¼Œä½†å°±çœŸçš„çœ‹å€‹äººå–œå¥½æ‹‰\u0026hellip;ï¼Œæœ‰æ²’æœ‰æƒ³ç•™è‘—ç´€å¿µï¼Œä½†æ˜¯åˆè¶…å¤§å¼µï¼Œå¤§å®¶éƒ½å…‰é ­é‚„å¾ˆé›£åˆ†è¾¨èª°æ˜¯èª°ï¼ŒçœŸçš„æ˜¯ä¹ŸæŒºå‘çš„å°±æ˜¯äº†\u0026hellip;ã€‚ è¦è¼ªæµç«™å¤œå“¨ï¼Œä½†åªç«™ä¸€å€‹å°æ™‚ï¼Œåœ¨ç‡ŸæœŸé–“å¤§æ¦‚æœƒç«™åˆ°å››æ¬¡å·¦å³ æ›¿æ­Œæ¯”è³½ (è»æ­Œæ¯”è³½) ä¸å¤ªçŸ¥é“è©²æ€éº¼è©•åƒ¹é€™å€‹æ±è¥¿ï¼Œåæ­£è¡Œæœ‰é¤˜åŠ›çš„è©±ï¼ŒåƒåŠ å…¬å·®å¯ä»¥é¡å¤–åŠ  2 åˆ†ï¼Œä¸éæœƒæ¯å¤©å°‘ç¡ä¸€å€‹å°æ™‚ä¾†åšé“å…·ã€ç·´å‹•ä½œ (ç‰¹æŠ€) å•¥çš„ å„å€‹ä¸­éšŠçš„è¦å±€å’Œè¦æ±‚æœƒå·®è »å¤šçš„ï¼Œé€™å€‹å°±çœŸçš„åªèƒ½ç¥å¥½é‹äº†ï¼Œåˆ†é…åˆ°æ¯”è¼ƒå¥½çš„ä¸­éšŠæœƒç¨å¾®è¼•é¬†ä¸€é»ï¼Œé›–ç„¶è©²æ•´ç†çš„å…§å‹™ã€è©²åšçš„äº‹æƒ…é‚„æ˜¯è¦åšï¼Œä½†æ˜¯å°±å¯èƒ½æ¯”è¼ƒä¸æœƒç½µäººï¼Œä¹Ÿä¸æœƒå¤ªéåš´æ ¼ã€‚ ","date":"April 7 2025","externalUrl":null,"permalink":"/posts/rdss-experiences/","section":"æ–‡ç« ","summary":"","title":"ç ”ç™¼æ›¿ä»£å½¹ 127T å¿ƒå¾—","type":"posts"},{"content":"","date":"February 19 2025","externalUrl":null,"permalink":"/tags/python/","section":"æ¨™ç±¤","summary":"","title":"Python","type":"tags"},{"content":"","date":"February 19 2025","externalUrl":null,"permalink":"/categories/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/","section":"åˆ†é¡","summary":"","title":"è»Ÿé«”é–‹ç™¼","type":"categories"},{"content":" å‰è¨€ # æˆ‘ä½¿ç”¨ Python çš„ FastAPI é–‹ç™¼äº†ä¸€å€‹å°ˆæ¡ˆï¼Œä¸¦è¨ˆç•«å°å…¥ Prometheus ä¾†æ”¶é›† metricsã€‚ç„¶è€Œï¼Œåœ¨æ’°å¯«å–®å…ƒæ¸¬è©¦æ™‚ï¼Œæˆ‘é‡åˆ°äº†è¨±å¤šç¥ç§˜çš„å•é¡Œã€‚æœ¬ä¾†ä»¥ç‚ºåªæ˜¯æ¸¬è©¦å¯«éŒ¯ï¼Œä½†æ·±å…¥ç ”ç©¶å¾Œç™¼ç¾ï¼Œé€™å…¶å¯¦èˆ‡ Prometheus çš„ Python SDK (prometheus_client) çš„ multiprocess å¯¦ä½œæ–¹å¼æœ‰é—œã€‚\né€™ç¯‡æ–‡ç« å°‡ç°¡å–®æ¢è¨ Prometheus çš„ Python Client SDK çš„å¤š multiprocess è¨­è¨ˆï¼Œå¦‚ä½•å°‡å…¶æ•´åˆåˆ° FastAPI å°ˆæ¡ˆä¸­ï¼Œä»¥åŠå¦‚ä½•å¯¦ç¾å–®å…ƒæ¸¬è©¦ã€‚åŒæ™‚ï¼Œæˆ‘ä¹Ÿæœƒèªªæ˜æˆ‘é‡åˆ°çš„å•é¡Œä»¥åŠç›®å‰èƒ½æƒ³åˆ°çš„è§£æ±ºæ–¹æ¡ˆã€‚\nPrometheus Client SDK åŸºæœ¬ä»‹ç´¹ # å°æ–¼ API Serverï¼Œæˆ‘å€‘é€šå¸¸å¸Œæœ›æ”¶é›†ä¸€äº› metricsï¼Œä¾‹å¦‚ï¼š\nrequests çš„ç¸½æ•¸ response time HTTP 200 å›æ‡‰æ•¸é‡ å…¶ä»–èˆ‡å•†æ¥­é‚è¼¯ç›¸é—œçš„ metrics é€™äº› metrics å¯ä»¥é€é Prometheus é€²è¡Œæ”¶é›†ï¼Œä¸¦æ­é… Grafanaã€Alert Manager ç­‰å·¥å…·é€²è¡Œç›£æ§ã€‚Prometheus å®˜æ–¹æä¾›äº†ä¸€å€‹ Python SDKï¼Œè®“é–‹ç™¼è€…èƒ½å¤ å¿«é€Ÿé–‹ç™¼å¯¦ä½œ metrics ä¸¦å°å‡ºåˆ° Prometheusã€‚\né¦–å…ˆï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹å¦‚ä½•åœ¨ FastAPI ä¸­ä½¿ç”¨ Prometheus Python Client SDKã€‚\né€™æ®µç¨‹å¼ç¢¼å±•ç¤ºäº†å¦‚ä½•å®šç¾© Counterï¼Œç”¨ä¾†è¨ˆç®—æ‰€æœ‰ API Endpoint çš„ è«‹æ±‚æ¬¡æ•¸ï¼š\n# main.py from prometheus_client import Counter, make_asgi_app from fastapi import FastAPI, Request from starlette.middleware.base import BaseHTTPMiddleware counter = Counter(\u0026#39;http_requests_total\u0026#39;, \u0026#39;Total HTTP requests\u0026#39;, [\u0026#39;method\u0026#39;, \u0026#39;endpoint\u0026#39;]) app = FastAPI() class PrometheusMiddleware(BaseHTTPMiddleware): async def dispatch(self, request: Request, call_next): counter.labels(request.method, request.url.path).inc() response = await call_next(request) return response app.add_middleware(PrometheusMiddleware) é€™é‚Šæˆ‘å€‘å®šç¾©äº†ä¸€å€‹ counterï¼Œä¸¦è¨»å†Šæˆ FastAPI çš„ middlewareï¼Œæ¯æ¬¡æœ‰ request é€²ä¾†çš„æ™‚å€™ï¼Œcounter çš„æ•¸å€¼å°±æœƒåŠ ä¸€ (inc)ï¼Œä¸”æœƒå°‡ HTTP method å’Œ URL path ä½œç‚º labelï¼Œä»¥ä¾¿å€åˆ†ä¸åŒçš„ endpointsã€‚\næ¥è‘—ï¼Œæˆ‘å€‘éœ€è¦å®šç¾© /metrics ç«¯é»ï¼Œè®“ Prometheus èƒ½å¤ æ‹‰å– metrics è³‡æ–™ï¼š\napp.mount(\u0026#34;/metrics\u0026#34;, make_asgi_app()) æ¥è‘—æˆ‘å€‘è¨ªå•ç«¯é»å°±å¯ä»¥å–å¾— metrics è³‡æ–™ï¼Œå› ç‚ºæˆ‘å€‘è¨ªå• /metrics/ é€™å€‹ç«¯é»ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥çœ‹åˆ° http_requests_total é€™å€‹ counter çš„æ•¸å€¼æ˜¯ 1ã€‚\n# fastapi main.py # curl 127.0.0.1:8000/metrics/ # HELP http_requests_total Total HTTP requests # TYPE http_requests_total counter http_requests_total{endpoint=\u0026#34;/metrics/\u0026#34;,method=\u0026#34;GET\u0026#34;} 1.0 # HELP http_requests_created Total HTTP requests # TYPE http_requests_created gauge http_requests_created{endpoint=\u0026#34;/metrics/\u0026#34;,method=\u0026#34;GET\u0026#34;} 1.7377473771929123e+09 è¨ªå• /metrics æ™‚ï¼ŒFastAPI æœƒå›å‚³ HTTP 307 ä¸¦å°å‘ /metrics/ï¼Œå¦‚æœä½¿ç”¨ curl æ¸¬è©¦æ™‚ï¼Œéœ€è¦åŠ ä¸Š -L åƒæ•¸æ‰èƒ½è·Ÿéš¨é‡å°ï¼Œæˆ–è€…ç›´æ¥è¨ªå• /metrics/ã€‚\nå–®å…ƒæ¸¬è©¦ Middleware # é‚£æˆ‘å€‘è©²æ€éº¼å°é€™å€‹ middleware é€²è¡Œå–®å…ƒæ¸¬è©¦å‘¢ï¼Ÿæˆ‘å€‘å¸Œæœ›ä½¿ç”¨ pytest å°é€™å€‹ middleware é€²è¡Œå–®å…ƒæ¸¬è©¦ï¼Œç¢ºä¿ metrics èƒ½å¤ æ­£ç¢ºè¢«è¨˜éŒ„ï¼Œä»¥åŠå°å‡ºåˆ°ç«¯é»ã€‚\n# test_main.py from main import app from fastapi.testclient import TestClient client = TestClient(app) def test_middle(): response = client.get(\u0026#34;/metrics/\u0026#34;) assert response.status_code == 200 assert \u0026#39;http_requests_total{endpoint=\u0026#34;/metrics/\u0026#34;,method=\u0026#34;GET\u0026#34;} 1.0\u0026#39; in response.text FastAPI æä¾› TestClient è®“æˆ‘å€‘å¯ä»¥æ¨¡æ“¬ API è«‹æ±‚ä¸¦é€²è¡Œæ¸¬è©¦ã€‚åœ¨é€™å€‹æ¸¬è©¦ä¸­ï¼Œæˆ‘å€‘å° /metrics/ ç™¼é€ GET è«‹æ±‚ï¼Œä¸¦æª¢æŸ¥å›å‚³çš„ metrics æ˜¯å¦åŒ…å« http_requests_total{endpoint=\u0026quot;/metrics/\u0026quot;,method=\u0026quot;GET\u0026quot;} 1.0ã€‚\npytest test.py ... ====================== 1 passed, 1 warning in 0.43s ======================= ç•¶ç„¶æˆ‘å€‘å¾—åˆ°äº†æˆ‘å€‘é æœŸçš„çµæœï¼Œé€™å€‹æ¸¬è©¦æ˜¯æˆåŠŸçš„ã€‚\nMultiprocess è¨­è¨ˆ # æ¥è‘—ï¼Œæˆ‘å€‘å°±è¦è«‡åˆ° prometheus python client çš„ multiprocess è¨­è¨ˆï¼Œä¸Šé¢çš„ middleware åœ¨ multiprocess çš„æƒ…æ³ä¸‹æ˜¯æœƒæœ‰å•é¡Œçš„ï¼Œå› ç‚º counter å­˜åœ¨æ–¼æ¯å€‹ process çš„è¨˜æ†¶é«”ä¸­ï¼Œå› æ­¤ä¸åŒ process çš„è¨ˆæ•¸äº’ä¸ç›¸é€šã€‚é€™å°è‡´ /metrics ç«¯é»å›å‚³çš„å…§å®¹ï¼Œåƒ…åŒ…å«ç•¶å‰ process çš„è¨ˆæ•¸ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ process çš„ç¸½å’Œã€‚\nPrometheus çš„è§£æ±ºæ–¹æ¡ˆ # Prometheus Python Client æä¾›çš„è§£æ³•æ˜¯ï¼š\næ¯å€‹ process å…ˆå°‡ metrics è³‡æ–™å¯«å…¥å„è‡ªçš„æª”æ¡ˆä¸­ ç•¶è¨ªå• /metrics æ™‚ï¼Œçµ±ä¸€è®€å–æ‰€æœ‰æª”æ¡ˆï¼Œåˆä½µæ•¸æ“šå¾Œå†å›å‚³ ä½¿ç”¨ä¸Šä¹Ÿå¾ˆç°¡å–®ï¼š\n# main.py import os os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;] = \u0026#39;/dev/shm\u0026#39; é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦è¨­å®š PROMETHEUS_MULTIPROC_DIR ç’°å¢ƒè®Šæ•¸ï¼ŒæŒ‡å®š metrics æª”æ¡ˆçš„å„²å­˜è·¯å¾‘ã€‚é€™æ¨£ä¸€ä¾†ï¼Œæ‰€æœ‰ Counter éƒ½æœƒè‡ªå‹•é€²å…¥ multiprocess æ¨¡å¼ï¼Œä¸¦å°‡è³‡æ–™å¯«å…¥å°æ‡‰çš„æª”æ¡ˆã€‚\ndef make_prometheus_app(): registry = CollectorRegistry() multiprocess.MultiProcessCollector(registry=registry) return make_asgi_app(registry=registry) app.mount(\u0026#34;/metrics\u0026#34;, make_prometheus_app()) æ¥è‘—ï¼Œæˆ‘å€‘éœ€è¦ä¿®æ”¹ /metrics ç«¯é»çš„å°å‡ºæ–¹å¼ï¼Œç¢ºä¿å®ƒèƒ½å¤ è®€å–å¤šå€‹ process çš„æ•¸æ“šä¸¦åˆä½µï¼š\nCollectorRegistry æ˜¯ç”¨ä¾†ç®¡ç†æ‰€æœ‰è¨ˆæ•¸å™¨çš„çµæ§‹ï¼Œæ‰€æœ‰çš„ Counterã€Gaugeã€Histogramã€Summary éƒ½æœƒå‘ä¸€å€‹æˆ–å¤šå€‹ Registry è¨»å†Šã€‚ç•¶æˆ‘å€‘è¨ªå• /metrics æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯å‘¼å« registry çš„ collect() æ–¹æ³•ï¼Œregistry æœƒå°æ‡‰èª¿ç”¨æ‰€æœ‰è¨»å†Šåœ¨è£¡é¢è¨ˆæ•¸å™¨çš„ collect() æ–¹æ³•ï¼Œå°‡æ‰€æœ‰ metrics è³‡æ–™åˆä½µèµ·ä¾†å°å‡ºã€‚\ngraph TD Endpoint -- Collect --\u0026gt; Registry Registry -- Collect --\u0026gt; Counter1 Registry -- Collect --\u0026gt; Counter2 Registry -- Collect --\u0026gt; Counter3 å‰é¢æˆ‘å€‘å®šç¾© Counter å’Œä½¿ç”¨ make_metrics_app çš„æ™‚å€™æ²’æœ‰å®šç¾© registryï¼Œä½†æ˜¯ prometheus client æœƒä½¿ç”¨ä¸€å€‹é è¨­çš„ registry ä¾†ä¿å­˜ã€‚\n# prometheus_client/asgi.py def make_asgi_app(registry: CollectorRegistry = REGISTRY): ... # prometheus_client/multiprocess.py class Counter(MetricWrapperBase): # prometheus_client/metrics.py class MetricWrapperBase(Collector): def __init__(self: T, ... registry: Optional[CollectorRegistry] = REGISTRY, ... ) -\u0026gt; None: å¯ä»¥çœ‹åˆ°ï¼Œé€™é‚Šéƒ½ä½¿ç”¨äº†ä¸€å€‹ REGISTRY ä½œç‚ºé è¨­åƒæ•¸ï¼Œé€™å€‹ REGISTRY å°±æ˜¯ä¸€å€‹é è¨­å…¨åŸŸè®Šæ•¸çš„ CollectorRegistryã€‚\n# prometheus_client/registry.py ... REGISTRY = CollectorRegistry() æ‰€ä»¥ make_asgi_app æœƒå‘¼å« REGISTRY.collect()ï¼Œè€Œ REGITRY.collect() å‰‡æœƒå‘¼å«åˆ° counter.collect()ã€‚\næ¥è‘—è®“æˆ‘å€‘å›åˆ° multi proccess çš„ç¨‹å¼ç¢¼ã€‚\ndef make_prometheus_app(): registry = CollectorRegistry() multiprocess.MultiProcessCollector(registry=registry) return make_asgi_app(registry=registry) app.mount(\u0026#34;/metrics\u0026#34;, make_prometheus_app()) é€™é‚Šï¼Œæˆ‘å€‘å®šç¾©äº†ä¸€å€‹ç©ºçš„ registry è¦†è“‹ make_asgi_app é è¨­çš„ REGISTRYï¼Œä¸¦ä¸”å…¶ä¸­åªæœ‰æ”¾å…¥ MultiProcessCollectorã€‚æ‰€ä»¥ç•¶æˆ‘å€‘å‘¼å« /metrics çš„æ™‚å€™ï¼Œç­‰åƒ¹æ–¼å‘¼å« MultiProcessCollector.collect()ï¼ŒMultiProcessCollector æœƒè®€å– PROMETHEUS_MULTIPROC_DIR ä¸­çš„æ‰€æœ‰çš„æª”æ¡ˆï¼Œå°‡æ‰€æœ‰ process çš„ metrics è³‡æ–™åˆä½µèµ·ä¾†å°å‡ºã€‚\ngraph TD Endpoint -- Collect --\u0026gt; Registry Registry -- Collect --\u0026gt; MultiProcessCollector MultiProcessCollector -- Read Files --\u0026gt; PROMETHEUS_MULTIPROC_DIR Counter1-- Write --\u0026gt; PROMETHEUS_MULTIPROC_DIR Counter2-- Write --\u0026gt; PROMETHEUS_MULTIPROC_DIR Counter3-- Write --\u0026gt; PROMETHEUS_MULTIPROC_DIR åœ¨ prometheus è£¡é¢ï¼Œè¨ˆæ•¸å™¨æœ‰ Counter, Gauge, Histogram, Summary ç­‰ç¨®é¡ï¼Œå°æ–¼æ¯å€‹é¡å‹è¨ˆæ•¸å™¨çš„ä¸åŒ Processï¼Œprometheus client éƒ½æœƒå¯«åˆ° PROMETHEUS_MULTIPROC_DIR/_.db çš„æª”æ¡ˆè£é¢ã€‚\nls /dev/shm counter_2463.db counter_3743.db ç¬¬ä¸€å€‹é™·é˜±ï¼šPROMETHEUS_MULTIPROC_DIR çš„è¨­ç½®æ™‚é–“ # å¦‚æœï¼Œå¦‚æœæŒ‰ç…§æˆ‘ä¸Šé¢æè¿°çš„æ–¹å¼æ’°å¯«å‡ºä»¥ä¸‹çš„ç¨‹å¼ç¢¼ï¼Œå°‡ç’°å¢ƒè®Šæ•¸çš„è¨­ç½®æ”¾åœ¨ Import å¾Œé¢çš„ç¬¬ä¸€è¡Œã€‚\nimport os from prometheus_client import Counter, CollectorRegistry, multiprocess, make_asgi_app from fastapi import FastAPI, Request from starlette.middleware.base import BaseHTTPMiddleware os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;] = \u0026#39;/dev/shm\u0026#39; é‚£éº¼ä½ å°±æœƒç™¼ç¾ï¼Œä¸è«–æ€éº¼è®€ /metricséƒ½æ˜¯ç©ºçš„ã€‚è€ŒåŸå› å‘¢ï¼Œæˆ‘å€‘å°±éœ€è¦äº†è§£ Prometheus Client æ˜¯æ€éº¼åˆ¤å®šæ˜¯å¦è¦å•Ÿç”¨ multiprocess æ¨¡å¼ï¼Œå°‡ metrics å¯«å…¥æª”æ¡ˆçš„ã€‚\ncounter = Counter(\u0026#39;http_requests_total\u0026#39;, \u0026#39;Total HTTP requests\u0026#39;, [\u0026#39;method\u0026#39;, \u0026#39;endpoint\u0026#39;]) # prometheus_client/metrics.py class Counter(MetricWrapperBase): def _metric_init(self) -\u0026gt; None: self._value = values.ValueClass(self._type, self._name, self._name + \u0026#39;_total\u0026#39;, self._labelnames, self._labelvalues, self._documentation) self._created = time.time() å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Counter å…§éƒ¨æœƒå‘¼å« _metric_init å‡½æ•¸ï¼Œå¯¦ä¾‹åŒ–ç”¨æ–¼ä¿å­˜æ•¸å€¼çš„ values.ValueClassã€‚\n### prometheus_client/values.py def get_value_class(): # Should we enable multi-process mode? # This needs to be chosen before the first metric is constructed, # and as that may be in some arbitrary library the user/admin has # no control over we use an environment variable. if \u0026#39;prometheus_multiproc_dir\u0026#39; in os.environ or \u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39; in os.environ: return MultiProcessValue() else: return MutexValue ValueClass = get_value_class() è€Œé€™å€‹ ValueClass å¯¦éš›ä¸Šæ˜¯ä¸€å€‹å…¨åŸŸè®Šæ•¸ï¼Œæœƒè¢«metrics.py å°å…¥ï¼Œå› æ­¤ï¼Œç•¶æˆ‘å€‘ import prometheus_client æ™‚ï¼Œprometheus client å°±å·²ç¶“æ ¹æ“šç’°å¢ƒè®Šæ•¸ PROMETHEUS_MULTIPROC_DIR æ˜¯å¦å­˜åœ¨ä¾†æ±ºå®šæ˜¯å¦è¦å•Ÿç”¨ multiprocess æ¨¡å¼äº†ã€‚\né€™é‚Š ValueClass æœƒè®Šæˆæ˜¯ MultiProcessValue() çš„è¿”å›å€¼ï¼Œä½†å…·é«”æ˜¯æ˜¯ç”šéº¼ï¼Œæˆ‘å€‘å¾Œé¢å†ä¾†çœ‹ã€‚\næ‰€ä»¥ï¼Œå¦‚æœæˆ‘å€‘åœ¨ import prometheus_client ä¹‹å¾Œæ‰è¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼Œé‚£éº¼ prometheus client å°±ä¸æœƒå•Ÿç”¨ multiprocess æ¨¡å¼ï¼Œè€Œæ˜¯å–®ç´”æŠŠæ•¸å€¼ä¿å­˜åœ¨è¨˜æ†¶é«”ä¸­ã€‚\nå› æ­¤ï¼Œå¦‚æœè¦é€éç¨‹å¼ç¢¼è¨­ç½®å»å•Ÿç”¨é€™å€‹åŠŸèƒ½çš„è©±ï¼Œæˆ‘å€‘å¿…éœ€è¦åœ¨ import ä¹‹å‰è¨­ç½®å¥½ç’°å¢ƒè®Šæ•¸ï¼Œåˆæˆ–æ˜¯åœ¨åŸ·è¡Œ Python å‰å°±å®Œæˆç’°å¢ƒè®Šæ•¸çš„è¨­ç½®ã€‚\nimport os os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;] = \u0026#39;/dev/shm\u0026#39; from prometheus_client import Counter, CollectorRegistry, multiprocess, make_asgi_app from fastapi import FastAPI, Request from starlette.middleware.base import BaseHTTPMiddleware ç¬¬äºŒå€‹é™·é˜±ï¼šç’°å¢ƒè®Šæ•¸çš„è¨­ç½® # å› ç‚ºæˆ‘å€‘æ¡ç”¨äº† multiprocess çš„æ¨¡å¼ï¼Œç‚ºäº†å–®å…ƒæ¸¬è©¦ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿æ¯æ¬¡æ¸¬è©¦å‰å¾Œ PROMETHEUS_MULTIPROC_DIR æ˜¯ç©ºçš„ï¼Œä¸ç„¶å°±æœƒè®€åˆ°ä¸Šä¸€æ¬¡æ¸¬è©¦çš„ metrics è³‡æ–™ä»¥åŠå…¶ä»–æ¸¬è©¦çš„ç´€éŒ„ã€‚\nç›´è¦ºçš„æƒ³æ³•æ˜¯æˆ‘å€‘å°±ä¿®æ”¹ PROMETHEUS_MULTIPROC_DIR çš„ä½ç½®ï¼Œå°‡ metrics ä¿å­˜åˆ°æš«æ™‚çš„è³‡æ–™å¤¾ä¸­ã€‚å› æ­¤ï¼Œç¬¬ä¸€ç‰ˆçš„æ¸¬è©¦ä¿®æ”¹å¾Œè®Šæˆé€™æ¨£ã€‚\n# test_main.py import os import tempfile from main import app import pytest from fastapi.testclient import TestClient client = TestClient(app) @pytest.fixture() def clean_metrics(): os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;] = tempfile.mkdtemp() yield shutil.rmtree(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]) def test_middle(clean_metrics): response = client.get(\u0026#34;/metrics\u0026#34;) assert response.status_code == 200 assert \u0026#39;http_requests_total{endpoint=\u0026#34;/metrics/\u0026#34;,method=\u0026#34;GET\u0026#34;} 1.0\u0026#39; in response.text è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯æˆ‘å€‘åœ¨ main.py çš„é–‹é ­æœ‰è¨­ç½®ä¸€æ¬¡ PROMETHEUS_MULTIPROC_DIRï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç¢ºä¿ multiprocess çš„æ¨¡å¼æ˜¯å•Ÿç”¨çš„ã€‚\né€™é‚Šè—‰ç”± pytest çš„èªæ³•ä¾†æ’å…¥ä¸€å€‹ pretest å’Œ posttest çš„ actionã€‚ æˆ‘å€‘è—‰ç”± tempfile.mkdtemp() å–å¾—ä¸€å€‹éš¨æ©Ÿç›®éŒ„ï¼Œç„¶å¾Œä¿®æ”¹ PROMETHEUS_MULTIPROC_DIR çš„ä½ç½®ï¼Œè®“ metrics ä¿å­˜åˆ°é€™å€‹ç›®éŒ„ä¸­ï¼Œç„¶å¾Œï¼Œåœ¨æ¸¬è©¦çµæŸå¾Œåˆªé™¤é€™å€‹ç›®éŒ„ã€‚\nè·‘äº†é€™å€‹æ¸¬è©¦ä½ æœƒç™¼ç¾ä¸è«–æ€éº¼è·‘ metrics é€™å€‹ç«¯é»å›å‚³éƒ½æ˜¯ç©ºçš„ï¼Œæˆ–è‘—å¦‚æœä½ æœ‰å…ˆè·‘éå¹¾æ¬¡é€™å€‹ APIï¼Œç„¶å¾Œæ‰è·‘æ¸¬è©¦ä½ æœƒç™¼ç¾ï¼Œä»–æœƒå›å¾©ä¹‹å‰çš„è³‡æ–™ï¼Œä¸¦ä¸”é€™æ¬¡æ¸¬è©¦è¨ªå•ä¸æœƒè¢«è¨˜éŒ„åˆ°ã€‚\nè¦ç­è§£ç‚ºç”šéº¼ç™¼ç”Ÿé€™ç¨®ç¥å¥‡çš„ç¾è±¡ï¼Œè¦äº†è§£ä¸€ä¸‹ multiprocess collector æ˜¯å¦‚ä½•æ±ºå®šè¦è®€å–å“ªå€‹è³‡æ–™å¤¾çš„ã€‚\nMultiprocess Collector æœƒåœ¨åˆå§‹åŒ–çš„æ™‚å€™å°±æ±ºå®šè¦è®€å–å“ªå€‹è³‡æ–™å¤¾ã€‚\n# site-packages/prometheus_client/multiprocess.py class MultiProcessCollector: \u0026#34;\u0026#34;\u0026#34;Collector for files for multi-process mode.\u0026#34;\u0026#34;\u0026#34; def __init__(self, registry, path=None): if path is None: path = os.environ.get(\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;) self._path = path ä¸¦ä¸”æˆ‘å€‘åœ¨ import main.py çš„æ™‚å€™å°±å·²ç¶“å®Œæˆäº†å° MultiProcessCollector çš„åˆå§‹åŒ–ã€‚\n# main.py def make_prometheus_app(): registry = CollectorRegistry() multiprocess.MultiProcessCollector(registry=registry) return make_asgi_app(registry=registry) app.mount(\u0026#34;/metrics\u0026#34;, make_prometheus_app()) æ‰€ä»¥ MultiprocessCollector æœƒå»æŸ¥çœ‹åŸæœ¬è¨­å®šçš„ /dev/shmï¼Œè‡ªç„¶å°±è®€ä¸åˆ°æ¸¬è©¦çš„è³‡æ–™ã€‚\né™·é˜±ä¸‰ï¼šæ¶ˆå¤±çš„ metrics # é‚£éº¼æœ‰æ²’æœ‰è¾¦æ³•åœ¨ï¼Œä¸ä¿®æ”¹ä¸»ç¨‹å¼çš„æƒ…æ³ä¸‹ï¼Œä¿®å¾©æ¸¬è©¦é€ æˆçš„éŒ¯èª¤ã€‚é‚£æˆ‘æƒ³åˆ°ï¼Œæˆ‘å€‘å°±ä¸è¦æ”¹è·¯å¾‘ï¼Œç›´æ¥æŠŠ PROMETHEUS_MULTIPROC_DIR æ¸…ç†ä¹¾æ·¨ï¼Œé‚£éº¼é€™æ¨£å°±å¯ä»¥äº†å§ï¼Ÿ\n@pytest.fixture() def clean_metrics(): for filename in glob.glob(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]+\u0026#39;/*\u0026#39;): os.remove(filename) yield for filename in glob.glob(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]+\u0026#39;/*\u0026#39;): os.remove(filename) æ­å–œä½ æœƒç™¼ç¾é€™å€‹æ¸¬è©¦æ˜¯è¡Œçš„é€šçš„ï¼\nç„¶è€Œç•¶ä½ æ·»åŠ äº†å¦å¤–ä¸€å€‹æ¸¬è©¦ï¼Œä¸¦ä¸”é€™å€‹æ¸¬è©¦è·‘åœ¨ middleware çš„æ¸¬è©¦ä¹‹å‰åŸ·è¡Œï¼Œä½ å°±æœƒç™¼ç¾ï¼Œclient.get(\u0026quot;/metrics\u0026quot;) å›å‚³çš„è³‡æ–™åˆæ˜¯ç©ºçš„äº†ï¼Œé€™æ˜¯ç‚ºä»€éº¼å‘¢ï¼Ÿ\né€™æ™‚å€™ï¼Œæˆ‘å€‘å°±éœ€è¦æ·±å…¥äº†è§£ Counter æ˜¯å¦‚ä½•æŠŠè³‡æ–™ä¿å­˜åˆ°æª”æ¡ˆä¸­çš„ã€‚\nclass Counter(MetricWrapperBase): def _metric_init(self) -\u0026gt; None: self._value = values.ValueClass(self._type, self._name, self._name + \u0026#39;_total\u0026#39;, self._labelnames, self._labelvalues, self._documentation) å‰é¢æˆ‘å€‘æœ‰èªªéï¼ŒCounter çš„å¯¦éš›è®€å¯«æ˜¯é€é values.ValueClassï¼Œä¸¦ä¸”åœ¨ import çš„æ™‚å€™è¢«æŒ‡å®šç‚º MultiProcessValue()ã€‚\ndef MultiProcessValue(process_identifier=os.getpid): \u0026#34;\u0026#34;\u0026#34;Returns a MmapedValue class based on a process_identifier function. The \u0026#39;process_identifier\u0026#39; function MUST comply with this simple rule: when called in simultaneously running processes it MUST return distinct values. Using a different function than the default \u0026#39;os.getpid\u0026#39; is at your own risk. \u0026#34;\u0026#34;\u0026#34; files = {} values = [] pid = {\u0026#39;value\u0026#39;: process_identifier()} # Use a single global lock when in multi-processing mode # as we presume this means there is no threading going on. # This avoids the need to also have mutexes in __MmapDict. lock = Lock() class MmapedValue: \u0026#34;\u0026#34;\u0026#34;A float protected by a mutex backed by a per-process mmaped file.\u0026#34;\u0026#34;\u0026#34; _multiprocess = True def __init__(self, typ, metric_name, name, labelnames, labelvalues, help_text, multiprocess_mode=\u0026#39;\u0026#39;, **kwargs): with lock: ... self.__reset() ... def __reset(self): typ, metric_name, name, labelnames, labelvalues, help_text, multiprocess_mode = self._params file_prefix = typ if file_prefix not in files: filename = os.path.join( os.environ.get(\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;), \u0026#39;{}_{}.db\u0026#39;.format(file_prefix, pid[\u0026#39;value\u0026#39;])) files[file_prefix] = MmapedDict(filename) self._file = files[file_prefix] self._key = mmap_key(metric_name, name, labelnames, labelvalues, help_text) self._value, self._timestamp = self._file.read_value(self._key) def inc(self, amount): ... def set(self, value, timestamp=None): ... def get(self): ... return MmapedValue å¯ä»¥çœ‹åˆ°å¯¦éš›ä¸Šï¼Œvalues.ValueClass æ˜¯ MmapedValue ã€‚\nMmapedValue çš„ __init__ æœƒå‘¼å«åˆ° __resetï¼Œè€Œ __reset æœƒå¯¦ä¾‹åŒ–ä¸€å€‹ MmapedDictï¼Œç”± MmapedDict ä¾†èˆ‡å¯¦éš›çš„æª”æ¡ˆäº’å‹•æ“ä½œã€‚\nå¯ä»¥ç™¼ç¾ï¼Œé€™é‚Šæœƒä½¿ç”¨ file_prefix ä½œç‚º keyï¼Œå°‡ MmapedDict ä¿å­˜åœ¨ files é€™å€‹ dictionary ä¸­ï¼Œfile_prefix å¯¦éš›ä¸Šæ˜¯ Metrics çš„é¡å‹ï¼Œä¹Ÿå°±æ˜¯ Counterã€Gaugeã€Histogramã€Summary ç­‰ç­‰ã€‚ è€Œ files æ˜¯ä¿å­˜åœ¨ MultiProcessValue å‡½æ•¸çš„ä¸Šä¸‹æ–‡ç•¶ä¸­çš„ï¼Œå› ç‚º MultiProcessValue åªæœƒåœ¨ values.py è¢« import å¾—æ™‚å€™è¢«åŸ·è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥æ¯å€‹é¡å‹ metrics çš„ MmapedDict éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚\n### prometheus_client/values.py def get_value_class(): # Should we enable multi-process mode? # This needs to be chosen before the first metric is constructed, # and as that may be in some arbitrary library the user/admin has # no control over we use an environment variable. if \u0026#39;prometheus_multiproc_dir\u0026#39; in os.environ or \u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39; in os.environ: return MultiProcessValue() else: return MutexValue ValueClass = get_value_class() ç•¶æˆ‘å€‘ç¬¬ä¸€æ¬¡å¯«å…¥ Counter æ™‚ï¼Œ_metric_init æœƒè¢«è§¸ç™¼å»ºç«‹ MmapedDict å¯¦ä¾‹ï¼Œå°‡æª”æ¡ˆé€é MMAP æ˜ å°„åˆ°è¨˜æ†¶é«”ä¸­æ“ä½œï¼Œå¾ŒçºŒæ‰€æœ‰ Counter çš„æ“ä½œéƒ½æœƒé€éé€™å€‹ MmapedDict ä¾†æ“ä½œæª”æ¡ˆã€‚\nå› ç‚ºå¯¦éš›ä¸Šæ˜¯é€é MMAP æ“ä½œï¼ŒåŠ ä¸Šé€™å€‹ä¹Ÿåªæ˜¯è‡¨æ™‚æª”æ¡ˆï¼Œæ‰€ä»¥æ‰æœƒå»ºè­°å°‡æª”æ¡ˆæ”¾ç½®åœ¨ /dev/shm é€™å€‹ç´”è¨˜æ†¶é«”çš„æª”æ¡ˆç³»çµ±ä¸­ï¼Œæé«˜ IO æ•ˆèƒ½ã€‚\nå¦‚æœå¯¦éš›å»çœ‹ Counter çš„åŸå§‹ç¢¼ï¼Œæœƒç™¼ç¾åœ¨ Couter çš„ base MetricWrapper ï¼Œ__init__ æœƒå‘¼å« _metric_initï¼Œä½†æ˜¯æœƒå…ˆéä¸€å€‹åˆ¤æ–·æ˜¯æœƒå…ˆéä¸€å€‹åˆ¤æ–·æ˜¯ï¼Œif self._is_observable()ï¼Œå¯¦éš›ä¸Šé€™å€‹æ•¸å€¼æœƒæ˜¯ Falseï¼Œå°è‡´ _metric_init ä¸å‚™å‘¼å«ã€‚Prometheus çš„è¨­è¨ˆæ˜¯æ¯æ¬¡å‘¼å« counter.labes(...) çš„æ™‚å€™ï¼Œæœƒç‚ºæ¯çµ„ä¸åŒçš„ labelsï¼Œæœƒå»ºç«‹ä¸€å€‹ Counter å¯¦ä¾‹ï¼Œé€™å€‹å­å¯¦ä¾‹çš„ Observable æ‰æœƒæ˜¯ Trueï¼Œæ‰æœƒå‘¼å« _metric_initã€‚\n@pytest.fixture() def clean_metrics(): for filename in glob.glob(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]+\u0026#39;/*\u0026#39;): os.remove(filename) yield for filename in glob.glob(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]+\u0026#39;/*\u0026#39;): os.remove(filename) å‡è¨­ï¼Œæˆ‘å€‘ middleware çš„ test ä¸æ˜¯ç¬¬ä¸€å€‹åŸ·è¡Œçš„ï¼Œç•¶å…¶ä»–æ¸¬è©¦é€²è¡Œæ™‚ï¼Œå°±æœƒè¨˜éŒ„åˆ° http_requests_total çš„ Counterï¼Œå°è‡´ MmapedDict è¢«å»ºç«‹ã€‚ç•¶åŸ·è¡Œåˆ°æˆ‘å€‘çš„æ¸¬è©¦æ™‚ï¼Œclean_metricsæœƒæŠŠå°æ‡‰çš„æª”æ¡ˆåˆªé™¤ï¼Œä½†æ˜¯ MmapedDict ä¸æœƒè¢«åˆªé™¤ï¼Œå› æ­¤ç•¶ mddleware çš„ test åŸ·è¡Œæ™‚ï¼Œå¯¦éš›ä¸Šå°±ä¸æœƒå¯«å…¥åˆ°ä»»ä½•åœ°æ–¹ï¼ŒåŒæ™‚å› ç‚ºåªæ˜¯ MMAP è¨˜æ†¶é«”å°æ‡‰çš„æª”æ¡ˆæ¶ˆå¤±ï¼Œ MmapedDict ä¹Ÿä¸æœƒå ±éŒ¯ã€‚ å› ç‚ºï¼Œpytest åŸ·è¡Œä¸åŒçš„ test å¯¦éš›ä¸Šä¸æœƒé‡æ–° importï¼Œæ‰€ä»¥ MmapedDict ä¸æœƒè¢«é‡æ–°å»ºç«‹ã€‚\nè§£æ±ºæ–¹æ¡ˆ # æœ€å¾Œæƒ³åˆ°ä¸€å€‹æ¯”è¼ƒç°¡å–®çš„æ–¹æ¡ˆï¼Œä¾†è®“æ¸¬è©¦é€šéï¼Œå°±æ˜¯åªåœ¨æ¸¬è©¦å¾Œåˆªé™¤æª”æ¡ˆã€‚\n@pytest.fixture() def clean_metrics(): yield for filename in glob.glob(os.environ[\u0026#39;PROMETHEUS_MULTIPROC_DIR\u0026#39;]+\u0026#39;/*\u0026#39;): os.remove(filename) é€™æ¨£å¯ä»¥ç¢ºæ¯æ¬¡æ¸¬è©¦å¾Œï¼Œéƒ½ä¸æœƒç•™ä¸‹ä»»ä½• metrics çš„æª”æ¡ˆï¼Œå› ç‚ºåŸ·è¡Œå¾ŒçºŒå…¶ä»–æ¸¬è©¦é …ç›®æ™‚ï¼Œä¹Ÿä¸æœƒé‡å»ºæª”æ¡ˆï¼Œåæ­£ metrics çš„è³‡æ–™å°æ–¼å…¶ä»–å–®å…ƒæ¸¬è©¦ä¾†èªªç„¡æ„ç¾©ã€‚å¦å¤–ï¼Œæˆ‘å€‘çš„å–®å…ƒæ¸¬è©¦æœƒæª¢æŸ¥ä¸€å€‹ç‰¹æ®Šçš„ metrics http_requests_total{endpoint=\u0026quot;/metrics/\u0026quot;,method=\u0026quot;GET\u0026quot;}ï¼Œæˆ‘å€‘å¯ä»¥ç¢ºä¿å…¶ä»–æ¸¬è©¦ä¸æœƒå‘¼å«åˆ° /metrics é€™å€‹ç«¯é»ï¼Œæ‰€ä»¥é€™å€‹æ¸¬è©¦ä¹Ÿä¸æœƒå—åˆ°å…¶ä»–æ¸¬è©¦å‘çš„å½±éŸ¿ã€‚\nçµè«– # åœ¨é€™æ¬¡ç´€éŒ„ä¸­ï¼Œæˆ‘å€‘æ¢è¨äº† Prometheus SDK çš„é‹ä½œåŸç†ã€‚Prometheus SDK é€éæª”æ¡ˆä¾†è¨˜éŒ„å„å€‹ Process çš„ metricsï¼Œä¸¦èšåˆèµ·ä¾†ç”¢ç”Ÿå¯¦éš›çš„ metrics è³‡æ–™ã€‚ PROMETHEUS_MULTIPROC_DIR æœƒæ±ºå®š metrics æª”æ¡ˆçš„ä¿å­˜ä½ç½®ï¼Œä¸¦åœ¨ import prometheus_client çš„æ™‚å€™ï¼ŒSDK æœƒæ ¹æ“šè©²è®Šæ•¸æ˜¯å¦è¨­ç½®ä¾†æ±ºå®š Couter è¦æ¡ç”¨ singleprocess é‚„æ˜¯ multiprocess çš„è¡Œç‚ºï¼Œæ‰€ä»¥è¦åœ¨ import ä¹‹å‰è¨­ç½®å¥½ç’°å¢ƒè®Šæ•¸ã€‚ MultiProcessCollector æœƒåœ¨åˆå§‹åŒ–çš„æ™‚å€™è®€å– PROMETHEUS_MULTIPROC_DIR ï¼Œä¸¦ä¸”åœ¨ä¹‹å¾Œçš„æ“ä½œéƒ½æœƒè®€å–é€™å€‹è³‡æ–™å¤¾ã€‚ Couter ç­‰è¨ˆæ•¸å™¨æœƒåœ¨ç¬¬ä¸€æ¬¡å¯«å…¥æ•¸å€¼æ™‚ï¼Œæ‰“é–‹æª”æ¡ˆå»ºç«‹ MMAPï¼Œæ¸¬è©¦åˆ‡æ›å¾Œï¼Œå› ç‚º pytest å¯¦éš›ä¸Šä¸æœƒé‡æ–° importï¼Œæ‰€ä»¥ MmapedDict ä¸æœƒè¢«åˆªé™¤ï¼Œå¦‚æœæª”æ¡ˆè¢«åˆªé™¤ï¼Œä¸¦ä¸æœƒå ±éŒ¯ï¼Œä½†ä¹Ÿä¸æœƒå»ºç«‹æ–°çš„æª”æ¡ˆã€‚\n","date":"February 19 2025","externalUrl":null,"permalink":"/posts/pitfalls-of-unit-testing-the-multiprocess-prometheus-python-client/","section":"æ–‡ç« ","summary":"","title":"å° Prometheus Python SDK åœ¨ Multi Process æ¨¡å¼ä¸‹é€²è¡Œå–®å…ƒæ¸¬è©¦çš„é™·é˜±","type":"posts"},{"content":"","date":"January 19 2025","externalUrl":null,"permalink":"/tags/golang/","section":"æ¨™ç±¤","summary":"","title":"Golang","type":"tags"},{"content":"","date":"January 19 2025","externalUrl":null,"permalink":"/tags/hugo/","section":"æ¨™ç±¤","summary":"","title":"Hugo","type":"tags"},{"content":" å‰è¨€ # Hugo æ˜¯ä¸€å€‹ Markdown çš„éœæ…‹ç¶²ç«™ç”Ÿæˆå™¨ã€‚ä¸åŒçš„ Markdown éœæ…‹ç¶²ç«™ç”Ÿæˆå™¨æœ¬è³ªä¸ŠåŠŸèƒ½éƒ½æ˜¯ä¸€æ¨£çš„ï¼Œéƒ½æ˜¯å°‡ Markdown è½‰æ›æˆ HTMLï¼Œç„¶å¾Œç”Ÿæˆä¸€å€‹éœæ…‹ç¶²ç«™ã€‚ä¸åŒéœæ…‹ç¶²ç«™ç”Ÿæˆå™¨çš„å·®ç•°å°±åœ¨æ–¼å®ƒæ‰€ä½¿ç”¨çš„æ¨¡æ¿ (Template) æ©Ÿåˆ¶ï¼Œhexo ä½¿ç”¨çš„æ˜¯ ejs æ¨¡æ¿ï¼Œvuepress ç›´æ¥ä½¿ç”¨ Vue.js æ­é… SSR ä¾†ç”Ÿæˆç¶²ç«™ï¼Œè€Œ Hugo ä½¿ç”¨çš„æ˜¯ Go èªè¨€çš„ text/template æ¨¡çµ„ã€‚ä¸åŒçš„ Template æ©Ÿåˆ¶ç›´æ¥æ±ºå®šäº†æ€éº¼å»é–‹ç™¼ä¸€å€‹éœæ…‹ç¶²ç«™çš„ä¸»é¡Œï¼Œä»¥åŠæ€éº¼å»æ“´å±•ä¸»é¡Œçš„åŠŸèƒ½ã€‚é€™ç¯‡æ–‡ç« å°‡æœƒå¸¶æ‚¨äº†è§£ Hugo çš„ Template æ©Ÿåˆ¶ï¼Œäº†è§£å¦‚ä½•å»è¦†è“‹ã€æ“´å±•ä¸»é¡Œçš„çµæ§‹åŠæ¨£å¼ï¼Œå¢åŠ è‡ªå·±çš„é é¢ã€åŠŸèƒ½ã€‚\ngolang text/template æ¨¡çµ„ # ä¸€å€‹åŸºæœ¬çš„éƒ¨è½å€‹ç¶²é  HTML çµæ§‹æ˜¯ç”±è¨±å¤šå€‹å°å€å¡Šæ‰€çµ„æˆçš„ï¼ŒHTML æœ€åŸºæœ¬çš„çµæ§‹åŒ…å«äº† head è·Ÿ bodyï¼Œè€Œ body æ ¹æ“šç¶²é é¡¯ç¤ºçš„æ¶æ§‹ï¼Œé€šå¸¸åˆæœƒåˆ†æˆ header, main, footer ç­‰ç­‰å€å¡Šï¼Œä¸åŒçš„é é¢å¯èƒ½æœƒå…±ç”¨å…¶ä¸­éƒ¨åˆ†çš„å€å¡Šï¼Œä¹Ÿå¯èƒ½æœƒæœ‰è‡ªå·±ç¨ç«‹çš„å€å¡Šï¼Œé€™äº›å€å¡Šå¦‚åŒæ‹¼åœ–ä¸€èˆ¬çš„æ§‹æˆåœ¨ä¸€èµ·ã€‚\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; ... \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;header\u0026gt; ... \u0026lt;/header\u0026gt; \u0026lt;main\u0026gt; \u0026lt;article\u0026gt; ... \u0026lt;/article\u0026gt; \u0026lt;/main\u0026gt; \u0026lt;footer\u0026gt; ... \u0026lt;/footer\u0026gt; \u0026lt;/body\u0026gt; æ¯”å¦‚èªªï¼Œæ‰€æœ‰çš„\u0026quot;æ–‡ç« \u0026quot;é é¢ï¼ŒåŸºæœ¬ä¸Šåªæ˜¯åœ¨å…§å®¹ä¸Šæœ‰æ‰€å·®ç•°ï¼Œæ‰€æœ‰ä»‹é¢çš„çµæ§‹éƒ½æ˜¯ä¸€æ¨£çš„ï¼Œå¯æ˜¯é¦–é çš„æ•´å€‹ main å€å¡Šå°±èˆ‡æ–‡ç« é é¢ä¸åŒï¼Œä½†æ˜¯ footer è·Ÿ header éƒ½æœ‰æ‰€ä¸åŒã€‚Hugo å°±è—‰ç”±äº† Golang çš„ template æ¨¡çµ„ï¼Œè®“æˆ‘å€‘å¯ä»¥åƒæ‹šæ‹šåœ–ä¸€æ¨£çš„æŠŠæ‰€æœ‰çš„ä¸åŒå€å¡Šçµ„åˆåœ¨ä¸€èµ·ï¼Œæ§‹æˆæ¯å€‹é é¢ã€‚\nåŸºæœ¬ä»‹ç´¹ # Hugo ä½¿ç”¨äº† Go çš„ template æ¨¡çµ„ï¼Œå› æ­¤è¦äº†è§£ Hugo çš„é‹ä½œå°±å¿…é ˆè¦çŸ¥é“ golang çš„ template æ¨¡çµ„æ˜¯æ€éº¼é‹ä½œçš„ï¼Œä½†æ˜¯é€™é‚Šåªæœƒç°¡å–®çš„ä»‹ç´¹ä¸€ä¸‹ï¼Œå»ºè­°é‚„æ˜¯éœ€è¦å…ˆå»äº†è§£å­¸ç¿’ Golang çš„ template æ¨¡çµ„ã€‚\nåœ¨ Golang çš„æ¨¡æ¿ä¸­ï¼Œç”¨é›™å¤§æ‹¬è™Ÿ {{ }} ä¾†æ¨™è¨˜å¸¶æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„å€å¡Šï¼Œæ¯”å¦‚èªªè®Šæ•¸ã€å‡½æ•¸ã€æ¢ä»¶åˆ¤æ–·ã€è¿´åœˆç­‰ç­‰ã€‚\nHello, {{ .Title }} æ¯”å¦‚èªªåœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œ{{ .Title }} è¡¨ç¤ºè¦æ¸²æŸ“ä¸€å€‹è®Šæ•¸ï¼Œåç¨±æ˜¯Titleï¼Œé€™å€‹è®Šæ•¸æ˜¯åœ¨æ¸²æŸ“æ¨¡æ¿æ™‚å‚³å…¥çš„ï¼Œå‡è¨­å‚³å…¥çš„æ•¸å€¼æ˜¯Worldï¼Œé‚£éº¼é€™å€‹æ¨¡æ¿å°±æœƒæ¸²æŸ“æˆHello, Worldã€‚\n{{ if .IsHome }} \u0026lt;h1\u0026gt;Home\u0026lt;/h1\u0026gt; {{ else }} \u0026lt;h1\u0026gt;Not Home\u0026lt;/h1\u0026gt; {{ end }} åœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œ{{ if .IsHome }} è¡¨ç¤ºè¦é€²è¡Œä¸€å€‹æ¢ä»¶åˆ¤æ–·ï¼Œå¦‚æœ.IsHomeç‚ºçœŸï¼Œå‰‡æ¸²æŸ“\u0026lt;h1\u0026gt;Home\u0026lt;/h1\u0026gt;ï¼Œå¦å‰‡æ¸²æŸ“\u0026lt;h1\u0026gt;Not Home\u0026lt;/h1\u0026gt;ã€‚\nBlock # ç‚ºäº†è¦è®“ä¸»é¡Œé–‹ç™¼è€…ï¼Œå¯ä»¥ä»¥æ‹šç©æœ¨çš„æ–¹å¼ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹æ–¹å¼å»å®šç¾©æ¯ä¸€å€‹ç©æœ¨çš„é•·ç›¸ï¼Œç„¶å¾Œå®šç¾©å¦‚ä½•å°‡é€™äº›ç©æœ¨æ‹¼è£åœ¨ä¸€èµ·ã€‚\nåœ¨ golang è£¡é¢ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ define ä¾†å®šç¾©ä¸€å€‹ç©æœ¨ï¼Œç„¶å¾Œåœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ block ä¾†å¼•ç”¨é€™å€‹ç©æœ¨ã€‚\n{{ define \u0026#34;header\u0026#34; }} \u0026lt;header\u0026gt; ... \u0026lt;/header\u0026gt; {{ end }} åœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘å®šç¾©äº†ä¸€å€‹åç‚ºheaderçš„ç©æœ¨ï¼Œç„¶å¾Œåœ¨å…¶ä»–åœ°æ–¹å¯ä»¥ä½¿ç”¨blockä¾†å¼•ç”¨é€™å€‹ç©æœ¨ã€‚\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; {{ block \u0026#34;header\u0026#34; . }}default content{{ end }} \u0026lt;/html\u0026gt; æœ€å¾Œæ¸²æŸ“å‡ºä¾†çš„çµæœå°±æ˜¯\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;header\u0026gt; ... \u0026lt;/header\u0026gt; \u0026lt;/html\u0026gt; ä¸€äº›ä½¿ç”¨é golang template çš„äººæ¯”è¼ƒç†Ÿæ‚‰å¯èƒ½æ˜¯ç”¨ {{ template \u0026quot;header\u0026quot; . }} ä¾†æ’å…¥å…§å®¹ï¼Œå·®åˆ¥åœ¨æ–¼åœ¨ block ä¸­å¯ä»¥å®šç¾©ä¸€å€‹é è¨­å…§å®¹ï¼Œå¦‚æœæ²’æœ‰ä»»ä½•åœ°æ–¹å®šç¾©headerï¼Œå‰‡æœƒä½¿ç”¨é è¨­å…§å®¹ã€‚\nHugo Template æ©Ÿåˆ¶ # æ¸²æŸ“é‚è¼¯ # Hugo æ˜¯å»ºç¯‰åœ¨ Golang çš„ template æ¨¡çµ„ä¹‹ä¸Šçš„ï¼ŒHugo æ±ºå®šäº†ä¸€å€‹å°æ–¼ä¸€å€‹ m arkdown æ–‡ä»¶ï¼Œè¦å»ä½¿ç”¨å“ªä¸€äº› Template æª”æ¡ˆï¼Œä»¥åŠå¦‚ä½•å»æ¸²æŸ“é€™äº›æ¨¡æ¿ï¼ŒåŒæ™‚ä¹Ÿè¦ç¯„äº†ä¸€äº›æ¨¡æ¿çµæ§‹çš„åŸå‰‡ã€‚\nåœ¨è¨è«–ä¸åŒçš„é é¢é¡å‹ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆçœ‹ä¸€å€‹æœ€åŸºæœ¬çš„ç¯„ä¾‹ï¼Œhugo çš„æ‰€æœ‰æ¨¡æ¿éƒ½æ”¾åœ¨layoutsè³‡æ–™å¤¾ä¸­ï¼Œå…¶ä¸­æœ€åŸºç¤çš„æ˜¯ layouts/_default/baseof.htmlè·Ÿlayouts/_default/single.htmlã€‚\nlayouts/_default/baseof.html æ˜¯ hugo æ¸²æŸ“æ‰€æœ‰ html é é¢çš„æ™‚å€™çš„åŸºç¤æ¨¡ç‰ˆ (Base Template)ï¼Œé€™å€‹æ¨¡æ¿å®šç¾©äº†ç¶²é çš„æœ€åŸºç¤çµæ§‹ï¼Œhugo ç”¢ç”Ÿ HTML é é¢å°±æ˜¯å»æ¸²æŸ“é€™å€‹åŸºç¤æ¨¡æ¿ã€‚\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;{{ block \u0026#34;title\u0026#34; . }} \u0026lt;!-- Blocks may include default content. --\u0026gt; {{ .Site.Title }} {{ end }}\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!-- Code that all your templates share, like a header --\u0026gt; {{ block \u0026#34;main\u0026#34; . }} \u0026lt;!-- The part of the page that begins to differ between templates --\u0026gt; {{ end }} {{ block \u0026#34;footer\u0026#34; . }} \u0026lt;!-- More shared code, perhaps a footer but that can be overridden if need be in --\u0026gt; {{ end }} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; æ¯”å¦‚èªªï¼Œåœ¨ hugo æ–‡ä»¶ä¸­çš„é€™å€‹ç¯„ä¾‹ï¼Œå®šç¾©äº†ä¸€å€‹æœ€åŸºæœ¬æ¡†æ¶ã€‚ .Site.Titleç­‰è®Šæ•¸æ˜¯åœ¨æ¸²æŸ“æ™‚ hugo å‚³å…¥çš„è³‡è¨Šã€‚\nåŒæ™‚é€™å€‹æ¨¡æ¿å¡«å…¥äº† main å’Œ footer é€™å…©å€‹ blockã€‚Hugo æœƒæŒ‰ç…§ç‰¹å®šçš„è¦å‰‡ã€è¼‰å…¥å»å°‹æ‰¾å¯èƒ½å®šç¾©é€™äº›ç©æœ¨çš„æª”æ¡ˆï¼Œæœå°‹çš„è¦å‰‡æˆ‘å€‘ç¨å¾Œåœ¨è¨è«–ã€‚å°æ–¼æ–‡ç« é é¢ï¼Œhugo æœƒè¼‰å…¥ layouts/_default/single.html é€™å€‹æª”æ¡ˆã€‚\n{{ define \u0026#34;main\u0026#34; }} \u0026lt;article\u0026gt; \u0026lt;h1\u0026gt;{{ .Title }}\u0026lt;/h1\u0026gt; {{ .Content }} \u0026lt;/article\u0026gt; {{ end }} å› æ­¤ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ layouts/_default/single.html ä¸­å®šç¾© main é€™å€‹ blockã€‚å¯ä»¥çœ‹åˆ°é€™é‚Šå¡«å…¥äº†Contenté€™å€‹è®Šæ•¸ï¼Œé€™å€‹è®Šæ•¸æ˜¯ hugo å°‡ markdown è½‰æ›æˆçš„ html å…§å®¹ï¼Œé€™é‚Šæˆ‘å€‘å°‡å…¶å¸¶å…¥åˆ°\u0026lt;article\u0026gt;æ¨™ç±¤ä¸­ï¼Œå°±å¯ä»¥é¡¯ç¤ºæ–‡ç« çš„å…§å®¹ï¼Œç•¶ç„¶ markdown æ–‡ä»¶å…·é«”è¦æ€éº¼è¢«æ¸²æŸ“æˆ htmlï¼Œä¹Ÿæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œé€™å€‹æˆ‘å€‘å¾Œé¢å†è«‡ã€‚\né€™æ¨£ä¸€ä¾†ï¼Œç•¶æˆ‘å€‘æ‰“é–‹ä¸€ç¯‡æ–‡ç« çš„ç¶²å€æ™‚ï¼Œhugo å°±å¯ä»¥å®Œæˆ htmlï¼Œä¸¦çœ‹åˆ° markdown æ–‡ä»¶çš„å…§å®¹äº†ã€‚\nMarkdown æ–‡ä»¶å±¬æ€§ # ç¾åœ¨æˆ‘å€‘çŸ¥é“äº† hugo æ˜¯å¦‚ä½•å»æ¸²æŸ“ä¸€å€‹é é¢çš„ï¼Œä½†æ˜¯ä¸€å€‹éƒ¨è½æ ¼æ–‡ç« ä¸åªæ˜¯ç”±æ–‡ç« é é¢æ‰€çµ„æˆï¼Œé‚„åŒ…å«äº†é¦–é ã€åˆ†é¡é ã€æ¨™ç±¤é ç­‰ç­‰ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦ç”±ä¸åŒçš„æª”æ¡ˆå»å®šç¾©å°æ‡‰çš„ \u0026ldquo;main\u0026rdquo; blockï¼Œç„¶å¾Œç”± hugo æ ¹æ“šä¸åŒçš„é é¢é¡å‹å»è¼‰å…¥ä¸åŒçš„æª”æ¡ˆã€‚\nHugo éƒ¨è½æ ¼çš„å…§å®¹ç”± content ç›®éŒ„ä¸‹çš„ markdown æ–‡ä»¶æ‰€çµ„æˆï¼Œå°æ–¼æ¯å€‹ markdown æ–‡ä»¶ï¼Œéƒ½æœƒæœ‰å„è‡ªçš„ Kindï¼ŒTypeï¼ŒLayout ä¸‰å€‹å±¬æ€§å»å…±åŒæ±ºå®šäº†ï¼Œé€™å€‹ markdown æ–‡ä»¶è¦è¼‰å…¥å“ªä¸€äº›æ¨¡æ¿æª”æ¡ˆï¼Œå®Œæˆæ¸²æŸ“ã€‚\nKind # Kind æ˜¯æŒ‡å¹¾å€‹ hugo å®šç¾©çš„ç‰¹å®šé¡å‹ home, page, section, taxonomy, or termã€‚\nhome ä»£è¡¨çš„æ˜¯é¦–é ï¼Œcontent/_index.md å°±æœƒè¢«è¨­å®šæˆ Kind: homeã€‚ page å°±æ˜¯åŸºæœ¬çš„ç¨ç«‹é é¢å’Œæ–‡ç« é é¢ï¼Œæ¯”å¦‚èªª content/about.md å°±æœƒè¢«è¨­å®šæˆ Kind: pageã€‚ section ä»£è¡¨çš„æ˜¯ä¸€å€‹åˆ—è¡¨é ï¼Œä¸€èˆ¬å­ç›®éŒ„ä¸­çš„ _index.md æœƒè¢«è¨­å®šæˆ Kind: sectionï¼Œæ¯”å¦‚èªª content/posts/_index.mdã€‚ taxonomy ä»£è¡¨çš„æ˜¯ä¸€å€‹åˆ†é¡åˆ—è¡¨é ï¼Œåœ¨å¸¸è¦‹çš„éƒ¨è½æ ¼æ¡†æ¶ä¸­ï¼Œæˆ‘å€‘æœƒä½¿ç”¨ tag æˆ– category ä¾†åˆ†é¡æ–‡ç« ï¼Œé€™äº›åˆ†é¡çš„åˆ—è¡¨é å°±æœƒè¢«è¨­å®šæˆ Kind: taxonomyï¼Œæ¯”å¦‚èªª content/tags/_index.mdã€‚ term ä»£è¡¨çš„æ˜¯ä¸€å€‹åˆ†é¡é ï¼Œæ¯”å¦‚èªªæœ‰ä¸€å€‹ tag æ˜¯ pythonï¼Œé‚£ content/tags/hugo.md å°±æœƒè¢«è¨­å®šæˆ Kind: termã€‚ Type # type æ˜¯å°æ–‡ç« çš„ä¸€ç¨®åˆ†é¡æ–¹å¼ï¼Œhugo æœƒé è¨­ä½¿ç”¨ content ä¸‹ï¼Œé ‚å±¤ç›®éŒ„çš„åç¨±ä½œç‚º typeï¼Œä¸éä¹Ÿå¯ä»¥ä½¿ç”¨ front matter ä¸­çš„ type ä¾†æŒ‡å®šã€‚æœ€å¸¸è¦‹çš„ content/posts ç›®éŒ„ä¸‹çš„æ–‡ç« æœƒè¢«è¨­ç½®ç‚º Type: postsï¼Œè€Œç›´æ¥æ”¾åœ¨ content ç›®éŒ„ä¸‹çš„æ–‡ç« æœƒè¢«è¨­ç½®ç‚º Type: pageï¼Œå¦‚ content/about.mdã€‚\nLayout # layout å‰‡æ˜¯å°ˆé–€ç”¨ä¾†æ§å¼é é¢æ¨£å¼çš„è®Šæ•¸ï¼Œé è¨­æƒ…æ³ä¸‹ layout æ˜¯ç©ºçš„ï¼Œè¦é€é front matter ä¾†æŒ‡å®šã€‚\næ¨¡æ¿è¼‰å…¥è¦å‰‡ # ä¸€å€‹ markdown æ–‡ä»¶çš„ Kind, Type, Layout é€™ä¸‰å€‹å±¬æ€§å…±åŒæ±ºå®šäº† hugo è¦è¼‰å…¥å“ªä¸€äº›æ¨¡æ¿æª”æ¡ˆã€‚\nåœ¨ hugo çš„æ–‡ä»¶ä¸­æœ‰å®Œæ•´çš„åˆ—èˆ‰ç¯„ä¾‹èªªæ˜ï¼Œé€™é‚Šæˆ‘å€‘åªå–ä¸€å€‹ä¾†ç•¶ä½œç¯„ä¾‹èªªæ˜ã€‚\nå‡è¨­æˆ‘å€‘æœ‰ä¸€ç¯‡æ–‡ç« çš„é é¢ content/cool/introduce-python.mdä¸¦é€é front mater æŒ‡å®šäº† layout: demolayoutï¼Œé‚£éº¼ hugo æœƒä¾åºå°‹æ‰¾ä»¥ä¸‹æª”æ¡ˆï¼š\nlayouts/cool/demolayout.html.html layouts/cool/single.html.html layouts/cool/demolayout.html layouts/cool/single.html layouts/_default/demolayout.html.html layouts/_default/single.html.html layouts/_default/demolayout.html layouts/_default/single.html å› ç‚º Kind æ˜¯ pageï¼Œæ‰€ä»¥æœƒæœå°‹ single.htmlã€‚å…¶ä»–çš„ Kind æœƒæœ‰ä¸åŒçš„æœå°‹é †çºŒï¼Œåœ¨é€™é‚Šä¸ä¸€ä¸€åˆ—èˆ‰ã€‚\nå¦å¤–å°æ–¼åŸºç¤æ¨¡æ¿ï¼Œhugo ä¹ŸæœƒæŒ‰ç…§ä¸€å®šçš„è¦å‰‡å»å°‹æ‰¾ï¼š\nlayouts/cool/single-baseof.html.html layouts/cool/baseof.html.html layouts/cool/single-baseof.html layouts/cool/baseof.html layouts/_default/single-baseof.html.html layouts/_default/baseof.html.html layouts/_default/single-baseof.html layouts/_default/baseof.html hugo æœƒè¼‰å…¥ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æ¨¡æ¿æª”æ¡ˆï¼Œä¸¦åˆ©ç”¨ç¬¬ä¸€å€‹æ‰¾åˆ°çš„åŸºç¤æ¨¡æ¿å»æ¸²æŸ“ï¼Œè¦ç‰¹åˆ¥æ³¨æ„åªæœ‰ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æ¨¡æ¿æª”æ¡ˆå’ŒåŸºç¤æ¨¡æ¿æª”æ¡ˆæœƒè¢«è¼‰å…¥ã€‚\nPartials # å¦‚åŒä¸Šé¢æ‰€èªªï¼Œhugo åªæœƒè¼‰å…¥ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æ¨¡æ¿æª”æ¡ˆï¼Œä½†æ˜¯é€™æ¨£æˆ‘å€‘å°±æ²’è¾¦æ³•åœ¨ä¸åŒçš„ layout å’Œé é¢é¡å‹ä¸­å»å…±ç”¨ä¸€äº›æ¨¡æ¿ç‰‡æ®µï¼Œé€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨ partials ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚\npartials æ˜¯æ”¾åœ¨ layouts/partials ç›®éŒ„ä¸‹çš„æ¨¡æ¿ç‰‡æ®µï¼Œé€™äº›ç‰‡æ®µä¸éœ€è¦ä½¿ç”¨ define åŒ…è£ï¼Œè€Œæ˜¯ç›´æ¥æ•´å€‹æª”æ¡ˆä»£è¡¨ä¸€å€‹æ¨¡æ¿ç‰‡æ®µã€‚\næˆ‘å€‘å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ partial ä¾†å¼•ç”¨é€™äº›æ¨¡æ¿ç‰‡æ®µã€‚\n{{ partial \u0026#34;header.html\u0026#34; . }} é€™æ¨£ä¸€ä¾†ï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨ä¸åŒçš„æ¨¡æ¿ä¸­å…±ç”¨ä¸€äº›ç‰‡æ®µäº†ã€‚\nä¸»é¡Œè¦†è“‹è¦†è“‹ # hugo çš„ä¸»é¡Œï¼Œå°±æ˜¯é€éå®šç¾©ä¸åŒçš„ layouts æª”æ¡ˆä¾†å®Œæˆä¸»é¡Œçš„é–‹ç™¼ã€‚è—‰ç”± hugo çš„ç‰¹æ€§æˆ‘å€‘å¯ä»¥åœ¨ä¸éœ€è¦ä¿®æ”¹ä¸»é¡ŒåŸå§‹æª”æ¡ˆçš„æƒ…æ³ä¸‹ï¼Œå»è¦†è“‹ä¸»é¡Œçš„æ¨£å¼ã€çµæ§‹ï¼Œç”šè‡³æ˜¯åŠŸèƒ½ã€‚\næˆ‘å€‘å¯ä»¥é€éåœ¨layoutsç›®éŒ„ä¸‹å®šç¾©èˆ‡ themes/\u0026lt;theme\u0026gt;/layouts åŒåçš„æª”æ¡ˆä¾†è“‹æ‰ä¸»é¡Œçš„æ¨£å¼ï¼Œé€™æ¨£ä¸€ä¾†ï¼Œhugo å°±æœƒä½¿ç”¨æˆ‘å€‘å®šç¾©çš„æª”æ¡ˆä¾†æ¸²æŸ“é é¢ï¼Œæˆ‘å€‘ä¹Ÿä¸éœ€è¦ç›´æ¥å»ä¿®æ”¹ä¸»é¡Œã€‚\né€™æ¨£çš„æ©Ÿåˆ¶å¸¶ä¾†äº†å…©å€‹å¥½è™•ã€‚é¦–å…ˆï¼Œæˆ‘å€‘å¯ä»¥å¾layoutsç›®éŒ„å¾—çŸ¥æ˜ç¢ºçŸ¥é“æˆ‘å€‘ä¿®æ”¹äº†å“ªäº›æª”æ¡ˆï¼Œè€Œä¸æ˜¯å»ç¿»éæ•´å€‹ä¸»é¡Œç›®éŒ„ã€‚å…¶æ¬¡ï¼Œæˆ‘å€‘å¯ä»¥ä¿æŒ theme ç›®éŒ„ä¸ä¿®æ”¹ï¼Œé€™æ¨£ä¸€ä¾†ï¼Œæˆ‘å€‘å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ›´æ–°ä¸»é¡Œï¼Œä¹Ÿä¸ç”¨æ“”å¿ƒæˆ‘å€‘çš„ä¿®æ”¹æœƒè¢«è¦†è“‹ã€‚\nå…¶ä»–ç‰¹æ®Šé é¢ # é™¤äº†ä¸Šè¿°çš„ home ä»¥å¤–ï¼Œå…¶å¯¦é‚„æœ‰ RSSã€404ã€sitemap ç­‰ç‰¹æ®Šé é¢ï¼Œé€™äº›é é¢çš„æ¨¡æ¿æª”æ¡ˆä¹Ÿæ˜¯å¯ä»¥è‡ªå®šç¾©çš„ï¼Œåªè¦åœ¨ layouts ç›®éŒ„ä¸‹å®šç¾©å°æ‡‰çš„æª”æ¡ˆå³å¯ã€‚\nMarkdown è™•ç† # Render Hooks # å‰é¢ï¼Œæˆ‘å€‘è¬›è¿°äº† hugo æ€éº¼é€éæ¨¡æ¿æ©Ÿåˆ¶å»ºç«‹æ•´å€‹ç¶²é çš„æ¡†æ¶ï¼Œæ¥ä¸‹ä¾†æˆ‘æœƒèªªæ˜ä¸€ä¸‹é‚£ markdown æ–‡ä»¶çš„å…§å®¹æ˜¯æ€éº¼è¢«è½‰æ›æˆ html çš„ï¼Œä¸¦ä¸”æˆ‘å€‘è¦æ€éº¼å»ä¿®æ”¹é€™å€‹è½‰æ›éç¨‹ã€‚\nhugo æœƒè§£æ markdown æ–‡ä»¶çš„å…§å®¹ï¼Œä¸¦è§£ææˆä¸€å€‹å€‹çš„å…ƒç´ ã€‚\n[Hugo](https://gohugo.io) ![kitten](kitten.jpg) æ¯”å¦‚èªªé€™å€‹ markdown æ–‡ä»¶ï¼Œhugo æœƒè§£ææˆä¸€å€‹é€£çµå…ƒç´ ï¼Œä¸€å€‹åœ–ç‰‡å…ƒç´ ç­‰ç­‰ï¼Œæ¥è‘—å°æ–¼æ¯å€‹å…ƒç´ ï¼Œhugo å°±åŒæ¨£å¯ä»¥é€éæ¨¡æ¿å»æ¸²æŸ“ã€‚\nå°æ–¼æ¯å€‹å…ƒç´ é¡å‹æ‡‰è©²æ€éº¼å»æ¸²æŸ“ï¼Œåœ¨ hugo ä¸­ç¨±ä¹‹ç‚º render hooksï¼Œæˆ‘å€‘åŒæ¨£å¯ä»¥é€éè‡ªå®šç¾©çš„æ¨¡æ¿å»è¦†è“‹æ‰é è¨­çš„ render hooksï¼Œä¾†ä¿®æ”¹å…ƒç´ çš„æ¸²æŸ“æ–¹å¼ã€‚\nrender hooks æ”¾ç½®åœ¨ layouts/_default/_markuip/render-\u0026lt;element\u0026gt;.html ä¸­ï¼Œæ¯”å¦‚èªªå°æ–¼é€£çµå…ƒç´ ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ layouts/_default/_markup/render-link.html ä¸­å®šç¾©å¦‚ä½•å»æ¸²æŸ“é€£çµå…ƒç´ ã€‚\nå°æ–¼æ¯å€‹å…ƒç´  hugo æœƒå‚³å…¥ä»€éº¼åƒæ•¸ï¼Œå¯ä»¥åƒè€ƒ hugo çš„æ–‡ä»¶ã€‚\n\u0026lt;a href=\u0026#34;{{ .Destination | safeURL }}\u0026#34; {{- with .Title }} title=\u0026#34;{{ . }}\u0026#34;{{ end -}} \u0026gt; {{- with .Text }}{{ . }}{{ end -}} \u0026lt;/a\u0026gt; é€™æ˜¯ä¸€å€‹æ¸²æŸ“é€£çµå…ƒç´ çš„ç¯„ä¾‹ã€‚\nShortcodes # Shortcodes å‰‡æ˜¯è®“æˆ‘å€‘å¯ä»¥é¡å¤–å®šç¾©ï¼Œå¯ä»¥åœ¨ mardown æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨çš„è‡ªå®šç¾©å…ƒç´ ã€‚\nå‡è¨­å»ºç«‹äº†ä¸€å€‹ layouts/shortcodes/audio.html\n{{ with resources.Get (.Get \u0026#34;src\u0026#34;) }} \u0026lt;audio controls preload=\u0026#34;auto\u0026#34; src=\u0026#34;{{ .RelPermalink }}\u0026#34;\u0026gt;\u0026lt;/audio\u0026gt; {{ end }} é‚£å€‘æˆ‘å€‘å°±å¯ä»¥åœ¨ markdown æ–‡ä»¶ä¸­ä½¿ç”¨ {{ \u0026lt; audio src=\u0026quot;audio/test.mp3\u0026quot; \u0026gt;}} ä¾†æ’å…¥ä¸€å€‹éŸ³æ¨‚æ’­æ”¾å™¨ã€‚\nhugo æœƒæŠŠå®ƒæ¸²æŸ“æˆ\u0026lt;audio controls preload=\u0026quot;auto\u0026quot; src=\u0026quot;/audio/test.mp3\u0026quot;\u0026gt;\u0026lt;/audio\u0026gt;ã€‚\nçµè«– # Hugo çš„æ¨¡æ¿æ©Ÿåˆ¶éå¸¸å¼·å¤§ï¼Œå®ƒè®“æˆ‘å€‘å¯ä»¥å¾ˆæ–¹ä¾¿çš„å»å®šç¾©ç¶²é çš„çµæ§‹ã€æ¨£å¼ï¼Œä¸¦ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿çš„å»æ“´å±•ä¸»é¡Œçš„åŠŸèƒ½ã€‚ä½†æ˜¯éœ€è¦å»ç†Ÿæ‚‰ä¸€ä¸‹ golang çš„ Template æ¨¡çµ„ï¼Œé‚„æœ‰ hugo çš„åŸ·è¡Œè¦å‰‡ï¼Œæ‰èƒ½å¤ æ›´å¥½çš„å»é–‹ç™¼æˆ‘å€‘çš„éƒ¨è½æ ¼ã€‚\n","date":"January 19 2025","externalUrl":null,"permalink":"/posts/hugo-template-mechanism/","section":"æ–‡ç« ","summary":"","title":"æ·±å…¥äº†è§£ Hugo çš„ Template æ©Ÿåˆ¶ï¼šçµæ§‹èˆ‡æ¸²æŸ“è¦å‰‡","type":"posts"},{"content":"","date":"January 18 2025","externalUrl":null,"permalink":"/tags/s3/","section":"æ¨™ç±¤","summary":"","title":"S3","type":"tags"},{"content":" ä»‹ç´¹ # S3 æ˜¯ AWS æä¾›çš„ç‰©ä»¶å„²å­˜æœå‹™ï¼Œç°¡å–®ä¾†èªªä¹Ÿå°±æ˜¯ä¸€å€‹æª”æ¡ˆå„²å­˜æœå‹™ã€‚ é€™ç¯‡æ–‡ç« å°‡æœƒè®“ä½ äº†è§£å¦‚ä½•ä½¿ç”¨ AWS çš„ Python SDK boto3 æ“ä½œ S3 APIï¼Œå¯¦ç¾æª”æ¡ˆä¸Šå‚³åŠŸèƒ½ï¼Œä¸¦æ·±å…¥æ¢è¨ S3 æä¾›çš„ Multipart Upload æ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬å…¶æ¦‚å¿µã€å„ªå‹¢èˆ‡ä½¿ç”¨æ–¹å¼ã€‚\nS3 çš„å„²å­˜çµæ§‹ä¸»è¦ç”± Bucket å’Œ Object çµ„æˆï¼š\nBucketï¼šå„²å­˜ç©ºé–“çš„ç®¡ç†å–®ä½ï¼Œé¡ä¼¼ç¡¬ç¢Ÿï¼Œå¯è¨­å®šå­˜å–æ¬Šé™èˆ‡å„²å­˜ç­–ç•¥ã€‚ Objectï¼šå¯¦éš›å„²å­˜çš„æª”æ¡ˆï¼Œæ¯å€‹ Object ç”±ä¸€å€‹å”¯ä¸€çš„ Key æ¨™è­˜ï¼Œæœ¬è³ªä¸Šé¡ä¼¼æ–¼æª”æ¡ˆè·¯å¾‘ï¼Œä¾‹å¦‚ folder1/folder2/file.txtã€‚ é–‹å§‹ä¹‹å‰ï¼Œå…ˆç¢ºä¿å·²å®‰è£ boto3ï¼Œé€™æ˜¯æ“ä½œ AWS API çš„ Python å·¥å…·ï¼š\npip install boto3 åœ¨ boto3 ä¸­ï¼Œå¯ä»¥ä½¿ç”¨é«˜éšï¼ˆhigh-levelï¼‰å’Œä½éšï¼ˆlow-levelï¼‰APIã€‚\nä½éš APIï¼šæ¯å€‹ function call ç›´æ¥å°æ‡‰ AWS æœå‹™çš„ HTTP APIï¼Œæä¾›æ›´ç´°ç·»çš„æ“ä½œæ§åˆ¶ã€‚ é«˜éš APIï¼šåœ¨ä½éš API åŸºç¤ä¸Šå°è£ï¼Œä½¿ç”¨æ›´ç°¡æ½”çš„ä»‹é¢å®Œæˆå¸¸è¦‹ä»»å‹™ã€‚ ä½¿ç”¨é«˜éš API ä¸Šå‚³æª”æ¡ˆ # ä»¥ä¸‹ç¯„ä¾‹å±•ç¤ºå¦‚ä½•åˆ©ç”¨ boto3 API å°‡æª”æ¡ˆä¸Šå‚³åˆ° S3ã€‚\né¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦å»ºç«‹ä¸€å€‹ S3 çš„å®¢æˆ¶ç«¯ï¼ˆclientï¼‰ï¼Œä¸¦ä¸»è¦è¨­å®š endpoint å’Œ access key/secret keyã€‚\nimport boto3 from boto3.s3.transfer import TransferConfig, KB import os endpoint = os.getenv(\u0026#39;ENDPOINT\u0026#39;) bucket_name = os.getenv(\u0026#39;BUCKET_NAME\u0026#39;) access_key_id = os.getenv(\u0026#39;ACCESS_KEY_ID\u0026#39;) secret_key = os.getenv(\u0026#39;SECRET_KEY\u0026#39;) # Create a session with the specified credentials session = boto3.session.Session( aws_access_key_id=access_key_id, aws_secret_access_key=secret_key ) # Create an S3 client with the specified endpoint s3_client = session.client(\u0026#39;s3\u0026#39;, endpoint_url=endpoint) Endpoint æ˜¯æŒ‡å‘ S3 ä¼ºæœå™¨çš„åœ°å€ã€‚ç”±æ–¼ S3 API å·²æˆç‚ºç‰©ä»¶å„²å­˜çš„å»£æ³›æ¨™æº–ï¼Œä¸åƒ… AWS æä¾›çš„ S3 æœå‹™ä½¿ç”¨æ­¤ APIï¼Œè¨±å¤šå…¶ä»–é›²ç«¯å„²å­˜è§£æ±ºæ–¹æ¡ˆä¹Ÿæä¾›å…¼å®¹çš„ S3 API æœå‹™ã€‚é€™æ„å‘³è‘—ï¼Œæˆ‘å€‘å¯ä»¥é€éè¨­å®š endpoint ä¾†æŒ‡å®šç›®æ¨™ä¼ºæœå™¨çš„ä½ç½®ï¼Œé€²è€Œä½¿ç”¨ boto3 æ“ä½œé€™äº›å…¼å®¹çš„æœå‹™ã€‚\nconfig = TransferConfig( multipart_threshold=KB * 25, max_concurrency=10, multipart_chunksize=1024 * 25, use_threads=True) objectKey = \u0026#34;file.txt\u0026#34; # Perform the multipart upload with open(\u0026#34;file.txt\u0026#34;, \u0026#39;rb\u0026#39;) as file: s3_client.upload_fileobj(file, bucket_name, objectKey, Config=config) ä½¿ç”¨ High-Level API ä¸Šå‚³æª”æ¡ˆéå¸¸ç°¡å–®ï¼Œåªéœ€ä¸€è¡Œç¨‹å¼ç¢¼å³å¯å®Œæˆã€‚æˆ‘å€‘åªéœ€æä¾› Bucket åç¨± å’Œ Object Keyï¼Œå³å¯å°‡æª”æ¡ˆé †åˆ©ä¸Šå‚³è‡³ S3ã€‚\nMultipart Upload # åœ¨é€™è£¡ï¼Œæˆ‘å€‘é¡å¤–å¥—ç”¨äº† transfer configï¼Œä»¥å•Ÿç”¨ Multipart Upload æ©Ÿåˆ¶ã€‚\nMultipart Upload æ˜¯ S3 API æä¾›çš„ä¸€ç¨®ä¸Šå‚³æ©Ÿåˆ¶ï¼Œç°¡å–®ä¾†èªªï¼Œå®ƒå°‡ä¸€å€‹å¤§æª”æ¡ˆåˆ†å‰²æˆå¤šå€‹å°å€å¡Šï¼ˆpartsï¼‰ï¼Œä¸¦åˆ†æ®µä¸Šå‚³ã€‚\næ ¹æ“š AWS æ–‡ä»¶çš„èªªæ˜ï¼Œé€™ç¨®æ©Ÿåˆ¶å…·æœ‰ä»¥ä¸‹å„ªå‹¢ï¼š\næå‡æ•ˆç‡ï¼šé€éå°‡æ¯å€‹ part å¹³è¡ŒåŒ–ä¸Šå‚³ï¼Œé¡¯è‘—æé«˜å¤§æª”æ¡ˆçš„ä¸Šå‚³é€Ÿåº¦ã€‚ æé«˜å¯é æ€§ï¼šé¿å…å› ç¶²è·¯æˆ–ä¼ºæœå™¨å•é¡Œå°è‡´æ•´å€‹æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼Œå› ç‚ºæ¯å€‹å€å¡Šå¯ä»¥ç¨ç«‹é‡å‚³ã€‚ å³æ™‚è™•ç†ï¼šç•¶æ‡‰ç”¨ä¸­çš„ä½¿ç”¨è€…ä¸Šå‚³å¤§æª”æ¡ˆæ™‚ï¼Œå¯ç›´æ¥è™•ç†æ¥æ”¶åˆ°çš„åˆ†æ®µæª”æ¡ˆï¼Œè€Œç„¡éœ€ç­‰å¾…æ•´å€‹æª”æ¡ˆå®Œæˆä¸Šå‚³ã€‚ Multipart Upload çš„æ“ä½œæµç¨‹ # å¾ S3 API çš„è§’åº¦ä¾†çœ‹ï¼Œä½¿ç”¨ Multipart Upload é€²è¡Œæª”æ¡ˆä¸Šå‚³ï¼Œéœ€è¦ä»¥ä¸‹ä¸‰å€‹æ­¥é©Ÿï¼š\nå»ºç«‹ä¸Šå‚³ä»»å‹™ï¼šä½¿ç”¨ CreateMultipartUpload æŒ‡å®šä¸Šå‚³è·¯å¾‘ï¼ˆObject Keyï¼‰ï¼Œå»ºç«‹ä¸Šå‚³ä»»å‹™ã€‚æ­¤æ™‚ï¼ŒS3 æœƒå›å‚³ä¸€å€‹å”¯ä¸€çš„ uploadIdï¼Œç”¨æ–¼è­˜åˆ¥è©²ä¸Šå‚³ä»»å‹™ã€‚\nåˆ†æ®µä¸Šå‚³ï¼šç¨‹å¼å°‡æª”æ¡ˆåˆ†å‰²ç‚ºå¤šå€‹å°å€å¡Šï¼Œä¸¦ä½¿ç”¨ UploadPart ä¸Šå‚³æ¯å€‹å€å¡Šï¼š\næ¯å€‹å€å¡Šæœ‰ä¸€å€‹å”¯ä¸€çš„ partNumberï¼Œç”±ç¨‹å¼æ±ºå®šã€‚ partNumber ä¸éœ€è¦é€£çºŒï¼Œä½†æœ€çµ‚å¿…é ˆæŒ‰é †åºæ’åˆ—ã€‚ å„å€å¡Šå¯å¹³è¡Œä¸Šå‚³ï¼Œç„¡éœ€ç­‰å¾…å‰ä¸€å€‹å€å¡Šå®Œæˆã€‚ å®Œæˆä¸Šå‚³ï¼šæœ€å¾Œï¼Œå‘¼å« CompleteMultipartUploadï¼Œå°‡ S3 æœƒå°‡æ‰€æœ‰å€å¡Šåˆä½µæˆå®Œæ•´æª”æ¡ˆï¼Œä¸¦å®Œæˆä¸Šå‚³ã€‚\nä¸­æ–·èˆ‡æ¸…ç†æ©Ÿåˆ¶ # è‹¥ä¸Šå‚³ä»»å‹™ä¸­æ–·æˆ–å¤±æ•—ï¼Œéƒ¨åˆ†å·²ä¸Šå‚³çš„å€å¡Šæœƒè¢«ä¿å­˜åœ¨ Object Storage ä¸­ï¼Œé€™äº›ç¨±ç‚º incomplete multipart uploadsã€‚å®ƒå€‘æœƒå ç”¨å­˜å„²ç©ºé–“ï¼Œå› æ­¤éœ€å®šæœŸæ¸…ç†ï¼š\næˆ‘å€‘å¯ä»¥ä¸»å‹•å‘¼å« AbortMultipartUpload å–æ¶ˆä¸Šå‚³ä»»å‹™ä¸¦åˆªé™¤ç„¡æ•ˆå€å¡Šã€‚ AWS ä¹Ÿæä¾› Lifecycle Policies ä¾†è¨­å®šå®šæ™‚æ¸…é™¤ incomplete multipart uploadsã€‚\nç•¶ç„¶ï¼Œboto3 çš„é«˜éš API å·²ç¶“å°‡æ•´å€‹ multipart upload çš„éç¨‹å°è£èµ·ä¾†ï¼Œä½¿ç”¨è€…ä¸éœ€è¦è‡ªå·±å»ç®¡ç† multipart upload çš„éç¨‹ï¼Œåªéœ€è¦æŠŠæª”æ¡ˆå‚³çµ¦ boto3 ä¸¦è¨­å®šå¥½ transfer configï¼Œä»–å°±æœƒè‡ªå‹•é€é multithreading ä¾†å®Œæˆå¤šå€‹å€å¡Šçš„ä¸Šå‚³ã€‚\né€éä½éš API å¯¦ç¾ Multipart Upload # ç•¶ç„¶ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥é€é boto3 æä¾›çš„ä½éš API ä¾†ï¼Œè‡ªè¡Œå®Œæˆåˆ†ç‰‡è·Ÿä¸Šå‚³ã€‚\nåœ¨ä½éš API ä¸­ï¼Œæ¯å€‹ S3 API è«‹æ±‚å°æ‡‰åˆ°ä¸€å€‹ boto3 çš„ function callã€‚\nresponse = s3_client.create_multipart_upload(Bucket=bucket_name, Key=objectKey) upload_id = response[\u0026#39;UploadId\u0026#39;] é¦–å…ˆï¼Œæˆ‘å€‘ä½¿ç”¨ create_multipart_upload å»ºç«‹ä¸€å€‹ä¸Šå‚³ä»»å‹™ï¼Œä¸¦å–å¾—å°æ‡‰çš„ uploadIdã€‚\nparts = [] with open(filename, \u0026#39;rb\u0026#39;) as file: for i in range(1, num_parts + 1): part_data = file.read(part_size) response = s3_client.upload_part( Bucket=bucket_name, Key=objectKey, PartNumber=i, UploadId=upload_id, Body=part_data ) parts.append({\u0026#39;PartNumber\u0026#39;: i, \u0026#39;ETag\u0026#39;: response[\u0026#39;ETag\u0026#39;]}) æ¥è‘—æˆ‘å€‘è®€å–è¦ä¸Šèˆ¹çš„æª”æ¡ˆï¼Œä¸¦å°‡æª”æ¡ˆåˆ†å‰²æˆå¤šå€‹å€å¡Šï¼Œé€é upload_part é€ä¸€ä¸Šå‚³ã€‚\nresponse = s3_client.complete_multipart_upload( Bucket=bucket_name, Key=objectKey, UploadId=upload_id, MultipartUpload={\u0026#39;Parts\u0026#39;: parts} ) æœ€å¾Œï¼Œæˆ‘å€‘ä½¿ç”¨ complete_multipart_upload å®Œæˆä¸Šå‚³ï¼Œæˆ‘å€‘å¯ä»¥åŒæ™‚å¸¶ä¸Šæ¯å€‹ Part ä¸Šå‚³å¾Œçš„ ETagï¼Œä»¥ç¢ºä¿æ‰€æœ‰å€å¡Šéƒ½å·²æˆåŠŸä¸Šå‚³ï¼Œåœ¨MultipartUpload={'Parts': parts}ä¸­æˆ‘å€‘é‚„å¯ä»¥å¸¶ä¸Šæ¯å€‹ Part çš„ Checksum æˆ–è‘—æä¾›æ•´å€‹æª”æ¡ˆçš„ Checksumï¼Œä»¥ç¢ºä¿æª”æ¡ˆçš„å®Œæ•´æ€§ã€‚\nå¦‚æœä¸­é€”ä¸Šèˆ¹å¤±æ•—äº†ï¼Œæˆ‘å€‘å¯ä»¥å‘¼å« s3 çš„ AbortMultipartUpload ä¾†å–æ¶ˆä¸Šå‚³ä»»å‹™ï¼Œä¸¦åˆªé™¤å·²ç¶“ä¸Šå‚³çš„å€å¡Šã€‚\n# Abort the multipart upload response = s3_client.abort_multipart_upload( Bucket=bucket_name, Key=object_key, UploadId=upload_id ) ç¸½çµ # ä»Šå¤©æˆ‘å€‘ä»‹ç´¹äº† S3 çš„ python SDK boto3ï¼Œä¸¦ä¸”æ·±å…¥æ¢è¨äº† S3 çš„ Multipart Upload æ©Ÿåˆ¶ï¼Œé€é Multipart Uploadï¼Œæˆ‘å€‘å¯ä»¥æ›´æœ‰æ•ˆç‡åœ°ä¸Šå‚³å¤§æª”æ¡ˆï¼Œæé«˜å¯é æ€§ï¼Œä¸¦ä¸”å³æ™‚è™•ç†æª”æ¡ˆã€‚ ç•¶ç„¶æ›´åŠ è©³ç´°çš„ä½¿ç”¨èªªæ˜ï¼Œå¯ä»¥åƒè€ƒ AWS S3 å’Œ boto3 çš„æ–‡ä»¶ã€‚\nåƒè€ƒè³‡æ–™ # boto3 AWS S3 API ","date":"January 18 2025","externalUrl":null,"permalink":"/posts/aws-s3-python-boto3-tutorial-with-multipart-upload/","section":"æ–‡ç« ","summary":"","title":"ç”¨ Python boto3 æ“ä½œ AWS S3ï¼šæª”æ¡ˆä¸Šå‚³èˆ‡ Multipart Upload æ©Ÿåˆ¶","type":"posts"},{"content":"å¾å®Œæˆå£è©¦åˆ°å®Œæˆç•¢æ¥­é›¢æ ¡æ˜¯ä¸€å€‹å¾ˆé•·ã€å¾ˆè¤‡é›œçš„æµç¨‹ï¼Œå› æ­¤æˆ‘å°‡æˆ‘ç•¢æ¥­ç¶“æ­·çš„æµç¨‹è¨˜éŒ„ä¸‹ä¾†ï¼Œå¸Œæœ›èƒ½å¤ å¹«åŠ©åˆ°äº¤å¤§è³‡å·¥æ‰€çš„å„ä½ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨ 2024 å¹´ç•¢æ¥­çš„æµç¨‹åŠå¿ƒå¾—ï¼Œå¸Œæœ›èƒ½è®“æœªä¾†çš„åŒå­¸å°ç•¢æ¥­æµç¨‹æœ‰å€‹æ¸…æ™°çš„æ¦‚å¿µã€‚\nä¸éè¦ç‰¹åˆ¥æ³¨æ„ï¼Œä¸åŒç³»æ‰€çš„è¦ç¯„å¯èƒ½æœƒæœ‰æ‰€ä¸åŒï¼ŒåŒå¯¦é©—å®¤ä½†æ˜¯æ›åœ¨ä¸åŒå­¸é™¢ä¸‹ä¹Ÿæœƒå·®å¾ˆå¤šï¼Œæ­¤å¤–è¦å®šä¹Ÿå¯èƒ½éš¨æ™‚é–“èª¿æ•´ï¼Œå› æ­¤é€™ä»½æ˜¯ 2024 è³‡ç§‘å·¥ç¢©ç”²çµ„çš„ç•¢æ¥­æµç¨‹ï¼Œåƒ…ä¾›åƒè€ƒã€‚\nä¸»è¦æµç¨‹æ˜¯æ ¹æ“šäº¤å¤§è³‡å·¥ç¶²ç«™çš„è«–æ–‡å£è©¦é ˆçŸ¥æš¨ç•¢æ¥­é›¢æ ¡èªªæ˜æ–‡ä»¶ï¼Œé€™ç¯‡æ–‡ç« ä¸»è¦æ˜¯é‡å°ä¸€äº›æ“ä½œç´°ç¯€è£œå……èªªæ˜ï¼Œæ‰€æœ‰éœ€è¦è¨ªå•çš„ç³»çµ±é€£çµå’Œæ–‡ä»¶éƒ½æœ‰åœ¨äº¤å¤§è³‡å·¥ç¶²ç«™è·Ÿèªªæ˜æ–‡ä»¶ä¸­ã€‚\nå£è©¦å‰æº–å‚™ # æ€§åˆ¥æ•™è‚²èˆ‡å­¸è¡“å€«ç† # é™¤äº†å®Œæˆç³»æ‰€çš„ä¿®èª²è¦æ±‚å¤–ï¼Œå­¸è¡“å€«ç†å’Œæ€§åˆ¥å¹³ç­‰æ•™è‚²èª²ç¨‹å»ºè­°ç¢©ä¸€æœ‰ç©ºå°±ç›¡æ—©å®Œæˆã€‚ç‰¹åˆ¥æ˜¯å­¸è¡“å€«ç†èª²ç¨‹ï¼Œå…§å®¹è¼ƒå¤šï¼Œé‚„æ˜¯éœ€è¦èŠ±äº›æ™‚é–“ã€‚å»ºè­°ä¸è¦æ‹–åˆ°ç•¢æ¥­å‰ï¼Œé¿å…ç•¢æ¥­æ™‚é–“æµç¨‹ç·Šè¿«é‚„è¦è™•ç†é€™ç¨®æ±è¥¿ã€‚å®Œæˆå¾Œï¼Œå¯åœ¨å­¸ç±æˆç¸¾ç®¡ç†ç³»çµ±çš„æˆç¸¾ç®¡ç†ä¸­ç¢ºèªæœ‰å…©å€‹ã€Œå·²é€šéã€çš„æ¨™ç¤ºã€‚\nç•¢æ¥­æ™‚é–“è¦åŠƒï¼šå­¸é›œè²»é€€è²» # æ­¤å¤–ï¼Œç‚ºäº†å¤§å®¶çš„éŒ¢åŒ…æ‰¾æƒ³ï¼Œå»ºè­°ç•™æ„ä¸€ä¸‹å­¸è²»é€€è²»çš„æ™‚æ®µã€‚å­¸æ ¡ä»¥å­¸æœŸä¸‰åˆ†ä¹‹ä¸€å’Œä¸‰åˆ†ä¹‹äºŒç‚ºç¯€é»å¯é€€éƒ¨åˆ†å­¸è²»ï¼Œå› æ­¤å¦‚æœæœ‰æ©Ÿæœƒçš„è©±ï¼Œç›¡é‡æŠŠç•¢æ¥­é›¢æ ¡çš„æ™‚é–“åœ¨é€€è²»æˆªæ­¢å‰ã€‚å…·é«”æ™‚é–“çœ‹å­¸æ ¡è¡Œäº‹æ›†ã€‚\nå£è©¦å‰ä¸‰å€‹æœˆï¼šæäº¤ç¢©å£«è«–æ–‡è¨ˆç•«æ›¸ # ç¬¬ä¸€æ­¥æ˜¯å£è©¦ä¸‰å€‹æœˆå‰ç¹³äº¤ç¢©å£«è«–æ–‡è¨ˆç•«æ›¸ã€‚è¨ˆç•«æ›¸å…§å®¹åŒ…æ‹¬è«–æ–‡åç¨±ï¼Œé‚„æœ‰ä¸€å€‹å€åŸŸå¡«å¯«è«–æ–‡èƒŒæ™¯èªªæ˜ã€æ–‡ç»ç¶œè¦½ã€ç ”ç©¶æ–¹æ³•ã€å¯¦é©—è¨­è¨ˆå’Œæ™‚ç¨‹å®‰æ’ç­‰è³‡è¨Šã€‚ç†æƒ³ä¸Šï¼Œé€™æ™‚å€™æ‡‰è©²å·²ç¶“æœ‰äº†è«–æ–‡çš„åŸºæœ¬æ¶æ§‹ï¼Œé€™ä»½æ–‡ä»¶ç„¡å­—æ•¸é™åˆ¶ï¼Œä¹Ÿä¸æœƒå½±éŸ¿åˆ°å¾Œé¢å£è©¦åŠæœ€å¾Œç¹³äº¤çš„è«–æ–‡ï¼Œå¡«ä¸Šç¾æœ‰çš„å…§å®¹å³å¯ã€‚å¦å¤–ï¼Œè¨ˆåŠƒæ›¸éœ€è¦**æ•™æˆç°½åã€‚**åŸºæœ¬ä¸Šï¼Œèˆ‡è«–æ–‡ç›¸é—œçš„æ–‡ä»¶å¯ç”¨é›»å­ç°½åçš„æ–¹å¼ç·šä¸Šç°½å¥½ï¼Œå†å°ä¸‹ä¾†ç¹³äº¤ï¼Œè€Œæœ‰äº›æ–‡ä»¶ä¹Ÿå¯ç”¨ email å¯„çµ¦ç³»è¾¦ã€‚\nå¦‚æœæ²’æœ‰åœ¨ä¸‰å€‹æœˆå‰ç¹³äº¤ï¼ŒåŠ©ç†å°±æœƒåœ¨ä½ ç”³è«‹å£è©¦å¾Œï¼Œå¯„ä¿¡å«ä½ å»ç³»è¾¦åšä¸‰å°æ™‚çš„ç¾©å‹™å·¥è®€æœå‹™ã€‚å·¥è®€éœ€é€£çºŒä¸‰å°æ™‚ï¼Œéœ€è¦åœ¨ä¸Šåˆä¹é»å‰æˆ–ä¸‹åˆä¸€é»å¾Œé–‹å§‹ï¼Œä¸ç„¶æœƒæ’åˆ°ç³»è¾¦åˆä¼‘æ™‚é–“ã€‚\nå£è©¦å‰ä¸€å€‹æœˆï¼šç¢ºèªå£è©¦ç´°ç¯€ # å£è©¦å‰ä¸€å€‹æœˆéå¸¸é‡è¦ã€‚ä¾è³‡å·¥æ‰€è¦å®šï¼Œéœ€æ–¼å£è©¦21 å¤©å‰æäº¤å£è©¦ç”³è«‹ã€‚ç”³è«‹å…§å®¹åŒ…æ‹¬ç¢ºå®šå£è©¦å§”å“¡ã€å£è©¦æ™‚é–“èˆ‡åœ°é»ã€è«–æ–‡ä¸­è‹±æ–‡é¡Œç›®ã€è«–æ–‡åˆç¨¿æŠ„è¥²æª¢æ¸¬çµæœç­‰ã€‚å› æ­¤å¤§æ¦‚ä¸€å€‹å¤šæœˆå‰å°±è¦ç¨å¾®ç•™æ„ä¸€ä¸‹é è¨ˆçš„å£è©¦æ™‚é–“å’Œé€²åº¦å®‰æ’ï¼Œä¸ç„¶æœƒä¾†ä¸åŠç”³è«‹å£è©¦ã€‚\nå£è©¦ç”³è«‹ç³»çµ± # è³‡å·¥ç³»ç”³è«‹å£è©¦çš„æ–¹å¼æ¯”è¼ƒç‰¹æ®Šï¼Œéœ€é€éç³»è¨ˆä¸­ç¶­è­·çš„ç¢©å£«ç­ç•¢æ¥­è«–æ–‡å£è©¦ç”³è«‹ç³»çµ±å®Œæˆï¼Œè©²ç³»çµ±éœ€ä½¿ç”¨è³‡å·¥ç³»è¨ˆä¸­å¸³è™Ÿç™»å…¥ã€‚å› æ­¤ï¼Œéœ€è¦æå‰å…ˆå®Œæˆå¸³è™Ÿè¨»å†Šã€‚å¦‚æœæ˜¯äº¤å¤§è³‡å·¥ç³»ç•¢æ¥­çš„åŒå­¸å¯ä»¥ç”³è«‹æ²¿ç”¨èˆŠæœ‰å¤§å­¸å¸³è™Ÿï¼Œä¸éæ²¿ç”¨ä¹Ÿè¦ç”³è«‹ï¼Œæ‰€ä»¥é‚„æ˜¯å»ºè­°æ—©é»è™•ç†ã€‚\nå£è©¦å§”å“¡åå–®èˆ‡è¯çµ¡ # å£è©¦å§”å“¡é€šå¸¸æ˜¯æ˜¯ 3~5 ä½ï¼Œå…¶ä¸­ä¸€ä½éœ€è¦æ˜¯é™¢å¤–å§”å“¡ï¼Œè€ŒæŒ‡å°æ•™æˆä¹Ÿå¯ä»¥æ“”ä»»å£å§”ã€‚å»ºè­°æ˜¯è©¢å•å¯¦é©—å®¤å­¸é•·å§ä»¥å¾€å£å§”æ˜¯æ€éº¼æ±ºå®šçš„ï¼Œä¸€èˆ¬ä¾†èªªæœƒè·ŸæŒ‡å°æ•™æˆè¨è«–ç¢ºèªï¼Œç„¶å¾Œé€é email é‚€è«‹å£è©¦å§”å“¡ã€‚\nå¦å¤–ï¼Œéœ€æŒ‡å®šä¸€ä½å£å§”æ“”ä»»å¬é›†äººï¼Œå¬é›†äººçš„å·¥ä½œçš„æ˜¯åœ¨å£è©¦ç•¶å¤©ä¸»æŒå£è©¦æµç¨‹ã€‚æŒ‡å°æ•™æˆä¸èƒ½æ“”ä»»å¬é›†äººã€‚å› æ­¤ï¼Œå»ºè­°æ˜¯è·ŸæŒ‡å°æ•™æˆåŒæ™‚ç¢ºèªå£å§”åå–®å’Œå¬é›†äººï¼Œç„¶å¾Œé€é Email é‚€è«‹æ•™æˆæ“”ä»»å£è©¦å§”å“¡åŠå¬é›†äººã€‚\nç¢ºèªæ•™æˆå€‘æ˜¯å¦æ–¹ä¾¿æ“”ä»»å£å§”çš„åŒæ™‚ï¼Œä¹Ÿéœ€è¦ç¢ºèªä¸€äº›äº‹é …ï¼Œå»ºè­°æ˜¯å¯ä»¥é–‹ä¸€å€‹ Google è¡¨å–®æˆ–è‘—ä¸€å€‹è¡¨æ ¼æ–‡ä»¶ï¼Œé™„åœ¨ Email å…§å»è©¢å•å£å§”å€‘ã€‚\né™¤äº†è¦ç¢ºèªæ•™æˆæ˜¯å¦æ“”ä»»å£å§”å¤–ï¼Œé‚„è¦èª¿æŸ¥å£è©¦æ™‚é–“åŠå£å§”çš„äº¤é€šæ–¹å¼ã€‚å»ºè­°æ˜¯è·ŸæŒ‡å°æ•™æˆç¢ºèªï¼ŒæŠ“å‡ºå¤§æ¦‚ä¸€åˆ°å…©å€‹æ˜ŸæœŸçš„å€é–“ï¼Œç„¶å¾Œèª¿æŸ¥å„å€‹å£å§”å¯ä»¥çš„æ™‚æ®µã€‚ä¸€èˆ¬ä¾†èªªå£è©¦æ™‚é–“æ˜¯ä¸€å€‹å°æ™‚ï¼Œå› æ­¤èª¿æŸ¥æ™‚ï¼Œå¯ä»¥ä»¥æ¯å€‹å°æ™‚ç‚ºå€é–“å€‹ä¾†èª¿æŸ¥ã€‚å®Œæˆèª¿æŸ¥å¾Œï¼Œç¢ºèªä¸€å€‹æœ€çµ‚çš„å£è©¦æ™‚é–“ï¼Œç„¶å¾Œé€šçŸ¥å„å€‹å£å§”ã€‚å¾ˆé‡è¦çš„æ˜¯æœ€çµ‚æ™‚é–“ä¹Ÿè¦å†æ¬¡è·ŸæŒ‡å°æ•™æˆç¢ºèªæ•™æˆæ˜¯å¦æœ‰ç©ºã€‚\näº¤é€šæ–¹å¼å‰‡æ˜¯ç”¨æ–¼ç³»æ‰€å ±å¸³ã€‚\næ…˜ç—›çš„æ•™è¨“æ˜¯ï¼Œå¦‚æœæ˜¯ç”¨å­¸æ ¡ä¿¡ç®±å¸³è™Ÿå»ºç«‹ Google è¡¨å–®ï¼Œè¦å°å¿ƒé è¨­æƒ…æ³ä¸‹åªæœ‰äº¤å¤§ä¿¡ç®±çš„å¸³è™Ÿå¯ä»¥å›å¾©ï¼Œè¦è¨˜å¾—æŠŠé™åˆ¶é—œæ‰ï¼Œä¸ç„¶å£å§”ä¾†èªªä¸èƒ½å¡«æœƒå¾ˆå°·å°¬ã€‚\nå£å§”å¯èƒ½æ¯”è¼ƒå¿™æˆ–ä¿¡å¤šæ²’çœ‹åˆ°ï¼Œå¦‚æœä¸€ç›´æ²’å›çš„è©±ï¼Œå¯ä»¥å†å¯„ä¸€å°ï¼Œæ¨™é¡Œå¯«ã€å†æ¬¡ä¾†ä¿¡ã€‘XXXï¼Œç•¶ç„¶å¦‚æœé‚„æ˜¯æ²’å›æˆ–å¾ˆæ€¥è¿«ï¼Œå°±å¯èƒ½è©¢å•æŒ‡å°æ•™æˆæœ‰æ²’æœ‰è¯ç¹«æ–¹å¼ï¼Œæˆ–è‘—é€éå…¶ä»–ç®¡é“è¯ç¹«å£å§”ã€‚\nè«–æ–‡åŸå‰µæ€§æ¯”å° # æäº¤å£è©¦ç”³è«‹æ™‚ï¼Œé‚„éœ€é€²è¡Œè«–æ–‡åˆç¨¿çš„åŸå‰µæ€§æ¯”å°ã€‚å°‡åˆç¨¿ä¸Šå‚³è‡³ E3 ç³»çµ±å¾Œï¼Œç²å¾—æ¯”å°çµæœä¸¦å¡«å¯«æ–¼å£è©¦ç”³è«‹ç³»çµ±ä¸­ã€‚åˆç¨¿äº¤å‡ºå»å¾Œï¼Œè«–æ–‡é‚„æ˜¯å¯ä»¥ç¹¼çºŒä¿®æ”¹ï¼Œé€™å€‹åˆç¨¿åªç”¨æ–¼ç”¢å‡ºé€™å€‹æ¯”å°çš„çµæœï¼Œå¾ŒçºŒä¸å½±éŸ¿ã€‚å¦‚æœä½¿ç”¨ä¸­æ–‡æª”åï¼Œå¯èƒ½æœƒå‡ºç¾æ¯”å°åŸ·è¡Œå¤±æ•—çš„ç‹€æ³ï¼Œå»ºè­°ç”¨è‹±æ–‡æª”åã€‚\nå£è©¦æ™‚é–“åŠåœ°é» # å£è©¦åœ°é»æ˜¯å€Ÿå·¥ç¨‹ä¸‰é¤¨çš„ç ”è¨å®¤ï¼ŒåŸå‰‡ä¸Šæ˜¯åˆ°ç ”è¨å®¤é ç´„ç³»çµ±å»å€Ÿï¼Œä½†æ˜¯é ç´„ç³»çµ±åªæœƒé–‹æ”¾ç•¶æœˆçš„å€Ÿç”¨ï¼Œæ‰€ä»¥å¦‚æœä½ è¦å€Ÿä¸‹å€‹æœˆçš„æ™‚æ®µï¼Œå¿…é ˆåˆ° EC341 å»äººå·¥ç™»è¨˜æˆ–è€…æ‰“é›»è©±ï¼Œå»ºè­°æ˜¯å‰å¾Œéƒ½å¤šå€Ÿä¸€äº›æ™‚é–“ï¼Œä»¥å…å…¶ä»–å¯¦é©—å®¤éœ€è¦ä½¿ç”¨ï¼Œæ–¹ä¾¿ææ—©é€²å»æº–å‚™ï¼Œä¹Ÿé¿å…æ“”å¿ƒå£è©¦æ™‚é–“å»¶èª¤ã€‚\nè«–æ–‡é¡Œç›® # ç‰¹åˆ¥èªªæ˜ä¸€ä¸‹è«–æ–‡é¡Œç›®ï¼Œé¦–å…ˆå£è©¦ç•¶å¤©éœ€è¦ç”¨åˆ°çš„ã€çµ¦å£å§”ç°½åçš„æ›¸é¢æ–‡ä»¶ï¼Œç³»è¾¦åŠ©ç†éƒ½æœƒå¹«ä½ å°å¥½ã€‚å…¶ä¸­åŒ…å«ç¢©å£«å­¸ä½è«–æ–‡å¯©å®šåŒæ„æ›¸ï¼Œä¸Šé¢æœƒæœ‰ä¸­è‹±æ–‡è«–æ–‡é¡Œç›®ã€‚å¦‚æœç”³è«‹å£è©¦å¾Œæœ‰è¦ä¿®æ”¹é¡Œç›®ï¼Œå°±éœ€è¦éº»ç…©ç³»è¾¦ä¿®æ”¹å¯©å®šæ›¸æ–‡ä»¶ã€‚å¦‚æœæ˜¯åœ¨å£è©¦å¾Œï¼Œå°±éœ€è¦é‡ç°½å¯©å®šæ›¸æˆ–è‘—å°ä¿®æ”¹ç´™æ¢è²¼ä¸Šå»ã€‚\né€™äº›éƒ½èª¿æŸ¥å¥½ä¹‹å¾Œï¼Œå°±å¯ä»¥åœ¨å£è©¦ç”³è«‹ç³»çµ±ä¸Šé¢å¡«å¯«ï¼Œå®Œæˆå£è©¦ç”³è«‹ï¼Œç„¶å¾ŒæŠŠå°å‡ºä¾†çš„æ–‡ä»¶çµ¦æ•™æˆç°½åï¼Œç„¶å¾Œé€çµ¦ç³»è¾¦ã€‚\nå£è©¦å‰ # å¤§ç´„å£è©¦å‰ä¸€å‘¨å·¦å³è¨˜å¾—å¯„ä¿¡æé†’å£è©¦å§”å“¡å£è©¦æ™‚é–“ã€åœ°é»ï¼Œç„¶å¾Œä¹Ÿæä¾›ä¸€ä¸‹è«–æ–‡é›»å­æª”çµ¦å£å§”å€‘åƒè€ƒã€‚å¦å¤–ï¼Œå¦‚æœæœ‰è¦æº–å‚™èŒ¶é»æˆ–åˆé¤ï¼Œè¦é †ä¾¿èª¿æŸ¥ã€è¨‚é¤ã€‚\nå»ºè­°å£è©¦ç•¶å¤©æä¾› PPT ç´™æœ¬çµ¦å£å§”åƒè€ƒå’Œç­†è¨˜ç”¨ï¼Œå¯ä»¥å•å•å¯¦é©—å®¤æœ‰æ²’æœ‰é€™å€‹æ…£ä¾‹ã€‚æœ‰çš„è©±ï¼Œå£è©¦å‰ä¸€å¤©è¨˜å¾—å…ˆå° PPT ç´™æœ¬ã€‚\nå£è©¦ç•¶å¤©å°±å…ˆå»ç³»è¾¦æ‹¿æ–‡ä»¶ï¼Œç³»è¾¦åŠ©ç†æœƒèªªæ˜ç”šéº¼æ±è¥¿è¦ç°½åã€‚å£å§”ä¾†çš„æ™‚å€™å°±å…ˆæŠŠæ–‡ä»¶äº¤çµ¦å£å§”ã€‚å£è©¦å¾Œç¢ºèªæœ‰ç°½åï¼Œç„¶å¾Œäº¤å›çµ¦ç³»è¾¦ï¼Œç³»è¾¦åŠ©ç†æœƒè¤‡å°å¯©å®šåŒæ„æ›¸ï¼Œç„¶å¾ŒæŠŠåŸç‰ˆé‚„çµ¦ä½ ã€‚\nå£è©¦å¾Œç•¢æ¥­é›¢æ ¡ # åˆ°é€™é‚Šï¼Œå…ˆæ­å–œå„ä½å£è©¦çµæŸï¼Œæ¥ä¸‹ä¾†å°±å¯ä»¥æº–å‚™ç•¢æ¥­äº†ã€‚\né¦–å…ˆæ˜¯å¹¾é …ç•¢æ¥­å‰çš„å‰ç½®å‹•ä½œã€‚\nä¿®è¨‚è«–æ–‡èˆ‡åœ–æ›¸é¤¨ä¸Šå‚³ # æ ¹æ“šå£è©¦å§”å“¡èˆ‡æ•™æˆå»ºè­°ä¿®è¨‚è«–æ–‡å¾Œï¼Œå°‡æœ€çµ‚ç‰ˆä¸Šå‚³è‡³**åœ–æ›¸é¤¨è«–æ–‡ä¸Šå‚³ç³»çµ±ã€‚**é€™å€‹ç³»çµ±åŒæ¨£æœ‰å¾ˆå¤šè³‡æ–™è¦å¡«å¯«ã€‚é€™é‚Šæœƒå†åšä¸€æ¬¡åŸå‰µæ€§æ¯”å°ï¼Œä¸éæ˜¯ç›´æ¥åœ¨ä¸Šå‚³ç³»çµ±å®Œæˆï¼Œä¸ç”¨åˆ° E3ã€‚\næ¥ä¸‹ä¾†ï¼Œæœ‰å¹¾å€‹æ–‡ä»¶éœ€è¦ç°½åï¼Œå­¸è¡“å€«ç†æš¨åŸå‰µæ€§æ¯”å°è²æ˜æ›¸åªè¦å°å‡ºä¾†è‡ªå·±ç°½åå°±å¥½äº†ã€‚å­¸ä½è«–æ–‡ç™¼è¡¨å½¢å¼ç¢ºèªæ›¸è¦èˆ‡æ•™æˆç¢ºèªæ˜¯å¦é¸æ“‡**ã€Œè«–æ–‡æ¡ç”¨è‘—ä½œå½™ç·¨å½¢å¼ã€ã€‚æˆ‘çš„ç†è§£æ˜¯ä¹‹å‰ç™¼äº†å¥½å¹¾ç¯‡è«–æ–‡ï¼Œè¦ä½œç‚ºç•¢æ¥­è«–æ–‡çš„åŸºç¤ï¼Œè¦é¿å…è‡ªæˆ‘æŠ„è¥²é‚„æœ‰å…¶ä»–å•é¡Œï¼Œé€™å€‹è·ŸæŒ‡å°æ•™æˆç¢ºèªï¼Œæ‡‰è©²æ²’æœ‰ç™¼éæ±è¥¿çš„è©±å°±ä¸æ¡ç”¨ã€‚ä¸éä¸æ¡ç”¨ä¹Ÿé‚„æ˜¯è¦æäº¤å­¸ä½è«–æ–‡ç™¼è¡¨å½¢å¼ç¢ºèªæ›¸ï¼Œé€™å¼µè¦æ•™æˆå’Œç³»è¾¦ç°½åè“‹ç« **ã€‚\nå¦‚æœè¦æ¡ç”¨è‘—ä½œå½™ç·¨å½¢å¼ï¼Œå‰‡éœ€å¦å¤–å¡«å¯«**ã€Œè‘—ä½œå½™ç·¨ä¹‹å­¸ä½è«–æ–‡è³‡è¨ŠåŠå½™ç·¨å­¸è¡“è‘—ä½œä¹‹å…±åŒä½œè€…è²¢ç»è²æ˜æ›¸ã€ï¼Œå¦‚æœ paper é‚„æœªç™¼è¡¨ä½†å·²è¢«æ¥å—ï¼Œä»è¦å¡«å¯«ã€‚è²¢ç»åº¦èªªæ˜å’Œç™¾åˆ†æ¯”å¯å’ŒæŒ‡å°æ•™æˆï¼ˆé€šè¨Šä½œè€…ï¼‰è¨è«–ï¼Œæ˜¯å¦ç´å…¥ä¸‹è¿°å…±åŒä½œè€…çš„å­¸ä½è«–æ–‡é‚£æ¬„åŸºæœ¬ä¸Šé™¤äº†ç¬¬ä¸€ä½œè€…ç‚ºæ˜¯å¤–ï¼Œå…¶ä»–ç‚ºå¦ï¼Œä½†è©³ç´°æƒ…æ³é‚„æ˜¯èˆ‡æŒ‡å°æ•™æˆè¨è«–çµæœç‚ºä¸»ã€‚ç°½åå¯ä»¥æ˜¯æ•¸ä½ç°½ç« ã€é›»å­ç°½ç« ã€é›»å­ç°½åç­‰å½¢å¼ï¼Œè€Œå¡«å¯«å®Œæˆå¾Œï¼Œè¦çµ¦æ•™æˆå’Œç³»è¾¦ç°½åè“‹ç« **ã€‚å¦‚æœæœ‰å­¸è¡“å€«ç†ç›¸é—œå•é¡Œæˆ–ä¸æœƒå¡«å¯«çš„æ–‡ä»¶ï¼Œå¯æ‰“é›»è©±æ‰¾ã€Œå­¸è¡“å€«ç†èˆ‡ç ”ç©¶èª ä¿¡è¾¦å…¬å®¤ã€è©¢å•ã€‚\næ¥è‘—æ˜¯æ›¸ç›®è³‡æ–™å»ºæª”ï¼Œå°±æ˜¯æŠŠä½ è«–æ–‡çš„è³‡æ–™å¡«é€²å»ï¼Œå°±æŠŠè«–æ–‡å…§å°æ‡‰å€å¡Šçš„æ–‡å­—ç›´æ¥è¤‡è£½è²¼ä¸Šéä¾†å³å¯ï¼Œå¦å¤–ç•¢æ¥­å»å‘è¨˜å¾—å¯«ã€‚\nç¬¬ä¸‰å€‹æ˜¯è«–æ–‡å…¬é–‹æˆæ¬Šçš„è¨­å®šï¼Œåˆ†æˆé›»å­ç‰ˆå’Œç´™æœ¬å…©å€‹éƒ¨åˆ†ï¼Œä¸€æ¨£è·Ÿå­¸é•·å§å’Œæ•™æˆç¢ºèªå½¢å¼ã€‚é€™é‚Šä¹Ÿæœƒæœ‰è«–æ–‡é›»å­æª”è‘—ä½œæ¬Šæˆæ¬Šæ›¸å’Œå»¶å¾Œå…¬é–‹ç”³è«‹æ›¸å…©å€‹æ–‡ä»¶ï¼Œå‰è€…è‡ªå·±ç°½åå°±å¥½ï¼Œå¾Œè€…æ˜¯æœ‰ä¸å…¬é–‹æˆ–å»¶æœŸå…¬é–‹æ‰æœƒéœ€è¦å¡«å¯«ï¼Œä¸€æ¨£è¦æ•™æˆå’Œç³»è¾¦ç°½åè“‹ç« ã€‚\né›–ç„¶ç³»çµ±ä¸Šé¢å¯«ç¬¬ä¸€æ­¥ç¬¬äºŒæ­¥ç¬¬ä¸‰æ­¥ï¼Œä½†æ˜¯å…¶å¯¦å¯ä»¥åŒæ™‚é€²è¡Œï¼Œæ‰€ä»¥è¨˜å¾—æŠŠç™¼è¡¨å½¢å¼ç¢ºèªæ›¸å’Œå»¶å¾Œå…¬é–‹ç”³è«‹æ›¸ä¸€èµ·çµ¦æ•™æˆå’Œç³»è¾¦ç°½åè“‹ç« ï¼Œå¦å¤–é€™äº›æ–‡ä»¶ä¸‹è¼‰ä¸‹ä¾†æœƒæœ‰ä¸­è‹±å…©å€‹ç‰ˆæœ¬ï¼Œæˆ‘å€‘ç°½ä¸­æ–‡çš„å°±å¥½äº†ã€‚\næ–‡ä»¶éƒ½ç°½åå®Œæˆå¾Œéƒ½æƒæä¸Šå‚³åˆ°ç³»çµ±ï¼Œæœ€å¾Œå°±æœƒå…ˆå¾Œæäº¤çµ¦ç³»è¾¦å’Œæ•™æˆå»ç¢ºèªï¼Œæœ‰å•é¡Œç³»è¾¦æœƒ Email å‘Šè¨´ä½ å“ªè£¡è¦ä¿®æ”¹ï¼Œå¦‚æœæ•™æˆæ²’çœ‹åˆ°è¦æé†’ä»–æ”¶ä¿¡æŒ‰ç¢ºèªã€‚\nç´™æœ¬è«–æ–‡è£½ä½œ # å®Œæˆè«–æ–‡ä¸Šå‚³å¾Œï¼Œå°±å¯ä»¥å°è£½ç´™æœ¬è«–æ–‡äº†ã€‚æŠŠè«–æ–‡æœ¬æ–‡ã€é›»å­æª”è‘—ä½œæ¬Šæˆæ¬Šæ›¸ã€å­¸ä½è«–æ–‡å¯©å®šåŒæ„æ›¸ã€å­¸ä½è«–æ–‡ç™¼è¡¨å½¢å¼ç¢ºèªæ›¸ã€å»¶å¾Œå…¬é–‹ç”³è«‹æ›¸ï¼ˆæœ‰çš„è©±ï¼‰ã€è‘—ä½œå½™ç·¨ä¹‹å­¸ä½è«–æ–‡è³‡è¨ŠåŠå½™ç·¨å­¸è¡“è‘—ä½œä¹‹å…±åŒä½œè€…è²¢ç»è²æ˜æ›¸ï¼ˆæœ‰çš„è©±ï¼‰ç­‰æª”æ¡ˆéƒ½æ”¾åˆ°ä¸€å€‹ USB è£¡é¢ï¼ˆä¸ç”¨åˆä½µæª”æ¡ˆï¼‰ã€‚åˆ°å·¥ç¨‹ä¸‰é¤¨ä¸€æ¨“å½±å°å®¤å°è£½ï¼Œæˆ–æ˜¯å‰ä¸€å¤©å¯„æª”æ¡ˆ email éå»ï¼Œéš”å¤©ç›´æ¥å»é ˜ï¼Œè€Œè«–æ–‡æœ€å°‘æ˜¯å…©æœ¬è¦äº¤çµ¦å­¸æ ¡ï¼Œé¡å¤–å°±çœ‹å¯¦é©—å®¤å’Œè‡ªå·±è¦ä¸è¦ç•™ä¸€æœ¬ã€‚å°è£½ç´„éœ€åŠå°æ™‚è‡³ä¸€å°æ™‚ï¼Œéƒ¨åˆ†å½©è‰²é é¢ä¸€æœ¬è²»ç”¨ç´„ç‚º NT$200-250ã€‚å°å‡ºä¾†å¾Œï¼Œè¦ç­‰åˆ°é›¢æ ¡ç¨‹åºå•Ÿå‹•å¾Œæ‰ç¹³äº¤çµ¦å­¸æ ¡ã€‚\næˆç¸¾æäº¤ # æ¥è‘—è¦å»æŠŠé›¢ç³»å–®å°å‡ºä¾†ï¼Œç„¶å¾Œçµ¦æ•™æˆå’Œç³»è¾¦ç°½åè“‹ç« ï¼Œç³»è¾¦æ‰æœƒå°‡å£è©¦æˆç¸¾æäº¤çµ¦è¨»å†Šçµ„ã€‚å¯ä»¥è·Ÿè«–æ–‡ä¸Šå‚³ç›¸é—œçš„æ–‡ä»¶ä¸€èµ·æ‹¿çµ¦æ•™æˆå’Œç³»è¾¦ç°½åã€‚\nè«–æ–‡æµ·å ± PPT # å¦å¤–é‚„æœ‰ä¸€å€‹è«–æ–‡æµ·å ± PPT è¦è¨˜å¾—åšå¥½ï¼Œä¸¦å¯„é€çµ¦ç³»è¾¦åŠ©ç†ã€‚\nå•Ÿå‹•é›¢æ ¡æµç¨‹ # å®Œæˆä¸Šè¿°æ­¥é©Ÿå¾Œï¼Œå³å¯å•Ÿå‹•ç·šä¸Šé›¢æ ¡æµç¨‹ã€‚éœ€æ»¿è¶³ä»¥ä¸‹æ¢ä»¶æ‰èƒ½å•Ÿå‹•ç³»çµ±ï¼š\nåœ–æ›¸é¤¨è«–æ–‡ä¸Šå‚³ä¸¦ç¶“éç³»è¾¦èˆ‡æ•™æˆå¯©æ ¸ï¼ˆéš”å¤©ï¼‰ æˆç¸¾é€é”è¨»å†Šçµ„ä¸”å·²ç™»è¨˜ï¼ˆæ ¹æ“šç³»æ‰€æ–‡ä»¶èªªæ˜ï¼Œè‡³å°‘ç­‰åŠå¤©ã€‚ï¼‰ æ²’æœ‰æœªå®Œæˆçš„å·®å‹¤ç™»è¨˜é …ç›® å¦‚æœå¯¦é©—å®¤æœ‰å ±è¨ˆç•«å’Œå·¥ä½œè²»æˆ–è‘—åœ¨å­¸æ ¡æœ‰æ‰“å·¥ï¼Œé‚£é›¢æ ¡ç¨‹åºï¼Œè¦ç­‰æ‰€æœ‰å·®å‹¤å·¥ä½œé …ç›®çš„ç™»è¨˜æ™‚é–“éå¾Œï¼Œæ‰èƒ½å¤ å•Ÿå‹•ã€‚ç†è«–ä¸Šï¼Œå¯ä»¥è«‹åŠ©ç†å”èª¿ä¿®æ”¹ç°½æ ¸æ™‚é–“ï¼Œä½†æ˜¯æˆ‘ç•¢æ¥­æ™‚ï¼Œå‰›å¥½åœ¨æ›´æ–°å·®å‹¤ç³»çµ±ï¼Œè¦å‰‡æœ‰è®Šï¼Œæ‰€ä»¥å¦‚æœé‚„æœ‰å·®å‹¤å·¥ä½œé …ç›®çš„è©±ï¼Œè¨˜å¾—ææ—©è©¢å•åŠ©ç†ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥èª¿æ•´ã€‚ å¯ä»¥å‰ä¸€å¤©æ™šä¸Šå•Ÿå‹•ç·šä¸Šé›¢æ ¡æˆçºŒï¼Œç„¶å¾Œç…§è‘—å­¸æ ¡çš„æµç¨‹èµ°å»è·‘æ ¡åœ’ RPGï¼Œç†è«–ä¸Šå¯ä»¥ä¸€å¤©å…§å®Œæˆæ‹¿åˆ°ç•¢æ¥­è­‰æ›¸é›¢é–‹å­¸æ ¡ã€‚è¨˜å¾—è¦å¸¶å…©æœ¬è«–æ–‡ã€å­¸ç”Ÿè­‰å’Œé€€é¸å–®ã€‚ç•¢æ¥­æµç¨‹åˆ†æˆé›¢ç³»å’Œé›¢æ ¡å…©å€‹éƒ¨åˆ†ã€‚\né›¢ç³»çš„éƒ¨åˆ†æ¯”è¼ƒç°¡å–®ï¼Œè¦æ‹¿é›¢ç³»å–®åˆ†åˆ¥çµ¦è³‡å·¥ç³»è¨ˆä¸­ã€å¯¦é©—å®¤åŠ©æ•™ç°½åï¼Œæœ€å¾Œäº¤å›ç³»è¾¦ (è¨˜å¾—å…ˆæŠŠæµ·å ± PPT å¯„éå»)ã€‚åŒæ™‚ï¼Œå› ç‚ºæˆ‘å€‘éœ€è¦é€€æ‰å€‹åˆ¥ç ”ç©¶ï¼Œæ‰€ä»¥å¯ä»¥é †ä¾¿æŠŠé€€é¸å–®æ‹¿çµ¦ç³»è¾¦è“‹ç« ã€‚\nå› ç‚ºé›¢ç³»å–®è¦å…ˆçµ¦ç³»è¾¦ç°½åæ‰èƒ½é€æˆç¸¾åˆ°è¨»å†Šçµ„å•Ÿå‹•é›¢æ ¡ï¼Œæ‰€ä»¥å¯èƒ½å¯ä»¥åœ¨é€æˆç¸¾æ™‚é †ä¾¿å®Œæˆé›¢ç³»å’Œé€€é¸å–®ï¼Œä¸ä¸€å®šè¦è·Ÿé›¢æ ¡åœ¨åŒä¸€å¤©å…§å¼„ã€‚\næ¥ä¸‹ä¾†å°±æ˜¯é›¢æ ¡æµç¨‹ï¼Œé€™é‚Šæä¾›ä¸€å€‹å»ºè­°çš„ RPG ç§»å‹•è·¯ç·šï¼š\nåœ–æ›¸é¤¨ï¼šç¹³äº¤è«–æ–‡ç´™æœ¬ è³‡è¨Šæœå‹™ä¸­å¿ƒä¸‰æ¨“è·æ¶¯ç™¼å±•çµ„ï¼šæœ‰ä¸€å€‹ç·šä¸Šè¡¨å–®è¦å¾ç·šä¸Šé›¢æ ¡ç³»çµ±çš„ä»‹é¢å…ˆå¡«ï¼Œå»é€™é‚Šé ˜ç•¢æ¥­è­‰æ›¸çš„æ›¸å¥—å’Œç´€å¿µå“ è³‡è¨Šæœå‹™ä¸­å¿ƒä¸‰æ¨“ä½å®¿æœå‹™çµ„ï¼šå¦‚æœæœ‰ä½å®¿èˆçš„åŒå­¸æ‰éœ€è¦ä¾†è™•ç†é€€å®¿ï¼Œæˆ‘æ²’æœ‰æ‰€ä»¥ä¸å¤ªæ¸…æ¥šæµç¨‹ ç§‘å­¸ä¸€é¤¨èª²å‹™çµ„ï¼šå®Œæˆå€‹åˆ¥ç ”ç©¶é€€é¸ï¼Œå¦‚æœæ˜¯åœ¨å¯’æš‘å‡æœŸé–“å‰‡ä¸ç”¨ã€‚ ç§‘å­¸ä¸€é¤¨è¨»å†Šçµ„ï¼šé ˜ç•¢æ¥­è­‰æ›¸ã€ç¹³äº¤å¦å¤–ä¸€æœ¬è«–æ–‡ã€‚åˆ°é€™é‚Šå°±æ­£å¼å®Œæˆç•¢æ¥­å•¦ï¼ å¤§ç¦®å ‚äºŒæ¨“å‡ºç´çµ„ï¼šå¦‚æœæœ‰è¦é€€å­¸é›œè²»ï¼Œå°±éœ€è¦å†ä¾†é€™é‚Šä¸€è¶Ÿã€‚ åˆ°é€™é‚Šå°±æ­£å¼ç•¢æ¥­é›¢é–‹äº¤å¤§äº†ï¼\n","date":"November 16 2024","externalUrl":null,"permalink":"/posts/graduation-process-tips-for-nycu-cs-masters/","section":"æ–‡ç« ","summary":"","title":"äº¤å¤§è³‡å·¥ç ”ç©¶æ‰€ç•¢æ¥­æµç¨‹å¿ƒå¾—","type":"posts"},{"content":"","date":"November 16 2024","externalUrl":null,"permalink":"/categories/%E7%A0%94%E7%A9%B6%E6%89%80/","section":"åˆ†é¡","summary":"","title":"ç ”ç©¶æ‰€","type":"categories"},{"content":" å‰è¨€ # éƒ¨è½æ ¼å»¢æ£„äº†ä¸€å¹´å¤šçš„æ™‚é–“ï¼Œçµ‚æ–¼æœ‰ç©ºä¾†å¥½å¥½æ•´ç†æ•´ç†æˆ‘çš„éƒ¨è½æ ¼äº†ã€‚åŸæœ¬æ˜¯ä½¿ç”¨ VuePress ä¾†ç”¢ç”Ÿæˆ‘çš„éƒ¨è½æ ¼ï¼Œä½†æ˜¯åœ¨é€™æ¬¡æ•´ç†çš„éç¨‹ä¸­ç™¼ç¾äº† VuePress çš„ä¸€äº›ç¼ºé»ï¼Œæƒ³äº†æƒ³ï¼Œç ”ç©¶äº†ä¸€ä¸‹ç¾åœ¨å¹¾æ¬¾çš„ Markdown éœæ…‹ç¶²ç«™ç”Ÿæˆæ¡†æ¶ï¼Œæœ€å¾Œæ±ºå®šå¾ VuePress æ¬é·åˆ° Hugo ä¸¦ä½¿ç”¨äº† Blowfish é€™å€‹ä¸»é¡Œã€‚\nèµ·å›  # å¤§æ¦‚åœ¨å…©å¹´å‰ï¼Œé–‹å§‹ä½¿ç”¨ Markdown ç”Ÿæˆå™¨ä¾†å»ºç«‹éœæ…‹éƒ¨è½æ ¼ã€‚æœ€æ—©æœ‰çŸ­æš«ä½¿ç”¨ Hexoã€‚å¾Œä¾†å°±æ¥è§¸åˆ° VuePress é€™å€‹æ¡†æ¶ï¼Œç™¼ç¾ Vuepress èƒ½å¤ ç›´æ¥åœ¨é é¢è£¡é¢å¯« Vue.js ä¾†æ“´å……åŠŸèƒ½ï¼Œæœªä¾†èƒ½å¤ æ¯”è¼ƒæ–¹ä¾¿åœ¨éƒ¨è½æ ¼è£¡é¢åŠ ä¸€å †åŠŸèƒ½ï¼Œæ‰€ä»¥å°±è·³åˆ° VuePress äº†ã€‚\nä½†æ˜¯ä¸€ç›´ä»¥ä¾†é€™å€‹éƒ¨è½æ ¼å°±æœ‰ SEO çš„å•é¡Œï¼Œå¾ˆå¤šé é¢æ²’æœ‰è¾¦æ³•è¢« Google Indexã€‚æ‰€ä»¥é€™æ¬¡å˜—è©¦è¦å»è§£æ±º SEO ç›¸é—œçš„å•é¡Œï¼Œç‚ºäº†è§£æ±ºé€™äº›å•é¡Œï¼Œéœ€è¦å»ä¿®æ”¹ VuePress çš„ Themeã€‚ä½†æ˜¯å°±ç™¼ç¾ä¿®æ”¹ VuePress çš„ theme æ˜¯ä¸€ä»¶æœ‰é»ç—›è‹¦çš„äº‹æƒ…ã€‚å› ç‚ºç›¸å°æ–¼ Hexo é€™ç¨®ç´”ç²¹ç”Ÿæˆéœæ…‹ç¶²é çš„å·¥å…·ï¼ŒVuePress ä½¿ç”¨çš„æ˜¯ç›´æ¥å»ºç«‹ä¸€å€‹åŸºæ–¼ Vue.js å‰ç«¯æ¡†æ¶çš„ç¶²é ï¼Œç„¶å¾Œæ¯ç¯‡æ–‡ç« ä½¿ç”¨ Server Side Rendering çš„æ–¹å¼å»ç”¢ç”Ÿéœæ…‹å…§å®¹ï¼Œä¸¦ä¸” Theme ä¹Ÿæ˜¯ç›´æ¥ä»¥ Vue module çš„æ–¹å¼æ’å…¥çš„ã€‚é€™å°è‡´ VuePress æ¡†æ¶æœ¬èº«ã€theme é‚„æœ‰é é¢çš„ç¨‹å¼ç¢¼å…¨éƒ¨éƒ½æœƒæ··åœ¨ä¸€èµ·ï¼Œå°è‡´é–‹ç™¼ä¸Šæœƒæœ‰é»é›£é™¤éŒ¯ã€‚\nç‚ºäº†çœå¿ƒï¼Œå°±æ±ºå®šæº–å‚™å¾ VuePress æ¬é·å› Hexo é€™ç¨®å–®ç´”æ¨¡æ¿å¼çš„éœæ…‹ç¶²é ç”Ÿæˆå™¨ã€‚åœ¨æ‰¾æ–°ä¸»é¡Œçš„éç¨‹ä¸­å°±ç™¼ç¾äº† Hugo é€™å€‹åŸºæ–¼ Golang é–‹ç™¼çš„éœæ…‹ç¶²é ç”Ÿå™¨ï¼Œä¸¦è¢«å®ƒçš„å¹¾å€‹ç‰¹æ€§çµ¦å¸å¼•ã€‚\nè¶…å¿«çš„ç·¨è­¯é€Ÿåº¦ï¼šHugo æ˜¯ä¸€å€‹ä½¿ç”¨ Golang é–‹ç™¼çš„ç”Ÿæˆå™¨ï¼ŒHugo çš„åŸ·è¡Œé€Ÿåº¦éå¸¸ä¹‹å¿«ï¼Œä»¥æˆ‘ç›®å‰ 19 ç¯‡æ–‡ç« ä¾†èªªï¼Œhugo ç·¨è­¯çš„æ™‚é–“æ˜¯ 100 msï¼ŒåŸºæœ¬ä¸Šæ˜¯å¯ä»¥é †é–‹ã€‚åŸæœ¬åœ¨ VuePress å°±è¦å¥½å¹¾ç§’ï¼Œè¶…ç´šä¹…ã€‚ Golang æ¨¡æ¿ï¼šæ¯å€‹æ¡†æ¶éƒ½æä¾›äº†æ¨¡æ¿å¼•æ“ï¼Œä¾†æä¾›å°ç¶²é ä¸»é¡ŒåŠå…§å®¹å®¢è£½åŒ–çš„åŠŸèƒ½ã€‚Hexo ä½¿ç”¨ ejs æ¨¡æ¿å¼•æ“ä¾†æ¸²æŸ“ï¼ŒVuePress åŸºæ–¼å‰ç«¯æ¡†æ¶çš„ç‰¹æ€§ï¼Œä½¿ç”¨ Vue.js çš„ç¨‹å¼ç¢¼ä¾†å»ºç«‹æ¨¡æ¿ã€‚Hugo å‰‡æ˜¯ä½¿ç”¨ Golang æœ¬èº«æä¾›çš„æ¨¡æ¿å¼•æ“ã€‚ç›¸è¼ƒæ–¼å¾ä¾†æ²’ç”¨éçš„ ejsï¼Œæˆ‘å° Golang çš„æ¨¡æ¿å¼•æ“æ¯”è¼ƒç†Ÿæ‚‰ã€‚ å®¹æ˜“æ“´å±•ä¸»é¡Œï¼šéœæ…‹éƒ¨è½æ ¼ç›¸å°ä¾†èªªä¸æ˜¯ä¸€å€‹å¾ˆè¤‡é›œçš„ç¶²ç«™ï¼Œæ‰€ä»¥ç›¸å°æ–¼ VuePress ç›´æ¥æä¾›å‰ç«¯æ¡†æ¶çš„æ“´å……å½ˆæ€§ï¼Œæ“´å……çš„å®¹æ˜“åº¦å°ç›®å‰çš„æˆ‘ä¾†èªªæ¯”è¼ƒé‡è¦ã€‚Hugo å¯ä»¥åœ¨ä¸ä¿®æ”¹ä¸»é¡Œæª”æ¡ˆçš„æƒ…æ³ä¸‹ï¼Œå¾ˆå®¹æ˜“åœ°é€éé¡å¤–çš„æª”æ¡ˆä¾†è¦†è“‹ä¸»é¡Œï¼Œä¿®æ”¹ä¸»é¡Œè¡Œç‚ºå’Œå¢åŠ åŠŸèƒ½ã€‚ çœå¿ƒçš„å…§å»ºåŠŸèƒ½ï¼šHugo æœ¬èº«å°±æä¾›äº†å° Google Analytics å’Œ Open Graph ç­‰åœ¨ Hexo å’Œ VuePress éƒ½éœ€è¦é¡å¤–æ¨¡çµ„æ‰èƒ½æä¾›çš„åŠŸèƒ½ã€‚ç›¸å°ä¾†èªªéå¸¸çœå¿ƒã€‚ æ¯”è¼ƒç©©å®šçš„ç·¨è­¯çµæœï¼šé€™å€‹æ˜¯ VuePress ä¿®æ”¹ä¸»é¡Œçš„æ™‚å€™çš„ä¸€å€‹å°ç¼ºé»ï¼Œå› ç‚º VuePress çš„æ‰€æœ‰ä¸»é¡Œå’Œæ’ä»¶æœ¬è³ªä¸Šéƒ½æ˜¯ JS ç¨‹å¼ç¢¼ï¼Œæœ€å¾Œæœƒè¢« VuePress ç·¨è­¯æˆä¸€äº› js bundleï¼Œé€šå¸¸æœƒæ˜¯ assets/js/23.501c2967.js é€™æ¨£çš„æª”æ¡ˆï¼Œä¸¦ä¸”æœƒç¶“é js uglify è·Ÿ minifyã€‚é‡æ–°ç·¨è­¯å¾Œæ•´å€‹æª”æ¡ˆå°±å¯èƒ½äº‚æ‰ï¼Œå°æ–¼ç”¨ Github Page ä¾†ç®¡ç†éƒ¨è½æ ¼çš„æˆ‘ä¾†èªªï¼Œä¸æ˜¯å¾ˆå–œæ­¡ã€‚ ä¸»é¡Œé¸æ“‡ # è·Ÿå¤§éƒ¨åˆ†çš„éœæ…‹éƒ¨è½æ ¼ç”Ÿæˆå™¨ä¸€æ¨£ï¼ŒHugo ä¹Ÿæœ‰å»£å¤§çš„é–‹å…ƒç¤¾ç¾¤æä¾›äº†å„å¼å„æ¨£çš„ä¸»é¡Œï¼Œé™¤äº†å¾ hugo å®˜ç¶²ï¼Œä»¥å¤–ä¹Ÿå¾ Github å’Œ Google å»æ‰¾äº†å¹¾å€‹æ„Ÿèˆˆè¶£ä¸»é¡Œã€‚é€™é‚Šä¹Ÿé †ä¾¿æŠŠé€™å¹¾å€‹åˆ†äº«çµ¦å¤§å®¶ã€‚\nToha: Toha æ˜¯æˆ‘æ‰¾åˆ°ç¬¬ä¸€å€‹æ„Ÿèˆˆè¶£çš„ä¸»é¡Œï¼Œä»–çš„é¦–é å¾ˆå¥½çœ‹ï¼Œä¹Ÿæä¾›äº†ä¸€äº›å¦‚ Skillsã€Code Notes ä¹‹é¡æˆ‘æ„Ÿèˆˆè¶£çš„åŠŸèƒ½ã€‚å¯æƒœçš„æ˜¯ä»–åªæä¾›äº†åŸºæ–¼ Tag çš„åˆ†é¡æ–¹å¼ï¼Œä¸æ”¯æ´ Categoryï¼Œæ‰€ä»¥èˆ‡æˆ‘åŸæœ‰çš„éƒ¨è½æ ¼ä¸å¤ªç›¸å®¹ï¼Œæ–‡ç« é é¢ä¹Ÿè¨­è¨ˆæ²’é‚£éº¼å¸å¼•æˆ‘ã€‚ blog.coolapso.sh: é€™å€‹ä½œè€…æœ€é…·çš„åœ°æ–¹æ˜¯æä¾›äº†ä¸€å€‹å‡ shell çš„å½¢å¼çš„å±¥æ­·ç¶²é ã€‚ hexo-theme-next: æœ¬ä¾†æ˜¯æ‰“ç®—å¾ VuePress æ¬åˆ° Hexo + Nextï¼Œæ‰€ä»¥å°±æ‰¾åˆ°é€™å€‹æŠŠ Hexo Next ä¸»é¡Œé·ç§»åˆ° Hugo çš„ç‰ˆæœ¬ã€‚ hexo-theme-aomori: é€™å€‹æ˜¯ Hexo çš„ä¸»é¡Œä½†æ˜¯å¾ˆå¥½çœ‹ã€‚ archie: ç¶“å…¸çš„æ¥µç°¡ä¸»é¡Œã€‚ hugo-theme-tailwind: åŸºæ–¼ tailwind CSS çš„ä¸»é¡Œã€‚æƒ³é¸é€™å€‹æ˜¯è€ƒæ…®åˆ°å¦‚æœè¦ä¿®æ”¹ä¸»é¡Œã€å¢åŠ é é¢ï¼Œæœ‰ tailwind CSS å¯èƒ½æœƒæ¯”è¼ƒå¥½æ”¹ã€‚ hugo-theme-bootstrap: å¦å¤–ä¸€å€‹åŸºæ–¼ BootStrapã€‚ æœ€å¾Œï¼Œæˆ‘é¸æ“‡çš„æ˜¯ Blowfishé€™å€‹ä¸»é¡Œï¼Œblowfish å¾ˆå¥½çœ‹ï¼Œè€Œä¸”åŠŸèƒ½å®Œå–„ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¿è¶³æˆ‘æ‰€æœ‰åŠŸèƒ½éœ€æ±‚ï¼Œæ‰€ä»¥å¾ŒæœŸè¦é¡å¤–åŠ çš„åŠŸèƒ½ä¹Ÿæ¯”è¼ƒå°‘ï¼Œä¸ç”¨èŠ±å¤ªå¤šæ™‚é–“ã€‚\nå°ˆæ¡ˆåˆå§‹åŒ– # å®‰è£ Hugo # å› ç‚º Hugo æ˜¯åŸºæ–¼ Golang é–‹ç™¼çš„ï¼Œæ¯”è¼ƒå¥½çš„å®‰è£æ–¹å¼æ˜¯å®‰è£ Golang ä¾†ç·¨è­¯æœ€æ–°ç‰ˆæœ¬ã€‚\nsudo su wget https://go.dev/dl/go1.23.2.linux-amd64.tar.gz rm -rf /usr/local/go \u0026amp;\u0026amp; tar -C /usr/local -xzf go1.23.2.linux-amd64.tar.gz # Add to .bashrc/.zshrc export PATH=$PATH:/usr/local/go/bin å®‰è£å®Œ Golang å¾Œå°±å¯ä»¥å®‰è£ hugoã€‚\ngo install -tags extended github.com/gohugoio/hugo@latest # å¦‚æœç”¨ non root å®‰è£æœƒåœ¨ $HOME/go/bin/ # ä¹Ÿéœ€è¦åŠ åˆ°ç’°å¢ƒè®Šæ•¸ # export PATH=$PATH:$HOME/go/bin/ å»ºç«‹éƒ¨è½æ ¼åŠå®‰è£ä¸»é¡Œ # æ¥è‘—åˆå§‹åŒ– hugo å°ˆæ¡ˆã€‚\nhugo new site \u0026lt;folder\u0026gt; cd \u0026lt;folder\u0026gt; åœ¨ hugo æ¶æ§‹ä¸‹ï¼Œä¸»é¡Œè¦æ”¾åœ¨ themes ç›®éŒ„ä¸‹ï¼Œæ‰€ä»¥è¦å°‡ä¸»é¡Œ clone åˆ° themes/blowfishã€‚\ngit init git submodule add -- https://github.com/nunocoracao/blowfish.git themes/blowfish æ¥è‘—è¦å°‡ä¸»é¡Œæä¾›çš„è¨­å®šæª”è¤‡è£½åˆ°éƒ¨è½æ ¼è¨­å®šæª”ç›®éŒ„ä¹‹ä¸‹ï¼Œä¹Ÿå°±æ˜¯config/_defaultã€‚\nrm hugo.toml mkdir -p config/_default/ cp themes/blowfish/config/_default/* config/_default/ æ¥è‘—è¦ä¿®æ”¹ config/_default/hugo.tomlï¼ŒæŠŠthemeçš„è¨»è§£#æ‹¿æ‰ï¼Œä¸»é¡Œæ‰èƒ½ç”Ÿæ•ˆã€‚\n# theme = \u0026#34;blowfish\u0026#34; # UNCOMMENT THIS LINE ç„¶å¾Œå•Ÿå‹• hugoçš„æ¸¬è©¦ä¼ºæœå™¨ã€‚\nhugo server å°±èƒ½è¨ªå•åˆ°ç©ºç™½çš„ä¸»é¡Œç¶²é äº†ï¼\nè¨­å®šèˆ‡æ¬é· # æ¥è‘—å°±è¦æŠŠç¶²ç«™è®Šæˆæˆ‘å€‘æƒ³è¦çš„æ¨£å­ï¼Œç„¶å¾ŒæŠŠæ–‡ç« æ¬éä¾†äº†ã€‚ä¿®æ”¹è¨­å®šçš„æ™‚å€™ï¼Œå¯ä»¥æŠŠç¶²ç«™ç”¨ hugo server è·‘èµ·ä¾†ï¼Œhugo åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´æœƒè‡ªå·±é‡ç·¨è­¯ï¼Œè€Œä¸”å› ç‚º Hugo ç·¨è­¯å¯å¾ˆå¿«ï¼Œå¯ä»¥å³æ™‚çœ‹åˆ°ä¿®æ”¹çµæœã€‚\nè¨­å®šä¸»é¡Œ # ç¶²é çš„è‡ªè¨‚åŒ–ä¸»è¦é‚„æ˜¯ç”±ä¸»é¡Œæä¾›çš„è¨­å®šï¼Œå‰é¢å·²ç¶“æŠŠä¸»é¡Œçš„è¨­å®šæª”è¤‡è£½åˆ° config/_default ç›®éŒ„ä¸‹ï¼Œæ¥ä¸‹ä¾†å°±åªè¦ä¸€å€‹æ¥è‘—ä¸€å€‹ä¿®æ”¹ã€‚\n# ls config/_default/ hugo.toml languages.en.toml markup.toml menus.en.toml module.toml params.toml å› ç‚º blowfish æ”¯æ´å¤šèªç³»ç¶²ç«™ï¼Œæ‰€ä»¥åœ¨è¨­å®šéƒ¨åˆ† languages è·Ÿ memus é€™å…©å€‹æª”æ¡ˆæ˜¯èªç³»ç¨ç«‹çš„ï¼Œå› ç‚ºæˆ‘è¦ä¸»è¦æ˜¯ç¹é«”ä¸­æ–‡ã€‚æ‰€ä»¥æŠŠåŸæœ‰çš„è‹±æ–‡èªç³»è¨­å®šæª”æ¡ˆåˆªæ‰ï¼Œæ”¹æˆä¸­æ–‡ã€‚\n# ls config/_default/ hugo.toml languages.zh-tw.toml markup.toml menus.zh-tw.toml module.toml params.toml æ¥ä¸‹ä¾†å°±æ˜¯æ‰“é–‹æ¯å€‹è¨­å®šæª”ï¼Œåƒè€ƒä¸»é¡Œçš„èªªæ˜æ–‡ä»¶ï¼ŒæŠŠç¶²ç«™èª¿æ•´æˆè‡ªå·±æƒ³è¦çš„æ¨£å­ã€‚\nGetting Started Â· Blowfish Configuration Â· Blowfish å› ç‚ºå¤§éƒ¨åˆ†çš„è¨­å®šå…§å®¹éƒ½åªéœ€è¦çœ‹è‘—è¨­å®šæª”å’Œèªªæ˜æ–‡ä»¶è¨­å®šï¼Œé€™é‚Šå°±ä¸è´…è¿°ã€‚\næ–‡ç« æ¬é· # æ–‡ç« æ¬é·åè€Œæ˜¯æ•´å€‹éç¨‹ä¸­æœ€ç°¡å–®çš„æ­¥é©Ÿï¼ŒHugo å®Œå…¨å…¼å®¹æˆ‘æ–‡ç« åŸæœ‰çš„ front matterã€‚æ‰€ä»¥åªè¦æŠŠæ–‡ç« è¤‡è£½åˆ° content/posts ç›®éŒ„ä¸‹ï¼Œå°±å¯ä»¥å®Œæˆæ¬é·äº†ã€‚\nä¸»é¡Œä¿®æ”¹ # èª¿æ•´ç¨‹å¼ç¢¼å€å¡Šé…è‰² # æ•´é«”ä¾†èªªï¼ŒåŸæœ¬ Blowfish ä¸»é¡Œçš„é…è‰²å°±è®“æˆ‘å¾ˆæ»¿æ„äº†ï¼Œæˆ‘å”¯ä¸€è¦ºå¾—æœ‰å•é¡Œçš„åœ°æ–¹æ˜¯ç¨‹å¼ç¢¼å€å¡Šçš„é…è‰²ï¼ŒBlowfish å®¢è£½åŒ–çš„èªæ³•é«˜é‡ä¸»é¡Œå¥½çœ‹ï¼Œä½†æ˜¯å°±ä¸å¤ æ¸…æ¥šï¼Œä¸å¤ªå¥½é–±è®€ã€‚\nHugo åˆ©ç”¨ chroma é€™å€‹å·¥å…·ä¾†ç”¢ç”Ÿç¨‹å¼ç¢¼å€å¡Šï¼ŒBlowfish åšçš„äº‹æƒ…æ˜¯é€é CSS å»èª¿æ•´ä¸åŒé—œéµå­—çš„é…è‰²å’Œå€å¡Šåº•è‰²ã€‚å› æ­¤ï¼Œå¯ä»¥é€éèª¿æ•´ CSS ä¾†ä¿®æ”¹æ•´å€‹é…è‰²ã€‚Chroma å…§å»ºäº†è¨±å¤šçš„é…è‰²ä¸»é¡Œï¼Œæˆ‘æŒ‘äº†å…¶ä¸­çš„ onedark é€™å€‹ä¸»é¡Œã€‚\nå¯ä»¥ç›´æ¥åªç”¨ hugo æŒ‡ä»¤ç”Ÿæˆä¸»é¡Œçš„ CSS è¨­å®šã€‚\nmkdir -p assets/css/ hugo gen hugo gen chromastyles --style=onedark \u0026gt; assets/css/custom.css è·Ÿæ“š Blowfish æ–‡ä»¶ ï¼Œå¯«å…¥åˆ° assets/css/custom.cssçš„ css å› ç‚ºæª”æ¡ˆé †åºçš„é—œä¿‚ï¼Œå„ªå…ˆåº¦æ¯”è¼ƒé«˜ï¼Œå¯ä»¥ç›´æ¥è¦†è“‹æ‰ä¸»é¡Œçš„ CSS è¨­å®šï¼Œé€™æ¨£å°±ä¸éœ€è¦ç›´æ¥ä¿®æ”¹ä¸»é¡Œçš„æª”æ¡ˆã€‚\nä¸éé€™æ¨£åªæœƒä¿®æ”¹åˆ°æ·ºè‰²æ¨¡å¼ä¸‹çš„ä¸»é¡Œï¼Œå¦‚æœè¦å°æš—è‰²æ¨¡å¼ç”Ÿæ•ˆï¼Œå°±éœ€è¦è¤‡è£½ä¸€ä»½æ•´å€‹ chroma çš„ CSSï¼Œç„¶å¾Œæ¯å€‹å¾Œé¢æ·»åŠ  is(.dark *) é¸æ“‡å™¨ã€‚\n# Light mode .prose .chroma { color: #abb2bf; background-color: #232631; } # Dark mode .prose .chroma:is(.dark *) { color: #abb2bf; background-color: #232631; } ä¸­æ–‡åŒ– # Blowfish æœ¬ä¾†å°±å·²ç¶“æœ‰å®Œæ•´çš„ç¹é«”ä¸­æ–‡æ”¯æ´ï¼Œå”¯ä¸€æ²’æ”¯æ´åˆ°çš„åœ°æ–¹æ˜¯ /posts, /tags, /categoriesé€™ä¸‰å€‹ç›®éŒ„çš„æ¨™é¡Œæ²’æœ‰ä¿®æ”¹ã€‚\nè¦ä¿®æ”¹ä¹Ÿæ¯”è¼ƒç°¡å–®ï¼Œå»ºç«‹ content/posts/_index.md, content/tags/_index.md, content/categories/_index.md é€™ä¸‰å€‹æª”æ¡ˆï¼Œç„¶å¾Œæ‰“ä¸Šæ¨™é¡Œå³å¯ã€‚\n--- title: æ¨™ç±¤ --- ä¿®æ”¹ 404 é é¢ # æ¥è‘—è¦èª¿æ•´çš„æ˜¯ 404 é é¢ï¼Œé€™æ˜¯åŸæœ¬çš„ 404 é é¢ï¼š\nä¸»è¦æ˜¯æˆ‘æƒ³è¦å°‡æˆ‘ç•«çš„ 404 åœ–ç‰‡æ”¾é€²ä¾†ï¼ŒåŸæœ¬çš„ä¸»é¡Œæ²’æœ‰æä¾›åœ¨ 404 é é¢ç½®å…¥åœ–ç‰‡çš„åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦å»ä¿®æ”¹æ¨¡æ¿ã€‚\né€™é‚Šå°±è¦ä»‹ç´¹ hugo å¾ˆå¼·å¤§çš„ä¸»é¡Œè¦†è“‹åŠŸèƒ½ï¼Œç•¶ hugo éœ€è¦æœå°‹ä¸€å€‹æ¨¡æ¿æ™‚ï¼Œæœƒä¾åºåœ¨ layouts, themes/xxxx/layoutså»æ‰¾åˆ°å°æ‡‰çš„æª”æ¡ˆã€‚æ‰€ä»¥ç•¶æˆ‘å€‘æƒ³è¦ä¿®æ”¹ä¸»é¡Œæ¨¡æ¿æ™‚ï¼Œåªè¦å°‡æ¨¡æ¿è¤‡è£½åˆ° layouts ä¸­ä¿®æ”¹ï¼Œå°±å¯ä»¥åœ¨å®Œå…¨ä¸æ›´å‹•ä¸»é¡Œæª”æ¡ˆçš„æƒ…æ³ä¸‹å®Œæˆä¿®æ”¹ã€‚\ncp themes/blowfish/layouts/404.html layouts ç„¶å¾Œå°±å¯ä»¥ç°¡å–®çš„ç½®å…¥ 404.pngã€‚\n{{ define \u0026#34;main\u0026#34; }} \u0026lt;h1 class=\u0026#34;mb-3 text-4xl font-extrabold\u0026#34;\u0026gt; {{ i18n \u0026#34;error.404_title\u0026#34; | emojify }} \u0026lt;/h1\u0026gt; \u0026lt;div class=\u0026#34;prose dark:prose-invert\u0026#34;\u0026gt; \u0026lt;p\u0026gt;{{ i18n \u0026#34;error.404_description\u0026#34; | emojify }}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;mt-8 mb-12 border border-2 border-neutral-200 dark:border-neutral-700 rounded shadow-2xl\u0026#34; \u0026gt; \u0026lt;img alt=\u0026#34;404\u0026#34; src=\u0026#34;/404.png\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; {{ end }} é€™å€‹åœ–æª”è¦æ”¾åœ¨ static/404.png ï¼Œhugo åœ¨ç·¨è­¯æ™‚æœƒè‡ªå‹•æŠŠ static ç›®éŒ„ä¸­çš„æª”æ¡ˆæ¬é·åˆ°ç·¨è­¯çµæœ\nLogo å¤§å° # å¦å¤–ç¶²ç«™ Logo çš„éƒ¨åˆ†ä¹Ÿåšäº†èª¿æ•´ï¼ŒåŸæœ¬ä¸»é¡Œæ˜¯å°‡ Logo å¤§å°è¨­å®šæˆåœ–æª”å¤§å°çš„ä¸€åŠï¼Œä½†æ˜¯æˆ‘è¦ºå¾—é‚„æ˜¯å¤ªå¤§äº†ã€‚\næ‰€ä»¥å°±ä¸€æ¨£ï¼ŒæŠŠ Header å°æ‡‰çš„æ¨¡æ¿æ‹¿å‡ºä¾†ç„¶å¾Œå»ä¿®æ”¹ã€‚åœ¨ hugo çš„è³‡æ–™å¤¾çµ„ç¹”ä¸­ï¼Œçµ„æˆç¶²é çš„å…ƒç´ éƒ½æœƒæ”¾åœ¨ partials é€™å€‹ç›®éŒ„ä¸‹ã€‚\nmkdir layouts/partials/headers cp themes/blowfish/layouts/partials/headers/basic ç›´æ¥æ”¹æˆ 32X32 å³å¯ã€‚\n\u0026lt;img src=\u0026#34;{{ $logo.RelPermalink }}\u0026#34; width=\u0026#34;32\u0026#34; height=\u0026#34;32\u0026#34; class=\u0026#34;logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom\u0026#34; alt=\u0026#34;{{ .Site.Title }}\u0026#34; /\u0026gt; Open Graph Image # å¦å¤–ä¸€å€‹æ¯”è¼ƒå¤§çš„æ”¹å‹•æ˜¯ open graph imageã€‚\nOpen graph çš„åŠŸèƒ½æ˜¯æä¾›ç¤¾ç¾¤ç¶²ç«™é¡¯ç¤ºçš„è³‡è¨Šï¼Œæ¯”å¦‚æŠŠé€£çµè²¼åˆ° Facebook æœƒé¡¯ç¤ºå‡ºä¸€å¼µåœ–ç‰‡è·Ÿä¸€äº›ç°¡å–®çš„æè¿°ã€‚é€™äº›æ˜¯é€éç‰¹æ®Šçš„ html header tag é”æˆçš„ã€‚å…¶ä¸­ og:image æ˜¯æä¾› facebook åˆ†äº«æ™‚é¡¯ç¤ºçš„å¤§åœ–ã€‚\n\u0026lt;meta property=\u0026#34;og:url\u0026#34; content=\u0026#34;http://localhost:1313/posts/proxmox-hard-disk-replacement-and-expansion/\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:site_name\u0026#34; content=\u0026#34;Louis Li\u0026amp;#39;s Blog\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:title\u0026#34; content=\u0026#34;Proxmoxç¡¬ç¢Ÿæ›´æ›åŠæ“´å®¹\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:description\u0026#34; content=\u0026#34;åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨å¦‚ä½•åœ¨Proxmoxä¸Šå°‡èˆŠçš„2TB SSDç¡¬ç¢Ÿå‡ç´šè‡³4TBï¼Œä¸¦ç„¡éœ€é‡æ–°å®‰è£ç³»çµ±æˆ–ç§»å‹•è™›æ“¬æ©Ÿçš„æ“ä½œæ­¥é©Ÿå’Œæ–¹æ³•ã€‚\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:locale\u0026#34; content=\u0026#34;zh_tw\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:type\u0026#34; content=\u0026#34;article\u0026#34; /\u0026gt; \u0026lt;meta property=\u0026#34;og:image\u0026#34; content=\u0026#34;http://localhost:1313/og_image.png\u0026#34; /\u0026gt; åœ¨ hugo æä¾›çš„æ¨¡æ¿ä¸­ï¼Œæœƒä½¿ç”¨æ–‡ç« çš„ç¬¬ä¸€å¼µå…§åµŒåœ–ç‰‡é€£çµä½œç‚º og:imageï¼Œä½†æ˜¯å¦‚æœæ–‡ç« æ²’æœ‰åœ–ç‰‡é‚£å°±ä¸æœƒè‡ªå‹•ç”¢ç”Ÿ og:imageï¼Œåœ–ç‰‡ä¹Ÿé™å®šæ–¼æ”¾åœ¨ contents/pages/æ–‡ç« ç›®éŒ„ä¸‹çš„åœ–ç‰‡ã€‚\næ‰€ä»¥æˆ‘å¸Œæœ›èƒ½å¤ ä¿®æ”¹ï¼Œè®“ä»–ä½¿ç”¨æˆ‘ä¹‹å‰è¨­è¨ˆå¥½çš„åœ–ç‰‡ï¼Œç•¶æˆæ‰€æœ‰æ²’æœ‰ og image ç¶²é çš„é è¨­ og imageã€‚\nå»çœ‹ä¸»é¡Œæ¨¡æ¿æœƒç™¼ç¾ï¼Œä»–ä½¿ç”¨ Hugo å…§å»ºçš„ opengraph æ¨¡æ¿ã€‚\n# themes/blowfish/layouts/partials/head.html {{ template \u0026#34;_internal/opengraph.html\u0026#34; . }} å› æ­¤é€™è£¡ä¿®æ”¹æ¯”è¼ƒéº»ç…©ï¼Œé¦–å…ˆæˆ‘å€‘éœ€è¦æŠŠé€™å€‹å…§ç½®çš„æ¨¡æ¿è¤‡è£½ä¸€ä»½åˆ° layouts/partials ç›®éŒ„ï¼Œé€™å€‹æª”æ¡ˆæˆ‘æ‰¾ä¸åˆ°è¦æ€éº¼å–å¾—ï¼Œæœ€å¾Œæ˜¯ç›´æ¥åˆ° hugo çš„ repository å»æŠ“ã€‚\nå¦å¤–æˆ‘å€‘ä¹Ÿéœ€è¦è¤‡è£½ä¸€ä»½ head.html æ¨¡æ¿ï¼Œå› ç‚ºè¦æŠŠåŸæœ¬æ¸²æŸ“å…§å»º opengraph.html è®Šæˆæ¸²æŸ“æˆ‘å€‘æ”¹éçš„ç‰ˆæœ¬ã€‚\n# layouts/partials/head.html {{ partial \u0026#34;opengraph.html\u0026#34; . }} æœ€å¾Œå°±æ˜¯ä¿®æ”¹ opengraph æ¨¡æ¿ï¼Œç•¶æ¨¡æ¿æ‰¾ä¸åˆ°åœ–ç‰‡çš„æ™‚å€™ä½¿ç”¨ä¸€å€‹é è¨­çš„åœ–ç‰‡é€£çµã€‚\n{{- with partial \u0026#34;_funcs/get-page-images\u0026#34; . }} {{- range . | first 6 }} \u0026lt;meta property=\u0026#34;og:image\u0026#34; content=\u0026#34;{{ .Permalink }}\u0026#34;\u0026gt; {{- end }} {{- else }} \u0026lt;meta property=\u0026#34;og:image\u0026#34; content=\u0026#34;{{ site.Params.defaultOpenGraphImage | absURL }}\u0026#34;\u0026gt; {{- end }} ç„¶å¾Œå†è¨­å®šè£¡é¢åŠ å…¥é€™å€‹åœ–ç‰‡çš„é€£çµï¼Œä¸¦æŠŠåœ–ç‰‡æ”¾åˆ° static ç›®éŒ„ã€‚\n# config/_default/hugo.toml [params] defaultOpenGraphImage = \u0026#34;/og_image.png\u0026#34; æˆæœ # åˆ°é€™é‚Šæˆ‘çš„æ•´å€‹ Hugo éœæ…‹éƒ¨è½æ ¼å°±å»ºç«‹å®Œæˆæ‹‰ã€‚\nPageSpeed Insights è¡Œå‹•è£ç½®èƒ½å¤ æ‹¿åˆ° 97 åˆ†ï¼ŒçœŸèˆ’é©ã€‚\n","date":"October 17 2024","externalUrl":null,"permalink":"/posts/from-vuepress-to-hugo/","section":"æ–‡ç« ","summary":"","title":"å¾ VuePress è·‘åˆ° Hugo","type":"posts"},{"content":"","date":"August 3 2023","externalUrl":null,"permalink":"/tags/lvm/","section":"æ¨™ç±¤","summary":"","title":"LVM","type":"tags"},{"content":"","date":"August 3 2023","externalUrl":null,"permalink":"/categories/proxmox/","section":"åˆ†é¡","summary":"","title":"Proxmox","type":"categories"},{"content":"åœ¨æ‰‹é‚Šçš„ Proxmox ä¸Šä½¿ç”¨äº†ä¸€å¹´å¤šçš„æ™‚é–“ï¼Œæœ€åˆæ˜¯ä½¿ç”¨ä¸€é¡† 2TB çš„ SSD ç¡¬ç¢Ÿï¼Œä½†éš¨è‘—æ™‚é–“æ¨ç§»ï¼Œç¡¬ç¢Ÿçš„å®¹é‡å·²ç¶“ä¸è¶³ä»¥æ‡‰ä»˜éœ€æ±‚ã€‚ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼Œæ±ºå®šè³¼è²·ä¸€é¡† 4TB çš„ SSD ä¾†æ›¿æ›ã€‚ç„¶è€Œï¼Œç‚ºäº†ç¯€çœæ™‚é–“å’Œæ–¹ä¾¿èµ·è¦‹ï¼Œå¸Œæœ›èƒ½å¤ ç›´æ¥å°‡èˆŠç¡¬ç¢Ÿçš„å…§å®¹é·ç§»åˆ°æ–°ç¡¬ç¢Ÿä¸Šï¼Œè€Œä¸å¿…é‡æ–°å®‰è£ Proxmox ç³»çµ±ï¼Œä¹Ÿä¸éœ€è¦æ¬é·è™›æ“¬æ©Ÿã€‚å› æ­¤ï¼Œé€²è¡Œäº†ä¸€äº›ç ”ç©¶å’Œæ“ä½œä¾†å¯¦ç¾é€™å€‹ç›®æ¨™ï¼Œé€™è£¡è¨˜éŒ„ä¸‹ç›¸é—œçš„æ­¥é©Ÿå’Œæ–¹æ³•ã€‚\nç¡¬ç¢Ÿå…§å®¹æ¬é· # é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦å°‡åŸå§‹ç¡¬ç¢Ÿå…§çš„è³‡æ–™æ¬ç§»åˆ°æ–°çš„ç¡¬ç¢Ÿä¸Šã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ dd å‘½ä»¤ç›´æ¥å°‡ç¡¬ç¢Ÿå…§å®¹å®Œå…¨è¤‡è£½éå»ã€‚é€™å¯ä»¥åœ¨ Proxmox çš„ Shell ä¸­åŸ·è¡Œï¼Œç„¡éœ€ä½¿ç”¨é¡å¤–çš„ USB é–‹æ©Ÿç¢Ÿæ“ä½œã€‚å„˜ç®¡é€™æ¨£åšå¯èƒ½æœƒè¤‡è£½ swap ç­‰å…§å®¹ï¼Œä½†é‡é–‹æ©Ÿå¾Œä¸æœƒå½±éŸ¿ç³»çµ±é‹ä½œã€‚\nè«‹å…ˆä½¿ç”¨ lsblk å‘½ä»¤æ‰¾åˆ°åŸå§‹ç¡¬ç¢Ÿå’Œç›®æ¨™ç¡¬ç¢Ÿï¼š\n# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme0n1 259:0 0 1.7T 0 disk â”œâ”€nvme0n1p1 259:1 0 1007K 0 part â”œâ”€nvme0n1p2 259:2 0 512M 0 part /boot/efi â””â”€nvme0n1p3 259:3 0 1.7T 0 part â”œâ”€pve-swap 253:0 0 8G 0 lvm [SWAP] â”œâ”€pve-root 253:1 0 96G 0 lvm / â”œâ”€pve-data_tmeta 253:2 0 15.8G 0 lvm â”‚ â””â”€pve-data-tpool 253:4 0 1.7T 0 lvm â”‚ â”œâ”€pve-data 253:5 0 1.7T 1 lvm â”‚ â”œâ”€pve-vm--100--disk--0 253:6 0 1T 0 lvm .... nvme1n1 259:4 0 3.6T 0 disk å¾ä¸Šè¿°è¼¸å‡ºä¸­ï¼Œæˆ‘å€‘å¯ä»¥å¾ˆå®¹æ˜“åœ°è¾¨è­˜å‡º nvme0n1 ç‚ºåŸå§‹ç¡¬ç¢Ÿï¼Œnvme1n1 ç‚ºæ–°çš„ç¡¬ç¢Ÿã€‚\næ¥ä¸‹ä¾†ï¼Œä½¿ç”¨ dd å‘½ä»¤é€²è¡Œç¡¬ç¢Ÿå…§å®¹çš„è¤‡è£½ã€‚ç‚ºäº†åœ¨è™•ç†éç¨‹ä¸­é¡¯ç¤ºé€²åº¦ï¼Œæˆ‘å€‘åŠ ä¸Š status=progress é¸é …ã€‚é€™æ¨£åœ¨è¤‡è£½ 2TB è³‡æ–™æ™‚ï¼Œæˆ‘å€‘å¯ä»¥çŸ¥é“é€²åº¦ï¼Œè€Œä¸æœƒç­‰å¤ªä¹…ä¸çŸ¥é“æ˜¯ä¸æ˜¯ç•¶æ‰äº† (æ¬äº†è¶…éåŠå°æ™‚)ã€‚bs åƒæ•¸ä»£è¡¨ dd ä¸€æ¬¡æ¬å‹•çš„è³‡æ–™å¡Šå¤§å°ï¼Œé è¨­å€¼æ˜¯ 512bytesï¼Œä½†é€™å¯èƒ½æœƒå°è‡´é€Ÿåº¦è®Šæ…¢ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é¸æ“‡è¼ƒå¤§çš„å€¼ï¼Œä¾‹å¦‚ bs=2Gã€‚\n# dd if=/dev/nvme0n1 of=/dev/nvme1n1 status=progress bs=2G å®Œæˆå¾Œï¼Œé—œæ©Ÿä¸¦å°‡èˆŠçš„ç¡¬ç¢Ÿç§»é™¤ï¼Œç”¨æ–°çš„ç¡¬ç¢Ÿé–‹æ©Ÿã€‚\nèª¿æ•´ç¡¬ç¢Ÿåˆ†å‰²å€å¤§å° # ç†è«–ä¸Šï¼Œé‡é–‹æ©Ÿå¾Œï¼Œæ‡‰è©²å¯ä»¥æ­£å¸¸é€²å…¥ç³»çµ±ï¼Œä½†å¾ Proxmox çš„ Web GUI å¯èƒ½æœƒç™¼ç¾å­˜å„²ç©ºé–“çš„å¤§å°æ²’æœ‰è®ŠåŒ–ã€‚é€™æ˜¯å› ç‚ºé›–ç„¶è³‡æ–™å·²ç¶“å®Œå…¨è¤‡è£½åˆ°å®¹é‡æ›´å¤§çš„ç¡¬ç¢Ÿï¼Œä½†ç³»çµ±è¨­å®šä»ç„¶åªèªè­˜åŸæœ¬çš„ç¡¬ç¢Ÿå¤§å°ã€‚å› æ­¤ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘éœ€è¦èª¿æ•´åˆ†å‰²å€å’Œ LVM çš„é…ç½®ï¼Œè®“ Proxmox èƒ½å¤ ä½¿ç”¨æ–°çš„ç©ºé–“ã€‚\n# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme0n1 259:0 0 3.6T 0 disk â”œâ”€nvme0n1p1 259:1 0 1007K 0 part â”œâ”€nvme0n1p2 259:2 0 512M 0 part /boot/efi â””â”€nvme0n1p3 259:3 0 1.7T 0 part â”œâ”€pve-swap 253:0 0 8G 0 lvm [SWAP] â”œâ”€pve-root 253:1 0 96G 0 lvm / â”œâ”€pve-data_tmeta 253:2 0 15.8G 0 lvm â”‚ â””â”€pve-data-tpool 253:4 0 1.7T 0 lvm â”‚ â”œâ”€pve-data 253:5 0 1.7T 1 lvm â”‚ â”œâ”€pve-vm--100--disk--0 253:6 0 1T 0 lvm é€é lsblkï¼Œå¯ä»¥çœ‹åˆ°ç¡¬ç¢Ÿçš„å¤§å°ç‚º 3.6Tã€‚ç”±æ–¼ pve çš„è³‡æ–™éƒ½æ”¾åœ¨ nvem0n1p3 é€™å€‹åˆ†å‰²å€ä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘å€‘è¦å…ˆèª¿æ•´åˆ†å‰²å€çš„å¤§å°ã€‚\né€™é‚Šæˆ‘å€‘ä½¿ç”¨ growpart é€™å€‹å·¥å…·ä¾†èª¿æ•´åˆ†å‰²å€å¤§å°ã€‚\napt install cloud-guest-utils growpart /dev/nvme0n1 3 growpart çš„ç¬¬ä¸€å€‹åƒæ•¸æ˜¯è¦èª¿æ•´çš„ç¡¬ç¢Ÿï¼Œç¬¬äºŒå€‹åƒæ•¸æ˜¯ç¬¬å¹¾å€‹åˆ†å‰²å€ã€‚growpart é è¨­æœƒå°‡ç¡¬ç¢Ÿçš„å‰©é¤˜æœªåˆ†é…ç©ºé–“éƒ½åˆ†é…çµ¦åˆ†å‰²å€ï¼Œå› æ­¤ä¸éœ€è¦æŒ‡å®šå¤§å°ã€‚å¦‚æœä½ æ“”å¿ƒå‡ºå•é¡Œï¼Œå¯ä»¥å…ˆåŠ ä¸Š -N é¸é …æŸ¥çœ‹åˆ†é…çš„çµæœæ˜¯å¦ç¬¦åˆé æœŸã€‚\nåˆ†é…å®Œæˆå¾Œï¼Œå†æ¬¡ä½¿ç”¨ lsblk å‘½ä»¤ä¾†ç¢ºèªã€‚ç¾åœ¨ï¼Œnvme0n1p3 åˆ†å‰²å€çš„å¤§å°æ‡‰è©²å·²ç¶“è®Šæˆ 3.6T äº†ï¼š\n# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme0n1 259:0 0 3.6T 0 disk â”œâ”€nvme0n1p1 259:1 0 1007K 0 part â”œâ”€nvme0n1p2 259:2 0 512M 0 part /boot/efi â””â”€nvme0n1p3 259:3 0 3.6T 0 part â”œâ”€pve-swap 253:0 0 8G 0 lvm [SWAP] â”œâ”€pve-root 253:1 0 96G 0 lvm / â”œâ”€pve-data_tmeta 253:2 0 15.8G 0 lvm â”‚ â””â”€pve-data-tpool 253:4 0 1.7T 0 lvm â”‚ â”œâ”€pve-data 253:5 0 1.7T 1 lvm â”‚ â”œâ”€pve-vm--100--disk--0 253:6 0 1T 0 lvm ä½†æ˜¯å¾ Proxmox çš„ Web GUIï¼Œä½ å¯èƒ½æœƒç™¼ç¾å­˜å„²ç©ºé–“å¤§å°é‚„æ˜¯æ²’æœ‰æ”¹è®Šã€‚é€™æ˜¯å› ç‚º Proxmox åœ¨ partition ä¸Šé€é LVM åšäº†ä¸€å±¤åˆ†å‰²ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦èª¿æ•´ LVM çš„å¤§å°ã€‚\nèª¿æ•´ LVM # é¦–å…ˆï¼Œæˆ‘å€‘è¦èª¿æ•´ç¡¬ç¢Ÿåˆ†å‰²å€å°æ‡‰çš„ PVï¼ˆç‰©ç†å·ï¼‰å¤§å°ï¼š\n# pvs PV VG Fmt Attr PSize PFree /dev/nvme0n1p3 pve lvm2 a-- \u0026lt;1.74t \u0026lt;0.2t ä½¿ç”¨ pvs å‘½ä»¤å¯ä»¥æŸ¥çœ‹ PV çš„è³‡è¨Šã€‚\næ¥ä¸‹ä¾†ï¼Œä½¿ç”¨ pvresize å‘½ä»¤å°‡åˆ†å‰²å€å‰©é¤˜çš„æ‰€æœ‰ç©ºé–“éƒ½åŠ å…¥åˆ° PV å…§ï¼š\npvresize /dev/nvme0n1p3 é€™æ¨£å°±èƒ½å°‡åˆ†å‰²å€æœªä½¿ç”¨çš„ç©ºé–“åŠ å…¥åˆ° PVï¼Œç„¡éœ€é€²è¡Œå…¶ä»–é…ç½®ã€‚\nå†æ¬¡åŸ·è¡Œ pvs å‘½ä»¤ï¼Œç¾åœ¨ä½ æ‡‰è©²æœƒçœ‹åˆ° PV çš„å¤§å°å·²ç¶“å¢åŠ äº†ï¼š\n# pvs PV VG Fmt Attr PSize PFree /dev/nvme0n1p3 pve lvm2 a-- \u0026lt;3.64t \u0026lt;1.84t æœ€å¾Œï¼Œæˆ‘å€‘éœ€è¦èª¿æ•´ storage å°æ‡‰çš„ LVï¼ˆé‚è¼¯å·ï¼‰çš„å¤§å°ã€‚é¦–å…ˆï¼Œä½¿ç”¨ lvs å‘½ä»¤ä¾†æŸ¥çœ‹ LV çš„è³‡è¨Š\n# lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert data pve twi-aotz-- 1.67t 73.80 3.82 root pve -wi-ao---- 96.00g swap pve -wi-ao---- 8.00g vm-100-disk-0 pve Vwi-aotz-- 1.00t data 57.73 vm-100-disk-1 pve Vwi-aotz-- 4.00m data 14.06 vm-101-disk-0 pve Vwi-a-tz-- 100.00g data 71.78 vm-102-disk-0 pve Vwi-aotz-- 4.00m data 14.06 ... å¾ä¸Šè¿°è¼¸å‡ºä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰ VM çš„ç¡¬ç¢Ÿéƒ½æ›è¼‰åœ¨ pve/data é€™å€‹ pool ä¸‹é¢ã€‚å› æ­¤ï¼Œæˆ‘å€‘éœ€è¦èª¿æ•´çš„æ˜¯ pve/data çš„å¤§å°ã€‚\nä½¿ç”¨ lvresize å‘½ä»¤ä¾†èª¿æ•´ LV åˆ†é…çš„ç©ºé–“ï¼Œ -l è¡¨ç¤ºæ“´å¤§ï¼Œ +100%FREE è¡¨ç¤ºå°‡æ‰€æœ‰é–’ç½®ç©ºé–“åˆ†é…çµ¦è©² LVï¼Œæœ€å¾ŒæŒ‡å®š pve/dataï¼š\nlvresize -l +100%FREE pve/data åŸ·è¡Œå®Œå¾Œå†æ¬¡ä½¿ç”¨ lvs å‘½ä»¤ç¢ºèªï¼Œç¾åœ¨ data çš„å¤§å°æ‡‰è©²å·²ç¶“è®Šå¤§äº†ï¼š\n# lvs lvs LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert data pve twi-aotz-- \u0026lt;3.51t 35.16 3.86 root pve -wi-ao---- 96.00g swap pve -wi-ao---- 8.00g vm-100-disk-0 pve Vwi-aotz-- 1.00t data 57.73 vm-100-disk-1 pve Vwi-aotz-- 4.00m data 14.06 ç¾åœ¨ï¼Œå¾ Proxmox Web GUIï¼Œä½ ä¹Ÿæ‡‰è©²å¯ä»¥çœ‹åˆ°å­˜å„²ç©ºé–“å¤§å°å·²æˆåŠŸèª¿æ•´ã€‚\n","date":"August 3 2023","externalUrl":null,"permalink":"/posts/proxmox-hard-disk-replacement-and-expansion/","section":"æ–‡ç« ","summary":"","title":"Proxmox ç¡¬ç¢Ÿæ›´æ›åŠæ“´å®¹","type":"posts"},{"content":"","date":"August 3 2023","externalUrl":null,"permalink":"/tags/%E7%A1%AC%E7%A2%9F%E6%90%AC%E9%81%B7/","section":"æ¨™ç±¤","summary":"","title":"ç¡¬ç¢Ÿæ¬é·","type":"tags"},{"content":"","date":"November 3 2022","externalUrl":null,"permalink":"/tags/debug/","section":"æ¨™ç±¤","summary":"","title":"Debug","type":"tags"},{"content":"","date":"November 3 2022","externalUrl":null,"permalink":"/categories/openstack/","section":"åˆ†é¡","summary":"","title":"OpenStack","type":"categories"},{"content":"åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘å€‘ä»‹ç´¹äº† Openstack çš„å¹¾ç¨®ç¶²è·¯æ¶æ§‹ï¼Œä¸¦ä½¿ç”¨ Openstack-Ansible (OSA) å®Œæˆäº† Openstack çš„éƒ¨å±¬ï¼Œä»Šå¤©å‰‡æœƒç°¡å–®ç´€éŒ„ä¸€ä¸‹åœ¨å®Œæˆ OSA éƒ¨å±¬ä¹‹å¾Œæ€éº¼æ“ä½œ openstackã€‚\nä½¿ç”¨ openstack CLI # å®Œæˆ OSA éƒ¨å±¬ä¹‹å¾Œï¼Œåœ¨æ§åˆ¶ç¯€é»ä¸Šå¯ä»¥ä½¿ç”¨ lxc-ls -fÂ æŒ‡ä»¤æŸ¥çœ‹ LXC è³‡è¨Šã€‚\n# lxc-ls -f NAME STATE AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED infra1_galera_container-763c1458 RUNNING 1 onboot, openstack 10.0.3.44, 192.168.56.132 - false infra1_glance_container-ecb3abc2 RUNNING 1 onboot, openstack 10.0.3.174, 192.168.56.4 - false infra1_horizon_container-3c77d785 RUNNING 1 onboot, openstack 10.0.3.30, 192.168.56.238 - false infra1_keystone_container-40e90a3e RUNNING 1 onboot, openstack 10.0.3.19, 192.168.56.108 - false infra1_memcached_container-7a783869 RUNNING 1 onboot, openstack 10.0.3.242, 192.168.56.196 - false infra1_neutron_server_container-35c98df6 RUNNING 1 onboot, openstack 10.0.3.36, 192.168.56.74 - false infra1_nova_api_container-775a3593 RUNNING 1 onboot, openstack 10.0.3.225, 192.168.56.244 - false infra1_placement_container-dac38473 RUNNING 1 onboot, openstack 10.0.3.226, 192.168.56.33 - false infra1_rabbit_mq_container-c2bb7a2e RUNNING 1 onboot, openstack 10.0.3.20, 192.168.56.115 - false infra1_repo_container-23639b71 RUNNING 1 onboot, openstack 10.0.3.129, 192.168.56.94 - false infra1_rsyslog_container-509d2d2f RUNNING 1 onboot, openstack 10.0.3.164, 192.168.56.141 - false infra1_utility_container-4b62f537 RUNNING 1 onboot, openstack 10.0.3.198, 192.168.56.75 - false å…¶ä¸­å¯ä»¥çœ‹åˆ°ä¸€å€‹ utility_containerï¼Œæ˜¯ OSA ç”¨ä¾†æä¾› openstack cli çš„ LXCã€‚\né€é lxc-attach infra1_utility_container-4b62f537Â é€²å…¥ LXCã€‚\nåœ¨ä½¿ç”¨ openstack cli ä¹‹å‰è¦å°‡ admin ç™»å…¥è³‡è¨Šè¼‰å…¥ç’°å¢ƒè®Šæ•¸ï¼Œå¯ä»¥é€éæŒ‡ä»¤ . ~/openrcã€‚\næ¥è‘—å°±å¯ä»¥é€é openstackÂ é€™å€‹æŒ‡ä»¤è·Ÿ cluster äº’å‹•ã€‚\n# openstack user list --os-cloud=default +----------------------------------+-----------+ | ID | Name | +----------------------------------+-----------+ | 8291fddd2a80414d8f1b3cb40ff720c0 | admin | | 3761aw47e9204a8090843b00705b0ea8 | placement | | 4526a5q64f9a48dc9752b577e26559b9 | glance | | 2dbf52994f7f49a1b6eb5afdc6590781 | nova | | b7866083ve63469f93bd26e72a141a13 | neutron | +----------------------------------+-----------+ è¨ªå• horizon web GUI # é€éä¹‹å‰åœ¨ /etc/openstack_deploy/openstack_user_config.ymlÂ è¨­ç½®çš„ external_lb_vip_addressï¼Œé€éç€è¦½å™¨ https è¨ªå•è©²ç¶²å€ã€‚\nå¸³è™Ÿæ˜¯ adminï¼Œå¯†ç¢¼å¯ä»¥ç›´æ¥åœ¨å‰é¢æåˆ°çš„ openrc æª”æ¡ˆè£¡é¢æ‰¾åˆ° OS_PASSWORDï¼Œæˆ–è‘—åˆ° deployment host çš„ /etc/openstack_deploy/user_secrets.ymlÂ ä¸­æ‰¾åˆ° keystone_auth_admin_passwordã€‚\nè™›æ“¬æ©Ÿå»ºç«‹æµç¨‹ # å‡è¨­å‰é¢ä½¿ç”¨ OSA éƒ¨ç½²å®Œæˆï¼Œä¸¦ä½¿ç”¨ flatÂ ç¶²è·¯æ¨¡å¼ï¼Œé ç•™ 192.168.56.100-200/24 ä½œç‚ºè™›æ“¬æ©Ÿ IPï¼Œgateway ç‚º 195.168.56.1ã€‚\né¦–å…ˆæˆ‘å€‘è¦ä¸‹è¼‰ä¸€å€‹ VM çš„æ˜ è±¡æª”ï¼Œé€™é‚Šä½¿ç”¨ openstack ç¤ºç¯„ä½¿ç”¨çš„ cirrosï¼Œé€™æ˜¯ä¸€å€‹åªæœ‰ 13Mb å¤§å°çš„ imgï¼Œé©åˆæ‹¿ä¾†æ¸¬è©¦ã€‚ä¸¦å°‡å…¶ä¸Šå‚³åˆ° glance ä¸Šã€‚\nwget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img glance image-create --name \u0026#34;cirros\u0026#34; \\ --file cirros-0.4.0-x86_64-disk.img \\ --disk-format qcow2 --container-format bare \\ --visibility=public æ¥è‘—æˆ‘å€‘è¦å°‡ flatÂ ç¶²è·¯åŠ å…¥ openstackï¼Œå‡è¨­å‰é¢éƒ¨å±¬çš„æ™‚å€™å°‡ net_nameÂ è¨­ç½®ç‚º flat_net\nopenstack network create --external --share \\ --provider-physical-network flat_net --provider-network-type flat \\ flat_network neutron æœƒç‚º VM åˆ†é… IPï¼Œå› æ­¤è¦è¨­ç½® ip pool\nopenstack subnet create --network flat_network \\ --allocation-pool start=192.168.56.100,end=192.168.56.200 \\ --dns-nameserver 8.8.4.4 --gateway 192.168.56.1 \\ --subnet-range 192.168.56.0/24 flat_ip_pool æ¥è‘—æˆ‘å€‘è¦å»ºç«‹ä¸€å€‹ flavorï¼Œä½œç‚ºè™›æ“¬æ©Ÿçš„æ¨¡æ¿ï¼Œå®šç¾© VM çš„è¦æ ¼ï¼ŒåŒ…å« CPU, memory, disk çš„å¤§å°\nopenstack flavor create --vcpus 1 --ram 512 --disk 1 m1.tiny æ¥è‘—æˆ‘å€‘å°±å¯ä»¥çœŸçš„å°‡é€™å€‹ VM å»ºç«‹å‡ºä¾†äº†\nopenstack server create --flavor m1.tiny --image cirros --security-group default test å› ç‚ºæˆ‘å€‘ç¾åœ¨åªå»ºç«‹äº†ä¸€å€‹ networkï¼Œå› æ­¤å¯ä»¥ç›´æ¥çœç•¥ï¼Œå¦‚æœå­˜åœ¨å¤šå€‹ networkï¼Œå°±éœ€è¦ä¸‹ â€“network åƒæ•¸\nç‚ºäº†è¦æ¸¬è©¦ï¼Œè™›æ“¬æ©Ÿæ˜¯å¦æ­£å¸¸ï¼Œæˆ‘å€‘å¯ä»¥é€é ssh é€£é€²å»è™›æ“¬æ©Ÿè£¡é¢é€²è¡Œæ“ä½œ\né¦–å…ˆæˆ‘å€‘è¦ä¿®æ”¹ vm çš„ security group ruleï¼Œsecurity group æ˜¯ openstack æä¾›é˜²ç«ç‰†ç®¡ç†çš„æ©Ÿåˆ¶ï¼Œå°‡ VM åŠƒåˆ†æˆå¤šå€‹ security groupï¼Œçµ±ä¸€å¥—ç”¨ç‰¹å®šçš„é˜²ç«ç‰†è¦å‰‡ï¼Œé è¨­çš„ defualt group æ˜¯ä¸å…è¨±ä»»ä½• ingress æµé‡çš„ï¼Œå› æ­¤æˆ‘å€‘è¦è®“ä»–æ”¾è¡Œ ssh å’Œ icmp æ–¹ä¾¿æ¸¬è©¦ã€‚\nopenstack security group rule create --protocol tcp --ingress --dst-port 22 --remote-ip 0.0.0.0/0 \u0026lt;group id\u0026gt; openstack security group rule create --protocol icmp --remote-ip 0.0.0.0/0 \u0026lt;group id\u0026gt; é€™é‚Šè¦å¡«å…¥ security group idï¼Œå¯ä»¥é€éå‰›å‰›å»ºç«‹ VM çš„çµæœè³‡è¨Šè£¡é¢æ‰¾åˆ°ï¼Œæˆ–è‘—é€é openstack security group listÂ æŸ¥çœ‹ã€‚\næ¥è‘—æˆ‘å€‘å°±å¯ä»¥é€é ssh é€£å…¥ VM å…§éƒ¨\nopenstack server ssh -4 --private --login cirros test cirros çš„å¸³è™Ÿå¯†ç¢¼æ˜¯ cirros/gocubsgo\n","date":"November 3 2022","externalUrl":null,"permalink":"/posts/openstack-deployment-serial-3-basic-management-commands/","section":"æ–‡ç« ","summary":"","title":"OpenStack æ¶è¨­ç³»åˆ—æ–‡ç«  (3) - åŸºæœ¬æŒ‡ä»¤æ“ä½œ","type":"posts"},{"content":"","date":"November 3 2022","externalUrl":null,"permalink":"/tags/%E7%B3%BB%E7%B5%B1%E5%BB%BA%E7%BD%AE%E6%95%99%E5%AD%B8/","section":"æ¨™ç±¤","summary":"","title":"ç³»çµ±å»ºç½®æ•™å­¸","type":"tags"},{"content":"é€™ç¯‡è¨˜éŒ„ä¸€ä¸‹ï¼Œåœ¨ä½¿ç”¨ openstack æ™‚ï¼Œé‡åˆ°çš„å¹¾ç¨®å»ºç«‹å¤±æ•—æƒ…æ³å’Œè§£æ±ºæ–¹æ³•\nQuota exceeded # openstack é€é Quota ä¾†é™åˆ¶æ¯å€‹ project å¯ä»¥ä½¿ç”¨çš„è³‡æºé‡ï¼Œç•¶è¶…éé™åˆ¶æ™‚ï¼Œå°±æœƒå‡ºç¾é€™å€‹éŒ¯èª¤è¨Šæ¯ã€‚é è¨­ admin project ä¹Ÿæœƒæœ‰é€™å€‹é™åˆ¶ï¼Œè€Œä¸”é è¨­å€¼å…¶å¯¦å¾ˆå°ï¼Œå¦‚ instancesã€CPU å’Œ memory çš„é™åˆ¶\n10 instances 20 vCPU 51200 MB RAM é€éæŒ‡ä»¤ openstack quota showÂ å¯ä»¥æŸ¥çœ‹ç›®å‰çš„é™åˆ¶ä¸¦é€é quota set --cores/ram/instance... 200 \u0026lt;project\u0026gt;Â ä¾†ä¿®æ”¹å„ç¨®é™åˆ¶ è³‡æºä¸è¶³ # ä¹Ÿæœ‰å¯èƒ½æ˜¯å› ç‚º openstack cluster å·²ç¶“æ²’æœ‰è¶³å¤ å¤šçš„ cpu, memory æˆ–ç¡¬ç¢Ÿå¯ä»¥åˆ†é…çµ¦è™›æ“¬æ©Ÿäº†ã€‚\næœ€ç°¡å–®æ–¹æ³•æ˜¯å¢åŠ æ–°çš„æ©Ÿå™¨ä¾†æ‡‰ä»˜éœ€æ±‚ã€‚\nä½†æ˜¯é€šé€šä¾†èªªï¼Œåˆ†é… 8GB çš„ RAM çµ¦è™›æ“¬æ©Ÿä¸ä»£è¡¨è™›æ“¬æ©Ÿæœƒåƒæ»¿ 8GB çš„ RAMï¼Œå› æ­¤åœ¨ä¸€å°æœ‰ 100GB RAM çš„æ©Ÿå™¨ä¸Šï¼Œé–‹ 50 å° 8GB RAM ä½†æ˜¯å¯¦éš›ä¸Šåªæœƒç”¨åˆ° 1GB RAM çš„è™›æ“¬æ©Ÿï¼Œæ˜¯ä¸æœƒæœ‰å•é¡Œçš„ã€‚\nå› æ­¤æˆ‘å€‘å°±éœ€è¦èª¿æ•´ allocation ratioï¼Œallocation ratio è¡¨ç¤º openstack å¯ä»¥åˆ†é…å€ç‰©ç†è¨­å‚™æ“æœ‰çš„è³‡æºçµ¦è™›æ“¬æ©Ÿï¼Œä¾‹å¦‚å‰é¢çš„ä¾‹å­ä¸­ï¼Œ50 å° 8GB RAM çš„æ©Ÿå™¨éœ€è¦ 400GB çš„ ramã€‚ä½†æ˜¯å¯¦éš›ä¸Š server åªæœ‰ 100GB çš„ RAM é‚„è¦æ‰£æ‰ 2GB æ˜¯é ç•™çµ¦ host æœ¬èº«é‹è¡Œä½¿ç”¨ï¼Œå› æ­¤åªå‰©ä¸‹ 98GB çš„ RAM å¯ä»¥åˆ†é…çµ¦è™›æ“¬æ©Ÿï¼Œå› æ­¤ allocation ratio æœ€å°‘éœ€è¦æ˜¯ 400/98=4.1ã€‚\nåœ¨æ¯å€‹ compute nodeï¼Œå¯ä¿®æ”¹ /etc/nova/nova.confÂ é€™å€‹æª”æ¡ˆä¸­çš„ä¸‰å€‹åƒæ•¸ï¼Œå°æ‡‰åˆ° cpu, disk, ram çš„ allocation ratioã€‚\ncpu_allocation_ratio disk_allocation_ratio ram_allocation_ratio ä¿®æ”¹å®Œå¾Œè¦é‡å•Ÿ novaã€‚service nova-compute restart å¯ä»¥é€éæŒ‡ä»¤æŸ¥çœ‹å„å€‹è¨­å‚™ä¸Š resource çš„ä½¿ç”¨æƒ…æ³\n# openstack allocation candidate list --os-placement-api-version 1.12 --resource VCPU=1 --resource MEMORY_MB=1024 --resource DISK_GB=10 +---+----------------------------------+--------------------------------------+------------------------------------------+ | # | allocation | resource provider | inventory used/capacity | +---+----------------------------------+--------------------------------------+------------------------------------------+ | 1 | VCPU=1,MEMORY_MB=1024,DISK_GB=10 | 000ab365-74ea-4c16-9aaa-3a2bdea6238c | VCPU=1/4,MEMORY_MB=512/3893,DISK_GB=1/30 | +---+----------------------------------+--------------------------------------+------------------------------------------+ å…¶ä¸­æ¯ä¸€å€‹ resource provider éƒ½æ˜¯ä¸€å€‹ compute nodeï¼Œå¯ä»¥é€é openstack resource provider listÂ æŸ¥çœ‹å°æ‡‰åˆ°å“ªä¾†è¨­å‚™ 8944ã€‚\n","date":"November 3 2022","externalUrl":null,"permalink":"/posts/solve-openstack-vm-create-fail/","section":"æ–‡ç« ","summary":"","title":"è§£æ±º OpenStack  VM å»ºç«‹å¤±æ•—å•é¡Œ","type":"posts"},{"content":"","date":"November 1 2022","externalUrl":null,"permalink":"/tags/lxc/","section":"æ¨™ç±¤","summary":"","title":"LXC","type":"tags"},{"content":"åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘ä»‹ç´¹äº† Openstack çš„å¹¾ç¨® ç¶²è·¯æ¶æ§‹ï¼Œä»Šå¤©æˆ‘å€‘è¦ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Openstack å®˜æ–¹æä¾›çš„ Openstack-Ansible (OSA) ä¾†å®Œæˆ Opentack çš„éƒ¨ç½²ã€‚\næœ¬ç¯‡æ–‡ç« ä»¥ Openstack Victoria ç‰ˆæœ¬ç‚ºä¾‹ï¼Œå®‰è£åœ¨ä½œæ¥­ç³»çµ±ç‚º ubuntu çš„è¨­å‚™ä¸Šï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½æœƒæœ‰æ‰€ä¸åŒã€‚å¦å¤–æœ¬ç¯‡æ–‡ç« ä¸»è¦å°ˆæ³¨åœ¨ä½¿ç”¨ nova å»ºç«‹è™›æ“¬æ©Ÿæœå‹™ï¼Œå› æ­¤æœƒéƒ¨åˆ†çœç•¥æ‰ cinder ç­‰ opentstack å„²å­˜åŠŸèƒ½çš„éƒ¨åˆ†ã€‚\nä»‹ç´¹ # Openstack æ˜¯ç”± keystoneã€glance ç­‰å¤šå€‹çµ„ä»¶çµ„æˆï¼Œçµ„ä»¶ä¸‹åˆéœ€è¦ dabase base å’Œ message queue ç­‰æœå‹™ï¼Œå†åŠ ä¸Šéœ€è¦åœ¨æ¯å€‹é‹ç®—ç¯€é»ä¸Šéƒ¨å±¬çš„ novaã€neutronï¼Œå¦‚æœè¦æ‰‹å‹•éƒ¨ç½²ï¼Œæœƒéœ€è¦èŠ±è²»å¤§é‡çš„æ™‚é–“ã€å®¹æ˜“å‡ºéŒ¯ï¼Œä¹Ÿä¸åˆ©æ–¼æ“´å±•ã€‚å› æ­¤ Openstack å®˜æ–¹æä¾›äº† Openstack-Ansible (OSA)ï¼Œä½¿ç”¨ Ansible ä¾†è‡ªå‹•åŒ–éƒ¨ç½²åŠæ“´å±• Openstack clusterã€‚\né¦–å…ˆå¿…é ˆè¦çŸ¥é“é€é OSA éƒ¨å±¬çš„ openstack clauster åœ¨æ¶æ§‹ä¸Šæœƒèˆ‡æ‰‹å‹•å®‰è£æ–‡ä»¶æ•™çš„æ–¹å¼æœ‰äº›å·®ç•°ã€‚\næ‰€æœ‰ Controller node ä¸Šçš„ openstack çµ„ä»¶è¢«éƒ¨å±¬åœ¨ç¨ç«‹çš„ linux contaienr (LXC) å…§ï¼ŒLXC é€é linux bridge ç›´æ¥æš´éœ²åœ¨å¤–éƒ¨ç¶²è·¯ä¸­ï¼Œèˆ‡ç¯€é»å€‘è™•åœ¨åŒä¸€å€‹å­ç¶²æ®µå…§ï¼Œå¯ä»¥ç›´æ¥äº’ç›¸è¨ªå• controller node ä¸Šçš„çµ„å»ºä¹‹é–“ä¸ç›´æ¥äº’ç›¸è¨ªå•ï¼Œè€Œæ˜¯é€éä¸€å€‹ haproxyÂ åšä½œç‚ºé€²å…¥é»ï¼Œæä¾›é™„è¼‰å‡è¡¡å’Œé«˜å¯ç”¨ã€‚haproxy æœƒè¢«ç›´æ¥éƒ¨å±¬åœ¨æ§åˆ¶ç¯€é»ä¸Šï¼Œè€Œä¸æœƒè¢«éƒ¨å±¬åœ¨ LXC å…§ã€‚ å¦å¤–åœ¨åœ¨ OSA çš„æ–‡ä»¶å…§ï¼Œç”¨ä¾†åŸ·è¡Œ ansible playbook çš„ç¯€é»ç¨±ä¹‹ç‚º deployment hostï¼Œè€Œè¢«éƒ¨å±¬ openstack çš„ controller node å’Œ compute node è¢«çµ±ç¨±ç‚º taget hostã€‚ä¸éåœ¨å¯¦éš›æ“ä½œçš„æ™‚å€™ deployment host ä¸ä¸€å®šéœ€è¦æ˜¯ä¸€å°ç¨ç«‹çš„è¨­å‚™ï¼Œå¯ä»¥ç›´æ¥æŒ‘ä¸€å° target host ä¾†è·‘ã€‚\nå®‰è£æµç¨‹ # å‰ç½®ä½œæ¥­ # é¦–å…ˆæˆ‘å€‘è¦åœ¨ deployment host ä¸Šå®‰è£ python é‚„æœ‰ OSAã€‚\n# system apt update apt dist-upgrade apt install build-essential git chrony \\ openssh-server python3-dev sudo # OSA git clone -b victoria-em https://opendev.org/openstack/openstack-ansible/opt/openstack-ansible cd /opt/openstack-ansible scripts/bootstrap-ansible.sh æ¥è‘—åœ¨ target hosts ä¸Šæˆ‘å€‘ä¹Ÿéœ€è¦å…ˆå®‰è£ä¸€äº›å¿…å‚™çš„å¥—ä»¶\napt update apt dist-upgrade apt install bridge-utils debootstrap openssh-server \\ tcpdump vlan python3 apt install linux-modules-extra-$(uname -r) Ansible æ˜¯é€é ssh é€£ç·šåˆ°æ¯ä¸€å°ä¸»æ©Ÿä¸Šé¢å®Œæˆå®‰è£ï¼Œä¸” OSA è¦æ±‚åœ¨ deployment å’Œ target hosts ä¸Šéƒ½ä½¿ç”¨ rootã€‚OSA è¦æ±‚çš„ä½œæ³•æ˜¯åœ¨ deployment çš„ root ä¸Šå¸³è™Ÿä¸‹ï¼Œä½¿ç”¨ ssh-keygenÂ ç”Ÿæˆ ssh key ä¸¦å°‡ public key æ”¾åˆ°æ¯å€‹ target host çš„ /root/.ssh/authorized_keys ä¸­ã€‚å¦å¤– OSA é‚„æœƒå°‡ deployment host ä¸Šçš„ /root/.ssh/id_rsa.pubÂ æª”æ¡ˆè¤‡è£½åˆ°æ¯ä¸€å€‹ LXC çš„ authorized_keysï¼Œæ–¹ä¾¿å¾ŒçºŒè¨ªå•ã€‚é€™å€‹å¯ä»¥é€é lxc_container_ssh_keyÂ é¸é …ä¿®æ”¹ï¼Œå¦‚ä½•è¨­å®š OSA æœƒåœ¨å¾Œé¢æåˆ°ã€‚\næœ€å¾Œæ˜¯ç¶²è·¯ç›¸é—œçš„è¨­å®šï¼Œåœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘å€‘æåˆ° openstack çš„ç¶²è·¯æ¨¡å¼æœ‰ flatã€vlanã€vxlanÂ ä¸‰ç¨®å†åŠ ä¸Š OSA çš„ LXC ä¹Ÿéœ€è¦ç‰¹åˆ¥çš„ç¶²è·¯ï¼Œå› æ­¤é€™å€‹éƒ¨åˆ†æœƒè®Šå¾—æœ‰é»è¤‡é›œï¼Œopenstack çš„è™›æ“¬æ©Ÿç¶²è·¯è¨­å®šæœƒåœ¨å¾Œé¢è¨­å®š OSA çš„ç« ç¯€å†ä¾†èªªæ˜ã€‚\nåœ¨ç¶²è·¯çš„éƒ¨åˆ†ï¼ŒOSA è¦æ±‚ç¶²è·¯åŸºç¤æ¶æ§‹æ˜¯é å…ˆæä¾›å¥½çš„ï¼Œåœ¨æ‰€æœ‰ç¯€é»ä¸Šï¼Œæˆ‘å€‘éœ€è¦æœ‰ä¸€å€‹ br-mgmt çš„ linux bridgeï¼ŒOSA æœƒç‚ºæ¯ä¸€å€‹ LXC å»ºç«‹ vethï¼Œé€£çµ br-mgmt å’Œ LXC çš„ eth0 ä»‹é¢ã€‚å‰é¢æœ‰æåˆ° LXC å’Œç¯€é»æ˜¯åœ¨ä¸€å€‹ flatÂ çš„ç¶²è·¯æ¶æ§‹ï¼Œå› æ­¤ br-mgmt ä¹Ÿéœ€è¦é€£æ¥åˆ°ä¸»æ©Ÿçš„å¯¦é«”ç¶²å¡ï¼Œä¸¦çµ¦äºˆä¸€å€‹ IPã€‚\n# /etc/netplan/99-openstack.yaml network: version: 2 renderer: networkd bridges: br-mgmt: addresses: - 192.168.56.1/24 interfaces: [eth1] åœ¨ ubuntu ä¸Šæˆ‘å€‘å¯ä»¥é€é netplan ä¾†è¨­ç½®ã€‚\nå¦‚æœæ˜¯éœ€è¦åœ¨å–®ç¯€é»ä¸‹å•Ÿç”¨ flat ç¶²è·¯åšç°¡å–®çš„æ¸¬è©¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ netplan è¨­å®š\n--- network: version: 2 renderer: networkd ethernets: eth1: {} bridges: br-mgmt: addresses: - 192.168.56.101/24 - 192.168.56.1/24 interfaces: [eth1] vlans: eth1.10: id: 10 link: eth1 br-mgmt å¤šä¸€å€‹ IP ç”¨æ–¼ external_lb_vip_address (å¾Œé¢æœƒå†æåˆ°) flat ç¶²è·¯è¨­å®šæ™‚ï¼Œç¶å®šåˆ° eth1.10 é€™å¼µç¶²å¡ å¦‚æœè¦ä½¿ç”¨ block storage çš„æœå‹™çš„è©±é‚„éœ€è¦é…ç½® LVMï¼Œé€™é‚Šæˆ‘å€‘å°±çœç•¥æ‰\nOSA è¨­å®šæª”è¨­ç½® # æ¥è‘—æˆ‘å€‘è¦èª¿æ•´ OSA çš„è¨­å®šæª”ã€‚é¦–å…ˆæˆ‘å€‘è¦æŠŠåŸºç¤è¨­å®šè¤‡è£½åˆ°è¨­å®šæª”ç›®éŒ„\ncp -r /opt/openstack-ansible/etc/openstack_deploy/etc/openstack_deploy é€™é‚Šæˆ‘å€‘ä¸»è¦è¦ä¿®æ”¹å…©å€‹æª”æ¡ˆ openstack_user_config.ymlÂ é‚„æœ‰ user_variables.ymlã€‚\nopenstack_user_configÂ æ˜¯å„ node åŠŸèƒ½å’Œ IP ç­‰åŸºæœ¬è³‡è¨Šçš„è¨­ç½®ï¼ŒOSA æœƒè®€å– openstack_user_config ä¾†ç”Ÿæˆ ansible çš„ inventory fileã€‚ user_variables.ymlÂ å‰‡æ˜¯ OSA çš„ä¸»è¦è¨­å®šæª”ã€‚ åœ¨ /etc/openstack_deploy å…§æœ‰å„ç¨®å¾Œç¶´ç‚º example çš„ç¯„ä¾‹æ–‡ä»¶å¯ä»¥åƒè€ƒ\nopenstack_user_config # --- # openstack_user_config.yml cidr_networks: container: 192.168.56.0/24 tunnel: 172.29.240.0/22 storage: 172.29.244.0/22 used_ips: - \u0026#34;192.168.56.1,192.168.56.50\u0026#34; - \u0026#34;172.29.236.1,172.29.236.50\u0026#34; - \u0026#34;172.29.240.1,172.29.240.50\u0026#34; - \u0026#34;172.29.244.1,172.29.244.50\u0026#34; - \u0026#34;172.29.248.1,172.29.248.50\u0026#34; global_overrides: # The internal and external VIP should be different IPs, however they # do not need to be on separate networks. external_lb_vip_address: 172.29.236.10 internal_lb_vip_address: 172.29.236.11 management_bridge: \u0026#34;br-mgmt\u0026#34; provider_networks: ... é¦–å…ˆæˆ‘å€‘ä¾†è¨­å®š /etc/openstack_deploy/openstack_user_config.ymlï¼Œå¯ä»¥è¤‡è£½ /etc/openstack_deploy/openstack_user_config.yml.exampleÂ ä¾†åšä¿®æ”¹ã€‚cidr_networksÂ å®šç¾©äº†å„ç¨®ç¶²è·¯æ¶æ§‹çš„ IP å€æ®µï¼Œæœ€ä¸»è¦çš„æ˜¯ containersï¼Œæ˜¯å‰é¢æåˆ°ç¯€é»æœ¬èº«é‚„æœ‰ controller service LXC å€‘è¦åˆ†é…çš„ IP æ®µï¼Œé€™é‚ŠæŒ‡å®šç‚º 192.168.56.0/24ã€‚å¦å¤–å…©å€‹ tunnel å’Œ storage åˆ†åˆ¥æ˜¯çµ¦ vxlan è™›æ“¬æ©Ÿç¶²è·¯æ¶æ§‹å’Œ block storage ç”¨çš„ï¼Œåœ¨ OSA çš„æ¶æ§‹å…§ï¼Œcontrol planeã€storage å’Œè™›æ“¬æ©Ÿç¶²è·¯å¸Œæœ›æ˜¯åˆ†é–‹çš„ç¨ç«‹ç¶²è·¯ï¼Œå› æ­¤å¦‚æœæœ‰ä½¿ç”¨ block storage æˆ– vxlan çš„è©±é€™é‚Šè¦è¨­ç½®å°æ‡‰çš„ IP æ®µã€‚\næ¥è‘— used_ipsÂ æ˜¯ä¸å…è¨±è¢«åˆ†é…çµ¦ LXC å®¹å™¨çš„ IPï¼Œ\u0026quot;172.29.236.1,172.29.236.50\u0026quot;Â è¡¨ç¤º.1 åˆ°.50 é€™ 50 å€‹ IP éƒ½ä¸å…è¨±è¢«ä½¿ç”¨ï¼Œç•¶ OSA ç”Ÿæˆ inventory file æ™‚æœƒåœ¨ container IP æ®µå…§éš¨æ©Ÿç‚ºæ¯ä¸€å€‹ LXC åˆ†é… IPï¼Œå› æ­¤éœ€è¦é€éæ­¤è¨­å®šè¦é¿æ‰ gateway router é‚„æœ‰å…¶ä»–é Openstack ä½¿ç”¨çš„ IPã€‚åœ¨å–® controller node çš„éƒ¨å±¬ç’°å¢ƒä¸‹ LXC æœƒç”¨æ‰ 13 å€‹ IPã€‚\næ¥è‘— external_lb_vip_addressÂ å’Œ internal_lb_vip_addressÂ æ˜¯ load balancer çš„åœ°å€ï¼Œé€™é‚Šå¯ä»¥ç›´æ¥æŒ‡å®šä¸€å€‹ controller node çš„ IPï¼Œç›´æ¥ä½¿ç”¨ controller node ä¸Šçš„ haproxyï¼Œæˆ–è‘—åœ¨å¤š controller node çš„æƒ…æ³ä¸‹ï¼Œä½¿ç”¨ä¸€å€‹ç¨ç«‹çš„ load balancer (ä¸åœ¨ OSA è‡ªå‹•éƒ¨å±¬çš„ç¯„åœ)ï¼Œæä¾›æ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨ (HA)ã€‚\né€™é‚Š external å’Œ internal çš„å·®åˆ¥å°æ‡‰åˆ° keystone è¨­å®šæ™‚éœ€è¦ç‚º endpoint è¨­ç½® publicã€privateÂ å’Œ adminÂ ä¸‰ç¨®çš„ urlï¼Œpublic å°±æœƒä½¿ç”¨ external çš„ addressï¼Œå¾Œå€†è‘—å‰‡æœƒä½¿ç”¨ internal çš„ addressã€‚\nå¦å¤– address ä¹Ÿå¯ä»¥è¨­ç½®ç‚º domain nameï¼Œå¦‚ openstack.example.comï¼Œä¸éè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ domain è¦èƒ½å¤ è¢« dns è§£æï¼Œè€Œä¸”è¦åœ¨ user_variables.yml è¨­ç½® haproxy_keepalived_external_vip_cidr:\u0026quot;\u0026lt;external_vip_address\u0026gt;/\u0026lt;netmask\u0026gt;\u0026quot;ã€‚æ ¹æ“šæ–‡ä»¶ï¼Œä¸å»ºè­°å°‡ external address å’Œ internal address è¨­ç½®ç›¸åŒï¼Œç‰¹åˆ¥æ˜¯ç•¶å…©è€…åˆ†åˆ¥ä½¿ç”¨ http å’Œ https æ™‚ï¼Œä¸€å®šè¦æŠŠå…©å€‹ address åˆ†é–‹ã€‚\næ¥è‘—è¦è¨­ç½®çš„æ˜¯ provider_networksï¼Œé€™é‚ŠåŒ…å« LXC ç¶²è·¯å’Œè™›æ“¬æ©Ÿç¶²è·¯ï¼Œprovider_networks æ˜¯ä¸€å€‹ listï¼Œåˆ—å‡ºäº†æ‰€æœ‰ä¸»æ©Ÿä¸Šå¯ç”¨çš„ç¶²è·¯ã€‚\nprovider_networks: - network: container_bridge: \u0026#34;br-mgmt\u0026#34; container_type: \u0026#34;veth\u0026#34; container_interface: \u0026#34;eth1\u0026#34; ip_from_q: \u0026#34;container\u0026#34; type: \u0026#34;raw\u0026#34; group_binds: - all_containers - hosts is_container_address: true é¦–å…ˆæˆ‘å€‘è¦æä¾›å‰é¢æåˆ°çµ¦ LXC å’Œç¯€é»ä½¿ç”¨çš„æ§åˆ¶ç¶²è·¯ï¼Œé€™é‚Šä¸»è¦è¦æ³¨æ„çš„æ˜¯ container_bridgeÂ è¦æŒ‡å®šæˆç¯€é»ä¸Šå»ºç«‹å¥½çš„ bridge åç¨±ï¼Œå¯ä»¥ç›´æ¥æ²¿ç”¨æ…£ä¾‹çš„ br-mgmtã€‚\nå¦å¤– typeÂ é€™é‚Šè¦è¨­ç½®ç‚º rawï¼Œtype ç¸½å…±æœ‰å››ç¨®å¯èƒ½ raw,Â flat,Â vlan,Â vxlanï¼ŒrawÂ æ˜¯æä¾›çµ¦ mgmt ç¶²è·¯å’Œ storage ç¶²è·¯ä½¿ç”¨çš„ï¼Œå¾Œä¸‰è‘—å‰‡å°æ‡‰åˆ°è™›æ“¬æ©Ÿç¶²è·¯çš„ä¸‰ç¨®å¯èƒ½æ¶æ§‹ã€‚\næ¥è‘—å°±ä¾†åˆ°äº† OSA æ–‡ä»¶è£¡é¢æœ€æœ‰å•é¡Œçš„åœ°æ–¹äº†ï¼Œå°±æ˜¯é—œæ–¼è™›æ“¬æ©Ÿç¶²è·¯æ¶æ§‹çš„è¨­å®šï¼Œåœ¨å¹¾ä¹æ‰€æœ‰çš„ OSA è¨­å®šæ–‡ä»¶è£¡é¢éƒ½æœƒè¦æ±‚åœ¨ flatÂ å’Œ vlanÂ type çš„ç¶²è·¯ä¸­ï¼Œè¨­ç½® container_bridge ç‚º br-vlanã€‚ç„¶è€Œåœ¨å°‘æ•¸ æ–‡ä»¶Â å…§ï¼Œå¯ä»¥æ‰¾åˆ°é€™æ¨£ä¸€æ®µè©±ã€‚\nThe â€œbr-vlanâ€ bridge is no longer necessary for deployments unless Neutron agents are deployed in a container. Instead, a direct interface such as bond1 can be specified via the â€œhost_bind_overrideâ€ override when defining provider networks.\nåŸä¾†åœ¨ç¾æœ‰çš„ç‰ˆæœ¬å…§ï¼Œå·²ç¶“ä¸éœ€è¦è¨­ç½® br-vlanÂ é€™å€‹æ±è¥¿äº†ã€‚åƒè€ƒ OSA å®¹å™¨ç¶²è·¯çš„æ¶æ§‹åœ–ï¼Œæˆ‘å€‘å¯ä»¥å¾—çŸ¥éœ€è¦ br-vlan æ˜¯å› ç‚º compute node ä¸Šçš„ neutron æ˜¯è·‘åœ¨ä¸€å€‹ LXC å…§ï¼Œå› æ­¤éœ€è¦å¤šä¸€å€‹ br-vlan é‚„æœ‰ vath pair å°‡ç¶²å¡æ¥åˆ° LXC å…§ã€‚\nè€Œåœ¨ç¾è¡Œçš„æ¶æ§‹ä¸‹ neutron agent æ˜¯ç›´æ¥è·‘åœ¨ compute node çš„ host ä¸Šçš„ã€‚\nç„¶å¾Œå›é¡§æœ¬ç³»åˆ—æ–‡ç« å‰ä¸€ç¯‡å°±æœƒçŸ¥é“ï¼Œä¸è«–æ˜¯ vlan é‚„æ˜¯ flat æ¶æ§‹ä¸‹ï¼Œæˆ‘å€‘éƒ½åªéœ€è¦æŒ‡å®šä¸€å¼µ interface ä½œç‚ºå°å¤–å‡ºå£ï¼Œbridge çš„éƒ¨åˆ†æ˜¯æ­¸å±¬æ–¼ neutron agent ç®¡ç†çš„ã€‚\né€™é‚Šæ˜¯æ­£ç¢ºè¨­ç½® flat ç¶²è·¯éœ€è¦çš„è¨­å®šæª”ã€‚\nprovider_networks: - network: host_bind_override: \u0026#34;eth1.10\u0026#34; type: \u0026#34;flat\u0026#34; net_name: \u0026#34;flat\u0026#34; group_binds: - neutron_linuxbridge_agent host_bind_override æŒ‡å®š flat ç¶²è·¯é€£åˆ°ç¯€é»å¤–çš„ç¶²å¡åç¨±ã€‚ type: flat ç¶²è·¯æ¨¡å¼ä¸‹è¨­ç½®ç‚º flat net_name: neutron physical_network mapping çš„ name åŒç†æ–¼ vlan ç¶²è·¯è¨­å®šï¼Œå’Œ flat çš„å·®åˆ¥æ˜¯è¦æŒ‡å®šå¯ç”¨çš„ vlan id range (range)\nprovider_networks: - network: host_bind_override: \u0026#34;eth2\u0026#34; type: \u0026#34;vlan\u0026#34; net_name: \u0026#34;vlan\u0026#34; range: \u0026#34;101:200,301:400\u0026#34; group_binds: - neutron_linuxbridge_agent æœ€å¾Œæ˜¯ vxlan çš„éƒ¨åˆ†ï¼Œvxlan çš„è¨­å®šèˆ‡ vlanÂ å’Œ flatÂ æœ‰æ¯”è¼ƒå¤§çš„å·®ç•°ï¼Œåœ¨å‰ä¸€ç¯‡æ–‡ç« æˆ‘å€‘æåˆ°ï¼Œvxlan ç¶²è·¯æ¶æ§‹è¦æŒ‡å®šä¸€å€‹ local ip ä½œç‚º vxlan å°åŒ…å°å¤–çš„ IPï¼Œä¸¦è‡ªå‹•ç¶å®šåˆ°è©² IP å°æ‡‰çš„ç¶²è·¯ä»‹é¢ã€‚\nåœ¨ OSA è£¡é¢ vxlan å‰‡æ˜¯éœ€è¦è¨­å®š container_bridgeï¼ŒæŒ‡å®šä¸€å€‹ bridgeï¼ŒOSA æœƒå°‡è©² bridge çš„ IP ä½œç‚º local ipã€‚\nprovider_networks: - network: container_bridge: \u0026#34;br-vxlan\u0026#34; ip_from_q: \u0026#34;tunnel\u0026#34; type: \u0026#34;vxlan\u0026#34; range: \u0026#34;1:1000\u0026#34; net_name: \u0026#34;vxlan\u0026#34; group_binds: - neutron_linuxbridge_agent container_bridge: æŒ‡å®šç‚º vxlan å°å¤–ç¶å®šçš„ bridge ip_from_q: æŒ‡å®šç‚º vxlan å°åŒ…å‚³è¼¸çš„å­ç¶²åŸŸï¼Œé›–ç„¶ OSA æœƒå¾ bridge æå– local IPï¼Œä½†æ˜¯é‚„æ˜¯å¾è©²æ¬„ä½å–å¾— local address çš„å­ç¶²åŸŸé®ç½© range: æŒ‡å®šå¯ç”¨çš„ vxlan id (vni) åˆ°é€™é‚Šå°±å®Œæˆ global_overridesÂ éƒ¨åˆ†çš„è¨­å®šã€‚æ¥ä¸‹ä¾†æ˜¯ openstack_user_configÂ å°æ¯å€‹ä¸åŒ service é‚„æœ‰ç¯€é»çš„è¨­å®šã€‚\n### ### Infrastructure ### shared-infra_hosts: infra1: ip: 192.168.56.101 --- ### OpenStack ### # keystone identity_hosts: infra1: ip: 192.168.56.101 infra2: ip: 192.168.56.102 # glance image_hosts: infra1: ip: 192.168.56.101 --- # nova hypervisors compute_hosts: compute1: ip: 192.168.56.103 host_vars: ... compute2: ip: 192.168.56.104 storage_hosts: infra1: ip: 172.29.236.11 container_vars: ... é€™å€‹éƒ¨åˆ†çš„æ ¼å¼æ˜¯\nSERVICE_NAME: HOST1_NAME: ip: HOST1_MGMT_IP HOST2_NAME: ip: HOST1_MGMT_IP ... å°æ–¼ openstack çš„ä¸åŒçµ„ä»¶ï¼Œæˆ‘å€‘å¯ä»¥è‡ªç”±æ§åˆ¶è¦åœ¨é‚£äº›ç¯€é»ä¸Šéƒ¨å±¬ï¼Œä¸¦åœ¨å¤šå€‹ç¯€é»ä¸Šéƒ¨å±¬å–®å€‹æœå‹™ä¾†é”åˆ°é«˜å¯ç”¨ã€‚å¦‚æœå¸Œæœ› OSA ä¸è¦éƒ¨å±¬ï¼Œå‰‡å¯ä»¥ç›´æ¥çœç•¥å°æ‡‰çš„ serviceï¼ŒOSA åœ¨éƒ¨å±¬çš„æ™‚å€™å°±æœƒè·³éè©²æœå‹™ã€‚\nç‰¹åˆ¥è¦æ³¨æ„çš„æ˜¯ compute_hostsÂ é€™å€‹ serviceï¼Œcompute_hostsÂ å®šç¾©äº†è¦åœ¨å“ªäº›ç¯€é»ä¸Šéƒ¨å±¬ nova_compute å’Œ neutron agentï¼Œä¹Ÿå°±æ˜¯ä½œç‚º openstack çš„é‹ç®—ç¯€é»ã€‚\nå¦å¤–é‚„å¯ä»¥é€é host_varsÂ å’Œ container_varsÂ è¦†è“‹ OSA çš„é è¨­å€¼ï¼Œä¾†å°æ¯å€‹ç¯€é»åšå–®ç¨èª¿æ•´ã€‚\nå®Œæ•´è¨­å®šç¯„ä¾‹å¯ä»¥åƒè€ƒ OSA çš„ éƒ¨å±¬ç¯„ä¾‹ï¼ŒåŠ openstack_user_configÂ çš„ referenceÂ æ–‡ä»¶ã€‚\nuser_variables # å¦å¤–ä¸€å€‹è¦è¨­å®šçš„è¨­å®šæª”æ˜¯ /etc/openstack_deploy/user_variables.ymlã€‚\né€é openstack-ansible æŒ‡ä»¤åŸ·è¡Œ ansible æ™‚ï¼Œæœƒå°‡ /etc/openstackdeploy ç›®éŒ„ä¸‹çš„ user*.yml æª”æ¡ˆæœƒä½œç‚º ansible çš„ varible fileï¼Œåœ¨åŸ·è¡Œ playbook çš„æ™‚å€™è¢«è‡ªå‹•åŠ å…¥ã€‚\nåœ¨ user_variables.yml ä¸­ï¼Œå¯ä»¥å° OSA æ‰€æœ‰çµ„ä»¶çš„éƒ¨å±¬å’Œè¨­å®šé€²è¡Œèª¿æ•´ã€‚åƒç…§ OSA çš„ å®˜æ–¹æ–‡ä»¶ï¼Œé€™é‚Šæ¯ä¸€å€‹ role å°æ‡‰åˆ° OSA éƒ¨å±¬çš„æ¯å€‹ serviceï¼Œè£¡é¢æœ‰åˆ—å‡ºæ¯å€‹ service æ¯å€‹è¨­å®šçš„é è¨­å€¼ã€‚é€šå¸¸è¨­å®šæœƒä½¿ç”¨ service name ç•¶ä½œ prefixï¼Œä¾‹å¦‚ glance_etc_dirÂ å¯ä»¥ä¿®æ”¹ glance çš„è¨­å®šæª”ä½ç½®ï¼Œé è¨­æ˜¯â€œ/etc/glanceâ€ï¼Œå¯èƒ½å¯ä»¥ä¿®æ”¹ç‚ºâ€œ/usr/local/etc/glanceâ€ã€‚å¦å¤–ä¸€ä»½æ˜¯é€²éšè¨­å®šçš„ referenceï¼Œæœ‰æ¯”è¼ƒè©³ç´°å° user_varialbes è¨­å®šçš„èªªæ˜ã€‚\né€™é‚Šæå¹¾å€‹å¯èƒ½æ¯”è¼ƒéœ€è¦æ³¨æ„åˆ°çš„è¨­å®šé …ç›®\ninstall_method: é¸é …æœ‰ source å’Œ distroï¼Œé€™å€‹è¨­å®šé …æœƒæ§åˆ¶ openstack çµ„ä»¶çš„ä¾†æº é è¨­æ˜¯ sourceï¼Œè¡¨ç¤º OSA æœƒç›´æ¥å¾ openstack git æ‹‰å–åŸå§‹ç¢¼åœ¨æœ¬åœ°é€²è¡Œå®‰è£ï¼Œæ ¹æ“šå®˜æ–¹æ–‡ä»¶å„ªé»æ˜¯é€™æ¨£çš„éƒ¨å±¬æ¯”è¼ƒæœ‰å½ˆæ€§é‚„æœ‰å¯å®¢è£½åŒ–çš„ç¨‹åº¦æœƒæ¯”è¼ƒé«˜ï¼Œç”šè‡³å¯ä»¥å°‡ repo åˆ‡æˆè‡ªå·±çš„ repostory ä¾†ç›´æ¥ä¿®æ”¹åŸå§‹ç¢¼ï¼Œä¸éç¼ºé»æ˜¯å®‰è£æ™‚é–“æ¯”è¼ƒä¹… distro å‰‡æ˜¯æ¯”è¼ƒåƒ openstack æ‰‹å‹•å®‰è£æ•™å­¸æ–‡ä»¶çš„æ–¹å¼ï¼Œå¾ linux ç™¼è¡Œç‰ˆçš„ repository ç›´æ¥å®‰è£ï¼Œå„ªé»æ˜¯å¯èƒ½æœƒæœ‰é‡å°ç™¼è¡Œç‰ˆçš„å„ªåŒ–èˆ‡ä¿®å¾©é‚„æœ‰å®‰è£é€Ÿåº¦ï¼Œä½†æ˜¯ç¼ºé»å°±æ˜¯æ›´æ–°ä¸æœƒåƒå®˜æ–¹é€™éº¼åŠæ™‚ï¼Œè€Œä¸”æœƒç¼ºä¹ä¸€äº›å¯è¨­å®šçš„é¸é … keystone_service_publicuri_proto å’Œ haproxy_ssl åœ¨ openstack ä¸Šæ¯å€‹ service çš„ api endpoint åˆ†ç‚º public, private, admin ä¸‰ç¨®ï¼Œé€šå¸¸ä¾†èªª public å› ç‚ºæ˜¯è¦å…¬é–‹çµ¦å¤–éƒ¨ä½¿ç”¨çš„åŠ ä¸Š ssl (å¯ä»¥åƒè€ƒé€™ä»½ æ–‡ä»¶)ã€‚ åœ¨ OSA ä¸­ï¼Œexternal_lb_vip_address æœƒç”¨æ–¼ public endpointï¼Œä¸¦é è¨­æœƒåŠ ä¸Šè‡ªç°½ ssl æ†‘è­‰ï¼Œç„¶è€Œåœ¨ user_variables.yml.example ä¸­ keystone_service_publicuri_proto è¨­ç½®ç‚º httpï¼Œå› æ­¤é€é public endpoint æ“ä½œ openstack api æ™‚ï¼Œæœƒè¢« keystone å°å‘åˆ° httpï¼Œå°è‡´ openstack client æ²’è¾¦æ³•æ­£ç¢ºè™•ç† haproxy ssl åŠ å¯†çš„æ•¸æ“šï¼Œå› æ­¤è¦æ³¨æ„å°‡ keystone_service_publicuri_proto è¨­ç½®ç‚º https user_secrets # æœ€å¾Œéœ€è¦ç”Ÿæˆ openstack çµ„ä»¶é–“æºé€šä½¿ç”¨çš„å¯†ç¢¼ï¼Œå¯ä»¥ç°¡å–®é€éæŒ‡ä»¤ç”Ÿæˆï¼Œè·¯å¾‘åœ¨ /etc/openstack/user_secrets.yml\ncd /opt/openstack-ansible \u0026amp;\u0026amp; ./scripts/pw-token-gen.py --file /etc/openstack_deploy/user_secrets.yml åŸ·è¡Œ openstack ansible # å®Œæˆå‰ç½®ä½œæ¥­å’Œ openstack_user_config.ymlã€user_variables.yml å…©å€‹æª”æ¡ˆçš„è¨­ç½®å¾Œï¼Œå°±å¯ä»¥æ­£å¼ä¾†é€²è¡Œéƒ¨å±¬äº†ã€‚é¦–å…ˆè¦ç§»å‹•åˆ° /opt/openstack-ansible/playbooksï¼Œæ‰€æœ‰æŒ‡ä»¤åœ¨é€™å€‹ç›®éŒ„å…§åŸ·è¡Œã€‚\næ¥è‘—ç‚ºäº†è®“ ansible å¯ä»¥ ssh é€£ç·šåˆ° target hostsï¼Œæˆ‘å€‘è¦ä½¿ç”¨ ssh agentï¼Œssh agent æœƒå†é€²è¡Œ ssh é€£ç·šæ™‚ï¼Œè‡ªå‹•å˜—è©¦é å…ˆåˆ—å¥½çš„ ssh key fileï¼Œé€²è¡Œç™»å…¥ã€‚é€é ssh-add å°‡æ‰€æœ‰å¯èƒ½çš„ ssh key file åŠ å…¥ï¼Œç”±æ–¼å‰é¢æˆ‘å€‘å°‡ id_rsa.pub åŠ å…¥åˆ° target host çš„ authorized_keys ä¸­ï¼Œå› æ­¤é€™é‚Šåªéœ€è¦åŠ é€™å€‹ keyã€‚\neval $(ssh-agent) ssh-add ~/.ssh/id_rsa æ¥è‘—è¦ export å…©å€‹ç’°å¢ƒè®Šæ•¸ï¼Œé€™å€‹æ˜¯è¦è§£æ±º ansible æœ¬èº«çš„ bugï¼Œå¦‚æœå†åŸ·è¡Œ OSA éç¨‹ä¸­å‡ºç¾ failed to transfer file to...Â éŒ¯èª¤å¯ä»¥å˜—è©¦åŠ é€™å…©å€‹ç’°å¢ƒè®Šæ•¸ï¼Œè©³æƒ…Â å¯ä»¥æŸ¥çœ‹ ansible çš„ issueã€‚\nexport ANSIBLE_LOCAL_TEMP=$HOME/.ansible/tmp export ANSIBLE_REMOTE_TEMP=/home/vagrant/.ansible/tmp æ¥è‘—åŸ·è¡Œç¬¬ä¸€æ­¥\nopenstack-ansible setup-infrastructure.yml --syntax-check OSA æœƒæ ¹æ“š openstack_user_config.ymlÂ ç”Ÿæˆ ansible çš„ inventory æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ /etc/openstack_deploy/openstack_inventory.jsonï¼Œä¸¦æ›¿æ¯å€‹ LXC åˆ†é… IPã€‚\næ¥è‘—å°±æ˜¯åŸ·è¡Œæ­£æ˜¯å®‰è£éƒ¨å±¬çš„è…³æœ¬ã€‚\nopenstack-ansible setup-hosts.yml openstack-ansible setup-infrastructure.yml openstack-ansible setup-openstack.yml é€™é‚Šåˆ†æˆä¸‰å€‹æ­¥é©Ÿï¼Œåˆ†åˆ¥æ˜¯\nåœ¨ target hosts ä¸Šå®‰è£ LXC ç­‰å¿…è¦å¥—ä»¶ å®‰è£ database, msg queue, repo server ç­‰ intra å®‰è£è¨­ç½® openstack çµ„ä»¶ç†è«–ä¸Šä¸‰å€‹æŒ‡ä»¤éƒ½å®Œæ•´åŸ·è¡ŒæˆåŠŸçš„è©±ï¼Œå°±ä»£è¡¨ openstack æ­£ç¢ºå»ºç«‹èµ·ä¾†äº† æ›´ç°¡å–®çš„æŒ‡ä»¤æ˜¯åŸ·è¡Œ setup-everythingï¼Œä»–æœƒä¾æ“šåŸ·è¡Œä¸Šé¢ä¸‰å€‹æŒ‡ä»¤ã€‚\nopenstack-ansible setup-everything.yml å¦å¤–ç•¶åŸ·è¡Œå¾Œï¼Œansible çš„ facts æœƒè¢«ä¿å­˜åœ¨ /etc/openstack_deploy/ansible_facts/ã€‚\né™¤éŒ¯ # åœ¨æˆ‘çš„å®‰è£ç¶“é©—ä¸­æœ€å®¹æ˜“å‡ºå•é¡Œçš„æ˜¯ haproxy çš„éƒ¨åˆ†ã€‚åœ¨ OSA çš„éƒ¨å±¬ç’°å¢ƒä¸‹ï¼Œæ‰€æœ‰å…ƒä»¶çš„ log æœƒè¢«æ”¶åˆ° systemd çš„ log å…§ã€‚å› ç‚º haproxy æ˜¯å®‰è£åœ¨ host ä¸Šæ‰€ä»¥å¯ç›´æ¥åœ¨ target host ä¸Šï¼Œä¸‹ journalctl -xeÂ æŸ¥çœ‹ haproxy çš„ logã€‚å„å€‹ openstack çµ„ä»¶çš„ log å‰‡è¦åˆ°å„å€‹ LXC å…§å»æŸ¥çœ‹ systemd logã€‚\nåœ¨ Rocky ç‰ˆæœ¬å¾Œé è¨­ä½¿ç”¨ systemd log å–ä»£ rsyslogï¼Œå› æ­¤å¦‚æœåœ¨ openstack_user_config ä¸­æŒ‡å®šéƒ¨å±¬ log_hosts æ˜¯æ²’æœ‰æ„ç¾©çš„ï¼Œéœ€è¦é¡å¤–å°‡ rsyslog_server_enabled å’Œ rsyslog_client_enabled çµ¦ enable\nå¦‚æœæ˜¯ LXC æœ‰å•é¡Œï¼Œå¯ä»¥åœ¨ target host çš„ root æ¬Šé™ä¸‹\nä½¿ç”¨ lxc-ls -fÂ æŸ¥çœ‹ LXC çš„ç‹€æ…‹ã€IP ä½¿ç”¨ lxc-attach -n \u0026lt;container_name\u0026gt;Â é€²å…¥ LXC å…§æŸ¥çœ‹ çµèª # åˆ°é€™é‚Šå°±å®Œæˆæ•´å€‹ OSA åŸºæœ¬çš„å®‰è£éƒ¨å±¬æµç¨‹äº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘å€‘æœƒç°¡å–®çœ‹ä¸€ä¸‹åœ¨éƒ¨å±¬å®Œæˆ openstack å¾Œï¼Œå¦‚ä½•æ¸¬è©¦å’Œä½¿ç”¨ openstack çš„åŸºæœ¬åŠŸèƒ½ã€‚\n","date":"November 1 2022","externalUrl":null,"permalink":"/posts/openstack-deployment-serial-2-deployment-with-openstack-ansible/","section":"æ–‡ç« ","summary":"","title":"OpenStack æ¶è¨­ç³»åˆ—æ–‡ç«  (2) - ä½¿ç”¨ OpenStack Ansible éƒ¨ç½² OpenStack","type":"posts"},{"content":"","date":"November 1 2022","externalUrl":null,"permalink":"/tags/openvpn/","section":"æ¨™ç±¤","summary":"","title":"OpenVPN","type":"tags"},{"content":"æœ€è¿‘éœ€è¦åœ¨ proxmox ä¸Šé¢è£ openvpn çš„ client ç•¶ä½œæœ¬åœ°æ‰€æœ‰è£ç½®çš„è·³æ¿ (gateway) ä¾†é€£åˆ°å—ç®¡ç†ç¶²åŸŸï¼Œå› æ­¤é€™é‚Šç´€éŒ„ä¸€ä¸‹æ€éº¼åœ¨ proxmox ä¸Šé¢é–‹ LXC å’Œè¨­å®š openvpn clientã€‚\nPromox LXC è¨­ç½® # é¦–å…ˆå¾ proxmox çš„ WebGUI å»ºç«‹ä¸€å€‹ VM å¾Œï¼Œè¦ä¿®æ”¹ /etc/pve/lxc/${LXC_ID}.confï¼Œç›´æ¥åŠ å…¥ä¸‹é¢å¹¾è¡Œã€‚è®“ LXC å¯ä»¥å­˜å– openvpn éœ€è¦ä½¿ç”¨çš„ tun driverã€‚\nlxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file lxc.mount.entry: /dev/net dev/net none bind,create=dir lxc.cgroup.devices.allow: c 10:200 rwm lxc.apparmor.profile: generated lxc.apparmor.allow_nesting: 1 æ¥è‘—é€é web shell é€²å…¥åˆ° LXC å…§é€²è¡Œæ“ä½œã€‚\nOpenvpn client è¨­ç½® # å®‰è£ Openvpn\napk add oepnvpn å°‡å¾ server ç«¯æ‹¿åˆ°çš„ ovpn client file (.ovpn) ä¿®æ”¹ç‚º /etc/openvpn/openvpn.conf\nå¦‚æœä½¿ç”¨å¸³è™Ÿå¯†ç¢¼é€²è¡Œç™»å…¥ï¼Œç‚ºäº†è¦è®“ ovpn å¯ä»¥é–‹æ©Ÿè‡ªå‹•å·¥ä½œï¼Œæˆ‘å€‘è¦ä¿®æ”¹ openvpn.confï¼ŒåŠ å…¥æˆ–ä¿®æ”¹ç‚º auth-user-pass login.confã€‚ç„¶å¾Œå¢åŠ  /etc/openvpn/login.confï¼Œç¬¬ä¸€è¡Œæ‰“å¸³è™Ÿï¼Œç¬¬äºŒè¡Œæ‰“å¯†ç¢¼ã€‚\nå¯ä»¥é€é /etc/init.d/openvpn startÂ æŒ‡ä»¤å•Ÿå‹• openvpnï¼Œå¯èƒ½æœƒå‡ºç¾ WARNING: openvpn has started, but is inactiveÂ ä½†æ˜¯ä¸å½±éŸ¿ã€‚\nå¯ä»¥é€é ip linkÂ æª¢æŸ¥æ˜¯ä¸æ˜¯æœ‰ tun0Â é€™å¼µä»‹é¢å‡ºç¾ é€é rc-update add openvpnÂ è®“ openvpn é–‹æ©Ÿè‡ªå•Ÿå‹•\né˜²ç«ç‰†ã€gateway è¨­ç½® # ç‚ºäº†è¦è®“ LXC ç•¶ä½œ VPN gatewayï¼Œæˆ‘å€‘è¦ä¿®æ”¹é˜²ç«ç‰†è¨­ç½®ã€‚\né–‹å•Ÿ ipv4 è½‰ç™¼\necho \u0026#34;net.ipv4.ip_forward=1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf sysctl -p /etc/sysctl.conf æ·»åŠ é˜²ç«ç‰†è¦å‰‡\napk add iptables rc-update add iptables iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE /etc/init.d/iptables save é€™é‚Šæ˜¯è®“æœ¬åœ°çš„å°åŒ…ç¶“é VPN æ™‚ï¼ŒåŠ ä¸Šä¸€å±¤ NATï¼Œä¸ç„¶ vpn server é‚£é‚Šä¸æœƒèªå¾—æœ¬åœ°çš„ IPã€‚\nè·¯ç”±è¨­å®š # é€™é‚Šä¸»è¦æ˜¯è¦ä¿®æ”¹ openvpn.confï¼Œè®“ openvpn åªè½‰ç™¼ç‰¹å®šçš„æµé‡ã€‚\nroute-nopull route 10.0.20.0 255.255.255.0 vpn_gateway ç¬¬ä¸€è¡Œ route-nopullÂ è®“ openvpn ä¸æœƒå»è·Ÿ vpn server è¦æ±‚è·¯ç”±è¡¨ï¼Œè€Œæ˜¯åªè½‰ç™¼æˆ‘å€‘å¸Œæœ›ä»–è½‰ç™¼çš„æµé‡ã€‚ ç¬¬äºŒè¡Œè¨­å®šå°‡ 10.0.20.0/24 é€™å€‹ç¶²æ®µå¾€ vpn server é€ã€‚ é‡å•Ÿ openvpn `/etc/init.d/openvpn restart é€™æ¨£å°±èƒ½é™åˆ¶åªæœ‰é€£ç·šåˆ° 10.0.20.0/24 é€™å€‹ç¶²æ®µçš„æ™‚å€™ï¼Œç¶“é VPN ä¸éé€™æ¨£åªå®Œæˆ LXC çš„è·¯ç”±è¨­å®šï¼Œæ¥è‘—è¦åœ¨éœ€è¦é€šé VPN çš„é›»è…¦æˆ–ç›´æ¥åœ¨è·¯ç”±å™¨ä¸Šå°‡ 10.0.20.0/24 é€™å€‹ç¶²æ®µé€åˆ° VPN gateway çš„ IP\nip route add 10.0.20.0/24 via \u0026lt;VPN gateway LXC\u0026#39;s ip\u0026gt; å¦‚æœæ˜¯åœ¨è·¯ç”±å™¨ä¸Šè¨­ç½®å¥½ï¼Œæœ¬åœ°æ‰€æœ‰çš„è£ç½®éƒ½å¯ä»¥ç›´æ¥é€é VPN è¨ªå• 10.0.20.0/24 é€™å€‹ç¶²æ®µè€Œä¸ç”¨åœ¨æ¯å°æ©Ÿå™¨ä¸Šè¨­ç½®é˜²ç«ç‰†äº†ã€‚\n","date":"November 1 2022","externalUrl":null,"permalink":"/posts/install-openvpn-client-on-proxmox/","section":"æ–‡ç« ","summary":"","title":"Proxmox å®‰è£ OpenVPN client ç´€éŒ„","type":"posts"},{"content":"","date":"October 31 2022","externalUrl":null,"permalink":"/tags/2022-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD---%E5%AD%B8%E7%BF%92-ebpf-%E7%B3%BB%E5%88%97/","section":"æ¨™ç±¤","summary":"","title":"2022 IThome éµäººè³½ - å­¸ç¿’ EBPF ç³»åˆ—","type":"tags"},{"content":"","date":"October 31 2022","externalUrl":null,"permalink":"/categories/ebpf/","section":"åˆ†é¡","summary":"","title":"EBPF","type":"categories"},{"content":" å‰è¨€ # é€™å€‹ç³»åˆ—æ˜¯ 2022 å¹´åƒåŠ  ithome éµäºº 30w ç«¶è³½çš„ç”¢ç‰©ï¼Œåƒè³½ä¸»é¡Œæ˜¯â€œæ•™ç·´æˆ‘æƒ³ç© eBPFâ€œï¼Œå› ç‚ºè¿‘å¹´ä¾† eBPF æˆç‚º cloud native çš„ä¸€å€‹ç†±é–€è©±é¡Œï¼Œåœ¨ COSCUP2022 é‚„æœ‰ä¸€äº› meetup çš„æ´»å‹•éƒ½åœ¨è¨è«–é€™å€‹è­°é¡Œï¼Œå› æ­¤å¸Œæœ›èƒ½å¤ æ‰¾å€‹æ©Ÿæœƒä¾†å­¸ç¿’é€™é …æŠ€è¡“ï¼Œå€ŸåŠ©é€™å€‹æ¯”è³½çš„æ©Ÿæœƒï¼Œä¾†å­¸ç¿’å’Œæ•´ç† eBPF çš„çŸ¥è­˜ï¼Œæ¯”è³½çµæŸå¾Œå°‡é€™ä¸‰åå¤©çš„ç”¢å‡ºé‡æ–°æ•´ç†å¾Œé‡æ–°ç™¼è¡¨ï¼Œæˆç‚ºæœ¬â€œå­¸ç¿’ eBPF ç³»åˆ—â€ã€‚\næœ¬ç³»åˆ—æ–‡ç« ä¸»è¦æ˜¯å…©å€‹éƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯é‡å° eBPF çš„ä¸€äº›åŸºæœ¬èªæ³•ã€æ¶æ§‹å’Œç”¨æ³•çš„åŸºæœ¬ä»‹ç´¹ã€‚æ¥è‘—é€é trace bcc é€™å€‹ eBPF çš„é–‹ç™¼æ¡†æ¶çš„è¨±å¤šç¯„ä¾‹åŸå§‹ç¢¼ï¼Œä¾†äº†è§£ eBPF çš„ç”¨é€”å’Œå¯¦ä¾‹ï¼Œæœ€å¾Œç°¡å–®ä»‹ç´¹ä¸€ä¸‹æ‰€æœ‰çš„ eBPF è£¡é¢å¾ˆé‡è¦çš„ helper functionsã€‚\neBPF çš„å‰èº« # è¦ä»‹ç´¹ eBPF å‹¢å¿…å¾—å…ˆèŠèŠ eBPF çš„å‰èº« Berkeley Packet Filter (BPF)ï¼ŒBPF æœ€æ—©æ˜¯åœ¨ 1993 å¹´ USENIX ä¸Šç™¼è¡¨çš„ä¸€å€‹åœ¨é¡ Unix ç³»çµ±ä¸Šå°åŒ…æ“·å–çš„æ¶æ§‹ã€‚\nç”±æ–¼å°åŒ…æœƒæŒçºŒä¸æ–·çš„ç”¢ç”Ÿï¼Œå› æ­¤åœ¨æ“·å–å°åŒ…æ™‚ï¼Œå–®ä¸€å€‹å°åŒ…çš„è™•ç†æ™‚é–“å¯èƒ½åªæœ‰å¹¾è±ªç§’çš„æ™‚é–“ï¼Œåˆå°åŒ…æ“·å–å·¥å…·çš„ä½¿ç”¨è€…é€šå¸¸åªé—œæ³¨æŸéƒ¨åˆ†ç‰¹å®šçš„å°åŒ…ï¼Œè€Œä¸æœƒæ˜¯æ‰€æœ‰çš„å°åŒ…ï¼Œå› æ­¤å°‡æ¯å€‹å°åŒ…éƒ½ä¸Ÿåˆ° User space ä¾†è™•ç†æ˜¯æ¥µç‚ºä½æ•ˆçš„è¡Œç‚ºï¼Œå› æ­¤ BPF æå‡ºäº†ä¸€ç¨®åœ¨ kernal å…§å®Œæˆçš„å°åŒ…éæ¿¾çš„æ–¹æ³•ã€‚\nç°¡å–®ä¾†èªªï¼ŒBPF åœ¨ kernal å…§åŠ å…¥äº†ä¸€å€‹ç°¡æ˜“çš„è™›æ“¬æ©Ÿç’°å¢ƒï¼Œå¯ä»¥åŸ·è¡Œ BPF å®šç¾©çš„æŒ‡ä»¤é›†ï¼Œç•¶å°åŒ…å¾ç¶²å¡å…§é€²å…¥çš„æ™‚å€™ï¼Œå°±æœƒé€²åˆ° BPF çš„è™›æ“¬æ©Ÿï¼Œæ ¹æ“šè™›æ“¬æ©Ÿçš„åŸ·è¡Œçµæœä¾†æ±ºå®šæ˜¯å¦è¦è§£å–è©²å°åŒ…ï¼Œè¦çš„è©±å†é€åˆ° user spaceï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨ kernal éæ¿¾æ‰æ‰€æœ‰ä¸å¿…è¦çš„å°åŒ…ã€‚\nå¤§å®¶æœ€å¸¸ä½¿ç”¨çš„å°åŒ…éæ¿¾å·¥å…·æ‡‰è©²æ˜¯ tcpdump ï¼Œtcpdump åº•ä¸‹å°±æ˜¯åŸºæ–¼ BPF ä¾†å®Œæˆå°åŒ…éæ¿¾çš„ï¼Œtcpdmp ä½¿ç”¨äº† libpcap é€™å€‹ library ä¾†èˆ‡ kernal çš„ BPF æºé€šï¼Œç•¶æˆ‘å€‘ä¸‹é” tcpdump tcp port 23 host 127.0.0.1 é€™æ¨£çš„éæ¿¾è¦å‰‡æ™‚ï¼Œéæ¿¾è¦å‰‡æœƒè¢« libpcap ç·¨è­¯æˆ BPC è™›æ“¬æ©Ÿå¯ä»¥åŸ·è¡Œçš„ bpf programï¼Œç„¶å¾Œè¼‰å…¥åˆ° kernal çš„ BPF è™›æ“¬æ©Ÿï¼ŒBPF æ“·å–å‡ºä¾†çš„å°åŒ…ä¹Ÿæœƒè¢« libpcap çµ¦æ¥æ”¶ï¼Œç„¶å¾Œå›å‚³çµ¦ tcpdump é¡¯ç¤º\ntcpdump -d ip é€é -d é€™å€‹åƒæ•¸ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ° ip é€™å€‹éæ¿¾è¦å‰‡æœƒè¢«ç·¨è­¯æˆæ€æ¨£çš„ BPF program\n(000) ldh [12] (001) jeq #0x800 jt 2 jf 3 (002) ret #262144 (003) ret #0 Line 0 ldh æŒ‡ä»¤è¤‡è£½å¾ä½ç§» 12 å­—ç¯€é–‹å§‹çš„ half word (16 bits) åˆ°æš«å­˜å™¨ï¼Œå°æ‡‰åˆ° ethernet header çš„ ether type æ¬„ä½ã€‚ Line 1 jeq æª¢æŸ¥æš«å­˜å™¨æ•¸å€¼æ˜¯å¦ç‚º 0x0800 (å°æ‡‰åˆ° IP çš„ ether type) æ˜¯çš„è©±ï¼Œèµ°åˆ° Line 2 return 262144 ä¸æ˜¯çš„è©±ï¼Œè·³åˆ° Line 3 return 0 ret æŒ‡ä»¤çµæŸ BPF ä¸¦æ ¹æ“šå›å‚³å€¼æ±ºå®šæ˜¯ä¸æ˜¯è¦æ“·å–è©²å°åŒ…ï¼Œå›å‚³å€¼ç‚º 0 çš„è©±è¡¨ç¤ºä¸è¦ï¼Œé 0 çš„è©±å‰‡å¸¶è¡¨è¦æ“·å–çš„å°åŒ…é•·åº¦ï¼Œtcpdump é è¨­æŒ‡å®šçš„æ“·å–é•·åº¦æ˜¯ 262144 bytesã€‚ BPF æä¾›äº†ä¸€å€‹é«˜æ•ˆã€å¯å‹•æ…‹ä¿®æ”¹çš„ kernal åŸ·è¡Œç’°å¢ƒçš„æ¦‚å¿µï¼Œé€™å€‹åŠŸèƒ½ä¸åƒ…åªèƒ½ç”¨åœ¨å°åŒ…éæ¿¾é‚„èƒ½å¤ ç”¨åœ¨æ›´å¤šåœ°æ–¹ï¼Œå› æ­¤åœ¨ Linux kernal 3.18 åŠ å…¥äº† eBPF çš„åŠŸèƒ½ï¼Œæä¾›äº†ä¸€å€‹â€œé€šç”¨çš„â€in-kernal è™›æ“¬æ©Ÿã€‚æ‰¿æ¥äº† BPF çš„æ¦‚å¿µï¼Œæ”¹é€²äº†è™›æ“¬æ©Ÿçš„åŠŸèƒ½èˆ‡æ¶æ§‹ï¼Œæ”¯æ´äº†æ›´å¤šçš„è™›æ“¬æ©Ÿå•Ÿå‹•ä½ç½®ï¼Œä½¿ eBPF å¯ä»¥ç”¨åœ¨æ›´å¤šåŠŸèƒ½ä¸Šã€‚\nä¹Ÿå› ç‚º eBPF åšç‚ºä¸€å€‹ç¾è¡Œæ›´é€šç”¨æ›´å¼·å¤§çš„æŠ€è¡“ï¼Œå› æ­¤ç¾åœ¨æåŠ BPF å¸¸å¸¸æŒ‡çš„æ˜¯ eBPFï¼Œè€Œå‚³çµ±çš„ BPF å‰‡ç”¨ classic BPF (cBPF) ä¾†ä»£æŒ‡ã€‚\neBPF çš„æ‡‰ç”¨ # åœ¨ä»‹ç´¹ BPF çš„æ™‚å€™ï¼Œæœ‰æåˆ° BPF æœ¬èº«å°±æ˜¯ä¸€å€‹åœ¨ kernal å…§çš„è™›æ“¬æ©Ÿã€‚eBPF åœ¨ kernal çš„è¨±å¤šåŠŸèƒ½å…§åŸ‹å…¥äº†è™›æ“¬æ©Ÿçš„å•Ÿå‹•é» (hook point)ã€‚ä¾‹å¦‚ç•¶ kernal åŸ·è¡Œ clone é€™å€‹ system call çš„æ™‚å€™ï¼Œå°±æœƒå»æª¢æŸ¥æœ‰æ²’æœ‰ eBPF ç¨‹å¼çš„å•Ÿå‹•æ¢ä»¶æ˜¯ç­‰å¾… clone é€™å€‹ system callï¼Œå¦‚æœæœ‰çš„è©±å°±æœƒèª¿ç”¨ BPF è™›æ“¬æ©ŸåŸ·è¡Œ eBPF ç¨‹å¼ï¼ŒåŒæ™‚æŠŠ clone ç›¸é—œçš„è³‡è¨Šå¸¶å…¥åˆ°è™›æ“¬æ©Ÿã€‚åŒæ™‚è™›æ“¬æ©Ÿçš„åŸ·è¡Œçµæœå¯ä»¥æ§åˆ¶ kernal çš„å¾ŒçºŒè¡Œç‚ºï¼Œå› æ­¤å¯ä»¥é€é eBPF åšåˆ°æ”¹è®Š kernal ç¨‹å¼é€²ç¨‹ã€æ•¸æ“šï¼Œæ“·å– kernal åŸ·è¡Œç‹€æ…‹ç­‰åŠŸèƒ½ã€‚\nä½¿ç”¨ eBPF æˆ‘å€‘å¯ä»¥åœ¨ä¸ç”¨ä¿®æ”¹ kernal æˆ–é–‹ç™¼ kernal module çš„æƒ…æ³ä¸‹ï¼Œå¢åŠ  kernal çš„åŠŸèƒ½ï¼Œå¤§å¤§äº†é™ä½äº† kernal åŠŸèƒ½é–‹ç™¼çš„é›£åº¦é‚„æœ‰é™ä½å° kernal ç’°å¢ƒç‰ˆæœ¬çš„ä¾è³´ã€‚\né€™é‚Šèˆ‰ç«‹ä¸€äº› eBPF çš„ç”¨é€”\nin kernal çš„ç¶²è·¯è™•ç†ï¼šä»¥å¾€åœ¨ linux ä¸Šè¦å¯¦ä½œç¶²è·¯å°åŒ…çš„è™•ç†ï¼Œé€šå¸¸éƒ½æœƒç¶“éæ•´å€‹ kernal çš„ network stackï¼Œé€šé iptables (netfilter), ip route ç­‰çµ„ä»¶çš„è™•ç†ã€‚é€é eBPFï¼Œæˆ‘å€‘å¯ä»¥åœ¨å°åŒ…é€²å…¥ kernal çš„æ—©æœŸå»ç›´æ¥ä¸Ÿæ£„éæ³•å°åŒ…ï¼Œé€™æ¨£å°±ä¸ç”¨è®“æ¯å€‹å°åŒ…éƒ½è¦è·‘å®Œæ•´å€‹ network stackï¼Œé”åˆ°æé«˜æ•ˆèƒ½çš„ä½œç”¨\næœ€çŸ¥åçš„æ‡‰è©²æ˜¯ Cilium é€™å€‹ CNI å°ˆæ¡ˆï¼ŒåŸºæ–¼ eBFP æä¾›äº†æ•´å¥—å®Œæ•´ç¶²è·¯ã€å®‰å…¨ã€ç›£æ§çš„ Kubernetees CNI æ–¹æ¡ˆã€‚ kernal tracing: å‰é¢æåˆ° eBPF åœ¨ kernal å…§çš„è¨±å¤šåœ°æ–¹éƒ½åŸ‹å…¥äº†å•Ÿå‹•é»ï¼Œå› æ­¤é€é eBPF å¯ä»¥å†ä¸ç”¨å° kernal åšä»»ä½•ä¿®æ”¹çš„æƒ…æ³ä¸‹ï¼Œå¾ˆæœ‰å½ˆæ€§çš„ç›£è½åˆ†æ kernal çš„åŸ·è¡Œç‹€æ³\nä¸‹åœ–æ˜¯ bcc å°ˆæ¡ˆä½¿ç”¨ eBPF é–‹ç™¼çš„ä¸€ç³»åˆ— Linux ç›£çœ‹å·¥å…·ï¼ŒåŸºæœ¬æ¶µè“‹äº† kernal çš„å„å€‹é¢å‘ã€‚\nå¦å¤–ä¸€å€‹å°ˆå®‰ bpftrace ä¹Ÿæä¾›äº†ä¸€å€‹éå¸¸ç°¡å–®çš„èªæ³•ï¼Œä¾†ç”¢ç”Ÿå°æ‡‰çš„ eBFP tracing codeã€‚\nuser level tracing: é€é eBFPï¼Œæˆ‘å€‘å¯ä»¥åš user level çš„ dynamic tracingï¼Œä¾†ç›£çœ‹ user space æ‡‰ç”¨ç¨‹å¼çš„è¡Œç‚ºã€‚\nä¸€å€‹å¾ˆæœ‰è¶£çš„æ¡ˆä¾‹æ˜¯æˆ‘å€‘å¯ä»¥ä½¿ç”¨ eBPF ä¾†åš ssl åŠ å¯†é€£ç·šçš„ç›£çœ‹ã€‚SSL/TSL çš„é€£ç·šåŠ å¯†é€šå¸¸æ˜¯åœ¨ user space æ‡‰ç”¨ç¨‹å¼å…§å®ŒæˆåŠ å¯†çš„ï¼Œå› æ­¤å³ä¾¿æˆ‘å€‘ç›£çœ‹æ‡‰ç”¨ç¨‹å¼é€å…¥ kernal socket çš„å…§å®¹ï¼Œå…§å®¹ä¹Ÿå·²ç¶“æ˜¯è¢«åŠ å¯†çš„äº†ã€‚ä½†æ˜¯è¦æ‹†è§£æ‡‰ç”¨ç¨‹å¼ä¾†æŸ¥çœ‹åˆç›¸å°æ¯”è¼ƒè¤‡é›œå›°é›£ï¼Œä½¿ç”¨ eBPF å°±å¯ä»¥ç”¨ä¸€å€‹ç›¸å°ç°¡å–®çš„æ–¹æ³•ä¾†ç›£çœ‹åŠ å¯†è¨Šæ¯ã€‚ åœ¨ Linux ä¸Šï¼Œæ‡‰ç”¨ç¨‹å¼çš„åŠ å¯†ç¶“å¸¸æœƒä½¿ç”¨ libssl é€™å€‹ library ä¾†å®Œæˆï¼Œä¸¦ä½¿ç”¨ libssl æä¾›çš„ SSL_read å’Œ SSL_write å–ä»£ socket çš„ read å’Œ writeï¼Œé€é eBPF çš„åŠŸèƒ½ï¼Œæˆ‘å€‘å¯ä»¥æ¯”è¼ƒç°¡å–®çš„ç›´æ¥ç›£è½æ‡‰ç”¨ç¨‹å¼å°é€™å…©å€‹å‡½æ•¸çš„å‘¼å«ï¼Œä¸¦ç›´æ¥æå–å‡ºæœªåŠ å¯†çš„é€£ç·šå…§å®¹ã€‚ Security: å‰é¢æœ‰è¬›åˆ°é€é eBFPï¼Œæˆ‘å€‘å¯ä»¥ç›£æ§ system call çš„å‘¼å«ã€kernal çš„åŸ·è¡Œã€user space ç¨‹å¼çš„å‡½æ•¸å‘¼å«ç­‰ç­‰ï¼Œå› æ­¤æˆ‘å€‘ä¹Ÿå°±å¯ä»¥é€é eBFP ä¾†ç›£æ§é€™äº›äº‹ä»¶ï¼Œä¸¦ä»¥æ­¤æª¢æ¸¬ç¨‹å¼çš„å®‰å…¨ï¼Œæ‹’çµ•éæ³•çš„ system call å‘¼å«ï¼Œæˆ–ç•°å¸¸è¡Œç‚ºç­‰ç­‰ã€‚ + è©³ç´°å¯ä»¥åƒè€ƒ Tetragon å’Œ tracee ä¹‹é¡çš„å°ˆæ¡ˆã€‚\nä¸Šé¢å¤§æ¦‚ä»‹ç´¹äº†ä¸€äº› eBFP çš„æ‡‰ç”¨å ´æ™¯ï¼ŒBPF ç¶“éæ“´å±•ä¹‹å¾Œï¼Œä¸å†ä¾·é™æ–¼å°åŒ…éæ¿¾é€™å€‹å ´æ™¯ï¼Œè€Œåœ¨ç¶²è·¯è™•ç†ã€å†…æ ¸è¿½è¹¤ã€å®‰å…¨ç›£æ§ï¼Œç­‰å„å€‹æ–¹é¢æœ‰äº†æ›´å¤šå¯ä»¥é–‹ç™¼çš„æ½›èƒ½ã€‚\nåƒè€ƒè³‡æ–™ # The BSD Packet filter paper tcpdump man page tcpdump ä¸ libpcap åŸç†åˆ†æ Debugging with eBPF Part 3: Tracing SSL/TLS connections eBPF applications ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-1-abstract-and-background/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 1 - æ‘˜è¦èˆ‡ç°¡ä»‹","type":"posts"},{"content":"æœ¬ç¯‡æ–‡ç« å°‡æœƒä»‹ç´¹åŒ…å« program type, map ç­‰é‡è¦æ¦‚å¿µé‚„æœ‰ eBPF çš„è¼‰å…¥æµç¨‹\nProgram Type # æˆ‘å€‘å¯ä»¥æŠŠ eBPF ç¨‹å¼å€åˆ†æˆä¸åŒçš„ BPF program typeï¼Œä¸åŒçš„ program type ä»£è¡¨å¯¦ç¾ä¸åŒåŠŸèƒ½çš„ eBPF ç¨‹å¼ã€‚é€šå¸¸ä¸åŒçš„ program type ä¹Ÿæœƒæœ‰ä¸åŒ hook pointï¼ŒeBPF ç¨‹å¼çš„è¼¸å…¥å’Œè¼¸å‡ºæ ¼å¼ä¹Ÿä¸åŒï¼Œä¹Ÿå°±å½±éŸ¿åˆ°ä¸åŒçš„ kernal çµ„ä»¶ã€‚\nåˆ°ç›®å‰ Linux kernal 5.19 ç‰ˆï¼Œlinux ç¸½å…±å®šç¾©äº† 32 ç¨®çš„ program typeã€‚åœ¨ linux kernal source code çš„ include/uapi/linux/bpf.h ä¸­å®šç¾©äº† bpf_prog_type åˆ—èˆ‰ï¼Œåˆ—èˆ‰äº†æ‰€æœ‰çš„ program typeã€‚\nenum bpf_prog_type { BPF_PROG_TYPE_UNSPEC, BPF_PROG_TYPE_SOCKET_FILTER, BPF_PROG_TYPE_KPROBE, BPF_PROG_TYPE_SCHED_CLS, BPF_PROG_TYPE_SCHED_ACT, BPF_PROG_TYPE_TRACEPOINT, BPF_PROG_TYPE_XDP, BPF_PROG_TYPE_PERF_EVENT, BPF_PROG_TYPE_CGROUP_SKB, BPF_PROG_TYPE_CGROUP_SOCK, ... }; ä»¥ BPF_PROG_TYPE_XDP ç‚ºä¾‹ï¼ŒXDP æ˜¯ Express Data Path çš„ç¸®å¯«ï¼ŒXDP ç¨‹å¼æœƒåœ¨å°åŒ…å¾ç¶²è·¯å¡é€²å…¥åˆ° kernal çš„æœ€æ—©æœŸè¢«è§¸ç™¼ã€‚\nä¸€å€‹ eBPF ç¨‹å¼å¤§è‡´ä¸Šå¯ä»¥çœ‹æˆä¸€å€‹ c çš„ functionï¼Œåœ¨ XDP program type ä¸‹ï¼Œkernal æœƒå¸¶å…¥ xdp_md è³‡æ–™çµæ§‹ä½œç‚º eBPF ç¨‹å¼çš„è¼¸å…¥ï¼ŒåŒ…å«äº†å°åŒ…çš„å…§å®¹ã€å°åŒ…çš„ä¾†æºä»‹é¢ç­‰è³‡è¨Šã€‚\n//include/uapi/linux/bpf.h /* user accessible metadata for XDP packet hook */ struct xdp_md { __u32 data; __u32 data_end; __u32 data_meta; /* Below access go through struct xdp_rxq_info */ __u32 ingress_ifindex; /* rxq-\u0026gt;dev-\u0026gt;ifindex */ __u32 rx_queue_index; /* rxq-\u0026gt;queue_index */ __u32 egress_ifindex; /* txq-\u0026gt;dev-\u0026gt;ifindex */ }; eBPF ç¨‹å¼å¿…é ˆå›å‚³ä¸€å€‹ xdp_action çš„ enumï¼Œå…¶ä¸­ XDP_PASS è¡¨ç¤ºå°åŒ…å¯ä»¥ç¹¼çºŒé€šéåˆ° kernal network stackï¼ŒXDP_DROP è¡¨ç¤ºç›´æ¥ä¸Ÿæ£„è©²å°åŒ…ã€‚\n//include/uapi/linux/bpf.h enum xdp_action { XDP_ABORTED = 0, XDP_DROP, XDP_PASS, XDP_TX, XDP_REDIRECT, }; é€éé€™æ¨£çš„ eBPF ç¨‹å¼ï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨å°åŒ…å‰›é€²å…¥ kernal çš„æ™‚å€™ç›´æ¥ä¸Ÿæ£„éæ³•å°åŒ…ï¼Œèƒ½å¤ æ¯”è¼ƒé«˜æ•ˆçš„è™•ç† DDos æ”»æ“Šç­‰å•é¡Œã€‚\nä»¥æ­¤å¯ä»¥å¯«å‡ºä¸€å€‹æ¥µç°¡å–®çš„ eBPF ç¨‹å¼ç¯„ä¾‹ (åªåŒ…å«æœ€ä¸»è¦çš„éƒ¨ä»½ï¼Œå®Œæ•´çš„ç¨‹å¼å¯«æ³•æœƒåœ¨å¾Œé¢æåˆ°)\nint xdp_prog_simple (struct xdp_md *ctx) { return XDP_DROP; } é€™å€‹ eBPF ç¨‹å¼å¯ä»¥è¢« attach åˆ°æŸä¸€å€‹ interface ä¸Šï¼Œç•¶å°åŒ…é€²ä¾†æ™‚æœƒè¢«å‘¼å«ã€‚ç”±æ–¼ç„¡æ¢ä»¶å›å‚³ XDP_DROPï¼Œå› æ­¤æœƒä¸Ÿæ£„æ‰€æœ‰çš„å°åŒ…ã€‚\nä½¿ç”¨æµç¨‹ # eBPF ç¨‹å¼ç¢¼è¦è¢«ç·¨è­¯æˆ eBPF è™›æ“¬æ©Ÿçš„ bytecode æ‰èƒ½å¤ åŸ·è¡Œã€‚ ä»¥ XDP ç‚ºä¾‹ï¼Œæœ€åº•å±¤çš„åšæ³•æ˜¯ç›´æ¥ä½¿ç”¨ LLVM ç·¨è­¯é€™æ®µ eBPF ç¨‹å¼ç¢¼ã€‚ é¦–å…ˆéœ€è¦è£œé½Šä½¿ç”¨ LLVM ç·¨è­¯æ™‚ï¼Œéœ€è¦çš„ header file å’Œè³‡è¨Šã€‚\n#include \u0026lt;uapi/linux/bpf.h\u0026gt; SEC (\u0026#34;xdp_prog\u0026#34;) int xdp_program(struct xdp_md *ctx) { return XDP_DROP; } char _license [] SEC (\u0026#34;license\u0026#34;) = \u0026#34;GPL\u0026#34;; æ¥è‘—ä½¿ç”¨ LLVM ç·¨è­¯æˆ ELF æ ¼å¼æ–‡ä»¶\nclang -c -target bpf xdp.c -o xdp.o ç„¶å¾Œä½¿ç”¨ bpf system call å°‡ bytecode è¼‰å…¥åˆ° kernal çš„ eBPF è™›æ“¬æ©Ÿå…§ï¼Œä¸¦å–å¾—å°æ‡‰çš„ file descriptorã€‚æœ€å¾Œé€é netlink socket ç™¼é€ä¸€å€‹ NLA_F_NESTED | 43 è¨Šæ¯ä¾†æŠŠ interface index èˆ‡ ebpf ç¨‹å¼çš„ file descriptor ç¶å®šã€‚å°±èƒ½å¤ è®“ eBPF ç¨‹å¼åœ¨å°æ‡‰çš„ interface å°åŒ…è™•ç†éç¨‹ä¸­è¢«å‘¼å«ã€‚\niproute2 æœ‰å¯¦ä½œè¼‰å…¥ eBPF çš„åŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥é€éä¸‹æŒ‡ä»¤\nip link set dev eth1 xdp xdp.o å¯èƒ½æœƒæ³¨æ„åœ¨ç¨‹å¼ç¢¼çš„æœ€å¾Œä¸€è¡Œã€‚ç‰¹åˆ¥æ¨™è¨»äº† GPL licenceã€‚ç”±æ–¼ eBPF ç¨‹å¼æœƒåµŒå…¥åˆ° kernelï¼Œèˆ‡ kernel ç·Šå¯†çš„ä¸€èµ·åŸ·è¡Œ (å…±ç”¨ address spaceã€æ¬Šé™ç­‰)ï¼Œåœ¨æ³•å¾‹åˆ¤æ–·ç¨ç«‹ç¨‹å¼çš„é‚Šç•Œæ™‚ï¼ŒeBPF ç¨‹å¼å’Œç›¸é—œçš„ kernel çµ„ä»¶æœƒè¢«è¦–ç‚ºä¸€é«”ï¼Œå› æ­¤ eBPF ç¨‹å¼æœƒå—åˆ°ç›¸é—œçš„ licence é™åˆ¶ã€‚\nè€Œé€™é‚Šæåˆ°çš„å…§æ ¸çµ„ä»¶æŒ‡çš„æ˜¯ eBPF helper functionã€‚helper function æ˜¯ eBPF ç¨‹å¼èˆ‡ kernel æºé€šçš„æ©‹æ¢ï¼Œç”±æ–¼ eBPF ç¨‹å¼æ˜¯åœ¨ eBPF è™›æ“¬æ©Ÿå…§åŸ·è¡Œï¼Œå› æ­¤å¦‚æœè¦å–å¾— kernel çš„é¡å¤–è³‡è¨Šæˆ–æ”¹è®Š kernel çš„è¡Œç‚ºï¼Œå¿…é ˆé€éè™›æ“¬æ©Ÿæä¾›çš„ helper function æ¥å£ã€‚\nä¸€éƒ¨ä»½çš„ helper function åŸºæ–¼ GPL æˆæ¬Šï¼Œå› æ­¤ç•¶ eBPF ç¨‹å¼ä½¿ç”¨äº† GPL æˆæ¬Šçš„ helper function å°±å¿…é ˆæ¨™ç¤ºç‚º GPL æˆæ¬Šï¼Œå¦å‰‡å°‡ eBPF ç¨‹å¼è¼‰å…¥åˆ° kernel æ™‚ï¼Œæœƒç›´æ¥è¢« kernel æ‹’çµ•ã€‚\nç›´æ¥ä½¿ç”¨æœ€åº•å±¤çš„æ–¹æ³•é–‹ç™¼ç›¸å°ä¾†èªªæ˜¯ä¸æ–¹ä¾¿å’Œå›°é›£çš„ï¼Œä¸åŒ program type çš„è¼‰å…¥æ–¹å¼å¯èƒ½é‚„å®Œå…¨ä¸ä¸€æ¨£ï¼Œå› æ­¤è¨±å¤šæŠ½è±¡çš„æ¡†æ¶å’Œ SDK è¢«ç™¼å‡ºä¾†ã€‚é›–ç„¶é‚„æ˜¯éœ€è¦ç·¨å¯« eBPF çš„ c codeï¼Œä½†æ˜¯ç·¨è­¯ã€è¼‰å…¥ã€æºé€šç­‰å·¥ä½œè¢«åŒ…åœ¨ SDK è£¡é¢ï¼Œå¯ä»¥æ–¹ä¾¿çš„ç›´æ¥ä½¿ç”¨ã€‚\né€™é‚Šèˆ‰ä¾‹ BPF Compiler Collection (BCC) é€™å¥—å·¥å…·ï¼ŒBCC å°‡ eBPF çš„ç·¨è­¯å’Œè¼‰å…¥å‹•ä½œåŒ…è£æˆäº† python çš„ APIï¼Œå› æ­¤èƒ½å¤ ç°¡å–®çš„å®Œæˆ eBPF çš„ç·¨è­¯å’ŒåŸ·è¡Œã€‚\nfrom bcc import BPF import time b = BPF (text = \u0026#34;\u0026#34;\u0026#34; #include \u0026lt;uapi/linux/bpf.h\u0026gt; int xdp_prog1 (struct xdp_md *ctx) { return XDP_DROP; } \u0026#34;\u0026#34;\u0026#34;) fn = b.load_func (\u0026#34;xdp_prog1\u0026#34;, BPF.XDP) b.attach_xdp (\u0026#34;wlp2s0\u0026#34;, fn, 0) try: while True: time.sleep (1) except KeyboardInterrupt: pass b.remove_xdp (\u0026#34;wlp2s0\u0026#34;, 0) ä½¿ç”¨æ¢ä»¶ # åœ¨é–‹å§‹ç© eBPF ä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆç¢ºå®šä¸€ä¸‹æˆ‘å€‘çš„ç’°å¢ƒèƒ½å¤ ä½¿ç”¨ eBPFã€‚æœ€æ—©åœ¨ kernal 3.15 ç‰ˆåŠ å…¥äº† eBPF åŠŸèƒ½ã€‚å¾ŒçºŒåœ¨ 3.15 åˆ°ç¾åœ¨çš„ 5.19 ç‰ˆé–“ï¼ŒeBPF é™¸é™¸çºŒçºŒåŠ å…¥äº†è¨±å¤šæ–°çš„åŠŸèƒ½ï¼Œå› æ­¤é–‹ç™¼çš„æ™‚å€™ï¼Œå¦‚æœä¸æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆçš„ä½œæ¥­ç³»çµ±ï¼Œå°±å¯èƒ½æœƒéœ€è¦ç¢ºèªä¸€ä¸‹ç‰ˆæœ¬æ˜¯å¦æ”¯æ´ï¼Œå„å€‹åŠŸèƒ½æ”¯æ´çš„ç‰ˆæœ¬å¯ä»¥åœ¨ é€™é‚Š åƒè€ƒ\nå¦å¤–å°±æ˜¯ eBPF çš„åŠŸèƒ½éœ€è¦åœ¨ç·¨è­¯ kernel çš„æ™‚å€™å•Ÿç”¨ï¼Œå¤§éƒ¨åˆ†çš„ç™¼è¡Œç‰ˆæ‡‰è©²éƒ½ç›´æ¥å•Ÿç”¨äº†ï¼Œä¸éå¦‚æœä½¿ç”¨æ™‚å‡ºç¾å•é¡Œå¯èƒ½é‚„æ˜¯åˆ° /proc/config.gz æˆ– /boot/config-\u0026lt;kernel-version\u0026gt; æª¢æŸ¥å…§æ ¸ç·¨è­¯çš„è¨­å®šï¼Œæ˜¯å¦æœ‰é–‹å•Ÿ CONFIG_BPF, CONFIG_BPF_SYSCALL, CONFIG_BPF_JIT é‚„æœ‰å…¶ä»– BPF ç›¸é—œ Kernal é¸é …ã€‚ è¨­å®šå¯ä»¥åƒè€ƒ bcc çš„ å®‰è£éœ€æ±‚\nè¼‰å…¥æµç¨‹ # ç•¶ eBPF ç¨‹å¼ç·¨è­¯å®Œæˆå¾Œï¼Œå°±éœ€è¦é€é bpf system call (åŸå§‹ç¢¼)ï¼Œå°‡ç·¨è­¯å¾Œçš„ bytecode è¼‰å…¥ kernel å…§åŸ·è¡Œã€‚\nç‚ºäº†å®‰å…¨æ€§è€ƒé‡ï¼Œè¦æ›è¼‰ eBPF ç¨‹å¼éœ€è¦ root æ¬Šé™æˆ– CAP_BPF capabilityï¼Œä¸éç›®å‰ä¹Ÿæœ‰åœ¨è¨­è¨ˆè®“é root æ¬Šé™å¸³è™Ÿèƒ½è¼‰å…¥ eBPF ç¨‹å¼ï¼Œå› æ­¤å°‡ kernel.unprivileged_bpf_disabled sysctl è¨­ç½®ç‚º false çš„æƒ…æ³ä¸‹ï¼Œé root å¸³è™Ÿæ˜¯æœ‰èƒ½åŠ›èƒ½å¤ ä½¿ç”¨ BPF_PROG_TYPE_SOCKET_FILTER çš„ eBPF ç¨‹å¼ã€‚\neBPF ç¨‹å¼éœ€è¦åµŒå…¥åˆ° kernel åŸ·è¡Œï¼Œå› æ­¤ eBPF ç¨‹å¼çš„å®‰å…¨æ€§æ˜¯æ¥µç‚ºé‡è¦çš„ï¼Œä¹Ÿè¦é¿å… eBPF ç¨‹å¼çš„éŒ¯èª¤æœ‰å¯èƒ½æœƒå°è‡´ kernel å´©æ½°æˆ–å¡æ­»ï¼Œå› æ­¤æ¯å€‹è¼‰å…¥ kernel çš„ eBPF ç¨‹å¼éƒ½è¦å…ˆç¶“éæ¥è‘— verifier æª¢æŸ¥ã€‚\né¦–å…ˆ eBPF ç¨‹å¼å¿…é ˆè¦åœ¨æœ‰é™çš„æ™‚é–“å…§åŸ·è¡Œå®Œæˆï¼Œä¸ç„¶å°±æœƒé€ æˆ kernel å¡æ­»ï¼Œå› æ­¤åœ¨æ—©æœŸçš„ç‰ˆæœ¬ä¸­ verifier æ˜¯æ‹’çµ•ä»»ä½• loop çš„å­˜åœ¨çš„ï¼Œæ•´å€‹ç¨‹å¼ç¢¼å¿…é ˆæ˜¯ä¸€å¼µ DAG (æœ‰å‘ç„¡ç’°åœ–)ã€‚ä¸éåœ¨ kernel 5.3 ç‰ˆæœ¬é–‹å§‹ï¼Œverifier å…è¨±äº†æœ‰é™æ¬¡æ•¸çš„å¾ªç’°ï¼Œverifier æœƒé€éæ¨¡æ“¬åŸ·è¡Œæª¢æŸ¥ eBPF æ˜¯ä¸æ˜¯æœƒåœ¨æœ‰é™æ¬¡æ•¸å…§åœ¨æ‰€æœ‰å¯èƒ½çš„åˆ†æ”¯ä¸Šèµ°åˆ° bpf_exitã€‚\næ¥è‘— eBPF ç¨‹å¼çš„å¤§å°ä¹Ÿå­˜åœ¨é™åˆ¶ï¼Œæ—©æœŸåªä¸€å€‹ eBPF ç¨‹å¼åªå…è¨± 4096 å€‹ ebpf vm çš„ instruction sï¼Œåœ¨è¨­è¨ˆæ¯”è¼ƒè¤‡é›œçš„ eBPF ç¨‹å¼ä¸Šæœ‰äº›æ‰è¥Ÿè¦‹è‚˜ï¼Œå› æ­¤å¾Œä¾†åœ¨ 5.2 ç‰ˆ é€™å€‹é™åˆ¶è¢«æ”¾å¯¬æˆ 1 million å€‹æŒ‡ä»¤ï¼ŒåŸºæœ¬ä¸Šæ˜¯ååˆ†å¤ ç”¨äº†ï¼Œä¹Ÿé‚„æ˜¯èƒ½ç¢ºä¿ ebpf ç¨‹å¼åœ¨ 1/10 ç§’å…§åŸ·è¡Œå®Œæˆã€‚\nç„¶å¾Œç¨‹å¼çš„ stack ä¹Ÿå­˜åœ¨å¤§å°é™åˆ¶ï¼Œç›®å‰é™åˆ¶æ˜¯ 512ã€‚\nç•¶ç„¶ verifier æª¢æŸ¥çš„é …ç›®ä¸åªå¦‚æ­¤ï¼Œå‰é¢æåˆ° non-GPL licence eBPF ç¨‹å¼ä½¿ç”¨ GPL licence çš„ helper functionï¼Œä¹Ÿæœƒè¢« verifier æ‹’çµ•ï¼Œä¸¦æ”¶åˆ°ä¸€å€‹ cannot call GPL-restricted function from non-GPL compatible program çš„éŒ¯èª¤ã€‚\næ­¤å¤– verifier ä¹Ÿæœƒé‡å° helper function çš„å‡½æ•¸å‘¼å«åƒæ•¸åˆæ³•æ€§ï¼Œæš«å­˜å™¨æ•¸å€¼åˆæ³•æ€§ï¼Œæˆ–å…¶ä»–ç„¡æ•ˆçš„ä½¿ç”¨æ–¹å¼ã€ç„¡æ•ˆçš„å›å‚³æ•¸å€¼ã€ç‰¹å®šå¿…é ˆçš„è³‡æ–™çµæ§‹æ˜¯å¦å®šç¾©ã€æ˜¯å¦éæ³•å­˜å–ä¿®æ”¹æ•¸æ“šã€ç„¡æ•ˆçš„ instruction åƒæ•¸ç­‰ç­‰åšå‡ºæª¢æŸ¥ä»¥åŠæ‹’çµ•å­˜åœ¨ç„¡æ³•åŸ·è¡Œåˆ°çš„ç¨‹å¼ç¢¼ã€‚\nå…·é«”çš„ verifier å¯ä»¥åƒè€ƒ 1 è¬ 5 åƒè¡Œçš„ åŸå§‹ç¢¼\nJIT # ç•¶ eBPF ç¨‹å¼é€šé verifier çš„é©—è­‰ä¹‹å¾Œæœƒé€²è¡Œ JIT (Just In Time) çš„äºŒæ¬¡ç·¨è­¯ã€‚ä¹‹å‰ä¸€ç›´æåˆ° eBPF æ˜¯ä¸€å€‹åŸ·è¡Œåœ¨ kernel å…§çš„è™›æ“¬æ©Ÿï¼Œå› æ­¤ç·¨è­¯å‡ºä¾†çš„ bytecode éœ€è¦å†åŸ·è¡Œçš„éç¨‹ä¸­åœ¨è½‰æ›æˆ machine codeï¼Œæ‰èƒ½å¤ çœŸæ­£åœ¨ CPU ä¸Šé¢åŸ·è¡Œï¼Œç„¶è€Œé€™æ¨£çš„è™›æ“¬åŒ–å’Œè½‰æ›éç¨‹ï¼Œæœƒé€ æˆ eBPF ç¨‹å¼çš„åŸ·è¡Œæ•ˆç‡ï¼Œæ¯”ç›´æ¥åŸ·è¡Œ machine code è¦ä½ä¸Šå¾ˆå¤šã€‚\nå› æ­¤ eBPF åŠ å…¥äº† JIT çš„åŠŸèƒ½ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯æŠŠ eBPF çš„ bytecode é å…ˆåœ¨è¼‰å…¥çš„æ™‚å€™ï¼Œç›´æ¥ç·¨è­¯æˆ CPU å¯åŸ·è¡Œçš„ machine codeï¼Œåœ¨åŸ·è¡Œ eBPF ç¨‹å¼çš„æ™‚å€™å°±å¯ä»¥ç›´æ¥åŸ·è¡Œï¼Œè€Œä¸ç”¨å†ç¶“é eBPF è™›æ“¬æ©Ÿçš„è½‰æ›ï¼Œä½¿ eBPF å¯ä»¥é”åˆ°åŸç”Ÿç¨‹å¼çš„åŸ·è¡Œæ•ˆç‡ã€‚\nç”±æ–¼ JIT éœ€è¦ç·¨è­¯å‡º machine codeï¼Œå› æ­¤é‡å°ä¸åŒçš„ CPU å¹³å°ä»–çš„æ”¯æ´æ˜¯åˆ†é–‹çš„ï¼Œä¸éç•¶ç„¶åˆ°äº†ç¾åœ¨ï¼ŒåŸºæœ¬ä¸Šå¤§éƒ¨åˆ†ä¸»æµçš„ CPU æ¶æ§‹ (x86, ARM, RISC, MIPSâ€¦) éƒ½å·²ç¶“æ”¯æ´äº†ï¼Œå…·é«”çš„æ”¯æ´æƒ…æ³å¯ä»¥åƒè€ƒé€™å¼µ è¡¨ã€‚\nåŒæ¨£ JIT æ˜¯ eBPF çš„ä¸€å€‹å¯é–‹é—œçš„ç¨ç«‹åŠŸèƒ½ï¼Œé€éè¨­ç½® bpf_jit_enable ä¾†å•Ÿç”¨ JIT çš„åŠŸèƒ½\nsystcl -w net.core.bpf_jit_enable=1 (è¨­ç½®ç‚º 2 çš„è©±ï¼Œå¯ä»¥åœ¨ kernel log çœ‹åˆ°ç›¸é—œæ—¥èªŒ)\nåˆ°æ­¤ eBPF ç¨‹å¼å°±å°±å®Œæˆè¼‰å…¥äº†ï¼Œé›–ç„¶åœ¨ eBPF ç¨‹å¼çš„è¼‰å…¥éç¨‹ä¸­é‚„æœƒå®Œæˆä¸€äº›è³‡æ–™çµæ§‹çš„å»ºç«‹å’Œç¶­è­·ï¼Œä½†æ˜¯é€™å€‹éƒ¨åˆ†å°±ä¸å†æœ¬æ–‡çš„ç¯„åœå…§äº†ã€‚\nç•¶ç„¶åˆ°æ­¤ eBPF ç¨‹å¼åªæ˜¯è¼‰å…¥åˆ°äº†å…§æ ¸ä¹‹ä¸­ï¼Œä¸¦æœªé€£æ¥åˆ°ä»»ä½•çš„ hook pointï¼Œå› æ­¤åˆ°æ­¤ç‚º eBPF ç¨‹å¼é‚„æœªèƒ½çœŸæ­£è¢«åŸ·è¡Œï¼Œä¸éé€™å°±æ˜¯å¾Œé¢çš„æ•…äº‹äº†ã€‚\nå¾ kernel source code ä¾†çœ‹ï¼Œåœ¨ eBPF ç¨‹å¼è¼‰å…¥çš„éç¨‹ä¸­æœƒå‘¼å« bpf_prog_select_runtime ä¾†åˆ¤æ–·æ˜¯å¦è¦å‘¼å« JIT compiler å»ç·¨è­¯ï¼Œæœ‰èˆˆè¶£å¯ä»¥å» trace é€™éƒ¨åˆ†çš„ codeã€‚\nç”Ÿå‘½é€±æœŸ # åœ¨é€é bpf (BPF_PROG_LOAD, ...) system call å°‡ eBPF ç¨‹å¼è¼‰å…¥å…§æ ¸çš„éç¨‹ (å¯ä»¥åƒè€ƒ åŸå§‹ç¢¼)ï¼Œæœƒæ›¿è©² eBPF ç¨‹å¼å»ºç«‹ struct bpf_prog çµæ§‹ï¼Œå…¶ä¸­ prog-\u0026gt;aux-\u0026gt;refcnt è¨ˆæ•¸å™¨è¨˜éŒ„äº†è©² eBPF ç¨‹å¼çš„åƒè€ƒæ•¸é‡ï¼Œè¼‰å…¥çš„æ™‚å€™æœƒé€é atomic64_set (\u0026amp;prog-\u0026gt;aux-\u0026gt;refcnt, 1); å°‡ refcnt è¨­ç½®ç‚ºä¸€ï¼Œä¸¦è¿”ç‚ºå°æ‡‰çš„ file descriptorã€‚\nç•¶ refcnt é™ç‚º 0 çš„æ™‚å€™ï¼Œå°±æœƒè§¸ç™¼ unloadï¼Œå°‡ eBPF ç¨‹å¼è³‡æºçµ¦é‡‹æ”¾æ‰ã€‚(åŸå§‹ç¢¼) å› æ­¤å¦‚æœå‘¼å« BPF_PROG_LOAD çš„ç¨‹å¼æ²’æœ‰é€²ä¸€æ­¥æ“ä½œï¼Œä¸¦ç›´æ¥çµæŸçš„è©±ï¼Œç•¶ file descriptor è¢« releaseï¼Œå°±æœƒè§¸ç™¼ refcntâ€“ï¼Œè€Œè®Šæˆ 0 ä¸¦ç§»é™¤ eBPF ç¨‹å¼ã€‚\nè¦å¢åŠ  eBPF ç¨‹å¼ refcnf å¤§è‡´ä¸Šæœ‰å¹¾ç¨®æ–¹å¼\né€é bpf systemcall çš„ BPF_BTF_GET_FD_BY_ID ç­‰æ–¹å¼å–å¾— eBPF ç¨‹å¼å°æ‡‰çš„ file descriptor å°‡ eBPF ç¨‹å¼ attach åˆ°äº‹ä»¶ã€Link ä¸Šï¼Œä½¿ eBPF ç¨‹å¼èƒ½çœŸçš„é–‹å§‹å·¥ä½œã€‚ å› æ­¤ç•¶ eBPF è¢« attach åˆ° hook points ä¸Šä¹‹å¾Œï¼Œå³ä¾¿åŸå§‹è¼‰å…¥ç¨‹å¼çµæŸä¹Ÿä¸æœƒå°è‡´ eBPF ç¨‹å¼è¢«å›æ”¶ï¼Œè€Œå¯ä»¥æ­£å¸¸ç¹¼çºŒå·¥ä½œã€‚ Link æ˜¯ eBPF å¾Œä¾†æä¾›çš„æ–°ç‰¹æ€§ï¼Œå› æ­¤æš«æ™‚è¶…å‡ºäº†æœ¬æ–‡çš„è¨è«–ç¯„åœ é€é bpf systemcall çš„ BPF_OBJ_PINï¼Œå°‡ eBPF ç¨‹å¼é‡˜åˆ° BPFFS ä¸Šã€‚ BPFFS æ˜¯ BPF file systemï¼Œæœ¬è³ªä¸Šæ˜¯ä¸€å€‹è™›æ“¬çš„æª”æ¡ˆç³»çµ±ï¼Œä¸€æ¨£é€é bpf system call çš„ BPF_OBJ_PINï¼Œæˆ‘å€‘å¯ä»¥æŠŠ eBPF ç¨‹å¼æ”¾åˆ° /sys/fs/bpf/ è·¯å¾‘ä¸‹çš„æŒ‡å®šä½ç½®ï¼Œä¸¦é€é open çš„æ–¹å¼ç›´æ¥å–å¾— file descriptorã€‚PIN åŒæ¨£æœƒå¢åŠ  refcntï¼Œå› æ­¤ PIN ä½çš„ç¨‹å¼ä¸æœƒè¢«å›æ”¶ è¦é‡‹æ”¾ PIN ä½çš„ç¨‹å¼ï¼Œå¯ä»¥ä½¿ç”¨ unlink æŒ‡ä»¤ç§»é™¤è™›æ“¬æª”æ¡ˆï¼Œå³å¯å–æ¶ˆ PINã€‚ é€éä»¥ä¸Šçš„æ“ä½œéƒ½æœƒå¢åŠ  refcntï¼Œç›¸åçš„ï¼Œå°æ‡‰çš„è³‡æºé‡‹æ”¾å‰‡æœƒæ¸›å°‘ refcntã€‚å› æ­¤åªè¦ç¢ºä¿æœ‰ä»»ä½•ä¸€å€‹ eBPF ç¨‹å¼çš„åƒè€ƒå­˜åœ¨ï¼Œå³å¯ä¿è­‰ eBPF ç¨‹å¼ä¸€ç›´å­˜åœ¨ kernel å…§ã€‚\nHelper Funtions # ä¹‹å‰åœ¨ä»‹ç´¹ eBPF çš„ GPL æˆæ¬Šçš„æ™‚å€™ï¼Œæœ‰æåˆ° eBPF helper function é€™å€‹æ±è¥¿ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘ä¾†æ¯”è¼ƒä»”ç´°çš„ä»‹ç´¹ä¸€ä¸‹ã€‚\nä¹‹å‰æåˆ° eBPF ç¨‹å¼æ˜¯åœ¨ eBPF è™›æ“¬æ©Ÿå…§åŸ·è¡Œï¼Œç”±æ–¼ eBPF ç¨‹å¼æœƒåµŒå…¥ kernel å…§ï¼Œåœ¨ kernel space åŸ·è¡Œï¼Œæ‰€ä»¥ç‚ºäº†å®‰å…¨æ€§è€ƒé‡æˆ‘å€‘ä¸èƒ½è®“ eBPF ç¨‹å¼ä»»æ„çš„å­˜å–å’Œä¿®æ”¹ kernel è¨˜æ†¶é«”å’Œå‘¼å« kernel å‡½æ•¸ï¼Œå› æ­¤ eBPF çš„è§£æ±ºæ–¹æ¡ˆæ˜¯æä¾›äº†ä¸€ç³»åˆ—çš„ APIï¼Œè®“ eBPF ç¨‹å¼åªèƒ½å¤ éé™å®šçš„ API å»èˆ‡ kernel æºé€šï¼Œå› æ­¤å¯ä»¥è®“ eBPF ç¨‹å¼å° kernel çš„æ“ä½œé™åˆ¶åœ¨ä¸€å€‹å¯æ§çš„ç¯„åœï¼Œä¹Ÿå¯ä»¥é€é verifier å’Œ API å¾Œé¢çš„å¯¦ä½œå»ç¢ºä¿ API å‘¼å«çš„æœ‰æ•ˆå’Œå®‰å…¨æ€§ã€‚\nåœ¨ eBPF è£¡é€™ä¸€ç³»åˆ—çš„ API å°±ç¨±ä¹‹ç‚º eBPF helper funtionsã€‚\nå¦å¤–ä¸åŒçš„å°æ–¼ eBPF program type çš„ eBPF ç¨‹å¼ï¼Œç”±æ–¼ä»–å€‘åŸ·è¡Œçš„æ™‚æ©Ÿé»å’Œåœ¨ kernel çš„ä½ç½®ä¸åŒï¼Œå› æ­¤ä»–å€‘èƒ½å¤ å–å¾—çš„ kernel è³‡è¨Šä¹Ÿå°±ä¸åŒï¼Œä»–å€‘å¯ä»¥å‘¼å«åŸ·è¡Œçš„ helper funtions ä¹Ÿå°±ä¸åŒã€‚å…·é«”æ¯å€‹ä¸åŒ program type å¯ä»¥åŸ·è¡Œçš„ helper function å¯ä»¥åƒè€ƒ bcc çš„ æ–‡ä»¶\nä¸‹é¢åˆ—å¹¾èˆ‰å€‹æ‰€æœ‰ program type éƒ½å¯ä»¥å‘¼å«çš„ helper function\nu64 bpf_ktime_get_ns (void) å–å¾—å¾é–‹æ©Ÿé–‹å§‹åˆ°ç¾åœ¨çš„æ™‚é–“ï¼Œå–®ä½æ˜¯å¥ˆç§’ u32 bpf_get_prandom_u32 (void) å–å¾—ä¸€å€‹ random number æ¥è‘—æˆ‘å€‘èˆ‰ä¾‹åœ¨ BPF_PROG_TYPE_SOCKET_FILTER ä¸‹æ‰èƒ½ä½¿ç”¨çš„ helper function\nlong bpf_skb_load_bytes (const void *skb, u32 offset, void *to, u32 len) ç”±æ–¼ socket filter çš„åŠŸèƒ½å°±æ˜¯å° socket çš„æµé‡åšéæ¿¾ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€é skb_load_bytes ä¾†å–å¾— socket å‚³è¼¸çš„å°åŒ…å…§å®¹ å®Œæ•´çš„ helper function åˆ—è¡¨é‚„æœ‰æ¯å€‹å‡½æ•¸å…·é«”çš„å®šç¾©ä»¥åŠä½¿ç”¨èªªæ˜æè¿°å¯ä»¥åœ¨ bpf.h æŸ¥æ‰¾åˆ°ã€‚\nå¦å¤–ç‰¹åˆ¥è¦æ³¨æ„çš„æ˜¯å—é™æ–¼ eBPF è™›æ“¬æ©Ÿçš„é™åˆ¶ï¼ŒeBPF helper function çš„åƒæ•¸æ•¸é‡æœ€å¤šåªå¯ä»¥æœ‰äº”å€‹ï¼Œåœ¨ä½¿ç”¨ä¸å®šåƒæ•¸é•·åº¦çš„åƒæ•¸æ™‚ï¼Œæœ€å¤šä¹Ÿåªèƒ½æœ‰ 5 å€‹åƒæ•¸ (å¦‚ä¹‹å¾Œæœƒæåˆ°çš„ trace_printk)ã€‚\nå› æ­¤é›–ç„¶ eBPF éå¸¸å¼·å¤§èƒ½å¤ éå¸¸æ–¹ä¾¿çš„å‹•æ…‹å° kernel åšä¿®æ”¹ï¼Œä½†ç‚ºäº†å®‰å…¨ï¼Œä»–å¯ä»¥åŸ·è¡Œçš„æ“ä½œæ˜¯è¨‚å®šåœ¨ä¸€å€‹éå¸¸åš´æ ¼çš„æ¡†æ¶ä¸Šçš„ï¼Œåœ¨é–‹ç™¼æ™‚éœ€è¦ç†Ÿç¿’æ•´å€‹æ¡†æ¶çš„é™åˆ¶å’Œå¯åˆ©ç”¨çš„ API è³‡æºã€‚\nDebug Tracing # åœ¨å°‡ eBPF ç¨‹å¼è¼‰å…¥ kernel å·¥ä½œå¾Œï¼Œæˆ‘å€‘å‹¢å¿…éœ€è¦ä¸€äº›æ‰‹æ®µä¾†èˆ‡ eBPF ç¨‹å¼åšæºé€šï¼Œä¸€æ–¹é¢æˆ‘å€‘éœ€è¦è¼¸å‡ºåµéŒ¯è¨Šæ¯ï¼Œä¾†å° eBPF ç¨‹å¼ debugï¼Œä¸€æ–¹é¢æˆ‘å€‘å¯èƒ½æœƒå¸Œæœ›èƒ½å¤ å¯¦æ™‚é€é eBPF ç¨‹å¼å–å¾— kernel çš„æŸäº›è³‡è¨Šåˆæˆ–è‘—å‹•æ…‹èª¿æ•´ eBPF ç¨‹å¼çš„åŸ·è¡Œè¦å‰‡ã€‚\nå¦‚æœåªæ˜¯éœ€è¦ eBPF ç¨‹å¼å–®æ–¹é¢çš„è¼¸å‡ºè¨Šæ¯ï¼Œè®“æˆ‘å€‘å¯ä»¥åµéŒ¯ï¼Œå¯ä»¥ä½¿ç”¨æ¯”è¼ƒç°¡å–®çš„æ‰‹æ®µã€‚eBPF æœ‰æä¾›ä¸€å€‹ helper function long bpf_trace_printk (const char *fmt, u32 fmt_size, ...)ï¼Œå¯ä»¥è¼¸å…¥ä¸€å€‹æ ¼å¼åŒ–å­—ä¸² fmtï¼ŒåŠæœ€å¤šä¸‰å€‹è®Šæ•¸ (åƒæ•¸å€‹æ•¸çš„é™åˆ¶)ã€‚è¼¸å‡ºçµæœæœƒè¢«è¼¸å‡ºåˆ° /sys/kernel/debug/tracing/trace_pipe ä¸­ã€‚.\nå¯ä»¥é€éæŒ‡ä»¤æŸ¥çœ‹è¼¸å‡ºçµæœï¼š\nsudo cat /sys/kernel/debug/tracing/trace_pipe è¼¸å‡ºçš„æ ¼å¼å¦‚ä¸‹ï¼š\ntelnet-470 [001] .N.. 419421.045894: 0x00000001: \u0026lt;formatted msg\u0026gt; é¦–å…ˆæ˜¯ process name telnetï¼Œç„¶å¾Œæ˜¯ PID 470ã€‚ æ¥çºŒçš„ 001 æ˜¯æŒ‡ç•¶å‰åŸ·è¡Œçš„ CPU ç·¨è™Ÿã€‚ .N.. çš„æ¯å€‹å­—å…ƒå°æ‡‰åˆ°ä¸€å€‹åƒæ•¸ irqs ä¸­æ–·æ˜¯å¦å•Ÿç”¨ TIF_NEED_RESCHED å’Œ PREEMPT_NEED_RESCHED æ˜¯å¦è¨­ç½® (ç”¨æ–¼ kernel process scheduling) ç¡¬ä¸­æ–­ / è»Ÿä¸­æ–­æ˜¯å¦ç™¼ç”Ÿä¸­ level of preempt_disabled 419421.045894 æ™‚é–“ 0x00000001: eBPF å…§éƒ¨çš„æŒ‡ä»¤æš«å­˜å™¨æ•¸å€¼ é›–ç„¶ trace_printk å¯ä»¥æ¥æ”¶æ ¼å¼åŒ–å­—ä¸²ï¼Œä½†æ˜¯æ”¯æ´çš„æ ¼å¼å­—å…ƒæ¯”è¼ƒå°‘ï¼Œåªæ”¯æ´ % d, % i, % u, % x, % ld, % li, % lu, % lx, % lld, % lli, % llu, % llx, % p, % sã€‚\nå¦å¤–æœ‰ä¸€å€‹ bpf_printk å·¨é›†ï¼Œæœƒä½¿ç”¨ sizeof (fmt) å¹«å¿™å¡«ä¸Šç¬¬äºŒå€‹ fmt_sizeã€‚å› æ­¤ä½¿ç”¨ bpf_printk å¯ä»¥çœç•¥ fmt_sizeã€‚\nåœ¨æ¯”è¼ƒæ–°çš„ç‰ˆæœ¬æä¾›äº† bpf_snprintf å’Œ bpf_seq_printf å…©å€‹æ–°çš„ print å‡½æ•¸ï¼Œå‰è€…æ˜¯æŠŠè³‡æ–™å¯«å…¥é å…ˆå»ºç«‹å¥½çš„ buffer å…§ï¼Œå¾Œè€…å¯ä»¥å¯«å…¥åœ¨ç‰¹å®š program type ä¸‹å¯ä»¥å–å¾—çš„ seg_fileï¼Œå…©è€…çš†ç”¨é™£åˆ—å­˜æ”¾å¾Œé¢çš„åƒæ•¸åˆ—ï¼Œå› æ­¤å¯ä»¥æ‰“ç ´ helper funtion 5 å€‹åƒæ•¸çš„é™åˆ¶ã€‚\næœ€å¾Œè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ä½¿ç”¨ trace_printk æœƒå¤§å¹…æ‹–æ…¢ eBPF ç¨‹å¼çš„åŸ·è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥ trace_printk åªé©ç”¨æ–¼é–‹ç™¼æ™‚ç”¨ä¾† debug ä½¿ç”¨ï¼Œä¸é©ç”¨æ–¼æ­£å¼ç’°å¢ƒç•¶ä¸­ã€‚\nMap # æ¥è‘—ä»‹ç´¹ eBPF çš„å¦å¤–ä¸€å€‹é‡è¦çµ„ä»¶ mapï¼Œå‰é¢æåˆ° trace_printk åªé©åˆç”¨åœ¨é™¤éŒ¯éšæ®µï¼Œè¼¸å‡º eBPF çš„åŸ·è¡Œè³‡è¨Šåˆ° user spaceï¼Œç„¶è€Œæˆ‘å€‘éœ€è¦ä¸€å€‹å¯ä»¥åœ¨æ­£å¼ç’°å¢ƒå…§ï¼Œæä¾› user space ç¨‹å¼å’Œ eBPF ç¨‹å¼ä¹‹é–“é›™å‘æ•¸æ“šäº¤æ›çš„èƒ½åŠ›ï¼Œå¦å¤–æ¯æ¬¡è§¸ç™¼ eBPF ç¨‹å¼éƒ½å¯çœ‹ä½œç¨ç«‹åŸ·è¡Œ eBPF ç¨‹å¼ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦åœ¨å¤šæ¬¡å‘¼å« eBPF ç¨‹å¼æ™‚å…±äº«è³‡æ–™çš„åŠŸèƒ½ã€‚å› æ­¤ eBPF ç¨‹å¼å¼•å…¥äº† mapã€‚\neBPF map å®šç¾©äº†ä¸€ç³»åˆ—ä¸åŒçš„ä¸åŒçš„è³‡æ–™çµæ§‹é¡å‹ï¼ŒåŒ…å«äº† hash, array, LRU hash, ring buffer, queue ç­‰ç­‰ï¼Œå¦å¤–ä¹Ÿæä¾› per-cpu hash, per-cpu array ç­‰è³‡æ–™çµæ§‹ï¼Œç”±æ–¼æ¯é¡† CPU å¯ä»¥ç²å¾—ç¨ç«‹çš„ mapï¼Œå› æ­¤å¯ä»¥æ¸›å°‘ lock çš„éœ€æ±‚ï¼Œæé«˜åŸ·è¡Œæ•ˆèƒ½ã€‚æ‰€æœ‰çš„ map type ä¸€æ¨£å¯ä»¥åƒè€ƒ bpf.h çš„ enum bpf_map_typeã€‚\nstruct bpf_map_def SEC (\u0026#34;maps\u0026#34;) map = { .type = BPF_MAP_TYPE_ARRAY, .key_size = sizeof (int), .value_size = sizeof (__u32), .max_entries = 4096, }; é¦–å…ˆè¦å…ˆåœ¨ eBPF ç¨‹å¼å…§å®šç¾© map çš„è³‡æ–™çµæ§‹ï¼Œåœ¨ eBPF ç¨‹å¼å…§å®šç¾©ä¸€å€‹ map æ™‚ï¼ŒåŸºæœ¬éœ€è¦å®šç¾©å››å€‹æ±è¥¿åˆ†åˆ¥æ˜¯è©²è³‡æ–™çµæ§‹çš„ map type, key å’Œ value çš„å¤§å°ä»¥åŠè³‡æ–™çµæ§‹å…§æœ€å¤šæœ‰å«å¤šå°‘ entryï¼Œå¦‚æœè¶…å‡º max_entries ä¸Šé™å‰‡æœƒç™¼ç”ŸéŒ¯èª¤å›å‚³ (-E2BIG)ã€‚\neBPF æä¾›äº† bpf_map_lookup_elem, bpf_map_update_elem, bpf_map_delete_elem ç­‰ helper functions ä¾†å° map è³‡æ–™åšæ“ä½œã€‚lookup çš„å®Œæ•´å®šç¾©æ˜¯ void *bpf_map_lookup_elem (struct bpf_map *map, const void *key)ï¼Œé€é key å»å°‹æ‰¾ map è£¡é¢å°æ‡‰çš„ valueï¼Œä¸¦è¿”å›å…¶æŒ‡æ¨™ï¼Œç”±æ–¼è¿”å›çš„æ˜¯æŒ‡æ¨™ï¼Œæ‰€ä»¥æœƒæŒ‡å‘ map çœŸå¯¦å„²å­˜çš„è¨˜æ†¶é«”ï¼Œå¯ä»¥ç›´æ¥å°å…¶å€¼é€²è¡Œæ›´æ–°ã€‚\nç•¶ç„¶é™¤äº†å¹¾å€‹åŸºæœ¬çš„ helper function å¤–ï¼Œä¸åŒçš„ map type å¯èƒ½æœƒæ”¯æ´æ›´å¤šçš„æ“ä½œæˆ–åŠŸèƒ½ï¼Œä¾‹å¦‚ bpf_skb_under_cgroup æ˜¯çµ¦ BPF_MAP_TYPE_CGROUP_ARRAY å°ˆç”¨çš„ã€‚\nåŸå§‹ç¢¼è§£æ # linux kernel å®šç¾©äº† struct bpf_map_opsï¼Œä¾†æè¿° map å¯èƒ½æœƒæ”¯æ´çš„æ‰€æœ‰åŠŸèƒ½ã€‚\nstruct bpf_map_ops { /* funcs callable from userspace (via syscall) */ int (*map_alloc_check)(union bpf_attr *attr); struct bpf_map *(*map_alloc)(union bpf_attr *attr); void (*map_release)(struct bpf_map *map, struct file *map_file); void (*map_free)(struct bpf_map *map); int (*map_get_next_key)(struct bpf_map *map, void *key, void *next_key); void (*map_release_uref)(struct bpf_map *map); void *(*map_lookup_elem_sys_only)(struct bpf_map *map, void *key); ... } ä¸åŒçš„ map å†æ ¹æ“šéœ€è¦å»å¯¦ä½œå°æ‡‰çš„æ“ä½œï¼Œåœ¨ include/linux/bpf_types.h å®šç¾©ã€‚ä»¥ BPF_MAP_TYPE_QUEUE é€™å€‹ map type ä¾†èªªå°æ‡‰åˆ° queue_map_opsã€‚\n//kernel/bpf/queue_stack_maps.c const struct bpf_map_ops queue_map_ops = { .map_meta_equal = bpf_map_meta_equal, .map_alloc_check = queue_stack_map_alloc_check, .map_alloc = queue_stack_map_alloc, .map_free = queue_stack_map_free, .map_lookup_elem = queue_stack_map_lookup_elem, .map_update_elem = queue_stack_map_update_elem, .map_delete_elem = queue_stack_map_delete_elem, .map_push_elem = queue_stack_map_push_elem, .map_pop_elem = queue_map_pop_elem, .map_peek_elem = queue_map_peek_elem, .map_get_next_key = queue_stack_map_get_next_key, .map_btf_name = \u0026#34;bpf_queue_stack\u0026#34;, .map_btf_id = \u0026amp;queue_map_btf_id, }; ç•¶å‘¼å« bpf_map_push_elem æ™‚ï¼Œå°±æœƒå‘¼å« bpf_map_ops.map_push_elem ä¾†èª¿ç”¨ queue çš„ queue_stack_map_push_elem å®Œæˆã€‚\nè€Œå…·é«”æ¯å€‹ map æ”¯æ´ä»€éº¼ help function å¯èƒ½å°±è¦åƒè€ƒ helper function æ–‡ä»¶æè¿°\nä½¿ç”¨ç¯„ä¾‹ # é€™é‚Šæˆ‘å€‘ä¸€å€‹ç‰¹åˆ¥çš„ä½¿ç”¨å¯¦ä¾‹ä¾†çœ‹\nstruct elem { int cnt; struct bpf_spin_lock lock; }; struct bpf_map_def SEC(\u0026#34;maps\u0026#34;) counter = { .type = BPF_MAP_TYPE_ARRAY, .key_size = sizeof(int), .value_size = sizeof(elem), .max_entries = 1, }; é¦–å…ˆæˆ‘å€‘å®šç¾©äº†ä¸€å€‹ç‰¹åˆ¥çš„ ARRAY mapï¼Œå®ƒçš„ array size åªæœ‰ 1ï¼Œç„¶å¾Œ value æ˜¯ä¸€å€‹åŒ…å« u32 æ•´æ•¸å’Œä¸€å€‹ lock çš„è³‡æ–™çµæ§‹ã€‚\nSEC (\u0026#34;kprobe/sys_clone\u0026#34;) int hello_world(void *ctx) { u32 key = 0; elem *val; val = bpf_map_lookup_elem (\u0026amp;counter, \u0026amp;key); bpf_spin_lock (\u0026amp;val-\u0026gt;lock); val-\u0026gt;cnt++; bpf_spin_unlock (\u0026amp;val-\u0026gt;lock); bpf_trace_printk (\u0026#34;sys_clone count: % d\u0026#34;, val-\u0026gt;cnt); return 0; } ç”±æ–¼ key æˆ‘å€‘å›ºå®šæ˜¯ 0ï¼Œé€é bpf_map_lookup_elem æˆ‘å€‘æ°¸é æœƒå–å¾—åŒä¸€ç­†è³‡æ–™ï¼Œå› æ­¤å¯ä»¥ç°¡å–®çœ‹æˆæˆ‘å€‘æŠŠ counter ç•¶ä½œä¸€å€‹å–®ä¸€çš„å®¹å™¨ä¾†å­˜æ”¾ cnt è®Šæ•¸ï¼Œä¸¦ä½¿ç”¨ lock é¿å… cnt æ›´æ–°æ™‚çš„ race conditionã€‚\næˆ‘å€‘å°‡é€™å€‹ç¨‹å¼é™„åŠ åˆ° kprobe/sys_cloneï¼Œå°±å¯ä»¥ç”¨ä¾†çµ±è¨ˆ sys_clone å‘¼å«çš„æ¬¡æ•¸ã€‚\nå’Œå…¶ä»– eBPF çš„æ“ä½œä¸€æ¨£ï¼Œæˆ‘å€‘é€é bpf çš„ system call å»èˆ‡ kernel é€²è¡Œæºé€šã€‚è·Ÿ helper fuction é¡ä¼¼ï¼Œbpf systemcall æä¾›äº† BPF_MAP_LOOKUP_ELEM, BPF_MAP_UPDATE_ELEM, BPF_MAP_DELETE_ELEM ç­‰åƒæ•¸ä¾†æä¾›æœå°‹ã€æ›´æ–°ã€åˆªé™¤ map æ•¸å€¼çš„æ–¹æ³•ã€‚å¦å¤–ç‚ºäº†æ¸›å°‘ system call çš„é–‹éŠ·ï¼Œä¹Ÿæä¾› BPF_MAP_LOOKUP_BATCH, BPF_MAP_LOOKUP_AND_DELETE_BATCH, BPF_MAP_UPDATE_BATCH, BPF_MAP_DELETE_BATCH ç­‰æ–¹æ³•ä¾†åœ¨å–®æ¬¡ system call å…§å®Œæˆå¤šæ¬¡ map æ“ä½œã€‚\nå¿…è¦è¦æ³¨æ„çš„æ˜¯ map ä¸¦ä¸æ˜¯ eBPF program çš„é™„å±¬å“ï¼Œåœ¨ eBPF è™›æ“¬æ©Ÿå…§ï¼Œmap å’Œ program ä¸€æ¨£æ˜¯ç¨ç«‹çš„ç‰©ä»¶ï¼Œæ¯å€‹ map æœ‰è‡ªå·±çš„ refcnt å’Œç”Ÿå‘½é€±æœŸï¼ŒeBPF ç¨‹å¼çš„ç”Ÿå‘½é€±æœŸå’Œ map ä¸ä¸€å®šæ˜¯çµ±ä¸€çš„ã€‚\nmap è¼‰å…¥æµç¨‹ # åœ¨é€éå‡½å¼åº«å°‡ eBPF ç¨‹å¼è¼‰å…¥ kernel æ™‚ï¼Œå…ˆåšçš„å…¶å¯¦æ˜¯å»ºç«‹ mapï¼Œå°æ¯å¼µ map æœƒå‘¼å« bpf system call çš„ BPF_MAP_CREATEï¼Œä¸¦å¸¶å…¥ map type, key size, value size, max entries, flags ç­‰è³‡è¨Šä¾†å»ºç«‹ mapï¼Œå»ºç«‹å®Œæˆå¾Œæœƒè¿”å› map å°æ‡‰çš„ fire descripterã€‚\næ¥è‘—å‡½æ•¸åº«æœƒä¿®æ”¹ç·¨è­¯éçš„ ebpf bytecode è£¡é¢åƒè€ƒåˆ° map è®Šæ•¸çš„åœ°æ–¹ (ä¾‹å¦‚ lookup ç­‰ helper function çš„åƒæ•¸éƒ¨åˆ†)ï¼Œå°‡åŸå…ˆæµç©ºçš„ map åœ°å€ä¿®æ”¹æˆ map å°æ‡‰çš„ file descripterã€‚\næ¥è‘—ä¸€æ¨£å‘¼å« bpf BPF_PROG_LOAD ä¾†è¼‰å…¥ eBPF bytecodeï¼Œåœ¨è¼‰å…¥éç¨‹ä¸­ï¼Œverifier æœƒå‘¼å«åˆ° replace_map_fd_with_map_ptr å‡½æ•¸ï¼Œå°‡ bytecode è£¡é¢ map çš„ file descripter åœ¨æ›¿æ›æˆ map çš„å¯¦éš›åœ°å€ã€‚\nMap æŒä¹…åŒ– # å¦‚å‰é¢æ‰€è¿°ï¼Œmap åœ¨ eBPF è™›æ“¬æ©Ÿå…§å’Œ prog åŒç­‰æ˜¯ç¨ç«‹çš„å­˜åœ¨ï¼Œä¸¦ä¸”å…·æœ‰è‡ªå·±çš„ refcntï¼Œå› æ­¤å’Œ prog ä¸€æ¨£ï¼Œæˆ‘å€‘å¯ä»¥é€é bpf BPF_OBJ_PIN å°‡ map é‡˜åˆ° BPFFS çš„ /sys/fs/bpf/ è·¯å¾‘ä¸‹ï¼Œå…¶ä»–ç¨‹å¼å°±ä¸€æ¨£èƒ½é€é open file çš„æ–¹å¼å–å¾— map çš„ file descripterï¼Œå°‡ map è¼‰å…¥åˆ°å…¶ä»–çš„ eBPF ç¨‹å¼å…§ï¼Œé”æˆäº†å¤šå€‹ eBPF ç¨‹å¼ share åŒä¸€å€‹ map çš„æ•ˆæœã€‚\nTail call # æœ€å¾Œæˆ‘å€‘è¦ä¾†èŠçš„æ˜¯ tail call çš„åŠŸèƒ½ã€‚\ntail call ç°¡å–®ä¾†èªªå°±æ˜¯åœ¨ eBPF ç¨‹å¼å…§åŸ·è¡Œå¦å¤–ä¸€å€‹ eBPF ç¨‹å¼ï¼Œä¸éå’Œä¸€èˆ¬çš„å‡½æ•¸å‘¼å«ä¸ä¸€æ¨£ï¼ŒeBPF è™›æ“¬æ©Ÿåœ¨è·³è½‰åˆ°å¦å¤–ä¸€å€‹ eBPF ç¨‹å¼å¾Œå°±ä¸æœƒå†å›åˆ°å‰ä¸€å€‹ç¨‹å¼äº†ï¼Œæ‰€ä»¥ä»–æ˜¯ä¸€å€‹å–®å‘çš„å‘¼å«ã€‚\nå¦å¤–é›–ç„¶ä»–æœƒç›´æ¥è¤‡ç”¨å‰ä¸€å€‹ eBPF ç¨‹å¼çš„ stack frameï¼Œä½†æ˜¯è¢«å‘¼å«çš„ eBPF ç¨‹å¼ä¸èƒ½å¤ å­˜å–å‰å‘¼å«è€…çš„æš«å­˜å™¨å’Œ stackï¼Œåªèƒ½é€å–å¾—åœ¨å‘¼å« tail call æ™‚ï¼Œé€éåƒæ•¸å‚³éçš„ ctxã€‚\nä½¿ç”¨ tail call å¯ä»¥é€éæ‹†è§£ç°¡åŒ–ä¸€å€‹ eBPF ç¨‹å¼ï¼Œæ‰“ç ´å–®å€‹ eBPF ç¨‹å¼åªèƒ½æœ‰ 512bytes çš„ stackã€1 million å€‹æŒ‡ä»¤çš„é™åˆ¶ã€‚\nä¸€å€‹ä½¿ç”¨ç¯„ä¾‹æ˜¯å…ˆä½¿ç”¨ä¸€å€‹ eBPF ç¨‹å¼ä½œç‚º packet dispatcherï¼Œç„¶å¾Œæ ¹æ“šä¸åŒçš„ packet ether type ä¹‹é¡çš„æ¬„ä½ï¼Œå°‡ packet è½‰ç™¼çµ¦å°æ‡‰è™•ç†çš„ eBPF ç¨‹å¼ã€‚\nå¦å¤–ä¸€å€‹å°±æ˜¯å°‡ eBPF ç¨‹å¼è¦–ç‚ºå¤šå€‹æ¨¡çµ„ï¼Œé€é map å’Œ tail call å»å‹•æ…‹çš„ä»»æ„é‡æ•´æ’åºåŸ·è¡Œçµæ§‹ã€‚\nç‚ºäº†é¿å… eBPF ç¨‹å¼äº¤æ›¿å‘¼å«å½¼æ­¤å°è‡´å¡æ­»çš„ç‹€æ³ï¼Œkernel å®šç¾©äº† MAX_TAIL_CALL_CNT è¡¨ç¤ºåœ¨å–®å€‹ context ä¸‹æœ€å¤šå¯å‘¼å«çš„ tail call æ¬¡æ•¸ï¼Œç›®å‰æ˜¯ 32ã€‚å¦‚æœ tail call å› ç‚ºä»»ä½•åŸå› è€ŒåŸ·è¡Œå¤±æ•—ï¼Œå‰‡æœƒç¹¼çºŒåŸ·è¡ŒåŸæœ¬çš„ eBPF ç¨‹å¼ã€‚\nå¦‚ä½•ä½¿ç”¨ # tail call çš„ helper function å®šç¾©å¦‚ä¸‹ long bpf_tail_call (void *ctx, struct bpf_map *prog_array_map, u32 index)ã€‚åœ¨ä½¿ç”¨çš„æ™‚å€™æˆ‘å€‘è¦ä¸€å€‹ BPF_MAP_TYPE_PROG_ARRAY type çš„ mapï¼Œç”¨ä¾†ä¿å­˜ä¸€å€‹ eBPF program file descriptor çš„é™£åˆ—ã€‚åœ¨å‘¼å« tail call çš„æ™‚å€™å‚³éé€²å»åŸ·è¡Œã€‚\nåƒè€ƒè³‡æ–™ # BPF: A Tour of Program Types BPF ç¨‹åºï¼ˆBPF Progï¼‰ç±»å‹è¯¦è§£ Lifetime of BPF objects difference between loading, attaching, and linking? eBPF map BPF Map å†…æ ¸å®ç° BPF ç¯å½¢ç¼“å†²åŒº BPF æŠ€æœ¯ä»‹ç»åŠå­¦ä¹ åˆ†äº« æ­ç§˜ BPF map å‰ç”Ÿä»Šä¸– BPF æ•°æ®ä¼ é€’çš„æ¡¥æ¢ â€”â€”BPF MAPï¼ˆä¸€ï¼‰ bpf-helpers man page introduce bpf_tail_call () helper å¾ BPF to BPF Calls åˆ° Tail Calls ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-2-basic-concept/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 2 - åŸºæœ¬æ¦‚å¿µ","type":"posts"},{"content":"BPF Compiler Collection (BCC) æ˜¯ä¸€å¥—ç”¨æ–¼ eBPFï¼Œç”¨ä¾†æœ‰æ•ˆé–‹ç™¼ kernel è¿½è¹¤ä¿®æ”¹ç¨‹å¼çš„å·¥å…·é›†ã€‚\nä»‹ç´¹ # BCC æˆ‘è¦ºå¾—å¯ä»¥çœ‹æˆå…©å€‹éƒ¨åˆ†ï¼š\neBPF çš„ python å’Œ lua çš„å‰ç«¯ï¼Œé€é BCC æˆ‘å€‘å¯ä»¥ä½¿ç”¨ python å’Œ lua æ¯”è¼ƒç°¡å–®çš„é–‹ç™¼ eBPF çš„æ‡‰ç”¨ç¨‹å¼ï¼ŒBCC å°‡ bpf system call é‚„æœ‰ eBPC ç¨‹å¼ç·¨è­¯å°è£æˆäº† APIï¼Œä¸¦æä¾›ä¸€ç³»åˆ—é å…ˆå®šç¾©å¥½çš„å·¨é›†å’Œèªæ³•ä¾†ç°¡åŒ– eBPF ç¨‹å¼ã€‚ from bcc import BPF b = BPF (text = \u0026#34;\u0026#34;\u0026#34; #include \u0026lt;uapi/linux/bpf.h\u0026gt; int xdp_prog1 (struct xdp_md *ctx) { return XDP_DROP; } \u0026#34;\u0026#34;\u0026#34; fn = b.load_func (\u0026#34;xdp_prog1\u0026#34;, BPF.XDP) b.attach_xdp (\u0026#34;eth0\u0026#34;, fn, 0) ä»¥ä¸Šé¢çš„ç¯„ä¾‹ä¾†èªªï¼Œé€é BPF ç‰©ä»¶å¯¦ç«‹åŒ–æ™‚æœƒå®Œæˆ eBPC bytecode çš„ç·¨è­¯ï¼Œç„¶å¾Œé€é load_func å’Œ attach_xdp å°±å¯ä»¥å¾ˆç°¡å–®çš„å°‡ä¸Šé¢çš„ eBPF ç¨‹å¼ç¢¼ç·¨è­¯è¼‰å…¥åˆ° kernel ç„¶å¾Œ attach åˆ° xdp çš„ hook point ä¸Šã€‚\nä¸€ç³»åˆ—ä½¿ç”¨è‡ªèº«æ¡†æ¶é–‹ç™¼çš„å·¥å…·\nBCC ä½¿ç”¨è‡ªå·±çš„ API é–‹ç™¼äº†ä¸€ç³»åˆ—å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ç¾æˆ bcc eBPF ç¨‹å¼ï¼Œæœ¬èº«å°±å¹¾ä¹æ¶µè“‹äº† eBPF çš„æ‰€æœ‰ program typeï¼Œå¯ä»¥é–‹ç®±å³ç”¨ï¼Œç›´æ¥è·³é eBPF çš„é–‹ç™¼ã€‚\nä¸‹åœ–åŒ…å«äº† BCC å° linux kernel å„å€‹æ¨¡çµ„å¯¦ç¾çš„å·¥å…·åç¨±\neBPC æœ¬èº«å’Œ bcc ç›¸é—œçš„é–‹ç™¼æ–‡ä»¶ä»¥åŠç¯„ä¾‹ç¨‹å¼\nå¯ä»¥çœ‹åˆ°å‰é¢å¾ˆå¤šå¤©æœ‰åƒè€ƒåˆ° BCC çš„æ–‡ä»¶ï¼Œè³‡æ–™éå¸¸åœ°è±å¯Œ\nå®‰è£ # é¦–å…ˆ bcc çš„å®‰è£å¤§æ¦‚æœ‰å¹¾ç¨®æ–¹å¼\né€éå„å¤§ç™¼è¡Œæ¿çš„å¥—ä»¶ç®¡ç†å·¥å…·å®‰è£ ç›´æ¥ä½¿ç”¨åŸå§‹ç¢¼ç·¨è­¯å®‰è£ é€é docker image åŸ·è¡Œå°æ–¼å‰å…©è‘—ï¼Œbcc å®˜æ–¹çš„æ–‡ä»¶åˆ—èˆ‰äº†éœ€å¤šç™¼è¡Œç‰ˆçš„ å®‰è£æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå®¹æ˜“åœ°ç…§è‘—å®˜æ–¹æ–‡ä»¶å®‰è£ã€‚ä»¥ ubuntu ä¾†èªªï¼Œå¯ä»¥é€é Universe æˆ– iovisor çš„ repo å®‰è£ã€‚ç„¶è€Œå¿…é ˆè¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰ iovisor å’Œ universe ä¸Šé¢çš„ bcc å¥—ä»¶æœ¬çš„éƒ½æ¯”è¼ƒé™³èˆŠï¼Œç”šè‡³æ²’æœ‰ 20.04 å’Œ 22.04 å°æ‡‰çš„å®‰è£æºï¼Œå› æ­¤é€é apt å®‰è£å¯èƒ½æœƒå‡ºç¾ç‰ˆæœ¬ä¸æ”¯æ´æˆ–å®‰è£å¾Œé€£ç¯„ä¾‹éƒ½è·‘ä¸èµ·ä¾†çš„å•é¡Œã€‚ # use Universe # add-apt-repository universe # iovisor sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD echo \u0026#34;deb [trusted=yes] https://repo.iovisor.org/apt/xenial xenial-nightly main\u0026#34; | sudo tee /etc/apt/sources.list.d/iovisor.list sudo apt-get update sudo apt-get install bcc-tools libbcc-examples linux-headers-$(uname -r) å› æ­¤ç‰¹åˆ¥å»ºè­°é€éåŸå§‹ç¢¼ä¾†å®‰è£æœƒæ˜¯æ¯”è¼ƒç©©å¦¥çš„æ–¹å¼ã€‚ä¸€æ¨£åœ¨ bcc çš„çš„ å®‰è£æ–‡æª”Â è©³ç´°åˆ—èˆ‰äº†åœ¨å„å€‹ç™¼è¡Œç‰ˆæœ¬çš„å„å€‹ç‰ˆæœ¬ä¸‹ï¼Œè¦æ€éº¼å»å®‰è£ç›¸ä¾å¥—ä»¶ï¼Œç„¶å¾Œç·¨è­¯å®‰è£ bccã€‚\nsudo apt install -y bison build-essential cmake flex git libedit-dev \\ libllvm12 llvm-12-dev libclang-12-dev python zlib1g-dev libelf-dev libfl-dev python3-distutils git clone https://github.com/iovisor/bcc.git mkdir bcc/build; cd bcc/build cmake .. make sudo make install cmake -DPYTHON_CMD=python3 .. # build python3 binding pushd src/python/ make sudo make install popd é€™é‚ŠåŒæ¨£ä»¥ ubuntu èˆ‰ä¾‹ï¼Œé¦–å…ˆå› ç‚º BCC å¾Œç«¯é‚„æ˜¯ä½¿ç”¨ LLVMï¼Œå› æ­¤éœ€è¦å…ˆå®‰è£ llvm ä»¥åŠ bcc ç·¨è­¯éœ€è¦çš„ cmake ç­‰å·¥å…·ï¼Œç„¶å¾Œå¾Œé cmake ç·¨è­¯å®‰è£ã€‚\nå®‰è£å®Œæˆå¾Œï¼Œæ˜¨å¤©æåˆ°çš„ bcc è‡ªå·±å¯«å¥½çš„ kernel trace tools æœƒè¢«å®‰è£åˆ° /usr/share/bcc/toolsï¼Œå› æ­¤å¯ä»¥ç›´æ¥ cd åˆ°è©²ç›®éŒ„ä¾†ç©ï¼Œç”±æ–¼é€™äº› tools å…¶å¯¦å°±æ˜¯ python scriptï¼Œæ‰€ä»¥å…¶å¯¦ä¹Ÿå¯ä»¥ç›´æ¥é€é python3 åŸ·è¡Œ bcc repo ä¸‹ tools ç›®éŒ„å…§çš„ python æª”ï¼Œå…¶çµæœå…¶å¯¦æ˜¯ä¸€æ¨£çš„ã€‚\nåŒæ¨£çš„é‚„æœ‰ examples é€™å€‹è³‡æ–™å¤¾ä¸‹çš„ç¯„ä¾‹ä¹Ÿæœƒè¢«å®‰è£åˆ° /usr/share/bcc/examplesÂ ç›®éŒ„ä¸‹ã€‚\næœ€å¾Œæ˜¯é€é docker çš„æ–¹å¼åŸ·è¡Œ bccã€‚åŒæ¨£åƒè€ƒ bcc çš„ quickstartÂ æ–‡ä»¶ï¼Œä¸éåŠ ä¸Š --pid=host\ndocker run -it --rm \\ --pid=host \\ --privileged \\ -v /lib/modules:/lib/modules:ro \\ -v /usr/src:/usr/src:ro \\ -v /etc/localtime:/etc/localtime:ro \\ --workdir /usr/share/bcc/tools \\ zlim/bcc ä½†æ˜¯ä¸è«–æ˜¯ç›´æ¥ä½¿ç”¨ zlim/bccÂ é‚„æ˜¯é€é bcc repo å…§çš„ dockerfile è‡ªè¡Œç·¨è­¯ï¼Œç›®å‰æ¸¬è©¦èµ·ä¾†é‚„æ˜¯æœ‰è¨±å¤šå•é¡Œï¼Œä½¿ç”¨ zlim/bcc åœ¨åŸ·è¡Œéƒ¨åˆ†çš„ eBPF ç¨‹å¼æ™‚æœƒç·¨è­¯å¤±æ•—ï¼Œç›´æ¥é€é dockerfile ç·¨è­¯åˆæ­¥æ¸¬è©¦ä¹Ÿæ²’è¾¦æ³• build æˆåŠŸï¼Œå› æ­¤ç›®å‰è‡ªè¡Œç·¨è­¯ä½¿ç”¨å¯èƒ½é‚„æ˜¯ç›¸å°æ¯”è¼ƒç©©å®šç°¡å–®å¿«é€Ÿçš„æ–¹å¼ã€‚\n","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-3-introduction-to-bcc/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 3 - BCC ä»‹ç´¹","type":"posts"},{"content":"æˆ‘å€‘è¦ä¾†çœ‹ BCC çš„ tools/tcpconnect.pyÂ é€™æ”¯ç¨‹å¼ã€‚åŸå§‹ç¢¼åœ¨ é€™é‚Šã€‚\ntcpconnect ä»‹ç´¹ # é€™éš»ç¨‹å¼æœƒè¿½è¹¤ç´€éŒ„ kernel ç™¼èµ·çš„ TCP é€£ç·šï¼Œå¯ä»¥çœ‹åˆ°ç™¼èµ·é€£ç·šçš„ pid, æŒ‡ä»¤åç¨±ï¼Œip version, IP åœ°å€å’Œç›®æ¨™ port ç­‰è³‡è¨Šã€‚\nåŸ·è¡Œçµæœå¦‚ä¸‹ï¼š\npython3 tools/tcpconnect Tracing connect ... Hit Ctrl-C to end PID COMM IP SADDR DADDR DPORT 2553 ssh 4 10.0.2.15 10.0.2.1 22 2555 wget 4 10.0.2.15 172.217.160.100 80 tcpconnect å¯¦ä½œ # é¦–å…ˆé€é argparseÂ å®šç¾©äº†æŒ‡ä»¤çš„åƒæ•¸è¼¸å…¥ï¼Œä¸»è¦æ˜¯æä¾› filter çš„é¸é …ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é€é pid, uid, namespace ç­‰åƒæ•¸å» filter é€£ç·šç´€éŒ„ã€‚\nparser = argparse.ArgumentParser ( description=\u0026#34;Trace TCP connects\u0026#34;, formatter_class=argparse.RawDescriptionHelpFormatter, epilog=examples) parser.add_argument (\u0026#34;-p\u0026#34;, \u0026#34;--pid\u0026#34;, help=\u0026#34;trace this PID only\u0026#34;) ... args = parser.parse_args () æ¥è‘—å°±ä¾†åˆ°ä¸»è¦çš„ eBPF ç¨‹å¼ç¢¼çš„å®šç¾©\nbpf_text = \u0026#34;\u0026#34;\u0026#34; #include \u0026lt;uapi/linux/ptrace.h\u0026gt; #include \u0026lt;net/sock.h\u0026gt; #include \u0026lt;bcc/proto.h\u0026gt; BPF_HASH (currsock, u32, struct sock *); ... é¦–å…ˆå¯ä»¥çœ‹åˆ° BPF_HASHï¼Œé€™æ˜¯ BCC æä¾›çš„ä¸€å€‹å·¨é›†ï¼Œç”¨ä¾†å®šä¸€å€‹ hash type çš„ mapï¼Œå°æ–¼ä¸åŒ map type BCC éƒ½å®šç¾©äº†å°æ‡‰çš„å·¨é›†ä¾†å»ºç«‹ mapã€‚å…·é«”åˆ—è¡¨å¯ä»¥åƒè€ƒ é€™é‚Šã€‚ç¬¬ä¸€å€‹åƒæ•¸æ˜¯ map çš„åç¨±ï¼Œé€™é‚Šå«åš currsockï¼ŒåŒæ™‚é€™å€‹è®Šæ•¸ä¹Ÿç”¨æ–¼å¾ŒçºŒç¨‹å¼ç¢¼ä¸­å° map çš„åƒè€ƒå’Œ API å‘¼å«ï¼Œä¾‹å¦‚ currsock.lookup (\u0026amp;tid);Â å°±æ˜¯å° currsock é€™å€‹ map é€²è¡Œ lookup æ“ä½œã€‚æ¥è‘—å…©å€‹æ¬„ä½åˆ†åˆ¥å°æ‡‰ key å’Œ value çš„ typeï¼Œkey æ˜¯ä¸€å€‹ 32 ä½å…ƒæ•´æ•¸ï¼Œvalue å‰‡å°æ‡‰åˆ° sock struct æŒ‡æ¨™ã€‚sock çµæ§‹åœ¨ net/sock.hÂ å…§å®šç¾©ï¼Œæ˜¯ linux kernel ç”¨ä¾†ç¶­è­· socket çš„è³‡æ–™çµæ§‹ã€‚\nstruct ipv4_data_t { u64 ts_us; u32 pid; u32 uid; u32 saddr; u32 daddr; u64 ip; u16 lport; u16 dport; char task [TASK_COMM_LEN]; }; BPF_PERF_OUTPUT (ipv4_events); struct ipv6_data_t { ... æ¥è‘—åˆ†åˆ¥é‡å° ipv4 å’Œ ipv6 å®šç¾©äº†ä¸€å€‹ data_t çš„è³‡æ–™çµæ§‹ï¼Œç”¨æ–¼ bpf å’Œ userspace client ä¹‹é–“å‚³è¼¸ tcp connect çš„è³‡è¨Šç”¨ã€‚\né€™é‚Šå¯ä»¥çœ‹åˆ°å¦å¤–ä¸€å€‹ç‰¹åˆ¥çš„å·¨é›† BPF_PERF_OUTPUTã€‚é€™é‚Šç”¨åˆ°äº† eBPF æä¾›çš„ perf event æ©Ÿåˆ¶ï¼Œå®šç¾©äº†ä¸€å€‹ per-CPU çš„ event ring bufferï¼Œä¸¦æä¾›äº†å°æ‡‰çš„ bpf_perf_event_output helper function ä¾†æŠŠè³‡æ–™æ¨é€² ring buffer çµ¦ userspace å­˜å–ã€‚åœ¨ bcc é€™é‚Šå‰‡ä½¿ç”¨ ipv4_events.perf_submit (ctx, \u0026amp;data, sizeof (data));Â çš„ API ä¾†å‚³è¼¸è³‡æ–™ã€‚\n//separate flow keys per address family struct ipv4_flow_key_t { u32 saddr; u32 daddr; u16 dport; }; BPF_HASH (ipv4_count, struct ipv4_flow_key_t); æ¥è‘—åˆæ˜¯ä¸€å€‹ HASH mapï¼Œtcpdconnect æä¾›ä¸€å€‹åŠŸèƒ½é¸é …æ˜¯çµ±è¨ˆå„ç¨® connection çš„æ¬¡æ•¸ï¼Œæ‰€ä»¥é€™é‚Šå®šç¾©äº†ä¸€å€‹ ipv4_flow_key_t ç•¶ä½œ key ä¾†ä½œç‚ºçµ±è¨ˆä¾æ“šï¼ŒBPF_HASHÂ åœ¨é è¨­æƒ…æ³ä¸‹ value çš„ type æ˜¯ u64ï¼Œä¸€å€‹ 64 ä½å…ƒç„¡è™Ÿæ•´æ•¸ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ‹¿ä¾†çµ±è¨ˆã€‚\næ¥è‘—å°±ä¾†åˆ°äº† bpf å‡½æ•¸ä¸»é«”ï¼Œé€™å€‹å‡½æ•¸æœƒè¢« attach åˆ° tcp_v4_connect å’Œ tcp_v6_connect çš„ kprobe ä¸Šï¼Œç•¶å‘¼å« tcp_v4_connect å’Œ tcp_v6_connect æ™‚è¢«è§¸ç™¼ã€‚\nint trace_connect_entry(struct pt_regs *ctx, struct sock *sk) { if (container_should_be_filtered ()) { return 0; } u64 pid_tgid = bpf_get_current_pid_tgid (); u32 pid = pid_tgid \u0026gt;\u0026gt; 32; u32 tid = pid_tgid; FILTER_PID u32 uid = bpf_get_current_uid_gid (); FILTER_UID //stash the sock ptr for lookup on return currsock.update (\u0026amp;tid, \u0026amp;sk); return 0; }; é¦–å…ˆå®ƒæ¥æ”¶çš„åƒæ•¸æ˜¯ pt_regs çµæ§‹å’Œ tcp_v4_connect çš„åƒæ•¸ï¼Œpt_regs åŒ…å«äº† CPU ä½”å­˜å™¨çš„æ•¸å€¼è³‡è¨Šï¼Œä½œç‚º eBPF çš„ä¸Šä¸‹æ–‡ã€‚å¾Œé¢ tcp_v4_connect çš„ç¬¬ä¸€å€‹åƒæ•¸ sock çµæ§‹å°æ‡‰åˆ°ç•¶æ¬¡é€£ç·šçš„ socket è³‡è¨Šï¼Œç”±æ–¼å¾Œé¢å¹¾å€‹åƒæ•¸ä¸æœƒä½¿ç”¨åˆ°æ‰€ä»¥å¯ä»¥çœç•¥æ‰ã€‚\n./tcpconnect --cgroupmap mappath # only trace cgroups in this BPF map ./tcpconnect --mntnsmap mappath # only trace mount namespaces in the map é¦–å…ˆå‘¼å«çš„æ˜¯ container_should_be_filteredã€‚åœ¨ argparser ä¸­å®šç¾©äº†å…©å€‹åƒæ•¸ cgroupmap å’Œ mntnsmap ç”¨ä¾†é‡å°ç‰¹å®šçš„ cgroups æˆ– mount namespaceã€‚container_should_be_filteredÂ å‰‡æœƒè² è²¬é€™å…©é …çš„æª¢æŸ¥ã€‚\nä¸€é–‹å§‹çœ‹å¯èƒ½æœƒç™¼ç¾åœ¨ eBPF ç¨‹å¼è£¡é¢æ‰¾ä¸åˆ°é€™å€‹å‡½æ•¸å®šçš„å®šç¾©ï¼Œç”±æ–¼é€™å…©å€‹ filter éå¸¸å¸¸ç”¨å› æ­¤ bcc å®šç¾©äº† bcc.containers.filter_by_containerså‡½æ•¸ï¼Œåœ¨ python ç¨‹å¼ç¢¼è£¡é¢æœƒçœ‹åˆ°ï¼Œbpf_text = filter_by_containers (args) + bpf_textã€‚ä»¥ cgroup ä¾†èªªï¼Œå¦‚æœä½¿ç”¨è€…æœ‰æä¾› cgroupmapÂ é€™å€‹åƒæ•¸ï¼Œfilter_by_containersÂ æœƒåœ¨ mappath é€é BPF_TABLE_PINNEDÂ åœ¨ BPFFS å»ºç«‹ä¸€å€‹ hash type çš„ mapï¼Œæ ¹æ“šé€™å€‹ map çš„ key ä¾† filter cgroup idï¼Œé€é bpf_get_current_cgroup_id ()Â å–å¾—ç•¶å‰ä¸Šä¸‹æ–‡çš„ cgroup_id ä¸¦åªä¿ç•™æœ‰åœ¨ map å…§çš„ä¸Šä¸‹æ–‡ã€‚\næ¥è‘— FILTER_PIDÂ å’Œ FILTER_UIDÂ åˆ†åˆ¥æ˜¯é‡å° pid å’Œ uid å» filterï¼Œåœ¨å¾Œé¢çš„ python ç¨‹å¼ç¢¼ä¸­æœƒæ ¹æ“šæ˜¯å¦æœ‰å•Ÿç”¨é€™å€‹é¸é …ä¾†æŠŠå­—ä¸²æ›¿ä»£æˆå°æ‡‰çš„ç¨‹å¼ç¢¼æˆ–ç©ºå­—ä¸²\nif args.pid: bpf_text = bpf_text.replace (\u0026#39;FILTER_PID\u0026#39;, \u0026#39;if (pid != % s) { return 0; }\u0026#39; % args.pid) bpf_text = bpf_text.replace (\u0026#39;FILTER_PID\u0026#39;, \u0026#39;\u0026#39;) å¦‚æœä¸€åˆ‡éƒ½æ»¿è¶³ï¼Œå°±æœƒä½¿ç”¨ tid ç•¶ keyï¼Œå°‡ sock çµæ§‹æ›´æ–°åˆ° currsockÂ map ç•¶ä¸­ã€‚\nå¾ŒåŠéƒ¨åˆ†çš„ eBPG ç¨‹å¼ç¢¼å®šç¾©äº† trace_connect_returnï¼Œé€™å€‹å‡½æ•¸æœƒè¢« attach åˆ° tcp_v4_connect å’Œ tcp_v6_connect çš„ kretprobe ä¸Šã€‚kprobe æ˜¯åœ¨å‡½æ•¸è¢«å‘¼å«æ™‚è¢«è§¸ç™¼ï¼Œkretprobe å‰‡æ˜¯åœ¨å‡½æ•¸å›å‚³æ™‚è¢«è§¸ç™¼ï¼Œå› æ­¤å¯ä»¥å–å¾—å‡½æ•¸çš„å›å‚³å€¼å’ŒåŸ·è¡Œçµæœã€‚\nint trace_connect_v4_return(struct pt_regs *ctx) { return trace_connect_return (ctx, 4); } çœŸæ­£çš„é€²å…¥é»åˆ†æˆ ip v4 å’Œ v6 çš„ç‰ˆæœ¬ä¾†å‚³å…¥ ipver è®Šæ•¸ã€‚\nstatic int trace_connect_return(struct pt_regs *ctx, short ipver) { int ret = PT_REGS_RC (ctx); u64 pid_tgid = bpf_get_current_pid_tgid (); u32 pid = pid_tgid \u0026gt;\u0026gt; 32; u32 tid = pid_tgid; struct sock **skpp; skpp = currsock.lookup (\u0026amp;tid); if (skpp == 0) { return 0; //missed entry } if (ret != 0) { //failed to send SYNC packet, may not have populated //socket __sk_common.{skc_rcv_saddr, ...} currsock.delete (\u0026amp;tid); return 0; } //pull in details struct sock *skp = *skpp; u16 lport = skp-\u0026gt;__sk_common.skc_num; u16 dport = skp-\u0026gt;__sk_common.skc_dport; FILTER_PORT FILTER_FAMILY if (ipver == 4) { IPV4_CODE } else /* 6 */ { IPV6_CODE } currsock.delete (\u0026amp;tid); return 0; } é€é PT_REGS_RCÂ å¯ä»¥å–å¾—å‡½æ•¸çš„å›å‚³å€¼ï¼Œæ ¹æ“šå‡½æ•¸çš„å®šç¾©ï¼Œå¦‚æœåŸ·è¡ŒæˆåŠŸæ‡‰è©²è¦å›å‚³ 0 æ‰€ä»¥å¦‚æœ retÂ ä¸ç‚ºé›¶ï¼Œè¡¨ç¤ºåŸ·è¡ŒéŒ¯èª¤ï¼Œç›´æ¥å¿½ç•¥ã€‚é€é currsock.lookupÂ æˆ‘å€‘å¯ä»¥å–å›å°æ‡‰ tid çš„ sock æŒ‡æ¨™ï¼Œç„¶å¾Œå–å¾— dst port å’Œ src port (lport)ï¼Œç”±æ–¼é€™æ™‚å€™ tcp_connect å·²ç¶“åŸ·è¡Œå®Œæˆï¼Œæ‰€ä»¥ src port å·²ç¶“è¢« kernel åˆ†é…ã€‚\né€™é‚Šå¯ä»¥çœ‹åˆ° eBPF ç¨‹å¼è¨­è¨ˆä¸Šæ¯”è¼ƒè¤‡é›œçš„åœ°æ–¹ï¼Œsock çµæ§‹é«”è¦åœ¨ kprobe å–å¾—ï¼Œä½†æ˜¯æˆ‘å€‘åˆéœ€è¦ kretprobe å¾Œçš„ä¸€äº›è³‡è¨Šï¼Œå› æ­¤æ•´å€‹æ¶æ§‹è¦è¢«æ‹†æˆå…©å€‹éƒ¨åˆ†ï¼Œç„¶å¾Œé€é map ä¾†é€²è¡Œå‚³è¼¸ã€‚\næ¥è‘— FILTER_PORTÂ å’Œ FILTER_FAMILYÂ ä¸€æ¨£æœƒè¢«æ›¿æ›ï¼Œç„¶å¾Œæ ¹æ“š dst port å’Œ family ä¾† filterã€‚\nç”±æ–¼ tcpconnect æœ‰ç´€éŒ„å’Œçµ±è¨ˆé€£ç·šæ¬¡æ•¸å…©ç¨®æ¨¡å¼ï¼Œå› æ­¤æœ€å¾Œä¸€æ®µçš„ code ä¸€æ¨£å…ˆè¢«æ¨™è¨˜æˆ IPV4_CODEã€‚ç„¶å¾Œæ ¹æ“šæ¨¡å¼çš„ä¸åŒä¾†å–ä»£æˆä¸åŒçš„ codeã€‚\nif args.count: bpf_text = bpf_text.replace (\u0026#34;IPV4_CODE\u0026#34;, struct_init [\u0026#39;ipv4\u0026#39;][\u0026#39;count\u0026#39;]) bpf_text = bpf_text.replace (\u0026#34;IPV6_CODE\u0026#34;, struct_init [\u0026#39;ipv6\u0026#39;][\u0026#39;count\u0026#39;]) else: bpf_text = bpf_text.replace (\u0026#34;IPV4_CODE\u0026#34;, struct_init [\u0026#39;ipv4\u0026#39;][\u0026#39;trace\u0026#39;]) bpf_text = bpf_text.replace (\u0026#34;IPV6_CODE\u0026#34;, struct_init [\u0026#39;ipv6\u0026#39;][\u0026#39;trace\u0026#39;]) æˆ‘å€‘é€™é‚Šå°±åªçœ‹ ipv4 trace çš„ç‰ˆæœ¬ã€‚\nstruct ipv4_data_t data4 = {.pid = pid, .ip = ipver}; data4.uid = bpf_get_current_uid_gid (); data4.ts_us = bpf_ktime_get_ns () / 1000; data4.saddr = skp-\u0026gt;__sk_common.skc_rcv_saddr; data4.daddr = skp-\u0026gt;__sk_common.skc_daddr; data4.lport = lport; data4.dport = ntohs (dport); bpf_get_current_comm (\u0026amp;data4.task, sizeof(data4.task)); ipv4_events.perf_submit (ctx, \u0026amp;data4, sizeof(data4)); é€™é‚Šå…¶å¯¦å°±æ˜¯å»å¡«å…… ipv4_data_t çµæ§‹ã€é€é bpf_get_current_comm å–å¾—ç•¶å‰ç¨‹å¼çš„åç¨±ï¼Œæœ€å¾Œé€éå‰é¢é€é BPP_PERF_OUT å®šç¾©çš„ ipv4_eventsï¼Œå‘¼å« perf_submit (ctx, \u0026amp;data4, sizeof (data4))Â å°‡è³‡æ–™é€åˆ° user spaceã€‚\nåˆ°é€™é‚Šå°±å®Œæˆäº†æ•´å€‹çš„ eBPF ç¨‹å¼ç¢¼ bpf_textÂ çš„å®šç¾©ï¼Œå¾Œé¢å°±æœƒå…ˆç¶“éå‰é¢è¬›çš„ï¼Œå°‡ IPV4_CODE ç­‰å­—æ®µï¼Œæ ¹æ“š tcpconnect çš„åƒæ•¸é€²è¡Œå–ä»£ã€‚\nb = BPF (text=bpf_text) b.attach_kprobe (event=\u0026#34;tcp_v4_connect\u0026#34;, fn_name=\u0026#34;trace_connect_entry\u0026#34;) b.attach_kprobe (event=\u0026#34;tcp_v6_connect\u0026#34;, fn_name=\u0026#34;trace_connect_entry\u0026#34;) b.attach_kretprobe (event=\u0026#34;tcp_v4_connect\u0026#34;, fn_name=\u0026#34;trace_connect_v4_return\u0026#34;) b.attach_kretprobe (event=\u0026#34;tcp_v6_connect\u0026#34;, fn_name=\u0026#34;trace_connect_v6_return\u0026#34;) æ¥è‘—é€é BCC çš„ library å®Œæˆ eBPF ç¨‹å¼ç¢¼çš„ç·¨è­¯ã€è¼‰å…¥å’Œ attachã€‚\næœ€å¾Œæ˜¯è¼¸å‡ºçš„éƒ¨åˆ†ï¼Œå‰é¢æœƒå…ˆè¼¸å‡ºä¸€äº›ä¸‹åˆ—çš„æ¬„ä½è³‡è¨Šï¼Œä½†æ˜¯ç”±æ–¼é€™ä¸æ˜¯å¾ˆé‡è¦æ‰€ä»¥å°±çœç•¥æ‰ã€‚\nTracing connect ... Hit Ctrl-C to end PID COMM IP SADDR DADDR DPORT b = BPF (text=bpf_text) ... # read events b [\u0026#34;ipv4_events\u0026#34;].open_perf_buffer (print_ipv4_event) b [\u0026#34;ipv6_events\u0026#34;].open_perf_buffer (print_ipv6_event) while True: try: b.perf_buffer_poll () except KeyboardInterrupt: exit () å®Œæˆè¼‰å…¥å¾Œï¼Œæˆ‘å€‘å¯ä»¥æ‹¿åˆ°ä¸€å€‹å°æ‡‰çš„ BPF ç‰©ä»¶ï¼Œé€é b[MAP_NAME]ï¼Œæˆ‘å€‘å¯ä»¥èª¿ç”¨ map å°æ‡‰çš„ open_perf_bufferAPIï¼Œé€é open_perf_bufferï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹ callback function ç•¶æœ‰è³‡æ–™å¾ kernel é€é perf_submit è¢«å‚³è¼¸çš„æ™‚å€™è¢«å‘¼å«ä¾†è™•ç† eBPF ç¨‹å¼é€éä¾†çš„è³‡æ–™ã€‚\næœ€å¾Œæœƒå‘¼å« b.perf_buffer_pollÂ ä¾†æŒçºŒæª¢æŸ¥ perf map æ˜¯ä¸æ˜¯æœ‰æ–°çš„ perf eventï¼Œä»¥åŠå‘¼å«å°æ‡‰çš„ callback functionã€‚\ndef print_ipv4_event(cpu, data, size): event = b [\u0026#34;ipv4_events\u0026#34;].event (data) global start_ts if args.timestamp: if start_ts == 0: start_ts = event.ts_us printb (b\u0026#34;%-9.3f\u0026#34; % ((float(event.ts_us) - start_ts) / 1000000), nl=\u0026#34;\u0026#34;) if args.print_uid: printb (b\u0026#34;%-6d\u0026#34; % event.uid, nl=\u0026#34;\u0026#34;) dest_ip = inet_ntop (AF_INET, pack (\u0026#34;I\u0026#34;, event.daddr)).encode () if args.lport: printb (b\u0026#34;%-7d %-12.12s %-2d %-16s %-6d %-16s %-6d % s\u0026#34; % (event.pid, event.task, event.ip, inet_ntop (AF_INET, pack (\u0026#34;I\u0026#34;, event.saddr)).encode (), event.lport, dest_ip, event.dport, print_dns (dest_ip))) else: printb (b\u0026#34;%-7d %-12.12s %-2d %-16s %-16s %-6d % s\u0026#34; % (event.pid, event.task, event.ip, inet_ntop (AF_INET, pack (\u0026#34;I\u0026#34;, event.saddr)).encode (), dest_ip, event.dport, print_dns (dest_ip))) x é€é b [\u0026quot;ipv4_events\u0026quot;].eventÂ å¯ä»¥ç›´æ¥å°‡ data æ•¸æ“šè½‰æ›æˆ BPF ç¨‹å¼å…§å®šç¾©çš„è³‡æ–™çµæ§‹ï¼Œæ–¹ä¾¿å­˜å–ã€‚å–å¾—çš„è³‡æ–™å†ç¶“éä¸€äº›æ¸…æ´—å’Œè½‰è­¯å°±èƒ½å¤ ç›´æ¥è¼¸å‡ºäº†ã€‚\né›–ç„¶æˆ‘å€‘è·³éäº† count åŠŸèƒ½é‚„æœ‰ä¸€å€‹ç´€éŒ„ dst ip çš„ DNS æŸ¥è©¢ï¼Œä½†åˆ°æ­¤æˆ‘å€‘å¤§è‡´ä¸Šçœ‹å®Œäº†æ•´å€‹ tcpconnect çš„ä¸»è¦çš„å¯¦ä½œå…§å®¹ã€‚\n","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-4-bcc-tcpconnect/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 4 - BCC tcpconnect","type":"posts"},{"content":"é€™ç¯‡æ–‡ç« æœƒä»‹ç´¹ eBPF socket filter çš„æ¦‚å¿µï¼Œä¸¦ä½¿ç”¨ bcc çš„ http-parse-simple.pyÂ ä½œç‚ºç¯„ä¾‹ï¼Œä¾†èªªæ˜å¦‚ä½•ä½¿ç”¨ eBPF socket filter ä¾†éæ¿¾ HTTP è«‹æ±‚ï¼Œä¸¦ä¸”æœƒæ·±å…¥åº•ä¸‹ eBPF çš„ socket filter åº•å±¤éƒ¨åˆ†çš„å¯¦ä½œã€‚\nSocket filter ä»‹ç´¹ # å‰ä¸€ç¯‡æ–‡ç« ä»‹ç´¹çš„ tcpconnect æ˜¯ä½¿ç”¨ BPF_PROG_TYPE_KPROBEÂ é€™å€‹ program typeï¼Œé€é kprobe/kretprobe æ©Ÿåˆ¶åœ¨ kernel function è¢«å‘¼å«å’Œå›å‚³çš„æ™‚å€™åŸ·è¡Œã€‚\né€™æ¬¡ä½¿ç”¨çš„æ˜¯ BPF_PROG_TYPE_SOCKET_FILTERï¼Œsocket filter å¯ä»¥å°é€²å‡º socket çš„å°åŒ…é€²è¡Œæˆªæ–·æˆ–éæ¿¾ã€‚ç‰¹åˆ¥æ³¨æ„é€™é‚Šå¦‚æœæœƒéœ€è¦æ“·å–å°åŒ… (é•·åº¦ä¸ç­‰æ–¼åŸå§‹å°åŒ…é•·åº¦) å‰‡æœƒè§¸ç™¼å°å°åŒ…é€²è¡Œè¤‡è£½ï¼Œç„¶å¾Œä¿®æ”¹å°åŒ…å¤§å°ã€‚\nsocket filter program æœƒåœ¨ socket å±¤è¢«å‘¼å« (åœ¨ net/core/sock.c çš„ sock_queue_rcv_skb è¢«å‘¼å«)ï¼Œä¸¦å‚³å…¥ _sk_buff çµæ§‹Â å–å¾— socket ä¸Šä¸‹æ–‡åŠå°åŒ…çš„å…§å®¹ã€‚\né€éå›å‚³çš„æ•¸å€¼ä¾†æ±ºå®šå¦‚ä½•è™•ç†è©²å°åŒ…ï¼Œå¦‚æœå›å‚³çš„æ•¸å€¼å¤§æ–¼ç­‰æ–¼å°åŒ…é•·åº¦ï¼Œç­‰åƒ¹æ–¼ä¿ç•™å®Œæ•´å°åŒ…ï¼Œå¦‚æœé•·åº¦å°æ–¼å°åŒ…é•·åº¦ï¼Œå‰‡æˆªæ–·åªä¿ç•™å›å‚³æ•¸å€¼é•·åº¦çš„å°åŒ…ã€‚å…¶ä¸­å…©å€‹ç‰¹ä¾‹æ˜¯å›å‚³ 0 å’Œ - 1ã€‚å›å‚³ 0 ç­‰åƒ¹è§£å–ä¸€å€‹é•·åº¦ç‚º 0 çš„å°åŒ…ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥ä¸Ÿæ£„è©²å°åŒ…ã€‚å›å‚³ - 1 æ™‚ï¼Œç”±æ–¼å°åŒ…é•·åº¦æ˜¯ç„¡è™Ÿæ•´æ•¸ï¼Œ-1 ç­‰åƒ¹æ–¼æ•´æ•¸çš„æœ€å¤§æ•¸å€¼ï¼Œå› æ­¤ä¿è­‰ä¿ç•™æ•´å€‹å®Œæ•´çš„å°åŒ…ã€‚\nå¦å¤–ä¸€å€‹é—œéµæŠ€è¡“æ˜¯ raw socketï¼Œæˆ‘å€‘å¯ä»¥å°‡ raw socket ç›£è½æŸå€‹ç¶²è·¯ä»‹é¢ä¸Šæ‰€æœ‰é€²å‡ºå°åŒ…ã€‚\nå› æ­¤æ•´å€‹ç¨‹å¼çš„åŸ·è¡Œæ–¹å¼æ˜¯é€™æ¨£çš„ï¼Œåœ¨ç›®æ¨™ç¶²è·¯å¡ä¸Šé–‹å•Ÿä¸€å€‹ raw socketï¼Œé€é eBPF ç¨‹å¼éæ¿¾æ‰æ‰€æœ‰é http çš„å°åŒ…ï¼Œåªä¿ç•™ http å°åŒ…é€å‡ºåˆ° raw socketï¼Œuserspace client æ¥æ”¶åˆ°å°åŒ…æ™‚ï¼Œå¯ä»¥ç›´æ¥è§£æå°åŒ…æ¬„ä½æå–å‡º http å°åŒ…è³‡è¨Šã€‚\nhttp-parse-simple ä»‹ç´¹ # é¦–å…ˆä¸€æ¨£å…ˆäº†è§£ä¸€ä¸‹é€™æ”¯ç¨‹å¼çš„åŠŸèƒ½ï¼Œhttp-parse èƒ½å¤ ç¶å®šåˆ°ä¸€å¼µç¶²è·¯å¡ä¸Šé¢åŸ·è¡Œï¼Œç„¶å¾Œæå–ç¶“é http æµé‡ï¼Œå°‡ http version, method, uri å’Œ status è¼¸å‡ºé¡¯ç¤ºã€‚(ç•¶ç„¶å¦‚æœç¶“é tls åŠ å¯†çš„è©±æ˜¯æ²’è¾¦æ³•çš„)\nåŸ·è¡Œçµæœå¦‚ä¸‹\npython http-parse-complete.py GET /pipermail/iovisor-dev/ HTTP/1.1 HTTP/1.1 200 OK GET /favicon.ico HTTP/1.1 HTTP/1.1 404 Not Found GET /pipermail/iovisor-dev/2016-January/thread.html HTTP/1.1 HTTP/1.1 200 OK GET /pipermail/iovisor-dev/2016-January/000046.html HTTP/1.1 HTTP/1.1 200 OK http-parse-simple å¯¦ä½œ # eBPF å¯¦ä½œ # åœ¨é€™æ¬¡çš„ç¨‹å¼ä¸­ eBPF c code ç›´æ¥å¯«åœ¨ä¸€å€‹ç¨ç«‹çš„ http-parse-simple.c æª”æ¡ˆä¸­ã€‚\né€™æ¬¡çš„ ebpf ç¨‹å¼å¾ˆç°¡å–®åªæœ‰å–®ä¸€å€‹å‡½æ•¸ http_filterï¼Œä½œç‚º socket filter çš„é€²åº¦é»ã€‚\nint http_filter(struct __sk_buff *skb) { u8 *cursor = 0; struct ethernet_t *ethernet = cursor_advance (cursor, sizeof(*ethernet)); //filter IP packets (ethernet type = 0x0800) if (!(ethernet-\u0026gt;type == 0x0800)) { goto DROP; } struct ip_t *ip = cursor_advance (cursor, sizeof(*ip)); //drop the packet returning 0 DROP: return 0; ... ç›¸ä¿¡å¾ˆå¤šäººè·Ÿæˆ‘ä¸€æ¨£ç¬¬ä¸€çœ¼çœ‹åˆ°é€™å€‹ç¨‹å¼æœƒè¦ºå¾—éå¸¸ç–‘æƒ‘ï¼Œé¦–å…ˆçœ‹åˆ°çš„æ˜¯ cursorÂ å’Œ cursor_advanceÂ é€™å…©å€‹æ±è¥¿ï¼Œå¾ ip é‚£è¡Œå¤§æ¦‚å¯ä»¥çŒœçš„å‡ºä¾†ï¼Œcursor æ˜¯å°å°åŒ…å…§å®¹å­˜å–ä½ç½®çš„æŒ‡æ¨™ï¼Œcursor_advance æœƒè¼¸å‡ºç•¶å‰ cursor çš„ä½ç½®ï¼Œç„¶å¾Œå°‡ cursor å‘å¾Œç§»å‹•ç¬¬äºŒå€‹åƒæ•¸çš„é•·åº¦ã€‚ç”±æ–¼æˆ‘å€‘è¦åˆ†æçš„æ˜¯ http å°åŒ…ï¼Œæ‰€ä»¥ä»–çš„ ether type å‹¢å¿…å¾—æ˜¯ 0x0800 (IP)ï¼Œæ‰€ä»¥å°æ–¼ä¸æ»¿è¶³çš„å°åŒ…ï¼Œæˆ‘å€‘ç›´æ¥ goto åˆ° dropï¼Œreturn 0ã€‚è¡¨ç¤ºæˆ‘å€‘è¦æ“·å–ä¸€å€‹é•·åº¦ç‚º 0 çš„å°åŒ…ç­‰åƒ¹æ–¼ä¸Ÿæ£„è©²å°åŒ…ã€‚\nåœ¨ bcc çš„ helpers.hÂ è¼”åŠ©å‡½æ•¸æ¨™é ­æª”è£¡é¢å¯ä»¥çœ‹åˆ° cursor_advane çš„å®šç¾©ã€‚\n//packet parsing state machine helpers #define cursor_advance (_cursor, _len) \\ ({ void *_tmp = _cursor; _cursor += _len; _tmp; }) æœç„¶ç¬¦åˆæˆ‘å€‘çš„é æœŸï¼Œå…ˆå°‡åŸå…ˆ cursor æŒ‡æ¨™çš„æ•¸å€¼ä¿ç•™èµ·ä¾†ï¼Œå°‡ cursor å‘å¾Œç§»å‹• len å¾Œå›å‚³åŸå§‹æ•¸å€¼ã€‚\nå¾Œé¢çš„ç¨‹å¼ç¢¼å…¶å¯¦å°±å¾ˆç°¡å–®ï¼Œé¦–å…ˆä¸€è·¯è§£æå°åŒ…ç¢ºä¿ä»–æ˜¯ä¸€å€‹ ip/tcp/http å°åŒ…ã€å°åŒ…é•·åº¦å¤ é•·å¡çš„ä¸‹ä¸€å€‹æœ‰æ•ˆçš„ http å°åŒ…å…§å®¹\npayload_offset = ETH_HLEN + ip_header_length + tcp_header_length; ... unsigned long p [7]; int i = 0; for (i = 0; i \u0026lt; 7; i++) { p [i] = load_byte (skb, payload_offset + i); } æ¥è‘—å°‡ http packet çš„å‰ 7 å€‹ byte è®€å‡ºä¾†ï¼Œload_byte åŒæ¨£æ˜¯å®šç¾©åœ¨ helpers.h\nunsigned long long load_byte (void *skb, unsigned long long off) asm (\u0026#34;llvm.bpf.load.byte\u0026#34;); ä»–æœƒç›´æ¥è½‰è­¯æˆ BPF_LD_ABSï¼Œå¾ payload_offset ä½ç½®é–‹å§‹è®€ä¸€å€‹ byte å‡ºä¾†ï¼Œpayload_offsetï¼Œæ˜¯å‰é¢ç®—å‡ºä¾†å¾ ethernet header é–‹å§‹åˆ° http payload çš„ä½ç§»ã€‚\n//HTTP if ((p [0] == \u0026#39;H\u0026#39;) \u0026amp;\u0026amp; (p [1] == \u0026#39;T\u0026#39;) \u0026amp;\u0026amp; (p [2] == \u0026#39;T\u0026#39;) \u0026amp;\u0026amp; (p [3] == \u0026#39;P\u0026#39;)) { goto KEEP; } //GET if ((p [0] == \u0026#39;G\u0026#39;) \u0026amp;\u0026amp; (p [1] == \u0026#39;E\u0026#39;) \u0026amp;\u0026amp; (p [2] == \u0026#39;T\u0026#39;)) { goto KEEP; } ... //no HTTP match goto DROP; //keep the packet and send it to userspace returning -1 KEEP: return -1; æ¥è‘—æª¢æŸ¥å¦‚æœå°åŒ…å±¬æ–¼ HTTP (ä»¥ HTTP, GET, POST, PUT, DELETE HEADâ€¦ é–‹é ­)ï¼Œå°±æœƒè·³åˆ° keepï¼Œä¿ç•™æ•´å€‹å®Œæ•´çš„å°åŒ…é€åˆ° userspace client programã€‚\nGET /favicon.ico HTTP/1.1 HTTP/1.1 200 OK HTTP request æœƒä»¥ method é–‹é ­ã€response æœƒä»¥ HTTP é–‹é ­ï¼Œæ‰€ä»¥éœ€è¦æŸ¥æ‰¾é€™äº›å­—æ¨£é–‹é ­çš„å°åŒ…ã€‚\npython å¯¦ä½œ # æ¥è‘—æˆ‘å€‘å¾ˆå¿«é€Ÿçš„ä¾†çœ‹ä¸€ä¸‹ python ç¨‹å¼ç¢¼çš„éƒ¨åˆ†ã€‚\nbpf = BPF (src_file = \u0026#34;http-parse-simple.c\u0026#34;,debug = 0) function_http_filter = bpf.load_func (\u0026#34;http_filter\u0026#34;, BPF.SOCKET_FILTER) BPF.attach_raw_socket (function_http_filter, interface) socket_fd = function_http_filter.sock sock = socket.fromfd (socket_fd,socket.PF_PACKET,socket.SOCK_RAW,socket.IPPROTO_IP) sock.setblocking (True) é¦–å…ˆæˆ‘å€‘ä¸€æ¨£é€é BPF ç‰©ä»¶å®Œæˆ bpf ç¨‹å¼ç¢¼çš„ç·¨è­¯ï¼Œä¸ä¸€æ¨£çš„æ˜¯æ˜¯é€™é‚Šç›´æ¥æŒ‡å®š src_file å¾æª”æ¡ˆè®€å–ã€‚æ¥è‘—é€é load_funcï¼ŒæŒ‡å®š socket filter é€™å€‹ program type type å’Œ http_filter é€™å€‹å…¥å£å‡½æ•¸ï¼Œä¸¦è¼‰å…¥ ebpf bytecode åˆ° kernel æ¥è‘—é€é bcc æä¾›çš„ attach_raw_socket API åœ¨ interface ä¸Šå»ºç«‹ row socket ä¸¦å°‡ socket filter program attach ä¸Šå»ã€‚æ¥è‘—å¾ function_http_filter.sockÂ å–å¾— raw socket çš„ file descripter ä¸¦å°è£æˆ python çš„ socket ç‰©ä»¶ã€‚ç”±æ–¼å¾Œé¢éœ€è¦ socket æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ attach_raw_socket å»ºç«‹å‡ºä¾†çš„ socket æ˜¯éé˜»å¡çš„ï¼Œæ‰€ä»¥é€™é‚Šé€é sock.setblocking (True)Â é˜»å¡ socket\nwhile 1: #retrieve raw packet from socket packet_str = os.read (socket_fd,2048) packet_bytearray = bytearray (packet_str) ... for i in range (payload_offset,len (packet_bytearray)-1): if (packet_bytearray [i]== 0x0A): # \\n if (packet_bytearray [i-1] == 0x0D): \\r break # é‡åˆ° http çš„æ›è¡Œ \\r\\n å‰‡çµæŸ \u0026lt; br\u0026gt; print (\u0026#34;% c\u0026#34; % chr (packet_bytearray [i]), end = \u0026#34;\u0026#34;) å¾Œé¢çš„ç¨‹å¼ç¢¼å…¶å¯¦å°±å’Œ ebpf çš„éƒ¨åˆ†å¤§åŒå°ç•°ï¼Œå¾ socket è®€å–å°åŒ…å…§å®¹ã€è§£æåˆ° http payload å¾Œï¼Œå°‡ http payload çš„ç¬¬ä¸€è¡Œè¼¸å‡ºå‡ºä¾†ã€‚\nåˆ°æ­¤æˆ‘å€‘å°±å®Œæˆäº† http-parse-simpleÂ çš„è§£æã€‚\nå•é¡Œ # cursor æŒ‡æ¨™æ•¸å€¼ç‚º 0ï¼Œä½†æ˜¯å¯ä»¥å­˜å–åˆ°å°åŒ…çš„å…§å®¹ã€‚\nu8 *cursor = 0; struct ethernet_t *ethernet = cursor_advance (cursor, sizeof(*ethernet)); if (!(ethernet-\u0026gt;type == 0x0800)) { goto DROP; } ç‰¹åˆ¥çš„ load_bytes å‡½æ•¸å‘¼å«ï¼Œä¾†å–å¾—å°åŒ…å…§å®¹\nload_byte (skb, payload_offset + i); é¦–å…ˆé›–ç„¶ ebpf ä½¿ç”¨ c ä¾†ç·¨å¯«ï¼Œä½†æ˜¯ç¶“ç”± LLVM ç·¨è­¯å¾Œæœƒè½‰æ›æˆ eBPF bytecodeï¼Œåœ¨é€²å…¥ kernel å¾Œæœƒå†ç¶“é verifier çš„ä¿®æ”¹ã€‚(ç¶“éé€™æ¬¡çš„æ¢ç´¢ï¼Œå¯ä»¥ç†è§£ verifier é›–ç„¶å«åš verifierï¼Œä½†æ˜¯ä»–çš„åŠŸèƒ½ç¢ºåŒ…ç¾…è¬è±¡ï¼Œå° eBPF æ¶æ§‹ä¾†èªªéå¸¸é‡è¦)\næ·±å…¥äº†è§£ Socket filter # ç‚ºäº†ç†è§£é€™æ®µ eBPF code å¾Œé¢ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Œæˆ‘å€‘å…ˆæŸ¥çœ‹ LLVM ç·¨è­¯å‡ºä¾†çš„ eBPF bytecodeã€‚\nBCC Debug # åœ¨ BCC ç·¨è­¯æ™‚ï¼Œæˆ‘å€‘å¯ä»¥é€é debugÂ é€™å€‹åƒæ•¸å–å¾—ç·¨è­¯éç¨‹ä¸­çš„è³‡è¨Šï¼Œç•¶ç„¶ä¹ŸåŒ…å«å–å¾— LLVM ç·¨è­¯å‡ºä¾†çš„ eBPF bytecodeï¼Œå¯ä»¥ä½¿ç”¨çš„ debug é¸é …å¦‚ä¸‹\n# Debug flags # Debug output compiled LLVM IR. DEBUG_LLVM_IR = 0x1 # Debug output loaded BPF bytecode and register state on branches. DEBUG_BPF = 0x2 # Debug output pre-processor result. DEBUG_PREPROCESSOR = 0x4 # Debug output ASM instructions embedded with source. DEBUG_SOURCE = 0x8 # Debug output register state on all instructions in addition to DEBUG_BPF. DEBUG_BPF_REGISTER_STATE = 0x10 # Debug BTF. DEBUG_BTF = 0x20 è§£æ simple-http-parse ç·¨è­¯çµæœ # é€é BPF (src='simple-http-parse.c', debug=DEBUG_PREPROCESSOR)ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ code è¢« LLVM é‡æ–°è§£é‡‹ç‚º\nvoid *cursor = 0; struct ethernet_t *ethernet = cursor_advance (cursor, sizeof(*ethernet)); //filter IP packets (ethernet type = 0x0800) if (!(bpf_dext_pkt (skb, (u64) ethernet+12, 0, 16) == 0x0800)) { goto DROP; } å› æ­¤ cursor åœ¨é€™é‚Šçš„ç”¨é€”çœŸçš„åªæ˜¯è¨ˆç®— offsetã€‚bpf_dext_pkt åœ¨ bcc çš„ helper.hÂ æœ‰æ‰€å®šç¾©\nu64 bpf_dext_pkt(void *pkt, u64 off, u64 bofs, u64 bsz) { if (bofs == 0 \u0026amp;\u0026amp; bsz == 8) { return load_byte (pkt, off); } else if (bofs + bsz \u0026lt;= 8) { return load_byte (pkt, off) \u0026gt;\u0026gt; (8 - (bofs + bsz)) \u0026amp; MASK (bsz); } else if (bofs == 0 \u0026amp;\u0026amp; bsz == 16) { return load_half (pkt, off); ... å¯ä»¥çœ‹åˆ°ä»–æ˜¯æ ¹æ“šåƒæ•¸å¤§å°å’Œé¡å‹å»æ­£ç¢ºå‘¼å« load_byte, load_half, load_dword ç³»åˆ—å‡½æ•¸ï¼Œæ‰€ä»¥å…¶å¯¦ä»–åšçš„äº‹æƒ…èˆ‡æˆ‘å€‘æ„Ÿèˆˆè¶£çš„ç¬¬äºŒæ®µ codeÂ load_byte (skb, payload_offset + i);Â æ˜¯ä¸€è‡´çš„ã€‚\næ¥è‘—æˆ‘å€‘ä½¿ç”¨ BPF (src='simple-http-parse.c', debug=DEBUG_SOURCE)Â æŸ¥çœ‹ç·¨è­¯å‡ºä¾†çš„ eBPF binary codeã€‚\n; int http_filter(struct __sk_buff *skb) { // Line 27 0:\tbf 16 00 00 00 00 00 00\tr6 = r1 1:\t28 00 00 00 0c 00 00 00\tr0 = *(u16 *) skb [12] ; if (!(bpf_dext_pkt (skb, (u64) ethernet+12, 0, 16) == 0x0800)) { // Line 34 2:\t55 00 5c 00 00 08 00 00\tif r0 != 2048 goto +92 å…¶ä¸­ r0, r1, r6 æ˜¯ eBPF çš„ registerï¼Œæˆ‘å€‘é€™é‚Šåªé—œæ³¨ç¬¬ 1 è¡Œ r0 = *(u16 *) skb [12]ï¼Œé€™è¡Œæ˜¯å¾ skb çš„ç¬¬ 12 å€‹ byte æ‹¿å–è³‡æ–™å‡ºä¾†ï¼Œå‰›å¥½å°æ‡‰åˆ° bpf_dext_pktã€‚\næ ¹æ“š ebpf instruction set çš„å®šç¾©ï¼Œç¬¬ä¸€å€‹ byte 28 (0010 1000) æ˜¯ op codeã€‚æœ€å¾Œ 3 å€‹ bit 000 æ˜¯ op code çš„ç¨®é¡ã€‚é€™é‚Šçš„ 0x00 å°æ‡‰åˆ° BPF_LDÂ (non-standard load operations)\n3 bits (MSB) 2 bits 3 bits (LSB) mode size instruction class åœ¨ BPF_LDÂ é€™å€‹åˆ†é¡å…§ï¼Œsize bits 01 å‰›å¥½å°æ‡‰åˆ° BPF_HÂ (half word (2 bytes)) æœ€å‰é¢çš„ 3 å€‹ bit 000 ä»£è¡¨ BPF_ABS(legacy BPF packet access)ã€‚\nåˆ°é€™é‚Šæˆ‘å€‘å°±ç†è§£å®ƒæ˜¯æ€éº¼é‹ä½œäº†äº†ï¼ŒeBPF å®šç¾©äº† BPF_ABSÂ ä¾†ä»£è¡¨å°å°åŒ…çš„å­˜å–æ“ä½œï¼ŒLLVM åœ¨ç·¨è­¯çš„æ™‚æœƒå°‡å° skb çš„ load_byte è½‰è­¯æˆå°æ‡‰çš„ instructionã€‚\näº†è§£ eBPF BPF_ABS instruction # æˆ‘å€‘å¯ä»¥æ›´æ·±å…¥çš„äº†è§£ä¸€ä¸‹ eBPF å° BPF_ABSÂ åšäº†ä»€éº¼äº‹æƒ…ï¼Œåœ¨ verifier é€™å€‹ç¥å¥‡çš„åœ°æ–¹æœå°‹ BPF_ABSÂ é€™å€‹ instructionï¼Œæœƒæ‰¾åˆ°ä¸‹é¢é€™æ®µå…§å®¹ (ç°¡åŒ–ç‰ˆ)\n/* Implement LD_ABS and LD_IND with a rewrite, if supported by the program type. */ if (BPF_CLASS (insn-\u0026gt;code) == BPF_LD \u0026amp;\u0026amp; (BPF_MODE (insn-\u0026gt;code) == BPF_ABS || BPF_MODE (insn-\u0026gt;code) == BPF_IND)) { cnt = env-\u0026gt;ops-\u0026gt;gen_ld_abs (insn, insn_buf); new_prog = bpf_patch_insn_data (env, i + delta, insn_buf, cnt); é¦–å…ˆåŸ·è¡Œæ¢ä»¶æ˜¯ BPF_LDÂ åŠ BPF_ABSï¼Œæˆ‘å€‘çš„ code å‰›å¥½ç¬¦åˆé€™å€‹æ¢ä»¶ï¼Œæ¥è‘—æœƒå‘¼å« env-\u0026gt;ops-\u0026gt;gen_ld_absï¼Œæ ¹æ“šåŸæœ¬çš„ instrunctionÂ insnï¼Œç”Ÿæˆæ–°çš„ instruction å¯«å…¥ insn_bufï¼Œæ¥è‘—å‘¼å« bpf_patch_insn_dataÂ å°‡åŸæœ¬çš„æŒ‡ä»¤å–ä»£ç‚ºæ–°çš„æŒ‡ä»¤ã€‚\næ¥è‘—æˆ‘å€‘è¦æ‰¾ä¸€ä¸‹ gen_ld_absï¼Œè·Ÿ day 11 ä»‹ç´¹ map çš„æƒ…æ³é¡ä¼¼ï¼Œverifier å®šç¾©äº† bpf_verifier_ops çµæ§‹ï¼Œè®“ä¸åŒçš„ program type æ ¹æ“šéœ€è¦ï¼Œå¯¦ä½œ bpf_verifier_ops å®šç¾©çš„ function ä¾†æä¾›ä¸åŒçš„åŠŸèƒ½å’Œè¡Œç‚ºã€‚\nsocket filter çš„å®šç¾©å¦‚ä¸‹\nconst struct bpf_verifier_ops sk_filter_verifier_ops = { .get_func_proto\t= sk_filter_func_proto, .is_valid_access\t= sk_filter_is_valid_access, .convert_ctx_access\t= bpf_convert_ctx_access, .gen_ld_abs\t= bpf_gen_ld_abs, }; æ‰€ä»¥è®“æˆ‘å€‘çœ‹åˆ° bpf_gen_ld_absÂ (ä¸€æ¨£ç¶“éç°¡åŒ–åªçœ‹æˆ‘å€‘éœ€è¦çš„éƒ¨åˆ†)\nstatic int bpf_gen_ld_abs(const struct bpf_insn *insn, struct bpf_insn *insn_buf) { *insn++ = BPF_MOV64_REG (BPF_REG_2, orig-\u0026gt;src_reg); /* We\u0026#39;re guaranteed here that CTX is in R6. */ *insn++ = BPF_MOV64_REG (BPF_REG_1, BPF_REG_CTX); *insn++ = BPF_EMIT_CALL (bpf_skb_load_helper_16_no_cache); } çœ‹åˆ°æœ€å¾Œä¸€è¡Œå°±å¾ˆæ¸…æ™°äº†ï¼Œæœ€å¾Œå…¶å¯¦ç­‰æ–¼èª¿ç”¨äº†å…§éƒ¨ä½¿ç”¨çš„ helper function ä¾†å­˜å–è³‡æ–™ã€‚eBPF ä¹Ÿææä¾›äº†é¡ä¼¼çš„ helper functionÂ bpf_skb_load_bytesï¼Œä¾†æä¾›å­˜å–å°åŒ…å…§å®¹çš„åŠŸèƒ½ã€‚\nBPF_CALL_2 (bpf_skb_load_helper_16_no_cache, const struct sk_buff *, skb, int, offset) { return ____bpf_skb_load_helper_16 (skb, skb-\u0026gt;data, skb-\u0026gt;len - skb-\u0026gt;data_len, offset); } è€Œ bpf_skb_load_helper_16_no_cache å…¶å¯¦å°±æ˜¯ç›´æ¥å¾ sk_buff-\u0026gt;dataÂ çš„ä½ç½®å–å¾—è³‡æ–™ï¼Œdata æ˜¯ sk_buff ç”¨ä¾†æŒ‡åˆ°å°åŒ…é–‹é ­çš„æŒ‡æ¨™ã€‚\n__sk_buff çš„é™åˆ¶ # æ—¢ç„¶æ•´å€‹æŒ‡ä»¤çš„æœ¬è³ªæ˜¯å¾ sk_buff-\u0026gt;dataÂ æ‹¿å–è³‡æ–™ï¼Œé‚£æˆ‘å€‘æ˜¯ä¸æ˜¯èƒ½å¤ ç›´æ¥å¾ __sk_buffÂ è£¡é¢æ‹¿åˆ°è³‡æ–™å‘¢ï¼Ÿ\nåœ¨ socket program type ä¸‹ program context æ˜¯ __sk_buffï¼Œä»–å…¶å¯¦æœ¬è³ªæ˜¯å° sk_buff çš„å¤šä¸€å±¤å°è£ (åŸå›  åƒè¦‹)ï¼Œåœ¨åŸ·è¡Œçš„æ™‚å€™ï¼Œverifier æ›å°‡å…¶å–ä»£å› sk_buffï¼Œå› æ­¤__sk_buff ç­‰æ–¼æ˜¯ sk_buff æš´éœ²å‡ºä¾†çš„ä»‹é¢ã€‚\nstruct __sk_buff { ... __u32 data; __u32 data_end; __u32 napi_id; ... åƒè€ƒ**sk_buff çš„å®šç¾©ï¼Œ**sk_buff æ˜¯æœ‰å®šç¾©å°‡ data å’Œ data_endï¼Œé‚£æˆ‘å€‘åŸå§‹çš„ eBPF ç¨‹å¼æ˜¯ä¸æ˜¯å¯ä»¥æ”¹æˆ\nvoid *cursor = (void*)(long)(__sk_buff-\u0026gt;data); struct ethernet_t *ethernet = cursor_advance (cursor, sizeof (*ethernet)); if (!(ethernet-\u0026gt;type == 0x0800)) { goto DROP; } å¦‚æœå®Œæˆé€™æ¨£çš„ä¿®æ”¹ï¼Œé‡æ–°è·‘ä¸€é http-parse-simple.pyï¼Œä½ æœƒå¾—åˆ°\npython3 http-parse-simple.py -i eno0 binding socket to \u0026#39;enp0s3\u0026#39; bpf: Failed to load program: Permission denied ; int http_filter (struct __sk_buff *skb) { 0: (bf) r6 = r1 ; void *cursor = (void*)(long) skb-\u0026gt;data; 1: (61) r7 = *(u32 *)(r6 +76) invalid bpf_context access off=76 size=4 processed 2 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0 Traceback (most recent call last): File \u0026#34;http-parse-simple.py\u0026#34;, line 69, in \u0026lt;module\u0026gt; function_http_filter = bpf.load_func (\u0026#34;http_filter\u0026#34;, BPF.SOCKET_FILTER) File \u0026#34;/usr/lib/python3/dist-packages/bcc/__init__.py\u0026#34;, line 526, in load_func raise Exception (\u0026#34;Failed to load BPF program % s: % s\u0026#34; % Exception: Failed to load BPF program b\u0026#39;http_filter\u0026#39;: Permission denied å¯ä»¥çœ‹åˆ°ç¨‹å¼ç¢¼è¢« verifier æ‹’çµ•ï¼Œä¸¦æ‹¿åˆ°äº†ä¸€å€‹ invalid bpf_context access off=76 size=4Â çš„éŒ¯èª¤ï¼Œè¡¨ç¤ºå­˜å– __sk_buff-\u0026gt;dataÂ æ˜¯éæ³•çš„ã€‚\nå›å»è¿½è¹¤ç¨‹å¼ç¢¼çš„è©±ï¼Œæœƒçœ‹åˆ°åœ¨ verifier è£¡é¢æœƒç”¨ env-\u0026gt;ops-\u0026gt;is_valid_accessÂ ä¾†æª¢æŸ¥è©²å­˜å–æ˜¯å¦æœ‰æ•ˆï¼Œé€™åŒæ¨£å®šç¾©åœ¨ bpf_verifier_opsÂ çµæ§‹å…§ã€‚\nå…¶ä¸­ socket filter program çš„å¯¦ä½œæ˜¯\nstatic bool sk_filter_is_valid_access (int off, int size, enum bpf_access_type type, const struct bpf_prog *prog, struct bpf_insn_access_aux *info) { switch (off) { case bpf_ctx_range (struct __sk_buff, tc_classid): case bpf_ctx_range (struct __sk_buff, data): case bpf_ctx_range (struct __sk_buff, data_meta): case bpf_ctx_range (struct __sk_buff, data_end): case bpf_ctx_range_till (struct __sk_buff, family, local_port): case bpf_ctx_range (struct __sk_buff, tstamp): case bpf_ctx_range (struct __sk_buff, wire_len): case bpf_ctx_range (struct __sk_buff, hwtstamp): return false; } ... å¯ä»¥å¾ˆç›´æ¥çœ‹åˆ°æ‹’çµ•äº† data çš„å­˜å–ã€‚\nå¾ linux kernel çš„ è®Šæ›´ç´€éŒ„Â ä¾†æ¨æ¸¬ï¼Œdata æ¬„ä½å¥½åƒæœ¬ä¾†å°±ä¸æ˜¯çµ¦ socket filter ä½¿ç”¨çš„ï¼Œåªæ˜¯å–®ç´”å› ç‚º cls_bpf å’Œ socker filter å¯èƒ½å…±ç”¨äº†é€™éƒ¨åˆ†çš„ç¨‹å¼ç¢¼ï¼Œå› æ­¤è¦é¡å¤–é˜»æ“‹é€™éƒ¨åˆ†çš„ code ä¸è®“ä½¿ç”¨ã€‚\nçµèª # æœ€å¾Œé‚„æœ‰ä¸€å€‹æ²’è§£æ±ºçš„å•é¡Œï¼Œu8 *cursor = 0;ï¼Œç‚ºç”šéº¼ç©ºæŒ‡æ¨™ç¶“é LLVM ç·¨è­¯å¾Œæœƒç·¨è­¯æˆå° skb çš„å­˜å–é‚„æ˜¯æœªçŸ¥çš„ï¼Œçœ‹èµ·ä¾†åƒæ˜¯ BCC ç‰¹åˆ¥çš„æ©Ÿåˆ¶ï¼Œä½†æ˜¯æ‰¾ä¸å¤ªåˆ°ç›¸é—œè³‡æ–™ï¼Œåªå¥½ä¿ç•™é€™å€‹å•é¡Œã€‚\nåƒè€ƒè³‡æ–™ # eBPF Instruction Set Stackoverflow: invalid bpf_context accessâ€ bpf-helpers man page ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-5-bcc-http-filter-socket-filter/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 5 - BCC HTTP Filter \u0026 Socket Filter","type":"posts"},{"content":"é€™ç¯‡æ–‡ç« æœƒä»‹ç´¹ eBPF ä¸€å€‹æ¯”è¼ƒçŸ¥åçš„ç”¨é€”ï¼Œexpress data path (XDP)ï¼Œä¸¦ä½¿ç”¨ bcc çš„ xdp_redirect_map.pyÂ ä½œç‚ºç¯„ä¾‹ã€‚\nXDP ä»‹ç´¹ # æœƒèªª linux çš„ç¶²è·¯æ…¢ä¸»è¦æ˜¯å› ç‚ºå°åŒ…åœ¨é€²å‡º linux è¨­å‚™æ™‚è¦ç¶“é linux kernel çš„ network stackï¼Œç¶“éå¤§å®¶ç†Ÿæ‚‰çš„ iptables, routing table.. ç­‰ç¶²è·¯å­ç³»çµ±çš„è™•ç†ï¼Œç„¶è€Œç¶“ç”±é€™éº¼å¤šè¤‡é›œçš„ç³»çµ±è™•ç†å°±æœƒå¸¶ä¾†å»¶é²ï¼Œé™ä½ linux ç¶²è·¯çš„æ•ˆèƒ½ã€‚\nä¸Šåœ–æ˜¯å°åŒ…åœ¨ç¶“ç”± linux ç¶²è·¯å­ç³»çµ±åˆ°é€²å…¥è·¯ç”±å‰çš„æˆªåœ–ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å°åŒ…å‰›é€²å…¥åˆ° linux kernelï¼Œç”šè‡³é€£å‰é¢çœ‹éï¼Œlinux ç”¨ä¾†ç¶­è­·æ¯ä¸€å€‹å°åŒ…çš„ skb çµæ§‹éƒ½é‚„æ²’å»ºç«‹å‰ï¼Œå°±æœƒå‘¼å«åˆ° XDP eBPF ç¨‹å¼ï¼Œå› æ­¤å¦‚æœæˆ‘å€‘èƒ½å¤ åœ¨ XDP éšæ®µå°±å…ˆéæ¿¾æ‰å¤§é‡çš„å°åŒ…ï¼Œæˆ–å°åŒ…è½‰ç™¼ã€æ”¹å¯«ï¼Œèƒ½å¤ é¿å…æ‰é€²å…¥ linux ç¶²è·¯å­ç³»çµ±çš„æ•´å€‹éç¨‹ï¼Œé™ä½ linux è™•ç†å°åŒ…çš„æˆæœ¬ã€æé«˜æ€§èƒ½ã€‚\nå‰é¢æåˆ° XDP å·¥ä½œåœ¨å°åŒ…é€²å…¥ linux kernel çš„éå¸¸æ—©æœŸï¼Œç”šè‡³æ—©æ–¼ skb çš„å»ºç«‹ï¼Œå…¶å¯¦ XDP çš„ hook point ç›´æ¥æ˜¯åœ¨ driver å…§ï¼Œå› æ­¤ XDP æ˜¯éœ€è¦ driver ç‰¹åˆ¥æ”¯æ´çš„ï¼Œç‚ºæ­¤ XDP å…¶å¯¦æœ‰ä¸‰ç¨®å·¥ä½œæ¨¡å¼:Â xdpdrv,Â xdpgeneric,xdpoffloadã€‚xdpdrvÂ æŒ‡çš„æ˜¯ native XDPï¼Œå°±æ˜¯æ¨™æº–çš„ XDP æ¨¡å¼ï¼Œä»–çš„ hook point åœ¨ driver å±¤ï¼Œå› æ­¤æ˜¯ç¶²å¡æ¥æ”¶åˆ°å°åŒ…é€è‡³ç³»çµ±çš„ç¬¬ä¸€ä½ï¼Œå¯ä»¥æä¾›æ¥µå¥½çš„ç¶²è·¯æ€§èƒ½ã€‚xdpgeneric: generic XDP æä¾›ä¸€å€‹åœ¨ skb å»ºç«‹å¾Œçš„ XDP é€²å…¥é»ï¼Œå› æ­¤å¯ä»¥åœ¨ driver ä¸æ”¯æ´çš„æƒ…æ³ä¸‹æä¾› XDP åŠŸèƒ½ï¼Œä½†ä¹Ÿç”±æ–¼è©²é€²å…¥é»æ¯”è¼ƒæ™šï¼Œæ‰€ä»¥å…¶å¯¦ä¸å¤ªèƒ½æä¾›å¥½çš„ç¶²è·¯æ•ˆèƒ½ï¼Œè©²é€²å…¥é»ä¸»è¦æ˜¯è®“æ–°é–‹ç™¼è€…åœ¨ç¼ºä¹æ”¯æ´ç¶²å¡çš„æƒ…æ³ä¸‹ç”¨æ–¼æ¸¬è©¦å­¸ç¿’ï¼Œä»¥åŠæä¾› driver é–‹ç™¼è€…ä¸€å€‹æ¨™æº–ç”¨ã€‚xdpoffload: åœ¨æŸäº›ç¶²å¡ä¸‹ï¼Œå¯ä»¥å°‡ XDP offload åˆ°ç¶²å¡ä¸Šé¢åŸ·è¡Œï¼Œç”±æ–¼ç›´æ¥å·¥ä½œåœ¨ç¶²å¡æ™¶ç‰‡ä¸Šï¼Œå› æ­¤èƒ½å¤ æä¾›æ¯” native XDP é‚„è¦æ›´å¥½çš„æ€§èƒ½ï¼Œä¸éç¼ºé»å°±æ˜¯éœ€è¦ç¶²å¡æ”¯æ´è€Œä¸”éƒ¨åˆ†çš„ map å’Œ helper function æœƒç„¡æ³•ä½¿ç”¨ã€‚\nXDP çš„ return æ•¸å€¼ä»£è¡¨äº†å°åŒ…çš„ä¸‹å ´ï¼Œç¸½å…±æœ‰äº”ç¨®çµæœï¼Œå®šç¾©åœ¨ xdp_action\nenum xdp_action { XDP_ABORTED = 0, XDP_DROP, XDP_PASS, XDP_TX, XDP_REDIRECT, }; XDP_ABORTED, XDP_DROP éƒ½ä»£è¡¨ä¸Ÿæ£„å°åŒ…ï¼Œå› æ­¤ä½¿ç”¨ XDP æˆ‘å€‘å¯ä»¥æ¯”è¼ƒé«˜æ•ˆçš„ä¸Ÿæ£„å°åŒ…ï¼Œç”¨æ–¼é˜²ç¦¦ DDoS æ”»æ“Šã€‚ä¸é XDP_ABORTED åŒæ™‚æœƒç”¢ç”Ÿä¸€å€‹ eBPF ç³»çµ±éŒ¯èª¤ï¼Œå¯ä»¥é€é tracepoint æ©Ÿåˆ¶ä¾†æŸ¥çœ‹ã€‚\necho 1 \u0026gt; /sys/kernel/debug/tracing/events/xdp/xdp_exception/enable cat /sys/kernel/debug/tracing/trace_pipe systemd-resolve-512 [000] .Ns.1 5911.288420: xdp_exception: prog_id=91 action=ABORTED ifindex=2 ... XDP_PASS å°±æ˜¯æ­£å¸¸çš„è®“å°åŒ…é€šéä¸è™•ç†ã€‚\nXDP_TX æ˜¯å°‡å°åŒ…ç›´æ¥å¾åŸå§‹ç¶²å¡é€å‡ºå»ï¼Œæˆ‘å€‘å¯ä»¥é€éåœ¨ XDP ç¨‹å¼å…§ä¿®æ”¹å°åŒ…å…§å®¹ï¼Œä¾†ä¿®æ”¹ç›®çš„åœ° IP å’Œ MACï¼Œä¸€å€‹ä½¿ç”¨å‰æ™¯æ˜¯ç”¨æ–¼ load balancingï¼Œå¯ä»¥å°‡å°åŒ…æ‰“åˆ° XDP ä¸»æ©Ÿï¼Œåœ¨ä¿®æ”¹å°åŒ…é€å»å¾Œç«¯ä¸»æ©Ÿã€‚\nXDP_REDIRECT æ˜¯æ¯”è¼ƒå¾Œä¾†æ–°åŠ å…¥çš„ä¸€å€‹åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°‡å°åŒ…\nç›´æ¥è½‰é€åˆ°å¦å¤–ä¸€å¼µç¶²è·¯å¡ï¼Œç›´æ¥é€å‡ºå» æŒ‡å®šçµ¦ç‰¹å®šçš„ CPU è™•ç† å°‡å°åŒ…ç›´æ¥é€çµ¦ç‰¹å®šçš„ä¸€å€‹ AF_XDP çš„ socket ä¾†é”åˆ°è·³é kernel stack ç›´æ¥äº¤ç”± user space è™•ç†çš„æ•ˆé æœ€å¾Œï¼Œå‰é¢æåˆ° XDP æ—©æ–¼ skb çš„å»ºç«‹ï¼Œå› æ­¤ XDP eBPF program çš„ä¸Šä¸‹æ–‡ä¸æ˜¯skbbuffï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå·±çš„ xdp_md\nstruct xdp_md { __u32 data; __u32 data_end; __u32 data_meta; /* Below access go through struct xdp_rxq_info */ __u32 ingress_ifindex; /* rxq-\u0026gt;dev-\u0026gt;ifindex */ __u32 rx_queue_index; /* rxq-\u0026gt;queue_index */ }; å¯ä»¥çœ‹åˆ° xdp_md æ˜¯ä¸€å€‹éå¸¸ç²¾ç°¡çš„è³‡æ–™çµæ§‹ï¼Œå› ç‚º linux é‚„æ²’å°å…¶åšè§£ææå–å‡ºæ›´å¤šè³‡è¨Šã€‚\nxdp_redirect_map ä»‹ç´¹ # é€™æ¬¡ä½¿ç”¨çš„ eBPF program type ç†æ‰€ç•¶ç„¶æ˜¯ BPF_PROG_TYPE_XDPã€‚\né€™éš»ç¨‹å¼çš„åŠŸèƒ½å¾ˆç°¡å–®ï¼ŒåŸ·è¡Œæ™‚æŒ‡å®šå…©å€‹ interfaceÂ in_intfÂ å’Œ out_intfï¼Œæ‰€æœ‰å¾ in_intfÂ é€²å…¥çš„å°åŒ…æœƒç›´æ¥å¾ out_intfÂ é€å‡ºå»ï¼Œä¸¦ä¸”äº¤æ› src mac address å’Œ dst mac addressï¼ŒåŒæ™‚è¨˜éŒ„æ¯ç§’é˜é€šéè©²ä»‹é¢çš„å°åŒ…å€‹æ•¸ã€‚\nå¾ out_intf é€²å…¥çš„å°åŒ…å‰‡æ­£å¸¸äº¤çµ¦ linux network ç³»çµ±è™•ç†ã€‚\né¦–å…ˆæˆ‘å€‘ä¸€æ¨£è¦å…ˆé©—è­‰ç¨‹å¼çš„åŸ·è¡Œï¼Œé¦–å…ˆå»ºç«‹ä¸€å€‹ network namespace net0ã€‚ç„¶å¾ŒæŠŠå…©å€‹ç¶²å¡ veth_in_intf , veth_out_intf\næ”¾é€²å»ï¼Œä½œç‚º xdp_redirect_map ä½¿ç”¨çš„ç¶²å¡ã€‚ç‚ºäº†æ–¹ä¾¿æ‰“æµé‡ï¼Œæˆ‘å€‘å¹« in_intf æŒ‡å®šä¸€å€‹ ip 10.10.10.1ï¼Œä¸¦å¹«åŠ å…¥ä¸€å€‹ä¸å­˜åœ¨çš„é ç«¯ ip 10.10.10.2ï¼Œæ¥è‘—æˆ‘å€‘å°±å¯ä»¥é€é ping 10.10.10.2 ä¾†å¾ in_intf æ‰“æµé‡ï¼Œé€é tcpdump æ•æ‰ out_intf çš„å°åŒ…ï¼Œæ‡‰è©²å°±å¯ä»¥çœ‹åˆ°å¾ 10.10.10.1 éä¾†çš„å°åŒ…ï¼ŒåŒæ™‚ mac address è¢«äº¤æ›äº†ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° src mac è®Šæˆ ee:11:ee:11:ee:11ã€‚\nip netns add net0 ip link add in_intf type veth peer name veth_in_intf ip link add out_intf type veth peer name veth_out_intf ip link set veth_in_intf netns net0 ip link set veth_out_intf netns net0 ip link set in_intf up ip link set out_intf up ip netns exec net0 ip link set veth_in_intf up ip netns exec net0 ip link set veth_out_intf up ip address add 10.10.10.1/24 dev in_intf ip neigh add 10.10.10.2 lladdr ee:11:ee:11:ee:11 dev in_intf ç›®å‰é€™å€‹éƒ¨åˆ†å…¶å¯¦æ²’æœ‰é©—è­‰æˆåŠŸï¼Œé›–ç„¶æ ¹æ“š xdp redirect çš„ logï¼Œå°åŒ…æ˜¯çœŸçš„æœ‰æˆåŠŸè¢«è½‰é€åˆ° veth_out_intf çš„ï¼Œç„¶å¾Œé€é tcpdump å»æ²’æœ‰åœ¨ out_intf ä¸Šæ”¶åˆ°å°åŒ…ï¼Œå¯æƒœçš„æ˜¯å…·é«”åŸå› æ²’èƒ½ç¢ºå®šã€‚\nxdp_redirect_map å¯¦ä½œ # eBPF å¯¦ä½œ # é€™æ¬¡çš„ç¨‹å¼éå¸¸ç°¡çŸ­ï¼Œé¦–å…ˆæ˜¯ä¸€å€‹ swap_src_dst_mac å‡½æ•¸ï¼Œç”¨æ–¼äº¤æ›å°åŒ…çš„ src mac address å’Œ dst mac addressã€‚\nstatic inline void swap_src_dst_mac(void *data) { unsigned short *p = data; unsigned short dst [3]; dst [0] = p [0]; dst [1] = p [1]; dst [2] = p [2]; p [0] = p [3]; p [1] = p [4]; p [2] = p [5]; p [3] = dst [0]; p [4] = dst [1]; p [5] = dst [2]; } ç”±æ–¼ mac address åœ¨ ethernet header çš„å‰ 12 å€‹ bit æ‰€ä»¥å¯ä»¥å¾ˆç°¡å–®åœ°é€²è¡Œäº¤æ›ã€‚\næ¥è‘—å°±ç›´æ¥é€²å…¥åˆ°äº† attach åœ¨ in interface ä¸Šçš„ XDP å‡½æ•¸\nint xdp_redirect_map(struct xdp_md *ctx) { void* data_end = (void*)(long) ctx-\u0026gt;data_end; void* data = (void*)(long) ctx-\u0026gt;data; struct ethhdr *eth = data; uint32_t key = 0; long *value; uint64_t nh_off; nh_off = sizeof(*eth); if (data + nh_off \u0026gt; data_end) return XDP_DROP; value = rxcnt.lookup (\u0026amp;key); if (value) *value += 1; swap_src_dst_mac (data); return tx_port.redirect_map (0, 0); } é¦–å…ˆ data åŠ data_end æ˜¯åˆ†åˆ¥æŒ‡åˆ°å°åŒ…é ­å°¾çš„æŒ‡æ¨™ï¼Œç”±æ–¼å°åŒ…é ­éƒ½æ˜¯ ethernet headerï¼Œå› æ­¤å¯ä»¥ç›´æ¥å°‡ data è½‰æˆ ethhdrÂ æŒ‡æ¨™ã€‚é¦–å…ˆå° ethernet å°åŒ…åšä¸€å€‹å®Œæ•´æ€§æª¢æŸ¥ï¼Œdata + nh_off \u0026gt; data_endÂ è¡¨ç¤ºå°åŒ…å¤§å°å°æ–¼ä¸€å€‹ ethernet headerï¼Œè¡¨ç¤ºå°åŒ…è¡¨ç¤ºä¸å®Œæ•´ï¼Œå°±ç›´æ¥å°‡å°åŒ…é€é XDP_DROPÂ ä¸Ÿæ£„ã€‚\næ¥è‘— rxcxtÂ æ˜¯é å…ˆå®šç¾©çš„ä¸€å€‹ BPF_PERCPU_ARRAY (rxcnt, long, 1);ï¼ŒPER_CPU map çš„ç‰¹æ€§æ˜¯æ¯é¡† CPU ä¸Šéƒ½æœƒä¿æœ‰ä¸€ä»½ç¨ç«‹ä¸åŒæ­¥çš„è³‡æ–™ï¼Œå› æ­¤å¯ä»¥é¿å… cpu ä¹‹é–“çš„ race conditionï¼Œæ¸›å°‘ lock çš„é–‹éŠ·ã€‚é€™é‚ŠæŒ‡å®šæ¯å€‹ CPU ä¸Šçš„ array é•·åº¦ç‚º 1ï¼Œå¯ä»¥åƒè€ƒ Day11 æœ‰ä»‹ç´¹éï¼Œæ˜¯ä¸€å€‹ç‰¹åˆ¥çš„ä½¿ç”¨æŠ€å·§ï¼Œå¯ä»¥ç°¡å–®çœ‹æˆä¸€å€‹å¯ä»¥è·Ÿ user space share çš„å…¨åŸŸè®Šæ•¸ã€‚\nuint32_t key = 0; value = rxcnt.lookup (\u0026amp;key); if (value) *value += 1; é€™é‚Šçš„ç”¨é€”æ˜¯ç”¨ä¾†çµ±è¨ˆç¶“éçš„å°åŒ…å€‹æ•¸ï¼Œå› æ­¤é€™é‚Šéå¸¸ç°¡å–®ï¼Œçµ±ä¸€ä½¿ç”¨ 0 ç•¶ä½œ key å»å­˜å–å”¯ä¸€çš„ valueï¼Œç„¶å¾Œæ¯ç¶“éä¸€å€‹å°åŒ…å°±å°‡ value åŠ ä¸€ï¼Œé€™é‚Šå¯ä»¥æ³¨æ„åˆ° lookup å›å‚³çš„æ˜¯ pointerï¼Œå› æ­¤å¯ä»¥ç›´æ¥å°ä»–åšä¿®æ”¹å³å¯ä¿å­˜ã€‚\nswap_src_dst_mac (data); return tx_port.redirect_map (0, 0); æœ€å¾Œæœƒå‘¼å« swap_src_dst_macÂ ä¾†äº¤æ›å°åŒ…ï¼Œç„¶å¾Œé€é redirect_mapÂ ä¾†å°‡å°åŒ…é€åˆ°å°æ‡‰çš„ out interfaceã€‚\nBPF_MAP_TYPE_DEVMAP å’Œ BPF_MAP_TYPE_CUPMAP æ˜¯ç”¨ä¾†æ­é… XDP_REDIRECTï¼Œå°‡å°åŒ…å°å‘é€å®šçš„ CPU æˆ–è‘—å¾å…¶ä»– interface é€å‡ºå»çš„ã€‚\nè€Œé€™é‚Šçš„ redirect_map åœ¨ç·¨è­¯æ™‚æœƒè¢«ä¿®æ”¹ç‚ºå‘¼å« bpf_redirect_map é€™å€‹ helper functionã€‚å…¶å®šç¾©ç‚º long bpf_redirect_map (struct bpf_map *map, u32 key, u64 flags)ï¼Œé€éæ¥æ”¶ map å¯ä»¥æ ¹æ“šå°æ‡‰åˆ°çš„ value ä¾†å°‡å°åŒ…å°å‘åˆ° interface æˆ–è‘— CPUï¼Œè¨­ç½®æ–¹æ³•æœƒåœ¨å¾Œé¢çš„ python code ä»‹ç´¹ã€‚ç”±æ–¼æˆ‘å€‘ä»Šå¤©åªç‚ºæœ‰ä¸€å€‹ out interfaceï¼Œå› æ­¤å¯ä»¥å¾ˆç°¡å–®çš„æŒ‡å®š key ç‚º 0\nå¾Œé¢çš„ flags ç›®å‰åªæœ‰ä½¿ç”¨æœ€å¾Œå…©å€‹ bitï¼Œå¯ä»¥ç•¶ä½œ key æ‰¾ä¸åˆ°æ™‚ redirect_map çš„å›å‚³å€¼ï¼Œå› æ­¤ä»¥æœ¬æ¬¡çš„ code ä¾†èªªï¼Œé è¨­çš„å›å‚³æ•¸å€¼æ˜¯ 0ï¼Œä¹Ÿå°±å°æ‡‰åˆ° XDP_ABORTEDã€‚\nint xdp_dummy(struct xdp_md *ctx) { return XDP_PASS; } æœ€å¾Œä¸€æ®µç¨‹å¼ç¢¼ xdp_dummyÂ æ˜¯ç”¨ä¾†çš†åœ¨ out interface ä¸Šçš„ XDP ç¨‹å¼ï¼Œä½†ä»–å°±åªæ˜¯ç°¡å–®çš„ XDP_PASSï¼Œè®“é€²å…¥çš„å°åŒ…ç¹¼çºŒäº¤ç”± linux kernel ä¾†è™•ç†ã€‚\npython å¯¦ä½œ # æ¥ä¸‹ä¾†å°±é€²å…¥åˆ° python code çš„éƒ¨åˆ†\nin_if = sys.argv [1] out_if = sys.argv [2] ip = pyroute2.IPRoute () out_idx = ip.link_lookup (ifname=out_if)[0] é¦–å…ˆå°‡å…©å¼µç¶²å¡çš„åç¨±è®€é€²ä¾†ï¼Œæ¥è‘—é€é pyroute2 çš„å·¥å…·å»æ‰¾åˆ° out interface çš„ ifindex\ntx_port = b.get_table (\u0026#34;tx_port\u0026#34;) tx_port [0] = ct.c_int (out_idx) æ¥è‘—æ˜¯è¨­å®š tx_port é€™å¼µ DEVMAP çš„ key 0 ç‚º out interface çš„ indexï¼Œå› æ­¤æ‰€æœ‰ç¶“é eBPF ç¨‹å¼çš„å°åŒ…éƒ½æœƒä¸Ÿåˆ° out interface\nin_fn = b.load_func (\u0026#34;xdp_redirect_map\u0026#34;, BPF.XDP) out_fn = b.load_func (\u0026#34;xdp_dummy\u0026#34;, BPF.XDP) b.attach_xdp (in_if, in_fn, flags) b.attach_xdp (out_if, out_fn, flags) æ¥è‘—å°±æ˜¯å°‡ eBPF ç¨‹å¼ attach åˆ°å…©å¼µç¶²å¡ä¸Š\nrxcnt = b.get_table (\u0026#34;rxcnt\u0026#34;) prev = 0 while 1: val = rxcnt.sum(0).value if val: delta = val - prev prev = val print(\u0026#34;{} pkt/s\u0026#34;.format(delta)) time.sleep (1) å°‡ eBPF ç¨‹å¼ attach ä¸Šå»ä¹‹å¾Œå°±å®Œæˆäº†å°åŒ…é‡å°å‘çš„å·¥ä½œï¼Œå‰©ä¸‹çš„éƒ¨åˆ†æ˜¯ç”¨ä¾†çµ±è¨ˆæ¯ç§’é˜ç¶“éçš„å°åŒ…çš„ï¼Œé€™é‚Šçš„åšæ³•å¾ˆç°¡å–®ï¼Œæ¯ç§’é˜éƒ½å»ç´€éŒ„ä¸€æ¬¡é€šéå°åŒ…ç¸½é‡å’Œå‰ä¸€ç§’é˜çš„å·®ç•°å°±å¯ä»¥ç®—å‡ºä¾†é€™ä¸€ç§’å…§ç¶“éçš„å°åŒ…æ•¸é‡ã€‚é€™é‚Šæ¯”è¼ƒç‰¹åˆ¥çš„æ˜¯ rxcnt.sumï¼Œå‰é¢æåˆ° rxcnt æ˜¯ä¸€å€‹ per cpu çš„ mapï¼Œå› æ­¤é€™é‚Šä½¿ç”¨ sum å‡½æ•¸å°‡æ¯é¡† cpu çš„ key 0 ç›´æ¥ç›¸åŠ èµ·ä¾†ï¼Œå°±å¯ä»¥å¾—åˆ°ç¶“éæ‰€æœ‰ CPU çš„å°åŒ…ç¸½é‡ã€‚\n","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-6-xdp-bcc-xdp-redirect-map/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 6 - XDP \u0026 BCC xdp_redirect_map","type":"posts"},{"content":"æ¥çºŒå‰ä¸€ç¯‡ä¸»é¡Œ XDPï¼Œä»Šå¤©æˆ‘å€‘è¦ç¹¼çºŒä¾†èŠèŠ eBPF åœ¨ linux netowrk data path ä¸Šçš„å¦å¤–ä¸€å€‹é€²å…¥é» tcï¼Œä¸¦åŒæ¨£ä»¥ bcc çš„ neighbor_sharingÂ ä½œç‚ºç¯„ä¾‹ã€‚\nLinux tc ä»‹ç´¹ # é¦–å…ˆæˆ‘å€‘è¦å…ˆèŠèŠ tcÂ æ˜¯ä»€éº¼æ±è¥¿ã€‚Traffic Control (tc) æ˜¯ linux kernel ç¶²è·¯ç³»çµ±è£¡é¢å’Œ netfilter/iptables åŒç­‰é‡è¦çš„ä¸€å€‹çµ„ä»¶ã€‚ä¸é netfilter ä¸»è¦è‘—é‡åœ¨ packet mangling (å°åŒ…ä¿®æ”¹) å’Œ filter (éæ¿¾)ã€‚è€Œ tc çš„é‡é»æ˜¯åœ¨èª¿æ§æµé‡ï¼Œæä¾›é™é€Ÿã€æ•´å½¢ç­‰åŠŸèƒ½ã€‚\ntc çš„å·¥ä½œæ™‚æ©Ÿé»åˆ†æˆ ingress tcÂ å’Œ egress tcï¼Œä»¥ ingress tcÂ ä¾†èªªï¼Œä»–ç™¼ç”Ÿåœ¨ skb allocation ä¹‹å¾Œï¼Œé€²å…¥ netfilter ä¹‹å‰ã€‚ingress tcÂ ä¸»è¦ç”¨æ–¼è¼¸å…¥æµé‡æ§åˆ¶ï¼Œegress tcÂ å‰‡ç”¨æ–¼æµé‡å„ªå…ˆç´šã€QoS çš„åŠŸèƒ½ã€‚åœ¨å‚³çµ±ä½¿ç”¨ä¸Šï¼Œtc æ›´ä¸»è¦æ˜¯ç”¨åœ¨ egress tcï¼Œingress tcÂ æœ¬èº«æœ‰æ¯”è¼ƒå¤§çš„åŠŸèƒ½é™åˆ¶ã€‚\nåœ¨ tcÂ è£¡é¢æœ‰ä¸‰å€‹ä¸»è¦çš„æ¦‚å¿µï¼Œqdiscã€classÂ å’Œ filter (classifier)ã€‚\ntc çš„åŸºç¤æ˜¯ queueï¼Œå°åŒ…è¦é€²å‡ºä¸»æ©Ÿæ™‚ï¼Œæœƒå…ˆé€²å…¥ queueï¼Œæ ¹æ“šç‰¹å®šçš„ç­–ç•¥é‡æ–°æ’åºã€åˆªé™¤ã€å»¶é²å¾Œå†äº¤çµ¦ç¶²å¡é€å‡ºï¼Œæˆ– netfilter ç­‰ç³»çµ±æ”¶å…¥ã€‚\nqdiscÂ æ˜¯å¥—ç”¨åœ¨é€™å€‹ queue ä¸Šé¢çš„ç­–ç•¥è¦å‰‡ã€‚ä¸‹åˆ—èˆ‰ä¾‹ä¸€éƒ¨ä»½ï¼š\næœ€åŸºæœ¬çš„ç­–ç•¥è¦å‰‡æ˜¯ pfifoï¼Œå°±æ˜¯ä¸€å€‹ç°¡å–®çš„ FIFO queueï¼Œåªèƒ½è¨­å®š queue çš„å¯å„²å­˜çš„å°åŒ…å¤§å°å’Œå°åŒ…å€‹æ•¸ã€‚ æ›´é€²éšçš„å¦‚ pfifo_fastï¼Œæœƒæ ¹æ“š ip å°åŒ…å…§çš„ ToSÂ æ¬„ä½å°‡å°åŒ…åˆ†æˆä¸‰å€‹å„ªå…ˆåº¦ï¼Œæ¯å€‹å„ªå…ˆåº¦å…§æ˜¯èµ° FIFO è¦å‰‡ï¼Œä½†æ˜¯æœƒå„ªå…ˆæ¸…ç©ºé«˜å„ªå…ˆåº¦çš„å°åŒ…ã€‚ sfqÂ å‰‡æ˜¯æœƒæ ¹æ“š tcp/udp/ip æ¬„ä½ hash çš„çµæœå€åˆ†å‡ºä¸åŒçš„é€£ç·šï¼Œå°‡ä¸åŒé€£ç·šçš„å°åŒ…æ”¾å…¥ç¨ç«‹çš„ bucket å…§ï¼Œç„¶å¾Œ bucket é–“ä½¿ç”¨è¼ªå°‹çš„æ–¹å¼ï¼Œä¾†è®“ä¸åŒé€£ç·šå‡ç­‰çš„è¼¸å‡ºã€‚ ingress æ˜¯å°ˆé–€ç”¨åœ¨ ingress tc çš„ qdisc ä¸Šé¢çš„ qdisc éƒ½æ­¸ç‚º classless QDiscï¼Œå› ç‚ºæˆ‘å€‘ä¸èƒ½é€éè‡ªå®šç¾©çš„æ–¹å¼å°æµé‡é€²è¡Œåˆ†é¡ï¼Œæä¾›ä¸åŒçš„ç­–ç•¥ã€‚ èˆ‡ classless ç›¸åçš„æ˜¯ classful qdiscï¼Œåœ¨ classful qdisc å…§ï¼Œæˆ‘å€‘å¯ä»¥ä»¥å®šç¾©å‡ºå¤šå€‹ classï¼Œé‡å°ä¸åŒçš„ class è¨­å®šä¸åŒçš„é™é€Ÿç­–ç•¥ç­‰è¦å‰‡ã€‚ä¹Ÿå¯ä»¥å°‡å¤šå€‹ class é™„å±¬åœ¨å¦å¤–ä¸€å€‹ class ä¸‹ï¼Œè®“å­ class å…±ç”¨ä¸€å€‹çˆ¶ class çš„æœ€å¤§ç¸½é™é€Ÿè¦å‰‡ï¼Œä½†æ˜¯å­åˆ†é¡åˆç¨ç«‹æœ‰é™é€Ÿè¦å‰‡ç­‰ç­‰ã€‚\nè€Œè¦å°æµé‡é€²è¡Œåˆ†é¡å°±æœƒç”¨åˆ° filter, å°æ–¼æŸå€‹ qdisc (classless/classful çš†å¯) æˆ–è‘—çˆ¶ class ä¸Šçš„å°åŒ…ï¼Œå¦‚æœæ»¿è¶³ filter çš„æ¢ä»¶ï¼Œå°±å¯ä»¥æŠŠå°åŒ…æ­¸åˆ°æŸå€‹ class ä¸Šã€‚é™¤äº†æ­¸é¡åˆ°æŸå€‹ class ä¸Šï¼Œfilter ä¹Ÿå¯ä»¥è¨­ç½®ç‚ºåŸ·è¡ŒæŸå€‹ actionï¼ŒåŒ…æ‹¬ä¸Ÿæ£„å°åŒ…ã€è¤‡è£½å°åŒ…æµé‡åˆ°å¦å¤–ä¸€å€‹ç¶²è·¯ä»‹é¢ä¸Šä¹‹é¡çš„â€¦\nå°æ–¼ qdisc å’Œ class åœ¨å»ºç«‹æ™‚éœ€æŒ‡å®šæˆ–è‡ªå‹•åˆ†é…ä¸€å€‹åœ¨ç¶²å¡ä¸Šå”¯ä¸€çš„ handle ä½œç‚ºè­˜åˆ¥ idï¼Œæ ¼å¼æ˜¯ \u0026lt;major\u0026gt;:\u0026lt;minor\u0026gt;(æ•¸å­—)ï¼Œå°æ–¼ qdisc ä¾†èªªåªæœ‰ major çš„éƒ¨åˆ† \u0026lt;major\u0026gt;:ï¼Œå° class ä¾†èªª major å¿…é ˆèˆ‡å°æ‡‰ qdisc ç›¸åŒã€‚\nå¦å¤–åœ¨ egress pipeline å¯ä»¥æœ‰å¤šå€‹ qdiscï¼Œå…¶ä¸­ä¸€å€‹ä½œç‚º rootï¼Œå…¶ä»–çš„è—‰ç”± filter å¾ root qdisc dispatch éå»ï¼Œæ‰€ä»¥éœ€è¦æœ‰ major é€™å€‹æ¬„ä½ã€‚\nåœ¨ linux ä¸Šé¢ä¸»è¦é€é tcÂ é€™å€‹æŒ‡ä»¤ä¾†è¨­ç½® qdiscã€classÂ å’Œ filterã€‚\n# æ·»åŠ  eth0 egress çš„ root qdiscï¼Œé¡å‹æ˜¯ htbï¼Œå¾Œé¢æ˜¯ htb çš„åƒæ•¸ tc qdisc add dev enp0s3 root handle 1: htb default 30 # æ·»åŠ  eth çš„ ingress qdisc tc qdisc add dev enp0s3 ingress # è¨­ç½®ä¸€å€‹ classï¼Œé€Ÿåº¦ä¸Šä¸‹é™éƒ½æ˜¯ 20mbpsï¼Œé™„å±¬æ–¼ eth0 çš„ root qdisc (1:) ä¸‹ tc class add dev enp0s3 partent 1: classid 1:1 htb rate 20mbit ceil 20mbit # ç•¶å°åŒ…ç‚º ip, dst port 80 æ™‚åˆ†é¡åˆ°ä¸Šè¿°åˆ†é¡ tc filter add dev enp0s3 protocol ip parent 1: prio 1 u32 match ip dport 80 0xffff flowid 1:1 # æŸ¥çœ‹ egress filter tc filter show dev eth0 # æŸ¥çœ‹ ingress filter tc filter show dev eth0 ingress eBPF èˆ‡ tc # eBPF åœ¨ tc ç³»çµ±è£¡é¢æ˜¯åœ¨ filterÂ çš„éƒ¨åˆ†ä½œç”¨ï¼Œä¸¦å¯åˆ†æˆå…©ç¨®æ¨¡å¼ï¼Œclassifier (BPF_PROG_TYPE_SCHED_CLS) å’Œ action (BPF_PROG_TYPE_SCHED_ACT)ã€‚\nclassifier: å‰è€…åˆ†æå°åŒ…å¾Œï¼Œæ±ºå®šæ˜¯å¦ matchï¼Œä¸¦å¯ä»¥å°‡å°åŒ…åˆ†é¡çµ¦é€é tc æŒ‡ä»¤é è¨­çš„ classid æˆ–è‘—é‡æ–°æŒ‡å®š classidã€‚ 0: mismatch 1: match, ä½¿ç”¨ filter é è¨­çš„ classid ç›´æ¥å›å‚³ä¸€å€‹ classid action: ä½œç‚ºè©² filterÂ çš„ actionï¼Œç•¶ tc è¨­ç½®çš„ filter è¦å‰‡ match å¾Œï¼Œå‘¼å« eBPF ç¨‹å¼æ±ºå®š action æ˜¯ drop (2), åŸ·è¡Œé è¨­ action (-1) ç­‰ã€‚ä¸‹åˆ—æ˜¯ action çš„å®Œæ•´å®šç¾© #define TC_ACT_UNSPEC\t(-1) #define TC_ACT_OK\t0 #define TC_ACT_RECLASSIFY\t1 #define TC_ACT_SHOT\t2 #define TC_ACT_PIPE\t3 #define TC_ACT_STOLEN\t4 #define TC_ACT_QUEUED\t5 #define TC_ACT_REPEAT\t6 #define TC_ACT_REDIRECT\t7 #define TC_ACT_JUMP\t0x10000000 BCC neighbor_sharing # ä»‹ç´¹ # é€™æ¬¡è¦çœ‹çš„æ˜¯ examples/networking/neighbor_sharingã€‚(åŸå§‹ç¢¼)\né€™æ¬¡çš„ eBPF ç¨‹å¼æœƒæä¾› QoS çš„æœå‹™ï¼Œå°ç¶“éæŸå¼µç¶²å¡çš„é‡å°å¾€ç‰¹å®šçš„ IP æä¾›ä¸åŒçš„é™é€Ÿç¾¤çµ„ã€‚\n/------------\\ | neigh1 --|-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-| | | neigh2 --|-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-| \u0026lt;-128kb-| /------\\ | neigh3 --|-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-| | wan0 | wan | | | ^ | br100 |-\u0026lt;-\u0026lt;-\u0026lt;--| sim | | | clsfy_neigh () | | ^ \\------/ | lan1 ----|-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-| \u0026lt;--1Mb--| | | lan2 ----|-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-\u0026gt;-| | classify_wan () | ^ \\------------/ | pass () | ä¸Šåœ–æ˜¯ neighbor_sharing è‡ªå¸¶çš„ç¶²è·¯æ‹“è­œåœ–ï¼Œneight1-3, lan1-2, wan0 æ˜¯ç¨ç«‹çš„ network namespace æ“æœ‰ç¨ç«‹çš„ IPï¼Œneighbor_sharing æœƒåœ¨ wansim åˆ° br100 çš„ä»‹é¢ä¸Šå»ºç«‹ ingress tcï¼Œé‡å° neigh1-3 çš„ IP æä¾›ç¸½å…± 128kb/s çš„ç¶²è·¯é€Ÿåº¦ï¼Œå°å…¶ä»– IP æä¾›ç¸½å…± 1024kb/s çš„ç¶²è·¯é€Ÿåº¦ã€‚\né¦–å…ˆåœ¨æ¸¬è©¦ä¹‹å‰è¦å…ˆå®‰è£ pyroute2 å’Œ netperfï¼Œå‰è€…æ˜¯ python æ¥æ¥ tc æŒ‡ä»¤çš„ libraryï¼Œå¾Œè€…æ˜¯ç”¨ä¾†æ¸¬è©¦ç¶²é€Ÿçš„å·¥å…·ã€‚å¦å¤–è¦è¨˜å¾—è¨­ç½®é˜²ç«ç‰†è¦å‰‡ä¸ç„¶ br100 ä¸æœƒè½‰ç™¼å°åŒ…\npip3 install pyroute2 apt install netperf iptables -P FORWARD ACCEPT sysctl -w net.ipv4.ip_forward=1 neight1-3 æœƒè¢«åˆ†é… 172.16.1.100-102 çš„ IP, lan å‰‡æ˜¯ 172.16.1.150-151ã€‚\nsudo ip netns exec wan0 netperf -H 172.16.1.100 -l 2 -k MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.100 () port 0 AF_INET : demo Recv Send Send Socket Socket Message Elapsed Size Size Size Time Throughput bytes bytes bytes secs. 10^6bits/sec 131072 16384 16384 6.00 161.45 é€é netperf å¯ä»¥æ¸¬å‡ºä¾†åˆ° neight1 çš„å°åŒ…æµé‡è¢«é™åˆ¶åœ¨ç´„ 161.45 kbits/secã€‚\nip netns exec wan0 netperf -H 172.16.1.150 -l 2 -f k MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.150 () port 0 AF_INET : demo Recv Send Send Socket Socket Message Elapsed Size Size Size Time Throughput bytes bytes bytes secs. 10^3bits/sec 131072 16384 16384 2.67 1065.83 è€Œåˆ° lan1 å¤§ç´„æ˜¯ 1065.83kbits/secï¼Œæ¥è¿‘é å…ˆè¨­ç½®çš„è¦å‰‡ã€‚\npython å¯¦ä½œ # é€™æ¬¡æœƒå…ˆçœ‹ python çš„ç¨‹å¼ç¢¼ï¼Œç”±æ–¼é€™æ¬¡çš„ç¨‹å¼ç¢¼åŒ…å«å¤§é‡ç”¨ä¾†å»ºç«‹æ¸¬è©¦ç’°å¢ƒçš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æœƒè·³éåªçœ‹ç›¸é—œçš„å…§å®¹ã€‚\nb = BPF (src_file=\u0026#34;tc_neighbor_sharing.c\u0026#34;, debug=0) wan_fn = b.load_func (\u0026#34;classify_wan\u0026#34;, BPF.SCHED_CLS) pass_fn = b.load_func (\u0026#34;pass\u0026#34;, BPF.SCHED_CLS) neighbor_fn = b.load_func (\u0026#34;classify_neighbor\u0026#34;, BPF.SCHED_CLS) é¦–å…ˆé€™æ¬¡çš„ eBPF ç¨‹å¼åŒ…å«ä¸‰å€‹éƒ¨åˆ†ï¼Œå› æ­¤æœƒåˆ†åˆ¥è¼‰å…¥ï¼Œä¸¦ä¸”å…¨éƒ¨éƒ½æ˜¯ classifier (BPF_PROG_TYPE_SCHED_CLS)\nipr.tc (\u0026#34;add\u0026#34;, \u0026#34;ingress\u0026#34;, wan_if [\u0026#34;index\u0026#34;], \u0026#34;ffff:\u0026#34;) ipr.tc (\u0026#34;add-filter\u0026#34;, \u0026#34;bpf\u0026#34;, wan_if [\u0026#34;index\u0026#34;], \u0026#34;:1\u0026#34;, fd=wan_fn.fd, prio=1, name=wan_fn.name, parent=\u0026#34;ffff:\u0026#34;, action=\u0026#34;drop\u0026#34;, classid=1, rate=\u0026#34;128kbit\u0026#34;, burst=1024 * 32, mtu=16 * 1024) ipr.tc (\u0026#34;add-filter\u0026#34;, \u0026#34;bpf\u0026#34;, wan_if [\u0026#34;index\u0026#34;], \u0026#34;:2\u0026#34;, fd=pass_fn.fd, prio=2, name=pass_fn.name, parent=\u0026#34;ffff:\u0026#34;, action=\u0026#34;drop\u0026#34;, classid=2, rate=\u0026#34;1024kbit\u0026#34;, burst=1024 * 32, mtu=16 * 1024) æ¥è‘—æœƒå»ºç«‹ wan_if çš„ ingress qdisc (wan_if æ˜¯ wan0 æ¥åˆ° br100 çš„ä»‹é¢)ï¼Œä¸¦ä¸”æœƒ ingress qdisc ä¸‹å»ºç«‹å…©æ¢ filterï¼Œé¦–å…ˆå®ƒçš„ type æŒ‡å®šç‚º bpf ä¸¦é€é fd=wan_fn.fdÂ é¸å®š eBPF programï¼Œæ‰€ä»¥æœƒäº¤ç”± eBPF classifier ä¾†æ±ºå®šæ˜¯ä¸æ˜¯è¦ matchã€‚\nclassifier match å¾Œå°±æœƒåŸ·è¡Œä¸‹å±¬çš„ policing actionï¼Œè·Ÿ classid ç„¡é—œï¼Œä¸”åœ¨é€™æ¬¡çš„ç¯„ä¾‹ä¸­ä¸¦ä¸å­˜åœ¨ classï¼Œæ‰€ä»¥ classid å…¶å¯¦æ˜¯ç„¡æ„ç¾©çš„ï¼Œä¸ä¸€å®šè¦è¨­ç½®ã€‚\nå¾ŒåŠæ®µ action=\u0026quot;drop\u0026quot;, rate=\u0026quot;128kbit\u0026quot;, burst=1024 * 32, mtu=16 * 1024Â å®šç¾©äº†ä¸€æ¢ policing actionï¼Œåªæœ‰ç•¶å°åŒ…æ»¿è¶³ policy æ¢ä»¶æ™‚æ‰æœƒè§¸ç™¼å…·é«”çš„ actionï¼Œé€™é‚ŠæŒ‡å®šæ˜¯æµé‡è¶…å‡º 128kbit æ™‚åŸ·è¡Œ dropï¼Œä¹Ÿå°±é”åˆ°äº†é™åˆ¶ neigh æµé‡çš„æ•ˆæœã€‚\nç¬¬äºŒæ¢åŒç†ï¼Œmatch pass_fn ä¸¦ä¸”æµé‡åˆ°é” 1024kbit æ™‚åŸ·è¡Œ dropï¼Œç”±æ–¼ pass_fn é¡§åæ€ç¾©æ˜¯ç„¡æ¢ä»¶ match çš„æ„æ€ï¼Œæ‰€ä»¥ç­‰åƒ¹æ–¼æ‰€æœ‰é neigh çš„æµé‡å…±ç”¨é€™ä¸€æ¢çš„ 1024kbit æµé‡é™åˆ¶ã€‚\nå› æ­¤ç¸½çµä¾†èªªï¼ŒeBPF ç¨‹å¼ wan_fn é€éæŸç¨®æ–¹å¼åˆ¤æ–·å°åŒ…æ˜¯å¦æ˜¯å¾€ neigh çš„ ipï¼Œæ˜¯çš„è©±å°± match ç¬¬ä¸€æ¢ filter åŸ·è¡Œ policing action ä¾†é™æµï¼Œä¸ç„¶å°± match ç¬¬äºŒæ¢ filter ä¾†åšé™æµã€‚\nret = self._create_ns (\u0026#34;neighbor% d\u0026#34; % i, ipaddr=ipaddr, fn=neighbor_fn, cmd=cmd) æ¥è‘—å°±æœƒçœ‹åˆ°ï¼Œåœ¨å»ºç«‹ neigh1-3 çš„ namespace æ™‚ï¼Œattach äº† neighbor_fn åˆ°ç¶²å¡ä¸Šï¼Œå› æ­¤å°±å¾ˆå¥½ç†è§£äº† neighbor_fn ç›£è½äº†å¾ neigh ç™¼å‡ºçš„å°åŒ…ï¼Œè§£ææ‹¿åˆ° neigh çš„ IP å¾Œï¼Œé€é map share çµ¦ wan_fnï¼Œè®“ wan_fn å¯ä»¥æ ¹æ“š ip æ±ºå®šè¦ä¸è¦ match ç¬¬ä¸€æ¢ policing actionã€‚\neBPF å¯¦ä½œ # åˆ°é€™è£¡å…¶å¯¦å°±åˆ†æå‡ºæ•´å€‹ç¨‹å¼çš„åŸ·è¡Œé‚è¼¯äº†ï¼Œæˆ‘å€‘æ¥çºŒä¾†çœ‹çœ‹ neighbor_sharing çš„ eBPF ç¨‹å¼ï¼Œé€™æ¬¡çš„ eBPF ç¨‹å¼åˆ†æˆä¸‰å€‹éƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯æ¥åœ¨æ¯å€‹ neigh ingress æ–¹å‘çš„ classify_neighborï¼Œæ¥è‘—æ˜¯æ¥åœ¨ wan0 ingress æ–¹å‘çš„ classify_wan å’Œ passã€‚\nå‰é¢èªªåˆ°å‡ºä¾† classify_neighborÂ è¦åšçš„äº‹æƒ…å°±æ˜¯ç´€éŒ„ neigh1-3 çš„ IPï¼Œæä¾›çµ¦ classify_wanÂ åˆ¤æ–·æ˜¯å¦è¦ match å°åŒ…ï¼ŒåŸ·è¡Œ 128kbits çš„æµé‡é™åˆ¶ã€‚\nstruct ipkey { u32 client_ip; }; BPF_HASH (learned_ips, struct ipkey, int, 1024); é¦–å…ˆå®šç¾©äº†ä¸€å€‹ hash map ç”¨ key ä¾†å„²å­˜æ‰€æœ‰ neigh çš„ IP\nint classify_neighbor(struct __sk_buff *skb) { u8 *cursor = 0; ethernet: { struct ethernet_t *ethernet = cursor_advance (cursor, sizeof(*ethernet)); switch (ethernet-\u0026gt;type) { case ETH_P_IP: goto ip; default: goto EOP; } } ip: { struct ip_t *ip = cursor_advance (cursor, sizeof(*ip)); u32 sip = ip-\u0026gt;src; struct ipkey key = {.client_ip=sip}; int val = 1; learned_ips.insert (\u0026amp;key, \u0026amp;val); goto EOP; } EOP: return 1; } æ¥è‘— classify_neighborÂ å°±æœƒç”¨ cursor è§£æå‡º source ipï¼Œå°‡å…¶ä½œç‚º hash map çš„ key æ”¾åˆ° learned_ips è£¡é¢ï¼Œvalue å‰‡éƒ½è¨­ç‚º 1ã€‚ä¸è«–å¦‚ä½•éƒ½æœƒ return 1 æ”¾è¡Œå°åŒ…ã€‚é›–ç„¶å…¶å¯¦é€™æ˜¯ neighbor ingress æ–¹å‘ä¸Šå”¯ä¸€çš„ä¸€æ¢ filterï¼Œæ‰€ä»¥ä¸è«–å›å‚³å€¼ç‚ºå¤šå°‘å…¶å¯¦éƒ½å¯ä»¥ï¼Œä¸å½±éŸ¿åŸ·è¡Œçµæœã€‚\né€™é‚Šå°±è¦æåˆ°ç¬¬ä¸€æ¬¡å­¸ç¿’ tc é‚„æœ‰ classifier æ™‚æœƒæ„Ÿåˆ°å¾ˆå›°æƒ‘çš„åœ°æ–¹äº†ï¼Œé¦–å…ˆ classifier çš„å›å‚³å€¼ 0 è¡¨ç¤º mismatch, 1 è¡¨ç¤º match ä¸¦è½‰ç§»åˆ°é è¨­çš„ classï¼Œå…¶é¤˜å›å‚³å€¼è¡¨ç¤ºç›´æ¥æŒ‡å®š classid ç‚ºå›å‚³çš„æ•¸å€¼ã€‚æ¥è‘—ä¸è«– classid æ˜¯å¤šå°‘ï¼Œéƒ½æœƒåŸ·è¡Œ filter ä¸Šé¢ç¶å®šçš„ actionã€‚åœ¨é€™æ¬¡çš„ç¯„ä¾‹ä¸­ï¼Œæ‰€æœ‰çš„ filter å…¶å¯¦éƒ½ä¸å­˜åœ¨ä»»ä½•çš„ classï¼Œå› æ­¤ return å€¼å”¯ä¸€çš„æ„ç¾©æ˜¯æ§åˆ¶æ˜¯å¦è¦åŸ·è¡Œ actionã€‚é€™é‚Š classify_neighbor ç¶å®šçš„ action æ˜¯ okï¼Œè¡¨ç¤ºæ”¾è¡Œå°åŒ…çš„æ„æ€\nint classify_wan(struct __sk_buff *skb) { u8 *cursor = 0; ethernet: { struct ethernet_t *ethernet = cursor_advance (cursor, sizeof(*ethernet)); switch (ethernet-\u0026gt;type) { case ETH_P_IP: goto ip; default: goto EOP; } } ip: { struct ip_t *ip = cursor_advance (cursor, sizeof(*ip)); u32 dip = ip-\u0026gt;dst; struct ipkey key = {.client_ip=dip}; int *val = learned_ips.lookup (\u0026amp;key); if (val) return *val; goto EOP; } EOP: return 0; } æ¥è‘—çœ‹åˆ° classify_wanï¼Œä»–æœƒæå–å°åŒ…çš„ dst ip addressï¼Œä¸¦å˜—è©¦æœå°‹ learned_ipsï¼Œå¦‚æœæ‰¾çš„åˆ°å°±è¡¨ç¤ºé€™å€‹æ˜¯ neighbor çš„ ipï¼Œå›å‚³ map å°æ‡‰çš„ valueï¼Œå‰é¢æåˆ°æ‰€æœ‰çš„ value éƒ½æœƒè¨­ç½®ç‚º 1ï¼Œå› æ­¤è¡¨ç¤º match çš„æ„æ€ï¼Œä¸ç„¶å°±è·³è½‰åˆ° EOP å›å‚³ 0ï¼Œè¡¨ç¤º mismatchã€‚åŒæ¨£ç”±æ–¼é€™é‚Šä¸å­˜åœ¨ classï¼Œå› æ­¤ value åªè¦æ˜¯é 0 å³å¯ï¼Œåªæ˜¯ç”¨ä¾† match åŸ·è¡Œ policing actionã€‚\nint pass(struct __sk_buff *skb) { return 1; } æœ€å¾Œçš„ passÂ å…¶å¯¦å°±æ˜¯ä¸€æ¢ç„¡æ¢ä»¶å›å‚³ 1 è¡¨ç¤º matchï¼Œä¾†åŸ·è¡Œ wan0 æ–¹å‘ç¬¬äºŒæ¢ 1024kbits/sec çš„é™æµæ”¿ç­–ç”¨çš„ã€‚\ntc èˆ‡ XDP æ¯”è¼ƒ # åœ¨ eBPF è£¡é¢ï¼ŒXDP å’Œ TC å…©å€‹åŠŸèƒ½å¸¸å¸¸è¢«æ‹¿ä¾†ä¸€èµ·è¨è¼ªï¼Œå‰é¢æœ‰æåˆ° eBPF å¯ä»¥åšç‚º tc actions ä½¿ç”¨ä¾†é”åˆ°å°åŒ…éæ¿¾ä¹‹é¡çš„æ•ˆæœï¼Œé›–ç„¶å¯¦è¡Œæ•ˆæœä¸Šæ˜¯æ¯”ä¸ä¸Š XDP çš„ï¼Œä½†æ˜¯ tc ingress çš„ eBPF hook point ä¹Ÿåœ¨ kernel data path çš„æœ€æ—©æœŸï¼Œå› æ­¤ä¹Ÿèƒ½å¤ æä¾›ä¸éŒ¯çš„æ•ˆèƒ½ï¼ŒåŠ ä¸Š tc ebpf program çš„ context æ˜¯ sk_buffï¼Œç›¸è¼ƒæ–¼ xdp_buffï¼Œå¯ä»¥ç›´æ¥é€é __sk_buffÂ å–å¾—å’Œä¿®æ”¹æ›´å¤šçš„ meta dataï¼ŒåŠ ä¸Š tc åœ¨ ingress å’Œ egress æ–¹å‘éƒ½æœ‰ hook pointï¼Œä¸åƒ XDP åªèƒ½ä½œç”¨åœ¨ ingress æ–¹å‘ï¼Œä¸” tc å®Œå…¨ä¸éœ€è¦é©…å‹•æ”¯æ´å³å¯å·¥ä½œï¼Œå› æ­¤ tc åœ¨ä½¿ç”¨å½ˆæ€§å’Œéˆæ´»åº¦ä¸Šæ˜¯æ¯” XDP æ›´å å„ªçš„ã€‚\nä¸é tc å…¶å¯¦ä¹Ÿæœ‰æä¾› offload çš„åŠŸèƒ½ï¼Œå°‡ eBPF ç¨‹å¼ offload åˆ°ç¶²å¡ä¸Šé¢åŸ·è¡Œã€‚\nDirect action # ç„¶è€Œç”±æ–¼ tc çš„ hook point åˆ†æˆ classifier å’Œ action å› æ­¤ç„¡æ³•é€éå–®ä¸€å€‹ eBPF ç¨‹å¼åšåˆ° match-action çš„æ•ˆæœï¼Œç„¶è€Œå¤§å¤šæ•¸æ™‚å€™ eBPF tc ç¨‹å¼çš„é–‹ç™¼ä¸¦ä¸æ˜¯è¦åˆ©ç”¨ tc ç³»çµ±çš„åŠŸèƒ½åšé™é€Ÿç­‰åŠŸèƒ½ï¼Œè€Œæ˜¯è¦åˆ©ç”¨ tc åœ¨ kernel path æ¥µæ—©æœŸé€™é»åš packet mangling å’Œ filter ç­‰äº‹é …ï¼Œå†åŠ ä¸Š tc ç³»çµ±çš„ä½¿ç”¨å­¸ç¿’é›£åº¦ç›¸å°é«˜ï¼Œå› æ­¤ eBPC åœ¨ tc å¾Œå¼•å…¥äº† direct-actionÂ å’Œ clsactÂ é€™å…©å€‹åŠŸèƒ½ã€‚\né¦–å…ˆä»‹ç´¹ direct-action (da)ï¼Œé€™å€‹æ˜¯åœ¨ classifier (BPF_PROG_TYPE_SCHED_CLS) å¯å•Ÿç”¨çš„ä¸€å€‹é¸é …ï¼Œå¦‚æœå•Ÿç”¨ daï¼Œclassifier çš„å›å‚³å€¼å°±è®Šæˆæ˜¯ actionï¼Œå’Œ BPF_PROG_TYPE_SCHED_ACT ç›¸åŒï¼Œè€ŒåŸæœ¬çš„ classid æ”¹æˆè¨­ç½®__skb_buff-\u0026gt;tc_classid ä¾†å‚³è¼¸ã€‚\nåœ¨ kernel code å…§ä½¿ç”¨ prog-\u0026gt;exts_integrated æ¨™ç¤ºæ˜¯å¦å•Ÿç”¨ da åŠŸèƒ½\né€é da å¯ä»¥é€éå–®ä¸€å€‹ eBPF ç¨‹å¼å®Œæˆ classifier å’Œ action çš„åŠŸèƒ½ï¼Œé™ä½äº† tc hook point å°åŸæœ¬ tc ç³»çµ±æ¡†æ¶çš„ä¾è³´ï¼Œèƒ½å¤ é€é eBPF ç¨‹å¼ç°¡æ½”çš„å®ŒæˆåŠŸèƒ½ã€‚\nåœ¨ da çš„ä½¿ç”¨ä¸Šå¯ä»¥åƒè€ƒ bcc çš„ç¯„ä¾‹ examples/networking/tc_perf_event.pyï¼Œä½¿ç”¨ä¸Šèˆ‡æ™®é€šçš„ classifer å¹¾ä¹ç„¡ç•°ï¼Œåªè¦åœ¨è¼‰å…¥æ™‚ ipr.tc (\u0026quot;add-filter\u0026quot;,\u0026quot;bpf\u0026quot;, me,\u0026quot;:1\u0026quot;, fd=fn.fd, ... ,direct_action=True)Â åŠ ä¸Š direct_action é¸é …å³å¯ã€‚\né€é tc æŒ‡ä»¤æŸ¥çœ‹æ™‚ä¹Ÿå¯ä»¥çœ‹åˆ° direct-actionÂ å­—æ¨£ã€‚\ntc filter show dev t1a filter parent 1: protocol all pref 49152 bpf chain 0 filter parent 1: protocol all pref 49152 bpf chain 0 handle 0x1 flowid :1 hello direct-action not_in_hw id 308 tag 57cd311f2e27366b jited action order 1: gact action pass random type none pass val 0 index 2 ref 1 bind 1 clsact # å¾Œä¾† tc åŠ å…¥äº† clsactï¼Œclsact æ˜¯ä¸€å€‹å°ˆç‚º eBPF è¨­è¨ˆçš„å½ qdiscã€‚é¦–å…ˆ clsact åŒæ™‚ä½œç”¨åœ¨ ingress å’Œ egress æ–¹å‘ï¼Œä¹Ÿé€²ä¸€æ­¥ç°¡åŒ–äº† ebpf ç¨‹å¼çš„æ›è¼‰ã€‚\ntc qdisc add dev em1 clsact tc filter add dev em1 ingress bpf da obj tc-example.o sec ingress tc filter add dev em1 egress bpf da obj tc-example.o sec egress åŒæ™‚ clsact å·¥ä½œåœ¨çœŸçš„ qdisc æœ¬èº«çš„ lock ä¹‹å‰ï¼Œå› æ­¤å¯ä»¥é¿å… lock çš„é–‹éŠ·ï¼Œé å…ˆå®Œæˆæ¯”è¼ƒè¤‡é›œç¹é‡çš„å°åŒ…åˆ†é¡ï¼Œåœ¨é€²å…¥åˆ°çœŸçš„ queue filter æ™‚åªæ ¹æ“šæ›´ç°¡å–®çš„æ¬„ä½ (å¦‚ tc_index) åšåˆ†é¡ã€‚å¦å¤– da æœ¬ä¾†åªèƒ½ä½¿ç”¨åœ¨ ingress æ–¹å‘ï¼Œé€é clsactï¼Œda å¯ä»¥å·¥ä½œåœ¨ egress æ–¹å‘ã€‚\né—œæ–¼ eBPF tc çš„éƒ¨åˆ†å°±å¤§è‡´ä¸Šä»‹ç´¹åˆ°é€™è£¡ï¼Œå°æ–¼ tc é€™å€‹å­ç³»çµ±ç›¸å°ä¾†èªªæ˜¯çœŸçš„è »é™Œç”Ÿçš„ï¼Œå› æ­¤ä»‹ç´¹é€™å€‹éƒ¨åˆ†çš„ç¢ºæ˜¯æœ‰æ¯”è¼ƒå¤§çš„é›£åº¦å’Œèªªä¸æ¸…æ¥šçš„åœ°æ–¹ã€‚\nåƒè€ƒè³‡æ–™ # Classifying packets with filters tc man page ç”¨ tc qdisc ç®¡ç† Linux ç½‘ç»œå¸¦å®½ TC (Traffic Control) å‘½ä»¤ Linux TC (Traffic Control) ç®€ä»‹ ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-7-tc-bcc-neighbor-sharing/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 7 - tc \u0026 BCC neighbor_sharing","type":"posts"},{"content":"æœ¬ç¯‡æ˜¯ BCC å­¸ç¿’æ­·ç¨‹çš„æœ€å¾Œä¸€ç¯‡ï¼Œé€™ç¯‡æ–‡ç« æœƒä»‹ç´¹ linux cgroupsã€eBPF socketmap çš„åŠŸèƒ½ï¼Œä¸¦ä»¥ sockmap.pyÂ ä½œç‚ºç¯„ä¾‹ã€‚\ncgroups ä»‹ç´¹ # cgroups æ˜¯ Linux kernel å…§å»ºçš„ä¸€å€‹æ©Ÿåˆ¶ï¼Œå¯ä»¥ä»¥é€²ç¨‹ç‚ºæœ€å°å–®ä½ï¼Œå°å¯ä½¿ç”¨çš„ CPUã€memoryã€è£ç½® I/O ç­‰è³‡æºé€²è¡Œé™åˆ¶ã€åˆ†å‰²ã€‚\ncgroups ç›®å‰æœ‰ v1 å’Œ v2 å…©å€‹ç‰ˆæœ¬ï¼Œåœ¨åˆ†çµ„ç­–ç•¥æ¶æ§‹ä¸Šæœ‰æ‰€å·®ç•°ï¼Œé€™é‚Šä»‹ç´¹åªä»¥ v1 ç‚ºä¸»\nåœ¨ cgroup çš„æ¶æ§‹å…§ï¼Œæˆ‘å€‘å¯ä»¥é‡å°ä¸åŒçš„è³‡æºé¡å‹é€²è¡Œç¨ç«‹ç®¡ç† (ç¨±ç‚ºä¸åŒçš„ subsystem æˆ– controller) ï¼Œä¸€äº›å¯èƒ½çš„è³‡æºé¡å‹å’Œä¸€éƒ¨ä»½çš„åŠŸèƒ½ç°¡ä»‹å¦‚ä¸‹\ncpu: å°ä¸€å®šæ™‚é–“é€±æœŸå…§ï¼Œå¯ä½¿ç”¨çš„ cpu æ™‚é–“é•·åº¦é™åˆ¶ memory: é™åˆ¶è¨˜æ†¶é«”ä½¿ç”¨ä¸Šé™ä»¥åŠè¶…å‡ºä¸Šé™æ™‚çš„è¡Œç‚º blkio: æ§åˆ¶å°ç¡¬ç¢Ÿç­‰è¨­å‚™çš„è¨ªå•é€Ÿåº¦ä¸Šé™ cpuacct: ç”¨ä¾†çµ±è¨ˆç›®å‰çš„ CPU ä½¿ç”¨æƒ…æ³ devices: æ§åˆ¶å¯ä»¥è¨ªå•é‚£äº› device pids: é™åˆ¶ cgroup å…§å¯å»ºç«‹çš„ pid æ•¸é‡ï¼Œä¹Ÿå°±æ˜¯é€²ç¨‹æ•¸é‡ æ¥è‘—æ˜¯ hierarchyï¼Œcgroup ä½¿ç”¨æ¨¹ç‹€çµæ§‹ä¾†ç®¡ç†è³‡æºï¼Œä¸€å€‹ hierarchyÂ é è¨­æœƒæœ‰ä¸€å€‹æ ¹çµé»ï¼Œæ‰€æœ‰çš„ process (pid éƒ½æœƒ attach åœ¨é€™å€‹ç¯€é»ä¸Š)ã€‚\nä¸€å€‹ hierarchyÂ å¯ä»¥å°æ‡‰åˆ°é›¶å€‹æˆ–å¤šå€‹ä¸Šè¿°çš„ subsystemï¼Œä¸¦åœ¨ä¸€å€‹ç¯€é»å…§è¨­ç½®ä¸Šè¿°çš„é‚£äº›é™åˆ¶ï¼Œé‚£é€™äº›é™åˆ¶å°±æœƒå¥—ç”¨åˆ°åœ¨é€™å€‹ç¯€é»å…§çš„æ‰€æœ‰ processã€‚\nå¯ä»¥åœ¨ hierarchyÂ å…§å»ºç«‹å­ç¯€é»ï¼Œé‚£å­ç¯€é»å°±æœƒé è¨­å¥—ç”¨çˆ¶ç¯€é»çš„æ‰€æœ‰è¨­ç½®ï¼Œç„¶å¾Œå¯ä»¥åªé‡å°æœ‰èˆˆè¶£çš„é …ç›®ä½œæ›´ç´°ç·»çš„èª¿æ­£ã€‚\nä¸€å€‹ process åœ¨ä¸€æ£µ hierarchyÂ åªèƒ½ attach åœ¨ä¸€å€‹ç¯€é»ä¸Šï¼Œå¯ä»¥å° process è¨­å®šæ‰€åœ¨çš„ç¯€é»ã€‚å¾ process fork å‡ºä¾†çš„ process æœƒåœ¨åŒä¸€å€‹ç¯€é»ä¸Šï¼Œä½†æ˜¯æ¬é‹ process åˆ°ä¸åŒçš„ç¯€é»ï¼Œä¸¦ä¸æœƒå½±éŸ¿å­ processã€‚\nLinux é€éè™›æ“¬æª”æ¡ˆç³»çµ±ä¾†æä¾›ä¿®æ”¹èª¿æ•´ cgroups çš„ user space ä»‹é¢ã€‚é€šå¸¸ä¾†èªªä»‹é¢æœƒè¢«æ›è¼‰åœ¨ /sys/fs/cgroupÂ é€™å€‹è·¯å¾‘ä¸‹ã€‚\næˆ‘å€‘å¯ä»¥é€é mount ä¾†å»ºç«‹ hierarchyÂ ä¸¦æŠŠä»–é—œé€£åˆ°ä¸€å€‹æˆ–å¤šå€‹ subsystem\n# é—œé€£åˆ° CPU mkdir /sys/fs/cgroup/cpu mount -t cgroup -o cpu none /sys/fs/cgroup/cpu # é—œé€£åˆ° CPU å’Œ CPUACCT mkdir /sys/fs/cgroup/cpu,cpuacct mount -t cgroup -o cpu,cpuacct none /sys/fs/cgroup/cpu,cpuacct # ä¸é /sys/fs/cgroup ç›®éŒ„å¯èƒ½æœƒè¢«ç³»çµ±è¨­ç½®ç‚º \u0026lt; span class=\u0026#34;hljs-built_in\u0026#34;\u0026gt;read onlyï¼Œé¿å…éš¨æ„è®Šæ›´ï¼Œè€Œä¸”é€šå¸¸ä¸éœ€è¦å¢æ¸› hierarchy æœ¬èº«ï¼Œåªæ˜¯åœ¨ hierarchy å…§å¢æ¸›ç¯€é»ç®¡ç† æŸ¥çœ‹æ‰€æœ‰ç›®å‰çš„ hierarchy\nls /sys/fs/cgroup/-l total 0 dr-xr-xr-x 4 root root 0 å 11 22:50 blkio lrwxrwxrwx 1 root root 11 å 11 22:50 cpu -\u0026gt; cpu,cpuacct lrwxrwxrwx 1 root root 11 å 11 22:50 cpuacct -\u0026gt; cpu,cpuacct dr-xr-xr-x 4 root root 0 å 11 22:50 cpu,cpuacct dr-xr-xr-x 2 root root 0 å 11 22:50 cpuset dr-xr-xr-x 4 root root 0 å 11 22:50 devices dr-xr-xr-x 2 root root 0 å 11 22:50 freezer dr-xr-xr-x 2 root root 0 å 11 22:50 hugetlb dr-xr-xr-x 4 root root 0 å 11 22:50 memory dr-xr-xr-x 2 root root 0 å 11 22:50 misc lrwxrwxrwx 1 root root 16 å 11 22:50 net_cls -\u0026gt; net_cls,net_prio dr-xr-xr-x 2 root root 0 å 11 22:50 net_cls,net_prio lrwxrwxrwx 1 root root 16 å 11 22:50 net_prio -\u0026gt; net_cls,net_prio dr-xr-xr-x 2 root root 0 å 11 22:50 perf_event dr-xr-xr-x 4 root root 0 å 11 22:50 pids dr-xr-xr-x 2 root root 0 å 11 22:50 rdma dr-xr-xr-x 5 root root 0 å 11 22:50 systemd dr-xr-xr-x 5 root root 0 å 11 22:50 unified æ¥è‘—æŸ¥çœ‹ cpu çš„æ ¹çµé»\nls /sys/fs/cgroup/cpu/-l total 0 -rw-r--r-- 1 root root 0 å 11 21:39 cgroup.clone_children -rw-r--r-- 1 root root 0 å 11 21:39 cgroup.procs -r--r--r-- 1 root root 0 å 11 21:39 cgroup.sane_behavior -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.stat -rw-r--r-- 1 root root 0 å 11 21:39 cpuacct.usage -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_all -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_percpu -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_percpu_sys -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_percpu_user -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_sys -r--r--r-- 1 root root 0 å 11 21:39 cpuacct.usage_user -rw-r--r-- 1 root root 0 å 11 21:39 cpu.cfs_period_us -rw-r--r-- 1 root root 0 å 11 21:39 cpu.cfs_quota_us -rw-r--r-- 1 root root 0 å 11 21:39 cpu.shares -r--r--r-- 1 root root 0 å 11 21:39 cpu.stat drwxr-xr-x 4 root root 0 å…« 24 14:50 docker -rw-r--r-- 1 root root 0 å 11 21:39 notify_on_release -rw-r--r-- 1 root root 0 å 11 21:39 release_agent drwxr-xr-x 96 root root 0 å 11 06:05 system.slice -rw-r--r-- 1 root root 0 å 11 21:39 tasks drwxr-xr-x 2 root root 0 å 11 21:31 user.slice ç”±æ–¼å‰é¢å¯ä»¥çœ‹åˆ° cpu è¢« link åˆ° cpu,cpuacctï¼Œæ‰€ä»¥å¯ä»¥åŒæ™‚æŸ¥çœ‹åˆ° cpu._ å’Œ cpuacct._ çš„é¸é …ã€‚\né€é cpu.cfs_quota_us å’Œ cpu.cfs_period_us æˆ‘å€‘å°±èƒ½æ§åˆ¶é€™å€‹ç¯€é»ä¸Šæ‰€æœ‰ process åœ¨ period å…§å¯ä½¿ç”¨çš„ CPU æ™‚é–“ (quota)ã€‚\né€é cat tasksÂ æˆ‘å€‘å¯ä»¥çœ‹åˆ°æ‰€æœ‰ attach åœ¨é€™å€‹ç¯€é»ä¸Šçš„ pidã€‚\nå¯ä»¥çœ‹åˆ°æœ‰ä¸‰å€‹è³‡æ–™å¤¾ docker,Â system.slice,Â user.sliceï¼Œæ˜¯ä¸‰å€‹ hierarchy ä¸Šçš„å­ç¯€é»ï¼Œæˆ‘å€‘å¯ä»¥ç°¡å–®çš„é€é mkdirÂ çš„æ–¹å¼å»ºç«‹å­ç¯€é»ã€‚ç”±æ–¼é€™å°è¨­å‚™ä¸Šæœ‰è·‘ dockerï¼Œæ‰€ä»¥ docker æœƒåœ¨ /sys/fs/cgroup/cpu/docker/ ç›®éŒ„ä¸‹ç‚ºæ¯å€‹ container å»ºç«‹ç¨ç«‹çš„å­ç¯€é»ï¼Œé€é cgroup çš„æ–¹å¼é™åˆ¶å®¹å™¨çš„è³‡æºä½¿ç”¨é‡ã€‚\ndocker ps --format=\u0026#34;{{.ID}}\u0026#34; 90f64cb70ee0 177d1a3920ec ls /sys/fs/cgroup/cpu/docker -l total 0 drwxr-xr-x 2 root root 0 å…« 24 14:50 177d1a3920ec9.... drwxr-xr-x 2 root root 0 å…« 24 14:50 90f64cb70ee068... -rw-r--r-- 1 root root 0 å 11 21:39 cgroup.clone_children -rw-r--r-- 1 root root 0 å 11 21:39 cgroup.procs ... åœ¨è¨±å¤šç™¼è¡Œç‰ˆä¸Šä½¿ç”¨ systemd ä¾†åšç‚ºæ ¸å¿ƒç³»çµ±ç®¡ç†ç¨‹å¼ï¼Œä¹Ÿå°±æœƒé€é systemd ä¾†ç®¡ç† cgroupï¼Œå› æ­¤åœ¨è¨­ç½® kubelet æ™‚æœƒå»ºè­°å°‡ cgroup driver å¾ cgroupfs æ”¹æˆ systemdï¼Œçµ±ä¸€ç”± systemd ä¾†ç®¡ç†ï¼Œé¿å…åŒæ™‚æœ‰å…©å€‹ç³»çµ±åœ¨èª¿æ•´ cgroup\ncgroup v2 èª¿æ•´äº†ç®¡ç†ä»‹é¢çš„çµæ§‹ï¼Œåªä¿ç•™äº†å–®ä¸€å€‹ hierarchy (/sys/fs/cgroup/unified) ç®¡ç†æ‰€æœ‰çš„ subsystemï¼Œå› ç‚ºåˆ‡å‡ºå¤šå€‹ hierarchy ä¾†ç®¡ç†çš„æ–¹å¼è¢«èªç‚ºæ˜¯ä¸å¿…è¦ä¸”å¢åŠ ç³»çµ±è¤‡é›œåº¦çš„ã€‚\nåˆ°é€™é‚Šå¤§æ¦‚ä»‹ç´¹å®Œäº† cgroupï¼Œç”±æ–¼é€™æ¬¡ sockmap.py ä½¿ç”¨çš„ program type çš„ hook point æœƒåœ¨ cgroup ä¸Šï¼Œæ‰€ä»¥è¶é€™å€‹æ©Ÿæœƒè©³ç´°äº†è§£äº†ä¸€ä¸‹ cgroupã€‚\nsocketmap ä»‹ç´¹ # é€™é‚Šæˆ‘å€‘æ‹¿ Cilium CNIÂ ä»‹ç´¹Â çš„ä¸€å¼µåœ–ä¾†èªªæ˜ã€‚\nåœ–ä¸­æ˜¯ä¸€å€‹ä½¿ç”¨ envoy sidecar çš„ kubernetes pod ç¶²è·¯é€£ç·šç¤ºæ„åœ–ï¼Œç°¡å–®ä¾†èªª kubernetes ä¸Šé¢å®¹å™¨ (Pod) æœå‹™ (Service) çš„ç¶²è·¯æµé‡æœƒé€é iptables çš„æ©Ÿåˆ¶å…¨éƒ¨é‡æ–°å°å‘åˆ°è·‘åœ¨åŒä¸€å€‹å®¹å™¨å…§çš„ sidecarï¼Œé€é sidecar ç•¶ä½œä¸­ä»‹å®Œæˆç¶²è·¯ç›£æ§ã€æœå‹™ç™¼ç¾ç­‰åŠŸèƒ½å¾Œæ‰æœƒçœŸæ­£é›¢é–‹å®¹å™¨ã€‚é€²å…¥å®¹å™¨çš„æµé‡åŒæ¨£å…ˆéƒ½é‡å°å‘åˆ° sidecar è™•ç†ã€‚\né€™æ¨£çš„å¥½è™•æ˜¯å¯ä»¥å®Œå…¨ä¸å° service æœ¬èº«ä¿®æ”¹ï¼Œå®Œå…¨ç”±ç¨ç«‹çš„ sidecar ä¾†æä¾›é™„åŠ çš„ç¶²è·¯åŠŸèƒ½ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€å€‹å¾ˆæ˜é¡¯çš„å•é¡Œï¼Œä¸€å€‹å°åŒ…åœ¨å‚³è¼¸çš„éç¨‹ä¸­ï¼Œè¦ç¶“é 3 æ¬¡ Linux kernel çš„ network stack è™•ç†ï¼Œå¤§å¤§é™ä½äº†å°åŒ…çš„å‚³è¼¸æ•ˆç‡ã€‚\nå…¶ä¸­ç”±æ–¼éƒ½æ˜¯åœ¨åŒä¸€å°è¨­å‚™çš„åŒä¸€å€‹ç¶²è·¯ç©ºé–“å…§å‚³è¼¸ï¼Œå› æ­¤ TPC/IP/ethernet ç­‰åº•å±¤ç¶²è·¯å®Œå…¨å¯ä»¥çœç•¥ã€‚\nå› æ­¤æˆ‘å€‘å¯ä»¥é€é eBPF çš„ socket redirect æŠ€è¡“ä¾†ç°¡åŒ–é€™å€‹å°åŒ…çš„å‚³è¼¸éç¨‹ï¼Œç°¡å–®ä¾†èªªï¼Œåœ¨åŒä¸€å€‹è¨­å‚™çš„å…©å€‹ socket é–“çš„å‚³è¼¸ï¼Œæˆ‘å€‘å®Œå…¨å¯ä»¥ç›´æ¥è·³éåº•å±¤çš„ç¶²è·¯å †ç–Šï¼Œç›´æ¥åœ¨ socket layer å°‡å°åŒ…å…§å®¹å¾ä¸€å€‹ socket æ¬åˆ°å¦å¤–ä¸€å€‹ socketï¼Œè·³éåº•å±¤ TCP/IP/ethernet è™•ç†ã€‚\nsockmap.py ä»‹ç´¹ # bcc çš„ sockmap.pyÂ æä¾›çš„å°±æ˜¯ socket redirect çš„åŠŸèƒ½ï¼Œä»–æœƒç›£è½æ©Ÿå™¨ä¸Šçš„æ‰€æœ‰ socketï¼Œå°‡ local to local çš„ tcp é€£ç·šè³‡æ–™å°åŒ…ç›´æ¥é€é socket redirect çš„æ–¹å¼é€²è¡Œæ¬é‹ã€‚\nsocket redirect æ©Ÿåˆ¶å¥½åƒåŒæ™‚ä¹Ÿç¯€çœäº† packet åœ¨ userspace å’Œ kernel space ä¹‹é–“è¤‡è£½æ¬é‹çš„éç¨‹ï¼Œä¸éé€™ä»¶äº‹æƒ…æ²’æœ‰å®Œå…¨ç¢ºå®šã€‚\næˆ‘å€‘ä¸€æ¨£å…ˆçœ‹çœ‹åŸ·è¡Œèµ·ä¾†æ€éº¼æ¨£ï¼Œæˆ‘å€‘é€é python å»ºç«‹ä¸€å€‹ http server ä¸¦é€é curl ä¾†æ¸¬è©¦\npython3 -m http.server \u0026amp; curl 127.0.0.1:8000 æ¥è‘—æ˜¯ eBPF ç¨‹å¼çš„åŸ·è¡Œçµæœ\npython3 sockmap.py -c /sys/fs/cgroup/unified/ b\u0026#39;curl-3043 [000] d...1 7164.673950: bpf_trace_printk: remote-port: 8000, local-port: 46246\u0026#39; b\u0026#39;curl-3043 [000] dN..1 7164.673973: bpf_trace_printk: Sockhash op: 4, port 46246 --\u0026gt; 8000\u0026#39; b\u0026#39;curl-3043 [000] dNs11 7164.673985: bpf_trace_printk: remote-port: 46246, local-port: 8000\u0026#39; b\u0026#39;curl-3043 [000] dNs11 7164.673988: bpf_trace_printk: Sockhash op: 5, port 8000 --\u0026gt; 46246\u0026#39; b\u0026#39;curl-3043 [000] d...1 7164.674643: bpf_trace_printk: try redirect port 46246 --\u0026gt; 8000\u0026#39; b\u0026#39;python3-3044 [000] d...1 7164.675211: bpf_trace_printk: try redirect port 8000 --\u0026gt; 46246\u0026#39; b\u0026#39;python3-3044 [000] d...1 7164.675492: bpf_trace_printk: try redirect port 8000 --\u0026gt; 46246\u0026#39; é€™é‚Šå¯ä»¥çœ‹åˆ° sockmap è¦æŒ‡å®šä¸€å€‹ - c çš„åƒæ•¸ï¼Œå¾Œé¢æ˜¯æŒ‡å®šä¸€å€‹ cgroupï¼Œsockmap åªæœƒç›£æ§åœ¨é€™å€‹ cgroup ç¯€é»ä¸Šçš„ socket é€£ç·šã€‚é€™é‚Š unified æ˜¯ cgroup v2 çš„ hierarchyï¼Œåœ¨ cgroup v2 åªæœ‰ unified ä¸€å€‹ hierarchyï¼Œæ‰€æœ‰ subsystem éƒ½åœ¨é€™å€‹ hierarchy ä¸Šã€‚\né¦–å…ˆæ˜¯ curl remote-port: 8000, local-port: 46246' Sockhash op: 4, port 46246 --\u0026gt; 8000'ï¼Œé€™å…©æ¢æ˜¯ curl ç™¼èµ·é€£ç·šæ™‚ï¼Œè¨˜éŒ„ä¸‹ä¾†çš„ socket é€£ç·šè«‹æ±‚ã€‚\næ¥è‘— curl remote-port: 46246, local-port: 8000' Sockhash op: 5, port 8000 --\u0026gt; 46246'ï¼Œæ˜¯ curl è·Ÿ http server ä¹‹é–“é€£ç·šå»ºç«‹æˆåŠŸå¾Œï¼Œè¿”å›çµ¦ curl çš„ socket é€šçŸ¥ã€‚\næ¥è‘—å¯ä»¥çœ‹åˆ° 3 æ¢ try redirectÂ æ˜¯ curl å‚³é http request å’Œ http server è¿”å› http response çš„ msgï¼Œç›´æ¥é€é socket redirect çš„æ–¹å¼åœ¨å…©å€‹ socket ä¹‹é–“äº¤äº’ã€‚\né€™é‚Šæˆ‘å€‘ä½¿ç”¨ tcpdump å»ç›£è½ loÂ interface çš„æ–¹å¼ä¾†é©—è­‰ socket redirect æœ‰çœŸçš„é‹ä½œåˆ°ã€‚åŒæ¨£æ˜¯é€é curl 127.0.0.1:8000Â ç™¼èµ·é€£ç·šå‚³è¼¸è³‡æ–™ã€‚åœ¨æ²’æœ‰å•Ÿç”¨ sockmap çš„æƒ…æ³ä¸‹ tcpdump æ•æ‰åˆ° 12 å€‹å°åŒ…ã€‚è€Œé–‹å•Ÿ socketmap å¾Œåªæœƒæ•æ‰åˆ° 6 å€‹å°åŒ…ã€‚\né€éå°åŒ…å…§å®¹æœƒç™¼ç¾ï¼Œåœ¨ socketmap å•Ÿå‹•å¾Œï¼Œåªèƒ½å¤ æ•æ‰åˆ°å¸¶ SYNã€FINÂ ç­‰ flag çš„ TCP æ§åˆ¶å°åŒ…ï¼Œä¸æœƒæ•æ‰åˆ°ä¸­é–“ç´”ç²¹çš„è³‡æ–™äº¤æ›å°åŒ…ã€‚\nSOCK_OPS program type # å®Œæˆé©—è­‰å¾Œï¼Œæˆ‘å€‘æ¥è‘—ä¾†ä»‹ç´¹é€™æ¬¡ç”¨åˆ°çš„å…©ç¨® eBPG program typeï¼Œåˆ†åˆ¥æ˜¯ BPF_PROG_TYPE_SOCK_OPSÂ å’Œ BPF_PROG_TYPE_SK_MSGã€‚\nBPF_PROG_TYPE_SOCK_OPSÂ å¯ä»¥ attach åœ¨ä¸€å€‹ cgroup ç¯€é»ä¸Šï¼Œç•¶è©²ç¯€é»ä¸Šä»»æ„ process çš„ socket ç™¼ç”Ÿç‰¹å®šäº‹ä»¶æ™‚ï¼Œè©² eBPF program æœƒè¢«è§¸ç™¼ã€‚å¯èƒ½çš„äº‹ä»¶å®šç¾©åœ¨ bpf.hã€‚å…¶ä¸­ CB çµå°¾çš„è¡¨ç¤ºç‰¹å®šäº‹ä»¶å®Œæˆå¾Œè§¸ç™¼ï¼Œä¾‹å¦‚ BPF_SOCK_OPS_TCP_LISTEN_CBÂ è¡¨ç¤ºåœ¨ socket tcp é€£ç·šè½‰ä¹˜ LISTEN ç‹€æ…‹å¾Œè§¸ç™¼ã€‚æœ‰äº›å‰‡æ˜¯è§¸ç™¼ä¾†é€éå›å‚³å€¼è¨­ç½®ä¸€äº›æ§åˆ¶é …ï¼ŒBPF_SOCK_OPS_TIMEOUT_INITÂ æ˜¯åœ¨ TCP Timeout å¾Œè§¸ç™¼ï¼Œé€é eBPF çš„ return value è¨­ç½® RTOï¼Œ-1 è¡¨ç¤ºä½¿ç”¨ç³»çµ±é è¨­ã€‚\nenum { BPF_SOCK_OPS_VOID, BPF_SOCK_OPS_TIMEOUT_INIT, BPF_SOCK_OPS_RWND_INIT, BPF_SOCK_OPS_TCP_CONNECT_CB, BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB, BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB, BPF_SOCK_OPS_NEEDS_ECN, BPF_SOCK_OPS_BASE_RTT, BPF_SOCK_OPS_RTO_CB, BPF_SOCK_OPS_RETRANS_CB, BPF_SOCK_OPS_STATE_CB, BPF_SOCK_OPS_TCP_LISTEN_CB, BPF_SOCK_OPS_RTT_CB, BPF_SOCK_OPS_PARSE_HDR_OPT_CB, BPF_SOCK_OPS_HDR_OPT_LEN_CB, BPF_SOCK_OPS_WRITE_HDR_OPT_CB, }; é€™é‚Šè¦ç‰¹åˆ¥ä»‹ç´¹çš„æ˜¯ BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CBÂ å’Œ BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CBÂ åˆ†åˆ¥æ˜¯åœ¨ä¸»å‹•å»ºç«‹é€£ç·šæ™‚ (ç™¼é€ SYNï¼Œtcp ä¸‰æ‰‹äº¤æ¡ç¬¬ä¸€æ‰‹)ï¼Œå’Œè¢«å‹•å»ºç«‹é€£ç·šæ™‚ (ç™¼é€ SYN+ACKï¼Œtcp ä¸‰æ‰‹äº¤æ¡ç¬¬äºŒæ‰‹) è§¸ç™¼ã€‚\nè§¸ç™¼å¾Œæœƒæ‹¿åˆ° bpf_sock_ops ä¸Šä¸‹æ–‡ï¼Œä¸¦æ ¹æ“šäº‹ä»¶ä¸åŒï¼ŒeBPF å›å‚³å€¼ä¹Ÿä»£è¡¨ä¸åŒçš„æ„ç¾©ã€‚å…¶ä¸­ bpf_sock_ops-\u0026gt;opÂ å°æ‡‰åˆ°ä¸Šè¿°çš„äº‹ä»¶é¡å‹ã€‚args å‰‡æ˜¯ä¸åŒ op å¯èƒ½å¸¶çš„ä¸€äº›ç‰¹æ®Šåƒæ•¸ã€‚\nstruct bpf_sock_ops { __u32 op; union { __u32 args [4];\t/* Optionally passed to bpf program */ __u32 reply;\t/* Returned by bpf program\t*/ __u32 replylong [4];\t/* Optionally returned by bpf prog */ }; __u32 family; __u32 remote_ip4;\t/* Stored in network byte order */ __u32 local_ip4;\t/* Stored in network byte order */ __u32 remote_ip6 [4];\t/* Stored in network byte order */ __u32 local_ip6 [4];\t/* Stored in network byte order */ __u32 remote_port;\t/* Stored in network byte order */ __u32 local_port;\t/* stored in host byte order */ __u32 is_fullsock; ... SK_MSG SK_SKB program type # æ¥è‘—è¦ä»‹ç´¹å¦å¤–å…©å€‹ program typeÂ BPF_PROG_TYPE_SK_SKBÂ å’Œ BPF_PROG_TYPE_SK_MSGã€‚\né¦–å…ˆä»–å€‘ä¸ attach linux æœ¬èº«çš„æŸå€‹åœ°æ–¹è€Œæ˜¯ attach åœ¨ä¸€å€‹ eBPF map ä¸Šï¼Œé€™å€‹ map å¿…é ˆæ˜¯ BPF_MAP_TYPE_SOCKMAPÂ æˆ– BPF_MAP_TYPE_SOCKHASHã€‚å…©å€‹ map éƒ½æ˜¯æŸå€‹ key å°æ‡‰åˆ° socketï¼Œå¯ä»¥ä½¿ç”¨ sock_hash_update æ›´æ–° sockhash mapï¼Œå°‡ sock_ops çš„ä¸Šä¸‹æ–‡ bpf_sock_ops çµæ§‹ç•¶ä½œ value å»æ’å…¥ã€‚\nç•¶ sockmap è£¡é¢çš„ socket æœ‰è¨Šæ¯è¦é€å‡ºï¼Œå°åŒ…è¦è¢«æ”¾åˆ° socket çš„ TXQueue æ™‚æœƒè§¸ç™¼ BPF_PROG_TYPE_SK_MSGï¼Œè€Œç•¶å°åŒ…å¾å¤–ç•Œé€å…¥è¢«ä¸»æ©Ÿæ¥æ”¶ï¼Œè¦æ”¾åˆ° socket çš„ RXQueue æ™‚å‰‡æœƒè§¸ç™¼ BPF_PROG_TYPE_SK_SKBã€‚\nä»¥é€™æ¬¡æœƒç”¨åˆ°çš„ BPF_PROG_TYPE_SK_MSGÂ ä¾†èªªï¼Œç•¶ userspace å‘¼å« sendmsg æ™‚ï¼Œå°±æœƒè¢« eBPF ç¨‹å¼æ””æˆªã€‚\nå¯ä»¥é€éå›å‚³ __SK_DROP,Â __SK_PASS,Â __SK_REDIRECTÂ ä¾†æ±ºå®šæ˜¯è¦ä¸Ÿæ£„ã€æ¥æ”¶æˆ–åš socket redirectã€‚\né€é socket redirectï¼Œå°åŒ…æœƒå¾ç™¼é€ç«¯ socket ç›´æ¥è¢«ä¸Ÿåˆ°æ¥æ”¶ç«¯ socket RXQã€‚\nç›®å‰ redirect çš„åŠŸèƒ½åªèƒ½ç”¨æ–¼ TCP é€£ç·šã€‚\nsockmap å¯¦ä½œ # eBPF å¯¦ä½œ # å¤§è‡´ä¸Šçš„æ¦‚å¿µä»‹ç´¹å®Œäº†å°±è®“æˆ‘å€‘å›åˆ° bcc sockmap çš„ç¨‹å¼ç¢¼ã€‚\né¦–å…ˆä¸€æ¨£å…ˆçœ‹ eBPF çš„ç¨‹å¼ç¢¼ã€‚\n#define MAX_SOCK_OPS_MAP_ENTRIES 65535 struct sock_key { u32 remote_ip4; u32 local_ip4; u32 remote_port; u32 local_port; u32 family; }; BPF_SOCKHASH (sock_hash, struct sock_key, MAX_SOCK_OPS_MAP_ENTRIES); é€™é‚Šå®šç¾©äº†ä¸€å€‹ sock_keyï¼Œä½œç‚º BPF_SOCKHASH socket map çš„ keyï¼Œé€é five tuple (IP src/dst, sct/dst port åŠ TCP/UDP) ä¾†å®šä½ä¸€å€‹é€£ç·šã€‚\næ¥è‘—æˆ‘å€‘çœ‹åˆ°ç¬¬ä¸€ç¨® program typeÂ SOCK_OPSÂ çš„å…¥å£å‡½æ•¸ã€‚\nint bpf_sockhash (struct bpf_sock_ops *skops) { u32 op = skops-\u0026gt;op; /* ipv4 only */ if (skops-\u0026gt;family != AF_INET) return 0; switch (op) { case BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB: case BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB: bpf_sock_ops_ipv4 (skops); break; default: break; } return 0; } é€™é‚Šåšçš„äº‹æƒ…å¾ˆç°¡å–®ï¼Œåœ¨ socket å»ºç«‹é€£ç·š (ACTIVE_ESTABLISHED_CB) å’Œæ¥æ”¶é€£ç·š (PASSIVE_ESTABLISHED_CB) æ™‚ï¼Œå‘¼å« bpf_sock_ops_ipv4 å°‡ socket æ”¾åˆ° sock map å…§ï¼Œè®“ socket è¢«ç¬¬äºŒå€‹ program typeÂ SK_MSGÂ çš„ç¨‹å¼èƒ½å¤ åœ¨ socket å‘¼å« sendmsg ç­‰ API æ™‚è¢«æ””æˆªè™•ç†ã€‚ç”±æ–¼ socker redirect åªèƒ½è™•è£¡ TCP é€£ç·šï¼Œæ‰€ä»¥é AF_INETÂ çš„é€£ç·šæœƒè¢«éæ¿¾æ‰ã€‚\nstatic __always_inline void bpf_sock_ops_ipv4(struct bpf_sock_ops *skops) { struct sock_key skk = { .remote_ip4 = skops-\u0026gt;remote_ip4, .local_ip4 = skops-\u0026gt;local_ip4, .local_port = skops-\u0026gt;local_port, .remote_port = bpf_ntohl (skops-\u0026gt;remote_port), .family = skops-\u0026gt;family, }; int ret; bpf_trace_printk (...); ret = sock_hash.sock_hash_update (skops, \u0026amp;skk, BPF_NOEXIST); if (ret) { bpf_trace_printk (\u0026#34;bpf_sock_hash_update () failed. % d\\\\n\u0026#34;, -ret); return; } bpf_trace_printk (...); } é€™é‚Šçš„ bpf_sock_ops_ipv4 å…¶å¯¦ä¹Ÿå¾ˆç°¡å–®ï¼Œå¾ sock_opt è£¡é¢æå–å‡º IP åœ°å€ / TCP port çš„è³‡è¨Šï¼Œå¡«å…… sock_key çµæ§‹ï¼Œç„¶å¾Œå‘¼å« sock_hash_update æŠŠ key-value piar å¡é€²å» sock_hashã€‚å¾Œé¢çš„ flag æœ‰ BPF_NOEXIST,Â BPF_EXIST,Â BPF_ANYã€‚BPF_NOEXISTÂ è¡¨ç¤ºåªæœ‰ key ä¸åœ¨ map è£¡é¢çš„æ™‚å€™å¯ä»¥æ’å…¥ã€‚\næ¥è‘—æ˜¯ BPF_PROG_TYPE_SK_MSGÂ çš„å…¥å£å‡½æ•¸ã€‚\nint bpf_redir(struct sk_msg_md *msg) { if (msg-\u0026gt;family != AF_INET) return SK_PASS; if (msg-\u0026gt;remote_ip4 != msg-\u0026gt;local_ip4) return SK_PASS; struct sock_key skk = { .remote_ip4 = msg-\u0026gt;local_ip4, .local_ip4 = msg-\u0026gt;remote_ip4, .local_port = bpf_ntohl (msg-\u0026gt;remote_port), .remote_port = msg-\u0026gt;local_port, .family = msg-\u0026gt;family, }; int ret = 0; ret = sock_hash.msg_redirect_hash (msg, \u0026amp;skk, BPF_F_INGRESS); bpf_trace_printk (...); if (ret != SK_PASS) bpf_trace_printk (...); return ret; } é¦–å…ˆä¸€æ¨£æˆ‘å€‘åªèƒ½è™•è£¡ TCP é€£ç·šæ‰€æœ‰æŠŠé AF_INETÂ çš„é€£ç·šé€é return SK_PASS;Â äº¤å› linux kernel è™•ç†ã€‚\næ¥è‘—ç”±æ–¼ socket redirect åªåœ¨æœ¬æ©Ÿèµ·ä½œç”¨ï¼Œæ‰€ä»¥é€™é‚Šç°¡å–®åˆ¤æ–· src ip å’Œ dst ip ç›¸ä¸ç›¸åŒï¼Œä¾†åˆ¤æ–·æ˜¯å¦æ˜¯ local to local é€£ç·šã€‚\næ¥è‘—ç”±æ–¼ socket redirect æ™‚è¦å¾ç™¼é€ç«¯çš„ socket redirect åˆ°æ¥æ”¶ç«¯çš„ socketï¼Œå› æ­¤æˆ‘å€‘è¦å¾ socket map ä¸­æ‰¾åˆ°æ¥æ”¶ç«¯çš„ socketï¼Œå°ç™¼é€ç«¯å’Œæ¥æ”¶ç«¯çš„ socket ä¾†èªª src addres å’Œ dst address çš„æ˜¯é¡›å€’çš„ï¼Œæ‰€ä»¥é€™é‚Šåœ¨ç”Ÿ sock_key æ™‚æœƒæŠŠ local å’Œ remote é¡›å€’ã€‚\næ¥è‘—é€™é‚Šçš„ msg_redirect_hashÂ æ˜¯å° bpf_msg_redirect_hashÂ helper function çš„åŒ…è£ï¼Œæœƒå˜—è©¦å¾ socket map æ‰¾åˆ°å°æ‡‰çš„ socketï¼Œç„¶å¾Œå®Œæˆ redirect çš„è¨­ç½®ï¼Œä¸éæˆåŠŸæ˜¯å›å‚³æ˜¯ SK_PASS è€Œä¸æ˜¯ SK_REDIRECTã€‚\nåˆ°é€™é‚Šå°±å®Œæˆ eBPF ç¨‹å¼çš„éƒ¨åˆ†äº†ï¼Œæ¥ä¸‹ä¾† python çš„éƒ¨åˆ†å°±å¾ˆç°¡å–®ï¼Œåªæ˜¯æŠŠ eBPG ç¨‹å¼æ›é€²å»ã€‚\npython å¯¦ä½œ # examples = \u0026#34;\u0026#34;\u0026#34;examples: ./sockmap.py -c /root/cgroup # attach to /root/cgroup \u0026#34;\u0026#34;\u0026#34; parser = argparse.ArgumentParser ( description=\u0026#34;pipe data across multiple sockets\u0026#34;, formatter_class=argparse.RawDescriptionHelpFormatter, epilog=examples) parser.add_argument (\u0026#34;-c\u0026#34;, \u0026#34;--cgroup\u0026#34;, required=True, help=\u0026#34;Specify the cgroup address. Note. must be cgroup2\u0026#34;) args = parser.parse_args () å‰é¢æœ‰æåˆ° SOCK_OPS è¦æ›åœ¨ä¸€å€‹ cgroup ä¸‹é¢ï¼Œæ‰€ä»¥å…ˆåƒä¸€å€‹ cgroup è·¯å¾‘åƒæ•¸ä¾†ã€‚\nbpf = BPF (text=bpf_text) func_sock_ops = bpf.load_func (\u0026#34;bpf_sockhash\u0026#34;, bpf.SOCK_OPS) func_sock_redir = bpf.load_func (\u0026#34;bpf_redir\u0026#34;, bpf.SK_MSG) ç·¨è­¯ eBPF ç¨‹å¼ï¼Œå–å¾—å…©å€‹å…¥å£å‡½æ•¸\n# raise if error fd = os.open(args.cgroup, os.O_RDONLY) map_fd = lib.bpf_table_fd (bpf.module, b\u0026#34;sock_hash\u0026#34;) bpf.attach_func (func_sock_ops, fd, BPFAttachType.CGROUP_SOCK_OPS) bpf.attach_func (func_sock_redir, map_fd, BPFAttachType.SK_MSG_VERDICT) å‰é¢æåˆ° cgroup ä»‹é¢æ˜¯ä¸€å€‹è™›æ“¬æª”æ¡ˆç³»çµ±ï¼Œæ‰€ä»¥ç•¶ç„¶è¦é€é open å»å–å¾—å°æ‡‰çš„ file descriptorã€‚æ¥è‘—å°±æ˜¯ attach func_sock_ops åˆ° SOCK_OPSã€‚ç”±æ–¼ func_sock_redir è¦ attach åˆ° sock mapï¼Œæ‰€ä»¥å…ˆé€é bcc çš„ API å–å¾— sock_hash map çš„ file descripterï¼Œç„¶å¾Œ attach ä¸Šå»ã€‚\né€™æ¨£å°±å®Œæˆ sockemap çš„è¨­ç½®ï¼Œå¯ä»¥æˆåŠŸæä¾› socket redirect çš„æœå‹™äº†ï¼\nåƒè€ƒæ–‡ä»¶ # cgroups man page ç¬¬ä¸€åƒé›¶ä¸€ç¯‡çš„ cgroups ä»‹ç´¹ Cgroups ä¸­çš„èµ„æºç®¡ç† hierarchy å±‚çº§æ ‘ ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-8-cgroups-socket-map/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 8 - cgroups \u0026 socket map","type":"posts"},{"content":"æœ¬ç¯‡æ˜¯æœ¬ç³»åˆ—æ–‡ç« çš„æœ€å¾Œä¸€ç¯‡ï¼Œåœ¨ eBPF ç¨‹å¼è£¡é¢è¦èˆ‡ kernel äº¤äº’å¾ˆé‡è¦çš„æ˜¯ helper functionï¼Œå› æ­¤åœ¨æœ€å¾Œçš„å…©å¤©æ™‚é–“ï¼Œæˆ‘å€‘è¦æŠŠæ‰€æœ‰çš„ helper function é€Ÿè¦½éä¸€éã€‚é€™é‚Šä»‹ç´¹ä»¥ bpf-helper çš„ man æ–‡ä»¶Â çš„å…§å®¹ç‚ºä¸»ï¼Œéƒ¨åˆ†çš„ helper function å¯èƒ½å› ç‚ºæ–‡ä»¶æ›´æ–°è€Œæœ‰éºæ¼ã€‚\næ¥ä¸‹ä¾†çš„ä»‹ç´¹æœƒç¨å¾®å° helper function åšä¸€å®šç¨‹åº¦çš„åˆ†é¡ï¼Œä½†æ˜¯å…·é«”ä¸åŒçš„ eBPF program type æ”¯æ´é‚£äº› helper function å¯èƒ½é‚„æ˜¯è¦æ ¹æ“š bcc æ–‡ä»¶ã€æ¯å€‹ helper function å°æ‡‰çš„ commit è³‡è¨Šç­‰æŸ¥è©¢ã€‚\neBPF map æ“ä½œé¡ # array, map é¡å‹ map çš„æ“ä½œå‡½æ•¸ï¼Œå°æ‡‰åˆ°æŸ¥è©¢ã€æ’å…¥æˆ–æ›´æ–°ã€åˆªé™¤ map å…§çš„å…ƒç´ ã€‚å…¶ä¸­ update å¯ä»¥é€é flag (BPF_NOEXIST,Â BPF_EXIST,Â BPF_ANY) æ±ºå®š key æ˜¯ä¸æ˜¯ä¸èƒ½å…ˆå­˜åœ¨æˆ–ä¸€å®šè¦å­˜åœ¨æ–¼ map å…§ã€‚ bpf_map_lookup_elem bpf_map_update_elem bpf_map_delete_elem ç”¨æ–¼ stack, queue é¡å‹ map çš„æ“ä½œå‡½æ•¸ã€‚ bpf_map_peek_elem bpf_map_pop_elem bpf_map_push_elem ç”¨æ–¼ ringbuff çš„æ“ä½œå‡½æ•¸ (æ”¹é€²åŸæœ¬ perf event map çš„å•é¡Œ) bpf_ringbuf_output bpf_ringbuf_reserve bpf_ringbuf_submit bpf_ringbuf_discard bpf_ringbuf_query é€šç”¨å‡½æ•¸ # ç”Ÿæˆéš¨æ©Ÿæ•¸ get_prandom_u32 atol,Â atoul bpf_strtol bpf_strtoul å–å¾—ç•¶å‰åŸ·è¡Œ eBPF ç¨‹å¼çš„ (SMP) processor IDã€‚ç”±æ–¼ eBPF æ˜¯ no preemption çš„æ‰€ä»¥åœ¨æ•´å€‹åŸ·è¡Œéç¨‹ä¸­ processor id ä¸æœƒè®Šã€‚ bpf_get_smp_processor_id å–å¾—ç•¶å‰ NUMA (Non-uniform memory access) çš„ node idã€‚å—æ–¼åŒ¯æµæ’é™åˆ¶ï¼ŒCPU æ ¸å¿ƒå¯ä»¥æ¯”è¼ƒå¿«å­˜å–åŒç¯€é»ä¸Šçš„ memoryï¼Œé€é node id å€åˆ†ã€‚é€šå¸¸æ˜¯ç•¶ attach çš„ socket æœ‰å•Ÿç”¨ SO_ATTACH_REUSEPORT_EBPFÂ é¸é …æ™‚æœƒç”¨åˆ°ã€‚ bpf_get_numa_node_id æ­é… BPF_MAP_TYPE_PROG_ARRAYÂ map å»åŸ·è¡Œ tail callã€‚ bpf_tail_call å–å¾—é–‹æ©Ÿåˆ°ç•¶ä¸‹ç¶“éçš„æ™‚é–“ï¼Œå–®ä½æ˜¯ nsï¼Œå·®åˆ¥åœ¨æ–¼å¾Œè€…æœƒå¤šåŒ…å« suspend (æš«åœ) çš„æ™‚é–“ bpf_ktime_get_ns bpf_ktime_get_boot_ns å–å¾— jiffies64 bpf_jiffies64 å°‡å­—ä¸²è¨Šæ¯ç™¼é€åˆ° /sys/kernel/debug/tracing/traceï¼Œä¸»è¦ç”¨æ–¼é–‹ç™¼é™¤éŒ¯ bpf_trace_printk å¯«å…¥ seq_file bpf_seq_write bpf_seq_printf æ­é… struct bpf_spin_lockÂ æä¾›ä¸€å€‹çµ¦ BPF_MAP_TYPE_HASHÂ å’Œ BPF_MAP_TYPE_ARRAY(ç›®å‰åªæ”¯æ´é€™å…©è‘—) è£¡é¢ value ä½¿ç”¨çš„ lockï¼Œç”±æ–¼ä¸€å€‹ map è£¡é¢åªèƒ½æœ‰ä¸€å€‹ spin_lockï¼Œæ‰€ä»¥é€šå¸¸æ˜¯ä½¿ç”¨æŠŠä¹‹å‰æéï¼Œæ•´å€‹ map å›ºå®šåªæœ‰ä¸€å€‹å…ƒç´ ï¼ŒæŠŠæ•´å€‹ map ç•¶ä½œä¸€å€‹ global variable çš„ç”¨æ³• bpf_spin_lock bpf_spin_unlock æ­é… BPF_MAP_TYPE_PERF_EVENT_ARRAYÂ ä½¿ç”¨ï¼Œå‚³è¼¸è³‡æ–™åˆ° user space bpf_perf_event_output Tracing ç›¸é—œ (kprobe, tracepoint, perf event) # å–å¾—ç•¶å‰çš„ tgid, uid, gid, command name, task structure bpf_get_current_pid_tgid bpf_get_current_uid_gid bpf_get_current_comm bpf_get_current_task ç™¼ signal åˆ°ç•¶å‰ (process, thread) bpf_send_signal bpf_send_signal_thread ç”¨æ–¼è®€å–è¨˜æ†¶é«”è³‡æ–™ã€å­—ä¸²åŠå¯«å…¥è¨˜æ†¶é«”ã€‚å¸¶ user çš„ç‰ˆæœ¬ç”¨æ–¼ user space memoryï¼Œå…¶é¤˜ç”¨æ–¼ kernel space memoryã€‚ bpf_probe_read (é€šå¸¸ä½¿ç”¨å¾Œå€†è‘—) bpf_probe_read_user bpf_probe_read_kernel bpf_probe_read_str (é€šå¸¸ä½¿ç”¨å¾Œå€†è‘—) bpf_probe_read_user_str bpf_probe_read_kernel_str bpf_probe_write_user æ­é… BPF_MAP_TYPE_STACK_TRACEÂ ä½¿ç”¨ï¼Œå–å¾—ä¸€å€‹ stack address hash éçš„ stack id bpf_get_stackid å–å¾— userspace æˆ– kernel space çš„ stack è³‡æ–™ bpf_get_stack bpf_get_task_stack æ­é… BPF_MAP_TYPE_PERF_EVENT_ARRAYÂ å–å¾— perf-event counter çš„è®€æ•¸ bpf_perf_event_read bpf_perf_event_read_value (å»ºè­°ä½¿ç”¨) ç”¨æ–¼ BPF_PROG_TYPE_PERF_EVENTÂ å–å¾— struct perf_branch_entry bpf_read_branch_records æ­é… BPF_MAP_TYPE_CGROUP_ARRAYÂ ä½¿ç”¨ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨æŸå€‹ cgroup v2 ç¯€é»å…§ bpf_current_task_under_cgroup æŸ¥çœ‹ç•¶å‰ä¸Šä¸‹æ–‡çš„ cgroup ç¯€é»çš„ç¥–å…ˆç¯€é» id bpf_get_current_ancestor_cgroup_id å–å¾—ç•¶å‰ä¸Šä¸‹æ–‡å°æ‡‰çš„ cgroup id bpf_get_current_cgroup_id ç”¨æ–¼ kprobeï¼Œä¿®æ”¹å‡½æ•¸å›å‚³å€¼ bpf_override_return Cgroup ç›¸é—œ # å–å¾—ä¸€å€‹ç•¶å‰ network namespace å°æ‡‰çš„ cookie (identifer) bpf_get_netns_cookie å–å¾— local storage çš„æŒ‡æ¨™ (cgroup ç›¸é—œå¯ä½¿ç”¨çš„ä¸€å€‹å„²å­˜å€) bpf_get_local_storage ç”¨æ–¼ BPF_PROG_TYPE_CGROUP_SYSCTL å–å¾—ã€æ›´æ–° sysctl è³‡è¨Š bpf_sysctl_get_name bpf_sysctl_get_current_value bpf_sysctl_get_new_value bpf_sysctl_set_new_value å…¶ä»–é¡åˆ¥ # LIRC ç´…å¤–ç·šæ”¶ç™¼ç›¸é—œ (BPF_PROG_TYPE_LIRC_MODE2) bpf_rc_repeat bpf_rc_keydown bpf_rc_pointer_rel XDP ç›¸é—œ # æ–¼ XDP ä¿®æ”¹å°åŒ…å¤§å° (å¯ä»¥å¢å¤§æˆ–ç¸®å°) bpf_xdp_adjust_head bpf_xdp_adjust_tail XDP_TX redirect ä½¿ç”¨ bpf_redirect_map XDP è¼¸å‡ºå°åŒ…å…§å®¹åˆ° perf event bpf_xdp_output èª¿æ•´ xdp_md-\u0026gt;data_meta bpf_xdp_adjust_meta æŸ¥è©¢ fid (Forward Information Base, L2) bpf_fib_lookup (ä¹Ÿå¯ç”¨åœ¨ TC) LWT ç›¸é—œ # attach åœ¨ routing table æ›¿ L3 å°åŒ…é€²è¡Œ tunnel header encap bpf_lwt_push_encap å¤–å°åŒ… (underlay) å…§å®¹ä¿®æ”¹ bpf_lwt_seg6_store_bytes bpf_lwt_seg6_adjust_srh å¥—ç”¨ IPv6 Segment Routing action æ±ºç­– bpf_lwt_seg6_action socket, socket buffer ç›¸é—œ # ç”¨æ–¼ BPF_PROG_TYPE_CGROUP_SOCK_ADDRï¼Œä¿®æ”¹ bind address bpf_bind è®€å–å°åŒ…å…§å®¹ bpf_skb_load_bytes bpf_skb_load_bytes_relative ä¿®æ”¹å°åŒ…å…§å®¹ï¼Œå¯è‡ªå‹•æ›´æ–° chekcsum bpf_skb_store_bytes æ”¹å¯« l3, l4 çš„ checksum bpf_l3_csum_replace bpf_l4_csum_replace ç”¨æ–¼è¨ˆç®— check sumï¼Œå¯æ­é…å‰å…©å€‹ replace å‡½æ•¸ä½¿ç”¨ bpf_csum_diff å–å¾— xfrm (IPsec ç›¸é—œ) bpf_skb_get_xfrm_state å°‡å°åŒ…ç™¼åˆ°å…¶ä»–çš„ deviceã€‚å¾Œè€…æœƒè¤‡è£½ä¸€åˆ†å°åŒ…ã€‚ bpf_redirect bpf_clone_redirect å–å¾— classidï¼Œåƒè€ƒ cgroup çš„ net_clsï¼Œä½¿ç”¨æ–¼ TC egress pathã€‚ bpf_get_cgroup_classid å¢æ¸› vlan header bpf_skb_vlan_push bpf_skb_vlan_pop å–å¾—ã€ä¿®æ”¹å°åŒ…çš„ tunnel (ex. GRE) çš„ tunnel key è³‡è¨Š bpf_skb_get_tunnel_key bpf_skb_set_tunnel_key å–å¾—ã€ä¿®æ”¹å°åŒ…çš„ tunnel è³‡è¨Š bpf_skb_get_tunnel_opt bpf_skb_set_tunnel_opt å–å¾— skb çš„ tclassid æ¬„ä½ï¼Œç”¨æ–¼ clsact TC egress bpf_get_route_realm ä¿®æ”¹å°åŒ… prtocol (ipv4, ipv6) bpf_skb_change_proto ä¿®æ”¹å°åŒ…é¡å‹ (broadcast, multicast, unitcast..) bpf_skb_change_type æ­é… BPF_MAP_TYPE_CGROUP_ARRAYÂ ä½¿ç”¨ï¼Œæª¢æŸ¥ skb æ˜¯ä¸æ˜¯åœ¨æŸå€‹ cgroup v2 ç¯€é»çš„å­ç¯€é»å…§ã€‚ bpf_skb_under_cgroup å–å¾— skb å°æ‡‰çš„ cgroup id bpf_skb_cgroup_id å‘ä¸ŠæŸ¥æ‰¾ skb å°æ‡‰ cgroup ç¯€é»çš„ç¥–å…ˆç¯€é» id bpf_sk_ancestor_cgroup_id å–å¾—ã€ä¿®æ”¹ skb-\u0026gt;hash bpf_get_hash_recalc bpf_set_hash ä¿®æ”¹å°åŒ…å¤§å° bpf_skb_change_tail ç”¨æ–¼å°åŒ… payload å­˜å–ï¼Œå…·é«”å…§å®¹æœ‰é»é›£ç†è§£ (non-linear data) bpf_skb_pull_data ä¿®æ”¹ skb-\u0026gt;csum bpf_csum_update ä¿®æ”¹ skb-\u0026gt;csum_level bpf_csum_level æ¨™è¨» skb-\u0026gt;hashÂ ç‚ºç„¡æ•ˆï¼Œè§¸ç™¼é‡ç®— bpf_set_hash_invalid å°‡ skb-\u0026gt;skÂ è½‰æˆæ‰€æœ‰æ¬„ä½éƒ½å¯ä»¥è¨ªå•çš„ç‰ˆæœ¬ bpf_sk_fullsock å¾ skb-\u0026gt;skÂ å–å¾— struct bpf_tcp_sock bpf_tcp_sock å‘ tcp-sock å°æ‡‰çš„æ–¹å‘ç™¼ä¸€å€‹ tcp-ack bpf_tcp_send_ack å¾ skb-\u0026gt;skÂ å–å¾— bpf_sock bpf_get_listener_sock è¨­ç½® skb-\u0026gt;sk bpf_sk_assign å–å¾— bpf_sock å°æ‡‰çš„ cgroupv2 id bpf_sk_cgroup_id å–å¾— bpf_sock å°æ‡‰ cgroupv2 ç¯€é»çš„ç¥–å…ˆ id bpf_sk_ancestor_cgroup_id å¼·åˆ¶è½‰å‹ sk æˆç‰¹å®šçš„ XXX_sock çµæ§‹ bpf_skc_to_tcp6_sock bpf_skc_to_tcp_sock bpf_skc_to_tcp_timewait_sock bpf_skc_to_tcp_request_sock bpf_skc_to_udp6_sock å¢åŠ  packet header å€ (headroom) é•·åº¦ï¼Œç”¨æ–¼ç‚º L3 å°åŒ…ç›´æ¥åŠ ä¸Š L2 çš„ header bpf_skb_change_head å¹« socket å»ºç«‹ä¸€å€‹ cookieï¼Œä½œç‚º socket çš„ identifierï¼Œç”¨æ–¼è¿½è¹¤ bpf_get_socket_cookie (sk_buff) bpf_get_socket_cookie (bpf_sock_addr) bpf_get_socket_cookie (bpf_sock_ops) å–å¾— socket çš„ owner UID bpf_get_socket_uid æ¨¡æ“¬å‘¼å« getsocketoptã€setsockopt bpf_getsockopt bpf_setsockopt å­˜å– skb çš„ ebpf local storage bpf_sk_storage_get bpf_sk_storage_delete å°‡å°åŒ…å…§å®¹è¼¸å‡ºåˆ° perf event bpf_skb_output ä¿®æ”¹å°åŒ… payload å¤§å°ï¼Œå¯ä»¥å¾ L2 æˆ– L3 çš„è§’åº¦ä¾†çœ‹ bpf_skb_adjust_room ç”¢ç”Ÿã€å°‹æ‰¾å°åŒ…å°æ‡‰çš„ SYN cookie ACK+ bpf_tcp_gen_syncookie+ bpf_tcp_check_syncookie BPF_PROG_TYPE_SK_SKBÂ (ingress æ–¹å‘) æ­é… BPF_MAP_TYPE_SOCKMAPÂ åš socket redierct bpf_sk_redirect_map bpf_sk_redirect_hash æœå°‹æ»¿è¶³å°æ‡‰ 5-tuple çš„ socket bpf_sk_lookup_tcp bpf_skc_lookup_tcp bpf_sk_lookup_udp é‡‹æ”¾ä¸Šé¢å…©å€‹æ‰¾åˆ°çš„ socket çš„ reference bpf_sk_release BPF_PROG_TYPE_SK_MSGÂ (egress æ–¹å‘) æ­é… BPF_MAP_TYPE_SOCKMAPÂ åš socket redierct bpf_msg_redirect_map bpf_msg_redirect_hash æ›¿ç‰¹å®šé•·åº¦çš„å…§å®¹ä½œ verdict (SK_PASSâ€¦)ï¼Œå¯ç”¨æ–¼æˆªçŸ­å°åŒ…ï¼Œå„ªåŒ–è™•ç†é€Ÿåº¦ (tc ç›¸é—œçš„æ±è¥¿ä¸å¤ªç†Ÿâ€¦/) bpf_msg_apply_bytes è·³éæ¥ä¸‹ä¾†æŸé•·åº¦çš„å…§å®¹ä¸åš veridct bpf_msg_cork_bytes è®€å¯«ä¿®æ”¹ç‰¹å®šé•·åº¦çš„è³‡æ–™ bpf_msg_pull_data bpf_msg_pop_data bpf_msg_push_data æ›´æ–° BPF_MAP_TYPE_SOCKMAP bpf_sock_map_update è¨­ç½® bpf_sock_ops-\u0026gt;bpf_sock_ops_cb_flagsÂ æ¬„ä½ bpf_sock_ops_cb_flags_set æ›´æ–° sockhash bpf_sock_hash_update ç”¨æ–¼ BPF_PROG_TYPE_SK_REUSEPORT(å°‡å¤šå€‹ç¨‹å¼ç¶å®šåœ¨åŒä¸€å€‹ port ä¸Š) sk_select_reuseport ç”¨æ–¼ BPF_PROG_TYPE_CGROUP_SKBï¼Œè¨­ç½® ECN (Explicit Congestion Notification) bpf_skb_ecn_set_ce ","date":"October 31 2022","externalUrl":null,"permalink":"/posts/learn-ebpf-serial-9-ebpf-helper-functions/","section":"æ–‡ç« ","summary":"","title":"å­¸ç¿’ eBPF ç³»åˆ— 9 - eBPF helper functions","type":"posts"},{"content":"","date":"October 29 2022","externalUrl":null,"permalink":"/categories/terraform/","section":"åˆ†é¡","summary":"","title":"Terraform","type":"categories"},{"content":"","date":"October 29 2022","externalUrl":null,"permalink":"/tags/%E8%87%AA%E5%8B%95%E5%8C%96/","section":"æ¨™ç±¤","summary":"","title":"è‡ªå‹•åŒ–","type":"tags"},{"content":" å‰è¨€ # Proxmox æä¾›äº† web GUI ä¾†æ–¹ä¾¿çš„å»ºç«‹å’Œç®¡ç† LXC å’Œè™›æ“¬æ©Ÿï¼Œä½†æ˜¯å¦‚æœæœ‰å¤§é‡çš„è™›æ“¬æ©Ÿéœ€è¦å»ºç«‹ï¼Œé‚£éº¼ä½¿ç”¨ GUI å°±æœƒè®Šå¾—éå¸¸ç¹ç‘£ï¼Œè€Œä¸”ä¸åˆ©æ–¼ç‰ˆæœ¬æ§åˆ¶ã€‚å› æ­¤æˆ‘å€‘å¯ä»¥ä½¿ç”¨ Terraform ä¾†å®Œæˆè‡ªå‹•åŒ–å»ºç«‹çš„éç¨‹ã€‚ç„¶è€Œåœ¨ Proxmox ä¸Šä½¿ç”¨ Terraformï¼Œæˆ‘è¦ºå¾—ç›¸å° openstack ä¾†èªªæ¦‚å¿µæœƒæ¯”è¼ƒè¤‡é›œä¸€é»ï¼Œå› æ­¤èŠ±äº†ä¸€é»é»æ™‚é–“ä¾†é‡æ¸…ã€‚é€™é‚Šè¨˜éŒ„ä¸‹ä½¿ç”¨ terrform ç®¡ç† Proxmox çš„åŸºæœ¬æ“ä½œï¼Œå¸Œæœ›å°å¤§å®¶æœ‰å¹«åŠ©ã€‚\nCloud-init åŸºæœ¬è§€å¿µ # åœ¨ä½¿ç”¨ Terraform å»ºç«‹ Proxmox VM çš„éç¨‹ä¸­ï¼Œæˆ‘å€‘æœƒä½¿ç”¨åˆ° cloud-init é€™å€‹æŠ€è¡“ã€‚ åœ¨ä½¿ç”¨ Promox GUI è¨­ç½®è™›æ“¬æ©Ÿçš„éç¨‹ä¸­æœƒæœ‰å…©å¤§éº»ç…©çš„åœ°æ–¹ï¼Œç¬¬ä¸€å€‹æ˜¯éœ€è¦åœ¨ web GUI ä»‹é¢ä¸Šä¸€å°ä¸€å°çš„å»ºç«‹å‡ºä¾†ï¼Œç¬¬äºŒå€‹æ˜¯éœ€è¦åœ¨æ¯å°è™›æ“¬æ©Ÿä¸Šå®Œæˆ OS çš„å®‰è£ï¼Œè¨­ç½®ç¡¬ç¢Ÿã€ç¶²è·¯ã€SSH ç­‰ã€‚ å‰è€…æˆ‘å€‘é€é terraform ä¾†è§£æ±ºï¼Œå¾Œè€…æˆ‘å€‘å‰‡æœƒæ­é…åˆ©ç”¨ cloud-initã€‚cloud-init æ˜¯ä¸€å€‹æ¥­ç•Œæ¨™æº–ï¼Œåœ¨è¨±å¤š Linux ç™¼è¡Œç‰ˆé‚„æœ‰å…¬ / ç§æœ‰é›²ä¸Šéƒ½æœ‰ç›¸å°æ‡‰çš„æ”¯æ´ã€‚ å„ Linux ç™¼è¡Œç‰ˆæœƒç™¼è¡Œç‰¹è£½çš„ cloud image ä¾†æ”¯æŒ cloud-initã€‚ æ”¯æ´ cloud-init çš„ä½œæ¥­ç³»çµ±æœƒåœ¨é–‹æ©ŸåŸ·è¡Œçš„æ™‚å€™åŸ·è¡Œé€éç‰¹å®šæ–¹å¼å»è®€å–ä½¿ç”¨è€…è¨­å®šæª”ï¼Œè‡ªå‹•å®Œæˆå‰é¢æåˆ°çš„ç¶²è·¯ã€å¸³è™Ÿç­‰è¨­ç½®ï¼Œä¾†é”åˆ°è‡ªå‹•åŒ–çš„ç›®çš„ã€‚\nData Source # åœ¨ cloud image ä¸­ï¼Œcloud-init æœƒæ ¹æ“šè¨­å®šæª”ä¾†å®Œæˆè¨­ç½®ï¼Œè€Œè¨­å®šæª”çš„ä¾†æº (Data source) æœ‰å¾ˆå¤šç¨®ï¼Œä¸åŒçš„ cloud (AWS, Azure, GCP, Openstack, Proxmox) åœ¨ cloud-init æ¨™æº–ä¸‹åˆ¶å®šäº†ä¸åŒçš„è¨­å®šæª”ä¾†æºã€‚(å¯åƒè€ƒ æ–‡ä»¶)\nåœ¨ Proxmox ä¸Šæ”¯æ´ NoCloud å’Œ ConfigDrive å…©ç¨®è³‡æ–™æºï¼Œå…©ç¨®çš„åŸ·è¡Œæ–¹å¼ç›¸ä¼¼ï¼Œå°‡ä½¿ç”¨è€…è¨­å®šæª”è½‰æˆä¸€å€‹ç‰¹è£½çš„å°è±¡æª”æ›è¼‰åˆ°è™›æ“¬æ©Ÿä¸Šï¼Œç•¶ VM é–‹æ©Ÿæ™‚ cloud-init å¯ä»¥è‡ªå‹•æœç´¢åˆ°è©²å°è±¡æª”ï¼Œä¸¦è®€å–è£¡é¢çš„è¨­å®šæª”ä¾†å®Œæˆè¨­ç½®ã€‚\nå‰ç½®ä½œæ¥­ # é¦–å…ˆæˆ‘å€‘è¦å…ˆå®‰è£ Terraform å’Œåœ¨ proxmox ä¸Šå®‰è£ cloud-init çš„å·¥å…·ï¼Œé€™é‚Šç°¡å–®ç›´æ¥æŠŠ Terraform ä¹Ÿè£åœ¨ promox host ä¸Šé¢ã€‚\n# cloud-init apt-get install cloud-init # Terraform wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg echo \u0026#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main\u0026#34; | sudo tee /etc/apt/sources.list.d/hashicorp.list sudo apt update \u0026amp;\u0026amp; sudo apt install terraform Proxmox \u0026amp; Cloud-init # å†é€é Terraform è‡ªå‹•éƒ¨å±¬ä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆçœ‹çœ‹æ€éº¼åœ¨ Proxmox ä¸Šæ­é… cloud-init æ‰‹å‹•éƒ¨å±¬ VMã€‚\né€™é‚Šæˆ‘å€‘é€é promox çš„ CLI å·¥å…·ä¾†å®Œæˆè¨­ç½®ï¼Œä¸éæ“ä½œä¹Ÿéƒ½å¯ä»¥é€é GUI å®Œæˆã€‚\nå»ºç«‹ VM # export VM_ID=\u0026#34;9001\u0026#34; cd /var/lib/vz/template/iso/ wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img qm create $VM_ID \\ --name ubuntu-2004-focal-fossa \\ --ostype l26 \\ --memory 8192 \\ --balloon 2048 \\ --sockets 1 \\ --cores 1 \\ --vcpu 1 \\ --net0 virtio,bridge=vmbr11 \\ --onboot 1 qm importdisk $VM_ID focal-server-cloudimg-amd64.img local-lvm --format qcow2 qm set $VM_ID --scsihw virtio-scsi-pci qm set $VM_ID --scsi0 local-lvm:vm-$VM_ID-disk-0 qm set $VM_ID --boot c --bootdisk scsi0 qm set $VM_ID --ide2 local-lvm:cloudinit qm set $VM_ID --serial0 socket å‰é¢æåˆ° cloud-init è¦ä½¿ç”¨ç‰¹è£½çš„å°è±¡æª”ï¼Œé€™é‚Šæˆ‘å€‘é€é wget æŠ“å–å°è±¡æª”ï¼Œæ”¾åˆ° /var/lib/vz/template/iso/ è·¯å¾‘ä¸‹ï¼Œé€™æ˜¯ proxmox é è¨­æ”¾ç½® ISO æª”çš„è·¯å¾‘ï¼Œå› æ­¤å¯ä»¥é€é GUI åˆ° storage/local/ISO image çš„é é¢çœ‹åˆ°æˆ‘å€‘å‰›å‰›ä¸‹è¼‰çš„å°è±¡æª”ã€‚\næ¥è‘—é€é qm create æŒ‡ä»¤å»ºç«‹ VMï¼Œé€™é‚Š balloon åƒæ•¸å°æ‡‰åˆ° Minimum memory çš„è¨­å®šã€‚\né€™é‚Šæä¾›çš„ cloud image æä¾›çš„å°è±¡æª”ä¸¦ä¸æ˜¯é€šå¸¸æˆ‘å€‘ç”¨ä¾†å®‰è£ä½œæ¥­ç³»çµ±çš„ iso å®‰è£æª”ï¼Œè€Œæ˜¯ qcow2 æ–‡ä»¶ï¼Œqcow2 æ˜¯ä¸€ç¨®è™›æ“¬æ©Ÿç¡¬ç¢Ÿå¿«ç…§æ ¼å¼ï¼Œå› æ­¤é€™é‚Šæˆ‘å€‘é€é importdisk æŒ‡ä»¤ï¼Œç›´æ¥å°‡ img è½‰æ›æˆç¡¬ç¢Ÿã€‚\næ¥è‘—æˆ‘å€‘è¦å°‡å»ºç«‹å¥½çš„ç¡¬ç¢Ÿæ›è¼‰åˆ° VM ä¸Šï¼Œé€™é‚Šæˆ‘å€‘æŒ‡å®š scsi0 ä»‹é¢ï¼Œå°‡ç¡¬ç¢Ÿæ›è¼‰ä¸Šå»ï¼ŒåŒæ™‚ç”±æ–¼æˆ‘å€‘è¦å¾ cloud image é–‹æ©Ÿï¼Œå› æ­¤é€™é‚Šç›´æ¥å°‡ bootdisk è¨­å®šç‚º scsi0ã€‚\nProxmox å®˜æ–¹æ–‡ä»¶æœ‰æåˆ°ï¼Œubuntu çš„ cloud-init æ˜ åƒï¼Œå¦‚æœä½¿ç”¨ scsi æ¥å£æ›è¼‰çš„è©±ï¼Œéœ€è¦å°‡æ§åˆ¶å™¨è¨­ç½®ç‚º virtio-scsi-pciã€‚\næ¥è‘—æˆ‘å€‘éœ€è¦æ·»åŠ å…©å€‹ç‰¹æ®Šçš„è¨­å‚™ï¼Œé¦–å…ˆæ˜¯ cloudinit (GUI é¡¯ç¤ºç‚º cloud driver)ï¼Œé€™å€‹æ˜¯å‰é¢æåˆ°ç”¨æ–¼å‚³è¼¸ cloud-init è¨­å®šæª”çš„è¨­å‚™ï¼Œç•¶åœ¨ proxmox ä¸Šå®Œæˆ cloud-init è¨­å®šå¾Œï¼Œproxmox æœƒç”Ÿæˆå°æ‡‰çš„å°è±¡æª”æ›åˆ° cloud driver ä¸Šï¼Œ\nå¦å¤–ç”±æ–¼ cloud image çš„ç‰¹æ®Šæ€§ï¼Œæˆ‘å€‘éœ€è¦æ·»åŠ ä¸€å€‹ srial è¨­å‚™ã€‚\nåˆ°é€™é‚Šè¨­å€çµæœå¦‚ä¸‹åœ–ï¼š\nè¨­å®š cloud-init # æ¥è‘—æˆ‘å€‘è¦è¨­å®š cloud-initï¼Œé€™é‚Šæˆ‘å€‘é€é GUI çš„æ–¹å¼ä¾†å®Œæˆè¨­å®šã€‚\nåœ¨ proxmox ä¸Šæˆ‘å€‘å¯ä»¥ç°¡å–®çš„åœ¨ GUI å®Œæˆ cloudinit çš„è¨­å®š (åŒ…å«å¸³è™Ÿã€å¯†ç¢¼ã€SSH key ç­‰)ï¼Œæ¥è‘—æŒ‰ä¸‹ Regenerage image æŒ‰éˆ•ï¼Œproxmox æœƒç”Ÿæˆè¨­å®šæª”ï¼Œä¸¦æ›è¼‰åˆ°å‰é¢å»ºç«‹çš„ cloud driver ä¸Šã€‚\nå•Ÿå‹• VM # æ¥è‘—æˆ‘å€‘åªè¦æŒ‰ä¸‹ Start æŒ‰éˆ•ï¼ŒVM å°±æœƒé–‹æ©Ÿï¼Œä¸¦è‡ªå‹•å®Œæˆå‰é¢çš„ cloud-init è¨­å®šã€‚\nCloud image ä¸å¤ªå»ºè­°ä½¿ç”¨å¯†ç¢¼ç™»å…¥ï¼Œå› æ­¤é è¨­ VM é€šå¸¸éƒ½æœƒæŠŠ SSH å¯†ç¢¼ç™»å…¥é—œé–‰ï¼Œå› æ­¤éœ€è¦é€é SSH key ç™»å…¥ï¼Œæˆ–è‘—ä½¿ç”¨æœ€å¾Œå¾Œæåˆ°çš„ cicustom ä¾†ä¿®æ”¹ SSH è¨­å®šã€‚ ä½¿ç”¨ Terraform # æ¥è‘—æˆ‘å€‘å°±è¦æ­é… Terraform ä¾†å°‡å®Œæˆè‡ªå‹•åŒ–éƒ¨å±¬äº†ã€‚(Proxmox provider)\né¦–å…ˆå‰é¢çš„æŒ‡ä»¤ä¸èƒ½ä¸Ÿï¼Œæˆ‘å€‘åœ¨æœ€å¾ŒåŠ ä¸Šä¸€è¡Œ qm template $VM_IDï¼Œå°‡ VM è½‰æˆæ¨¡æ¿ç”¨æ–¼å¾ŒçºŒçš„ Terraform éƒ¨å±¬ã€‚ é€™é‚Šä½¿ç”¨æ¨¡æ¿ï¼Œç›®å‰ç ”ç©¶èµ·ä¾†æœ‰å…©å€‹åŸå› ï¼Œé¦–å…ˆç¡¬ç¢Ÿã€cloud driverã€serial é€™äº›å›ºå®šè™›æ“¬ç¡¬é«”å’Œ cloud image å¯ä»¥ç›´æ¥è¤‡è£½ï¼Œè€Œä¸ç”¨åœ¨ Terraform ä¸Šé‡æ–°è¨­å®šã€‚ å¦å¤– proxmox çš„ terraform provider å¥½åƒä¸æ”¯æ´ importdisk é€™æ¨£å°å…¥ qcow2 å°è±¡æª”çš„æ–¹å¼ã€‚\né¦–å…ˆæ˜¯ provider çš„åŸºç¤è¨­å®š\nterraform { required_providers { proxmox = { source = \u0026#34;Telmate/proxmox\u0026#34; version = \u0026#34;2.9.11\u0026#34; } } } provider \u0026#34;proxmox\u0026#34; { # Configuration options pm_api_url = \u0026#34;https://127.0.0.1:8006/api2/json\u0026#34; pm_user = \u0026#34;root@pam\u0026#34; pm_password = \u0026#34;password\u0026#34; pm_tls_insecure = true } é€™é‚Šæˆ‘å€‘ç›´æ¥ä½¿ç”¨ root çš„å¸³è™Ÿå¯†ç¢¼ç™»å…¥ proxmox webï¼Œä¸éç‚ºäº†å®‰å…¨å’Œæ§ç®¡çš„è©±ï¼Œå»ºè­°é‚„æ˜¯å»ºç«‹é¡å¤–çš„ä½¿ç”¨è€…çµ¦ terraform ä½¿ç”¨ï¼Œä»¥åŠä½¿ç”¨ token ä¾†å–ä»£å¯†ç¢¼ã€‚\n# å»ºç«‹ terraform ä½¿ç”¨è€… pveum role add TerraformProv -privs \u0026#34;VM.Allocate VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Cloudinit VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Monitor VM.Audit VM.PowerMgmt Datastore.AllocateSpace Datastore.Audit\u0026#34; pveum user add terraform-prov@pve --password \u0026lt;password\u0026gt; pveum aclmod /-user terraform-prov@pve -role TerraformProv # å»ºç«‹ token pveum user token add terraform-prov@pve terraform-token æ¥è‘—æˆ‘å€‘é€é proxmox_vm_qemu è³‡æºä¾†å»ºç«‹ VM\nresource \u0026#34;proxmox_vm_qemu\u0026#34; \u0026#34;resource-name\u0026#34; { name = \u0026#34;VM-name\u0026#34; target_node = \u0026#34;Node to create the VM on\u0026#34; clone = \u0026#34;ubuntu-2004-focal-fossa\u0026#34; full_clone = true os_type = \u0026#34;cloud-init\u0026#34; onboot = true cores = 8 sockets = 1 cpu = \u0026#34;host\u0026#34; memory = 8192 balloon = 2048 scsihw = \u0026#34;virtio-scsi-pci\u0026#34; bootdisk = \u0026#34;virtio0 disk { slot = 0 size = \u0026#34;65536M\u0026#34; type = \u0026#34;scsi\u0026#34; storage = \u0026#34;local-lvm\u0026#34; iothread = 1 } ipconfig0 = \u0026#34;192.168.0.1/24,gw=192.168.0.254\u0026#34; ciuser=\u0026#34;username\u0026#34; cipassword=\u0026#34;password\u0026#34; sshkeys = file (\u0026#34;/root/.ssh/id_rsa.pub\u0026#34;) } é¦–å…ˆç•¶ç„¶æ˜¯æŒ‡å®šæˆ‘å€‘ VM çš„åå­é‚„æœ‰è¦é•·åœ¨ proxmox cluster çš„å“ªå°æ©Ÿå™¨ä¸Š (name, target_node)ã€‚ æ¥è‘—æˆ‘å€‘æŒ‡å®šæˆ‘å€‘è¦ clone çš„æˆ‘å€‘å‰›å‰›åšçš„ VM æ¨¡æ¿ (clone) ä¸¦æŒ‡å®šç‚ºå®Œæ•´è¤‡è£½ (full_clone)ï¼Œä»¥åŠæŒ‡å®š OS type ç‚º cloud-initã€‚\næ¥è‘—æ˜¯è¨­å®š VM çš„ CPUã€memory ç­‰ç¡¬é«”è¦æ ¼ï¼Œé€™é‚Šè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯é€™å…ˆåƒæ•¸çš„è¦æ ¼ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œä¸¦ä¸æœƒå¥—ç”¨æ¨¡æ¿çš„è¦æ ¼ï¼Œè€Œæ˜¯ provider é è¨­çš„è¦æ ¼ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦æŒ‡å®šé€™äº›åƒæ•¸ã€‚\næ¥è‘—æ¯”è¼ƒç‰¹åˆ¥çš„æ˜¯æˆ‘å€‘è¦é‡æ–°å®šç¾©æˆ‘å€‘çš„ç¡¬ç¢Ÿï¼Œå‰é¢é›–ç„¶æˆ‘å€‘å·²ç¶“å°‡ cloud image è½‰æˆç¡¬ç¢Ÿæ›è¼‰åˆ° VM ä¸Šäº†ï¼Œä½†æ˜¯é€™æ¨£æ›è¼‰ä¸Šå»ç¡¬ç¢Ÿå¤§å°æ˜¯çµ•å°ä¸å¤ ç”¨çš„ (ä»¥ ubuntu çš„ image ä¾†èªªåªæœ‰ 2G å¤šçš„ç¡¬ç¢Ÿå¤§å°)ï¼Œå› æ­¤æˆ‘å€‘é€™é‚Šè¤‡å¯«ä¿®æ”¹ scsi0 çš„ç¡¬ç¢Ÿå¤§å°ï¼Œcloud-init åœ¨ç¬¬ä¸€æ¬¡é–‹æ©Ÿçš„æ™‚å€™èƒ½å¤ è‡ªæˆ‘å¯Ÿè¦ºä¸¦ä¿®æ”¹åˆ†å‰²å€çš„å¤§å°ä¾†åŒ¹é…æ–°çš„ç¡¬ç¢Ÿå®¹é‡ã€‚\næœ€å¾Œå°±æ˜¯ cloud-init çš„è¨­å®šï¼Œé€™é‚Šæˆ‘å€‘æŒ‡å®š VM çš„ IPã€å¸³è™Ÿå¯†ç¢¼ã€ä»¥åŠ ssh keyã€‚\næœ€å¾Œå°±ä¸€æ¨£é€éæŒ‡ä»¤å®Œæˆè‡ªå‹•éƒ¨å±¬\nterraform init terraform apply åˆ°é€™é‚Šæˆ‘å€‘å°±å®Œæˆ terraform èˆ‡ proxmox æ­é…çš„è‡ªå‹•éƒ¨å±¬äº†ã€‚\nå…¶ä»–é›œç´€ # cicustom # å‰é¢æˆ‘å€‘éƒ½æ˜¯é€é proxmox æœ¬èº«çš„åŠŸèƒ½ä¾†ç”Ÿæˆ cloud-init çš„è¨­å®šæª”ï¼Œä½†æ˜¯ proxmox æä¾›çš„è¨­ç½®é¸é …æœ‰é™ï¼Œå› æ­¤æœ‰æ™‚å€™æˆ‘å€‘æœƒéœ€è¦ç›´æ¥ä¿®æ”¹ cloud-init çš„è¨­å®šæª”ï¼Œ åœ¨ proxmox ä¸Šæä¾›å…©ç¨®æ–¹å¼ä¾†ç›´æ¥è¨­å®š cloud-init è¨­å®šæª”çš„åƒæ•¸ï¼Œä¸€å€‹æ˜¯ç›´æ¥åœ¨æŒ‡ä»¤ä¸Šæä¾›åƒæ•¸å€¼ï¼Œå¦å¤–ä¸€å€‹æ˜¯ç›´æ¥æä¾› cloud-init çš„ yaml è¨­å®šæª”\nåœ¨ terraform ä¸Šé¢ï¼Œæˆ‘å€‘ä¸€æ¨£å¯ä»¥é€é cicustom è¨­å®šä¾†é”åˆ°ç›¸åŒçš„äº‹æƒ…ã€‚\nagent # åœ¨æŸ¥æ‰¾è³‡æ–™æ™‚ï¼Œåœ¨è¨±å¤šç¯„ä¾‹æœƒçœ‹åˆ°æŒ‡å®š agent åƒæ•¸ç‚º 0 æˆ– 1ï¼Œé€™é‚Šçš„ agent æŒ‡çš„æ˜¯ Qemu-guest-agentï¼Œç°¡å–®ä¾†èªªå°±æ˜¯åœ¨è™›æ“¬æ©Ÿå…§éƒ¨å®‰è£ä¸€å€‹ agent ä¾†ç•¶ä½œ proxmox ç›´æ¥æ“ä½œè™›æ“¬æ©Ÿå…§éƒ¨çš„å¾Œé–€ï¼Œä¸éå…·é«”çš„åŠŸèƒ½å°±ä¸åœ¨æœ¬ç¯‡çš„ç¯„åœå…§äº†ï¼Œä¸”é è¨­æƒ…æ³ä¸‹é€™å€‹åŠŸèƒ½æ˜¯é—œé–‰çš„ã€‚\nçµèª # é€™é‚Šç°¡å–®ç´€éŒ„äº†ä¸€ä¸‹ terraform å’Œ proxmox çš„æ­é…ä½¿ç”¨ï¼Œåœ¨ä¸€é–‹å§‹ç ”ç©¶çš„æ™‚å€™ï¼Œcloud-init é‚„æœ‰ä½¿ç”¨ VM template é€™å…©ä»¶äº‹ï¼Œæ˜¯ä¹‹å‰åœ¨ä½¿ç”¨ terraform æˆ– proxmox ä¸æœƒç‰¹åˆ¥æ³¨æ„åˆ°çš„æ±è¥¿ï¼Œå› æ­¤æœƒæœ‰é»æ··äº‚å’Œä¸çŸ¥é“åŠŸèƒ½ï¼Œå¸Œæœ›é€™ç¯‡æ–‡ç« èƒ½å¤ å¹«åŠ©åˆ°æœ‰éœ€è¦çš„äººã€‚\nåƒè€ƒè³‡æ–™ # Terraform Provider for Proxmox Proxmox Cloud-Init eBPF\n","date":"October 29 2022","externalUrl":null,"permalink":"/posts/deploy-proxmox-vm-with-terraform/","section":"æ–‡ç« ","summary":"","title":"ä½¿ç”¨ Terraform éƒ¨å±¬ Proxmox è™›æ“¬æ©Ÿ","type":"posts"},{"content":" å‰è¨€ # åœ¨å˜—è©¦å¸ƒå»º openstack çš„éç¨‹ä¸­ï¼Œå¡é—œæœ€ä¹…çš„æ‡‰è©²æ˜¯ç¶²è·¯çš„éƒ¨åˆ†ï¼Œç”±æ–¼åœ¨è¨­ç½® openstack çš„éç¨‹ä¸­ï¼Œéœ€è¦å…ˆæŠŠç¶²è·¯ä»‹é¢å’Œç·šè·¯é€£æ¥è¨­å®šå¥½ï¼Œæ‰€ä»¥å¿…é ˆè¦å° openstack çš„ç¶²è·¯æ¶æ§‹ï¼Œæœ‰æ¸…æ™°çš„èªçŸ¥ï¼Œä¸ç„¶åœ¨è¨­ç½®çš„éç¨‹ä¸­æœƒé‡åˆ°è¨±å¤šéšœç¤™â€¦\nç‰¹åˆ¥æ˜¯ openstack æœ‰ flat, vlan, vxlan ä»¥åŠ provider, self-service å…©ç¨®ä¸åŒç¶­åº¦çš„æ¦‚å¿µåˆ†é¡ï¼Œå› æ­¤åœ¨é‡æ¸…çš„éç¨‹ä¸­èŠ±è²»è¨±å¤šæ™‚é–“ï¼Œå› æ­¤é€™é‚Šæ•´ç†ä¸€ä¸‹ openstack çš„å„ç¨®ç¶²è·¯æ¶æ§‹ã€‚\né€™ç¯‡æ–‡ç« ä¸æœƒä»‹ç´¹å…·é«”çš„ openstack æ­å»ºï¼Œä¸éä¹‹å¾Œæœƒæœ‰ä¸€ç¯‡ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ openstack-ansible ä¾†éƒ¨å±¬ openstackã€‚\né¦–å…ˆç‚ºäº†å¾ŒçºŒè¨è«–æ–¹ä¾¿æˆ‘å€‘é€™é‚Šè¦å…ˆå¹« openstack è£¡é¢çš„å¹¾å€‹ç¶²è·¯å±¤ç´šè¨‚å€‹åå­ã€‚\nç‰©ç†ç¶²è·¯ï¼šç”± openstack ç¯€é»ä¸Šé¢çš„å¯¦é«”ç¶²å¡ä»¥åŠçµé»å¤–çš„ç¶²è·¯æ§‹æˆ è¦†è“‹ (Overlay) ç¶²è·¯ï¼šä»¥è™›æ“¬æ©Ÿçš„è¦–è§’çœ‹åˆ°çš„ L2 ç¶²è·¯å¾ŒçºŒæœƒæŒçºŒå‡ºç¾é€™ä¸‰å€‹åè©ï¼Œåœ¨ä»‹ç´¹çš„éç¨‹ä¸­ä¾†è§£é‡‹å’Œåˆ†æé€™ä¸‰è€…çš„å·®åˆ¥ã€‚ Openstack ç¶²è·¯é¡å‹æ¦‚å¿µ # é¦–å…ˆæˆ‘å€‘å…ˆæ’‡é–‹ openstackï¼Œæˆ‘å€‘çœ‹ä¸€å€‹æœ€ç°¡å–®åœ¨å¤šå°å¯¦é«”è¨­å‚™ä¸Šé¢è£è¨­è™›æ“¬æ©Ÿæ§‹å»ºå‡ºä¾†çš„ä¸€å€‹ç¶²è·¯çµæ§‹ã€‚\nåœ¨é€™å€‹æ¶æ§‹è£¡ï¼Œæ‰€æœ‰çš„ VM å’Œå¯¦é«”ç¶²å¡éƒ½æ¥åœ¨åŒä¸€å€‹ linux bridge ä¸Šï¼Œç”±æ–¼å¯¦é«”ç¶²å¡ä¹Ÿæ©‹æ¥åœ¨ bridge ä¸Šäº†ï¼Œæ‰€ä»¥ç¯€é»ä¸Šçš„è¦†è“‹ç¶²è·¯æ˜¯ç‰©ç†ç¶²è·¯çš„å»¶ä¼¸ï¼Œå¯ä»¥çœ‹æˆæ‰€æœ‰å¯¦é«”å…±åŒæ§‹æˆäº†ä¸€å€‹ L2 ç¶²è·¯ã€‚ ç”±æ–¼ bridge æœ¬èº«å¯ä»¥çµ¦äºˆ IPï¼Œç•¶æˆæ˜¯æ¥åœ¨ç¯€é»ä¸Šçš„ç¶²è·¯ä»‹é¢ï¼Œå› æ­¤ VM å’Œç¯€é»æœ¬èº«ä¹Ÿéƒ½åŒåœ¨ä¸€å€‹ L2 ç¶²è·¯å…§å½¼æ­¤äº’ç›¸å¯è¦‹ã€‚ åœ¨é€™å€‹ç¶²è·¯æ¶æ§‹ä¸­ï¼Œç‰©ç†ç¶²è·¯å’Œè¦†è“‹ç¶²è·¯æ˜¯å®Œå…¨ç­‰åƒ¹é€šé€çš„ã€‚\nFlat network # æ¥è‘—æˆ‘å€‘åŠ å…¥ openstack çš„çµ„ä»¶ã€‚ é¦–å…ˆæ˜¯ controller ç¯€é»ï¼Œæˆ‘å€‘åœ¨ controller ç¯€é»ä¸Šéƒ¨å±¬äº† openstack çš„ API æœå‹™ã€‚ æ¥è‘—æˆ‘å€‘åœ¨ compute ç¯€é»ä¸Šå¢åŠ ä¸€å¼µå¯¦é«”ç¶²å¡ eth1 è®“ç¯€é»ä¸Šçš„ nova agent å’Œ neutron agent å¯ä»¥èˆ‡ contrroller node æºé€šã€‚ åœ¨é€™å€‹æ¶æ§‹ä¸­ï¼Œæ‰€æœ‰çš„ service å’Œ agent æ˜¯ç›´æ¥å®‰è£åœ¨ç¯€é»ä¸Šçš„ç¨‹å¼ï¼Œå› æ­¤å¯ä»¥é€é eth1 å¯¦é«”ç¶²å¡çš„ ip ç›´æ¥é€²è¡Œè¨ªå•ã€‚ åœ¨åœ–ä¸­çš„ linux bridge æ›äº†é¡è‰²ï¼Œå› ç‚ºé€™å€‹ bridge ä¸¦ä¸æ˜¯ç”±æˆ‘å€‘æ‰‹å‹•å»ºç«‹å‡ºä¾†çš„è€Œæ˜¯ç”± neutron agent è‡ªè¡Œå»ºç«‹å‡ºä¾†çš„ã€‚åŒæ™‚ç•¶ nova å»ºç«‹ VM å¾Œï¼Œneutron ä¹Ÿæœƒå»ºç«‹ veth pair é€£æ¥ bridge å’Œ VMã€‚ åˆ°æ­¤æˆ‘å€‘å°±å»ºç«‹äº†æœ€ç°¡å–®çš„ openstack ç¶²è·¯ï¼Œåœ¨é€™å€‹ç¶²è·¯æ¶æ§‹ä¸‹é›–ç„¶ç¯€é»æœ¬èº«çš„ç¶²è·¯å¾ bridge åˆ†é›¢å‡ºä¾†æˆç‚ºäº†ç¨ç«‹çš„ç¶²å¡ï¼Œä½†æ˜¯ç¯€é»æœ¬èº«å’Œæ‰€æœ‰çš„ VM é‚„æ˜¯åŒè™•åœ¨ä¸€å€‹ L2 ç¶²è·¯å…§ï¼Œå› æ­¤åœ¨é€™å€‹ç¶²è·¯æ¶æ§‹ä¸­ï¼Œç‰©ç†ç¶²è·¯å’Œè¦†è“‹ç¶²è·¯æ˜¯å®Œå…¨ç­‰åƒ¹é€šé€çš„ã€‚\nåˆ°æ­¤æˆ‘å€‘å°±å»ºæ§‹äº† neutron çš„ç¬¬ä¸€å€‹ç¨®ç¶²è·¯æ¨¡å¼ flatã€‚Neutron çš„ä¸åŒæ¨¡å¼å·®ç•°åœ¨æ–¼èªª neuitron ç®¡ç†çš„ bridge æ˜¯å¦‚ä½•æ¥å…¥ç‰©ç†ç¶²è·¯çš„ã€‚åœ¨ flat æ¨¡å¼ä¸‹å°å¤–ç¶²å¡ç›´æ¥æ©‹æ¥åˆ° bridge ä¸Šï¼Œä¸å°å°åŒ…åšè™•ç†ã€‚\nåœ¨ openstack ä¸­æœ‰ tenant networks ç§Ÿæˆ¶ç¶²è·¯çš„æ¦‚å¿µï¼Œæˆ‘å€‘å¯ä»¥åœ¨ openstack ä¸Šåˆ‡å‡ºè‹¥å¹²å€‹ç¨ç«‹çš„ L2 ç¶²è·¯ï¼Œåˆ†çµ¦ä¸åŒçš„ project å’Œ vms ä½¿ç”¨ã€‚åœ¨ä½¿ç”¨å–®ä¸€å€‹ flat ç¶²è·¯çš„æ™‚å€™ï¼Œé€™ä»¶äº‹æ˜¯åšä¸åˆ°äº†ï¼Œå› ç‚ºæ‰€æœ‰ VM éƒ½åœ¨åŒä¸€å€‹ L2 ç¶²è·¯å…§ã€‚\nç›´è§€çš„ç¬¬ä¸€å€‹æ–¹æ³•ç•¶ç„¶æ˜¯åˆ‡å‡ºå¤šå€‹ flat network çµ¦ä¸åŒçš„ tenat ä½¿ç”¨ï¼Œç„¶è€Œé€™æ¨£ä½¿ç”¨çš„é™åˆ¶éå¸¸å¤§ï¼Œé¦–å…ˆæˆ‘å€‘éœ€è¦æ›¿æ¯å€‹ flat é å…ˆåˆ‡å‡ºç¨ç«‹çš„ L2 ç¶²è·¯ï¼Œåœ¨é€™å€‹ç¯„ä¾‹ä¸­æˆ‘å€‘ä½¿ç”¨ç¨ç«‹çš„ç¶²å¡å’Œäº¤æ›æ©Ÿä¾†åˆ†å‰²ï¼Œéå¸¸éº»ç…©ã€‚\nå› æ­¤æ¯”è¼ƒå¯è¡Œçš„æ–¹æ³•æ˜¯ä½¿ç”¨ vlan æˆ– vxlan ä¾†åˆ‡å‰²ç§Ÿæˆ¶ç¶²è·¯ï¼Œä¸¦å°‡ vlanã€vxlan çš„å»ºç«‹ç®¡ç†äº¤çµ¦ neutron agent ä¾†è™•ç†ã€‚\nVlan networ # é¦–å…ˆæ˜¯ vlan æ¨¡å¼ï¼Œåœ¨ vlan æ¨¡å¼ä¸‹æˆ‘å€‘ä¸€æ¨£æä¾›ä¸€å€‹ç¶²è·¯ä»‹é¢ eth0 çµ¦ neutron ä½¿ç”¨ï¼Œä¸¦ä¸€æ¨£å‡è¨­æ‰€æœ‰ç¯€é»ä¸Šçš„ eth0 ä»‹é¢éƒ½åœ¨ L2 äº’é€šã€‚\næ¥è‘—ç•¶æˆ‘å€‘é€é openstack å»ºç«‹ç¶²è·¯ä¸¦æŒ‡å®šç‚º vlan type æ™‚ï¼Œneutron æœƒæ›¿è©²ç¶²è·¯åˆ†é…ä¸€å€‹ vlan idï¼Œä¸¦å»ºç«‹å°æ‡‰çš„ vlan ç¶²è·¯å¡ï¼Œvlan ç¶²è·¯å¡æ˜¯ linux æœ¬èº«çš„åŠŸèƒ½ï¼Œç¶“é vlan ç¶²è·¯å¡çš„å°åŒ…æœƒå¾è©²ç¶²è·¯å¡æ¦œå®šçš„åŸå§‹ç¶²å¡é€å‡ºå» (eth0)ï¼Œä½†æ˜¯å°åŒ…æœƒåŠ ä¸Š vlan ç¶²å¡ç¶å®šçš„ vlan idã€‚\nå¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œæˆ‘å€‘åˆ‡å‰²å‡ºäº† vlan 356 å’Œ vlan 357 å…©å€‹ç§Ÿæˆ¶ç¶²è·¯ï¼Œä¸¦çµ±ä¸€é€é eth0 ç‰©ç†ç¶²è·¯èˆ‡å…¶ä»–ç¯€é»æºé€šã€‚\nVxlan network # é¦–å…ˆæˆ‘å€‘å…ˆä»‹ç´¹ä¸€ä¸‹ vxlanã€‚å’Œ vlan çš„åŠŸèƒ½é¡ä¼¼ï¼Œvxlan çš„åŠŸèƒ½ä¹Ÿæ˜¯åœ¨ä¸€å€‹ç¶²è·¯å…§åˆ‡å‰²å‡ºå¤šå€‹è¦†è“‹ç¶²è·¯ï¼Œä¸éæ•™æ–¼ vlanï¼Œvxlan æœ‰ä»¥ä¸‹ç‰¹é»ï¼š\nvlan id åªèƒ½å¤ åˆ‡å‡º 4096 å€‹ç¶²è·¯ï¼Œä½†æ˜¯ vxlan id å¯ä»¥åˆ‡å‡º 2 çš„ 24 æ¬¡æ–¹å€‹ç¶²è·¯ã€‚ vlan åªæ˜¯åœ¨ ethernet header å’Œ IP header ä¸­é–“æ’äº†ä¸€å€‹ vlan headerï¼Œå› æ­¤ vlan åªèƒ½åœ¨ L2 çš„ç‰©ç†ç¶²è·¯å…§å‚³è¼¸ã€‚ä½†æ˜¯ vxlan çš„å°è£æ–¹å¼æ˜¯å°‡æ•´å€‹ L2 å°åŒ…åŠ ä¸Šä¸€å€‹ vxlan header å¾Œï¼Œå°è£åœ¨ä¸€å€‹ UDP å°åŒ…å…§ï¼Œå› æ­¤é€éå¤–é¢çš„ UDP å°åŒ…ï¼Œvxlan èƒ½å¤ è·¨è¶Š L3 ç¶²è·¯å»ºç«‹ L2 çš„é€šé“ï¼Œé€£çµå…©å€‹ä¸ç›¸é€£çš„ L2 ç¶²è·¯ã€‚ åœ¨ Linux ä¸Šå»ºç«‹ vxlan ä»‹é¢æ™‚è¦æŒ‡å®šå…©å€‹æ±è¥¿ï¼Œä¸€å€‹æ˜¯ vni (vxlan id), å¦ä¸€å€‹æ˜¯ local ipï¼Œç•¶å°åŒ…é€šå…± vxlan ä»‹é¢æ™‚ï¼Œæœƒè¢«åŠ ä¸ŠåŒ…å« vni çš„ vxlan idï¼Œå¤–éƒ¨çš„ UDP å°åŒ…å‰‡æœƒåˆ©ç”¨ local ip ç•¶ä½œ src ipï¼ŒåŒæ™‚åˆ©ç”¨è©² local ip å°æ‡‰çš„ interface ä¾†æ”¶ç™¼ vxlan å°åŒ…ã€‚\nåœ¨ vlan ç¶²è·¯è£¡é¢ï¼Œç”±æ–¼ vlan ä¸€æ¨£æ˜¯ L2 å°åŒ…ï¼Œå› æ­¤å°åŒ…æ˜¯é€é L2 çš„å»£æ’­å­¸ç¿’æ©Ÿåˆ¶ä¾†å‚³éçš„ã€‚ç„¶è€Œå¦‚å‰é¢æ‰€ç¤ºï¼Œvxlan å°åŒ…æœƒå°è£æˆ UDP å°åŒ…ï¼Œå› æ­¤ vxlan é çš„æ˜¯ L3 çš„è·¯ç”±æ©Ÿåˆ¶ä¾†å‚³éã€‚\nåœ¨ Linux ä¸Šé€™å€‹è·¯ç”±æ©Ÿåˆ¶æœ‰å¹¾ç¨®ä½œæ³•\nåœ¨å»ºç«‹ vxlan interface æ™‚ç›´æ¥æŒ‡å®š remote ipï¼Œå»ºç«‹æˆé»å°é»çš„ vxlan tunnel\né€é linux bridge forwarding databaseï¼Œä¸‹é” forwarding ruleï¼ŒæŒ‡å®šç•¶ L2 å°åŒ…çš„ mac address æ˜¯å¤šå°‘çš„æ™‚å€™è¦é€åˆ°å“ªå€‹ remote ip\næœ€å¾Œä¹Ÿæ˜¯ openstack ä½¿ç”¨çš„æ–¹å¼ï¼Œå°‡å°åŒ…ç™¼é€åˆ°ä¸€å€‹ L3 å»£æ’­åœ°å€ (ä¾‹å¦‚ 239.1.1.1)ï¼Œlinux æœƒè‡ªå‹•åœ¨ L2 åŠ ä¸Š multicast mac addressï¼Œæ‰€æœ‰åœ¨åŒä¸€å€‹ L2 ç‰©ç†ç¶²è·¯ä¸Šçš„è¨­å‚™å°±èƒ½å¤ åŒæ™‚æ”¶åˆ° vxlan çš„å°åŒ…ã€‚å›åˆ° openstack ä¸Šï¼Œåœ¨è¨­ç½® vxlan æ™‚å’Œ vlanã€flat ä¸å¤ªä¸€æ¨£ï¼Œæˆ‘å€‘ä¸ç”¨æŒ‡å®šç¶å®šçš„ç¶²è·¯ä»‹é¢ (eth0)ï¼Œè€Œæ˜¯è¦æŒ‡å®š local_ip è·Ÿ vxlan_groupï¼Œå‰è€…å°æ‡‰åˆ°ç¶å®šè§£é¢ (eth0) çš„ IPï¼Œå¾Œè€…å‰‡æ˜¯ vxlan å»£æ’­åŸŸçš„ IP (239.1.1.1)ã€‚å¾Œé¢å°±å’Œ vlan ä¸€æ¨£ï¼Œåœ¨ openstack ä¸Šå»ºç«‹çš„ç¶²è·¯æ™‚ï¼Œnetruon ç‚ºè©²ç¶²è·¯å»ºç«‹å°æ‡‰çš„ vxlan ä»‹é¢å’Œ linux bridgeï¼Œä¾†æä¾›çµ¦è©²ç¶²è·¯çš„è™›æ“¬æ©Ÿä½¿ç”¨ã€‚\né›–ç„¶åœ¨ä¸€å°ç¯€é»ä¸Šé¢ä¸å¤ªå¯èƒ½é–‹åˆ° 4096 å€‹ tenantï¼Œä½†æ˜¯åœ¨æ•´å€‹ openstack å¢é›†å…§å¯ä»¥å°‡ä¸åŒ tenant åˆ†é…åœ¨ä¸åŒçš„ç¯€é»ä¸Šï¼Œå› æ­¤ vxlan æ˜¯æœ‰æ„ç¾©çš„ã€‚\nOpenstack ç¶²è·¯è¨­ç½® # åœ¨ openstack neutron ä¸­ï¼Œæˆ‘å€‘è¦è¨­å®šæ¯å€‹ç¯€é»ä¸Šçš„ ml2 è¨­å®šæª”ä¾†æä¾› neutron ç¶²è·¯çš„åŸºæœ¬è³‡è¨Šã€‚è·¯å¾‘åœ¨ /etc/neutron/plugins/ml2/ã€‚\n# /etc/neutron/plugins/ml2/ml2_conf.ini [ml2] type_drivers = flat,vlan,vxlan,local tenant_network_types = vxlan,vlan,flat mechanism_drivers = linuxbridge extension_drivers = port_security é¦–å…ˆå°æ–¼ä¸Šè¿°ä¸‰ç¨®ä¸åŒçš„ç¶²è·¯é¡å‹ï¼Œå¦‚æœè¦åœ¨ openstack å…§ä½¿ç”¨éœ€è¦æŒ‡å®šå•Ÿç”¨å°æ‡‰çš„ type_driversã€‚(é™¤äº†å‰é¢ä»‹ç´¹çš„ä¸‰ç¨®ç¶²è·¯é¡å‹ï¼Œé‚„æœ‰ local è·Ÿ gre é€™å…©ç¨®ï¼Œå‰è€…ç”¨æ–¼å–®æ©Ÿæƒ…æ³ neutron çš„ linux bridge ä¸é€£æ¥åˆ°ä»»ä½•å°å¤–ç¶²è·¯ï¼Œå¾Œè€…ä½¿ç”¨ gre tunnel ä¾†å–ä»£ vxlan tunnelï¼Œé€™é‚Šä¸å¤šä½œä»‹ç´¹) æ¥è‘— tenant_network_types è¡¨ç¤ºåœ¨ openstack è¨­å¯ä»¥ç”¨æ–¼å»ºç«‹ project ç§Ÿæˆ¶ç¶²è·¯çš„ç¶²è·¯é¡å‹ï¼ŒåŒæ™‚é †åºä¹Ÿä»£è¡¨äº†åœ¨å»ºç«‹ç¶²è·¯æ™‚é è¨­ä½¿ç”¨çš„ç¶²è·¯é¡å‹å„ªå…ˆé †åºã€‚ mechanism_drivers é€™é‚ŠæŒ‡å®šæ˜¯ linuxbridgeï¼Œå‰é¢æåˆ° neutron æœƒå»ºç«‹ bridge ä¾†é€£æ¥ VM è·Ÿå¤–éƒ¨ç¶²è·¯ä»‹é¢ï¼Œå…¶å¯¦é€™é‚Šé‚„æœ‰å¾ˆå¤šå…¶ä»–é¸é …ï¼Œä¾‹å¦‚ open vSwitchï¼Œä¾†æä¾›æ›´å¤šç¶²è·¯ç®¡ç†åŠŸèƒ½ï¼Œä½†æ˜¯é€™é‚Šå°±åªä»¥ linux bridge ç‚ºä¸»è¦ä»‹ç´¹å°è±¡ã€‚ extension_drivers å‰‡å¯ä»¥è¼‰å…¥å…¶ä»– plugin ä¾†æä¾› QoSã€å®‰å…¨ç®¡ç†çš„åŠŸèƒ½ã€‚ æ¥è‘—æˆ‘å€‘è¦è¨­å®šç‰©ç†ç¶²è·¯å’Œç¶²è·¯ä»‹é¢çš„å°æ‡‰ï¼Œåœ¨ flat å’Œ vlan ç¶²è·¯æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘éƒ½éœ€è¦å°‡ç¶²è·¯èˆ‡ä¸€å¼µå¯ä»¥é€£æ¥åˆ°ç‰©ç†ç¶²è·¯çš„ç¶²è·¯ä»‹é¢åšç¶å®š (å‰é¢çš„ eth0 æˆ– eth1)ï¼Œä½†æ˜¯åœ¨å¯¦éš›æƒ…æ³ä¸­ï¼Œæ¯å€‹ç¯€é»ä¸Šç¶²è·¯ä»‹é¢å¡çš„åç¨±å¯èƒ½ä¸ç›¸é€šï¼Œå› æ­¤éœ€è¦åœ¨æ¯å€‹ç¯€é»ä¸ŠæŒ‡å®šç‰©ç†ç¶²è·¯å’Œç¶²è·¯ä»‹é¢çš„å°æ‡‰ã€‚\n# /etc/neutron/plugins/ml2/linuxbridge_agent.ini [linux_bridge] physical_interface_mappings = vlan1:eth0,flat1:eth1,flat2:eth2 æ¥è‘—å°ä¸åŒçš„ç¶²è·¯é¡å‹æœ‰å„è‡ªçš„ç¶²è·¯è¨­ç½®ï¼Œé¦–å…ˆæ˜¯ flatï¼Œè¦æŒ‡å®šçš„æ±è¥¿å¾ˆç°¡å–®ï¼Œå°±æ˜¯å¯ä»¥ç”¨æ–¼å»ºç«‹ flat network çš„ç‰©ç†ç¶²è·¯ï¼Œå¦‚æœæ‰€æœ‰ç¶²è·¯éƒ½å¯ä»¥ï¼Œå‰‡æŒ‡å®šç‚º *\n# /etc/neutron/plugins/ml2/ml2_conf.ini [ml2_type_flat] flat_networks = flat1, flat2 # Example:flat_networks = * åœ¨ vlan éƒ¨åˆ†å‰‡è¦æŒ‡å®šåœ¨æ¯å€‹ç‰©ç†ç¶²è·¯ä¸Šå…è¨±çš„ç§Ÿæˆ¶ç¶²è·¯ vlan idï¼Œæ ¼å¼æ˜¯\u0026lt;physical_network\u0026gt;[:\u0026lt;vlan_min\u0026gt;:\u0026lt;vlan_max\u0026gt;]\n# /etc/neutron/plugins/ml2/ml2_conf.ini [ml2_type_vlan] network_vlan_ranges = vlan1:101:200,vlan1:301:400 æœ€å¾Œ vxlan åˆ†æˆå…©å€‹éƒ¨åˆ†ï¼Œé¦–å…ˆå’Œ vlan é¡ä¼¼ï¼Œæˆ‘å€‘è¦æŒ‡å®šå¯ä½¿ç”¨çš„ vxlan vni å’Œå»£æ’­åŸŸ ip\n# /etc/neutron/plugins/ml2/ml2_conf.ini [ml2_type_vxlan] vxlan_group = 239.1.1.1 vni_ranges = 1:1000 æ¥è‘—æˆ‘å€‘è¦è¨­ç½®ç¶å®šçš„ç¶²å¡ ip\n# /etc/neutron/plugins/ml2/linuxbridge_agent.ini [vxlan] enable_vxlan = True vxlan_group = 239.1.1.1 # VXLAN local tunnel endpoint local_ip = 192.168.56.101 l2_population = False ttl = 32 é€™é‚Šæœ‰ä¸€å€‹ç‰¹åˆ¥çš„æ±è¥¿æ˜¯ l2 populationï¼Œl2 population æ˜¯ä¸€ç¨®é™ä½å»£æ’­å°åŒ…é€ æˆç¶²è·¯è² è¼‰çš„æ–¹å¼ï¼Œåœ¨å‚³çµ±ç¶²è·¯å…§ ARP å°åŒ…éœ€è¦å»£æ’­åˆ°æ‰€æœ‰çš„ç¯€é»ä¸Šï¼Œå¤§å¤§å¢åŠ çš„ç¶²è·¯çš„è² æ“”ï¼Œé€é l2 population æä¾›çš„ proxy ARP æ©Ÿåˆ¶ï¼ŒARP æœƒåœ¨ç¯€é»ä¸Šç›´æ¥ç”± neutron å›æ‡‰ï¼Œè€Œä¸ç”¨é€éç‰©ç†ç¶²è·¯å»£æ’­åˆ°æ‰€æœ‰ç¯€é»ä¸Šï¼Œå¤§å¤§é™ä½ç¶²è·¯è² æ“”ï¼Œç”±æ–¼ openstack å…§æ‰€æœ‰çš„ VM IPã€ç¶²å¡ mac address éƒ½æœƒå—åˆ° openstack çš„ç®¡ç†ï¼Œå› æ­¤ openstack å¯ä»¥åšåˆ° proxy ARPã€‚å¦‚æœéœ€è¦å•Ÿç”¨ l2 population å‰‡éœ€è¦é¡å¤–çš„ driverï¼Œé€™é‚Šä¸€æ¨£ä¸åšè©³ç´°ä»‹ç´¹ã€‚\næœ€å¾Œæ˜¯ç¶²è·¯å®‰å…¨çš„éƒ¨åˆ†ï¼Œåœ¨ openstack æˆ‘å€‘å¯ä»¥ä½¿ç”¨ iptables ä¾†å»ºç«‹ VM çš„ç¶²è·¯ç®¡ç†ï¼Œiptables æœƒé˜»æ“‹æ‰€æœ‰é€²å‡ºè™›æ“¬æ©Ÿç¶²è·¯çš„æµé‡ï¼Œä¸¦é€é security group ä¾†ä¸‹é” iptables çš„è¦å‰‡å…è¨±ç‰¹å®šæµé‡é€²å‡ºã€‚\n# /etc/neutron/plugins/ml2/linuxbridge_agent.ini [securitygroup] firewall_driver = iptables enable_security_group = True # /etc/neutron/plugins/ml2/ml2_conf.ini [securitygroup] enable_security_group = True enable_ipset = True Provider vs Self-service networks # æ¥è‘—æˆ‘å€‘è¦ä»‹ç´¹ openstack è£¡é¢å¦å¤–ä¸€å€‹é‡è¦çš„ç¶²è·¯æ¦‚å¿µï¼Œprovider network è·Ÿ self-service network çš„å·®åˆ¥ã€‚\né¦–å…ˆè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ï¼Œé€™é‚Šæåˆ°çš„åˆ†é¡æ–¹å¼å’Œå‰é¢çš„ç¶²è·¯é¡å‹æ˜¯å…©ç¨®ä¸åŒçš„è§’åº¦å’Œåˆ†é¡æ–¹å¼ã€‚\né›–ç„¶ flat network é€šå¸¸æœƒæ­é… provider networksï¼Œvlan å’Œ vxlan é€šå¸¸æœƒæ­é… self service network ä½†æ˜¯é€™ä¸¦ä¸æ˜¯ä¸€å®šè€Œä¸”å¿…è¦çš„ã€‚\nå‰é¢çš„ç¶²è·¯é¡å‹æˆ‘å€‘æ¢è¨çš„æ˜¯è¦å¦‚ä½•åœ¨è·¨ç¯€é»çš„ç¶²è·¯æ¶æ§‹ä¸‹æä¾›ä¸€å€‹æˆ–å¤šå€‹ L2 ç¶²è·¯è®“ VMs ä¹‹é–“å¯ä»¥å½¼æ­¤é€£æ¥ã€‚\né€™é‚Š provider å’Œ self-service çš„å·®åˆ¥å‰‡æ˜¯è¦æ¢è¨ï¼Œå¦‚ä½•æä¾›å‰é¢åˆ‡å‰²å‡ºä¾†çš„ç¶²è·¯ L3 çš„ç¶²è·¯åŠŸèƒ½ (gateway, routingâ€¦)\nåœ¨ provider ç¶²è·¯æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘å‡è¨­ L3 çš„ç¶²è·¯åŠŸèƒ½å¯ä»¥ç›´æ¥ç”±ç‰©ç†ç¶²è·¯æä¾›ï¼Œå› æ­¤ openstack åªè² è²¬æä¾› DHCPï¼Œä»¥åŠå°‡è™›æ“¬æ©Ÿæ¥åˆ°ç‰©ç†ç¶²è·¯ä¸Šï¼Œå…¶é¤˜çš„ gateway, routing åŠŸèƒ½ï¼Œopenstack åªå‡è¨­å­˜åœ¨ï¼Œä¸å¤šåšè™•ç†ã€‚åœ¨æœ€ç°¡å–®çš„ flat ç¶²è·¯æ¨¡å¼ä¸‹é€™éº¼åšç•¶ç„¶æ˜¯éå¸¸ç°¡å–®å¯è¡Œçš„ï¼Œæœ€ç°¡å–®çš„æ–¹æ³•å°±æ˜¯å°‡ flat ç¶²è·¯ç›´æ¥æ¥å…¥ç¯€é»é–“ openstack ç®¡ç†ç”¨çš„ç¶²æ®µï¼Œä¸¦èˆ‡ç¯€é»å…±ç”¨ ip subnetï¼Œç›´æ¥ç”±ç‰©ç†ç¶²è·¯æä¾›åŠŸèƒ½ã€‚\nç„¶è€Œåœ¨ vlan å’Œ vxlan æ¨¡å¼ä¸‹ä½¿ç”¨ proider ç¶²è·¯å°±ä¸æ˜¯é€™éº¼å¥½ç”¨äº†ï¼Œå‰é¢æåˆ°ç›¸è¼ƒæ–¼ flatï¼Œvlan å’Œ vxlan çš„ç‰¹é»å°±æ˜¯èƒ½å¤ å‹•æ…‹å»ºç«‹ç¨ç«‹çš„ç§Ÿæˆ¶ç¶²è·¯ï¼Œå¦‚æœè¦ä½¿ç”¨ provider æ©Ÿåˆ¶ï¼Œè®Šæˆèªªæˆ‘å€‘è¦å°å…¥é¡å¤–çš„è‡ªå‹•åŒ–æ–¹å¼ï¼Œæ›¿æ¯å€‹ vlan æˆ– vxlan æä¾› gateway çš„åŠŸèƒ½ï¼Œå› æ­¤é€šå¸¸æœƒä½¿ç”¨ self-service networkã€‚\nself-service network æŒ‡çš„æ˜¯ openstack self serviceï¼Œä¹Ÿå°±æ˜¯ç”± openstack æœ¬èº«ä¾†æä¾› L3 ç¶²è·¯çš„ gateway, router çš„åŠŸèƒ½ã€‚\nç‚ºäº†è¦æä¾› router çš„åŠŸèƒ½ï¼Œopenstack çš„ä½œæ³•æ˜¯ä½¿ç”¨ network namespaceã€‚\né¦–å…ˆæˆ‘å€‘éœ€è¦åœ¨ä¸€å€‹ç¯€é»ä¸Šéƒ¨ç½² neutron çš„ L3 agentã€‚ ç•¶æˆ‘å€‘é€é openstack çš„ API å»ºç«‹ä¸€å€‹ virtual router çš„æ™‚å€™ï¼Œnetron L3 agent æœƒåœ¨ç¯€é»ä¸Šå»ºç«‹ä¸€å€‹ç¨ç«‹çš„ network namespace ç•¶ä½œé€™å° virtual router çš„ä¸»é«”ã€‚\næ¥è‘—æˆ‘å€‘å°±å¯ä»¥å°‡ä¸åŒçš„ç§Ÿæˆ¶ç¶²è·¯æ¥å…¥ routerï¼Œé€é linux æœ¬èº«çš„ iptables, routing çš„åŠŸèƒ½ä¾†æä¾›ç§Ÿæˆ¶ç¶²è·¯é–“ routing çš„åŠŸèƒ½ã€‚\næˆ‘å€‘ä¹Ÿå¯ä»¥é€éæŠŠå…¶ä¸­ä¸€å€‹ç§Ÿæˆ¶ç¶²è·¯æˆ– flat ç¶²è·¯æ¥å…¥ç‰©ç†ç¶²è·¯ï¼Œä½¿ç”¨ provider network çš„æ–¹å¼ï¼Œå…¶ä»–çš„ç§Ÿæˆ¶ç¶²è·¯å¯ä»¥é€é virtual router routing åˆ° provider network çš„ç§Ÿæˆ¶ç¶²è·¯ä¾†ä¸Šç¶²ã€‚\nOpenstack self-service æŒ‡ä»¤ # é€™é‚Šè£œå……ä¸€ä¸‹å¦‚ä½•é€é cli åœ¨ openstack ä¸Šå»ºç«‹ router é‚„æœ‰æŠŠç§Ÿæˆ¶ç¶²è·¯åŠ å…¥ router\nopenstack router create router1 é¦–å…ˆå»ºç«‹ router1\nopenstack port create --network net1 net1-router-port æ¥è‘—ç‚ºäº†è®“ç§Ÿæˆ¶ç¶²è·¯èƒ½å¤ â€œæ¥ç·šâ€åˆ° routerï¼Œæˆ‘å€‘éœ€è¦å¹«ç¶²è·¯å»ºç«‹ä¸€å€‹ port\nopenstack router add port router1 net1-router-port æœ€å¾ŒæŠŠ port æ¥åˆ° router ä¸Š\n","date":"October 5 2022","externalUrl":null,"permalink":"/posts/openstack-deployment-serial-1-network-architecure-and-config/","section":"æ–‡ç« ","summary":"","title":"OpenStack æ¶è¨­ç³»åˆ— (1) - ç¶²è·¯æ¶æ§‹è§£æåŠè¨­ç½®","type":"posts"},{"content":" å‰è¨€ # é€™æ¬¡ä¾†å˜—è©¦å¯«å¯«çœ‹ spec å°è®€ï¼Œä»Šå¤©è¦è¬›çš„æ˜¯ Container Network Interface (CNI) Specificationã€‚CNI æ˜¯ CNCF çš„ä¸€å€‹å°ˆæ¡ˆï¼Œé€™å€‹å°ˆæ¡ˆåŒ…å«äº†ä»Šå¤©è¦è¬›çš„ CNI SPEC ä»¥åŠåŸºæ–¼é€™å€‹ SPEC é–‹ç™¼å‡ºä¾† libraries é‚„æœ‰ä¸€ç³»åˆ—çš„ CNI pluginsã€‚\nCNI å®šç¾©äº†ä¸€å¥— plugin-based çš„ç¶²è·¯è§£æ±ºæ–¹æ¡ˆï¼ŒåŒ…å«äº†è¨­å®šé‚„æœ‰å‘¼å«åŸ·è¡Œçš„æ¨™æº–ï¼Œä½¿ç”¨ CNI æœ€çŸ¥åçš„å°ˆæ¡ˆæ‡‰è©²å°±æ˜¯ kubernetes äº†ï¼Œåœ¨ k8s ç’°å¢ƒä¸­ï¼Œå®¹å™¨çš„ç¶²è·¯ä¸¦ä¸æ˜¯ç›´æ¥ç”± container runtime (ex. Docker) è™•ç†çš„ï¼Œcontainer runtime å»ºç«‹å¥½å®¹å™¨å¾Œï¼Œkubelet å°±æœƒä¾ç…§ CNI çš„è¨­å®šå’Œé€šè¨Šæ¨™æº–å»å‘¼å« CNI pluginï¼Œç”± CNI plugin ä¾†å®Œæˆå®¹å™¨çš„ç¶²è·¯è¨­ç½®ã€‚\nContainer runtime åœ¨åŸ·è¡Œå®¹å™¨å»ºç«‹æ™‚ï¼Œæœƒä¾æ“šè¨­å®šæª” (å¾ŒçºŒç¨±ç‚º network configuration) çš„æŒ‡ç¤ºï¼Œä¾åºå‘¼å«ä¸€å€‹æˆ–å¤šå€‹çš„ CNI plugin ä¾†å®Œæˆç¶²è·¯åŠŸèƒ½çš„è¨­ç½®ï¼Œä¸€å€‹ç¶²è·¯åŠŸèƒ½çš„è¨­ç½®å¯èƒ½æœƒéœ€è¦å¤šå€‹ CNI plugins ä¹‹é–“çš„ç›¸äº’åˆä½œï¼Œæˆ–è‘—ç”±å¤šå€‹ CNI plugin æä¾›å¤šå€‹ä¸åŒçš„ç¶²è·¯åŠŸèƒ½ã€‚\nOverview # ç›®å‰ CNI spec çš„ç‰ˆæœ¬æ˜¯ 1.0.0ï¼ŒCNI çš„ repository è£¡é¢é™¤äº† spec æ–‡ä»¶å¤–ä¹ŸåŒ…å«äº†åŸºæ–¼ CNI spec é–‹ç™¼çš„ go libraryï¼Œç”¨æ–¼ CNI plugin çš„é–‹ç™¼ã€‚ä¸é CNI spec å’Œ library çš„ç‰ˆæœ¬è™Ÿæ˜¯ç¨ç«‹çš„ï¼Œç•¶å‰çš„ library ç‰ˆæœ¬æ˜¯ 1.1.2ã€‚\né¦–å…ˆè¦å°å¹¾å€‹åŸºæœ¬åè©å®šç¾©\ncontainer æ˜¯ä¸€å€‹ç¶²è·¯ç¨ç«‹çš„ç’°å¢ƒï¼Œåœ¨ linux ä¸Šé€šå¸¸é€é network namespace çš„æ©Ÿåˆ¶ä¾†åˆ‡å‰²ï¼Œä¸éä¹Ÿå¯èƒ½æ˜¯ä¸€å€‹ç¨ç«‹çš„ VMã€‚ network æ˜¯ endpoints çš„é›†åˆï¼Œæ¯å€‹ endpoint éƒ½æœ‰è‘—ä¸€å€‹å”¯ä¸€æ˜¯åˆ¥çš„çš„åœ°å€ (é€šå¸¸æ˜¯ ip address) å¯ç”¨æ–¼äº’ç›¸é€šè¨Šã€‚ä¸€å€‹ç«¯é»å¯èƒ½æ˜¯ä¸€å€‹å®¹å™¨ã€VM æˆ–è‘—è·¯ç”±å™¨ä¹‹é¡çš„ç¶²è·¯è¨­å‚™ã€‚ runtime æŒ‡çš„æ˜¯å‘¼å«åŸ·è¡Œ CNI plugin çš„ç¨‹å¼ï¼Œä»¥ k8s ä¾†èªªï¼Œkubelet ä½œç‚ºé€™å€‹è§’è‰² plugin æŒ‡çš„æ˜¯ä¸€å€‹ç”¨ä¾†å®Œæˆå¥—ç”¨ç‰¹å®šç¶²è·¯è¨­å®šçš„ç¨‹å¼ã€‚ CNI Spec åŒ…å«äº”å€‹éƒ¨åˆ†\nNetwork configuration format: CNI ç¶²è·¯è¨­å®šçš„æ ¼å¼ Execution Protocol: runtime å’Œ CNI plugin ä¹‹é–“æºé€šçš„ protocol Execution of Network Configurations: æè¿° runtime å¦‚ä½•è§£æ network configuration å’Œæ“ä½œ CNI pluginã€‚ Plugin Delegation: æè¿° CNI plugin å¦‚ä½•å‘¼å« CNI pluginã€‚ Result Types: æè¿° CNI plugin å›å‚³çš„çµæœæ ¼å¼ã€‚ Section 1: Network configuration format # CNI å®šç¾©äº†ä¸€å€‹ç¶²è·¯è¨­å®šçš„æ ¼å¼ï¼Œé€™å€‹æ ¼å¼ç”¨æ–¼ runtime è®€å–çš„è¨­å®šæª”ï¼Œä¹Ÿç”¨æ–¼ runtime è§£æå¾Œï¼Œplugin æ¥æ”¶çš„æ ¼å¼ï¼Œé€šå¸¸ä¾†èªªè¨­å®šæª”æ˜¯ä»¥ ** éœæ…‹ ** æª”æ¡ˆçš„æ–¹å¼å­˜åœ¨ä¸»æ©Ÿä¸Šï¼Œä¸æœƒä»»æ„è®Šæ›´ã€‚\nCNI ä½¿ç”¨äº† JSON ä½œç‚ºè¨­å®šæª”çš„æ ¼å¼ï¼Œä¸¦åŒ…å«ä»¥ä¸‹å¹¾å€‹ä¸»è¦æ¬„ä½\ncniVersion (string): å°æ‡‰çš„ CNI spec ç‰ˆæœ¬ï¼Œç•¶å‰æ˜¯ 1.0.0 name (string): ä¸€å€‹åœ¨ä¸»æ©Ÿä¸Šä¸é‡è¤‡çš„ç¶²è·¯åç¨± disableCheck (boolean): å¦‚æœ disableCheck æ˜¯ true çš„è©±ï¼Œruntime å°±ä¸èƒ½å‘¼å« CHECKï¼ŒCHECK æ˜¯ spec å®šç¾©çš„ä¸€å€‹æŒ‡ä»¤ç”¨ä¾†æª¢æŸ¥ç¶²è·¯æ˜¯å¦ç¬¦åˆ plugin ä¾æ“šè¨­å®šçš„çµæœï¼Œç”±æ–¼ä¸€å€‹ç¶²è·¯è¨­å®šå¯èƒ½æœƒå‘¼å«å¤šå€‹ CNI pluginsï¼Œå› æ­¤å¯èƒ½æœƒå‡ºç¾ç¶²è·¯ç‹€æ…‹ç¬¦åˆç®¡ç†å“¡é æœŸï¼Œä½†æ˜¯ CNI plugin ä¹‹é–“è¡çªæª¢æŸ¥å¤±æ•—çš„æƒ…æ³ï¼Œé€™æ™‚å°±å¯ä»¥è¨­å®š disableCheck plugin (list): CNI plugin è¨­å®š (Plugin configuration object) çš„åˆ—è¡¨ã€‚ Plugin configuration object # plugin configuration object åŒ…å«äº†ä¸€äº›æ˜å®šçš„æ¬„ä½ï¼Œä½† CNI plugin å¯èƒ½æ ¹æ“šéœ€è¦å¢åŠ æ¬„ä½ï¼Œæœƒç”± runtime åœ¨ä¸ä¿®æ”¹çš„æƒ…æ³ä¸‹é€çµ¦ CNI pluginã€‚\nå¿…å¡«ï¼š type (string): CNI plugin çš„åŸ·è¡Œæª”åç¨± å¯é¸æ¬„ä½ (CNI protocol ä½¿ç”¨): capabilities (dictionary): å®šç¾© CNI plugin æ”¯æ´çš„ capabilitiesï¼Œå¾Œé¢åœ¨ section 3 æœƒä»‹ç´¹ã€‚ ä¿ç•™æ¬„ä½ï¼šé€™äº›æ¬„ä½æ˜¯åœ¨åŸ·è¡Œéç¨‹ä¸­ï¼Œç”± runtime ç”Ÿæˆå‡ºä¾†çš„ï¼Œå› æ­¤ä¸æ‡‰è©²åœ¨è¨­å®šæª”å…§è¢«å®šç¾©ã€‚ runtimeConfig args ä»»ä½• cni.dev/ é–‹é ­çš„ key å¯é¸æ¬„ä½ï¼šä¸æ˜¯ protocol å®šç¾©çš„æ¬„ä½ï¼Œä½†æ˜¯ç”±æ–¼å¾ˆå¤š CNI plugin éƒ½æœ‰ä½¿ç”¨ï¼Œå› æ­¤å…·æœ‰ç‰¹å®šçš„æ„ç¾©ã€‚ ipMasq (boolean): å¦‚æœ plugin æ”¯æ´çš„è©±ï¼Œæœƒåœ¨ host ä¸Šæ›¿è©²ç¶²è·¯è¨­ç½® IP masqueradeï¼Œå¦‚æœ host è¦åšç‚ºè©²ç¶²è·¯çš„ gateway çš„è©±ï¼Œå¯èƒ½éœ€è¦è©²åŠŸèƒ½ã€‚ ipam (dictionary): IPAM (IP Address Management) è¨­ç½®ï¼Œå¾Œé¢åœ¨ section 4 æœƒä»‹ç´¹ã€‚ dns (dictionary): DNS è¨­ç½®ç›¸é—œè¨­ç½® nameservers (list of strings): DNS server çš„ IP åˆ—è¡¨ domain (string): DNS search domain search (list of strings),: DNS search domain åˆ—è¡¨ options (list of strings): DNS options åˆ—è¡¨ å…¶ä»–æ¬„ä½ï¼šCNI plugin è‡ªå·±å®šç¾©çš„é¡å¤–æ¬„ä½ã€‚ è¨­å®šæª”ç¯„ä¾‹\n{ \u0026#34;cniVersion\u0026#34;: \u0026#34;1.0.0\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;dbnet\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;bridge\u0026#34;, //plugin specific parameters \u0026#34;bridge\u0026#34;: \u0026#34;cni0\u0026#34;, \u0026#34;keyA\u0026#34;: [\u0026#34;some more\u0026#34;, \u0026#34;plugin specific\u0026#34;, \u0026#34;configuration\u0026#34;], \u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;host-local\u0026#34;, //ipam specific \u0026#34;subnet\u0026#34;: \u0026#34;10.1.0.0/16\u0026#34;, \u0026#34;gateway\u0026#34;: \u0026#34;10.1.0.1\u0026#34;, \u0026#34;routes\u0026#34;: [ {\u0026#34;dst\u0026#34;: \u0026#34;0.0.0.0/0\u0026#34;} ] }, \u0026#34;dns\u0026#34;: { \u0026#34;nameservers\u0026#34;: [ \u0026#34;10.1.0.1\u0026#34; ] } }, { \u0026#34;type\u0026#34;: \u0026#34;tuning\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;mac\u0026#34;: true }, \u0026#34;sysctl\u0026#34;: { \u0026#34;net.core.somaxconn\u0026#34;: \u0026#34;500\u0026#34; } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: {\u0026#34;portMappings\u0026#34;: true} } ] } Section 2: Execution Protocol # CNI çš„å·¥ä½œæ¨¡å¼æ˜¯ç”± container runtime å»å‘¼å« CNI plugin çš„ binariesï¼ŒCNI Protocol å®šç¾©äº† runtime å’Œ plugin ä¹‹é–“çš„æºé€šæ¨™æº–ã€‚\nCNI plugin çš„å·¥ä½œæ˜¯å®Œæˆå®¹å™¨ç¶²è·¯ä»‹é¢çš„æŸç¨®è¨­ç½®ï¼Œå¤§è‡´ä¸Šå¯ä»¥åˆ†æˆå…©é¡\nInterface plugin: å»ºç«‹å®¹å™¨å…§çš„ç¶²è·¯ä»‹é¢ï¼Œä¸¦ç¢ºä¿å…¶é€£æ¥å¯ç”¨ Chained plugin: èª¿æ•´ä¿®æ”¹ä¸€å€‹å·²å»ºç«‹çš„ä»‹é¢ (å¯èƒ½åŒæ™‚æœƒéœ€è¦å»ºç«‹æ›´å¤šé¡å¤–çš„ä»‹é¢) Runtime é€éå…©ç¨®æ–¹å¼å‚³éåƒæ•¸ï¼Œä¸€æ˜¯é€éç’°å¢ƒè®Šæ•¸ï¼ŒäºŒæ˜¯é€é stdin å‚³é Section 1 å®šç¾©çš„ configurationã€‚å¦‚æœæˆåŠŸçš„è©±ï¼Œçµæœæœƒé€é stdout å‚³éï¼Œå¦‚æœå¤±æ•—çš„è©±å°±æœƒéŒ¯èª¤è³‡è¨Šæœƒé€é stderr å‚³éã€‚configuration å’Œçµæœã€éŒ¯èª¤éƒ½æ˜¯ä½¿ç”¨ JSON æ ¼å¼ã€‚\nRuntime å¿…é ˆåœ¨ Runtime çš„ç¶²è·¯åŸ·è¡Œï¼Œå¤§å¤šæ•¸æƒ…æ³ä¸‹å°±æ˜¯åœ¨ä¸»æ©Ÿçš„é è¨­ network namespace/dom0\nParameters # Protocol çš„åƒæ•¸éƒ½æ˜¯é€éç’°å¢ƒè®Šæ•¸ä¾†å‚³éçš„ï¼Œå¯èƒ½çš„åƒæ•¸å¦‚ä¸‹\nCNI_COMMAND: ç•¶å‰åŸ·è¡Œçš„ CNI æ“ä½œ (å¯èƒ½æ˜¯ ADD, DEL, CHECK. VERSION) CNI_CONTAINERID: å®¹å™¨çš„ ID CNI_NETNS: å®¹å™¨ç¶²è·¯ç©ºé–“çš„åƒè€ƒï¼Œå¦‚æœæ˜¯ä½¿ç”¨ namespaces çš„æ–¹å¼ä¾†åˆ‡å‰²çš„è©±ï¼Œå°±æ˜¯ namespce çš„è·¯å¾‘ï¼ˆe.g. /run/netns/[nsname] ) CNI_IFNAME: è¦å»ºç«‹åœ¨å®¹å™¨å…§çš„ä»‹é¢åç¨±ï¼Œå¦‚æœ plugin ç„¡æ³•å»ºç«‹è©²åç¨±å‰‡å›å‚³éŒ¯èª¤ CNI_ARGS: å…¶ä»–åƒæ•¸ï¼ŒAlphanumeric æ ¼å¼çš„ key-value pairsï¼Œä½¿ç”¨åˆ†è™Ÿéš”é–‹â€e.g. FOO=BAR;ABC=123 CNI_PATH: CNI plugin çš„æœå°‹è·¯å¾‘ï¼Œå› ç‚º CNI å­˜åœ¨ CNI plugin å‘¼å« CNI plugin çš„æƒ…æ³ï¼Œæ‰€ä»¥éœ€è¦é€™å€‹è·¯å¾‘ã€‚å¦‚æœåŒ…å«å¤šå€‹è·¯å¾‘ï¼Œä½¿ç”¨ OS å®šç¾©çš„åˆ†éš”ç¬¦è™Ÿåˆ†å‰²ã€‚Linux ä½¿ç”¨ : ï¼ŒWindows ä½¿ç”¨ ; Errors # å¦‚æœåŸ·è¡ŒæˆåŠŸï¼ŒCNI Plugin æ‡‰è©²å›å‚³ 0ã€‚å¦‚æœå¤±æ•—å‰‡å›å‚³é 0ï¼Œä¸¦å¾ stderr å›å‚³ error result type structureã€‚\nCNI operations # ADD # CNI plugin æœƒåœ¨ CNI_NETNS å…§å»ºç«‹ CNI_IFNAME ä»‹é¢æˆ–å°è©²ä»‹é¢å¥—ç”¨ç‰¹å®šçš„è¨­ç½®\nå¦‚æœ CNI plugin åŸ·è¡ŒæˆåŠŸï¼Œæ‡‰è©²å¾ stdout å›å‚³ä¸€å€‹ result structureã€‚å¦‚æœ plugin çš„ stdin è¼¸å…¥åŒ…å« prevResultï¼Œä»–å¿…äº›ç›´æ¥æŠŠ prevResult åŒ…åœ¨ result structure å…§æˆ–å°ä»–ä¿®æ”¹å¾Œåœ¨åŒ…åœ¨ result structure å…§ï¼Œruntime æœƒæŠŠå‰ä¸€å€‹ CNI è¼¸å‡ºçš„ prevResult åŒ…åœ¨ä¸‹ä¸€å€‹ CNI çš„ stdin è¼¸å…¥å…§ã€‚\nå¦‚æœ CNI plugin å˜—è©¦å»ºç«‹ä»‹é¢æ™‚ï¼Œè©²ä»‹é¢å·²ç¶“å­˜åœ¨ï¼Œæ‡‰è©²ç™¼å‡ºéŒ¯èª¤ã€‚\nRuntime ä¸æ‡‰è©²åœ¨æ²’æœ‰ DEL çš„æƒ…æ³ä¸‹å°ä¸€å€‹ CNI_CONTAINERID å®¹å™¨çš„ä¸€å€‹ CNI_IFNAME ä»‹é¢å¤šæ¬¡å‘¼å« ADDã€‚ä¸éå¯èƒ½å°åŒä¸€å€‹ container çš„ä¸åŒä»‹é¢å‘¼å« ADDã€‚\nå¿…æœ‰çš„è¼¸å…¥åŒ…å« STDIN JSON configuration objectã€ CNI_COMMANDã€CNI_CONTAINERID ã€ CNI_NETNS å’Œ CNI_IFNAME ã€‚ CNI_ARGS å’Œ CNI_PATH ç‚ºå¯é¸é …ã€‚\nDEL # ç§»é™¤ CNI_NETNS å…§çš„ CNI_IFNAME ä»‹é¢ï¼Œæˆ–é‚„åŸ ADD å¥—ç”¨çš„ç¶²è·¯è¨­å®š\né€šå¸¸ä¾†èªªï¼Œå¦‚æœè¦é‡‹æ”¾çš„è³‡æºå·²ç¶“ä¸å­˜åœ¨ï¼ŒDEL ä¹Ÿæ‡‰è©²è¦–ç‚ºæˆåŠŸã€‚ä¾‹å¦‚å®¹å™¨ç¶²è·¯å·²ç¶“ä¸å­˜åœ¨äº†ï¼Œä¸€å€‹ IPAM plugin æ‡‰è©²é‚„æ˜¯è¦æ­£å¸¸çš„é‡‹æ”¾ IP å’Œå›å‚³æˆåŠŸï¼Œé™¤é IPAM plugin å°å®¹å™¨ç¶²è·¯å­˜åœ¨èˆ‡å¦æœ‰åš´æ ¼çš„è¦æ±‚ã€‚å³ä¾¿æ˜¯ DHCP pluginï¼Œé›–ç„¶åŸ·è¡Œ DEL æ“ä½œçš„æ™‚ä¾¯ï¼Œéœ€è¦é€éå®¹å™¨ç¶²è·¯ç™¼é€ DHCP release è¨Šæ¯ï¼Œä½†æ˜¯ç”±æ–¼ DHCP leases æœ‰ lifetime çš„æ©Ÿåˆ¶ï¼Œè¶…æ™‚å¾Œæœƒè‡ªå‹•å›æ”¶ï¼Œå› æ­¤å³ä¾¿å®¹å™¨ç¶²è·¯ä¸å­˜åœ¨ï¼ŒDHCP plugin åœ¨åŸ·è¡Œ DEL æ“ä½œæ™‚ï¼Œä¹Ÿæ‡‰è©²è©²å›å‚³æˆåŠŸã€‚\nå¦‚æœé‡è¤‡å°ä¸€å€‹ CNI_CONTAINERID å®¹å™¨çš„ CNI_IFNAME ä»‹é¢åŸ·è¡Œå¤šæ¬¡ DEL æ“ä½œï¼Œplguin éƒ½æ‡‰è©²å›å‚³ï¼Œå³ä¾¿ä»‹é¢å·²ç¶“ä¸å­˜åœ¨æˆ– ADD å¥—ç”¨çš„ä¿®æ”¹å·²ç¶“é‚„åŸã€‚\nå¿…æœ‰çš„è¼¸å…¥åŒ…å« STDIN JSON configuration objectã€ CNI_COMMANDã€CNI_CONTAINERID å’Œ CNI_IFNAMEã€‚ CNI_NETNSã€CNI_ARGS å’Œ CNI_PATH ç‚ºå¯é¸é …ã€‚\nCHECK # Runtime é€é CHECK æª¢æŸ¥å®¹å™¨çš„ç‹€æ…‹ï¼Œä¸¦ç¢ºä¿å®¹å™¨ç¶²è·¯ç¬¦åˆé æœŸã€‚CNI spec å¯ä»¥åˆ†ç‚º plugin å’Œ runtime çš„å…©éƒ¨åˆ†\nPlugin:\nplugin å¿…é ˆæ ¹æ“š prevResult ä¾†åˆ¤æ–·ä»‹é¢å’Œåœ°å€æ˜¯å¦ç¬¦åˆé æœŸ plugin å¿…é ˆæ¥å—å…¶ä»– chained plugin å°ä»‹é¢ä¿®æ”¹çš„çµæœ å¦‚æœ plugin å»ºç«‹ä¸¦åˆ—èˆ‰åœ¨ prevResult çš„ CNI Result type è³‡æº (ä»‹é¢ã€åœ°å€ã€è·¯ç”±è¦å‰‡) ä¸å­˜åœ¨æˆ–ä¸ç¬¦åˆé æœŸç‹€æ…‹ï¼Œplugin æ‡‰è©²å›å‚³éŒ¯èª¤ å¦‚æœå…¶ä»–ä¸åœ¨ Result type å…§çš„è³‡æºä¸å­˜åœ¨æˆ–ä¸ç¬¦åˆé æœŸä¹Ÿæ‡‰è©²å›å‚éŒ¯èª¤ã€‚å¯èƒ½çš„è³‡æºå¦‚ä¸‹ é˜²ç«ç‰†è¦å‰‡ æµé‡æ§ç®¡ (Traffic shaping controls) IP ä¿ç•™ (Reservation) å¤–éƒ¨ä¾è³´ï¼Œå¦‚é€£æ¥æ‰€éœ€çš„ daemon å¦‚æœç™¼ç¾å®¹å™¨ç¶²è·¯æ˜¯ç„¡æ³•è¨ªå•çš„æ‡‰è©²å›å‚³éŒ¯èª¤ plugin å¿…é ˆåœ¨å®Œæˆ ADD å¾Œèƒ½å¤ ç«‹å³è™•ç† CHECK æŒ‡ä»¤ï¼Œæ‡‰æ­¤ plguin æ‡‰è©²è¦å®¹å¿éåŒæ­¥å®Œæˆçš„ç¶²è·¯è¨­ç½®åœ¨ä¸€å®šçš„æ™‚é–“å…§ä¸ç¬¦åˆé æœŸã€‚ plugin åŸ·è¡Œ CHECK æ™‚ï¼Œæ‡‰è©²å‘¼å«æ‰€æœ‰ delegated plugin çš„ CHECKï¼Œä¸¦æŠŠ delegated plugin çš„éŒ¯èª¤å‚³çµ¦ plugin çš„å‘¼å«è€… Runtime:\nRuntime ä¸æ‡‰è©²åœ¨æœªåŸ·è¡Œ ADD å‰æˆ–å·²ç¶“ DEL å¾Œæ²’åœ¨åŸ·è¡Œä¸€æ¬¡ ADD çš„å®¹å™¨åŸ·è¡Œ CHECK å¦‚æœ configuration çš„ disableCheck ç‚ºçœŸï¼Œruntime ä¸æ‡‰å‘¼å« disableCheck Runtime å‘¼å« CHECK æ™‚ï¼Œconfiguration å¿…é ˆåœ¨ prevResult åŒ…å«å‰ä¸€æ¬¡ ADD æ“ä½œæ™‚æœ€å¾Œä¸€å€‹ plugin çš„ Resultã€‚Runtime å¯èƒ½æœƒä½¿ç”¨ libcni æä¾›çš„ Result caching åŠŸèƒ½ã€‚ å¦‚æœå…¶ä¸­ä¸€å€‹ plugin å›å‚³éŒ¯èª¤ï¼Œruntime å¯èƒ½ä¸æœƒå‘¼å«å¾Œé¢ plugin çš„ CHECK Runtime å¯èƒ½æœƒåœ¨ ADD å®Œå¾Œçš„ä¸‹ä¸€åˆ»ä¸€ç›´åˆ° DEL åŸ·è¡Œå‰çš„ä»»ä½•æ™‚é–“åŸ·è¡Œ CHECK Runtime å¯èƒ½æœƒå‡è¨­ä¸€å€‹ CHECK å¤±æ•—çš„å®¹å™¨æœƒæ°¸ä¹…è™•æ–¼é…ç½®éŒ¯èª¤çš„ç‹€æ…‹ å¿…æœ‰çš„è¼¸å…¥åŒ…å« STDIN JSON configuration objectã€ CNI_COMMANDã€CNI_CONTAINERIDã€CNI_NETNS å’Œ CNI_IFNAMEã€‚ CNI_ARGS å’Œ CNI_PATH ç‚ºå¯é¸é …ã€‚\né™¤äº† CNI_PATH ä»¥å¤–çš„åƒæ•¸å¿…é ˆå’Œ ADD æ™‚ä¸€è‡´ã€‚\nVERSION # Plugin é€é stdout è¼¸å‡º JSON æ ¼å¼çš„ version result type objectï¼Œç”¨æ–¼æŸ¥çœ‹ CNI plugin çš„ç‰ˆæœ¬ã€‚\nStdin è¼¸å…¥çš„ JSON ç‰©ä»¶åªåŒ…å« cniVersionã€‚ ç’°å¢ƒè®Šæ•¸åƒæ•¸åªéœ€è¦ CNI_COMMANDã€‚\nSection 3: Execution of Network Configurations # é€™å€‹ç« ç¯€æè¿°äº† runtime å¦‚ä½•è§£æ network configurationï¼Œä¸¦åŸ·è¡Œ CNI pluginsã€‚Runtime å¯èƒ½æœƒæƒ³è¦æ–°å¢ã€åˆªé™¤ã€æª¢æŸ¥ configurationï¼Œä¸¦å°æ‡‰åˆ° CNI plugin çš„ ADD, DELETE, CHECK æ“ä½œã€‚é€™å€‹ç« ç¯€ä¹Ÿå®šç¾© configuration æ˜¯å¦‚ä½•æ”¹è®Šä¸¦æä¾›çµ¦ plugin çš„ã€‚\nå°å®¹å™¨çš„ network configuration æ“ä½œç¨±ä¹‹ç‚º attachmentï¼Œä¸€å€‹ attachment é€šå¸¸å°æ‡‰åˆ°ä¸€å€‹ç‰¹å®š CNI_CONTAINERID å®¹å™¨çš„ CNI_IFNAME ä»‹é¢ã€‚\nç”Ÿå‘½é€±æœŸ # Runtime å¿…é ˆåœ¨å‘¼å«ä»»ä½• CNI Plugin ä¹‹å‰ï¼Œç‚ºå®¹å™¨å»ºç«‹æ–°çš„ network namespace Runtime ä¸€å®šä¸èƒ½åŒæ™‚åœ¨ä¸€å€‹å®¹å™¨åŸ·è¡Œå¤šå€‹ plugin å‘½ä»¤ï¼Œä½†æ˜¯åŒæ™‚è™•ç†å¤šå€‹å®¹å™¨æ˜¯å¯ä»¥çš„ã€‚å› æ­¤ plugin å¿…é ˆèƒ½å¤ è™•ç†å¤šå®¹å™¨ concurrency çš„å•é¡Œï¼Œä¸¦åœ¨å…±äº«çš„è³‡æº (e.g. IPAM DB) å¯¦ä½œ lock æ©Ÿåˆ¶ Runtime å¿…é ˆç¢ºä¿ ADD æ“ä½œå¾Œå¿…å®šåŸ·è¡Œä¸€æ¬¡ DEL æ“ä½œï¼Œå³ä¾¿ ADD å¤±æ•—ã€‚å”¯ä¸€å¯èƒ½çš„ä¾‹å¤–æ˜¯å¦‚çµé»ç›´æ¥ä¸Ÿå¤±ä¹‹é¡çš„ç½é›£æ€§äº‹ä»¶ã€‚ DEL æ“ä½œå¯èƒ½é€£çºŒå¤šæ¬¡åŸ·è¡Œ network configuration åœ¨ ADD å’Œ DEL æ“ä½œä¹‹é–“ï¼Œä»¥åŠä¸åŒçš„ç‚º attachment ä¹‹é–“æ‡‰è©²ä¿æŒä¸€è‡´ä¸è®Š runtime å¿…é ˆè² è²¬æ¸…é™¤å®¹å™¨çš„ network namespace Attachment Parameters # Network configuration åœ¨ä¸åŒçš„ attachments é–“æ‡‰è©²ä¿æŒä¸€è‡´ã€‚ä¸é runtime æœƒå‚³éå…¶ä»–æ¯å€‹ attachment ç¨ç«‹çš„åƒæ•¸ã€‚\nContainer ID: å°æ‡‰åˆ° Section 2 CNI_CONTAINERID ç’°å¢ƒè®Šæ•¸ Namespace: å°æ‡‰åˆ° CNI_NETNS ç’°å¢ƒè®Šæ•¸ Container interface name: å°æ‡‰åˆ° CNI_IFNAME ç’°å¢ƒè®Šæ•¸ Generic Arguments: å°æ‡‰åˆ° CNI_ARGS ç’°å¢ƒè®Šæ•¸ Capability Arguments: CNI plugins search path: å°æ‡‰åˆ° CNI_PATH ç’°å¢ƒè®Šæ•¸ Adding an attachment # å° configuration çš„ plugins æ¬„ä½çš„æ¯å€‹ plugin configuration åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ\næ ¹æ“š type æ¬„ä½å°‹æ‰¾ CNI plugin çš„åŸ·è¡Œæª”ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡å›å‚³éŒ¯èª¤ æ ¹æ“š plugin configuration ç”Ÿæˆé€çµ¦ plugin sdtin çš„ configuration åªæœ‰ç¬¬ä¸€å€‹åŸ·è¡Œçš„ plugin ä¸æœƒå¸¶ prevResult æ¬„ä½ï¼Œå¾ŒçºŒåŸ·è¡Œçš„ plugin éƒ½æœƒæŠŠå‰ä¸€å€‹çš„ plugin çš„çµæœæ”¾åœ¨ prevResult åŸ·è¡Œ plugin çš„åŸ·è¡Œæª”ã€‚è¨­ç½® CNI_COMMAND=ADDï¼Œæä¾›å‰é¢å®šç¾©çš„ç’°å¢ƒè®Šæ•¸ï¼Œä»¥åŠé€é standard in å‚³è¼¸ç”Ÿæˆå‡ºä¾†çš„ configuration å¦‚æœ plugin å›å‚³éŒ¯èª¤ï¼Œä¸­æ–·åŸ·è¡Œä¸¦å›å‚³éŒ¯èª¤çµ¦ caller Runtime å¿…é ˆæŒä¹…ä¿å­˜æœ€å¾Œä¸€å€‹ plugin çš„çµæœï¼Œç”¨æ–¼ check å’Œ delete æ“ä½œã€‚\nDeleting an attachment # åˆªé™¤ attachment å’Œæ·»åŠ åŸºæœ¬ä¸Šå·®ä¸å¤šçš„ï¼Œå·®åˆ¥æ˜¯\nplugin çš„åŸ·è¡Œé †åºæ˜¯åéä¾†çš„ï¼Œå¾æœ€å¾Œä¸€å€‹é–‹å§‹ prevResult æ¬„æ°¸é æ˜¯ä¸Šä¸€æ¬¡ add æ“ä½œæ™‚ï¼Œæœ€å¾Œä¸€å€‹ plugin çš„çµæœ å° configuration çš„ plugins æ¬„ä½ååºçš„æ¯å€‹ plugin configuration åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ\næ ¹æ“š type æ¬„ä½å°‹æ‰¾ CNI plugin çš„åŸ·è¡Œæª”ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡å›å‚³éŒ¯èª¤ æ ¹æ“š plugin configuration å’Œä¸Šæ¬¡ ADD åŸ·è¡Œçš„ result ç”Ÿæˆé€çµ¦ plugin sdtin çš„ configuration åŸ·è¡Œ plugin çš„åŸ·è¡Œæª”ã€‚è¨­ç½® CNI_COMMAND=DELï¼Œæä¾›å‰é¢å®šç¾©çš„ç’°å¢ƒè®Šæ•¸ï¼Œä»¥åŠé€é standard in å‚³è¼¸ç”Ÿæˆå‡ºä¾†çš„ configuration å¦‚æœ plugin å›å‚³éŒ¯èª¤ï¼Œä¸­æ–·åŸ·è¡Œä¸¦å›å‚³éŒ¯èª¤çµ¦ caller Checking an attachment # å¦‚åŒ Section 2 æ‰€è¿°ï¼ŒRuntime æœƒé€é CNI plugin æª¢æŸ¥æ¯å€‹ attachment æ˜¯å¦æ­£å¸¸é‹ä½œä¸­ã€‚ éœ€æ³¨æ„çš„æ˜¯ Runtime å¿…é ˆä½¿ç”¨å’Œ add æ“ä½œæ™‚ä¸€è‡´çš„ attachment parameters\næª¢æŸ¥å’Œæ·»åŠ åªæœ‰å…©å€‹å·®åˆ¥\nprevResult æ¬„æ°¸é æ˜¯ä¸Šä¸€æ¬¡ add æ“ä½œæ™‚ï¼Œæœ€å¾Œä¸€å€‹ plugin çš„çµæœ å¦‚æœ network configuation ä¸­ disableCheck ç‚ºçœŸï¼Œå‰‡ç›´æ¥å›å‚³æˆåŠŸ å° configuration çš„ plugins æ¬„ä½çš„æ¯å€‹ plugin configuration åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿ\næ ¹æ“š type æ¬„ä½å°‹æ‰¾ CNI plugin çš„åŸ·è¡Œæª”ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡å›å‚³éŒ¯èª¤ æ ¹æ“š plugin configuration å’Œä¸Šæ¬¡ ADD åŸ·è¡Œçš„ result ç”Ÿæˆé€çµ¦ plugin sdtin çš„ configuration åŸ·è¡Œ plugin çš„åŸ·è¡Œæª”ã€‚è¨­ç½® CNI_COMMAND=CHECKï¼Œæä¾›å‰é¢å®šç¾©çš„ç’°å¢ƒè®Šæ•¸ï¼Œä»¥åŠé€é standard in å‚³è¼¸ç”Ÿæˆå‡ºä¾†çš„ configuration å¦‚æœ plugin å›å‚³éŒ¯èª¤ï¼Œä¸­æ–·åŸ·è¡Œä¸¦å›å‚³éŒ¯èª¤çµ¦ caller Deriving execution configuration from plugin configuration # åœ¨ add, delete, check æ“ä½œæ™‚ï¼Œruntime å¿…é ˆæ ¹æ“š network configuration ç”Ÿæˆå‡º plugin å¯ä»¥å­˜å–çš„ execution configuration (åŸºæœ¬å°æ‡‰åˆ° plugin configuration)ï¼Œä¸¦å¡«å…¥å…§å®¹ã€‚\nå¦‚åŒ section 2 æ‰€è¿°ï¼Œexecution configuration ä½¿ç”¨ JSON æ ¼å¼ä¸¦é€é stdin å‚³çµ¦ CNI pluginã€‚\nå¿…è¦çš„æ¬„ä½å¦‚ä¸‹ï¼š cniVersion: åŒ network configuraion ä¸­ cniVersion çš„å€¼ name: åŒ network configuraion ä¸­ name çš„å€¼ runtimeConfig: runtime éœ€è¦å’Œ plugin å¯æä¾›çš„ capabilities çš„è¯é›† (capability æœƒåœ¨å¾Œé¢è¨è«–) prevResult: CNI plugin å›å‚³çš„ Result type çµæœ capabilities æ¬„ä½å¿…é ˆè¢«ç§»é™¤ å…¶ä»– plugin configuration çš„æ¬„ä½æ‡‰è©²è¢«æ”¾å…¥ execution configuration Deriving runtimeConfig # ç›¸å°æ–¼éœæ…‹çš„ network configuration ä¾†èªªï¼Œruntime å¯èƒ½æœƒéœ€è¦æ ¹æ“šæ¯å€‹ä¸åŒçš„ attachment ç”¢ç”Ÿå‹•æ…‹åƒæ•¸ã€‚ é›–ç„¶ runtime å¯ä»¥é€é CNI_ARGS å‚³éå‹•æ…‹åƒæ•¸çµ¦ CNI pluginï¼Œä½†æ˜¯æˆ‘å€‘æ²’è¾¦æ³•é æœŸèªª CNI plugin æœƒä¸æœƒæ¥æ”¶é€™å€‹åƒæ•¸ã€‚é€é capabilities æ¬„ä½ï¼Œå¯ä»¥æ˜å®š plugin æ”¯æ´çš„åŠŸèƒ½ï¼Œruntime æ ¹æ“š capabilities åŠéœ€æ±‚ï¼Œå‹•æ…‹ç”Ÿæˆè¨­å®šä¸¦å¡«å…¥ runtimeConfigã€‚CNI spec æ²’æœ‰å®šç¾© capabilityï¼Œä½†æ˜¯æ¯”è¼ƒé€šç”¨çš„ capability æœ‰åˆ—èˆ‰åœ¨å¦å¤–ä¸€ä»½ æ–‡ä»¶ã€‚\nä»¥ kubernetes å¸¸ç”¨çš„ Node port åŠŸèƒ½ä¾†èªªï¼Œéœ€è¦ CNI plugin æ”¯æ´ portMappings é€™å€‹ capabilityã€‚ åœ¨ section 1 çš„å®šç¾©ä¸­ï¼Œplugin configuration åŒ…å«äº† capabilities æ¬„ä½ï¼Œåœ¨é€™å€‹æ¬„ä½å¡«å…¥ portMappingsï¼Œè®“ runtime çŸ¥é“å¯ä»¥é€éè©² plugin è™•ç† port mappingã€‚\n{ \u0026#34;type\u0026#34;: \u0026#34;myPlugin\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;portMappings\u0026#34;: true } } Runtime åŸ·è¡Œ CNI plugin æ™‚ï¼Œæœƒæ ¹æ“š capabilities ç”Ÿæˆ runtimeConfigï¼Œä¸¦å¡«å…¥å°æ‡‰çš„å‹•æ…‹åƒæ•¸ã€‚\n{ \u0026#34;type\u0026#34;: \u0026#34;myPlugin\u0026#34;, \u0026#34;runtimeConfig\u0026#34;: { \u0026#34;portMappings\u0026#34;: [ { \u0026#34;hostPort\u0026#34;: 8080, \u0026#34;containerPort\u0026#34;: 80, \u0026#34;protocol\u0026#34;: \u0026#34;tcp\u0026#34; } ] } ... } Section 4: Plugin Delegation # é›–ç„¶ CNI çš„ä¸»è¦çš„æ¶æ§‹æ˜¯ä¸€ç³»åˆ—çš„ CNI plkugin ä¾æ¬¡åŸ·è¡Œï¼Œä½†é€™æ¨£çš„æ–¹å¼æœ‰äº›æ™‚å€™æ²’è¾¦æ³•æ»¿è¶³ CNI çš„éœ€æ±‚ã€‚CNI plugin å¯èƒ½æœƒéœ€è¦å°‡æŸäº›åŠŸèƒ½å§”è¨—çµ¦å¦å¤–ä¸€å€‹ CNI pluginï¼Œä¸¦å­˜åœ¨ plugin å‘¼å« plugin çš„æƒ…æ³ï¼Œæœ€å¸¸è¦‹çš„æ¡ˆä¾‹å°±æ˜¯ IP åœ°å€çš„åˆ†é…ç®¡ç†ã€‚\né€šå¸¸ä¾†èªªï¼ŒCNI plugin æ‡‰è©²è¦æŒ‡å®šä¸¦ç¶­è­·å®¹å™¨çš„ IP åœ°å€ä»¥åŠä¸‹é”å¿…è¦çš„ routing rulesï¼Œé›–ç„¶ç”± CNI plugin è‡ªä¸»å®Œæˆå¯ä»¥è®“ CNI plugin æœ‰æ›´å¤§çš„å½ˆæ€§ä½†æ˜¯ä¹ŸåŠ é‡äº† CNI plugin çš„è·è²¬å’Œé–‹ç™¼é›£åº¦ï¼Œè®“ä¸åŒçš„ CNI plugin éœ€è¦é‡è¤‡é–‹ç™¼ç›¸åŒçš„ IP åœ°å€ç®¡ç†é‚è¼¯ï¼Œå› æ­¤è¨±å¤š CNI å°‡ IP ç®¡ç†çš„é‚è¼¯å§”è¨—çµ¦å¦ä¸€å€‹ç¨ç«‹çš„ pluginï¼Œè®“ç›¸é—œé‚è¼¯å¯ä»¥ç›´æ¥è¢«è¤‡ç”¨ã€‚å°æ­¤é™¤äº†å‰é¢æåˆ°çš„ interface plugin å’Œ chanined pluginï¼Œæˆ‘å€‘å®šç¾©äº†ç¬¬ä¸‰é¡çš„ plugin - IP Address Management Pligin (IPAM plugin)ã€‚\nç”±ä¸»è¦çš„ CNI plugin å»å‘¼å« IPAM pluginï¼ŒIPAM plugin åˆ¤æ–·ç¶²è·¯ä»‹é¢çš„ IP åœ°å€ã€gatewayã€routing rulesï¼Œä¸¦å›å‚³è³‡è¨Šçµ¦ä¸»è¦çš„ CNI plugin å»å®Œæˆç›¸å°æ‡‰è¨­ç½®ã€‚(IPAM plugin å¯èƒ½æœƒé€é dhcp ä¹‹é¡çš„ protocl, å„²å­˜åœ¨æœ¬åœ°çš„æª”æ¡ˆç³»çµ±è³‡è¨Šæˆ– network configuration çš„ ipam section å–å¾—è³‡è¨Š)\nDelegated Plugin protocol # å’Œ Runtime åŸ·è¡Œ CNI plugin çš„æ–¹å¼ä¸€æ¨£ï¼Œdelegated plugin ä¹Ÿæ˜¯é€éåŸ·è¡Œ CNI plugin å¯åŸ·è¡Œç¨‹å¼çš„æ–¹å¼ã€‚ä¸»è¦çš„ plugin åœ¨ CNI_PATH è·¯å¾‘ä¸‹æœå°‹ CNI pluginã€‚delegated plugin å¿…é ˆæ¥æ”¶å’Œä¸»è¦ plugin å®Œå…¨ä¸€è‡´çš„ç’°å¢ƒè®Šæ•¸åƒæ•¸ï¼Œä»¥åŠä¸»è¦ plugin é€é stdin æ¥æ”¶åˆ°çš„å®Œæ•´ execute configurationã€‚ å¦‚æœåŸ·è¡ŒæˆåŠŸå‰‡å›å‚³ 0ï¼Œä¸¦é€é stdout è¿”å› Success result type outputã€‚\nDelegated plugin execution procedure # ç•¶ CNI plugin åŸ·è¡Œ delegated plugin æ™‚ï¼š åœ¨ CNI_PATH è·¯å¾‘ä¸‹æœå°‹ plugin çš„å¯åŸ·è¡Œç¨‹å¼ ä½¿ç”¨ CNI plugin çš„ç’°å¢ƒè®Šæ•¸åƒæ•¸å’Œ execute configurationï¼Œä½œç‚º delegated plugin çš„è¼¸å…¥ ç¢ºä¿ delegated plugin çš„ stderr æœƒè¼¸å‡ºåˆ° CNI plugin çš„ stderr ç•¶ plugin åŸ·è¡Œ delete å’Œ check æ™‚ï¼Œå¿…é ˆåŸ·è¡Œæ‰€æœ‰çš„ delegated pluginï¼Œä¸¦å°‡ delegated plugin çš„éŒ¯èª¤å›å‚³çµ¦ runtime ç•¶ ADD å¤±æ•—æ™‚ï¼Œplugin æ‡‰è©²åœ¨å›å‚³éŒ¯èª¤å‰ï¼Œå…ˆåŸ·è¡Œ delegated plugin çš„ DEL Section 5: Result Types # Plugin çš„å›å‚³çµæœä½¿ç”¨ JSON æ ¼å¼ï¼Œä¸¦æœ‰ä¸‰ç¨® Success Error Version Success # å¦‚æœ plugin çš„è¼¸å…¥åŒ…å« prevResultï¼Œè¼¸å‡ºå¿…é ˆåŒ…å«è©²æ¬„ä½çš„å€¼ï¼Œä¸¦åŠ ä¸Šè©² plugin å°ç¶²è·¯ä¿®æ”¹çš„è³‡è¨Šï¼Œå¦‚æœè©² plugin æ²’æœ‰ä»»ä½•æ“ä½œï¼Œå‰‡è©²æ¬„ä½å¿…é ˆä¿æŒåŸè¼¸å…¥å…§å®¹ã€‚ Success Type Result çš„æ¬„ä½å¦‚ä¸‹\ncniVersion: åŒè¼¸å…¥çš„ cniVersion ç‰ˆæœ¬ interfaces: ä¸€å€‹è©² plugin å»ºç«‹çš„ interface è³‡è¨Šçš„é™£åˆ—ï¼ŒåŒ…å« host çš„ interfaceã€‚ name: interface çš„åå­ mac: interface çš„ mac address sandbox: è©²ä»‹é¢çš„ç¶²è·¯ç’°å¢ƒåƒè€ƒï¼Œä¾‹å¦‚ network namespace çš„è·¯å¾‘ï¼Œå¦‚æœæ˜¯ host ä»‹é¢å‰‡è©²æ¬„ä½ç‚ºç©ºï¼Œå®¹å™¨å…§çš„ä»‹é¢è©²å€¼æ‡‰ç‚º CNI_NETNS ips: è©² plugin æŒ‡å®šçš„ ip address: CIDR æ ¼å¼çš„ ip address (e.g. 192.168.1.1/24) gateway: default gateway (å¦‚æœå­˜åœ¨çš„è©±) interface: ä»‹é¢çš„ indexï¼Œå°æ‡‰åˆ°å‰è¿° interfaces é™£åˆ— routes: plugin å»ºç«‹çš„ routing rules dst: route çš„ç›®çš„ (CIDR) gw: nexthop åœ°å€ dns nameservers: DNS server ä½ç½®é™£åˆ— (ipv4 æˆ– ipv6 æ ¼å¼) domain: DNS æœå°‹çš„ local domain search (list of strings): æœ‰å„ªå…ˆåº¦çš„ search domain options (list of strings): å…¶ä»–çµ¦ dns resolver çš„åƒæ•¸ Delgated plugin å¯èƒ½æœƒå¿½ç•¥ä¸éœ€è¦çš„æ¬„ä½ IPAM å¿…é ˆå›å‚³ä¸€å€‹ abbreviated Success Type result (å¿½ç•¥ interfaces å’Œ ips è£¡é¢çš„ interface æ¬„ä½) Error # plugin å›å‚³çš„éŒ¯èª¤è³‡è¨Šï¼Œæ¬„ä½æœ‰ cniVersion, code, msg, detailsã€‚\n{ \u0026#34;cniVersion\u0026#34;: \u0026#34;1.0.0\u0026#34;, \u0026#34;code\u0026#34;: 7, \u0026#34;msg\u0026#34;: \u0026#34;Invalid Configuration\u0026#34;, \u0026#34;details\u0026#34;: \u0026#34;Network 192.168.0.0/31 too small to allocate from.\u0026#34; } Error code 0-99 è¢«ä¿ç•™çµ¦é€šç”¨çš„éŒ¯èª¤ï¼Œ100 ä»¥ä¸Šæ˜¯ plugin è‡ªå®šç¾©çš„éŒ¯èª¤ã€‚\nError code æè¿° 1 ä¸æ”¯æ´çš„ CNI ç‰ˆæœ¬ 2 ä¸æ”¯æ´çš„ network configuration æ¬„ä½ï¼Œerror message æœƒåŒ…å«ä¸æ”¯æ´çš„æ¬„ä½åç¨±å’Œæ•¸å€¼ 3 æœªçŸ¥æˆ–ä¸å­˜åœ¨çš„å®¹å™¨ï¼Œé€™å€‹éŒ¯èª¤åŒæ™‚ä»£è¡¨ runtime ä¸éœ€è¦åŸ·è¡Œ DEL ä¹‹é¡çš„æ¸…ç†æ“ä½œ 4 ç„¡æ•ˆçš„ç’°å¢ƒç’°å¢ƒè®Šæ•¸åƒæ•¸ï¼Œerror message æœƒåŒ…å«ç„¡æ•ˆçš„æ¬„ä½åç¨± 5 IO éŒ¯èª¤ï¼Œä¾‹å¦‚ç„¡æ³•è®€å– stdin çš„ execute configuration 6 è§£æéŒ¯èª¤ï¼Œä¾‹å¦‚ç„¡æ•ˆçš„ execute configuration JSON æ ¼å¼ 7 ç„¡æ•ˆçš„ network configuration 11 ç¨å¾Œåœ¨å˜—è©¦ï¼Œå­˜åœ¨æš«æ™‚ç„¡æ³•æ“ä½œçš„è³‡æºï¼Œruntime æ‡‰è©²ç¨å¾Œé‡è©¦ æ­¤å¤–ï¼Œstderr ä¹Ÿå¯è¢«ç”¨æ–¼é JSON çµæ§‹çš„éŒ¯èª¤è¨Šæ¯ï¼Œå¦‚ log Version # Version Type Result çš„æ¬„ä½å¦‚ä¸‹ cniVersion: åŒè¼¸å…¥çš„ cniVersion ç‰ˆæœ¬ supportedVersions: ä¸€å€‹æ”¯æ´çš„ CNI ç‰ˆæœ¬é™£åˆ— { \u0026#34;cniVersion\u0026#34;: \u0026#34;1.0.0\u0026#34;, \u0026#34;supportedVersions\u0026#34;: [\u0026#34;0.1.0\u0026#34;, \u0026#34;0.2.0\u0026#34;, \u0026#34;0.3.0\u0026#34;, \u0026#34;0.3.1\u0026#34;, \u0026#34;0.4.0\u0026#34;, \u0026#34;1.0.0\u0026#34;] } Appendix: # åœ¨ CNI SPEC è£é¢åŒ…å«äº†ä¸€äº› configuration å’ŒåŸ·è¡Œéç¨‹ä¸­ plugin è¼¸å…¥è¼¸å‡ºçš„ç¯„ä¾‹ï¼Œå¯ä»¥åƒè€ƒ åŸå§‹æ–‡ä»¶ å¦å¤–é‚„æœ‰ä¸€ä»½ CNI çš„æ–‡ä»¶ CONVENTIONSï¼Œæè¿°è¨±å¤š spec è£¡é¢æ²’æœ‰å®šç¾©ä½†æ˜¯è¨±å¤š plugin å¸¸ç”¨çš„æ¬„ä½ã€‚\nå°ç¯€ # ä»¥ä¸Šæ˜¯å° CNI spec 1.0.0 çš„å°è®€ï¼Œå¸Œæœ›å°å¤§å®¶æœ‰å¹«åŠ©ã€‚\n","date":"September 5 2022","externalUrl":null,"permalink":"/posts/cni-spec-guiding/","section":"æ–‡ç« ","summary":"","title":"CNI-Spec-Guiding","type":"posts"},{"content":"","date":"September 5 2022","externalUrl":null,"permalink":"/tags/%E6%96%87%E4%BB%B6%E7%BF%BB%E8%AD%AF/","section":"æ¨™ç±¤","summary":"","title":"æ–‡ä»¶ç¿»è­¯","type":"tags"},{"content":"","date":"August 28 2022","externalUrl":null,"permalink":"/categories/onos/","section":"åˆ†é¡","summary":"","title":"ONOS","type":"categories"},{"content":"é€™ç¯‡æ–‡ç« æœƒä»‹ç´¹ä¸€ä¸‹ï¼Œåœ¨ ONOS ä¸Š P4 ç›¸é—œçš„æ¨¡çµ„å’ŒåŠŸèƒ½ï¼Œä»¥åŠæ€éº¼é–‹ç™¼ ONOS APP èˆ‡è¨­ç½® ONOSï¼Œè®“ ONOS å¯ä»¥æ§åˆ¶ p4 switch çš„ pipelineã€‚\nèƒŒæ™¯ä»‹ç´¹ # P4Runtime # P4Runtime æ˜¯ P4 API Working Group åˆ¶å®šçš„ä¸€å¥—åŸºæ–¼ Protobuf ä»¥åŠ gRPC çš„å‚³è¼¸å”å®šï¼Œä»–å¯ä»¥æä¾›ä¸åŒçš„ P4 äº¤æ›æ©Ÿå’Œä¸åŒçš„ SDN æ§åˆ¶å™¨ä¸€å¥—çµ±ä¸€çš„ API æ¨™æº–ï¼Œæä¾›æ§åˆ¶å™¨ç›´æ¥é€é p4runtime å°‡ç·¨è­¯å‡ºä¾† p4 pipeline ç›´æ¥ä¸Šå‚³åˆ° p4 switch ä¸Šã€è¨­ç½® p4 pipeline çš„ table entry ä»¥åŠæ¥æ”¶ packet-in çš„å°åŒ…å’Œ counter çš„è³‡è¨Šç­‰åŠŸèƒ½ã€‚\nONOS æ¶æ§‹ # ONOS ä½¿ç”¨åˆ†å±¤æ¶æ§‹å’Œä»‹é¢æŠ½è±¡çš„æ–¹å¼éš±è—äº†åº•å±¤äº¤æ›æ©Ÿå’Œå’Œæ§åˆ¶å”å®šçš„å…·é«”å…§å®¹ï¼Œè®“ä¸Šå±¤çš„æ‡‰ç”¨å¯ä»¥ç”¨çµ±ä¸€çš„ API ä¾†ç®¡ç†ç¶²è·¯çš„è¡Œç‚ºï¼Œå› æ­¤ä¸Šå±¤ç¶²è·¯å¯ä»¥ç”¨å®Œå…¨ç›¸åŒçš„æ–¹å¼ä¾†æ§åˆ¶ Openflow switch åŠ P4 switchï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ç†æœƒå„å€‹ switch table é †åºå’Œå…·é«”è¦å‰‡çš„ä¸‹é”æ–¹å¼ã€‚\nONOS Flow programmable # å³ä¾¿æ˜¯åœ¨åŒ—å‘æä¾›çµ¦ä½¿ç”¨è€…çš„ APIï¼ŒONOS ä¹Ÿå°å…¶åšäº†å¾ˆå¤šå±¤ç´šçš„æŠ½è±¡ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥è‡ªç”±æ±ºå®šè¦ä½¿ç”¨å“ªä¸€å€‹å±¤ç´šçš„ APIã€‚\nåœ¨ flow rule çš„éƒ¨åˆ†ï¼ŒONOS å¤§è‡´ä¸Šæä¾›äº†ä¸‰å€‹å±¤ç´šçš„æŠ½è±¡ï¼Œåˆ†åˆ¥æ˜¯ Flow Rule, Flow Objective åŠ Intent ï¼Œä¸è«–åœ¨å“ªä¸€å€‹å±¤ç´šï¼Œæˆ‘å€‘ä¸»è¦éƒ½æ˜¯è¦æ“ä½œå…©å€‹é›†åˆ Selector å’Œ Treatment\nSelector æ±ºå®šäº†å“ªäº›å°åŒ…å—é€™æ¢ flow rule ç®¡ç†ã€‚ä¸€å€‹ Selector åŒ…å«äº†è‹¥å¹²å€‹ Criterion ï¼ŒONOS é€é Enum å®šç¾©äº†å¸¸ç”¨çš„ Criterion Typeï¼Œä¾†å°æ‡‰å°åŒ…çš„ä¸åŒæ¬„ä½ï¼Œä¾‹å¦‚ IPV4_SRC , ETH_SRC ç­‰ã€‚\nTreatment å‰‡æ˜¯ Instruction çš„é›†åˆï¼Œä¸€å€‹ instruction é€šå¸¸å°æ‡‰åˆ°å°å°åŒ…çš„æŸå€‹æ¬„ä½é€²è¡Œä¿®æ”¹ï¼Œæˆ–è‘—æŒ‡å®šå°åŒ…åœ¨äº¤æ›æ©Ÿçš„ output portã€‚\nä¸‰å€‹æŠ½è±¡å±¤ç©çš„å·®åˆ¥åœ¨æ–¼é€™å…©å€‹é›†åˆå¥—ç”¨åˆ°çš„å°è±¡ï¼Œåœ¨æœ€é«˜å±¤ç´šçš„ Intent ï¼Œæˆ‘å€‘æ“ä½œçš„å°è±¡æ˜¯æ•´å€‹ç¶²è·¯æµï¼Œé™¤äº† Selector å’Œ Treatmentï¼Œæˆ‘å€‘é‚„è¦å®šç¾©æ•´å€‹ç¶²è·¯æµåœ¨ SDN ç¶²è·¯çš„å…¥å£ (Ingress Point) å’Œå‡ºå£ (Egress Point)ï¼ŒONOS æ ¸å¿ƒçš„ Intent Service æœƒå¹«æˆ‘å€‘æŠŠä¸€å€‹ Intent ç·¨è­¯æˆå¤šå€‹ FlowObjectiveã€‚\nç”±æ–¼ Intent æ“ä½œçš„æ˜¯æ•´å€‹ç¶²è·¯æµï¼Œåœ¨é€™å€‹å±¤ç´šå®šç¾© Output port æ˜¯æ²’æœ‰æ„ç¾©çš„ï¼Œä½†æ˜¯ç”±æ–¼åœ¨ ONOS ä½¿ç”¨çš„ JAVA API æ˜¯å…±é€šçš„ï¼Œæ‰€ä»¥ intent service æœƒå¿½ç•¥æ‰é€™å€‹ instructionï¼Œé€™å€‹åœ¨ ONOS çš„å¯¦ä½œä¸Šæ˜¯å¾ˆé‡è¦çš„è§€å¿µï¼Œå° treatment è£¡çš„ instructionsï¼Œåº•å±¤çš„ç·¨è­¯å™¨åªæœƒå–ä»–å¯ä»¥è™•ç†çš„ instructions å¾€æ›´åº•å±¤é€ï¼Œå°æ–¼ä¸å¯ä»¥è™•ç†çš„ instructionsï¼Œæœ‰äº›æœƒæœ‰ warnning logï¼Œæœ‰äº›æœƒç›´æ¥è·³ exceptionï¼Œæ›´æœ‰çš„æœƒç›´æ¥å¿½ç•¥ï¼Œå› æ­¤å¦‚æœ selector å’Œ treatment çš„åŸ·è¡Œçµæœä¸ç¬¦åˆæˆ‘å€‘çš„é æœŸï¼Œæœ‰å¯èƒ½æ˜¯æœ‰äº›ä¸æ”¯æ´çš„ instruction åœ¨è½‰æ›æˆäº¤æ›æ©Ÿå¯ä»¥æ‡‚å¾—è¦å‰‡çš„éç¨‹ä¸­è¢«å¿½ç•¥çš„ã€‚\nFlowObjective æ“ä½œçš„å°è±¡æ˜¯ä¸€å°ç¶²è·¯è¨­å‚™ (é€šå¸¸æ˜¯ä¸€å°äº¤æ›æ©Ÿ)ï¼ŒåŒæ¨£æˆ‘å€‘å®šç¾©ä¸€å€‹ Selector å’Œ Treatment ï¼Œå‘Šè¨´é€™å°äº¤æ›æ©Ÿæˆ‘å€‘è¦è™•ç†å“ªäº›å°åŒ…å’Œæ€éº¼è™•ç†ã€‚\næœ€åº•ä¸‹åˆ°äº† Flow Rule é€™å€‹å±¤ç´šï¼ŒFlow rule é€™å€‹å±¤ç´šå°è±¡æ˜¯äº¤æ›æ©Ÿä¸Šçš„ä¸€å¼µ tableï¼Œå› æ­¤ä»–åŠ å…¥äº† table id é€™å€‹æ¬„ä½ã€‚ä¸€å€‹ FlowObjective å¯èƒ½æœƒåŒ…å«å¤šå€‹ä¸åŒçš„ instructionï¼Œä¾‹å¦‚æˆ‘å€‘è¦ä¿®æ”¹å°åŒ…çš„ mac addressï¼Œä¿®æ”¹ ip çš„ ttl æ¬„ä½ï¼ŒåŒæ™‚ä¹Ÿè¦æ±ºå®šé€™å€‹å°åŒ…çš„ output portï¼Œé€™äº› instruction åœ¨ flow objective å±¤ç´šå¯ä»¥åŒ…å«åœ¨ä¸€å€‹ treatment å…§ï¼Œä½†æ˜¯åœ¨å¯¦éš›çš„äº¤æ›æ©Ÿä¸Šé€™äº› instruction å¯èƒ½åˆ†åˆ¥å±¬æ–¼ä¸åŒçš„ tableï¼Œå› æ­¤ä¸€å€‹ flow objective æœƒéœ€è¦å°æ‡‰åˆ°ä¸€æ¢æˆ–å¤šæ¢å¾— flow ruleï¼Œé€™ä¾æ“šåº•ä¸‹äº¤æ›æ©Ÿçš„ä¸åŒã€å‚³è¼¸å”å®šçš„ä¸åŒè€Œä¸åŒï¼Œå› æ­¤ ONOS å¼•å…¥äº† Pipeliner ï¼ŒDriver å¯ä»¥å¯¦ä½œ Pipeliner çš„ä»‹é¢ï¼Œè®“ ONOS çŸ¥é“å¦‚ä½•æŠŠ flow objective è½‰æ›æˆ flow rulesã€‚\nP4 in ONOS # ä¸Šåœ–æ˜¯ p4 åœ¨ ONOS å—å‘æ¶æ§‹ä¸Šçš„çµ„ä»¶\nåœ¨ Protocol layer ç”± P4Runtime çµ„ä»¶å¯¦ä½œ p4runtime procotolï¼Œç¶­è­· switch çš„é€£ç·šå’Œå…·é«”çš„ gRPC/Protobuf å‚³è¼¸å…§å®¹\næ¥è‘—æ˜¯ Driver layerï¼Œä¸åŒçš„ p4 switch åœ¨ pipeline çš„çµæ§‹ç­‰æ–¹é¢å­˜åœ¨å·®ç•°ï¼Œå› æ­¤åœ¨ ONOS è¨­å®šäº¤æ›æ©Ÿè³‡è¨Šæ™‚è¦æ ¹æ“šä¸åŒçš„ Switch é¸æ“‡ driver\nå¦‚æœæ˜¯ bmv2 switch ä½¿ç”¨ org.onosproject.bmv2ï¼Œå¦‚æœæ˜¯ tofino äº¤æ›æ©Ÿä½¿ç”¨ org.onosproject.barefoot æœ€ä¸Šé¢æ˜¯ ONOS æ ¸å¿ƒï¼Œé€™é‚Šæœ‰ translation services å’Œ pipeconf æ¶æ§‹ã€‚p4 äº¤æ›æ©Ÿçš„ç‰¹è‰²æ˜¯èƒ½é€é p4lang å®šç¾©å‡ºå®Œå…¨ä¸åŒçš„ pipelineï¼Œåœ¨ä½¿ç”¨ ONOS æ§åˆ¶ p4 switch çš„æ™‚å€™ï¼Œæˆ‘å€‘å°±éœ€è¦é‡å° pipeline å®šç¾©è¨»å†Š pipeconfï¼ŒONOS æ ¸å¿ƒå¯ä»¥èª¿ç”¨ pipeconf å°‡ flow objective æˆ– flow rule çš„ flow rule è½‰æ›æˆçœŸæ­£å¯ä»¥ä¸‹é”åˆ° p4 pipeline table ä¸Šçš„ entryã€‚ åœ¨ ONOS æ ¸å¿ƒå®šç¾©çš„é€™å¥— pipeconf åŠè½‰æ›æ¶æ§‹è¢«ç¨±ä¹‹ç‚º Pipeline Independent (PI) frameworkï¼Œå› æ­¤ ONOS ç›¸é—œçš„ class å’Œ interface éƒ½æœƒæœ‰ä¸€å€‹ PI çš„å‰ç¶´ã€‚\nå¦å¤–å°±è¦æåˆ° Pipeline-agnostic APP å’Œ Pipeline-aware APP çš„å·®åˆ¥ï¼Œé€™é‚ŠæŒ‡çš„éƒ½æ˜¯åŒ—å‘ä»‹é¢ä¸Šé¢è™•ç†ç¶²è·¯é‚è¼¯çš„ APPï¼Œå·®åˆ¥åœ¨æ–¼ Pipeline-agnostic app å®Œå…¨ä¸è€ƒæ…®åº•ä¸‹çš„ pipelineï¼Œå› æ­¤é€šå¸¸æ“ä½œçš„æ˜¯ flow objectiveï¼Œè€Œ pipeline aware app å¿…é ˆçŸ¥é“åº•å±¤ pipeline çš„æ¶æ§‹ï¼Œç›´æ¥ç”¢å‡ºç‰¹å®šçš„ flow ruleã€‚\né–‹ç™¼ Pipeline-agnostic APP çš„å¥½è™•æ˜¯ä»–è¶³å¤ æŠ½è±¡å› æ­¤å¯ä»¥æ‡‰ç”¨åœ¨å„ç¨®ä¸åŒçš„äº¤æ›æ©Ÿå’Œç¶²è·¯ï¼Œä½†æ˜¯æˆ‘å€‘å°±éœ€è¦é¡å¤–å¯¦ä½œ pipeliner ç­‰ç·¨è­¯å™¨ä¾†åšè½‰æ›ï¼Œå› æ­¤ç›´æ¥å¦‚æœåªé‡å°å–®ä¸€ pipeline çš„æƒ…æ³ä¸‹ï¼Œç›´æ¥é–‹ç™¼ pipeline aware app æœƒæ¯”è¼ƒç°¡å–®ã€‚\nPipeconf é–‹ç™¼ # åœ¨ä½¿ç”¨ ONOS æ§åˆ¶ p4 switch æ™‚ï¼Œæœ€åŸºæœ¬è¦åšçš„å°±æ˜¯æ’°å¯« pipeline å°æ‡‰çš„ pipeconfã€‚ä¸€å€‹å®Œæ•´çš„ Pipeconf æœƒåŒ…å«\nå¾ p4 compiler æ‹¿åˆ° pipeline è³‡è¨Šæª”æ¡ˆï¼Œp4info, bmv2 json, Tofino binaryâ€¦. PipeconfLoader: ä¸€å€‹ pipeconf çš„é€²å…¥é»ï¼Œå‘ PiPipeconfService è¨»å†Šä¸€å€‹æˆ–å¤šå€‹ pipeconfï¼Œå®šç¾© pipeconf çš„ id, å°æ‡‰çš„ interpreter, pipeliner, p4info æª”æ¡ˆè·¯å¾‘ç­‰è³‡è¨Šã€‚ Interpreter: ä¸»è¦è² è²¬å…©ä»¶äº‹ æä¾› ONOS æ ¸å¿ƒè³‡è¨Šä¸¦å”åŠ©å°‡ common flow rule è½‰æ›æˆ protocol independent flow ruleï¼ŒåŒ…å«äº† table id çš„ mapping, æ¬„ä½åç¨±å’Œæ•¸å€¼çš„è½‰æ›ç­‰ è™•ç† packet-in/packet-out çš„å°åŒ…ï¼Œç•¶å°åŒ…å¾ p4 switch packet-in åˆ° controller æ™‚ï¼ŒæœƒæŠŠ metadata (input port ç­‰è³‡è¨Š) ç•¶ä½œ packet çš„ä¸€å€‹ header é™„åŠ åœ¨ packet ä¸­ï¼Œä¸€èµ·é€åˆ° controllerï¼Œpipeconf éœ€è¦è§£æå°åŒ…ï¼Œå°‡å°åŒ…è³‡è¨Šæå–å‡ºä¾†ã€‚ç•¶å°åŒ… packet-out æ™‚ï¼ŒåŒæ¨£éœ€è¦ metadata è½‰æ›æˆ pipeline å®šç¾©çš„ packet-out headerï¼Œé™„åŠ åœ¨å°åŒ…å…§é€è‡³äº¤æ›æ©Ÿï¼Œpipeline parser æ‰èƒ½é‡æ–°å°‡è³‡è¨Šè§£æå‡ºä¾†è™•ç†ã€‚ Pipeliner: è² è²¬å°‡ flow objective è½‰æ›æˆ flow rule ä½†æ˜¯ Interpreter å’Œ Pipeliner çš„åŠŸèƒ½æ˜¯ä¸ä¸€å®šè¦å¯¦ä½œçš„ï¼Œå¦‚æœå°æ‡‰çš„åŠŸèƒ½æ²’æœ‰è¢«å¯¦ä½œï¼Œé‚£åŒ—å‘çš„ APP å°±åªèƒ½å‘¼å«æ¯”è¼ƒåº•å±¤çš„ API è€Œç„¡æ³•èª¿å‹• flow objective ç­‰åŠŸèƒ½ã€‚\né–‹ç™¼ç›®æ¨™ # ä¸‹é¢æœƒç”¨ä¸€å€‹éå¸¸ç°¡å–®çš„ p4 pipeline ä½œç‚ºç¯„ä¾‹ï¼Œæˆ‘å€‘é æœŸè¦å¯¦ä½œä¸€å€‹åŸºæœ¬çš„ Layer 2 switch pipelineï¼Œä½¿ ProxyARP APP å’Œ Reactive Forwarding APP èƒ½å¤ æ­£å¸¸çš„é‹ä½œã€‚(ä½¿ç”¨ bmv2 å’Œ ONOS v2.7.0 é–‹ç™¼)\nå»ºç«‹ ONOS APP # è·Ÿä»»ä½•å…¶ä»– ONOS æ¨¡çµ„ä¸€æ¨£ï¼Œpipeconf å¯ä»¥ä½œç‚ºä¸€å€‹ç¨ç«‹çš„ ONOS APP é–‹ç™¼ï¼Œå†å®‰è£åˆ° ONOS ä¸Šï¼Œæ‰€ä»¥é¦–å…ˆå»ºç«‹æˆ‘å€‘çš„ simepleswitch APP\nonos-create-app Define value for property \u0026#39;groupId\u0026#39;: me.louisif.pipelines Define value for property \u0026#39;artifactId\u0026#39;: simpleswitch Define value for property \u0026#39;version\u0026#39; 1.0-SNAPSHOT: : Define value for property \u0026#39;package\u0026#39; me.louisif: : me.louisif.pipelines.simpleswitch pom.xml # åœ¨ pipeconf çš„é–‹ç™¼ä¸­ï¼Œä½¿ç”¨åˆ° p4 ç›¸é—œçš„ api ä¸¦æ²’æœ‰è¢«åŒ…å«åœ¨ onos æ¨™æº– api å…§ï¼Œéœ€è¦é¡å¤–åŠ å…¥ p4runtime-model é€™å€‹ dependencyã€‚\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.onosproject\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;onos-protocols-p4runtime-model\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${onos.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å¦å¤–å¯ä»¥åœ¨ onos çš„ dependency app åˆ—è¡¨å…§åŠ å…¥ pipeline å°æ‡‰çš„ driverï¼Œé€™æ¨£å•Ÿå‹• pipeconf æ™‚å°±æœƒè‡ªå‹•å•Ÿç”¨ç›¸é—œçš„ driver appï¼Œè€Œä¸ç”¨äº‹å‰æ‰‹å‹•å•Ÿå‹•ã€‚\n\u0026lt;properties\u0026gt; \u0026lt;onos.app.requires\u0026gt;org.onosproject.drivers.bmv2\u0026lt;/onos.app.requires\u0026gt; \u0026lt;/properties\u0026gt; P4 æ’°å¯« # æ¥è‘—æ’°å¯«æˆ‘å€‘çš„ p4 æª”æ¡ˆï¼Œè·¯å¾‘æ˜¯ src/main/resource/simpleswitch.p4ã€‚resource è³‡æ–™å¤¾åœ¨ç·¨è­¯çš„æ™‚å€™æœƒè¢«é™„åŠ åˆ°ç·¨è­¯å‡ºä¾†çš„ oar è£¡é¢ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨ ONOS åŸ·è¡Œçš„æ™‚å€™å­˜å–åˆ°ç·¨è­¯å‡ºä¾†çš„ p4info ç­‰æª”æ¡ˆã€‚å®Œæ•´çš„æª”æ¡ˆåœ¨ github ä¸Šã€‚\nåœ¨ simpleswitch çš„ ingress pipeline å…§åªåŒ…å«ä¸€å¼µ table0ï¼Œç”¨æ–¼ L2 çš„ packet forwardingï¼Œä½¿ç”¨ send é€™å€‹ action ä¾†å°‡å°åŒ…ä¸Ÿåˆ°æŒ‡å®šçš„ output portï¼Œåœ¨ bmv2 switch æœƒå®šç¾©ä¸€å€‹ cpu portï¼Œç•¶ egress_port ç‚ºè©² port number æ™‚ï¼Œå°åŒ…å°±æœƒè¢«é€è‡³ ONOSï¼Œå› æ­¤ send_to_cpu é€™å€‹ action åªå–®ç´”åš set egress port é€™å€‹å‹•ä½œã€‚\ncontrol table0_control(inout headers_t hdr, inout local_metadata_t local_metadata, inout standard_metadata_t standard_metadata) { action send(port_t port) { standard_metadata.egress_spec = port; } action send_to_cpu() { standard_metadata.egress_spec = CPU_PORT; } action drop() { mark_to_drop (standard_metadata); } table table0 { key = { standard_metadata.ingress_port : ternary; hdr.ethernet.src_addr : ternary; hdr.ethernet.dst_addr : ternary; hdr.ethernet.ether_type : ternary; } actions = { send; send_to_cpu; drop; } default_action = drop; size = 512; } apply { table0.apply (); } } control MyIngress(inout headers_t hdr, inout local_metadata_t meta, inout standard_metadata_t standard_metadata) { apply { // é€™å€‹å¾Œé¢åœ¨ä»‹ç´¹ //if (standard_metadata.ingress_port == CPU_PORT) { // standard_metadata.egress_spec = hdr.packet_out.egress_port; // hdr.packet_out.setInvalid (); // exit; // } else { table0_control.apply (hdr, meta, standard_metadata); // } } } P4 ç·¨è­¯ # ç·¨è­¯ bmv2 pipeline å¯ä»¥ç›´æ¥è¤‡è£½ ONOS å…§å»ºçš„ basic pipeline ä½¿ç”¨çš„ ç·¨è­¯è…³æœ¬ï¼Œå°‡ Makefile å’Œ bmv2-compile.sh é€™å…©å€‹æª”æ¡ˆè¤‡è£½åˆ° resources è³‡æ–™å¤¾ä¸‹ï¼Œç„¶å¾Œä¿®æ”¹ Makefile æŠŠ basic æ”¹æˆ simpleswitchï¼Œä¸¦åˆªé™¤ int pipelineã€‚å¯ä»¥ç°¡å–®ä¸‹ make ä¾†å®Œæˆ pipeline çš„ç·¨è­¯ã€‚\nROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))/.. all: p4 constants p4: simpleswitch.p4 @./bmv2-compile.sh \u0026#34;simpleswitch\u0026#34; \u0026#34;\u0026#34; constants: docker run -v $(ONOS_ROOT):/onos -w /onos/tools/dev/bin \\ -v $(ROOT_DIR):/source \\ --entrypoint ./onos-gen-p4-constants opennetworking/p4mn:stable \\ -o /source/java/me/louisif/pipelines/simpleswitch/SimpleswitchConstants.java \\ simpleswitch /source/resources/p4c-out/bmv2/simpleswitch_p4info.txt clean: rm -rf p4c-out/bmv2/* é€™å€‹ makefile ä¸»è¦åˆ†ç‚ºå…©å€‹éƒ¨åˆ†ã€‚p4 æœƒå‘¼å« bmv2-compileï¼Œç·¨è­¯å‡º bmv2 çš„ p4info å’Œæè¿° pipeline çš„ json æª”æ¡ˆã€‚constants å‰‡æœƒä½¿ç”¨ p4mn é€™å€‹ container ç”Ÿæˆå‡ºä¸€å€‹ SimpleswitchConstants.java çš„æª”æ¡ˆï¼Œé€™å€‹æª”æ¡ˆæœƒæŠŠ pipeline æ‰€æœ‰ table åç¨±ã€æ¬„ä½ã€action åç¨±åˆ—èˆ‰å‡ºä¾†ï¼Œæ–¹ä¾¿ pipeconf çš„ç¨‹å¼ç¢¼ç›´æ¥èª¿ç”¨ï¼Œä»¥ table0 ä¾†èªªï¼Œå®ƒçš„å®Œæ•´åç¨±ç‚º MyIngress.table0_control.table0 ï¼Œå¯ä»¥ä½¿ç”¨ MY_INGRESS_TABLE0_CONTROL_TABLE0 è®Šæ•¸ä¾†ä»£è¡¨ã€‚\npublic static final PiTableId MY_INGRESS_TABLE0_CONTROL_TABLE0 = PiTableId.of (\u0026#34;MyIngress.table0_control.table0\u0026#34;); æœ€å°å¯åŸ·è¡Œ Pipeconf # æ’°å¯« PipeconfLoader # æ¥è‘—æˆ‘å€‘è¦å…ˆå¯«ä¸€å€‹æœ€å°å¯ä»¥å‹•çš„ pipeconfï¼ŒåªåŒ…å« PipeconfLoader.java é€™å€‹æª”æ¡ˆï¼Œè·¯å¾‘æ˜¯ src/main/java/me/louisif/simpleswitch/PipeconfLoader.javaï¼Œå‰æ–‡æåˆ° PipeconfLoader çš„å·¥ä½œæ˜¯å‘ PipeconfService è¨»å†Š pipeconf çš„è³‡è¨Šï¼Œå› æ­¤æˆ‘å€‘å¹« PipeconfLoader åŠ ä¸Š Component çš„ Annotationï¼Œè®“ activate function åœ¨ APP å•Ÿå‹•æ™‚è¢«å‘¼å«ï¼Œæ¥è‘—åœ¨ activate function è£¡é¢å»è¨»å†Š pipeconfã€‚\nä»¥æˆ‘å€‘çš„ä¾‹å­è€Œè¨€ï¼Œæˆ‘å€‘ä½¿ç”¨çš„æ˜¯ bmv2 çš„ pipelineï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥é€™æ¨£å¯«\nfinal URL jsonUrl = PipeconfLoader.class.getResource (\u0026#34;/p4c-out/bmv2/simpleswitch.json\u0026#34;); final URL p4InfoUrl = PipeconfLoader.class.getResource (\u0026#34;/p4c-out/bmv2/simpleswitch_p4info.txt\u0026#34;); PiPipeconf pipeconf = DefaultPiPipeconf.builder () .withId (PIPECONF_ID) .withPipelineModel (P4InfoParser.parse (p4InfoUrl)) .addExtension (P4_INFO_TEXT, p4InfoUrl) .addExtension (BMV2_JSON, jsonUrl) .build (); piPipeconfService.register (pipeconf); æª”æ¡ˆè·¯å¾‘è¦å¡«å¯«ç›¸å°æ–¼ resource é€™å€‹è³‡æ–™å¤¾çš„è·¯å¾‘ï¼Œå¦å¤– addExtension çš„å…§å®¹æœƒæ ¹æ“š switch çš„ä¸åŒè€Œä¸åŒï¼Œå¦‚æœæˆ‘å€‘ä»Šå¤©ä½¿ç”¨çš„æ˜¯ tonifo çš„ pipeline é‚£å°±è¦æ”¹æˆ\nfinal URL binUrl = PipeconfLoader.class.getResource (\u0026#34;/p4c-out/tofino.bin\u0026#34;); final URL p4InfoUrl = PipeconfLoader.class.getResource (\u0026#34;/p4c-out/p4info.txt\u0026#34;); final URL contextJsonUrl = PipeconfLoader.class.getResource (\u0026#34;/p4c-out/context.json\u0026#34;); DefaultPiPipeconf.builder () .withId (PIPECONF_ID) .withPipelineModel (parseP4Info (p4InfoUrl)) .addExtension (P4_INFO_TEXT, p4InfoUrl) .addExtension (TOFINO_BIN, binUrl) .addExtension (TOFINO_CONTEXT_JSON, contextJsonUrl) .build (); piPipeconfService.register (pipeconf); æ¸¬è©¦ # å®Œæˆ PipeconfLoader.java å°±æ§‹æˆäº†ä¸€å€‹å¯ä»¥é‹ä½œçš„ pipeconfï¼Œç‚ºäº†æ¸¬è©¦æˆ‘å€‘ä½¿ç”¨ opennetworking/p4mn é€™å€‹ container ä¾†å¯¦é©—ï¼Œp4mn æ˜¯ä¸€å€‹ mininet çš„ docker imageï¼Œå¯ä»¥å¾ˆç°¡å–®çš„å•Ÿå‹•ä¸€å€‹ mininet çš„æ¸¬è©¦æ‹“è­œï¼Œä¸¦ä½¿ç”¨ bmv2 switch å–ä»£ mininet åŸæœ¬ä½¿ç”¨çš„ openflow switchã€‚\ndocker run -v /tmp/p4mn:/tmp --privileged --rm -it -p 50001:50001 opennetworking/p4mn:stable ä½¿ç”¨é€™å€‹æŒ‡ä»¤å¯ä»¥å•Ÿå‹•ä¸€å€‹åŒ…å«ä¸€å€‹å«åš bmv2-s1 çš„ bmv2 switch å’Œå…©å€‹ host\nåŒæ™‚æœƒç”Ÿæˆä¸€å€‹ onos çš„ netcfg æª”æ¡ˆï¼Œè·¯å¾‘ /tmp/p4mn/bmv2-s1-netcfg.json\n{ \u0026#34;devices\u0026#34;: { \u0026#34;device:bmv2:s1\u0026#34;: { \u0026#34;ports\u0026#34;: { \u0026#34;1\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;s1-eth1\u0026#34;, \u0026#34;speed\u0026#34;: 10000, \u0026#34;enabled\u0026#34;: true, \u0026#34;number\u0026#34;: 1, \u0026#34;removed\u0026#34;: false, \u0026#34;type\u0026#34;: \u0026#34;copper\u0026#34; }, \u0026#34;2\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;s1-eth2\u0026#34;, \u0026#34;speed\u0026#34;: 10000, \u0026#34;enabled\u0026#34;: true, \u0026#34;number\u0026#34;: 2, \u0026#34;removed\u0026#34;: false, \u0026#34;type\u0026#34;: \u0026#34;copper\u0026#34; } }, \u0026#34;basic\u0026#34;: { \u0026#34;managementAddress\u0026#34;: \u0026#34;grpc://localhost:50001?device_id=1\u0026#34;, \u0026#34;driver\u0026#34;: \u0026#34;bmv2\u0026#34;, \u0026#34;pipeconf\u0026#34;: \u0026#34;me.louisif.pipelines.simpleswitch\u0026#34; } } } } é€™å€‹æª”æ¡ˆåŒ…å«äº† ONOS P4 éœ€è¦çš„æ‰€æœ‰è³‡è¨Šï¼Œä¸»è¦åˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼Œports å®šç¾©äº†é€™å€‹äº¤æ›æ©Ÿæ‰€æœ‰çš„ port è³‡è¨Šã€‚basic éƒ¨åˆ†ï¼ŒmanagementAddress æ˜¯ ONOS ç”¨ä¾†ä½¿ç”¨ p4runtime é€£ç·šåˆ° switch çš„è·¯å¾‘ï¼Œpipeconf æŒ‡å®šäº†é€™å€‹ switch ä½¿ç”¨çš„ pipeconfï¼Œé è¨­æœƒæ˜¯ org.onosproject.pipelines.basicï¼Œåœ¨æˆ‘å€‘çš„ç¯„ä¾‹ä¸­éœ€è¦æ”¹ç‚º me.louisif.pipelines.simpleswitchã€‚\nåªè¦å°‡ me.louisif.pipelines.simpleswitch çš„ app å•Ÿç”¨ï¼Œä¸¦ä¸Šå‚³ bmv2-s1-netcfg.jsonï¼ŒONOS å°±å¯ä»¥æˆåŠŸé€£ç·šåˆ°é€™å€‹ bmv2 switchï¼Œä¸¦æ­£å¸¸æä¾›åŒ—å‘çš„ APP æœå‹™äº†ã€‚\nå¦‚ä½•ä¸‹ flow rule # å®Œæˆ pipeconf å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥é€éä¸‹ flow rule çš„æ–¹å¼ä¾†è®“ switch å·¥ä½œäº†ï¼Œç‚ºäº†è¦è®“ h1 å’Œ h2 èƒ½å¤ äº’ç›¸æºé€šï¼Œæœ€ç°¡å–®çš„æ–¹æ³•å°±æ˜¯å°‡æ‰€æœ‰ port 1 é€²ä¾†çš„å°åŒ…é€åˆ° port 2ã€æ‰€æœ‰å¾ port 2 é€²ä¾†çš„å°åŒ…é€åˆ° port 1ã€‚\nç‚ºæ­¤æˆ‘å€‘éœ€è¦å…©æ¢ table0 çš„ entryï¼Œåˆ†åˆ¥æ˜¯\nstandard_metadata.ingress_port == 1 (mask 0x1ff) â†’ send port=2 standard_metadata.ingress_port == 2 (mask 0x1ff) â†’ send port=1 ç”±æ–¼ standard_metadata.ingress_port é€™å€‹ key æ˜¯ ternaryï¼Œå› æ­¤æˆ‘å€‘éœ€è¦åŒ…å« mask, port é€™å€‹ type çš„é•·åº¦æ˜¯ 9 bitsï¼Œå› ç‚ºè¦å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥ mask æ˜¯ 0x1ffã€‚\nfinal PiCriterion.Builder criterionBuilder = PiCriterion.builder () .matchTernary (PiMatchFieldId.of (\u0026#34;standard_metadata.ingress_port\u0026#34;), inPortNumber.toLong (), 0x1ff); final PiAction piAction = PiAction.builder ().withId (PiActionId.of (\u0026#34;MyIngress.table0_control.send\u0026#34;)) .withParameter (new PiActionParam(PiActionParamId.of (\u0026#34;port\u0026#34;), outPortNumber.toLong ())) .build (); final FlowRule flowRule = DefaultFlowRule.builder () .fromApp (coreService.getAppId (APP_NAME)) .forDevice (deviceId) .forTable (PiTableId.of (\u0026#34;MyIngress.table0_control.table0\u0026#34;)).makePermanent ().withPriority (65535) .withSelector (DefaultTrafficSelector.builder ().matchPi (criterionBuilder.build ()).build ()) .withTreatment (DefaultTrafficTreatment.builder ().piTableAction (piAction).build ()).build (); flowRuleService.applyFlowRules (flowRule); æˆ‘å€‘å¯ä»¥é€éé€™æ¨£çš„æ–¹å¼ä¾†ä¸‹é”ç¬¬ä¸€æ¢ table entryï¼Œå¯ä»¥ç™¼ç¾å’Œå¹³å¸¸çš„ flow entry ä¸ä¸€æ¨£çš„åœ°æ–¹æ˜¯ table id ä½¿ç”¨çš„æ˜¯ PiTableId é€™å€‹ typeï¼Œä¸¦æŒ‡å®šäº† table0 çš„å®Œæ•´ id MyIngress.table0_control.table0ï¼Œå¦å¤– Selector å’Œ Treatment åˆ†åˆ¥ä½¿ç”¨äº† matchPi å’Œ piTableAction é€™å…©å€‹ç‰¹åˆ¥çš„å‡½æ•¸ã€‚\næˆ‘å€‘é€™é‚Šå°‡åªä½¿ç”¨ PiTableId, PiCriterion å’Œ PiAction å®šç¾©çš„ flow rule ç¨±ä¹‹ç‚º PI flow ruleï¼ŒPI flow rule æ˜¯ onos çš„ p4runtime å¯ä»¥ç›´æ¥è™•ç†çš„ flow ruleï¼Œæ‰€æœ‰çš„æ¬„ä½åç¨±éƒ½å”¯ä¸€å°æ‡‰åˆ° p4 pipeline çš„æŸå€‹æ¬„ä½ï¼Œå‰é¢æåˆ°é€™äº› PiTableId, PiMatchFieldId ç­‰éƒ½æœƒåœ¨ SimpleswitchConstants.java å…§è¢«å®šç¾©ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä½¿ç”¨ä¾†ç¸®çŸ­ç¨‹å¼ç¢¼é•·åº¦ã€‚\nimport static me.louisif.pipelines.simpleswitch.SimpleswitchConstants.*; final PiCriterion.Builder criterionBuilder = PiCriterion.builder () .matchTernary (INGRESS_PORT, inPortNumber.toLong (), 0x1ff); final PiAction piAction = PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND) .withParameter (PORT, outPortNumber.toLong ())) .build (); final FlowRule flowRule = DefaultFlowRule.builder () .fromApp (coreService.getAppId (APP_NAME)) .forDevice (deviceId) .forTable (MY_INGRESS_TABLE0_CONTROL_TABLE0).makePermanent ().withPriority (65535) .withSelector (DefaultTrafficSelector.builder ().matchPi (criterionBuilder.build ()).build ()) .withTreatment (DefaultTrafficTreatment.builder ().piTableAction (piAction).build ()).build (); flowRuleService.applyFlowRules (flowRule); åœ¨ç¯„ä¾‹ç¨‹å¼ç¢¼è£¡é¢åŒ…å«äº†ç°¡å–®çš„ cli æŒ‡ä»¤å¯¦ä½œï¼Œå› æ­¤å¯ä»¥åœ¨ ONOS CLI ä½¿ç”¨ add-pi-flow-rule \u0026lt;device id\u0026gt; \u0026lt;input port\u0026gt; \u0026lt;output port\u0026gt; çš„æ–¹å¼ä¾†ä¸‹é”ä¸Šé¢çš„ flow ruleã€‚è©³æƒ…å¯ä»¥ åƒè€ƒæª”æ¡ˆã€‚\nç•¶ç„¶é€™æ¨£ç·¨å¯«å‡ºä¾†çš„ flow rule æœƒç”¢ç”Ÿä¸€å€‹å•é¡Œï¼Œå¦‚æœç›¸åŒçš„ pipelineï¼Œæˆ‘å€‘å¸Œæœ›èƒ½å¾ bmv2 ç§»æ¤åˆ° tonifo ä¸Šé¢å»ä½¿ç”¨ï¼Œç”±æ–¼æ¬„ä½çš„åç¨±æœƒå­˜åœ¨å·®ç•°ï¼Œå› æ­¤æ‰€æœ‰ä¸‹é” flow rule çš„ APP éƒ½éœ€è¦é‡æ–°å¯«ï¼Œé¡¯ç„¶é€™æ¨£ä¸æ˜¯ä¸€å€‹å¾ˆå¥½çš„åšæ³•ï¼Œå¢åŠ äº†ç¨‹å¼ç¢¼ç¶­è­·ä¸Šçš„å›°é›£ï¼Œå› æ­¤ ONOS åŠ å…¥å‰é¢æåˆ°çš„ Interpreter é‚„æœ‰ translator æ©Ÿåˆ¶ï¼Œä¸‹ä¸€ç¯€æœƒä»‹ç´¹å¦‚ä½•ç‚º pipeline ç·¨å¯« Interpreter é‚„æœ‰ç”¨æ¯”è¼ƒé€šç”¨çš„æ–¹æ³•ä¾†ä¸‹ flow ruleï¼Œåœ¨å®Œæˆ interpreter å¾Œä¸Šè¿°çš„ flow ruleï¼Œå¯ä»¥ç”¨ä¸‹é¢é€™å€‹æˆ‘å€‘æ¯”è¼ƒç†Ÿæ‚‰çš„æ–¹æ³•ä¾†ä¸‹é”ã€‚\nprivate static final int TABLE0_TABLE_ID = 0; final FlowRule flowRule = DefaultFlowRule.builder () .fromApp (coreService.getAppId (APP_NAME)) .forDevice (deviceId) .forTable (TABLE0_TABLE_ID).makePermanent ().withPriority (65535) .withSelector (DefaultTrafficSelector.builder ().matchInPort (inPortNumber).build ()) .withTreatment (DefaultTrafficTreatment.builder ().setOutput (outPortNumber).build ()) .build (); flowRuleService.applyFlowRules (flowRule); æ’°å¯« Interpreter # åœ¨å‰ä¸€ç¯€æˆ‘å€‘å®Œæˆäº†åŸºæœ¬çš„ pipeconf è¨»å†Šï¼Œä¸¦ä½¿ç”¨ PI flow rule çš„æ–¹å¼ä¾†æ§åˆ¶äº¤æ›æ©Ÿï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨ PI flow rule æœƒé™ä½ APP çš„å½ˆæ€§ï¼Œä½¿ç§»æ¤åˆ°ä¸åŒ pipeline çš„å›°é›£åº¦æé«˜ã€‚å¦å¤– SDN çš„ä¸€å€‹ç‰¹è‰²æ˜¯å¯ä»¥ä½¿ç”¨ packet-in/packet-out çš„æ–¹å¼ä¾†è®“ controller å³æ™‚æ€§çš„è™•ç†å°åŒ…ï¼Œå› æ­¤æœ¬çµæœƒä»‹ç´¹å¦‚ä½•å¯¦ä½œ Interpreter ä¾†æä¾› packet-in/packet-outï¼Œä»¥åŠ flow rule translation çš„åŠŸèƒ½ã€‚\nè¦æä¾›ä¸€å€‹ pipeline interpreterï¼Œæˆ‘å€‘éœ€è¦å¯¦ä½œ PiPipelineInterpreter é€™å€‹ä»‹é¢ï¼Œè¦æ³¨æ„çš„æ˜¯ Interpreter class éœ€è¦ç¹¼æ‰¿ AbstractHandlerBehaviourï¼Œç„¶å¾Œå† PipeconfLoader å»æŒ‡å®šé€™å€‹å¯¦ä½œ\npublic class SimpleSwitchInterpreterImpl extends AbstractHandlerBehaviour implements PiPipelineInterpreter { } PiPipeconf pipeconf = DefaultPiPipeconf.builder () .withId (PIPECONF_ID) .withPipelineModel (P4InfoParser.parse (p4InfoUrl)) .addBehaviour (PiPipelineInterpreter.class, SimpleSwitchInterpreterImpl.class) .addExtension (P4_INFO_TEXT, p4InfoUrl) .addExtension (BMV2_JSON, jsonUrl) .build (); ç•¶ä¸€æ¢ flow rule è¢«åŠ å…¥åˆ° ONOS æ™‚ï¼ŒPI framework æœƒå°‡å…¶ç¿»è­¯æˆ PI flow ruleï¼Œä¹Ÿå°±æ˜¯å°‡é PI * çš„æ¬„ä½è½‰æ›æˆ PI flow rule çš„æ¬„ä½ã€‚\nfinal FlowRule flowRule = DefaultFlowRule.builder () .forTable (0) .withSelector (DefaultTrafficSelector.builder ().matchInPort (inPortNumber).build ()) .withTreatment (DefaultTrafficTreatment.builder ().setOutput (outPortNumber).build ()) .build (); Table Id translation # ä»¥å‰é¢æåˆ°çš„ port 1 é€åˆ° port 2 çš„ flow rule ä¾†ç¤ºç¯„ï¼Œæˆ‘å€‘éœ€è¦æŠŠ table id 0ï¼Œè½‰æ›æˆ PiTableId.of (\u0026quot;MyIngress.table0_control.table0\u0026quot;) ï¼Œé€™å°æ‡‰åˆ° Interpreter çš„ mapFlowRuleTableId å‡½æ•¸ï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹ map ä¾†è¨˜éŒ„ï¼Œtable index è·Ÿ Pi table id ä¹‹é–“çš„é—œä¿‚ï¼Œç„¶å¾Œå¯¦ä½œ mapFlowRuleTableIdã€‚é€™é‚Šçš„ id 0 ä¸¦ä¸å…·æœ‰ç‰¹å®šçš„æ„ç¾©ï¼Œåªæ˜¯å–®ç´”æˆ‘å€‘ interpreter å®šç¾©çš„ table indexï¼Œå› æ­¤ç•¶ APP ä½¿ç”¨æ™‚ï¼Œéœ€è¦çŸ¥é“é€™å€‹ index å°æ‡‰åˆ°çš„ table å…·é«”æ˜¯ä»€éº¼åŠŸèƒ½ï¼Œç•¶ç„¶é€šå¸¸æˆ‘å€‘æœƒå†åŠ ä¸Šä¸€å±¤ pipelinerï¼Œé€é flow objective ä¾†éš±è— table id çš„ç´°ç¯€ã€‚\nprivate static final Map\u0026lt;Integer, PiTableId\u0026gt; TABLE_MAP = new ImmutableMap.Builder\u0026lt;Integer, PiTableId\u0026gt;() .put (0, MY_INGRESS_TABLE0_CONTROL_TABLE0) .build (); @Override public Optional\u0026lt;PiTableId\u0026gt; mapFlowRuleTableId(int flowRuleTableId) { return Optional.ofNullable (TABLE_MAP.get (flowRuleTableId)); } Selector Translation # æˆ‘å€‘é€šå¸¸ä½¿ç”¨ DefaultTrafficSelector.builder ä¾†å®šç¾© Selectorã€‚ matchInPort æœƒåœ¨ selector å…§åŠ å…¥ä¸€å€‹ PortCriterion ï¼Œä»–çš„ criterion tpye æ˜¯ Criterion.Type.IN_PORT ï¼Œç‚ºæ­¤ Interpreter éœ€è¦æ ¹æ“š Criterion typeï¼Œå°‡å…¶è½‰æ›æˆ p4 table å°æ‡‰çš„ keyï¼ŒåŒæ¨£æˆ‘å€‘ä½¿ç”¨ map çš„æ–¹å¼ä¾†ç¶­è­·å…¶é—œä¿‚ã€‚\nprivate static final Map\u0026lt;Criterion.Type, PiMatchFieldId\u0026gt; CRITERION_MAP = new ImmutableMap.Builder\u0026lt;Criterion.Type, PiMatchFieldId\u0026gt;() .put (Criterion.Type.IN_PORT, HDR_STANDARD_METADATA_INGRESS_PORT) .put (Criterion.Type.ETH_SRC, HDR_HDR_ETHERNET_SRC_ADDR) .put (Criterion.Type.ETH_DST, HDR_HDR_ETHERNET_DST_ADDR) .put (Criterion.Type.ETH_TYPE, HDR_HDR_ETHERNET_ETHER_TYPE) .build (); @Override public Optional\u0026lt;PiMatchFieldId\u0026gt; mapCriterionType(Criterion.Type type) { return Optional.ofNullable (CRITERION_MAP.get (type)); } å¯èƒ½æœ‰äº›äººæœƒæœ‰äº›ç–‘æƒ‘èªªï¼Œp4 table key å¯èƒ½æœƒæ˜¯ exact æˆ–æ˜¯ ternaryï¼Œé‚£ ONOS è¦æ€éº¼æŠŠ matchInPort è½‰æ›æˆ ternary mask 0x1ff\nå‰é¢æåˆ°åœ¨è¨»å†Š pipeconf æ™‚ï¼Œæˆ‘å€‘é€é .withPipelineModel (P4InfoParser.parse (p4InfoUrl)) è¼‰å…¥ p4info (åœ¨ ONOS å…§ç¨±ä¹‹ç‚º PiPipelineModel)ï¼Œæ¯å€‹ key å…·é«”çš„é¡å‹å’Œè³‡æ–™é•·åº¦æœƒåŒ…å«åœ¨ p4info å…§ï¼ŒPI framework åœ¨è½‰æ›æ™‚æœƒæ ¹æ“šä¸åŒ criterion type å’Œ key type çš„ä¸åŒå’Œéœ€æ±‚è‡ªå‹•åšè½‰æ›ã€‚\nTreatment Translation # ä¸åƒ table id å’Œ criterionï¼Œåœ¨ p4 å…§ï¼Œæ¯å€‹ action æ˜¯ä¸€å€‹å¯å¸¶åƒæ•¸çš„ functionï¼Œå’Œ ONOS å®šç¾©çš„ treatment ä¸å­˜åœ¨ç°¡å–®çš„å°æ‡‰é—œä¿‚ï¼Œå› æ­¤ interpreter å®šç¾©äº† mapTreatmentï¼Œè¼¸å…¥æ˜¯ treatment å’Œ table idï¼Œè¼¸å‡ºæ˜¯ PiActionï¼Œè®“ interpreter å®Œæ•´çš„è™•ç†æ•´å€‹ treatmentã€‚\n@Override public PiAction mapTreatment(TrafficTreatment treatment, PiTableId piTableId) throws PiInterpreterException { // æª¢æŸ¥ table id æ˜¯å¦æœ‰æ•ˆï¼Œç”±æ–¼åªæœ‰ table0 ä¸€å¼µ tableï¼Œå› æ­¤é€™é‚Šç›´æ¥æª¢æŸ¥ table id æ˜¯ä¸æ˜¯ table 0 if (!piTableId.equals (MY_INGRESS_TABLE0_CONTROL_TABLE0)) { throw new PiInterpreterException(\u0026#34;Unsupported table id: \u0026#34; + piTableId); } // æˆ‘å€‘çš„ pipeline åªæ”¯æ´ set output port ä¸€å€‹ instruction if (treatment.allInstructions ().size () != 1 || !treatment.allInstructions ().get (0).type ().equals (Instruction.Type.OUTPUT)) { throw new PiInterpreterException(\u0026#34;Only output instruction is supported\u0026#34;); } PortNumber port = ((Instructions.OutputInstruction) treatment.allInstructions ().get (0)).port (); // åƒ controllerã€flooding é€™äº›ç‰¹åˆ¥çš„ portï¼Œç¨±ä¹‹ç‚º Logical port if (port.isLogical ()) { if (port.exactlyEquals (PortNumber.CONTROLLER)) { // æˆ‘å€‘æ”¯æ´ä½¿ç”¨ send_to_controller é€™å€‹ action å°‡å°åŒ…é€åˆ° ONOS return PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND_TO_CPU) .build (); } else { throw new PiInterpreterException(\u0026#34;Unsupported logical port: \u0026#34; + port); } } ä¸€èˆ¬çš„ä½¿ç”¨ç”¨ send é€™å€‹ action ä¾†å‚³é€å°åŒ… \u0026lt; br\u0026gt; return PiAction.builder ().withId (MY_INGRESS_TABLE0_CONTROL_SEND) .withParameter (new PiActionParam(PORT, port.toLong ())) .build (); } åˆ°æ­¤æˆ‘å€‘å·²ç¶“å®Œæˆäº† flow rule çš„è½‰æ›ï¼Œå¯ä»¥ä½¿ç”¨ ONOS æ¨™æº–çš„ flow rule ä¾†æ“ä½œ pipeline äº†ã€‚\nå¦‚æœå¸Œæœ›å°è½‰æ›æ©Ÿåˆ¶æœ‰æ›´è©³ç´°çš„ç­è§£å¯ä»¥æŸ¥çœ‹ ONOS åŸå§‹ç¢¼\nPacket-in/Packet-out # Interpreter å¦å¤–ä¸€å€‹é‡è¦çš„åŠŸèƒ½æ˜¯ä½¿ pipeline æ”¯æ´ packet-in/packet-out çš„åŠŸèƒ½ã€‚ç‚ºæ­¤æˆ‘å€‘éœ€è¦å…ˆä¿®æ”¹æˆ‘å€‘çš„ p4 pipelineã€‚\né¦–å…ˆæˆ‘å€‘æœƒå…ˆåŠ å…¥å…©å€‹ç‰¹åˆ¥çš„ headerï¼Œä¸¦ä½¿ç”¨ controller_header anotation æ¨™è¨˜ï¼Œ@controller_header (\u0026quot;packet_in\u0026quot;) ä¾†å¾—çŸ¥é€™å€‹ packet_in_header_t å°æ‡‰çš„æ˜¯ packet-in æ™‚ï¼Œé™„åŠ åœ¨é€™å€‹å°åŒ…çš„ meta dataï¼Œé€šå¸¸æœƒå®šç¾© ingress port ä¾†è¡¨ç¤ºå°åŒ…çš„ input portã€‚åŒæ¨£çš„ packet_out_header_t æ˜¯ packet-out æ™‚ï¼ŒONOS é€ä¾† pipeline è™•ç†çš„ meta data\n@controller_header (\u0026#34;packet_in\u0026#34;) header packet_in_header_t { bit\u0026lt;7\u0026gt; _padding; bit\u0026lt;9\u0026gt; ingress_port; } @controller_header (\u0026#34;packet_out\u0026#34;) header packet_out_header_t { bit\u0026lt;7\u0026gt; _padding; bit\u0026lt;9\u0026gt; egress_port; } æ¥è‘—æˆ‘å€‘è¦ä¿®æ”¹ headerã€parserï¼Œå¾ ONOS packet out å‡ºä¾†çš„å°åŒ…å° p4 äº¤æ›æ©Ÿä¾†èªªç›¸ç•¶æ–¼å¾ç‰¹å®šä¸€å€‹ port é€é€²ä¾†çš„å°åŒ…ï¼Œå› æ­¤ä¸€æ¨£æœƒç¶“éæ•´å€‹ pipeline\nä»¥ bmv2 ä¾†èªªï¼Œcontroller çš„ port number å¯ä»¥è‡ªç”±æŒ‡å®šï¼Œåœ¨æˆ‘å€‘ä½¿ç”¨çš„ p4mn container å…§é€™å€‹ port è¢«å®šç¾©æˆ 255ï¼Œç‚ºæ­¤æˆ‘å€‘åœ¨ pipeline çš„ p4 æª”æ¡ˆå…§å®šç¾©äº† CPU_PORT å·¨é›†ç‚º 255\næˆ‘å€‘å°‡ packet-in/packet-out header åŠ å…¥åˆ° headers å…§ï¼Œç•¶ packet-out æ™‚ï¼Œpacket_out æœƒåœ¨å°åŒ…çš„é–‹é ­ï¼Œå› æ­¤åœ¨ parser çš„ start stateï¼Œæˆ‘å€‘å…ˆæ ¹æ“š ingress port æ˜¯ä¸æ˜¯ CPU_PORT ä¾†æ±ºå®šæ˜¯ä¸æ˜¯è¦ parse packet_out headerã€‚\nstruct headers_t { packet_in_header_t packet_in; packet_out_header_t packet_out; ethernet_h ethernet; } parser MyParser(packet_in packet, out headers_t hdr, inout local_metadata_t meta, inout standard_metadata_t standard_metadata) { state start { transition select(standard_metadata.ingress_port) { CPU_PORT: parse_packet_out; default: parse_ethernet; } } state parse_packet_out { packet.extract (hdr.packet_out); transition parse_ethernet; } state parse_ethernet { packet.extract (hdr.ethernet); transition accept; } } åœ¨ Ingress éƒ¨åˆ†ï¼Œå¦‚æœæ˜¯ packet-out packetï¼Œæˆ‘å€‘æ²’æœ‰å¿…è¦è®“ä»–ç¶“éæ•´å€‹ ingress pipelineï¼Œç‚ºæ­¤æˆ‘å€‘ç›´æ¥å°‡ egress_spec è¨­ç½®ç‚º packet_out header å…§çš„ egress_portï¼Œç„¶å¾Œç›´æ¥å‘¼å« exitã€‚\ncontrol MyIngress(inout headers_t hdr, inout local_metadata_t meta, inout standard_metadata_t standard_metadata) { apply { if (standard_metadata.ingress_port == CPU_PORT) { standard_metadata.egress_spec = hdr.packet_out.egress_port; hdr.packet_out.setInvalid (); exit; } table0_control.apply (hdr, meta, standard_metadata); } } æˆ‘å€‘çš„ table0 å‰‡åŠ å…¥äº† send_to_cpu é€™å€‹ actionï¼Œåšçš„äº‹æƒ…å°±æ˜¯æŠŠ egress_spec è¨­å®šæˆ CPU portã€‚\ncontrol table0_control(inout headers_t hdr, inout local_metadata_t local_metadata, inout standard_metadata_t standard_metadata) { action send_to_cpu() { standard_metadata.egress_spec = CPU_PORT; } } ç•¶å°åŒ…è¦ packet-in åˆ° ONOS æ™‚ï¼Œéœ€è¦å°‡ packet-in header è¨­ç‚º validï¼Œä¸¦å¡«å…¥å°æ‡‰çš„è³‡æ–™ï¼Œé€™å€‹éƒ¨åˆ†æœƒå† Egress pipeline å®Œæˆ\ncontrol MyEgress(inout headers_t hdr, inout local_metadata_t meta, inout standard_metadata_t standard_metadata) { apply { if (standard_metadata.egress_port == CPU_PORT) { hdr.packet_in.setValid (); hdr.packet_in.ingress_port = standard_metadata.ingress_port; hdr.packet_in._padding = 0; } } } æœ€å¾Œç‚ºäº†è®“ packet-in header èƒ½å¾Œè¢«å‚³åˆ° ONOSï¼Œéœ€è¦å† deparser åŠ å…¥è©² headerï¼Œæ³¨æ„ packet-out header æ˜¯ç‚ºäº†è®“ pipeline èƒ½å¤ æ ¹æ“šè©² header ä¾†è™•ç† pecket-out header ç”¨çš„ï¼Œå› æ­¤ä»–ä¸æ‡‰è©²è¢«åŠ å…¥åˆ° deparserã€‚\ncontrol MyDeparser(packet_out packet, in headers_t hdr) { apply { packet.emit (hdr.packet_in); packet.emit (hdr.ethernet); } } æ¥è‘—å›åˆ°æˆ‘å€‘çš„ interpreterï¼Œåœ¨ interpreter å…§å®šç¾©äº†å…©å€‹å‡½æ•¸ mapInboundPacket å’Œ mapOutboundPacketï¼Œåˆ†åˆ¥å°æ‡‰ packet-in å’Œ packet-out å°åŒ…çš„è™•ç†ã€‚å…ˆå‰æˆ‘å€‘åœ¨ p4 pipeline å®šç¾©äº† packet_in å’Œ packet_out çš„ headerï¼Œé€™å…©å€‹å‡½æ•¸æœ€åŸºæœ¬çš„åŠŸèƒ½æ˜¯è®€å–å’Œå¯«å…¥é€™å…©å€‹ header çš„è³‡è¨Šã€‚ç”±æ–¼é€™å…©å€‹å‡½æ•¸çš„åŠŸèƒ½ç›¸å°å›ºå®šï¼Œå› æ­¤å¯ä»¥ç›´æ¥å¾ ONOS çš„ basic pipeline interpreter è¤‡è£½éä¾†ä¿®æ”¹ã€‚\n@Override public Collection\u0026lt;PiPacketOperation\u0026gt; mapOutboundPacket(OutboundPacket packet) throws PiInterpreterException { TrafficTreatment treatment = packet.treatment (); // ç”±æ–¼ outbound packet çš„å…§å®¹é€šå¸¸ä¸ç”¨åœ¨ switch ä¸Šåœ¨åšä¿®æ”¹ï¼Œå› æ­¤æˆ‘å€‘åªéœ€è¦å–å¾— //set output port çš„ instruction // ç•¶ç„¶å¦‚æœæœ‰ç‰¹åˆ¥çš„åŠŸèƒ½éœ€æ±‚ï¼Œå¯ä»¥é€éä¿®æ”¹ pipeline ä¾†æ”¯æ´æ›´å¤š instruction List\u0026lt;Instructions.OutputInstruction\u0026gt; outInstructions = ... ImmutableList.Builder\u0026lt;PiPacketOperation\u0026gt; builder = ImmutableList.builder (); for (Instructions.OutputInstruction outInst : outInstructions) { ... // é€™é‚Šé€éå‘¼å« createPiPacketOperation ä¾†å¡«å…¥ packet_out header çš„è³‡è¨Š builder.add (createPiPacketOperation (packet.data (), outInst.port ().toLong ())); ... } return builder.build (); } private PiPacketOperation createPiPacketOperation(ByteBuffer data, long portNumber) throws PiInterpreterException { PiPacketMetadata metadata = createPacketMetadata (portNumber); return PiPacketOperation.builder () .withType (PACKET_OUT) .withData (copyFrom (data)) .withMetadatas (ImmutableList.of (metadata)) .build (); } @Override public InboundPacket mapInboundPacket(PiPacketOperation packetIn, DeviceId deviceId) throws PiInterpreterException { Ethernet ethPkt; ... ethPkt = Ethernet.deserializer ().deserialize (packetIn.data ().asArray (), 0, ... //packet_in header çš„è³‡è¨Šæœƒä»¥ key-value çš„æ–¹å¼å­˜åœ¨ packetIn.metadatas Optional\u0026lt;PiPacketMetadata\u0026gt; packetMetadata = packetIn.metadatas () .stream ().filter (m -\u0026gt; m.id ().equals (INGRESS_PORT)) .findFirst () // å¾ä¸­æå–å‡º input port number ImmutableByteSequence portByteSequence = packetMetadata.get ().value (); short s = portByteSequence.asReadOnlyBuffer ().getShort (); ConnectPoint receivedFrom = new ConnectPoint(deviceId, PortNumber.portNumber (s)); ByteBuffer rawData = ByteBuffer.wrap (packetIn.data ().asArray ()); return new DefaultInboundPacket(receivedFrom, ethPkt, rawData); ... } åˆ°æ­¤æˆ‘å€‘å·²ç¶“å®Œæˆäº† interpreter çš„å¯¦ç¾äº†ï¼ŒInterpreter ç›®å‰é‚„åŒ…å« mapLogicalPortNumber å’Œ getOriginalDefaultAction ï¼Œä¸éåŸºæœ¬çš„ interpreter ä¸éœ€è¦å¯¦ç¾é€™å…©å€‹åŠŸèƒ½ï¼Œæ‰€ä»¥é€™é‚Šå°±ä¸å†å±•é–‹ä»‹ç´¹ã€‚\nåŒæ¨£ä½¿ç”¨ç¯„ä¾‹ç¨‹å¼ç¢¼æ™‚ï¼Œå¯ä»¥åœ¨ ONOS CLI ä½¿ç”¨ add-common-flow-rule \u0026lt;device id\u0026gt; \u0026lt;input port\u0026gt; \u0026lt;output port\u0026gt; çš„æ–¹å¼ä¾†ä½¿ç”¨ä¸‹é” ONOS æ¨™æº–çš„ flow ruleã€‚è©³æƒ…å¯ä»¥ åƒè€ƒæª”æ¡ˆã€‚\næ’°å¯« Pipeliner # åˆ°ç›®å‰ç‚ºæ­¢æˆ‘å€‘å·²ç¶“å®Œæˆäº† pipeconf çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯ä»¥ä¸‹ flow rule é‚„æœ‰ä½¿ç”¨ packet-in/packet-out çš„åŠŸèƒ½ï¼Œä¸éåˆ°ç›®å‰æˆ‘å€‘é‚„æ˜¯éœ€è¦ç›´æ¥ä½¿ç”¨ flow ruleï¼Œè¦çŸ¥é“ table id å°æ‡‰çš„åŠŸèƒ½ï¼Œç‚ºäº†èƒ½å¤ éš±è— table çš„ç´°ç¯€é‚„æœ‰éŠœæ¥ ONOS å…§å»ºçš„ç¶²è·¯åŠŸèƒ½ APPï¼Œæˆ‘å€‘éœ€è¦å¯¦ä½œ pipeliner è®“æˆ‘å€‘çš„äº¤æ›æ©Ÿæ”¯æ´ flow objective çš„åŠŸèƒ½ã€‚\nå’Œ Interpreter é¡ä¼¼ï¼Œæˆ‘å€‘éœ€è¦å¯¦ä½œ Pipeliner é€™å€‹ä»‹é¢ä¸¦ç¹¼æ‰¿ AbstractHandlerBehaviour ç„¶å¾Œåœ¨ PipeconfLoader é€é addBehaviour (Pipeliner.class, SimpleSwitchPipeliner.class) çš„æ–¹å¼åŠ å…¥ã€‚\npublic class SimpleSwitchPipeliner extends AbstractHandlerBehaviour implements Pipeliner { private final Logger log = getLogger (getClass ()); private FlowRuleService flowRuleService; private DeviceId deviceId; @Override public void init(DeviceId deviceId, PipelinerContext context) { this.deviceId = deviceId; this.flowRuleService = context.directory ().get (FlowRuleService.class); } } é¦–å…ˆæˆ‘å€‘å¯¦ä½œ init æ–¹æ³•ï¼Œpipeliner å’Œäº¤æ›æ©Ÿä¹‹é–“æ˜¯ 1 å° 1 çš„é—œä¿‚ï¼Œå› æ­¤ç•¶äº¤æ›æ©Ÿè¢«åˆå§‹åŒ–çš„æ™‚å€™ï¼Œå¯ä»¥é€é init æ–¹æ³•å–å¾— device çš„ idã€‚context æœ€ä¸»è¦çš„éƒ¨ä»½æ˜¯ä½¿ç”¨ directory ().get æ–¹æ³•ã€‚å¹³å¸¸æˆ‘å€‘åœ¨ APP é–‹ç™¼æ™‚æ˜¯ä½¿ç”¨ Reference annotation ä¾†å–å¾— onos çš„ serviceï¼Œé€™é‚Šæˆ‘å€‘å¯ä»¥ç›´æ¥é€é get æ–¹æ³•ä¾†å–å¾— serviceï¼Œç”±æ–¼ pipeliner éœ€è¦å®Œæˆ flow ojbective åˆ° flow rule çš„è½‰æ›ï¼Œä¸¦ç›´æ¥é€åˆ° flow rule serviceï¼Œå› æ­¤é€™é‚Šå…ˆå–å¾— flow rule serviceã€‚\nåœ¨ ONOS Flow Objective Service çš„æ¶æ§‹å…§ï¼Œå…¶å¯¦ç¸½å…±æœ‰ä¸‰ç¨® objectiveï¼Œåˆ†åˆ¥æ˜¯ forwardã€filter å’Œ nextï¼Œä»–å€‘éƒ½éœ€è¦é€é pipeliner ä¾†å’Œ ONOS æ ¸å¿ƒäº’å‹•ï¼Œç”±æ–¼æˆ‘å€‘åªæƒ³è¦å¯¦ä½œ forwarding objective çš„éƒ¨åˆ†ï¼Œå› æ­¤ filter å’Œ next å¯ä»¥å–®ç´”å›æ‡‰ä¸æ”¯æ´çš„éŒ¯èª¤è¨Šæ¯\n@Override public void filter(FilteringObjective obj) { obj.context ().ifPresent (c -\u0026gt; c.onError (obj, ObjectiveError.UNSUPPORTED)); } @Override public void next(NextObjective obj) { obj.context ().ifPresent (c -\u0026gt; c.onError (obj, ObjectiveError.UNSUPPORTED)); } @Override public List\u0026lt;String\u0026gt; getNextMappings(NextGroup nextGroup) { // We do not use nextObjectives or groups. return Collections.emptyList (); } æ¥è‘—å°±åˆ°äº†æˆ‘å€‘çš„ä¸»è§’ forward objectiveï¼Œåœ¨å¯¦ä½œé‚è¼¯ä¸Šå…¶å¯¦èˆ‡ interpreter å° treatment çš„è™•ç†æ–¹å¼é¡ä¼¼ï¼Œforward æ–¹æ³•æœƒå–å¾—ä¸€å€‹ ForwardingObjective ç‰©ä»¶ï¼Œæˆ‘å€‘æ ¹æ“š treatment å’Œ selector ç”Ÿæˆå‡ºä¸€æ¢æˆ–å¤šæ¢ flow ruleï¼Œç„¶å¾Œé€é flow rule service ä¸‹æ”¾åˆ°äº¤æ›æ©Ÿä¸Šã€‚\n@Override public void forward(ForwardingObjective obj) { if (obj.treatment () == null) { obj.context ().ifPresent (c -\u0026gt; c.onError (obj, ObjectiveError.UNSUPPORTED)); } // Simply create an equivalent FlowRule for table 0. final FlowRule.Builder ruleBuilder = DefaultFlowRule.builder () .forTable (MY_INGRESS_TABLE0_CONTROL_TABLE0) .forDevice (deviceId) .withSelector (obj.selector ()) .fromApp (obj.appId ()) .withPriority (obj.priority ()) .withTreatment (obj.treatment ()); if (obj.permanent ()) { ruleBuilder.makePermanent (); } else { ruleBuilder.makeTemporary (obj.timeout ()); } switch (obj.op ()) { case ADD: flowRuleService.applyFlowRules (ruleBuilder.build ()); break; case REMOVE: flowRuleService.removeFlowRules (ruleBuilder.build ()); break; default: log.warn (\u0026#34;Unknown operation {}\u0026#34;, obj.op ()); } obj.context ().ifPresent (c -\u0026gt; c.onSuccess (obj)); } æœ€å¾Œæˆ‘å€‘é‚„éœ€è¦å¯¦ä½œ purgeAllï¼Œç•¶åˆªé™¤æ‰€æœ‰ flow obejctive çš„æ™‚å€™ï¼Œåˆªé™¤æ‰€æœ‰çš„ flow ruleï¼Œé€™é‚Šæˆ‘å€‘åªéœ€è¦ç°¡å–®å‘¼å« flow rule service çš„ purgeFlowRules å°±å¥½ã€‚\n@Override public void purgeAll(ApplicationId appId) { flowRuleService.purgeFlowRules (deviceId, appId); } åˆ°æ­¤æˆ‘å€‘å·²ç¶“å®Œæˆäº†æ•´å€‹ pipeconf çš„å¯¦ä½œï¼Œå¯ä»¥é€é flow objective çš„æ–¹å¼ä¾†ç®¡ç†äº¤æ›æ©Ÿä¸¦èˆ‡ ONOS å…§å»ºçš„ APP æ•´åˆï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€éä½¿ç”¨ proxyarp å’Œ fwd å…©å€‹ APP ä¾†è®“æˆ‘å€‘çš„äº¤æ›æ©Ÿèƒ½å¤ æ­£å¸¸çš„å·¥ä½œã€‚\nå°çµ # ä»¥ä¸Šå°±æ˜¯ ONOS P4 Pipeconf çš„åŸºæœ¬é–‹ç™¼æ•™å­¸ï¼Œä½¿ç”¨çš„ç¯„ä¾‹ç¨‹å¼ç¢¼åœ¨ githubï¼Œå¦‚æœæœ‰é‡åˆ°ä»»ä½•å•é¡Œæˆ–æœ‰èªªæ˜ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œæ­¡è¿ç•™è¨€æå•ï¼Œæˆ‘æœƒç›¡åŠ›ç‚ºå¤§å®¶è§£ç­”ã€‚\nåƒè€ƒè³‡æ–™ # https://hackmd.io/@cnsrl/onos_p4\nhttps://wiki.onosproject.org/pages/viewpage.action?pageId=16122675\nhttps://github.com/p4lang/tutorials/blob/master/exercises/basic/solution/basic.p4\n","date":"August 28 2022","externalUrl":null,"permalink":"/posts/onos-p4-switch-pipeconf-development/","section":"æ–‡ç« ","summary":"","title":"ONOS-P4-Switch-Pipeconf-Development","type":"posts"},{"content":"","date":"August 28 2022","externalUrl":null,"permalink":"/tags/p4/","section":"æ¨™ç±¤","summary":"","title":"P4","type":"tags"},{"content":"","date":"August 28 2022","externalUrl":null,"permalink":"/tags/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC%E6%95%99%E5%AD%B8/","section":"æ¨™ç±¤","summary":"","title":"è»Ÿé«”é–‹ç™¼æ•™å­¸","type":"tags"},{"content":" ONOS è¸©å‘æ—¥è¨˜\nå‰è¨€ # æœ€è¿‘å˜—è©¦ä½¿ç”¨ ONOS ç›®å‰æœ€æ–°çš„ 2.7 ç‰ˆä¾†é–‹ç™¼ APPï¼Œç”¨ OpenFlow ä¾†è®“äº¤æ›æ©Ÿå¯¦ç¾ router çš„åŠŸèƒ½ã€‚çµæœè¸©åˆ° ONOS Packet-in å°åŒ…è™•ç†å¯¦ä½œæœªå®Œå…¨çš„å‘ã€‚\nç•¶å°åŒ…ç¶“é router æ™‚ï¼Œæœƒæ ¹æ“š routing table å’Œå°åŒ…çš„ç›®æ¨™æ±ºå®šè¦å¾€å“ªå€‹ interface é€å‡ºï¼ŒåŒæ™‚å°‡å°åŒ…çš„ source mac address æ”¹ç‚ºäº¤æ›æ©Ÿçš„ mac addressã€å°åŒ…çš„ destination mac address æ”¹ç‚º nexthop çš„ mac addressã€‚å› æ­¤æˆ‘å€‘éœ€è¦åœ¨äº¤æ›æ©Ÿä¸Šå®‰è£ä¸€æ¢ flow ruleï¼Œselector æ˜¯ destination mac addressï¼Œtreatment æœ‰ä¸‰å€‹ instructions åˆ†åˆ¥æ˜¯ï¼šä¿®æ”¹ src macã€dst mac å’Œæ±ºå®š output portã€‚\nç‚ºäº†æ¸›å°‘äº¤æ›æ©Ÿä¸Šçš„ flow entry çš„æ•¸é‡ï¼Œæ‰€ä»¥æ¡ç”¨ reactive çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ç•¶äº¤æ›æ©Ÿæ”¶åˆ°ç¬¬ä¸€å°åŒ…æ™‚ï¼Œå…ˆå°‡å°åŒ…é€ (packet-in) çµ¦ SDN controllerï¼Œcontroller æ ¹æ“š routing tableï¼Œç›´æ¥ä¿®æ”¹è©²å°åŒ…çš„ mac addressï¼Œä¸¦å¾äº¤æ›æ©Ÿç‰¹å®šçš„ port é€å‡º (packet-out)ï¼ŒåŒæ™‚ç”Ÿæˆå°æ‡‰çš„ flow rule ä¸¦å®‰è£åˆ°äº¤æ›æ©Ÿä¸Šï¼Œå¾ŒçºŒçš„å°åŒ…å°±å¯ä»¥ç›´æ¥æ ¹æ“š flow rule è½‰é€è€Œä¸ç”¨å†ç¶“é controllerã€‚\nå•é¡Œ # ç„¶è€Œå•é¡Œå°±å‡ºç¾åœ¨ç¬¬ä¸€å€‹å°åŒ…ä¸Šï¼Œæ ¹æ“š tcpdump çœ‹åˆ°çš„çµæœï¼Œå°åŒ…çš„ source å’Œ destination mac address éƒ½æ²’æœ‰è¢«ä¿®æ”¹åˆ°ã€‚\nç”±æ–¼æˆ‘æ˜¯ä½¿ç”¨ OVS ä¾†æ¨¡æ“¬ Openflow äº¤æ›æ©Ÿï¼Œå› æ­¤é¦–å…ˆæ‡·ç–‘æ˜¯ä¸æ˜¯ OVS æœ¬èº«å¯¦ä½œé™åˆ¶ï¼Œä¸æ”¯æ´åŒæ™‚åŒ…å«ä¸Šè¿°ä¸‰å€‹ instructions å°è‡´ã€‚ç„¶è€Œï¼Œå¾ŒçºŒç¶“é flow rule ç›´æ¥é€å‡ºçš„å°åŒ…ï¼Œéƒ½æœ‰æˆåŠŸä¿®æ”¹åˆ° mac addressã€‚ç”±æ–¼åªæœ‰ç¬¬ä¸€å€‹ packet-in åˆ° controllerï¼Œå† packet-out å› switch çš„å°åŒ…æ²’æœ‰è¢«ä¿®æ”¹ï¼Œå› æ­¤é–‹å§‹æ‡·ç–‘æ˜¯ ONOS çš„å•é¡Œã€‚\nè¿½è¹¤ # åœ¨ ONOS è£¡é¢ï¼Œä¸€èˆ¬ä½¿ç”¨ PacketProcessor çš„æ–¹å¼ä¾†è™•ç† packet-in åˆ° controller çš„å°åŒ…ã€‚é¦–å…ˆå¯¦ä½œ PacketProcessor ä»‹é¢ï¼Œç„¶å¾Œå‘ PacketService è¨»å†Šï¼ŒONOS å°±æœƒèª¿ç”¨ processor è™•ç† packet-in çš„å°åŒ…ã€‚\nprivate PacketProcessor processor = new PacketProcessor() { @Override public void process(PacketContext context) { //.... è™•ç†å°åŒ…çš„é‚è¼¯ // ä¿®æ”¹è¨­å®šå°åŒ…çš„ mac address å’Œæ±ºå®š output port context.treatmentBuilder () .setEthSrc (srcMac) .setEthDst (dstMac) .setOutput (outPort.port ()); context.send (); // å°‡å°åŒ… packet-out å›äº¤æ›æ©Ÿ } }; @Activate protected void activate() { packetService.addProcessor (processor, PacketProcessor.director (1)); } PacketContext æœƒåŒ…å« packet-in é€²ä¾†çš„å°åŒ…å…§å®¹ï¼Œä¸¦å¯é€é context.treatmentBuilder ä¿®æ”¹å°åŒ…å’Œæ±ºå®šè¦å¾€å“ªå€‹ port é€å‡ºå»ï¼Œæœ€å¾Œé€é send æŒ‡ä»¤ï¼Œpacket-out å›äº¤æ›æ©Ÿã€‚\næœæŸ¥ä¸€ä¸‹ ONOS çš„åŸå§‹ç¢¼ï¼Œæœƒåœ¨ core/api ä¸‹é¢æ‰¾åˆ° DefaultPacketContextï¼Œé€™å€‹ class å¯¦ä½œäº† PacketContext é€™å€‹ Interfaceï¼Œä½†æ˜¯é€™å€‹ class æ˜¯ä¸€å€‹ abstract classï¼Œå› æ­¤ä¸€å®šæœ‰äººç¹¼æ‰¿äº†å®ƒï¼Œç¹¼çºŒæœæŸ¥ PacketContext é€™å€‹å­—æœƒæ‰¾åˆ°å…©å€‹è·Ÿ Openflow ç›¸é—œçš„ï¼ŒDefaultOpenFlowPacketContext å’Œ OpenFlowCorePacketContextï¼Œä½†æ˜¯å¾Œè€…æ‰æœ‰ç¹¼æ‰¿ DefaultPacketContext å’Œå¯¦ä½œ PacketContext ä»‹é¢ï¼Œå› æ­¤ PacketProcesser åœ¨è™•ç† openflow packet-in é€²ä¾†çš„å°åŒ…æ™‚ï¼Œæ‹¿åˆ°çš„ PacketContext å…·é«”æ‡‰è©²æ˜¯ OpenFlowCorePacketContext é€™å€‹ classã€‚\næ‰“é–‹ OpenFlowCorePacketContext.java æœƒçœ‹åˆ°å®ƒå¯¦ç¾äº† send é€™å€‹ functionï¼Œç¶“éç°¡å–®çš„æª¢æŸ¥å¾Œå‘¼å« sendPacket é€™å€‹ functionï¼Œç„¶å¾Œä½ å°±æœƒçœ‹åˆ°â€¦\nprivate void sendPacket(Ethernet eth) { List\u0026lt;Instruction\u0026gt; ins = treatmentBuilder ().build ().allInstructions (); OFPort p = null; // TODO: support arbitrary list of treatments must be supported in ofPacketContext for (Instruction i : ins) { if (i.type () == Type.OUTPUT) { p = buildPort (((OutputInstruction) i).port ()); break; //for now... } } ....... } è¬åº•æ­æ›‰ï¼ŒåŸä¾† ONOS åªæœ‰å¯¦ä½œ output é€™å€‹ instruction (æ±ºå®š output port)ï¼Œå› æ­¤å®ƒç›´æ¥å¿½ç•¥çš„ set source mac å’Œ set destination mac å…©å€‹æŒ‡ä»¤ï¼Œäº¤æ›æ©Ÿé€å‡ºä¾†çš„å°åŒ…ç•¶ç„¶å°±åªæœ‰å¾€å°çš„ port é€ï¼Œè€Œæ²’æœ‰æ”¹åˆ° mac addressã€‚\nçµè«– # çµè«–å°±æ˜¯åœ¨ç•¶å‰ ONOS 2.7 ç’°å¢ƒä¸‹ï¼ŒPacketProcesser åœ¨è™•ç† Openflow äº¤æ›æ©Ÿå°åŒ… packet-out çš„æ™‚å€™ï¼Œåªèƒ½æ±ºå®šè©²å°åŒ…çš„ output portï¼Œå…¶é¤˜å°è©²å°åŒ…çš„ä¿®æ”¹éƒ½æ˜¯ç„¡æ•ˆçš„ã€‚\nåƒè€ƒè³‡æ–™ # ONOS Source code ","date":"August 12 2022","externalUrl":null,"permalink":"/posts/analyze-why-onos-packet-processor-treatment-not-work/","section":"æ–‡ç« ","summary":"","title":"åˆ†æ ONOS Packet Processor Treatment ç„¡æ•ˆä¹‹åŸå› ","type":"posts"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/awesome/","section":"","summary":"","title":"Awesome","type":"page"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"}]