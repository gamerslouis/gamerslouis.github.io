<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing - Louis Li&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Louis Li&#039;s Blog"><meta name="msapplication-TileImage" content="/img/mylogo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Louis Li&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="接續前一篇主題 XDP，今天我們要繼續來聊聊 eBPF 在 linux netowrk data path 上的另外一個進入點 tc，並同樣以 bcc 的 neighbor_sharing 作為範例。"><meta property="og:type" content="blog"><meta property="og:title" content="學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing"><meta property="og:url" content="https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/"><meta property="og:site_name" content="Louis Li&#039;s Blog"><meta property="og:description" content="接續前一篇主題 XDP，今天我們要繼續來聊聊 eBPF 在 linux netowrk data path 上的另外一個進入點 tc，並同樣以 bcc 的 neighbor_sharing 作為範例。"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://blog.louisif.me/img/my_og_image.png"><meta property="article:published_time" content="2022-10-31T09:16:36.000Z"><meta property="article:modified_time" content="2022-10-31T10:33:30.646Z"><meta property="article:author" content="Louis Li"><meta property="article:tag" content="eBPF"><meta property="article:tag" content="linux"><meta property="article:tag" content="bcc"><meta property="article:tag" content="tc"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.louisif.me/img/my_og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/"},"headline":"學習 eBPF 系列 7 - tc & BCC neighbor_sharing","image":["https://blog.louisif.me/img/og_image.png"],"datePublished":"2022-10-31T09:16:36.000Z","dateModified":"2022-10-31T10:33:30.646Z","author":{"@type":"Person","name":"Louis Li"},"publisher":{"@type":"Organization","name":"Louis Li's Blog","logo":{"@type":"ImageObject","url":"https://blog.louisif.me/img/mylogo.svg"}},"description":"接續前一篇主題 XDP，今天我們要繼續來聊聊 eBPF 在 linux netowrk data path 上的另外一個進入點 tc，並同樣以 bcc 的 neighbor_sharing 作為範例。"}</script><link rel="canonical" href="https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/"><link rel="alternate" href="/atom.xml" title="Louis Li&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/mylogo.svg"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.6.0/styles/atom-one-dark-reasonable.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-79VDS4QY8D" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-79VDS4QY8D');</script><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/archives">Archives</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜尋" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><p class="level-item is-flex justify-content-center"><i class="fas fa-calendar mr-1"></i><span><time dateTime="2022-10-31T09:16:36.000Z" title="10/31/2022, 5:16:36 PM">2022-10-31</time>發表</span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-folder mr-1"></i><span><a class="link-muted" href="/categories/eBPF/">eBPF</a></span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-clock mr-1"></i><span>26 分鐘讀完 (大約3854個字)</span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-person mr-1"></i><span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次訪問</span></p></div></div><h1 class="title is-3 is-size-4-mobile">學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing</h1><div class="content"><p>接續前一篇主題 <code>XDP</code>，今天我們要繼續來聊聊 eBPF 在 linux netowrk data path 上的另外一個進入點 <code>tc</code>，並同樣以 bcc 的 <a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/examples/networking/neighbor_sharing/">neighbor_sharing</a> 作為範例。</p>
<span id="more"></span>

<h2 id="Linux-tc-介紹"><a href="#Linux-tc-介紹" class="headerlink" title="Linux tc 介紹"></a>Linux tc 介紹</h2><p>首先我們要先聊聊 <code>tc</code> 是什麼東西。Traffic Control (tc) 是 linux kernel 網路系統裡面和 netfilter&#x2F;iptables 同等重要的一個組件。不過 netfilter 主要著重在 packet mangling (封包修改) 和 filter (過濾)。而 tc 的重點是在調控流量，提供限速、整形等功能。</p>
<p>tc 的工作時機點分成 <code>ingress tc</code> 和 <code>egress tc</code>，以 <code>ingress tc</code> 來說，他發生在 skb allocation 之後，進入 netfilter 之前。<code>ingress tc</code> 主要用於輸入流量控制，<code>egress tc</code> 則用於流量優先級、QoS 的功能。在傳統使用上，tc 更主要是用在 <code>egress tc</code>，<code>ingress tc</code> 本身有比較大的功能限制。</p>
<p>在 <code>tc</code> 裡面有三個主要的概念，<code>qdisc</code>、<code>class</code> 和 <code>filter (classifier)</code>。</p>
<p>tc 的基礎是 queue，封包要進出主機時，會先進入 queue，根據特定的策略重新排序、刪除、延遲後再交給網卡送出，或 netfilter 等系統收入。</p>
<p><code>qdisc</code> 是套用在這個 queue 上面的策略規則。下列舉例一部份:</p>
<ul>
<li>最基本的策略規則是 pfifo，就是一個簡單的 FIFO queue，只能設定 queue 的可儲存的封包大小和封包個數。</li>
<li>更進階的如 pfifo_fast，會根據 ip 封包內的 <code>ToS</code> 欄位將封包分成三個優先度，每個優先度內是走 FIFO 規則，但是會優先清空高優先度的封包。</li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc-sfq.8.html">sfq</a> 則是會根據 tcp&#x2F;udp&#x2F;ip 欄位 hash 的結果區分出不同的連線，將不同連線的封包放入獨立的 bucket 內，然後 bucket 間使用輪尋的方式，來讓不同連線均等的輸出。</li>
<li>ingress 是專門用在 ingress tc 的 qdisc<br>上面的 qdisc 都歸為 classless QDisc，因為我們不能透過自定義的方式對流量進行分類，提供不同的策略。</li>
</ul>
<p>與 classless 相反的是 classful qdisc，在 classful qdisc 內，我們可以以定義出多個 <code>class</code>，針對不同的 class 設定不同的限速策略等規則。也可以將多個 class 附屬在另外一個 class 下，讓子 class 共用一個父 class 的最大總限速規則，但是子分類又獨立有限速規則等等。</p>
<p>而要對流量進行分類就會用到 <code>filter</code>, 對於某個 qdisc (classless&#x2F;classful 皆可) 或著父 class 上的封包，如果滿足 filter 的條件，就可以把封包歸到某個 class 上。<br>除了歸類到某個 class 上，filter 也可以設置為執行某個 action，包括丟棄封包、複製封包流量到另外一個網路介面上之類的…</p>
<p>對於 qdisc 和 class 在建立時需指定或自動分配一個在網卡上唯一的 handle 作為識別 id，格式是 <code>&lt;major&gt;:&lt;minor&gt;</code>(數字)，對於 qdisc 來說只有 major 的部分 <code>&lt;major&gt;:</code>，對 class 來說 major 必須與對應 qdisc 相同。</p>
<p>另外在 egress pipeline 可以有多個 qdisc，其中一個作為 root，其他的藉由 filter 從 root qdisc dispatch 過去，所以需要有 major 這個欄位。</p>
<p>在 linux 上面主要透過 <code>tc</code> 這個指令來設置 <code>qdisc</code>、<code>class</code> 和 <code>filter</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"> 添加 eth0 egress 的 root qdisc，類型是 htb，後面是 htb 的參數 </span><br>tc qdisc add dev enp0s3 root handle 1: htb default 30<br><span class="hljs-meta prompt_"># </span><span class="language-bash"> 添加 eth 的 ingress qdisc</span><br>tc qdisc add dev enp0s3 ingress<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> 設置一個 class，速度上下限都是 20mbps，附屬於 eth0 的 root qdisc (1:) 下 </span><br>tc class add dev enp0s3 partent 1: classid 1:1 htb rate 20mbit ceil 20mbit<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> 當封包為 ip, dst port 80 時分類到上述分類 </span><br>tc filter add dev enp0s3 protocol ip parent 1: prio 1 u32 match ip dport 80 0xffff flowid 1:1<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"> 查看 egress filter</span><br>tc filter show dev eth0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> 查看 ingress filter</span><br>tc filter show dev eth0 ingress<br></code></pre></td></tr></table></figure>

<h2 id="eBPF-與-tc"><a href="#eBPF-與-tc" class="headerlink" title="eBPF 與 tc"></a>eBPF 與 tc</h2><p>eBPF 在 tc 系統裡面是在 <code>filter</code> 的部分作用，並可分成兩種模式，classifier (BPF_PROG_TYPE_SCHED_CLS) 和 action (BPF_PROG_TYPE_SCHED_ACT)。</p>
<ul>
<li><p>classifier: 前者分析封包後，決定是否 match，並可以將封包分類給透過 tc 指令預設的 classid 或著重新指定 classid。</p>
<ul>
<li>0: mismatch</li>
<li>-1: match, 使用 filter 預設的 classid</li>
<li>直接回傳一個 classid</li>
</ul>
</li>
<li><p>action: 作為該 <code>filter</code> 的 action，當 tc 設置的 filter 規則 match 後，呼叫 eBPF 程式決定 action 是 drop (2), 執行預設 action (-1) 等。<br>  下列是 action 的完整定義</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_UNSPEC	(-1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_OK		0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_RECLASSIFY	1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_SHOT		2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_PIPE		3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_STOLEN		4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_QUEUED		5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_REPEAT		6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_REDIRECT		7</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TC_ACT_JUMP		0x10000000	</span><br></code></pre></td></tr></table></figure>

<h2 id="BCC-neighbor-sharing"><a href="#BCC-neighbor-sharing" class="headerlink" title="BCC neighbor_sharing"></a>BCC neighbor_sharing</h2><h3 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h3><p>這次要看的是 <code>examples/networking/neighbor_sharing</code>。(<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/examples/networking/neighbor_sharing/">原始碼</a>)</p>
<p>這次的 eBPF 程式會提供 QoS 的服務，對經過某張網卡的針對往特定的 IP 提供不同的限速群組。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">                         /------------\                        |<br>neigh1 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |                        |<br>neigh2 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|    &lt;-128kb-|        /------\        |<br>neigh3 --|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |  wan0  | wan  |        |<br>         | ^             |   br100    |-&lt;-&lt;-&lt;--| sim  |        |<br>         | clsfy_neigh () |            |   ^    \------/        |<br>lan1 ----|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|    &lt;--1Mb--|   |                    |<br>lan2 ----|-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-&gt;-|            |   classify_wan ()       |<br>           ^             \------------/                        |<br>           pass ()                                              |<br></code></pre></td></tr></table></figure>
<p>上圖是 neighbor_sharing 自帶的網路拓譜圖，neight1-3, lan1-2, wan0 是獨立的 network namespace 擁有獨立的 IP，neighbor_sharing 會在 wansim 到 br100 的介面上建立 <code>ingress tc</code>，針對 neigh1-3 的 IP 提供總共 128kb&#x2F;s 的網路速度，對其他 IP 提供總共 1024kb&#x2F;s 的網路速度。</p>
<p>首先在測試之前要先安裝 pyroute2 和 netperf，前者是 python 接接 tc 指令的 library，後者是用來測試網速的工具。另外要記得設置防火牆規則不然 br100 不會轉發封包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">pip3 install pyroute2<br>apt install netperf<br>iptables -P FORWARD ACCEPT<br>sysctl -w net.ipv4.ip_forward=1<br></code></pre></td></tr></table></figure>

<p>neight1-3 會被分配 172.16.1.100-102 的 IP, lan 則是 172.16.1.150-151。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo ip netns exec wan0 netperf -H 172.16.1.100 -l 2 -k<br>MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.100 () port 0 AF_INET : demo<br>Recv   Send    Send<br>Socket Socket  Message  Elapsed<br>Size   Size    Size     Time     Throughput<br>bytes  bytes   bytes    secs.    10^6bits/sec<br><br> 131072  16384  16384    6.00      161.45<br></code></pre></td></tr></table></figure>
<p>透過 netperf 可以測出來到 neight1 的封包流量被限制在約 161.45 kbits&#x2F;sec。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip netns exec wan0 netperf -H 172.16.1.150 -l 2 -f k<br>MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.150 () port 0 AF_INET : demo<br>Recv   Send    Send                          <br>Socket Socket  Message  Elapsed              <br>Size   Size    Size     Time     Throughput  <br>bytes  bytes   bytes    secs.    10^3bits/sec  <br><br>131072  16384  16384    2.67     1065.83 <br></code></pre></td></tr></table></figure>
<p>而到 lan1 大約是 1065.83kbits&#x2F;sec，接近預先設置的規則。</p>
<h3 id="python-實作"><a href="#python-實作" class="headerlink" title="python 實作"></a>python 實作</h3><p>這次會先看 python 的程式碼，由於這次的程式碼包含大量用來建立測試環境的部分，所以會跳過只看相關的內容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">b = BPF (src_file=<span class="hljs-string">&quot;tc_neighbor_sharing.c&quot;</span>, debug=<span class="hljs-number">0</span>)<br><br>wan_fn = b.load_func (<span class="hljs-string">&quot;classify_wan&quot;</span>, BPF.SCHED_CLS)<br>pass_fn = b.load_func (<span class="hljs-string">&quot;pass&quot;</span>, BPF.SCHED_CLS)<br>neighbor_fn = b.load_func (<span class="hljs-string">&quot;classify_neighbor&quot;</span>, BPF.SCHED_CLS)<br></code></pre></td></tr></table></figure>
<p>首先這次的 eBPF 程式包含三個部分，因此會分別載入，並且全部都是 classifier (BPF_PROG_TYPE_SCHED_CLS)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">ipr.tc (<span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-string">&quot;ingress&quot;</span>, wan_if [<span class="hljs-string">&quot;index&quot;</span>], <span class="hljs-string">&quot;ffff:&quot;</span>)<br>ipr.tc (<span class="hljs-string">&quot;add-filter&quot;</span>, <span class="hljs-string">&quot;bpf&quot;</span>, wan_if [<span class="hljs-string">&quot;index&quot;</span>], <span class="hljs-string">&quot;:1&quot;</span>, fd=wan_fn.fd,<br>	   prio=<span class="hljs-number">1</span>, name=wan_fn.name, parent=<span class="hljs-string">&quot;ffff:&quot;</span>, action=<span class="hljs-string">&quot;drop&quot;</span>,<br>	   classid=<span class="hljs-number">1</span>, rate=<span class="hljs-string">&quot;128kbit&quot;</span>, burst=<span class="hljs-number">1024</span> * <span class="hljs-number">32</span>, mtu=<span class="hljs-number">16</span> * <span class="hljs-number">1024</span>)<br>ipr.tc (<span class="hljs-string">&quot;add-filter&quot;</span>, <span class="hljs-string">&quot;bpf&quot;</span>, wan_if [<span class="hljs-string">&quot;index&quot;</span>], <span class="hljs-string">&quot;:2&quot;</span>, fd=pass_fn.fd,<br>	   prio=<span class="hljs-number">2</span>, name=pass_fn.name, parent=<span class="hljs-string">&quot;ffff:&quot;</span>, action=<span class="hljs-string">&quot;drop&quot;</span>,<br>	   classid=<span class="hljs-number">2</span>, rate=<span class="hljs-string">&quot;1024kbit&quot;</span>, burst=<span class="hljs-number">1024</span> * <span class="hljs-number">32</span>, mtu=<span class="hljs-number">16</span> * <span class="hljs-number">1024</span>)<br></code></pre></td></tr></table></figure>

<p>接著會建立 wan_if 的 ingress qdisc (wan_if 是 wan0 接到 br100 的介面)，並且會 ingress qdisc 下建立兩條 filter，首先它的 type 指定為 bpf 並透過 <code>fd=wan_fn.fd</code> 選定 eBPF program，所以會交由 eBPF classifier 來決定是不是要 match。</p>
<blockquote>
<p>classifier match 後就會執行下屬的 policing action，跟 classid 無關，且在這次的範例中並不存在 class，所以 classid 其實是無意義的，不一定要設置。</p>
</blockquote>
<p>後半段 <code>action=&quot;drop&quot;, rate=&quot;128kbit&quot;, burst=1024 * 32, mtu=16 * 1024</code> 定義了一條 policing action，只有當封包滿足 policy 條件時才會觸發具體的 action，這邊指定是流量超出 128kbit 時執行 drop，也就達到了限制 neigh 流量的效果。</p>
<p>第二條同理，match pass_fn 並且流量到達 1024kbit 時執行 drop，由於 pass_fn 顧名思義是無條件 match 的意思，所以等價於所有非 neigh 的流量共用這一條的 1024kbit 流量限制。</p>
<p>因此總結來說，eBPF 程式 wan_fn 透過某種方式判斷封包是否是往 neigh 的 ip，是的話就 match 第一條 filter 執行 policing action 來限流，不然就 match 第二條 filter 來做限流。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">ret = self._create_ns (<span class="hljs-string">&quot;neighbor% d&quot;</span> % i, ipaddr=ipaddr,<br>                                  fn=neighbor_fn, cmd=cmd)<br></code></pre></td></tr></table></figure>
<p>接著就會看到，在建立 neigh1-3 的 namespace 時，attach 了 neighbor_fn 到網卡上，因此就很好理解了 neighbor_fn 監聽了從 neigh 發出的封包，解析拿到 neigh 的 IP 後，透過 map share 給 wan_fn，讓 wan_fn 可以根據 ip 決定要不要 match 第一條 policing action。</p>
<h3 id="eBPF-實作"><a href="#eBPF-實作" class="headerlink" title="eBPF 實作"></a>eBPF 實作</h3><p>到這裡其實就分析出整個程式的執行邏輯了，我們接續來看看 neighbor_sharing 的 eBPF 程式，這次的 eBPF 程式分成三個部分，首先是接在每個 neigh ingress 方向的 classify_neighbor，接著是接在 wan0 ingress 方向的 classify_wan 和 pass。</p>
<p>前面說到出來 <code>classify_neighbor</code> 要做的事情就是紀錄 neigh1-3 的 IP，提供給 <code>classify_wan</code> 判斷是否要 match 封包，執行 128kbits 的流量限制。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipkey</span> &#123;</span><br>  u32 client_ip;<br>&#125;;<br><br>BPF_HASH (learned_ips, <span class="hljs-keyword">struct</span> ipkey, <span class="hljs-type">int</span>, <span class="hljs-number">1024</span>);<br></code></pre></td></tr></table></figure>
<p>首先定義了一個 hash map 用 key 來儲存所有 neigh 的 IP</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">classify_neighbor</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> __sk_buff *skb)</span> &#123;<br>  u8 *cursor = <span class="hljs-number">0</span>;<br>  ethernet: &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ethernet_t</span> *<span class="hljs-title">ethernet</span> =</span> cursor_advance (cursor, <span class="hljs-keyword">sizeof</span>(*ethernet));<br>    <span class="hljs-keyword">switch</span> (ethernet-&gt;type) &#123;<br>      <span class="hljs-keyword">case</span> ETH_P_IP: <span class="hljs-keyword">goto</span> ip;<br>      <span class="hljs-keyword">default</span>: <span class="hljs-keyword">goto</span> EOP;<br>    &#125;<br>  &#125;<br>  ip: &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_t</span> *<span class="hljs-title">ip</span> =</span> cursor_advance (cursor, <span class="hljs-keyword">sizeof</span>(*ip));<br>    u32 sip = ip-&gt;src;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipkey</span> <span class="hljs-title">key</span> =</span> &#123;.client_ip=sip&#125;;<br>    <span class="hljs-type">int</span> val = <span class="hljs-number">1</span>;<br>    learned_ips.insert (&amp;key, &amp;val);<br>    <span class="hljs-keyword">goto</span> EOP;<br>  &#125;<br>EOP:<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>接著 <code>classify_neighbor</code> 就會用 cursor 解析出 source ip，將其作為 hash map 的 key 放到 learned_ips 裡面，value 則都設為 1。不論如何都會 return 1 放行封包。雖然其實這是 neighbor ingress 方向上唯一的一條 filter，所以不論回傳值為多少其實都可以，不影響執行結果。</p>
<blockquote>
<p>這邊就要提到第一次學習 tc 還有 classifier 時會感到很困惑的地方了，首先 classifier 的回傳值 0 表示 mismatch, 1 表示 match 並轉移到預設的 class，其餘回傳值表示直接指定 classid 為回傳的數值。接著不論 classid 是多少，都會執行 filter 上面綁定的 action。在這次的範例中，所有的 filter 其實都不存在任何的 class，因此 return 值唯一的意義是控制是否要執行 action。這邊 classify_neighbor 綁定的 action 是 ok，表示放行封包的意思</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">classify_wan</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> __sk_buff *skb)</span> &#123;<br>  u8 *cursor = <span class="hljs-number">0</span>;<br>  ethernet: &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ethernet_t</span> *<span class="hljs-title">ethernet</span> =</span> cursor_advance (cursor, <span class="hljs-keyword">sizeof</span>(*ethernet));<br>    <span class="hljs-keyword">switch</span> (ethernet-&gt;type) &#123;<br>      <span class="hljs-keyword">case</span> ETH_P_IP: <span class="hljs-keyword">goto</span> ip;<br>      <span class="hljs-keyword">default</span>: <span class="hljs-keyword">goto</span> EOP;<br>    &#125;<br>  &#125;<br>  ip: &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_t</span> *<span class="hljs-title">ip</span> =</span> cursor_advance (cursor, <span class="hljs-keyword">sizeof</span>(*ip));<br>    u32 dip = ip-&gt;dst;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipkey</span> <span class="hljs-title">key</span> =</span> &#123;.client_ip=dip&#125;;<br>    <span class="hljs-type">int</span> *val = learned_ips.lookup (&amp;key);<br>    <span class="hljs-keyword">if</span> (val)<br>      <span class="hljs-keyword">return</span> *val;<br>    <span class="hljs-keyword">goto</span> EOP;<br>  &#125;<br>EOP:<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接著看到 <code>classify_wan</code>，他會提取封包的 dst ip address，並嘗試搜尋 learned_ips，如果找的到就表示這個是 neighbor 的 ip，回傳 map 對應的 value，前面提到所有的 value 都會設置為 1，因此表示 match 的意思，不然就跳轉到 EOP 回傳 0，表示 mismatch。同樣由於這邊不存在 class，因此 value 只要是非 0 即可，只是用來 match 執行 policing action。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pass</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> __sk_buff *skb)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最後的 <code>pass</code> 其實就是一條無條件回傳 1 表示 match，來執行 wan0 方向第二條 1024kbits&#x2F;sec 的限流政策用的。</p>
<h2 id="tc-與-XDP-比較"><a href="#tc-與-XDP-比較" class="headerlink" title="tc 與 XDP 比較"></a>tc 與 XDP 比較</h2><p>在 eBPF 裡面，XDP 和 TC 兩個功能常常被拿來一起討輪，前面有提到 eBPF 可以做為 tc actions 使用來達到封包過濾之類的效果，雖然實行效果上是比不上 XDP 的，但是 tc ingress 的 eBPF hook point 也在 kernel data path 的最早期，因此也能夠提供不錯的效能，加上 tc ebpf program 的 context 是 <code>sk_buff</code>，相較於 <code>xdp_buff</code>，可以直接透過 <code>__sk_buff</code> 取得和修改更多的 meta data，加上 tc 在 ingress 和 egress 方向都有 hook point，不像 XDP 只能作用在 ingress 方向，且 tc 完全不需要驅動支援即可工作，因此 tc 在使用彈性和靈活度上是比 XDP 更占優的。</p>
<blockquote>
<p>不過 tc 其實也有提供 offload 的功能，將 eBPF 程式 offload 到網卡上面執行。</p>
</blockquote>
<h2 id="Direct-action"><a href="#Direct-action" class="headerlink" title="Direct action"></a>Direct action</h2><p>然而由於 tc 的 hook point 分成 classifier 和 action 因此無法透過單一個 eBPF 程式做到 match-action 的效果，然而大多數時候 eBPF tc 程式的開發並不是要利用 tc 系統的功能做限速等功能，而是要利用 tc 在 kernel path 極早期這點做 packet mangling 和 filter 等事項，再加上 tc 系統的使用學習難度相對高，因此 eBPC 在 tc 後引入了 <a target="_blank" rel="noopener" href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=045efa82ff563cd4e656ca1c2e354fa5bf6bbda4">direct-action</a> 和 <a href="%5B%601f211a1b929c%60%5D(https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=1f211a1b929c804100e138c5d3d656992cfd5622)">clsact</a> 這兩個功能。</p>
<p>首先介紹 direct-action (da)，這個是在 classifier (BPF_PROG_TYPE_SCHED_CLS) 可啟用的一個選項，如果啟用 da，classifier 的回傳值就變成是 action，和 BPF_PROG_TYPE_SCHED_ACT 相同，而原本的 classid 改成設置__skb_buff-&gt;tc_classid 來傳輸。</p>
<blockquote>
<p>在 kernel code 內使用 prog-&gt;exts_integrated 標示是否啟用 da 功能</p>
</blockquote>
<p>透過 da 可以透過單一個 eBPF 程式完成 classifier 和 action 的功能，降低了 tc hook point 對原本 tc 系統框架的依賴，能夠透過 eBPF 程式簡潔的完成功能。</p>
<p>在 da 的使用上可以參考 bcc 的範例 <code>examples/networking/tc_perf_event.py</code>，使用上與普通的 classifer 幾乎無異，只要在載入時 <code>ipr.tc (&quot;add-filter&quot;,&quot;bpf&quot;, me,&quot;:1&quot;, fd=fn.fd, ... ,direct_action=True)</code> 加上 direct_action 選項即可。</p>
<p>透過 tc 指令查看時也可以看到 <code>direct-action</code> 字樣。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">tc filter show dev t1a<br>filter parent 1: protocol all pref 49152 bpf chain 0 <br>filter parent 1: protocol all pref 49152 bpf chain 0 handle 0x1 flowid :1 hello direct-action not_in_hw id 308 tag 57cd311f2e27366b jited <br>	action order 1: gact action pass<br>	 random type none pass val 0<br>	 index 2 ref 1 bind 1<br><br></code></pre></td></tr></table></figure>

<h2 id="clsact"><a href="#clsact" class="headerlink" title="clsact"></a>clsact</h2><p>後來 tc 加入了 clsact，clsact 是一個專為 eBPF 設計的偽 qdisc。首先 clsact 同時作用在 ingress 和 egress 方向，也進一步簡化了 ebpf 程式的掛載。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">tc qdisc add dev em1 clsact<br>tc filter add dev em1 ingress bpf da obj tc-example.o sec ingress<br>tc filter add dev em1 egress bpf da obj tc-example.o sec egress<br></code></pre></td></tr></table></figure>
<p>同時 clsact 工作在真的 qdisc 本身的 lock 之前，因此可以避免 lock 的開銷，預先完成比較複雜繁重的封包分類，在進入到真的 queue filter 時只根據更簡單的欄位 (如 tc_index) 做分類。另外 da 本來只能使用在 ingress 方向，透過 clsact，da 可以工作在 egress 方向。</p>
<p>關於 eBPF tc 的部分就大致上介紹到這裡，對於 tc 這個子系統相對來說是真的蠻陌生的，因此介紹這個部分的確是有比較大的難度和說不清楚的地方。</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.qdisc.filters.html">Classifying packets with filters</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man8/tc.8.html">tc man page</a></li>
<li><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/lartc-qdisc-zh/">用 tc qdisc 管理 Linux 网络带宽</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1409664">TC (Traffic Control) 命令</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/4000">Linux TC (Traffic Control) 简介</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>學習 eBPF 系列 7 - tc &amp; BCC neighbor_sharing</p><p><a href="https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/">https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Louis Li</p></div></div><div class="level-item is-narrow"><div><h6>發表於</h6><p>2022-10-31</p></div></div><div class="level-item is-narrow"><div><h6>更新於</h6><p>2022-10-31</p></div></div><div class="level-item is-narrow"><div><h6>許可協議</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/eBPF/">eBPF</a><a class="link-muted mr-2" rel="tag" href="/tags/linux/">linux</a><a class="link-muted mr-2" rel="tag" href="/tags/bcc/">bcc</a><a class="link-muted mr-2" rel="tag" href="/tags/tc/">tc</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/eBPF/Learn-eBPF-Serial-8-cgroups-socket-map/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">學習 eBPF 系列 8 - cgroups &amp; socket map</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/eBPF/Learn-eBPF-Serial-6-XDP-BCC-xdp-redirect-map/"><span class="level-item">學習 eBPF 系列 6 - XDP &amp; BCC xdp_redirect_map</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">評論</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://blog.louisif.me/eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/';
            this.page.identifier = 'eBPF/Learn-eBPF-Serial-7-tc-BCC-neighbor-sharing/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'louis-lis-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mylogo.svg" alt="Louis Li"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Louis Li</p><p class="is-size-6 is-block">NYCU CS</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hsinchu, Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分類</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">標籤</p><a href="/tags"><p class="title">14</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/gamerslouis" target="_blank" rel="noopener">追蹤</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/gamerslouis"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Mail" href="mailto:me@louisif.me"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分類</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/ONOS/"><span class="level-start"><span class="level-item">ONOS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Openstack/"><span class="level-start"><span class="level-item">Openstack</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/eBPF/"><span class="level-start"><span class="level-item">eBPF</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-02T17:49:46.000Z">2022-11-03</time></p><p class="title"><a href="/Openstack/Solve-Openstack-vm-create-fail/">解決 Openstack VM 建立失敗問題</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-02T16:47:08.000Z">2022-11-03</time></p><p class="title"><a href="/Openstack/Openstack-Deployment-Serial-3-Basic-Management-Commands/">Openstack 架設系列文章 (3) - 基本指令操作</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-01T13:00:57.000Z">2022-11-01</time></p><p class="title"><a href="/notes/Install-openvpn-client-on-proxmox/">Proxmox 安裝 openvpn client 紀錄</a></p><p class="categories"><a href="/categories/notes/">notes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-01T13:00:00.000Z">2022-11-01</time></p><p class="title"><a href="/Openstack/Openstack-Deployment-Serial-2-Deployment-with-Openstack-Ansible/">Openstack 架設系列文章 (2) - 使用 Openstack Ansible 部署 Openstack</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-31T10:14:40.000Z">2022-10-31</time></p><p class="title"><a href="/eBPF/Learn-eBPF-Serial-9-eBPF-helper-functions/">學習 eBPF 系列 9 - eBPF helper functions</a></p><p class="categories"><a href="/categories/eBPF/">eBPF</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">彙整</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">標籤</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/P4/"><span class="tag">P4</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bcc/"><span class="tag">bcc</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroups/"><span class="tag">cgroups</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eBPF/"><span class="tag">eBPF</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iaC/"><span class="tag">iaC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openstack/"><span class="tag">openstack</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openvpn/"><span class="tag">openvpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proxmox/"><span class="tag">proxmox</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/socketmap/"><span class="tag">socketmap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tc/"><span class="tag">tc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/terraform/"><span class="tag">terraform</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xdp/"><span class="tag">xdp</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">文章目錄</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Linux-tc-介紹"><span class="level-left"><span class="level-item">1</span><span class="level-item">Linux tc 介紹</span></span></a></li><li><a class="level is-mobile" href="#eBPF-與-tc"><span class="level-left"><span class="level-item">2</span><span class="level-item">eBPF 與 tc</span></span></a></li><li><a class="level is-mobile" href="#BCC-neighbor-sharing"><span class="level-left"><span class="level-item">3</span><span class="level-item">BCC neighbor_sharing</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#介紹"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">介紹</span></span></a></li><li><a class="level is-mobile" href="#python-實作"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">python 實作</span></span></a></li><li><a class="level is-mobile" href="#eBPF-實作"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">eBPF 實作</span></span></a></li></ul></li><li><a class="level is-mobile" href="#tc-與-XDP-比較"><span class="level-left"><span class="level-item">4</span><span class="level-item">tc 與 XDP 比較</span></span></a></li><li><a class="level is-mobile" href="#Direct-action"><span class="level-left"><span class="level-item">5</span><span class="level-item">Direct action</span></span></a></li><li><a class="level is-mobile" href="#clsact"><span class="level-left"><span class="level-item">6</span><span class="level-item">clsact</span></span></a></li><li><a class="level is-mobile" href="#參考資料"><span class="level-left"><span class="level-item">7</span><span class="level-item">參考資料</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Louis Li</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>個訪客</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-TW");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到頁首" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此網站使用Cookie來改善您的體驗。",
          dismiss: "知道了！",
          allow: "允許使用Cookie",
          deny: "拒絕",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="請輸入關鍵字..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"請輸入關鍵字...","untitled":"(無標題)","posts":"文章","pages":"頁面","categories":"分類","tags":"標籤"});
        });</script></body></html>