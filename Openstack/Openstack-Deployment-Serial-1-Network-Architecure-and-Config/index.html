<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Openstack 架設系列文章 (1) - 網路架構解析及設置 - Louis Li&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Louis Li&#039;s Blog"><meta name="msapplication-TileImage" content="/img/mylogo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Louis Li&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言在嘗試布建 openstack 的過程中，卡關最久的應該是網路的部分，由於在設置 openstack 的過程中，需要先把網路介面和線路連接設定好，所以必須要對 openstack 的網路架構，有清晰的認知，不然在設置的過程中會遇到許多障礙… 特別是 openstack 有 flat, vlan, vxlan 以及 provider, self-service 兩種不同維度的概念分類，因此在釐清"><meta property="og:type" content="blog"><meta property="og:title" content="Openstack 架設系列文章 (1) - 網路架構解析及設置"><meta property="og:url" content="https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/"><meta property="og:site_name" content="Louis Li&#039;s Blog"><meta property="og:description" content="前言在嘗試布建 openstack 的過程中，卡關最久的應該是網路的部分，由於在設置 openstack 的過程中，需要先把網路介面和線路連接設定好，所以必須要對 openstack 的網路架構，有清晰的認知，不然在設置的過程中會遇到許多障礙… 特別是 openstack 有 flat, vlan, vxlan 以及 provider, self-service 兩種不同維度的概念分類，因此在釐清"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://blog.louisif.me/img/my_og_image.png"><meta property="article:published_time" content="2022-10-04T19:10:57.000Z"><meta property="article:modified_time" content="2022-11-01T13:17:53.951Z"><meta property="article:author" content="Louis Li"><meta property="article:tag" content="Openstack"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.louisif.me/img/my_og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/"},"headline":"Openstack 架設系列文章 (1) - 網路架構解析及設置","image":["https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221002233913.png","https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221002235709.png","https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221003122839.png","https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221003140037.png","https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221005021155.png","https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221005021447.png"],"datePublished":"2022-10-04T19:10:57.000Z","dateModified":"2022-11-01T13:17:53.951Z","author":{"@type":"Person","name":"Louis Li"},"publisher":{"@type":"Organization","name":"Louis Li's Blog","logo":{"@type":"ImageObject","url":"https://blog.louisif.me/img/mylogo.svg"}},"description":"前言在嘗試布建 openstack 的過程中，卡關最久的應該是網路的部分，由於在設置 openstack 的過程中，需要先把網路介面和線路連接設定好，所以必須要對 openstack 的網路架構，有清晰的認知，不然在設置的過程中會遇到許多障礙… 特別是 openstack 有 flat, vlan, vxlan 以及 provider, self-service 兩種不同維度的概念分類，因此在釐清"}</script><link rel="canonical" href="https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/"><link rel="alternate" href="/atom.xml" title="Louis Li&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/mylogo.svg"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.6.0/styles/atom-one-dark-reasonable.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-79VDS4QY8D" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-79VDS4QY8D');</script><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/archives">Archives</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜尋" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><p class="level-item is-flex justify-content-center"><i class="fas fa-calendar mr-1"></i><span><time dateTime="2022-10-04T19:10:57.000Z" title="10/5/2022, 3:10:57 AM">2022-10-05</time>發表</span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-folder mr-1"></i><span><a class="link-muted" href="/categories/Openstack/">Openstack</a></span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-clock mr-1"></i><span>26 分鐘讀完 (大約3892個字)</span></p><p class="level-item is-flex justify-content-center"><i class="fas fa-person mr-1"></i><span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次訪問</span></p></div></div><h1 class="title is-3 is-size-4-mobile">Openstack 架設系列文章 (1) - 網路架構解析及設置</h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在嘗試布建 openstack 的過程中，卡關最久的應該是網路的部分，由於在設置 openstack 的過程中，需要先把網路介面和線路連接設定好，所以必須要對 openstack 的網路架構，有清晰的認知，不然在設置的過程中會遇到許多障礙…</p>
<p>特別是 openstack 有 <code>flat, vlan, vxlan</code> 以及 <code>provider, self-service</code> 兩種不同維度的概念分類，因此在釐清的過程中花費許多時間，因此這邊整理一下 openstack 的各種網路架構。</p>
<p>這篇文章不會介紹具體的 openstack 搭建，不過之後會有一篇介紹如何使用 openstack-ansible 來部屬 openstack。</p>
<span id="more"></span>

<p>首先為了後續討論方便我們這邊要先幫 openstack 裡面的幾個網路層級訂個名子。</p>
<ul>
<li>物理網路：由 openstack 節點上面的實體網卡以及結點外的網路構成</li>
<li>節點覆蓋 (Overlay) 網路：節點上面的特定一個 linux bridge 透過物理網路與其他節點上的 bridge 共同構成的一個 L2 網路</li>
<li>虛擬網路：以虛擬機的視角看到的 L2 網路<br>後續會持續出現這三個名詞，在介紹的過程中來解釋和分析這三者的差別。</li>
</ul>
<h2 id="Openstack-網路類型概念"><a href="#Openstack-網路類型概念" class="headerlink" title="Openstack 網路類型概念"></a>Openstack 網路類型概念</h2><p>首先我們先撇開 openstack，我們看一個最簡單在多台實體設備上面裝設虛擬機構建出來的一個網路結構。</p>
<p><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221002233913.png" alt="基礎網路架構"><br>在這個架構裡，所有的 VM 和實體網卡都接在同一個 linux bridge 上，由於實體網卡也橋接在 bridge 上了，所以節點上的虛擬網路是物理網路的延伸，可以看成所有實體共同構成了一個 L2 網路。<br>由於 bridge 本身可以給予 IP，當成是接在節點上的網路介面，因此 VM 和節點本身也都同在一個 L2 網路內彼此互相可見。<br>在這個網路架構中，物理網路、節點覆蓋網路和虛擬網路三者是完全等價通透的。</p>
<h3 id="Flat-network"><a href="#Flat-network" class="headerlink" title="Flat network"></a>Flat network</h3><p><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221002235709.png" alt="基礎 Openstack 網路架構"><br>接著我們加入 openstack 的組件。<br>首先是 controller 節點，我們在 controller 節點上部屬了 openstack 的 API 服務。<br>接著我們在 compute 節點上增加一張實體網卡 <code>eth1</code> 讓節點上的 nova agent 和 neutron agent 可以與 contrroller node 溝通。<br>在這個架構中，所有的 service 和 agent 是直接安裝在節點上的程式，因此可以透過 eth1 實體網卡的 ip 直接進行訪問。<br>在圖中的 linux bridge 換了顏色，因為這個 bridge 並不是由我們手動建立出來的而是由 neutron agent 自行建立出來的。同時當 nova 建立 VM 後，neutron 也會建立 veth pair 連接 bridge 和 VM。<br>到此我們就建立了最簡單的 openstack 網路，在這個網路架構下雖然節點本身的網路從 bridge 分離出來成為了獨立的網卡，但是節點本身和所有的 VM 還是同處在一個 L2 網路內，因此在這個架構下物理網路、節點覆蓋網路和虛擬網路三者還是完全等價通透的。</p>
<p>到此我們就建構了 neutron 的第一個種網路模式 <code>flat</code>。Neutron 的不同模式差異在於說 neuitron 管理的 bridge 是如何接入節點覆蓋網路的 (在這邊可以先直接看成物理網路，關於節點覆蓋網路我們會在後面解釋)。在 <code>flat</code> 模式下對外網卡直接橋接到 bridge 上，不對封包做處理。</p>
<p>在 openstack 中有 tenant networks 租戶網路的概念，我們可以在 openstack 上切出若干個獨立的 L2 網路，分給不同的 project 和 vms 使用。在使用單一個 <code>flat</code> 網路的時候，這件事是做不到了，因為所有 VM 都在同一個 L2 網路內。<br>![flat 網路運算節點架構](Openstack&#x2F;Openstack-Deployment-Serial-1-Network-Architecure-and-Config&#x2F;Pasted image20221003133348.png)<br>直觀的第一個方法當然是切出多個 <code>flat</code> network 給不同的 tenat 使用，然而這樣使用的限制非常大，首先我們需要替每個 flat 預先切出獨立的 L2 網路，在這個範例中我們使用獨立的網卡和交換機來分割，非常麻煩，雖然後面會提到可以使用節點覆蓋網路的方法來切割，只用一張網路卡達成，然而每次增加網路需要修改每個節點上 neutron agent 的設定檔，不適合隨時依據需求改動。</p>
<p>因此比較可行的方法是使用 vlan 或 vxlan 來切割租戶網路，並將 vlan、vxlan 的建立管理交給 neutron agent 來處理。</p>
<h3 id="Vlan-network"><a href="#Vlan-network" class="headerlink" title="Vlan network"></a>Vlan network</h3><p><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221003122839.png" alt="vlan 網路運算節點架構"></p>
<p>首先是 <code>vlan</code> 模式，在 vlan 模式下我們一樣提供一個網路介面 <code>eth0</code> 給 neutron 使用，並一樣假設所有節點上的 <code>eth0</code> 介面都在 L2 互通。</p>
<p>接著當我們透過 openstack 建立網路並指定為 <code>vlan</code> type 時，neutron 會替該網路分配一個 vlan id，並建立對應的 vlan 網路卡，vlan 網路卡是 linux 本身的功能，經過 vlan 網路卡的封包會從該網路卡榜定的原始網卡送出去 (eth0)，但是封包會加上 vlan 網卡綁定的 vlan id。</p>
<p>如上圖所示，我們切割出了 vlan 356 和 vlan 357 兩個租戶網路，並統一透過 eth0 物理網路與其他節點溝通。</p>
<h3 id="Vxlan-network"><a href="#Vxlan-network" class="headerlink" title="Vxlan network"></a>Vxlan network</h3><p>首先我們先介紹一下 vxlan。和 vlan 的功能類似，vxlan 的功能也是在一個網路內切割出多個虛擬網路，不過教於 vlan，vxlan 有以下特點:</p>
<ul>
<li>vlan id 只能夠切出 4096 個網路，但是 vxlan id 可以切出 2 的 24 次方個網路。</li>
<li>vlan 只是在 ethernet header 和 IP header 中間插了一個 vlan header，因此 vlan 只能在 L2 的物理網路內傳輸。但是 vxlan 的封裝方式是將整個 L2 封包加上一個 vxlan header 後，封裝在一個 UDP 封包內，因此透過外面的 UDP 封包，vxlan 能夠跨越 L3 網路建立 L2 的通道，連結兩個不相連的 L2 網路。</li>
</ul>
<p>在 Linux 上建立 vxlan 介面時要指定兩個東西，一個是 vni (vxlan id), 另一個是 local ip，當封包通共 vxlan 介面時，會被加上包含 vni 的 vxlan id，外部的 UDP 封包則會利用 local ip 當作 src ip，同時利用該 local ip 對應的 interface 來收發 vxlan 封包。</p>
<p>在 vlan 網路裡面，由於 vlan 一樣是 L2 封包，因此封包是透過 L2 的廣播學習機制來傳遞的。然而如前面所示，vxlan 封包會封裝成 UDP 封包，因此 vxlan 靠的是 L3 的路由機制來傳遞。</p>
<p>在 Linux 上這個路由機制有幾種作法</p>
<ul>
<li>在建立 vxlan interface 時直接指定 remote ip，建立成點對點的 vxlan tunnel</li>
<li>透過 linux bridge forwarding database，下達 forwarding rule，指定當 L2 封包的 mac address 是多少的時候要送到哪個 remote ip</li>
<li>最後也是 openstack 使用的方式，將封包發送到一個 L3 廣播地址 (例如 239.1.1.1)，linux 會自動在 L2 加上 multicast mac address，所有在同一個 L2 物理網路上的設備就能夠同時收到 vxlan 的封包。<br><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221003140037.png" alt="vxlan 網路運算節點架構"><br>回到 openstack 上，在設置 <code>vxlan</code> 時和 <code>vlan</code>、<code>flat</code> 不太一樣，我們不用指定綁定的網路介面 (eth0)，而是要指定 <code>local_ip</code> 跟 <code>vxlan_group</code>，前者對應到綁定解面 (eth0) 的 IP，後者則是 vxlan 廣播域的 IP (239.1.1.1)。<br>後面就和 vlan 一樣，在 openstack 上建立的網路時，netruon 為該網路建立對應的 vxlan 介面和 linux bridge，來提供給該網路的虛擬機使用。</li>
</ul>
<p>雖然在一台節點上面不太可能開到 4096 個 tenant，但是在整個 openstack 叢集內可以將不同 tenant 分配在不同的節點上，因此 vxlan 是有意義的。</p>
<h2 id="Openstack-網路設置"><a href="#Openstack-網路設置" class="headerlink" title="Openstack 網路設置"></a>Openstack 網路設置</h2><p>在 openstack neutron 中，我們要設定每個節點上的 ml2 設定檔來提供 neutron 網路的基本資訊。路徑在 <code>/etc/neutron/plugins/ml2/</code>。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="hljs-section">[ml2]</span><br><span class="hljs-attr">type_drivers</span> = flat,vlan,vxlan,local<br><span class="hljs-attr">tenant_network_types</span> = vxlan,vlan,flat<br><span class="hljs-attr">mechanism_drivers</span> = linuxbridge<br><span class="hljs-attr">extension_drivers</span> = port_security<br></code></pre></td></tr></table></figure>
<ul>
<li>首先對於上述三種不同的網路類型，如果要在 openstack 內使用需要指定啟用對應的 <code>type_drivers</code>。(除了前面介紹的三種網路類型，還有 local 跟 gre 這兩種，前者用於單機情況 neutron 的 linux bridge 不連接到任何對外網路，後者使用 gre tunnel 來取代 vxlan tunnel，這邊不多作介紹)</li>
<li>接著 <code>tenant_network_types</code> 表示在 openstack 設可以用於建立 project 租戶網路的網路類型，同時順序也代表了在建立網路時預設使用的網路類型優先順序。</li>
<li><code>mechanism_drivers</code> 這邊指定是 linuxbridge，前面提到 neutron 會建立 bridge 來連接 VM 跟外部網路介面，其實這邊還有很多其他選項，例如 open vSwitch，來提供更多網路管理功能，但是這邊就只以 linux bridge 為主要介紹對象。</li>
<li><code>extension_drivers</code> 則可以載入其他 plugin 來提供 QoS、安全管理的功能。</li>
</ul>
<p>接著我們要設定物理網路和網路介面的對應，在 flat 和 vlan 網路模式下，我們都需要將網路與一張可以連接到物理網路的網路介面做綁定 (前面的 eth0 或 eth1)，但是在實際情況中，每個節點上網路介面卡的名稱可能不相通，因此需要在每個節點上指定物理網路和網路介面的對應。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="hljs-section">[linux_bridge]</span><br><span class="hljs-attr">physical_interface_mappings</span> = vlan1:eth0,flat1:eth1,flat2:eth2<br></code></pre></td></tr></table></figure>

<p>接著對不同的網路類型有各自的網路設置，首先是 flat，要指定的東西很簡單，就是可以用於建立 flat network 的物理網路，如果所有網路都可以，則指定為 *</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="hljs-section">[ml2_type_flat]</span><br><span class="hljs-attr">flat_networks</span> = flat1, flat2<br><span class="hljs-comment"># Example:flat_networks = *</span><br></code></pre></td></tr></table></figure>

<p>在 vlan 部分則要指定在每個物理網路上允許的租戶網路 vlan id，格式是<br><code>&lt;physical_network&gt;[:&lt;vlan_min&gt;:&lt;vlan_max&gt;]</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="hljs-section">[ml2_type_vlan]</span><br><span class="hljs-attr">network_vlan_ranges</span> = vlan1:<span class="hljs-number">101</span>:<span class="hljs-number">200</span>,vlan1:<span class="hljs-number">301</span>:<span class="hljs-number">400</span><br></code></pre></td></tr></table></figure>
<p>最後 vxlan 分成兩個部分，首先和 vlan 類似，我們要指定可使用的 vxlan vni 和廣播域 ip</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="hljs-section">[ml2_type_vxlan]</span><br><span class="hljs-attr">vxlan_group</span> = <span class="hljs-number">239.1</span>.<span class="hljs-number">1.1</span><br><span class="hljs-attr">vni_ranges</span> = <span class="hljs-number">1</span>:<span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure>
<p>接著我們要設置綁定的網卡 ip</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="hljs-section">[vxlan]</span><br><span class="hljs-attr">enable_vxlan</span> = <span class="hljs-literal">True</span><br><span class="hljs-attr">vxlan_group</span> = <span class="hljs-number">239.1</span>.<span class="hljs-number">1.1</span><br><span class="hljs-comment"># VXLAN local tunnel endpoint</span><br><span class="hljs-attr">local_ip</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">56.101</span><br><span class="hljs-attr">l2_population</span> = <span class="hljs-literal">False</span><br><span class="hljs-attr">ttl</span> = <span class="hljs-number">32</span><br></code></pre></td></tr></table></figure>
<p>這邊有一個特別的東西是 l2 population，l2 population 是一種降低廣播封包造成網路負載的方式，在傳統網路內 ARP 封包需要廣播到所有的節點上，大大增加的網路的負擔，透過 l2 population 提供的 proxy ARP 機制，ARP 會在節點上直接由 neutron 回應，而不用透過物理網路廣播到所有節點上，大大降低網路負擔，由於 openstack 內所有的 VM IP、網卡 mac address 都會受到 openstack 的管理，因此 openstack 可以做到 proxy ARP。如果需要啟用 l2 population 則需要額外的 driver，這邊一樣不做詳細介紹。</p>
<p>最後是網路安全的部分，在 openstack 我們可以使用 iptables 來建立 VM 的網路管理，iptables 會阻擋所有進出虛擬機網路的流量，並透過 security group 來下達 iptables 的規則允許特定流量進出。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="hljs-section">[securitygroup]</span><br><span class="hljs-attr">firewall_driver</span> = iptables<br><span class="hljs-attr">enable_security_group</span> = <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># /etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="hljs-section">[securitygroup]</span><br><span class="hljs-attr">enable_security_group</span> = <span class="hljs-literal">True</span><br><span class="hljs-attr">enable_ipset</span> = <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>

<h2 id="Provider-vs-Self-service-networks"><a href="#Provider-vs-Self-service-networks" class="headerlink" title="Provider vs Self-service networks"></a>Provider vs Self-service networks</h2><p>接著我們要介紹 openstack 裡面另外一個重要的網路概念，provider network 跟 self-service network 的差別。</p>
<p>首先要特別注意的是，這邊提到的分類方式和前面的網路類型是兩種不同的角度和分類方式。</p>
<p>雖然 flat network 通常會搭配 provider networks，vlan 和 vxlan 通常會搭配 self service network 但是這並不是一定而且必要的。</p>
<p>前面的網路類型我們探討的是要如何在跨節點的網路架構下提供一個或多個 L2 網路讓 VMs 之間可以彼此連接。</p>
<p>這邊 provider 和 self-service 的差別則是要探討，如何提供前面切割出來的網路 L3 的網路功能 (gateway, routing…)</p>
<p>在 provider 網路模式下，我們假設 L3 的網路功能可以直接由物理網路提供，因此 openstack 只負責提供 DHCP，以及將虛擬機接到物理網路上，其餘的 gateway, routing 功能，openstack 只假設存在，不多做處理。在最簡單的 <code>flat</code> 網路模式下這麼做當然是非常簡單可行的，最簡單的方法就是將 <code>flat</code> 網路直接接入節點間 openstack 管理用的網段，並與節點共用 ip subnet，直接由物理網路提供功能。</p>
<p>然而在 <code>vlan</code> 和 <code>vxlan</code> 模式下使用 proider 網路就不是這麼好用了，前面提到相較於 <code>flat</code>，<code>vlan</code> 和 <code>vxlan</code> 的特點就是能夠動態建立獨立的租戶網路，如果要使用 provider 機制，變成說我們要導入額外的自動化方式，替每個 vlan 或 vxlan 提供 gateway 的功能，因此通常會使用 self-service network。</p>
<p>self-service network 指的是 openstack self service，也就是由 openstack 本身來提供 L3 網路的 gateway, router 的功能。</p>
<p>為了要提供 router 的功能，openstack 的作法是使用 network namespace。</p>
<p>首先我們需要在一個節點上部署 neutron 的 L3 agent。<br>當我們透過 openstack 的 API 建立一個 virtual router 的時候，netron L3 agent 會在節點上建立一個獨立的 network namespace 當作這台 virtual router 的主體。</p>
<p><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221005021155.png"><br>接著我們就可以將不同的租戶網路接入 router，透過 linux 本身的 iptables, routing 的功能來提供租戶網路間 routing 的功能。<br><img src="/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/Pastedimage20221005021447.png"><br>我們也可以透過把其中一個租戶網路或 <code>flat</code> 網路接入物理網路，使用 provider network 的方式，其他的租戶網路可以透過 virtual router routing 到 provider network 的租戶網路來上網。</p>
<h3 id="Openstack-self-service-指令"><a href="#Openstack-self-service-指令" class="headerlink" title="Openstack self-service 指令"></a>Openstack self-service 指令</h3><p>這邊補充一下如何透過 cli 在 openstack 上建立 router 還有把租戶網路加入 router</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">openstack router create router1<br></code></pre></td></tr></table></figure>
<p>首先建立 router1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">openstack port create --network net1 net1-router-port<br></code></pre></td></tr></table></figure>
<p>接著為了讓租戶網路能夠 “接線” 到 router，我們需要幫網路建立一個 port</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">openstack router add port router1 net1-router-port<br></code></pre></td></tr></table></figure>
<p>最後把 port 接到 router 上</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Openstack 架設系列文章 (1) - 網路架構解析及設置</p><p><a href="https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/">https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Louis Li</p></div></div><div class="level-item is-narrow"><div><h6>發表於</h6><p>2022-10-05</p></div></div><div class="level-item is-narrow"><div><h6>更新於</h6><p>2022-11-01</p></div></div><div class="level-item is-narrow"><div><h6>許可協議</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Openstack/">Openstack</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/Terraform/Deploy-proxmox-vm-with-terraform/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">使用 Terraform 部屬 Proxmox 虛擬機</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/Kubernetes/CNI-Spec-Guiding/"><span class="level-item">CNI Spec 導讀</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">評論</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://blog.louisif.me/Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/';
            this.page.identifier = 'Openstack/Openstack-Deployment-Serial-1-Network-Architecure-and-Config/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'louis-lis-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mylogo.svg" alt="Louis Li"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Louis Li</p><p class="is-size-6 is-block">NYCU CS</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hsinchu, Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分類</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">標籤</p><a href="/tags"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/gamerslouis" target="_blank" rel="noopener">追蹤</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/gamerslouis"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Mail" href="mailto:me@louisif.me"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分類</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/ONOS/"><span class="level-start"><span class="level-item">ONOS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Openstack/"><span class="level-start"><span class="level-item">Openstack</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/eBPF/"><span class="level-start"><span class="level-item">eBPF</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-02T17:49:46.000Z">2022-11-03</time></p><p class="title"><a href="/Openstack/Solve-Openstack-vm-create-fail/">解決 Openstack VM 建立失敗問題</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-02T16:47:08.000Z">2022-11-03</time></p><p class="title"><a href="/Openstack/Openstack-Deployment-Serial-3-Basic-Management-Commands/">Openstack 架設系列文章 (3) - 基本指令操作</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-01T13:00:57.000Z">2022-11-01</time></p><p class="title"><a href="/notes/Install-openvpn-client-on-proxmox/">Proxmox 安裝 openvpn client 紀錄</a></p><p class="categories"><a href="/categories/notes/">notes</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-11-01T13:00:00.000Z">2022-11-01</time></p><p class="title"><a href="/Openstack/Openstack-Deployment-Serial-2-Deployment-with-Openstack-Ansible/">Openstack 架設系列文章 (2) - 使用 Openstack Ansible 部署 Openstack</a></p><p class="categories"><a href="/categories/Openstack/">Openstack</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-31T10:14:40.000Z">2022-10-31</time></p><p class="title"><a href="/eBPF/Learn-eBPF-Serial-9-eBPF-helper-functions/">學習 eBPF 系列 9 - eBPF helper functions</a></p><p class="categories"><a href="/categories/eBPF/">eBPF</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">彙整</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">標籤</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IaC/"><span class="tag">IaC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Openstack/"><span class="tag">Openstack</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/P4/"><span class="tag">P4</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Proxmox/"><span class="tag">Proxmox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bcc/"><span class="tag">bcc</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cgroups/"><span class="tag">cgroups</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eBPF/"><span class="tag">eBPF</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openvpn/"><span class="tag">openvpn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proxmox/"><span class="tag">proxmox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/socketmap/"><span class="tag">socketmap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tc/"><span class="tag">tc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xdp/"><span class="tag">xdp</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">文章目錄</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#Openstack-網路類型概念"><span class="level-left"><span class="level-item">2</span><span class="level-item">Openstack 網路類型概念</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Flat-network"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Flat network</span></span></a></li><li><a class="level is-mobile" href="#Vlan-network"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Vlan network</span></span></a></li><li><a class="level is-mobile" href="#Vxlan-network"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Vxlan network</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Openstack-網路設置"><span class="level-left"><span class="level-item">3</span><span class="level-item">Openstack 網路設置</span></span></a></li><li><a class="level is-mobile" href="#Provider-vs-Self-service-networks"><span class="level-left"><span class="level-item">4</span><span class="level-item">Provider vs Self-service networks</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Openstack-self-service-指令"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Openstack self-service 指令</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/mylogo.svg" alt="Louis Li&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Louis Li</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>個訪客</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-TW");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到頁首" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此網站使用Cookie來改善您的體驗。",
          dismiss: "知道了！",
          allow: "允許使用Cookie",
          deny: "拒絕",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="請輸入關鍵字..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"請輸入關鍵字...","untitled":"(無標題)","posts":"文章","pages":"頁面","categories":"分類","tags":"標籤"});
        });</script></body></html>